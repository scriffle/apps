<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <title>MC Question Generator</title>
    <style>
        :root {
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #e9ecef;
            --text-primary: #212529;
            --text-secondary: #495057;
            --text-muted: #6c757d;
            --border-color: #dee2e6;
            --accent: #2563eb;
            --accent-hover: #1d4ed8;
            --success: #16a34a;
            --warning: #d97706;
            --danger: #dc2626;
            --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.07);
            --radius: 6px;
            --transition: 0.2s ease;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            font-size: 15px;
            line-height: 1.6;
            color: var(--text-primary);
            background: var(--bg-secondary);
            min-height: 100vh;
        }

        .app-container {
            max-width: 900px;
            margin: 0 auto;
            padding: clamp(12px, 3vw, 24px);
            min-height: 100vh;
        }

        header {
            background: var(--bg-primary);
            padding: clamp(16px, 4vw, 24px);
            border-radius: var(--radius);
            box-shadow: var(--shadow-sm);
            margin-bottom: 16px;
            border: 1px solid var(--border-color);
        }

        header h1 {
            font-size: clamp(1.25rem, 4vw, 1.5rem);
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        header p {
            color: var(--text-muted);
            font-size: 0.9rem;
        }

        .tab-nav {
            display: flex;
            gap: 4px;
            margin-bottom: 16px;
            background: var(--bg-primary);
            padding: 6px;
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
        }

        .tab-btn {
            flex: 1;
            padding: 12px 16px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            border-radius: 4px;
            transition: all var(--transition);
            min-height: 44px;
            touch-action: manipulation;
        }

        .tab-btn:hover {
            background: var(--bg-secondary);
        }

        .tab-btn.active {
            background: var(--accent);
            color: white;
        }

        .tab-btn .tab-num {
            display: inline-block;
            width: 20px;
            height: 20px;
            line-height: 20px;
            text-align: center;
            background: rgba(255,255,255,0.2);
            border-radius: 50%;
            font-size: 0.75rem;
            margin-right: 6px;
        }

        .tab-btn:not(.active) .tab-num {
            background: var(--bg-tertiary);
        }

        .tab-panel {
            display: none;
            background: var(--bg-primary);
            border-radius: var(--radius);
            border: 1px solid var(--border-color);
            box-shadow: var(--shadow-sm);
        }

        .tab-panel.active {
            display: block;
            animation: fadeIn 0.2s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(4px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .panel-content {
            padding: clamp(16px, 4vw, 24px);
        }

        .form-section {
            margin-bottom: 24px;
        }

        .form-section:last-child {
            margin-bottom: 0;
        }

        .section-title {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 12px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--border-color);
        }

        .form-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 16px;
        }

        .form-row:last-child {
            margin-bottom: 0;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--text-secondary);
            margin-bottom: 6px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 10px 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            font-size: 0.95rem;
            font-family: inherit;
            transition: border-color var(--transition), box-shadow var(--transition);
            min-height: 44px;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--accent);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .form-group textarea {
            min-height: 150px;
            resize: vertical;
        }

        .form-group small {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .option-group {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .option-group.vertical {
            flex-direction: column;
        }

        .option-item {
            display: flex;
            align-items: flex-start;
            gap: 8px;
            cursor: pointer;
            padding: 10px 12px;
            background: var(--bg-secondary);
            border-radius: var(--radius);
            border: 1px solid transparent;
            transition: all var(--transition);
            min-height: 44px;
        }

        .option-item:hover {
            border-color: var(--border-color);
        }

        .option-item.selected {
            border-color: var(--accent);
            background: rgba(37, 99, 235, 0.05);
        }

        .option-item input[type="radio"],
        .option-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            margin: 2px 0 0 0;
            cursor: pointer;
            accent-color: var(--accent);
            flex-shrink: 0;
        }

        .option-item > div {
            flex: 1;
        }

        .option-item span {
            font-size: 0.9rem;
            display: block;
        }

        .option-item small {
            display: block;
            font-size: 0.75rem;
            color: var(--text-muted);
            margin-top: 2px;
        }

        .cognitive-grid {
            display: grid;
            gap: 10px;
        }

        .cognitive-row {
            display: grid;
            grid-template-columns: 90px 1fr 90px 32px;
            align-items: center;
            gap: 12px;
        }

        .cognitive-row label {
            font-size: 0.85rem;
            color: var(--text-secondary);
        }

        .cognitive-row input[type="range"] {
            width: 100%;
            height: 6px;
            -webkit-appearance: none;
            background: var(--bg-tertiary);
            border-radius: 3px;
            cursor: pointer;
        }

        .cognitive-row input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 18px;
            height: 18px;
            background: var(--accent);
            border-radius: 50%;
            cursor: pointer;
        }

        .cognitive-row input[type="range"].locked {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .cognitive-row input[type="range"].locked::-webkit-slider-thumb {
            background: var(--text-muted);
        }

        .cognitive-stats {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            font-size: 0.85rem;
            line-height: 1.3;
        }

        .cognitive-stats .percent {
            font-weight: 600;
            color: var(--text-primary);
        }

        .cognitive-stats .questions {
            font-size: 0.75rem;
            color: var(--text-muted);
        }

        .cognitive-row .lock-btn {
            width: 32px;
            height: 32px;
            border: 1px solid var(--border-color);
            background: var(--bg-secondary);
            border-radius: var(--radius);
            cursor: pointer;
            font-size: 0.85rem;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition);
        }

        .cognitive-row .lock-btn:hover {
            background: var(--bg-tertiary);
        }

        .cognitive-row .lock-btn.locked {
            background: var(--accent);
            color: white;
            border-color: var(--accent);
        }

        .cognitive-total {
            display: flex;
            justify-content: flex-end;
            align-items: center;
            gap: 12px;
            padding-top: 12px;
            border-top: 1px solid var(--border-color);
            margin-top: 8px;
        }

        .cognitive-total span {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .cognitive-total strong {
            font-size: 1rem;
            color: var(--success);
        }

        .cognitive-total strong.error {
            color: var(--danger);
        }

        .cognitive-hint {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 8px;
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            padding: 10px 20px;
            border: none;
            border-radius: var(--radius);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition);
            min-height: 44px;
            touch-action: manipulation;
        }

        .btn-primary {
            background: var(--accent);
            color: white;
        }

        .btn-primary:hover {
            background: var(--accent-hover);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }

        .btn-secondary:hover {
            background: var(--border-color);
        }

        .btn-success {
            background: var(--success);
            color: white;
        }

        .btn-success:hover {
            background: #15803d;
        }

        .prompt-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .prompt-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            overflow: hidden;
        }

        .prompt-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
        }

        .prompt-header h3 {
            font-size: 0.95rem;
            font-weight: 600;
            color: var(--text-primary);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .prompt-header .step-num {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 24px;
            height: 24px;
            background: var(--accent);
            color: white;
            border-radius: 50%;
            font-size: 0.75rem;
        }

        .prompt-header .toggle-icon {
            font-size: 1.2rem;
            color: var(--text-muted);
            transition: transform var(--transition);
        }

        .prompt-card.expanded .toggle-icon {
            transform: rotate(180deg);
        }

        .prompt-body {
            display: none;
            padding: 16px;
        }

        .prompt-card.expanded .prompt-body {
            display: block;
        }

        .prompt-textarea {
            width: 100%;
            min-height: 300px;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            font-family: 'SF Mono', 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
            resize: vertical;
            background: var(--bg-secondary);
        }

        .prompt-textarea:focus {
            outline: none;
            border-color: var(--accent);
        }

        .prompt-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
            flex-wrap: wrap;
        }

        .copy-feedback {
            display: none;
            align-items: center;
            gap: 4px;
            color: var(--success);
            font-size: 0.85rem;
            font-weight: 500;
        }

        .copy-feedback.show {
            display: flex;
        }

        .status-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            font-size: 0.85rem;
        }

        .status-bar .status {
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--text-muted);
        }

        .status-indicator {
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: var(--border-color);
        }

        .status-indicator.ready {
            background: var(--success);
        }

        .status-indicator.incomplete {
            background: var(--warning);
        }

        .resource-card {
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: var(--radius);
            margin-bottom: 16px;
        }

        .resource-card:last-child {
            margin-bottom: 0;
        }

        .resource-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            cursor: pointer;
            user-select: none;
        }

        .resource-header h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .resource-header .toggle-icon {
            font-size: 1.2rem;
            color: var(--text-muted);
            transition: transform var(--transition);
        }

        .resource-card.expanded .resource-header .toggle-icon {
            transform: rotate(180deg);
        }

        .resource-body {
            display: none;
            padding: 0 16px 16px;
        }

        .resource-card.expanded .resource-body {
            display: block;
        }

        .resource-content {
            background: var(--bg-secondary);
            border-radius: var(--radius);
            padding: 16px;
            font-size: 0.9rem;
            max-height: 400px;
            overflow-y: auto;
        }

        .resource-content h4 {
            font-size: 0.95rem;
            margin: 16px 0 8px;
            color: var(--text-primary);
        }

        .resource-content h4:first-child {
            margin-top: 0;
        }

        .resource-content p {
            margin-bottom: 8px;
            color: var(--text-secondary);
        }

        .resource-content ul, .resource-content ol {
            margin: 8px 0 8px 20px;
            color: var(--text-secondary);
        }

        .resource-content li {
            margin-bottom: 4px;
        }

        .toast {
            position: fixed;
            bottom: 24px;
            right: 24px;
            padding: 12px 20px;
            background: var(--text-primary);
            color: white;
            border-radius: var(--radius);
            font-size: 0.9rem;
            box-shadow: var(--shadow-md);
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }

        .settings-toggle {
            position: fixed;
            bottom: 24px;
            left: 24px;
            width: 44px;
            height: 44px;
            background: var(--bg-primary);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-md);
            transition: all var(--transition);
            z-index: 100;
        }

        .settings-toggle:hover {
            background: var(--bg-secondary);
        }

        .settings-panel {
            position: fixed;
            left: 0;
            top: 0;
            width: 300px;
            height: 100vh;
            background: var(--bg-primary);
            border-right: 1px solid var(--border-color);
            box-shadow: var(--shadow-md);
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            z-index: 200;
            overflow-y: auto;
        }

        .settings-panel.open {
            transform: translateX(0);
        }

        .settings-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.3);
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
            z-index: 150;
        }

        .settings-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .settings-header h2 {
            font-size: 1rem;
            font-weight: 600;
        }

        .settings-close {
            width: 32px;
            height: 32px;
            border: none;
            background: transparent;
            cursor: pointer;
            font-size: 1.25rem;
            color: var(--text-muted);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: var(--radius);
        }

        .settings-close:hover {
            background: var(--bg-secondary);
        }

        .settings-body {
            padding: 16px;
        }

        .settings-section {
            margin-bottom: 24px;
        }

        .settings-section h3 {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            color: var(--text-muted);
            margin-bottom: 12px;
        }

        .help-text {
            background: #eff6ff;
            border: 1px solid #bfdbfe;
            border-radius: var(--radius);
            padding: 12px;
            margin-bottom: 16px;
            font-size: 0.85rem;
            color: #1e40af;
        }

        kbd {
            display: inline-block;
            padding: 2px 6px;
            font-family: inherit;
            font-size: 0.75rem;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-color);
            border-radius: 3px;
            box-shadow: 0 1px 1px rgba(0,0,0,0.1);
        }

        @media (max-width: 600px) {
            .tab-btn span:not(.tab-num) {
                display: none;
            }

            .tab-btn .tab-num {
                margin-right: 0;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .cognitive-row {
                grid-template-columns: 75px 1fr 70px 28px;
                gap: 8px;
            }

            .prompt-actions {
                flex-direction: column;
            }

            .prompt-actions .btn {
                width: 100%;
            }
        }

        @media print {
            .tab-nav, .settings-toggle, .toast, .btn {
                display: none;
            }

            .tab-panel {
                display: block !important;
                box-shadow: none;
                border: none;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <header>
            <h1>MC Question Generator</h1>
            <p>Configure once, generate tailored prompts for your LLM</p>
        </header>

        <nav class="tab-nav" role="tablist">
            <button class="tab-btn active" data-tab="setup" role="tab" aria-selected="true">
                <span class="tab-num">1</span><span>Setup</span>
            </button>
            <button class="tab-btn" data-tab="generate" role="tab" aria-selected="false">
                <span class="tab-num">2</span><span>Generate</span>
            </button>
            <button class="tab-btn" data-tab="resources" role="tab" aria-selected="false">
                <span class="tab-num">3</span><span>Resources</span>
            </button>
        </nav>

        <!-- Setup Tab -->
        <div class="tab-panel active" id="panel-setup" role="tabpanel">
            <div class="status-bar">
                <div class="status">
                    <span class="status-indicator" id="setupStatus"></span>
                    <span id="setupStatusText">Complete all fields to generate prompts</span>
                </div>
                <button class="btn btn-secondary" onclick="resetForm()" style="padding: 6px 12px; min-height: 32px; font-size: 0.8rem;">Reset</button>
            </div>
            <div class="panel-content">
                <!-- Basic Info -->
                <div class="form-section">
                    <div class="section-title">Basic Information</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="subject">Subject</label>
                            <input type="text" id="subject" placeholder="e.g., Biology, Mathematics, History">
                        </div>
                        <div class="form-group">
                            <label for="yearLevel">Year Level / Grade</label>
                            <input type="text" id="yearLevel" placeholder="e.g., Year 10, VCE, Grade 11">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="questionCount">Number of Questions</label>
                            <input type="number" id="questionCount" min="1" max="100" value="20">
                        </div>
                        <div class="form-group">
                            <label for="exportFormat">Export Format</label>
                            <select id="exportFormat">
                                <option value="docx">Word Document (.docx)</option>
                                <option value="pdf">PDF Document (.pdf)</option>
                                <option value="plain">Plain Text (.txt)</option>
                                <option value="qti">QTI for LMS Import</option>
                            </select>
                        </div>
                    </div>
                </div>

                <!-- Assessment Type -->
                <div class="form-section">
                    <div class="section-title">Assessment Type</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Purpose</label>
                            <div class="option-group">
                                <label class="option-item">
                                    <input type="radio" name="purpose" value="pretest">
                                    <div>
                                        <span>Pretest</span>
                                        <small>Assess prior knowledge</small>
                                    </div>
                                </label>
                                <label class="option-item">
                                    <input type="radio" name="purpose" value="formative" checked>
                                    <div>
                                        <span>Formative</span>
                                        <small>Identify learning gaps</small>
                                    </div>
                                </label>
                                <label class="option-item">
                                    <input type="radio" name="purpose" value="summative">
                                    <div>
                                        <span>Summative</span>
                                        <small>Measure mastery</small>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Question Set</label>
                            <div class="option-group vertical">
                                <label class="option-item">
                                    <input type="radio" name="setType" value="practice">
                                    <div>
                                        <span>Practice Set</span>
                                        <small>Questions with full explanations for self-study</small>
                                    </div>
                                </label>
                                <label class="option-item">
                                    <input type="radio" name="setType" value="real" checked>
                                    <div>
                                        <span>Assessment Set</span>
                                        <small>Questions with separate teacher answer key</small>
                                    </div>
                                </label>
                                <label class="option-item">
                                    <input type="radio" name="setType" value="both">
                                    <div>
                                        <span>Both (Practice + Assessment)</span>
                                        <small>Two parallel sets with different questions covering same content</small>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Options -->
                <div class="form-section">
                    <div class="section-title">Options</div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Language Variants</label>
                            <div class="option-group vertical">
                                <label class="option-item">
                                    <input type="checkbox" id="optSimplified">
                                    <span>Include simplified version (EAL/accessibility)</span>
                                </label>
                                <label class="option-item">
                                    <input type="checkbox" id="optExtension">
                                    <span>Include extension version (advanced)</span>
                                </label>
                            </div>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Answer Position</label>
                            <div class="option-group vertical">
                                <label class="option-item">
                                    <input type="radio" name="answerPosition" value="randomize" checked>
                                    <div>
                                        <span>Randomize the order of responses</span>
                                        <small>Correct answer appears in different positions (A, B, C, or D)</small>
                                    </div>
                                </label>
                                <label class="option-item">
                                    <input type="radio" name="answerPosition" value="fixedA">
                                    <div>
                                        <span>Make A always the correct response</span>
                                        <small>For use with software applications that randomize automatically</small>
                                    </div>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Cognitive Distribution -->
                <div class="form-section">
                    <div class="section-title">Cognitive Level Distribution (Bloom's Taxonomy)</div>
                    <div class="cognitive-grid">
                        <div class="cognitive-row">
                            <label>Remember</label>
                            <input type="range" id="cogRemember" min="0" max="100" value="15" oninput="handleCognitiveChange('Remember')">
                            <div class="cognitive-stats">
                                <span class="percent" id="cogRememberVal">15%</span>
                                <span class="questions" id="cogRememberQ">3 questions</span>
                            </div>
                            <button class="lock-btn" onclick="toggleLock('Remember')" title="Lock this value">üîì</button>
                        </div>
                        <div class="cognitive-row">
                            <label>Understand</label>
                            <input type="range" id="cogUnderstand" min="0" max="100" value="25" oninput="handleCognitiveChange('Understand')">
                            <div class="cognitive-stats">
                                <span class="percent" id="cogUnderstandVal">25%</span>
                                <span class="questions" id="cogUnderstandQ">5 questions</span>
                            </div>
                            <button class="lock-btn" onclick="toggleLock('Understand')" title="Lock this value">üîì</button>
                        </div>
                        <div class="cognitive-row">
                            <label>Apply</label>
                            <input type="range" id="cogApply" min="0" max="100" value="30" oninput="handleCognitiveChange('Apply')">
                            <div class="cognitive-stats">
                                <span class="percent" id="cogApplyVal">30%</span>
                                <span class="questions" id="cogApplyQ">6 questions</span>
                            </div>
                            <button class="lock-btn" onclick="toggleLock('Apply')" title="Lock this value">üîì</button>
                        </div>
                        <div class="cognitive-row">
                            <label>Analyze</label>
                            <input type="range" id="cogAnalyze" min="0" max="100" value="20" oninput="handleCognitiveChange('Analyze')">
                            <div class="cognitive-stats">
                                <span class="percent" id="cogAnalyzeVal">20%</span>
                                <span class="questions" id="cogAnalyzeQ">4 questions</span>
                            </div>
                            <button class="lock-btn" onclick="toggleLock('Analyze')" title="Lock this value">üîì</button>
                        </div>
                        <div class="cognitive-row">
                            <label>Evaluate</label>
                            <input type="range" id="cogEvaluate" min="0" max="100" value="10" oninput="handleCognitiveChange('Evaluate')">
                            <div class="cognitive-stats">
                                <span class="percent" id="cogEvaluateVal">10%</span>
                                <span class="questions" id="cogEvaluateQ">2 questions</span>
                            </div>
                            <button class="lock-btn" onclick="toggleLock('Evaluate')" title="Lock this value">üîì</button>
                        </div>
                        <div class="cognitive-row">
                            <label>Create</label>
                            <input type="range" id="cogCreate" min="0" max="100" value="0" oninput="handleCognitiveChange('Create')">
                            <div class="cognitive-stats">
                                <span class="percent" id="cogCreateVal">0%</span>
                                <span class="questions" id="cogCreateQ">0 questions</span>
                            </div>
                            <button class="lock-btn" onclick="toggleLock('Create')" title="Lock this value">üîì</button>
                        </div>
                        <div class="cognitive-total" id="cogTotal">
                            <span>Total:</span>
                            <strong id="cogTotalPercent">100%</strong>
                            <span class="questions-total" id="cogTotalQ">(20 questions)</span>
                        </div>
                    </div>
                    <p class="cognitive-hint">Drag a slider to adjust‚Äîother unlocked values rebalance automatically to maintain 100%. Click the lock icon to freeze a value.</p>
                </div>

                <!-- Content -->
                <div class="form-section">
                    <div class="section-title">Teaching Content</div>
                    <div class="form-group">
                        <label for="teachingContent">Paste your teaching materials here</label>
                        <textarea id="teachingContent" placeholder="Paste lecture notes, textbook sections, curriculum documents, or topic outlines..."></textarea>
                        <small>Include key concepts, definitions, processes, and learning objectives you want assessed.</small>
                    </div>
                    <div class="form-group" style="margin-top: 16px;">
                        <label for="topicsBreakdown">Topics & Teaching Time (optional)</label>
                        <textarea id="topicsBreakdown" placeholder="Topic 1: Cellular Respiration - 2 weeks&#10;Topic 2: Photosynthesis - 2 weeks&#10;Topic 3: ATP & Energy - 1 week" style="min-height: 100px;"></textarea>
                        <small>Helps create a balanced test blueprint. Format: Topic - time spent</small>
                    </div>
                </div>

                <div style="display: flex; justify-content: flex-end; padding-top: 16px; border-top: 1px solid var(--border-color);">
                    <button class="btn btn-primary" onclick="goToGenerate()">Generate Prompts ‚Üí</button>
                </div>
            </div>
        </div>

        <!-- Generate Tab -->
        <div class="tab-panel" id="panel-generate" role="tabpanel">
            <div class="status-bar">
                <div class="status">
                    <span class="status-indicator" id="generateStatus"></span>
                    <span id="generateStatusText">Ready to generate</span>
                </div>
                <span style="font-size: 0.8rem; color: var(--text-muted);">Use <kbd>Ctrl</kbd>+<kbd>C</kbd> after selecting</span>
            </div>
            <div class="panel-content">
                <div class="help-text">
                    Copy each prompt in order to your LLM. Wait for each response before sending the next. All prompts are pre-filled with your configuration.
                </div>
                <div class="prompt-list" id="promptList">
                    <!-- Prompts generated dynamically -->
                </div>
            </div>
        </div>

        <!-- Resources Tab -->
        <div class="tab-panel" id="panel-resources" role="tabpanel">
            <div class="panel-content">
                <div class="help-text">
                    Static resources that don't change based on your configuration. Copy and use as needed.
                </div>

                <!-- Student Instructions -->
                <div class="resource-card" id="resourceStudentInstructions">
                    <div class="resource-header" onclick="toggleResource('resourceStudentInstructions')">
                        <h3>Student Instructions</h3>
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="resource-body">
                        <div style="margin-bottom: 12px;">
                            <button class="btn btn-success" onclick="copyResource('studentInstructionsContent')">Copy Instructions</button>
                            <span class="copy-feedback" id="studentInstructionsContentFeedback">‚úì Copied</span>
                        </div>
                        <div class="resource-content" id="studentInstructionsContent">
<h4>How to Approach Multiple Choice Questions</h4>

<h4>BEFORE You Start</h4>
<ul>
<li>Read the instructions carefully</li>
<li>Check how many questions and how much time you have</li>
<li>Understand if there is negative marking (usually there is not)</li>
</ul>

<h4>FOR EACH Question</h4>

<p><strong>1. READ THE STEM CAREFULLY</strong></p>
<ul>
<li>Read the question twice before looking at options</li>
<li>Identify what it is actually asking (keywords: "best," "most," "primarily")</li>
<li>Try to answer in your head first, then look for a match</li>
</ul>

<p><strong>2. ELIMINATE OBVIOUSLY WRONG OPTIONS</strong></p>
<ul>
<li>Cross out answers you know are incorrect</li>
<li>Even eliminating one option improves your odds</li>
<li>Look for options that are off-topic, too extreme, or factually wrong</li>
</ul>

<p><strong>3. COMPARE REMAINING OPTIONS</strong></p>
<ul>
<li>Look for differences between similar answers</li>
<li>The question often hinges on subtle distinctions</li>
<li>Watch for qualifiers: "always," "never," "sometimes," "usually"</li>
</ul>

<p><strong>4. WATCH FOR TRICKS</strong></p>
<ul>
<li>"All of the above" - if ANY one is wrong, eliminate it</li>
<li>"None of the above" - if ANY one is right, eliminate it</li>
<li>Longest answer - sometimes correct, but not a reliable rule</li>
<li>Grammatical clues - all options should fit the stem grammatically</li>
</ul>

<p><strong>5. USE YOUR KNOWLEDGE, NOT PATTERNS</strong></p>
<ul>
<li>Do not assume "C is correct most often" (good tests randomize)</li>
<li>Do not change answers unless you find an actual error in your thinking</li>
<li>First instincts are usually correct IF you know the content</li>
</ul>

<p><strong>6. FOR APPLICATION/ANALYSIS QUESTIONS</strong></p>
<ul>
<li>Read any scenarios, graphs, or data carefully</li>
<li>Underline key information</li>
<li>Think about which concept/principle applies</li>
<li>Work through the logic before choosing</li>
</ul>

<p><strong>7. IF YOU ARE STUCK</strong></p>
<ul>
<li>Mark it and move on</li>
<li>Come back with fresh eyes</li>
<li>Make an educated guess (eliminate what you can)</li>
<li>Never leave a question blank (unless there is negative marking)</li>
</ul>

<p><strong>8. TIME MANAGEMENT</strong></p>
<ul>
<li>Do not spend too long on any one question</li>
<li>Budget roughly equal time per question</li>
<li>Save 5 minutes at the end to review</li>
</ul>

<p><strong>9. REVIEW YOUR ANSWERS</strong></p>
<ul>
<li>Check you have answered every question</li>
<li>Verify you have not accidentally marked two answers for one question</li>
<li>Only change answers if you spot a clear mistake in your reasoning</li>
</ul>

<p><strong>10. AFTER THE TEST</strong></p>
<ul>
<li>Learn from your mistakes</li>
<li>Understand WHY the correct answer was right</li>
<li>Understand WHY your chosen answer was wrong</li>
<li>Identify patterns in what you are getting wrong (concepts to review)</li>
</ul>

<h4>What Multiple Choice Questions Actually Test</h4>
<p>MC questions are not just about memorization. They test your ability to:</p>
<ul>
<li>Remember key facts and definitions</li>
<li>Understand concepts well enough to recognize them in different words</li>
<li>Apply knowledge to new situations</li>
<li>Analyze complex scenarios and relationships</li>
<li>Evaluate options and make judgments</li>
<li>Think critically about problems</li>
</ul>
<p>The best preparation is deep understanding, not just memorization.</p>

<h4>Common Mistakes to Avoid</h4>
<ol>
<li>Reading too quickly - Misreading "NOT" in a question</li>
<li>Overthinking - Looking for tricks that are not there</li>
<li>Pattern hunting - Trying to game the system instead of knowing content</li>
<li>Giving up - Not attempting questions when unsure</li>
<li>Ignoring qualifiers - Missing words like "usually," "primarily," "best"</li>
<li>Assuming - Choosing based on partial knowledge without full reading</li>
</ol>

<h4>Remember</h4>
<ul>
<li>The goal is learning, not just passing</li>
<li>Tests measure what you know now, not your worth</li>
<li>Wrong answers show you what to study next</li>
<li>Every test is a learning opportunity</li>
<li>If struggling, ask for help before the test</li>
</ul>
                        </div>
                    </div>
                </div>

                <!-- Devil's Advocate -->
                <div class="resource-card" id="resourceDevilsAdvocate">
                    <div class="resource-header" onclick="toggleResource('resourceDevilsAdvocate')">
                        <h3>Devil's Advocate Review Prompt</h3>
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="resource-body">
                        <div style="margin-bottom: 12px;">
                            <button class="btn btn-success" onclick="copyResource('devilsAdvocateContent')">Copy Prompt</button>
                            <span class="copy-feedback" id="devilsAdvocateContentFeedback">‚úì Copied</span>
                        </div>
                        <div class="resource-content" id="devilsAdvocateContent">CRITICAL REVIEW: Act as a devil's advocate to rigorously critique the multiple choice questions you just generated.

Your task is to identify potential problems, NOT to defend the questions. Be hypercritical and flag anything questionable.

For EACH question, evaluate:

1. FACTUAL ACCURACY
   - Are all facts, figures, dates, formulas, and principles DEFINITELY correct?
   - Could any information be outdated, oversimplified, or context-dependent?
   - Are there any statements that might be true in some contexts but not others?
   - Flag ANYTHING you're not 100% certain about for human verification
   - List specific facts that should be cross-checked with authoritative sources

2. QUESTION CLARITY AND VALIDITY
   - Is there EXACTLY ONE clearly correct answer?
   - Could the question be interpreted in multiple ways?
   - Is any wording ambiguous or confusing?
   - Does the question actually test what it claims to test?
   - Could a knowledgeable student reasonably argue for a different answer?

3. DISTRACTOR ANALYSIS
   - Is each distractor DEFINITELY incorrect?
   - Could any distractor be defended as correct under reasonable interpretation?
   - Are distractors based on genuine misconceptions or just arbitrary wrong answers?
   - Are any distractors too obviously wrong or joke answers?
   - Do distractors match the correct answer in plausibility and scope?

4. COGNITIVE LEVEL ACCURACY
   - Does the question actually require the claimed cognitive level?
   - Could it be answered at a lower level than intended?
   - Is the complexity appropriate for the target grade level?

5. BIAS AND SENSITIVITY
   - Are there any cultural assumptions or stereotypes?
   - Could any content be alienating or disadvantaging to certain student groups?
   - Are examples and contexts inclusive and appropriate?
   - Is any content potentially insensitive or controversial?

6. STUDENT EXPERIENCE
   - Is the question fair to students who studied the material?
   - Are there any "trick" elements that test test-taking skill rather than knowledge?
   - Is the language accessible for the target grade level?
   - Would students understand what's being asked?

7. ANSWER KEY VERIFICATION
   - Are the explanations for correct answers accurate?
   - Are the misconception descriptions for distractors valid?
   - Do the learning hints actually help or could they confuse?

OUTPUT FORMAT:

For each question, provide:

Question [number]: [PASS / FLAG / MAJOR ISSUE]

Issues Identified:
- [List any problems found, even minor ones]
- [Be specific about what needs verification or correction]
- [Flag uncertainties with "VERIFY:" prefix]

Recommended Actions:
- [What should be checked or changed]
- [Sources to consult for verification]

If question is a MAJOR ISSUE:
- [Explain why it should be rejected or heavily revised]

After reviewing all questions, provide:

SUMMARY:
- Total questions: [number]
- Passed without issues: [number]
- Flagged for review: [number]
- Major issues requiring rejection/revision: [number]

PATTERNS OBSERVED:
- [Any recurring types of errors or issues]

HIGHEST PRIORITY ITEMS FOR HUMAN VERIFICATION:
1. [Most critical items to verify]
2. [...]

Remember: Be harsh and skeptical. It's better to flag a good question for review than to miss a flawed one. The human teacher will make the final decisions.</div>
                    </div>
                </div>

                <!-- Proofreading Checklist -->
                <div class="resource-card" id="resourceProofreading">
                    <div class="resource-header" onclick="toggleResource('resourceProofreading')">
                        <h3>Proofreading Checklist</h3>
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="resource-body">
                        <div class="resource-content">
<h4>‚ö†Ô∏è CRITICAL: LLM-generated content requires careful human review</h4>

<h4>Why Proofreading is Essential</h4>
<ul>
<li><strong>Factual Errors:</strong> LLMs can confidently generate incorrect information</li>
<li><strong>Ambiguous Questions:</strong> Questions may have multiple valid interpretations</li>
<li><strong>Invalid Distractors:</strong> Distractors may not reflect genuine misconceptions</li>
<li><strong>Bias and Sensitivity:</strong> Content may contain cultural bias or inappropriate contexts</li>
<li><strong>Difficulty Mismatch:</strong> Questions may not match intended cognitive level</li>
<li><strong>Answer Key Errors:</strong> Explanations may be incorrect even when the answer is right</li>
</ul>

<h4>Verification Checklist</h4>

<p><strong>Factual Accuracy</strong></p>
<ul>
<li>‚òê Check every fact, figure, date, formula against authoritative sources</li>
<li>‚òê Verify scientific principles and technical terminology</li>
<li>‚òê Cross-reference with textbooks and curriculum documents</li>
</ul>

<p><strong>Question Quality</strong></p>
<ul>
<li>‚òê Each question has ONE clearly correct answer</li>
<li>‚òê No ambiguity in question interpretation</li>
<li>‚òê All options grammatically parallel and similar length</li>
<li>‚òê Cognitive level matches what was requested</li>
</ul>

<p><strong>Distractor Validity</strong></p>
<ul>
<li>‚òê Distractors are plausible but definitely incorrect</li>
<li>‚òê Distractors reflect real student misconceptions</li>
<li>‚òê No distractor could be argued as correct</li>
</ul>

<p><strong>Cultural Sensitivity</strong></p>
<ul>
<li>‚òê No stereotypes or cultural assumptions</li>
<li>‚òê Examples are inclusive and accessible</li>
<li>‚òê Names and contexts represent diverse backgrounds</li>
</ul>

<p><strong>Answer Key</strong></p>
<ul>
<li>‚òê Work through each question independently first</li>
<li>‚òê Verify explanations are accurate</li>
<li>‚òê Check misconception descriptions are valid</li>
</ul>

<h4>Common LLM Errors to Watch For</h4>
<ul>
<li>"Hallucinated" facts - plausible but invented information</li>
<li>Outdated information</li>
<li>Subtle conceptual errors that sound convincing</li>
<li>Overgeneralizations with important exceptions</li>
<li>Formula errors with subtle mistakes</li>
</ul>

<h4>When to Reject Questions</h4>
<ul>
<li>Any factual error that can't be easily corrected</li>
<li>Multiple answers could be defended as correct</li>
<li>Culturally insensitive or potentially harmful content</li>
<li>Doesn't align with curriculum or teaching emphasis</li>
</ul>

<p><strong>Remember: YOU are responsible for the quality of assessment materials used with students.</strong></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Settings Toggle -->
    <button class="settings-toggle" onclick="toggleSettings()" aria-label="Settings">‚öôÔ∏è</button>

    <!-- Settings Panel -->
    <div class="settings-overlay" id="settingsOverlay" onclick="toggleSettings()"></div>
    <div class="settings-panel" id="settingsPanel">
        <div class="settings-header">
            <h2>Settings</h2>
            <button class="settings-close" onclick="toggleSettings()">√ó</button>
        </div>
        <div class="settings-body">
            <div class="settings-section">
                <h3>Data</h3>
                <button class="btn btn-secondary" onclick="exportConfig()" style="width: 100%; margin-bottom: 8px;">Export Configuration</button>
                <button class="btn btn-secondary" onclick="importConfig()" style="width: 100%; margin-bottom: 8px;">Import Configuration</button>
                <button class="btn btn-secondary" onclick="clearAllData()" style="width: 100%; color: var(--danger);">Clear All Data</button>
            </div>
            <div class="settings-section">
                <h3>Keyboard Shortcuts</h3>
                <p style="font-size: 0.85rem; color: var(--text-secondary); margin-bottom: 8px;">
                    <kbd>1</kbd> <kbd>2</kbd> <kbd>3</kbd> Switch tabs<br>
                    <kbd>Esc</kbd> Close panels<br>
                    <kbd>Ctrl</kbd>+<kbd>Z</kbd> Undo<br>
                    <kbd>Ctrl</kbd>+<kbd>Y</kbd> Redo
                </p>
            </div>
        </div>
    </div>

    <!-- Toast -->
    <div class="toast" id="toast"></div>

    <!-- Hidden file input for import -->
    <input type="file" id="importFile" accept=".json" style="display: none;" onchange="handleImport(event)">

    <script>
        // State management
        let state = {
            subject: '',
            yearLevel: '',
            questionCount: 20,
            exportFormat: 'docx',
            purpose: 'formative',
            setType: 'real',
            optSimplified: false,
            optExtension: false,
            answerPosition: 'randomize',
            cogRemember: 15,
            cogUnderstand: 25,
            cogApply: 30,
            cogAnalyze: 20,
            cogEvaluate: 10,
            cogCreate: 0,
            teachingContent: '',
            topicsBreakdown: ''
        };

        let lockedLevels = new Set();
        let history = [];
        let historyIndex = -1;
        const MAX_HISTORY = 100;
        const cogLevels = ['Remember', 'Understand', 'Apply', 'Analyze', 'Evaluate', 'Create'];

        document.addEventListener('DOMContentLoaded', function() {
            loadState();
            setupEventListeners();
            updateCognitiveDisplay();
            updateSetupStatus();
        });

        function setupEventListeners() {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => switchTab(btn.dataset.tab));
            });

            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.addEventListener('change', handleInputChange);
                input.addEventListener('input', handleInputChange);
            });

            document.addEventListener('keydown', handleKeyboard);

            window.addEventListener('beforeunload', saveState);
            document.addEventListener('visibilitychange', () => {
                if (document.visibilityState === 'hidden') saveState();
            });
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tabName);
                btn.setAttribute('aria-selected', btn.dataset.tab === tabName);
            });
            document.querySelectorAll('.tab-panel').forEach(panel => {
                panel.classList.toggle('active', panel.id === `panel-${tabName}`);
            });

            if (tabName === 'generate') {
                generatePrompts();
            }
        }

        function handleInputChange(e) {
            const input = e.target;
            const id = input.id || input.name;
            let value;

            if (input.type === 'checkbox') {
                value = input.checked;
            } else if (input.type === 'radio') {
                value = input.value;
            } else if (input.type === 'number') {
                value = parseInt(input.value) || 0;
            } else if (input.type === 'range') {
                return; // Handled by cognitive functions
            } else {
                value = input.value;
            }

            if (id && state.hasOwnProperty(id)) {
                pushHistory();
                state[id] = value;
                saveState();
                updateSetupStatus();
                
                // Update question counts when questionCount changes
                if (id === 'questionCount') {
                    updateCognitiveDisplay();
                }
            }
        }

        function handleKeyboard(e) {
            if (!e.ctrlKey && !e.metaKey && !e.altKey && !e.target.matches('input, textarea')) {
                if (e.key === '1') switchTab('setup');
                if (e.key === '2') switchTab('generate');
                if (e.key === '3') switchTab('resources');
            }

            if (e.key === 'Escape') {
                const settingsPanel = document.getElementById('settingsPanel');
                if (settingsPanel.classList.contains('open')) {
                    toggleSettings();
                }
                document.querySelectorAll('.prompt-card.expanded, .resource-card.expanded').forEach(card => {
                    card.classList.remove('expanded');
                });
            }

            if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
                e.preventDefault();
                undo();
            }
            if ((e.ctrlKey || e.metaKey) && e.key === 'y') {
                e.preventDefault();
                redo();
            }
        }

        // BULLETPROOF cognitive slider algorithm
        function handleCognitiveChange(changedLevel) {
            const changedInput = document.getElementById(`cog${changedLevel}`);
            const requestedValue = parseInt(changedInput.value) || 0;
            
            pushHistory();
            
            // Step 1: Calculate how much is locked (excluding the changed slider)
            let lockedSum = 0;
            cogLevels.forEach(level => {
                if (level !== changedLevel && lockedLevels.has(level)) {
                    lockedSum += state[`cog${level}`];
                }
            });
            
            // Step 2: The changed slider can take at most (100 - lockedSum)
            const maxForChanged = 100 - lockedSum;
            const actualValue = Math.max(0, Math.min(requestedValue, maxForChanged));
            state[`cog${changedLevel}`] = actualValue;
            
            // Step 3: Calculate remaining budget for unlocked sliders
            const remainingBudget = 100 - lockedSum - actualValue;
            
            // Step 4: Get unlocked levels (excluding the changed one)
            const unlockedLevels = cogLevels.filter(l => 
                l !== changedLevel && !lockedLevels.has(l)
            );
            
            // Step 5: Distribute remaining budget among unlocked levels
            if (unlockedLevels.length > 0) {
                // Get current values of unlocked levels
                const currentUnlockedValues = {};
                let currentUnlockedSum = 0;
                unlockedLevels.forEach(level => {
                    currentUnlockedValues[level] = state[`cog${level}`];
                    currentUnlockedSum += state[`cog${level}`];
                });
                
                if (currentUnlockedSum > 0 && remainingBudget > 0) {
                    // Proportional distribution
                    let distributed = 0;
                    for (let i = 0; i < unlockedLevels.length; i++) {
                        const level = unlockedLevels[i];
                        if (i === unlockedLevels.length - 1) {
                            // Last level gets remainder to ensure exactly 100%
                            state[`cog${level}`] = remainingBudget - distributed;
                        } else {
                            const proportion = currentUnlockedValues[level] / currentUnlockedSum;
                            const newVal = Math.round(remainingBudget * proportion);
                            state[`cog${level}`] = newVal;
                            distributed += newVal;
                        }
                    }
                } else if (remainingBudget > 0) {
                    // All unlocked are at 0, distribute evenly
                    const perLevel = Math.floor(remainingBudget / unlockedLevels.length);
                    let remainder = remainingBudget - (perLevel * unlockedLevels.length);
                    
                    unlockedLevels.forEach(level => {
                        state[`cog${level}`] = perLevel + (remainder > 0 ? 1 : 0);
                        if (remainder > 0) remainder--;
                    });
                } else {
                    // No budget left, all unlocked go to 0
                    unlockedLevels.forEach(level => {
                        state[`cog${level}`] = 0;
                    });
                }
            }
            
            // Step 6: Ensure all values are non-negative integers
            cogLevels.forEach(level => {
                state[`cog${level}`] = Math.max(0, Math.round(state[`cog${level}`]));
            });
            
            // Step 7: Final verification - if total != 100, adjust
            const total = cogLevels.reduce((sum, l) => sum + state[`cog${l}`], 0);
            if (total !== 100) {
                const diff = 100 - total;
                // Find a level to adjust (prefer unlocked, then changed, then any)
                let adjustLevel = unlockedLevels.length > 0 ? unlockedLevels[0] : changedLevel;
                for (const level of unlockedLevels) {
                    if (state[`cog${level}`] + diff >= 0) {
                        adjustLevel = level;
                        break;
                    }
                }
                state[`cog${adjustLevel}`] = Math.max(0, state[`cog${adjustLevel}`] + diff);
            }

            updateCognitiveDisplay();
            saveState();
            updateSetupStatus();
        }

        function toggleLock(level) {
            const btn = document.querySelector(`.cognitive-row:has(#cog${level}) .lock-btn`);
            const slider = document.getElementById(`cog${level}`);
            
            if (lockedLevels.has(level)) {
                lockedLevels.delete(level);
                btn.classList.remove('locked');
                btn.textContent = 'üîì';
                btn.title = 'Lock this value';
                slider.classList.remove('locked');
            } else {
                lockedLevels.add(level);
                btn.classList.add('locked');
                btn.textContent = 'üîí';
                btn.title = 'Unlock this value';
                slider.classList.add('locked');
            }
        }

        function updateCognitiveDisplay() {
            let total = 0;
            const questionCount = state.questionCount || 20;
            
            cogLevels.forEach(level => {
                const input = document.getElementById(`cog${level}`);
                const percentDisplay = document.getElementById(`cog${level}Val`);
                const questionsDisplay = document.getElementById(`cog${level}Q`);
                const val = state[`cog${level}`];
                
                input.value = val;
                percentDisplay.textContent = `${val}%`;
                
                // Calculate question count
                const qCount = Math.round((val / 100) * questionCount);
                questionsDisplay.textContent = qCount === 1 ? '1 question' : `${qCount} questions`;
                
                total += val;
            });

            const totalPercentEl = document.getElementById('cogTotalPercent');
            totalPercentEl.textContent = `${total}%`;
            totalPercentEl.classList.toggle('error', total !== 100);
            
            const totalQDisplay = document.getElementById('cogTotalQ');
            totalQDisplay.textContent = `(${questionCount} questions)`;
        }

        function updateSetupStatus() {
            const indicator = document.getElementById('setupStatus');
            const text = document.getElementById('setupStatusText');
            
            const isComplete = state.subject && state.yearLevel && state.teachingContent;

            indicator.classList.remove('ready', 'incomplete');
            indicator.classList.add(isComplete ? 'ready' : 'incomplete');
            text.textContent = isComplete ? 'Ready to generate prompts' : 'Complete all required fields';
        }

        function generatePrompts() {
            const container = document.getElementById('promptList');
            const prompts = buildPrompts();
            
            container.innerHTML = '';
            
            prompts.forEach((prompt, index) => {
                const card = document.createElement('div');
                card.className = 'prompt-card';
                card.innerHTML = `
                    <div class="prompt-header" onclick="togglePrompt(this.parentElement)">
                        <h3><span class="step-num">${index + 1}</span>${prompt.title}</h3>
                        <span class="toggle-icon">‚ñº</span>
                    </div>
                    <div class="prompt-body">
                        <textarea class="prompt-textarea" id="prompt-${index}">${prompt.content}</textarea>
                        <div class="prompt-actions">
                            <button class="btn btn-success" onclick="copyPrompt(${index})">Copy Prompt</button>
                            <span class="copy-feedback" id="feedback-${index}">‚úì Copied</span>
                        </div>
                    </div>
                `;
                container.appendChild(card);
            });

            if (container.firstChild) {
                container.firstChild.classList.add('expanded');
            }

            updateGenerateStatus(prompts.length);
        }

        function getExportFormatText() {
            const formats = {
                'docx': 'Microsoft Word document (.docx file)',
                'pdf': 'PDF document (.pdf file)',
                'plain': 'plain text format (.txt file)',
                'qti': 'QTI format for LMS import'
            };
            return formats[state.exportFormat] || 'plain text format';
        }

        function getPurposeDescription() {
            const purposes = {
                'pretest': 'Pretest (assess prior knowledge before instruction)',
                'formative': 'Formative (identify learning gaps during instruction)',
                'summative': 'Summative (measure mastery after instruction)'
            };
            return purposes[state.purpose] || 'Formative';
        }

        function getCognitiveDistributionWithCounts() {
            const total = state.questionCount || 20;
            const levels = [
                { name: 'Remember', pct: state.cogRemember },
                { name: 'Understand', pct: state.cogUnderstand },
                { name: 'Apply', pct: state.cogApply },
                { name: 'Analyze', pct: state.cogAnalyze },
                { name: 'Evaluate', pct: state.cogEvaluate },
                { name: 'Create', pct: state.cogCreate }
            ];
            
            return levels
                .filter(l => l.pct > 0)
                .map(l => `${l.name}: ${l.pct}% (${Math.round((l.pct / 100) * total)} questions)`)
                .join(', ');
        }

        function buildPrompts() {
            const prompts = [];
            const cogDist = getCognitiveDistributionWithCounts();
            
            const answerPosNote = state.answerPosition === 'fixedA' 
                ? 'IMPORTANT: Make option A the correct answer for ALL questions (the software application will randomize when deployed)'
                : 'Distribute correct answers approximately evenly across A, B, C, D positions';

            const exportFormat = getExportFormatText();
            const purposeDesc = getPurposeDescription();
            const isBoth = state.setType === 'both';
            const questionsPerSet = state.questionCount;

            // 1. Content Analysis & Blueprint
            prompts.push({
                title: 'Content Analysis & Blueprint',
                content: `I need you to help me create a multiple choice assessment. First, analyze my content and create a test blueprint.

CONTEXT:
- Subject: ${state.subject || '[ENTER SUBJECT]'}
- Year Level: ${state.yearLevel || '[ENTER YEAR LEVEL]'}
- Assessment Purpose: ${purposeDesc}
- Total Questions Needed: ${isBoth ? `${questionsPerSet} questions per set (Practice + Assessment = ${questionsPerSet * 2} total)` : questionsPerSet}
- Output Format: ${exportFormat}

TEACHING CONTENT:
${state.teachingContent || '[PASTE YOUR TEACHING CONTENT HERE]'}

${state.topicsBreakdown ? `TOPICS & TEACHING TIME:\n${state.topicsBreakdown}\n` : ''}
COGNITIVE LEVEL TARGETS:
${cogDist}

TASK 1 - CONTENT ANALYSIS:
Analyze the teaching content and identify:
1. Key concepts that should be assessed
2. Technical terms students must know
3. Relationships, processes, or mechanisms to understand
4. Applications or problem-solving skills required
5. Common misconceptions (these become distractors)

TASK 2 - TEST BLUEPRINT:
Create a test blueprint table showing:
| Content Area/Topic | % Teaching Time | Remember | Understand | Apply | Analyze | Evaluate | Create | Total Questions |

Ensure:
- Question distribution matches teaching time emphasis
- Cognitive levels match my targets
- All major concepts are covered
- Flag any imbalances

Present the content analysis first, then the blueprint table.`
            });

            // 2. Question Generation
            if (state.setType === 'practice') {
                prompts.push({
                    title: 'Generate Practice Questions',
                    content: buildQuestionGenerationPrompt('practice', questionsPerSet, cogDist, answerPosNote, exportFormat, false)
                });
            } else if (state.setType === 'real') {
                prompts.push({
                    title: 'Generate Assessment Questions',
                    content: buildQuestionGenerationPrompt('real', questionsPerSet, cogDist, answerPosNote, exportFormat, false)
                });
            } else {
                prompts.push({
                    title: 'Generate Practice Set',
                    content: buildQuestionGenerationPrompt('practice', questionsPerSet, cogDist, answerPosNote, exportFormat, true)
                });
                prompts.push({
                    title: 'Generate Assessment Set',
                    content: buildQuestionGenerationPrompt('real', questionsPerSet, cogDist, answerPosNote, exportFormat, true)
                });
            }

            // 3. Quality Review
            prompts.push({
                title: 'Quality Review',
                content: `Review ALL questions you generated against these quality criteria.

HALADYNA FRAMEWORK CHECKLIST:
1. Are all stems clear and focused?
2. Are all options plausible and approximately equal length?
3. ${state.answerPosition === 'fixedA' ? 'Is option A the correct answer for all questions?' : 'Are correct answers distributed evenly across A, B, C, D?'}
4. Are there any "all of the above" or "none of the above" options? (should be NONE)
5. Do all options maintain grammatical consistency?

DISTRACTOR QUALITY:
1. Is each distractor based on a genuine misconception?
2. Are any distractors obviously wrong?
3. Do distractors match correct answer in plausibility?

BLOOM'S DISTRIBUTION:
1. Does actual distribution match: ${cogDist}?
2. Are higher-order questions truly requiring analysis/evaluation?

CONTENT COVERAGE:
1. Are all key concepts represented?
2. Appropriate depth across topics?

Identify any questions that fail criteria and REVISE them.

CRITICAL OUTPUT REQUIREMENTS:
After any revisions, you MUST provide:

1. All questions (mark any that were revised with [REVISED])

2. COMPLETE ANSWER KEY with full explanations for EVERY question:
   - Question number and correct answer letter
   - Why the correct answer is correct (2-3 sentences)
   - Why each incorrect option is wrong (specific misconception)
   - Learning hint for students

Ensure answer key explanations are updated to reflect any revisions made.

Format as ${exportFormat}.`
            });

            // 4. Simplified Version
            if (state.optSimplified) {
                prompts.push({
                    title: 'Simplified Language Version',
                    content: `Create a simplified language version of ALL questions suitable for English as Additional Language students or students reading below grade level.

SIMPLIFICATION GUIDELINES:
- Use shorter, simpler sentence structures
- Replace complex vocabulary with everyday terms
- Provide a glossary for essential technical terms that cannot be simplified
- Maintain the SAME cognitive level and content being tested
- Keep the SAME correct answer and misconception-based distractors
- Questions must still assess the same learning objectives

Format each question as:
Question X: [Cognitive Level]
[Simplified question stem]
   A. [Simplified option]
   B. [Simplified option]
   C. [Simplified option]
   D. [Simplified option]

CRITICAL: You MUST include a COMPLETE ANSWER KEY with full explanations for EVERY simplified question:
- Correct answer
- Why correct (2-3 sentences, using simplified language)
- Why each incorrect option is wrong (misconception in simple terms)
- Learning hint (accessible language)

Format as ${exportFormat}.`
                });
            }

            // 5. Extension Version
            if (state.optExtension) {
                prompts.push({
                    title: 'Extension Version',
                    content: `Create an extension version of ALL questions for students working above grade level or requiring additional challenge.

CURRENT LEVEL: ${state.yearLevel || '[YEAR LEVEL]'}
EXTENSION TARGET: Next curriculum level above ${state.yearLevel || '[YEAR LEVEL]'} (e.g., if Year 9, target Year 10 content and skills)

EXTENSION GUIDELINES:
- Questions must align with the NEXT year level's curriculum standards and learning outcomes
- Draw on content, terminology, and conceptual depth from the next curriculum level
- Incorporate skills and applications typically introduced at the next level
- Increase cognitive complexity (move up Bloom's levels where appropriate)
- Incorporate multi-step reasoning or synthesis of concepts
- Use more sophisticated contexts or novel applications
- Maintain plausible distractors based on advanced misconceptions
- Questions should stretch capable students toward next-level readiness

Format each question as:
Question X: [Cognitive Level] - Extension to [Next Year Level]
[Extension question stem]
   A. [Extension option]
   B. [Extension option]
   C. [Extension option]
   D. [Extension option]

CRITICAL: You MUST include a COMPLETE ANSWER KEY with full explanations for EVERY extension question:
- Correct answer
- Curriculum link: [Which next-level standard or outcome this addresses]
- Why correct (detailed explanation appropriate for advanced understanding)
- Why each incorrect option is wrong (advanced misconception analysis)
- Extension learning hint (pointing to deeper concepts at the next curriculum level)

Format as ${exportFormat}.`
                });
            }

            // 6. Final Review & Export
            prompts.push({
                title: 'Final Review & Export',
                content: `Perform final comprehensive review and provide the complete formatted output.

VERIFICATION CHECKLIST:

1. COUNT VERIFICATION:
   - Total questions: ${isBoth ? `${questionsPerSet} per set` : questionsPerSet}
   - Cognitive level distribution matches: ${cogDist}
   ${isBoth ? '- Both Practice and Assessment sets cover same content with DIFFERENT questions' : ''}

2. FORMAT VERIFICATION:
   - All questions use A, B, C, D format
   - Options properly indented
   - Unicode symbols correct (Œî, œÄ, ‚â†, ‚â§, ‚â•, Œº, ¬∞C, √ó, √∑, ¬≤, ¬≥)
   - ${state.answerPosition === 'fixedA' ? 'Option A is correct for all questions' : 'Correct answers distributed evenly'}

3. QUALITY VERIFICATION:
   - No grammatical errors
   - No ambiguous questions
   - All distractors plausible
   - All questions align with learning objectives

4. ANSWER KEY COMPLETENESS:
   - EVERY question has a complete answer key entry
   - All explanations are accurate and updated
   - Misconception descriptions are specific and valid
   - Learning hints are pedagogically sound

5. ACCESSIBILITY:
   - Clear, readable formatting
   - Appropriate language for ${state.yearLevel || '[YEAR LEVEL]'}
   - No culturally biased content

FINAL OUTPUT as ${exportFormat}:

${state.setType === 'practice' ? `
PRACTICE SET DOCUMENT:
1. Title page with subject, year level, "Practice Questions"
2. All ${questionsPerSet} questions numbered sequentially
3. Page break
4. ANSWER KEY AND EXPLANATIONS section with complete explanations for every question` : ''}

${state.setType === 'real' ? `
ASSESSMENT DOCUMENT (Student Version):
1. Title page with subject, year level
2. All ${questionsPerSet} questions numbered sequentially
3. No answers shown

TEACHER ANSWER KEY (Separate Document):
1. Quick reference table: Question | Answer | Cognitive Level | Key Concept
2. Complete explanations for every question:
   - Correct answer and why
   - Each distractor's targeted misconception
   - Teaching notes for remediation` : ''}

${state.setType === 'both' ? `
PRACTICE SET DOCUMENT:
1. Title: "${state.subject} Practice Questions"
2. ${questionsPerSet} questions numbered P1-P${questionsPerSet}
3. ANSWER KEY section with complete explanations for all practice questions

ASSESSMENT DOCUMENT (Student Version):
1. Title: "${state.subject} Assessment"
2. ${questionsPerSet} questions numbered A1-A${questionsPerSet}
3. Questions cover SAME CONTENT as practice but are DIFFERENT questions
4. No answers shown

TEACHER ANSWER KEY (Separate Document):
1. Quick reference table for assessment questions
2. Complete explanations for all ${questionsPerSet} assessment questions
3. Correlation notes showing which practice questions cover similar content` : ''}

Confirm all checks pass. Provide the complete, final documents.`
            });

            return prompts;
        }

        function buildQuestionGenerationPrompt(setType, questionCount, cogDist, answerPosNote, exportFormat, isBothMode) {
            const isPractice = setType === 'practice';
            const setLabel = isPractice ? 'PRACTICE' : 'ASSESSMENT';
            const prefix = isBothMode ? (isPractice ? 'P' : 'A') : '';
            const numbering = prefix ? `${prefix}1, ${prefix}2, ... ${prefix}${questionCount}` : `1, 2, 3, ... ${questionCount}`;

            return `Generate ${questionCount} multiple choice questions for ${state.subject || '[SUBJECT]'} ${state.yearLevel || '[YEAR LEVEL]'} based on the content analysis and blueprint.

${isBothMode ? `THIS IS THE ${setLabel} SET.
${isPractice ? 'These questions are for student self-study with full explanations.' : 'These questions are for formal assessment. They must cover the SAME CONTENT as the practice set but use DIFFERENT questions to maintain assessment validity.'}` : ''}

ASSESSMENT TYPE: ${getPurposeDescription()}

COGNITIVE LEVEL DISTRIBUTION:
${cogDist}

QUESTION CONSTRUCTION REQUIREMENTS:

Structure:
- Exactly 4 options (A, B, C, D) per question
- Number questions as: ${numbering}
- Format:
  Question ${prefix || ''}[number]: [Cognitive Level]
  [Question stem]
     A. [Option]
     B. [Option]
     C. [Option]
     D. [Option]
- ${answerPosNote}

Distractor Quality (CRITICAL):
- Base ALL distractors on common misconceptions from content analysis
- Ensure distractors are plausible in context, scope, and magnitude
- NO joke answers, obviously wrong options, or "All/None of the above"

Answer Length & Grammar:
- Correct answer must NOT be systematically longer than distractors
- All options grammatically consistent with stem
- Parallel structure across all options

Content:
- Cover all key concepts from blueprint
- Use novel scenarios (not verbatim from teaching materials)
- Higher-order questions include scenarios/data requiring analysis
${isBothMode && !isPractice ? '- Use DIFFERENT questions from the Practice Set while covering the same content areas and cognitive distribution' : ''}

Formatting:
- Use proper Unicode symbols: Œî, œÄ, ‚â†, ‚â§, ‚â•, Œº, ¬∞C, √ó, √∑, ¬≤, ¬≥

OUTPUT REQUIREMENTS:

First, provide ALL ${questionCount} questions.

Then, provide a COMPLETE ANSWER KEY with explanations for EVERY question:

${isPractice ? `ANSWER KEY AND EXPLANATIONS:

Question ${prefix || ''}1:
- Correct Answer: [Letter]
- Why correct: [2-3 sentence explanation]
- Why A is incorrect: [specific misconception] (skip if A is correct)
- Why B is incorrect: [specific misconception] (skip if B is correct)
- Why C is incorrect: [specific misconception] (skip if C is correct)
- Why D is incorrect: [specific misconception] (skip if D is correct)
- Learning hint: [teaching point for students who got this wrong]

[Repeat for all ${questionCount} questions]` : `TEACHER ANSWER KEY:

Quick Reference:
| Question | Answer | Cognitive Level | Key Concept |
|----------|--------|-----------------|-------------|
| ${prefix || ''}1 | [Letter] | [Level] | [Concept] |
[Continue for all questions]

Detailed Explanations:

Question ${prefix || ''}1:
- Correct Answer: [Letter]
- Cognitive Level: [Level]
- Why correct: [2-3 sentence explanation]
- Distractor analysis:
  * A: [misconception this targets]
  * B: [misconception this targets]
  * C: [misconception this targets]
  * D: [misconception this targets]
- Remediation note: [what to review with students who chose wrong answers]

[Repeat for all ${questionCount} questions]`}

Format output as ${exportFormat}.

Begin generating questions now.`;
        }

        function updateGenerateStatus(count) {
            const indicator = document.getElementById('generateStatus');
            const text = document.getElementById('generateStatusText');
            indicator.classList.add('ready');
            text.textContent = `${count} prompts ready`;
        }

        function togglePrompt(card) {
            card.classList.toggle('expanded');
        }

        function copyPrompt(index) {
            const textarea = document.getElementById(`prompt-${index}`);
            textarea.select();
            document.execCommand('copy');
            
            const feedback = document.getElementById(`feedback-${index}`);
            feedback.classList.add('show');
            setTimeout(() => feedback.classList.remove('show'), 2000);
            
            showToast('Prompt copied to clipboard');
        }

        function toggleResource(id) {
            const card = document.getElementById(id);
            card.classList.toggle('expanded');
        }

        function copyResource(contentId) {
            const content = document.getElementById(contentId);
            const text = content.innerText || content.textContent;
            
            const textarea = document.createElement('textarea');
            textarea.value = text;
            document.body.appendChild(textarea);
            textarea.select();
            document.execCommand('copy');
            document.body.removeChild(textarea);
            
            const feedback = document.getElementById(`${contentId}Feedback`);
            if (feedback) {
                feedback.classList.add('show');
                setTimeout(() => feedback.classList.remove('show'), 2000);
            }
            
            showToast('Copied to clipboard');
        }

        function toggleSettings() {
            const panel = document.getElementById('settingsPanel');
            const overlay = document.getElementById('settingsOverlay');
            panel.classList.toggle('open');
            overlay.classList.toggle('show');
        }

        function saveState() {
            localStorage.setItem('mcgen_state', JSON.stringify(state));
        }

        function loadState() {
            const saved = localStorage.getItem('mcgen_state');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    state = { ...state, ...parsed };
                    applyStateToForm();
                } catch (e) {
                    console.error('Failed to load state:', e);
                }
            }
        }

        function applyStateToForm() {
            ['subject', 'yearLevel', 'questionCount', 'exportFormat', 'teachingContent', 'topicsBreakdown'].forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = state[id];
            });

            const purposeRadio = document.querySelector(`input[name="purpose"][value="${state.purpose}"]`);
            if (purposeRadio) purposeRadio.checked = true;
            
            const setTypeRadio = document.querySelector(`input[name="setType"][value="${state.setType}"]`);
            if (setTypeRadio) setTypeRadio.checked = true;
            
            const answerPosRadio = document.querySelector(`input[name="answerPosition"][value="${state.answerPosition}"]`);
            if (answerPosRadio) answerPosRadio.checked = true;

            document.getElementById('optSimplified').checked = state.optSimplified;
            document.getElementById('optExtension').checked = state.optExtension;

            cogLevels.forEach(level => {
                const el = document.getElementById(`cog${level}`);
                if (el) el.value = state[`cog${level}`];
            });
        }

        function pushHistory() {
            history = history.slice(0, historyIndex + 1);
            history.push(JSON.stringify(state));
            if (history.length > MAX_HISTORY) history.shift();
            historyIndex = history.length - 1;
        }

        function undo() {
            if (historyIndex > 0) {
                historyIndex--;
                state = JSON.parse(history[historyIndex]);
                applyStateToForm();
                updateCognitiveDisplay();
                updateSetupStatus();
                showToast('Undo');
            }
        }

        function redo() {
            if (historyIndex < history.length - 1) {
                historyIndex++;
                state = JSON.parse(history[historyIndex]);
                applyStateToForm();
                updateCognitiveDisplay();
                updateSetupStatus();
                showToast('Redo');
            }
        }

        function exportConfig() {
            const data = JSON.stringify(state, null, 2);
            const blob = new Blob([data], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `mc-config-${new Date().toISOString().split('T')[0]}.json`;
            a.click();
            URL.revokeObjectURL(url);
            showToast('Configuration exported');
        }

        function importConfig() {
            document.getElementById('importFile').click();
        }

        function handleImport(e) {
            const file = e.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    pushHistory();
                    state = { ...state, ...imported };
                    applyStateToForm();
                    updateCognitiveDisplay();
                    updateSetupStatus();
                    saveState();
                    showToast('Configuration imported');
                } catch (err) {
                    showToast('Invalid configuration file');
                }
            };
            reader.readAsText(file);
            e.target.value = '';
        }

        function clearAllData() {
            if (confirm('Clear all saved data? This cannot be undone.')) {
                localStorage.removeItem('mcgen_state');
                location.reload();
            }
        }

        function resetForm() {
            pushHistory();
            state = {
                subject: '',
                yearLevel: '',
                questionCount: 20,
                exportFormat: 'docx',
                purpose: 'formative',
                setType: 'real',
                optSimplified: false,
                optExtension: false,
                answerPosition: 'randomize',
                cogRemember: 15,
                cogUnderstand: 25,
                cogApply: 30,
                cogAnalyze: 20,
                cogEvaluate: 10,
                cogCreate: 0,
                teachingContent: '',
                topicsBreakdown: ''
            };
            lockedLevels.clear();
            document.querySelectorAll('.lock-btn').forEach(btn => {
                btn.classList.remove('locked');
                btn.textContent = 'üîì';
            });
            document.querySelectorAll('input[type="range"]').forEach(slider => {
                slider.classList.remove('locked');
            });
            applyStateToForm();
            updateCognitiveDisplay();
            updateSetupStatus();
            saveState();
            showToast('Form reset');
        }

        function goToGenerate() {
            switchTab('generate');
        }

        function showToast(message) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            setTimeout(() => toast.classList.remove('show'), 2500);
        }
    </script>
</body>
</html>