<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Debug Tool - You Can't Fake This</title>
    <style>
        body {
            font-family: 'Courier New', monospace;
            margin: 20px;
            background: #1a1a1a;
            color: #00ff00;
        }
        h1 {
            color: #00ffff;
            border-bottom: 2px solid #00ffff;
            padding-bottom: 10px;
        }
        .test-section {
            margin: 20px 0;
            padding: 15px;
            border: 1px solid #333;
            background: #0a0a0a;
            border-radius: 5px;
        }
        .test-title {
            color: #ffff00;
            font-weight: bold;
            margin-bottom: 10px;
        }
        .success {
            color: #00ff00;
            padding: 5px;
            margin: 5px 0;
        }
        .error {
            color: #ff0000;
            padding: 5px;
            margin: 5px 0;
        }
        .warning {
            color: #ffaa00;
            padding: 5px;
            margin: 5px 0;
        }
        .info {
            color: #00aaff;
            padding: 5px;
            margin: 5px 0;
        }
        button {
            background: #00ffff;
            color: #000;
            border: none;
            padding: 10px 20px;
            margin: 10px 5px;
            cursor: pointer;
            font-weight: bold;
            border-radius: 3px;
        }
        button:hover {
            background: #00cccc;
        }
        pre {
            background: #2a2a2a;
            padding: 10px;
            border-radius: 3px;
            overflow-x: auto;
            color: #fff;
        }
        .json-preview {
            max-height: 300px;
            overflow-y: auto;
        }
        input[type="text"] {
            background: #2a2a2a;
            color: #00ff00;
            border: 1px solid #00ff00;
            padding: 5px;
            width: 300px;
            margin: 5px;
        }
        .path-display {
            background: #2a2a2a;
            padding: 8px;
            margin: 5px 0;
            border-left: 3px solid #00ffff;
            font-family: monospace;
        }
    </style>
</head>
<body>
    <h1>üîç Debug Tool - You Can't Fake This Platform</h1>
    
    <div class="test-section">
        <div class="test-title">üìã Test Configuration</div>
        <div id="config-display"></div>
        <button onclick="testAll()">üöÄ Run All Tests</button>
        <button onclick="clearResults()">üóëÔ∏è Clear Results</button>
    </div>

    <div class="test-section">
        <div class="test-title">Test 1: Check Current Location</div>
        <div id="test1-result"></div>
    </div>

    <div class="test-section">
        <div class="test-title">Test 2: Load Manifest</div>
        <div id="test2-result"></div>
        <button onclick="testManifest()">Test Manifest</button>
    </div>

    <div class="test-section">
        <div class="test-title">Test 3: Validate Manifest Structure</div>
        <div id="test3-result"></div>
        <button onclick="validateManifest()">Validate Structure</button>
    </div>

    <div class="test-section">
        <div class="test-title">Test 4: Load Specific Topic File</div>
        <input type="text" id="subject-input" placeholder="Subject (e.g., physics)" value="physics">
        <input type="text" id="filename-input" placeholder="Filename (e.g., U4-AOS1-11-Comparing-Light-Matter.json)" value="U4-AOS1-11-Comparing-Light-Matter.json">
        <button onclick="testTopicFile()">Test Topic File</button>
        <div id="test4-result"></div>
    </div>

    <div class="test-section">
        <div class="test-title">Test 5: Check All Topic Files from Manifest</div>
        <div id="test5-result"></div>
        <button onclick="testAllTopics()">Test All Topics</button>
    </div>

    <div class="test-section">
        <div class="test-title">Test 6: CORS and Headers Check</div>
        <div id="test6-result"></div>
        <button onclick="testCORS()">Test CORS</button>
    </div>

    <div class="test-section">
        <div class="test-title">Test 7: Directory Structure Check</div>
        <div id="test7-result"></div>
        <button onclick="testDirectoryStructure()">Test Directory</button>
    </div>

    <div class="test-section">
        <div class="test-title">Test 8: Console Log Monitor</div>
        <pre id="console-log" class="json-preview"></pre>
    </div>

    <script>
        // Configuration
        const CONFIG = {
            manifestPath: 'youcantfakethis/manifest.json',
            contentPath: 'youcantfakethis/'
        };

        // Custom console log
        const logToPage = (message, type = 'info') => {
            const consoleEl = document.getElementById('console-log');
            const timestamp = new Date().toISOString().split('T')[1].split('.')[0];
            const colorClass = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            consoleEl.innerHTML += `<span class="${colorClass}">[${timestamp}] ${message}</span>\n`;
            consoleEl.scrollTop = consoleEl.scrollHeight;
        };

        // Override console methods
        const originalLog = console.log;
        const originalError = console.error;
        console.log = (...args) => {
            originalLog(...args);
            logToPage(args.join(' '), 'info');
        };
        console.error = (...args) => {
            originalError(...args);
            logToPage(args.join(' '), 'error');
        };

        // Display configuration
        document.getElementById('config-display').innerHTML = `
            <div class="path-display">Manifest Path: ${CONFIG.manifestPath}</div>
            <div class="path-display">Content Path: ${CONFIG.contentPath}</div>
            <div class="path-display">Current URL: ${window.location.href}</div>
        `;

        // Test 1: Check current location
        function testLocation() {
            const result = document.getElementById('test1-result');
            result.innerHTML = `
                <div class="info">Protocol: ${window.location.protocol}</div>
                <div class="info">Host: ${window.location.host}</div>
                <div class="info">Pathname: ${window.location.pathname}</div>
                <div class="info">Full URL: ${window.location.href}</div>
            `;
            
            if (window.location.protocol === 'file:') {
                result.innerHTML += `<div class="warning">‚ö†Ô∏è Running from file:// protocol. This may cause CORS issues!</div>`;
            } else {
                result.innerHTML += `<div class="success">‚úÖ Running from ${window.location.protocol} protocol</div>`;
            }
        }

        // Test 2: Load Manifest
        async function testManifest() {
            const result = document.getElementById('test2-result');
            result.innerHTML = '<div class="info">Testing manifest load...</div>';
            
            const fullPath = `${window.location.origin}/${CONFIG.manifestPath}`;
            result.innerHTML += `<div class="path-display">Attempting to load: ${CONFIG.manifestPath}</div>`;
            result.innerHTML += `<div class="path-display">Full URL: ${fullPath}</div>`;
            
            try {
                const startTime = Date.now();
                const response = await fetch(CONFIG.manifestPath);
                const loadTime = Date.now() - startTime;
                
                result.innerHTML += `<div class="info">Response Status: ${response.status} ${response.statusText}</div>`;
                result.innerHTML += `<div class="info">Load Time: ${loadTime}ms</div>`;
                
                // Check headers
                const contentType = response.headers.get('content-type');
                result.innerHTML += `<div class="info">Content-Type: ${contentType || 'Not set'}</div>`;
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                result.innerHTML += `<div class="success">‚úÖ Manifest loaded successfully!</div>`;
                
                // Show preview
                result.innerHTML += `<div class="info">Manifest Preview:</div>`;
                result.innerHTML += `<pre class="json-preview">${JSON.stringify(data, null, 2)}</pre>`;
                
                // Store for other tests
                window.manifestData = data;
                
                return data;
            } catch (error) {
                result.innerHTML += `<div class="error">‚ùå Failed to load manifest: ${error.message}</div>`;
                
                // Common issues
                if (error.message.includes('404')) {
                    result.innerHTML += `<div class="warning">üìÅ File not found. Check if '${CONFIG.manifestPath}' exists</div>`;
                } else if (error.message.includes('Failed to fetch')) {
                    result.innerHTML += `<div class="warning">üîå Network error. Check if server is running or CORS is blocking</div>`;
                } else if (error.message.includes('JSON')) {
                    result.innerHTML += `<div class="warning">üìù Invalid JSON format in manifest file</div>`;
                }
                
                throw error;
            }
        }

        // Test 3: Validate Manifest Structure
        async function validateManifest() {
            const result = document.getElementById('test3-result');
            result.innerHTML = '<div class="info">Validating manifest structure...</div>';
            
            try {
                // Load manifest if not already loaded
                if (!window.manifestData) {
                    await testManifest();
                }
                
                const manifest = window.manifestData;
                let errors = [];
                let warnings = [];
                
                // Check required fields
                if (!manifest.subjects) {
                    errors.push('Missing "subjects" array');
                } else if (!Array.isArray(manifest.subjects)) {
                    errors.push('"subjects" must be an array');
                } else {
                    result.innerHTML += `<div class="success">‚úÖ Found ${manifest.subjects.length} subjects</div>`;
                    
                    // Check each subject
                    manifest.subjects.forEach((subject, i) => {
                        if (!subject.id) errors.push(`Subject ${i} missing "id"`);
                        if (!subject.name) warnings.push(`Subject ${i} missing "name"`);
                        if (!subject.units) errors.push(`Subject ${i} missing "units"`);
                        
                        if (subject.units && Array.isArray(subject.units)) {
                            subject.units.forEach((unit, j) => {
                                if (!unit.id) errors.push(`Subject ${i} Unit ${j} missing "id"`);
                                if (!unit.areasOfStudy) errors.push(`Subject ${i} Unit ${j} missing "areasOfStudy"`);
                                
                                if (unit.areasOfStudy && Array.isArray(unit.areasOfStudy)) {
                                    unit.areasOfStudy.forEach((aos, k) => {
                                        if (!aos.id) errors.push(`Subject ${i} Unit ${j} AOS ${k} missing "id"`);
                                        if (!aos.topics) errors.push(`Subject ${i} Unit ${j} AOS ${k} missing "topics"`);
                                        
                                        if (aos.topics && Array.isArray(aos.topics)) {
                                            aos.topics.forEach((topic, l) => {
                                                if (!topic.id) errors.push(`Topic ${l} missing "id"`);
                                                if (!topic.filename) errors.push(`Topic ${l} missing "filename"`);
                                                
                                                // Show topic info
                                                result.innerHTML += `<div class="info">  üìÑ ${subject.id}/${topic.filename} (${topic.status || 'no status'})</div>`;
                                            });
                                        }
                                    });
                                }
                            });
                        }
                    });
                }
                
                // Display results
                if (errors.length > 0) {
                    result.innerHTML += '<div class="error">‚ùå Structure Errors:</div>';
                    errors.forEach(err => {
                        result.innerHTML += `<div class="error">  ‚Ä¢ ${err}</div>`;
                    });
                }
                
                if (warnings.length > 0) {
                    result.innerHTML += '<div class="warning">‚ö†Ô∏è Warnings:</div>';
                    warnings.forEach(warn => {
                        result.innerHTML += `<div class="warning">  ‚Ä¢ ${warn}</div>`;
                    });
                }
                
                if (errors.length === 0) {
                    result.innerHTML += '<div class="success">‚úÖ Manifest structure is valid!</div>';
                }
                
            } catch (error) {
                result.innerHTML += `<div class="error">‚ùå Validation failed: ${error.message}</div>`;
            }
        }

        // Test 4: Load specific topic file
        async function testTopicFile() {
            const result = document.getElementById('test4-result');
            const subject = document.getElementById('subject-input').value;
            const filename = document.getElementById('filename-input').value;
            
            if (!subject || !filename) {
                result.innerHTML = '<div class="error">‚ùå Please enter both subject and filename</div>';
                return;
            }
            
            const path = `${CONFIG.contentPath}${subject}/${filename}`;
            const fullPath = `${window.location.origin}/${path}`;
            
            result.innerHTML = `<div class="info">Testing topic file load...</div>`;
            result.innerHTML += `<div class="path-display">Path: ${path}</div>`;
            result.innerHTML += `<div class="path-display">Full URL: ${fullPath}</div>`;
            
            try {
                const startTime = Date.now();
                const response = await fetch(path);
                const loadTime = Date.now() - startTime;
                
                result.innerHTML += `<div class="info">Response Status: ${response.status} ${response.statusText}</div>`;
                result.innerHTML += `<div class="info">Load Time: ${loadTime}ms</div>`;
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const data = await response.json();
                result.innerHTML += `<div class="success">‚úÖ Topic file loaded successfully!</div>`;
                
                // Validate topic structure
                if (data.metadata) {
                    result.innerHTML += `<div class="success">‚úÖ Has metadata</div>`;
                    if (data.metadata.tabs) {
                        result.innerHTML += `<div class="success">‚úÖ Has ${data.metadata.tabs.length} tabs</div>`;
                    }
                }
                
                if (data.content) {
                    result.innerHTML += `<div class="success">‚úÖ Has content</div>`;
                    const rounds = Object.keys(data.content);
                    result.innerHTML += `<div class="info">  Rounds: ${rounds.join(', ')}</div>`;
                }
                
                // Show preview
                result.innerHTML += `<div class="info">Topic Preview (first 500 chars):</div>`;
                const preview = JSON.stringify(data, null, 2).substring(0, 500);
                result.innerHTML += `<pre class="json-preview">${preview}...</pre>`;
                
            } catch (error) {
                result.innerHTML += `<div class="error">‚ùå Failed to load topic: ${error.message}</div>`;
                
                if (error.message.includes('404')) {
                    result.innerHTML += `<div class="warning">üìÅ File not found at: ${path}</div>`;
                    result.innerHTML += `<div class="warning">Make sure the file exists and path is correct</div>`;
                }
            }
        }

        // Test 5: Check all topics from manifest
        async function testAllTopics() {
            const result = document.getElementById('test5-result');
            result.innerHTML = '<div class="info">Testing all topic files from manifest...</div>';
            
            try {
                if (!window.manifestData) {
                    await testManifest();
                }
                
                const manifest = window.manifestData;
                let totalTopics = 0;
                let successCount = 0;
                let failedTopics = [];
                
                for (const subject of manifest.subjects) {
                    for (const unit of subject.units || []) {
                        for (const aos of unit.areasOfStudy || []) {
                            for (const topic of aos.topics || []) {
                                totalTopics++;
                                const path = `${CONFIG.contentPath}${subject.id}/${topic.filename}`;
                                
                                try {
                                    const response = await fetch(path);
                                    if (response.ok) {
                                        successCount++;
                                        result.innerHTML += `<div class="success">‚úÖ ${path}</div>`;
                                    } else {
                                        failedTopics.push({path, status: response.status});
                                        result.innerHTML += `<div class="error">‚ùå ${path} (${response.status})</div>`;
                                    }
                                } catch (error) {
                                    failedTopics.push({path, error: error.message});
                                    result.innerHTML += `<div class="error">‚ùå ${path} (${error.message})</div>`;
                                }
                            }
                        }
                    }
                }
                
                // Summary
                result.innerHTML += `<div class="info">üìä Summary: ${successCount}/${totalTopics} topics loaded successfully</div>`;
                
                if (failedTopics.length > 0) {
                    result.innerHTML += '<div class="error">Failed topics:</div>';
                    failedTopics.forEach(topic => {
                        result.innerHTML += `<div class="error">  ‚Ä¢ ${topic.path}</div>`;
                    });
                }
                
            } catch (error) {
                result.innerHTML += `<div class="error">‚ùå Test failed: ${error.message}</div>`;
            }
        }

        // Test 6: CORS and Headers
        async function testCORS() {
            const result = document.getElementById('test6-result');
            result.innerHTML = '<div class="info">Testing CORS and headers...</div>';
            
            try {
                const response = await fetch(CONFIG.manifestPath);
                
                // Check important headers
                const headers = {
                    'content-type': response.headers.get('content-type'),
                    'access-control-allow-origin': response.headers.get('access-control-allow-origin'),
                    'cache-control': response.headers.get('cache-control')
                };
                
                result.innerHTML += '<div class="info">Response Headers:</div>';
                for (const [key, value] of Object.entries(headers)) {
                    if (value) {
                        result.innerHTML += `<div class="info">  ${key}: ${value}</div>`;
                    } else {
                        result.innerHTML += `<div class="warning">  ${key}: Not set</div>`;
                    }
                }
                
                // Check content type
                if (headers['content-type']?.includes('json')) {
                    result.innerHTML += '<div class="success">‚úÖ Content-Type is JSON</div>';
                } else {
                    result.innerHTML += '<div class="warning">‚ö†Ô∏è Content-Type should be application/json</div>';
                }
                
                // CORS check
                if (window.location.protocol === 'file:') {
                    result.innerHTML += '<div class="warning">‚ö†Ô∏è Running from file:// - CORS may be an issue</div>';
                } else if (headers['access-control-allow-origin']) {
                    result.innerHTML += '<div class="success">‚úÖ CORS headers present</div>';
                } else {
                    result.innerHTML += '<div class="info">‚ÑπÔ∏è No CORS headers (may not be needed for same-origin)</div>';
                }
                
            } catch (error) {
                result.innerHTML += `<div class="error">‚ùå CORS test failed: ${error.message}</div>`;
                
                if (error.message.includes('Failed to fetch')) {
                    result.innerHTML += '<div class="error">This might be a CORS issue. Check browser console for details.</div>';
                }
            }
        }

        // Test 7: Directory structure
        async function testDirectoryStructure() {
            const result = document.getElementById('test7-result');
            result.innerHTML = '<div class="info">Testing directory structure...</div>';
            
            const paths = [
                'youcantfakethis/',
                'youcantfakethis/manifest.json',
                'youcantfakethis/physics/',
                'youcantfakethis/chemistry/',
                'youcantfakethis/biology/'
            ];
            
            for (const path of paths) {
                try {
                    const response = await fetch(path);
                    if (response.ok || response.status === 403 || response.status === 200) {
                        result.innerHTML += `<div class="success">‚úÖ ${path} exists</div>`;
                    } else {
                        result.innerHTML += `<div class="error">‚ùå ${path} (${response.status})</div>`;
                    }
                } catch (error) {
                    result.innerHTML += `<div class="error">‚ùå ${path} (${error.message})</div>`;
                }
            }
            
            result.innerHTML += '<div class="info">Note: Some servers block directory listing (403), which is normal.</div>';
        }

        // Run all tests
        async function testAll() {
            console.log('Starting all tests...');
            testLocation();
            
            await testManifest();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await validateManifest();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testTopicFile();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testCORS();
            await new Promise(resolve => setTimeout(resolve, 500));
            
            await testDirectoryStructure();
            
            console.log('All tests completed!');
        }

        // Clear results
        function clearResults() {
            const resultDivs = [
                'test1-result', 'test2-result', 'test3-result', 
                'test4-result', 'test5-result', 'test6-result', 
                'test7-result', 'console-log'
            ];
            
            resultDivs.forEach(id => {
                document.getElementById(id).innerHTML = '';
            });
        }

        // Auto-run location test on load
        window.onload = () => {
            testLocation();
            console.log('Debug tool loaded. Click "Run All Tests" to begin.');
        };
    </script>
</body>
</html>