<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VCE Examiner's Advice</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #1a1a2e;
            --secondary: #16213e;
            --tertiary: #0f3460;
            --accent: #e94560;
            --accent-dark: #c73e54;
            --success: #4caf50;
            --warning: #ff9800;
            --error: #f44336;
            --neutral: #607d8b;
            --text: #ffffff;
            --text-muted: #b0b0b0;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: var(--primary);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
        }

        /* Loading State */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--primary);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            flex-direction: column;
            gap: 1rem;
        }

        .loading-overlay.hidden {
            display: none;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--tertiary);
            border-top-color: var(--accent);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--text-muted);
            font-size: 1rem;
        }

        /* Error State */
        .error-message {
            background: rgba(244, 67, 54, 0.2);
            border: 1px solid var(--error);
            color: var(--text);
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
            margin: 2rem auto;
            max-width: 500px;
        }

        .error-message h2 {
            color: var(--error);
            margin-bottom: 0.5rem;
        }

        /* Header */
        header {
            background: var(--secondary);
            padding: 1.5rem;
            border-bottom: 2px solid var(--accent);
            margin-bottom: 1rem;
            border-radius: 8px 8px 0 0;
        }

        h1 {
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 1rem;
            color: var(--accent);
        }

        .header-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            align-items: flex-end;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }

        .control-group label {
            font-size: 0.8rem;
            color: var(--text-muted);
            font-weight: 500;
        }

        .control-group input,
        .control-group select {
            padding: 0.5rem 0.75rem;
            background: var(--tertiary);
            border: 1px solid var(--accent-dark);
            color: var(--text);
            border-radius: 4px;
            font-size: 0.9rem;
            min-width: 200px;
        }

        .control-group input::placeholder {
            color: var(--neutral);
        }

        .control-group select:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .control-group select option:disabled {
            color: var(--neutral);
        }

        .control-group select option {
            background: var(--secondary);
            color: var(--text);
        }

        /* Tabs */
        .tabs {
            display: flex;
            gap: 0.5rem;
            background: var(--secondary);
            padding: 0.5rem;
            border-radius: 4px;
            margin-bottom: 1rem;
        }

        .tab {
            flex: 1;
            padding: 0.75rem;
            background: var(--tertiary);
            border: 1px solid transparent;
            color: var(--text-muted);
            cursor: pointer;
            text-align: center;
            border-radius: 4px;
            transition: all 0.3s;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .tab:hover {
            background: var(--secondary);
            border-color: var(--accent-dark);
        }

        .tab.active {
            background: var(--accent-dark);
            color: var(--text);
            border-color: var(--accent);
        }

        .tab-content {
            display: none;
            background: var(--secondary);
            padding: 1.5rem;
            border-radius: 4px;
            min-height: 500px;
        }

        .tab-content.active {
            display: block;
        }

        /* No Subject Selected */
        .no-subject {
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-muted);
        }

        .no-subject h2 {
            font-size: 1.5rem;
            margin-bottom: 1rem;
            color: var(--text);
        }

        .no-subject p {
            font-size: 1rem;
            max-width: 400px;
            margin: 0 auto;
        }

        /* Category Select */
        .category-select {
            margin-bottom: 1rem;
        }

        .category-select select {
            width: 100%;
            padding: 0.75rem;
            background: var(--tertiary);
            border: 1px solid var(--accent-dark);
            color: var(--text);
            border-radius: 4px;
            font-size: 0.9rem;
            cursor: pointer;
            font-weight: 500;
        }

        /* Progress Bar */
        .progress-bar {
            background: var(--tertiary);
            height: 24px;
            border-radius: 12px;
            overflow: hidden;
            margin-bottom: 1rem;
            position: relative;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--accent-dark), var(--accent));
            transition: width 0.3s;
        }

        .progress-text {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--text);
            text-shadow: 0 1px 2px rgba(0,0,0,0.5);
        }

        /* Question Card */
        .question-card {
            background: var(--tertiary);
            padding: 1.5rem;
            border-radius: 8px;
            border: 2px solid transparent;
            margin-bottom: 1rem;
            transition: all 0.3s;
        }

        .question-card.active {
            border-color: var(--accent);
            box-shadow: 0 0 20px rgba(233, 69, 96, 0.2);
        }

        .question-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        .question-concept {
            font-size: 0.8rem;
            color: var(--accent);
            margin-bottom: 0.5rem;
            font-weight: 500;
        }

        .question-text {
            font-size: 1.1rem;
            line-height: 1.8;
            margin-bottom: 1.5rem;
            color: var(--text);
        }

        .answer-buttons {
            display: flex;
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .answer-btn {
            flex: 1;
            padding: 1rem;
            border: 2px solid var(--accent-dark);
            background: var(--secondary);
            color: var(--text);
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .answer-btn:hover:not(:disabled) {
            background: var(--tertiary);
            border-color: var(--accent);
            transform: translateY(-2px);
        }

        .answer-btn:active {
            transform: translateY(0);
        }

        .answer-btn.selected {
            background: var(--accent-dark);
            border-color: var(--accent);
        }

        .answer-btn.correct {
            background: var(--success);
            border-color: var(--success);
        }

        .answer-btn.incorrect {
            background: var(--error);
            border-color: var(--error);
        }

        .answer-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        /* Feedback */
        .feedback {
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1rem;
            display: none;
            font-size: 0.95rem;
            line-height: 1.6;
        }

        .feedback.show {
            display: block;
        }

        .feedback.correct {
            background: rgba(76, 175, 80, 0.2);
            border-left: 4px solid var(--success);
        }

        .feedback.incorrect {
            background: rgba(244, 67, 54, 0.2);
            border-left: 4px solid var(--error);
        }

        .feedback-header {
            font-weight: 600;
            margin-bottom: 0.5rem;
        }

        .study-tip {
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid rgba(255,255,255,0.1);
            font-style: italic;
            font-size: 0.9rem;
            color: var(--text-muted);
        }

        /* Status Indicator */
        .status-indicator {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .status-unanswered {
            background: var(--tertiary);
            color: var(--neutral);
        }

        .status-correct {
            background: rgba(76, 175, 80, 0.2);
            color: var(--success);
        }

        .status-incorrect {
            background: rgba(244, 67, 54, 0.2);
            color: var(--error);
        }

        /* Navigation */
        .navigation {
            display: flex;
            gap: 0.5rem;
            margin-top: 1.5rem;
            flex-wrap: wrap;
        }

        .nav-btn {
            padding: 0.75rem 1.5rem;
            background: var(--tertiary);
            border: 1px solid var(--accent-dark);
            color: var(--text);
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .nav-btn:hover {
            background: var(--accent-dark);
            border-color: var(--accent);
        }

        .nav-btn.primary {
            background: var(--accent-dark);
            border-color: var(--accent);
        }

        .nav-btn.primary:hover {
            background: var(--accent);
        }

        /* Category Summary */
        .category-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .category-card {
            background: var(--tertiary);
            padding: 1rem;
            border-radius: 8px;
            border-left: 4px solid var(--accent);
        }

        .category-card h3 {
            font-size: 0.95rem;
            margin-bottom: 0.5rem;
            color: var(--accent);
        }

        .category-card .stats {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* Keyboard Hint */
        .keyboard-hint {
            text-align: center;
            font-size: 0.8rem;
            color: var(--neutral);
            margin-top: 1rem;
            padding: 0.5rem;
            background: var(--primary);
            border-radius: 4px;
        }

        /* Mastery Overview */
        .mastery-overview {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .mastery-card {
            background: var(--tertiary);
            padding: 1.5rem;
            border-radius: 8px;
            text-align: center;
        }

        .mastery-number {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .mastery-card.mastered .mastery-number {
            color: var(--success);
        }

        .mastery-card.partial .mastery-number {
            color: var(--warning);
        }

        .mastery-card.needs-work .mastery-number {
            color: var(--error);
        }

        .mastery-card.not-attempted .mastery-number {
            color: var(--neutral);
        }

        .mastery-label {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* Concept List */
        .concept-list {
            margin-top: 1rem;
        }

        .concept-item {
            background: var(--tertiary);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            border-left: 4px solid var(--neutral);
        }

        .concept-item.mastered {
            border-left-color: var(--success);
        }

        .concept-item.partial {
            border-left-color: var(--warning);
        }

        .concept-item.needs-work {
            border-left-color: var(--error);
        }

        .concept-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }

        .concept-title {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .concept-details {
            font-size: 0.85rem;
            color: var(--text-muted);
            line-height: 1.6;
        }

        /* Filter Buttons */
        .filter-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            background: var(--tertiary);
            border: 1px solid var(--accent-dark);
            color: var(--text);
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.85rem;
            transition: all 0.3s;
        }

        .filter-btn:hover {
            background: var(--secondary);
        }

        .filter-btn.active {
            background: var(--accent-dark);
            border-color: var(--accent);
        }

        /* Utility Section */
        .utility-section {
            background: var(--tertiary);
            padding: 1.5rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .utility-section h3 {
            font-size: 1.1rem;
            margin-bottom: 1rem;
            color: var(--accent);
        }

        .utility-buttons {
            display: grid;
            gap: 0.75rem;
        }

        .utility-btn {
            padding: 1rem;
            background: var(--secondary);
            border: 1px solid var(--accent-dark);
            color: var(--text);
            cursor: pointer;
            border-radius: 4px;
            text-align: left;
            transition: all 0.3s;
            font-size: 0.9rem;
        }

        .utility-btn:hover {
            background: var(--tertiary);
            border-color: var(--accent);
        }

        .utility-btn.warning {
            border-color: var(--error);
            color: var(--error);
        }

        /* Stat Grid */
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .stat-item {
            background: var(--secondary);
            padding: 1rem;
            border-radius: 8px;
        }

        .stat-label {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-bottom: 0.25rem;
        }

        .stat-value {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--accent);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            padding: 1rem;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--secondary);
            padding: 2rem;
            border-radius: 8px;
            max-width: 500px;
            width: 100%;
            border: 2px solid var(--accent);
        }

        .modal-header {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            color: var(--accent);
        }

        .modal-body {
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .modal-buttons {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        .modal-btn {
            padding: 0.75rem 1.5rem;
            border: 1px solid var(--accent-dark);
            background: var(--tertiary);
            color: var(--text);
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.3s;
        }

        .modal-btn:hover {
            background: var(--accent-dark);
        }

        .modal-btn.primary {
            background: var(--accent-dark);
            border-color: var(--accent);
        }

        .modal-btn.primary:hover {
            background: var(--accent);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                padding: 0.5rem;
            }

            header {
                padding: 1rem;
            }

            h1 {
                font-size: 1.2rem;
            }

            .header-controls {
                flex-direction: column;
                align-items: stretch;
            }

            .control-group input,
            .control-group select {
                min-width: 100%;
            }

            .question-text {
                font-size: 1rem;
            }

            .answer-buttons {
                flex-direction: column;
            }

            .navigation {
                justify-content: center;
            }

            .nav-btn {
                flex: 1;
                min-width: 100px;
            }

            .mastery-overview {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-spinner"></div>
        <div class="loading-text">Loading VCE Examiner's Advice...</div>
    </div>

    <div class="container">
        <header>
            <h1>VCE Examiner's Advice</h1>
            <div class="header-controls">
                <div class="control-group">
                    <label for="studentName">Student Name</label>
                    <input type="text" id="studentName" placeholder="Enter your name">
                </div>
                <div class="control-group">
                    <label for="categorySelect">Study Area</label>
                    <select id="categorySelect" disabled>
                        <option value="">Loading...</option>
                    </select>
                </div>
                <div class="control-group">
                    <label for="subjectSelect">Subject</label>
                    <select id="subjectSelect" disabled>
                        <option value="">Select a study area first</option>
                    </select>
                </div>
            </div>
        </header>

        <div class="tabs">
            <div class="tab active" data-tab="questions">Questions</div>
            <div class="tab" data-tab="feedback">Feedback</div>
            <div class="tab" data-tab="utility">Utility</div>
        </div>

        <!-- Questions Tab -->
        <div class="tab-content active" id="questions-tab">
            <div id="noSubjectMessage" class="no-subject">
                <h2>Welcome to VCE Examiner's Advice</h2>
                <p>Select a study area and subject above to begin practising exam techniques and common misconceptions.</p>
            </div>

            <div id="questionsContent" style="display: none;">
                <div class="category-select">
                    <select id="questionCategorySelect">
                        <!-- Populated dynamically -->
                    </select>
                </div>

                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                    <div class="progress-text" id="progressText">0/0 (0%)</div>
                </div>

                <div id="questionContainer"></div>

                <div class="navigation">
                    <button class="nav-btn" id="prevBtn">‚Üê Previous</button>
                    <button class="nav-btn" id="skipBtn">Skip</button>
                    <button class="nav-btn primary" id="nextBtn">Next ‚Üí</button>
                </div>

                <div class="keyboard-hint">
                    Keyboard shortcuts: T (True) | F (False) | ‚Üê ‚Üí (Navigate)
                </div>

                <div class="category-summary" id="categorySummary"></div>
            </div>
        </div>

        <!-- Feedback Tab -->
        <div class="tab-content" id="feedback-tab">
            <div id="noSubjectFeedback" class="no-subject">
                <h2>No Subject Selected</h2>
                <p>Select a subject to view your progress and mastery levels.</p>
            </div>

            <div id="feedbackContent" style="display: none;">
                <div class="progress-bar">
                    <div class="progress-fill" id="overallProgressFill"></div>
                    <div class="progress-text" id="overallProgressText">0/0 (0%)</div>
                </div>

                <div class="mastery-overview">
                    <div class="mastery-card mastered">
                        <div class="mastery-number" id="masteredCount">0</div>
                        <div class="mastery-label">Mastered (2/2)</div>
                    </div>
                    <div class="mastery-card partial">
                        <div class="mastery-number" id="partialCount">0</div>
                        <div class="mastery-label">Partial (1/2)</div>
                    </div>
                    <div class="mastery-card needs-work">
                        <div class="mastery-number" id="needsWorkCount">0</div>
                        <div class="mastery-label">Needs Work (0/2)</div>
                    </div>
                    <div class="mastery-card not-attempted">
                        <div class="mastery-number" id="notAttemptedCount">0</div>
                        <div class="mastery-label">Not Attempted</div>
                    </div>
                </div>

                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="mastered">Mastered</button>
                    <button class="filter-btn" data-filter="partial">Partial</button>
                    <button class="filter-btn" data-filter="needs-work">Needs Work</button>
                    <button class="filter-btn" data-filter="not-attempted">Not Attempted</button>
                </div>

                <div class="concept-list" id="conceptList"></div>
            </div>
        </div>

        <!-- Utility Tab -->
        <div class="tab-content" id="utility-tab">
            <div class="utility-section">
                <h3>Session Management</h3>
                <div class="utility-buttons">
                    <button class="utility-btn" id="saveBtn">üíæ Save Progress</button>
                    <button class="utility-btn" id="exportBtn">üìä Export Results</button>
                    <button class="utility-btn" id="emailBtn">üìß Email to Teacher</button>
                    <button class="utility-btn warning" id="resetBtn">‚ö†Ô∏è Reset All Progress</button>
                </div>
            </div>

            <div class="utility-section">
                <h3>Statistics</h3>
                <div class="stat-grid">
                    <div class="stat-item">
                        <div class="stat-label">Questions Answered</div>
                        <div class="stat-value" id="statAnswered">0/0</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Accuracy Rate</div>
                        <div class="stat-value" id="statAccuracy">0%</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Current Subject</div>
                        <div class="stat-value" id="statSubject">-</div>
                    </div>
                    <div class="stat-item">
                        <div class="stat-label">Last Session</div>
                        <div class="stat-value" id="statLastSession">-</div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div class="modal" id="modal">
        <div class="modal-content">
            <div class="modal-header" id="modalHeader">Confirm Action</div>
            <div class="modal-body" id="modalBody">Are you sure?</div>
            <div class="modal-buttons">
                <button class="modal-btn" id="modalCancel">Cancel</button>
                <button class="modal-btn primary" id="modalConfirm">Confirm</button>
            </div>
        </div>
    </div>

    <script>
        // ========================================
        // VCE Examiner's Advice - Main Application
        // ========================================

        const CONFIG = {
            manifestPath: './manifest.json',
            dataBasePath: './data/'
        };

        // Application State
        let manifest = null;
        let subjectData = null;
        let randomisedQuestions = {}; // Stores shuffled question order per category

        let appState = {
            studentName: '',
            currentCategory: null,
            currentSubject: null,
            currentQuestionCategory: 0,
            currentQuestionIndex: 0,
            responses: {},
            filter: 'all',
            lastSaved: null
        };

        // ========================================
        // Initialisation
        // ========================================

        async function init() {
            try {
                await loadManifest();
                loadState();
                populateCategoryDropdown();
                setupEventListeners();
                hideLoading();

                // If we have a saved subject, try to load it
                if (appState.currentCategory && appState.currentSubject) {
                    document.getElementById('categorySelect').value = appState.currentCategory;
                    await populateSubjectDropdown(appState.currentCategory);
                    document.getElementById('subjectSelect').value = appState.currentSubject;
                    await loadSubject(appState.currentSubject);
                }
            } catch (error) {
                console.error('Initialisation error:', error);
                showError('Failed to load application. Please refresh the page.');
            }
        }

        async function loadManifest() {
            const response = await fetch(CONFIG.manifestPath);
            if (!response.ok) throw new Error('Failed to load manifest');
            manifest = await response.json();
        }

        async function loadSubjectData(subjectId) {
            const subject = findSubjectInManifest(subjectId);
            if (!subject || !subject.available) {
                throw new Error('Subject not available');
            }

            const response = await fetch(CONFIG.dataBasePath + subject.dataFile);
            if (!response.ok) throw new Error('Failed to load subject data');
            return await response.json();
        }

        function findSubjectInManifest(subjectId) {
            for (const category of manifest.categories) {
                for (const subject of category.subjects) {
                    if (subject.id === subjectId) {
                        return subject;
                    }
                }
            }
            return null;
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function showError(message) {
            document.getElementById('loadingOverlay').innerHTML = `
                <div class="error-message">
                    <h2>Error</h2>
                    <p>${message}</p>
                </div>
            `;
        }

        // ========================================
        // Theme Management
        // ========================================

        function applyTheme(theme) {
            const root = document.documentElement;
            root.style.setProperty('--primary', theme.primary || '#1a1a2e');
            root.style.setProperty('--secondary', theme.secondary || '#16213e');
            root.style.setProperty('--tertiary', theme.tertiary || '#0f3460');
            root.style.setProperty('--accent', theme.accent || '#e94560');
            root.style.setProperty('--accent-dark', theme.accentDark || '#c73e54');
            root.style.setProperty('--success', theme.success || '#4caf50');
            root.style.setProperty('--warning', theme.warning || '#ff9800');
            root.style.setProperty('--error', theme.error || '#f44336');
            root.style.setProperty('--neutral', theme.neutral || '#607d8b');
            root.style.setProperty('--text', theme.text || '#ffffff');
            root.style.setProperty('--text-muted', theme.textMuted || '#b0b0b0');
        }

        function resetTheme() {
            applyTheme({});
        }

        // ========================================
        // Question Randomisation
        // ========================================

        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        function generateRandomisedQuestions() {
            if (!subjectData) return;

            randomisedQuestions = {};

            subjectData.categories.forEach((category, catIndex) => {
                // Collect all questions from all concepts in this category
                const allQuestions = [];
                category.concepts.forEach((concept) => {
                    concept.questions.forEach((question, qIndex) => {
                        allQuestions.push({
                            conceptId: concept.id,
                            conceptTitle: concept.title,
                            questionIndex: qIndex,
                            question: question
                        });
                    });
                });

                // Shuffle all questions within this category
                randomisedQuestions[catIndex] = shuffleArray(allQuestions);
            });
        }

        function getCategoryQuestions() {
            if (!subjectData || appState.currentQuestionCategory === null) return [];
            return randomisedQuestions[appState.currentQuestionCategory] || [];
        }

        function getTotalQuestionCount() {
            if (!subjectData) return 0;
            let total = 0;
            subjectData.categories.forEach(cat => {
                cat.concepts.forEach(concept => {
                    total += concept.questions.length;
                });
            });
            return total;
        }

        // ========================================
        // Dropdown Population
        // ========================================

        function populateCategoryDropdown() {
            const select = document.getElementById('categorySelect');
            select.innerHTML = '<option value="">-- Select Study Area --</option>';

            manifest.categories.forEach(category => {
                const hasAvailable = category.subjects.some(s => s.available);
                const option = document.createElement('option');
                option.value = category.name;
                option.textContent = category.name + (hasAvailable ? '' : ' (Coming Soon)');
                if (!hasAvailable) {
                    option.disabled = true;
                }
                select.appendChild(option);
            });

            select.disabled = false;
        }

        async function populateSubjectDropdown(categoryName) {
            const select = document.getElementById('subjectSelect');
            select.innerHTML = '<option value="">-- Select Subject --</option>';

            const category = manifest.categories.find(c => c.name === categoryName);
            if (!category) {
                select.disabled = true;
                return;
            }

            category.subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.id;
                option.textContent = subject.name + (subject.available ? '' : ' (Coming Soon)');
                if (!subject.available) {
                    option.disabled = true;
                    option.style.color = '#666';
                }
                select.appendChild(option);
            });

            select.disabled = false;
        }

        function populateQuestionCategoryDropdown() {
            const select = document.getElementById('questionCategorySelect');
            select.innerHTML = '';

            if (!subjectData) return;

            subjectData.categories.forEach((category, index) => {
                const option = document.createElement('option');
                option.value = index;
                option.textContent = category.name;
                select.appendChild(option);
            });

            select.value = appState.currentQuestionCategory || 0;
        }

        // ========================================
        // Subject Loading
        // ========================================

        async function loadSubject(subjectId) {
            try {
                document.getElementById('loadingOverlay').classList.remove('hidden');
                document.querySelector('.loading-text').textContent = 'Loading subject...';

                subjectData = await loadSubjectData(subjectId);
                appState.currentSubject = subjectId;

                // Apply theme from subject data
                if (subjectData.theme) {
                    applyTheme(subjectData.theme);
                }

                // Update page title
                document.title = `VCE ${subjectData.subject} - Examiner's Advice`;
                document.querySelector('h1').textContent = `VCE ${subjectData.subject} Examiner's Advice`;

                // Generate randomised question order
                generateRandomisedQuestions();

                // Show content
                document.getElementById('noSubjectMessage').style.display = 'none';
                document.getElementById('questionsContent').style.display = 'block';
                document.getElementById('noSubjectFeedback').style.display = 'none';
                document.getElementById('feedbackContent').style.display = 'block';

                // Populate and render
                populateQuestionCategoryDropdown();
                renderCurrentQuestion();
                updateProgress();
                renderCategorySummary();
                updateFeedbackTab();
                updateUtilityStats();

                saveState();
                hideLoading();

            } catch (error) {
                console.error('Error loading subject:', error);
                hideLoading();
                showModal('Error', 'Failed to load subject data. Please try again.');
            }
        }

        // ========================================
        // State Management
        // ========================================

        function loadState() {
            const saved = localStorage.getItem('vceExaminerAdviceState');
            if (saved) {
                try {
                    const parsed = JSON.parse(saved);
                    appState = { ...appState, ...parsed };
                    document.getElementById('studentName').value = appState.studentName || '';
                } catch (e) {
                    console.error('Error loading state:', e);
                }
            }
        }

        function saveState() {
            appState.lastSaved = new Date().toISOString();
            localStorage.setItem('vceExaminerAdviceState', JSON.stringify(appState));
        }

        function getResponseKey(conceptId, questionIndex) {
            return `${appState.currentSubject}-${conceptId}-${questionIndex}`;
        }

        // ========================================
        // Event Listeners
        // ========================================

        function setupEventListeners() {
            // Tab switching
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', () => switchTab(tab.dataset.tab));
            });

            // Category selection
            document.getElementById('categorySelect').addEventListener('change', async (e) => {
                const categoryName = e.target.value;
                appState.currentCategory = categoryName;

                if (categoryName) {
                    await populateSubjectDropdown(categoryName);
                } else {
                    document.getElementById('subjectSelect').innerHTML = '<option value="">Select a study area first</option>';
                    document.getElementById('subjectSelect').disabled = true;
                }

                saveState();
            });

            // Subject selection
            document.getElementById('subjectSelect').addEventListener('change', async (e) => {
                const subjectId = e.target.value;
                if (subjectId) {
                    await loadSubject(subjectId);
                }
            });

            // Question category selection
            document.getElementById('questionCategorySelect').addEventListener('change', (e) => {
                appState.currentQuestionCategory = parseInt(e.target.value);
                appState.currentQuestionIndex = 0;
                renderCurrentQuestion();
                updateProgress();
                saveState();
            });

            // Student name
            document.getElementById('studentName').addEventListener('change', (e) => {
                appState.studentName = e.target.value;
                saveState();
            });

            // Navigation
            document.getElementById('prevBtn').addEventListener('click', () => navigateQuestion(-1));
            document.getElementById('nextBtn').addEventListener('click', () => navigateQuestion(1));
            document.getElementById('skipBtn').addEventListener('click', () => navigateQuestion(1));

            // Keyboard shortcuts
            document.addEventListener('keydown', (e) => {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;
                if (!subjectData) return;

                switch (e.key.toLowerCase()) {
                    case 't':
                        answerQuestion(true);
                        break;
                    case 'f':
                        answerQuestion(false);
                        break;
                    case 'arrowleft':
                        navigateQuestion(-1);
                        break;
                    case 'arrowright':
                        navigateQuestion(1);
                        break;
                }
            });

            // Filter buttons
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                    appState.filter = btn.dataset.filter;
                    updateFeedbackTab();
                });
            });

            // Utility buttons
            document.getElementById('saveBtn').addEventListener('click', () => {
                saveState();
                showModal('Progress Saved', 'Your progress has been saved successfully.');
            });

            document.getElementById('exportBtn').addEventListener('click', exportResults);
            document.getElementById('emailBtn').addEventListener('click', emailResults);
            document.getElementById('resetBtn').addEventListener('click', () => {
                showModal('Reset All Progress', 'This will delete all your responses for the current subject. Are you sure?', true, resetProgress);
            });

            // Modal
            document.getElementById('modalCancel').addEventListener('click', hideModal);
        }

        // ========================================
        // Tab Switching
        // ========================================

        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(tc => tc.classList.remove('active'));

            document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
            document.getElementById(`${tabName}-tab`).classList.add('active');

            if (tabName === 'feedback') {
                updateFeedbackTab();
            } else if (tabName === 'utility') {
                updateUtilityStats();
            }
        }

        // ========================================
        // Question Rendering
        // ========================================

        function renderCurrentQuestion() {
            const questions = getCategoryQuestions();
            if (questions.length === 0) {
                document.getElementById('questionContainer').innerHTML = '<p class="no-subject">No questions available in this category.</p>';
                return;
            }

            const currentQ = questions[appState.currentQuestionIndex];
            if (!currentQ) {
                appState.currentQuestionIndex = 0;
                return renderCurrentQuestion();
            }

            const responseKey = getResponseKey(currentQ.conceptId, currentQ.questionIndex);
            const response = appState.responses[responseKey];

            const html = `
                <div class="question-card active">
                    <div class="question-header">
                        <span>Question ${appState.currentQuestionIndex + 1}/${questions.length}</span>
                        <span class="status-indicator ${response ? (response.correct ? 'status-correct' : 'status-incorrect') : 'status-unanswered'}">
                            ${response ? (response.correct ? 'Correct' : 'Incorrect') : 'Unanswered'}
                        </span>
                    </div>
                    <div class="question-concept">${currentQ.conceptTitle}</div>
                    <div class="question-text">${currentQ.question.text}</div>
                    <div class="answer-buttons">
                        <button class="answer-btn ${response && response.answer === true ? (response.correct ? 'correct' : 'incorrect') : ''}"
                                onclick="answerQuestion(true)" ${response ? 'disabled' : ''}>
                            TRUE
                        </button>
                        <button class="answer-btn ${response && response.answer === false ? (response.correct ? 'correct' : 'incorrect') : ''}"
                                onclick="answerQuestion(false)" ${response ? 'disabled' : ''}>
                            FALSE
                        </button>
                    </div>
                    ${response ? `
                        <div class="feedback show ${response.correct ? 'correct' : 'incorrect'}">
                            <div class="feedback-header">${response.correct ? '‚úì Correct' : '‚úó Incorrect'}</div>
                            <div>${currentQ.question.explanation}</div>
                            ${currentQ.question.studyTip ? `<div class="study-tip">üí° Study Tip: ${currentQ.question.studyTip}</div>` : ''}
                        </div>
                    ` : ''}
                </div>
            `;

            document.getElementById('questionContainer').innerHTML = html;
        }

        function answerQuestion(answer) {
            const questions = getCategoryQuestions();
            if (questions.length === 0) return;

            const currentQ = questions[appState.currentQuestionIndex];
            const responseKey = getResponseKey(currentQ.conceptId, currentQ.questionIndex);

            if (appState.responses[responseKey]) return; // Already answered

            const correct = answer === currentQ.question.answer;

            appState.responses[responseKey] = {
                answer: answer,
                correct: correct,
                timestamp: new Date().toISOString()
            };

            saveState();
            renderCurrentQuestion();
            updateProgress();
            renderCategorySummary();
            updateFeedbackTab();
            updateUtilityStats();
        }

        function navigateQuestion(direction) {
            const questions = getCategoryQuestions();
            appState.currentQuestionIndex += direction;

            if (appState.currentQuestionIndex < 0) {
                appState.currentQuestionIndex = 0;
            } else if (appState.currentQuestionIndex >= questions.length) {
                appState.currentQuestionIndex = questions.length - 1;
            }

            renderCurrentQuestion();
            updateProgress();
            saveState();
        }

        // ========================================
        // Progress Updates
        // ========================================

        function updateProgress() {
            const questions = getCategoryQuestions();
            let answered = 0;

            questions.forEach((q) => {
                const key = getResponseKey(q.conceptId, q.questionIndex);
                if (appState.responses[key]) answered++;
            });

            const percentage = questions.length > 0 ? Math.round((answered / questions.length) * 100) : 0;

            document.getElementById('progressFill').style.width = percentage + '%';
            document.getElementById('progressText').textContent = `${answered}/${questions.length} (${percentage}%)`;
        }

        function renderCategorySummary() {
            if (!subjectData) return;

            const html = subjectData.categories.map((category, index) => {
                const totalQuestions = category.concepts.reduce((sum, c) => sum + c.questions.length, 0);
                let answered = 0;

                category.concepts.forEach((concept) => {
                    concept.questions.forEach((q, qIndex) => {
                        const key = getResponseKey(concept.id, qIndex);
                        if (appState.responses[key]) answered++;
                    });
                });

                const percentage = totalQuestions > 0 ? Math.round((answered / totalQuestions) * 100) : 0;

                return `
                    <div class="category-card">
                        <h3>${category.name}</h3>
                        <div class="stats">
                            ${answered}/${totalQuestions} answered (${percentage}%)
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('categorySummary').innerHTML = html;
        }

        // ========================================
        // Feedback Tab
        // ========================================

        function updateFeedbackTab() {
            if (!subjectData) return;

            const conceptMastery = {};

            // Calculate mastery for each concept
            subjectData.categories.forEach((category) => {
                category.concepts.forEach((concept) => {
                    const key = concept.id;
                    conceptMastery[key] = {
                        concept: concept,
                        categoryName: category.name,
                        responses: []
                    };

                    concept.questions.forEach((q, qIndex) => {
                        const responseKey = getResponseKey(concept.id, qIndex);
                        const response = appState.responses[responseKey];
                        conceptMastery[key].responses.push(response);
                    });
                });
            });

            // Count mastery levels
            let mastered = 0, partial = 0, needsWork = 0, notAttempted = 0;

            Object.values(conceptMastery).forEach(cm => {
                const answered = cm.responses.filter(r => r !== undefined);
                const correct = answered.filter(r => r && r.correct);

                if (answered.length === 0) {
                    notAttempted++;
                } else if (answered.length === cm.responses.length && correct.length === cm.responses.length) {
                    mastered++;
                } else if (correct.length > 0) {
                    partial++;
                } else {
                    needsWork++;
                }
            });

            document.getElementById('masteredCount').textContent = mastered;
            document.getElementById('partialCount').textContent = partial;
            document.getElementById('needsWorkCount').textContent = needsWork;
            document.getElementById('notAttemptedCount').textContent = notAttempted;

            // Overall progress
            const totalQuestions = getTotalQuestionCount();
            const totalAnswered = Object.keys(appState.responses).filter(k => k.startsWith(appState.currentSubject)).length;
            const overallPercentage = totalQuestions > 0 ? Math.round((totalAnswered / totalQuestions) * 100) : 0;

            document.getElementById('overallProgressFill').style.width = overallPercentage + '%';
            document.getElementById('overallProgressText').textContent = `${totalAnswered}/${totalQuestions} (${overallPercentage}%)`;

            // Render concept list
            renderConceptList(conceptMastery);
        }

        function renderConceptList(conceptMastery) {
            const filtered = Object.entries(conceptMastery).filter(([key, cm]) => {
                const answered = cm.responses.filter(r => r !== undefined);
                const correct = answered.filter(r => r && r.correct);

                if (appState.filter === 'all') return true;
                if (appState.filter === 'mastered') return answered.length === cm.responses.length && correct.length === cm.responses.length;
                if (appState.filter === 'partial') return answered.length > 0 && correct.length > 0 && correct.length < cm.responses.length;
                if (appState.filter === 'needs-work') return answered.length > 0 && correct.length === 0;
                if (appState.filter === 'not-attempted') return answered.length === 0;
                return false;
            });

            const html = filtered.map(([key, cm]) => {
                const answered = cm.responses.filter(r => r !== undefined);
                const correct = answered.filter(r => r && r.correct);
                const total = cm.responses.length;

                let status = 'not-attempted';
                let statusText = 'Not Attempted';

                if (answered.length === total && correct.length === total) {
                    status = 'mastered';
                    statusText = `Mastered (${correct.length}/${total})`;
                } else if (correct.length > 0) {
                    status = 'partial';
                    statusText = `Partial (${correct.length}/${total})`;
                } else if (answered.length > 0) {
                    status = 'needs-work';
                    statusText = `Needs Work (0/${total})`;
                }

                return `
                    <div class="concept-item ${status}">
                        <div class="concept-header">
                            <span class="concept-title">${cm.concept.title}</span>
                            <span>${statusText}</span>
                        </div>
                        <div class="concept-details">
                            Category: ${cm.categoryName}<br>
                            ${cm.responses.map((r, i) =>
                                r ? `Q${i + 1}: ${r.correct ? '‚úì Correct' : '‚úó Incorrect'}` : `Q${i + 1}: Not attempted`
                            ).join(' | ')}
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('conceptList').innerHTML = html || '<p style="text-align: center; color: var(--neutral); padding: 2rem;">No concepts match this filter.</p>';
        }

        // ========================================
        // Utility Functions
        // ========================================

        function updateUtilityStats() {
            if (!subjectData) {
                document.getElementById('statAnswered').textContent = '0/0';
                document.getElementById('statAccuracy').textContent = '0%';
                document.getElementById('statSubject').textContent = '-';
                document.getElementById('statLastSession').textContent = '-';
                return;
            }

            const totalQuestions = getTotalQuestionCount();
            const subjectResponses = Object.entries(appState.responses).filter(([k]) => k.startsWith(appState.currentSubject));
            const totalAnswered = subjectResponses.length;
            const correct = subjectResponses.filter(([k, r]) => r && r.correct).length;
            const accuracy = totalAnswered > 0 ? Math.round((correct / totalAnswered) * 100) : 0;

            document.getElementById('statAnswered').textContent = `${totalAnswered}/${totalQuestions}`;
            document.getElementById('statAccuracy').textContent = `${accuracy}%`;
            document.getElementById('statSubject').textContent = subjectData.subject || '-';
            document.getElementById('statLastSession').textContent = appState.lastSaved ? new Date(appState.lastSaved).toLocaleString() : 'Never';
        }

        function exportResults() {
            if (!subjectData) {
                showModal('No Subject', 'Please select a subject first.');
                return;
            }

            const results = generateResultsText();
            const blob = new Blob([results], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `VCE_${subjectData.subject}_Results_${appState.studentName || 'Student'}.txt`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function emailResults() {
            if (!subjectData) {
                showModal('No Subject', 'Please select a subject first.');
                return;
            }

            const results = generateResultsText();
            const subject = encodeURIComponent(`VCE ${subjectData.subject} Progress - ${appState.studentName || 'Student'}`);
            const body = encodeURIComponent(results);
            window.location.href = `mailto:?subject=${subject}&body=${body}`;
        }

        function generateResultsText() {
            const totalQuestions = getTotalQuestionCount();
            const subjectResponses = Object.entries(appState.responses).filter(([k]) => k.startsWith(appState.currentSubject));
            const totalAnswered = subjectResponses.length;
            const correct = subjectResponses.filter(([k, r]) => r && r.correct).length;
            const accuracy = totalAnswered > 0 ? Math.round((correct / totalAnswered) * 100) : 0;

            let text = `VCE ${subjectData.subject} Examiner's Advice - Progress Report\n`;
            text += `${'='.repeat(50)}\n\n`;
            text += `Student: ${appState.studentName || 'Not provided'}\n`;
            text += `Date: ${new Date().toLocaleString()}\n\n`;
            text += `Overall Progress: ${totalAnswered}/${totalQuestions} (${Math.round((totalAnswered / totalQuestions) * 100)}%)\n`;
            text += `Accuracy: ${accuracy}%\n\n`;

            text += `Category Breakdown:\n`;
            text += `${'-'.repeat(30)}\n`;

            subjectData.categories.forEach((category) => {
                const categoryQuestions = category.concepts.reduce((sum, c) => sum + c.questions.length, 0);
                let categoryAnswered = 0;

                category.concepts.forEach((concept) => {
                    concept.questions.forEach((q, qIndex) => {
                        const key = getResponseKey(concept.id, qIndex);
                        if (appState.responses[key]) categoryAnswered++;
                    });
                });

                text += `‚Ä¢ ${category.name}: ${categoryAnswered}/${categoryQuestions}\n`;
            });

            return text;
        }

        function resetProgress() {
            if (!appState.currentSubject) return;

            // Remove only responses for current subject
            const newResponses = {};
            Object.entries(appState.responses).forEach(([key, value]) => {
                if (!key.startsWith(appState.currentSubject)) {
                    newResponses[key] = value;
                }
            });

            appState.responses = newResponses;
            appState.currentQuestionIndex = 0;

            // Re-randomise questions
            generateRandomisedQuestions();

            saveState();
            renderCurrentQuestion();
            updateProgress();
            renderCategorySummary();
            updateFeedbackTab();
            updateUtilityStats();
            hideModal();
        }

        // ========================================
        // Modal
        // ========================================

        function showModal(header, body, showConfirm = false, confirmCallback = null) {
            document.getElementById('modalHeader').textContent = header;
            document.getElementById('modalBody').textContent = body;
            document.getElementById('modal').classList.add('show');

            const confirmBtn = document.getElementById('modalConfirm');
            if (showConfirm) {
                confirmBtn.style.display = 'block';
                confirmBtn.onclick = () => {
                    if (confirmCallback) confirmCallback();
                    hideModal();
                };
            } else {
                confirmBtn.style.display = 'none';
            }
        }

        function hideModal() {
            document.getElementById('modal').classList.remove('show');
        }

        // ========================================
        // Global Functions for onclick handlers
        // ========================================

        window.answerQuestion = answerQuestion;

        // ========================================
        // Start Application
        // ========================================

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', init);
        } else {
            init();
        }
    </script>
</body>
</html>