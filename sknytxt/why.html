<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Why Why Why</title>
    <style>
        :root {
            /* Default (neutral) theme */
            --primary-color: #007bff;
            --secondary-color: #0056b3;
            --accent-color: #0069d9;
            --background-color: #f5f5f5;
            --light-background: #e9ecef;
            --text-on-primary: #ffffff;
            --dark-text: #333;
            --border-color: #dee2e6;
        }
        
        /* Physics theme - Cyan */
        :root[data-theme="physics"] {
            --primary-color: #00BCD4;
            --secondary-color: #0097A7;
            --accent-color: #00ACC1;
            --background-color: #E0F7FA;
            --light-background: #B2EBF2;
            --text-on-primary: #004D40;
            --dark-text: #00695C;
            --border-color: #4DD0E1;
        }
        
        /* Chemistry theme - Purple */
        :root[data-theme="chemistry"] {
            --primary-color: #9C27B0;
            --secondary-color: #7B1FA2;
            --accent-color: #8E24AA;
            --background-color: #F3E5F5;
            --light-background: #E1BEE7;
            --text-on-primary: #ffffff;
            --dark-text: #4A148C;
            --border-color: #BA68C8;
        }
        
        /* Biology theme - Lime Green */
        :root[data-theme="biology"] {
            --primary-color: #8BC34A;
            --secondary-color: #689F38;
            --accent-color: #7CB342;
            --background-color: #F1F8E9;
            --light-background: #DCEDC8;
            --text-on-primary: #ffffff;
            --dark-text: #33691E;
            --border-color: #AED581;
        }
        
        /* Psychology theme - Orange */
        :root[data-theme="psychology"] {
            --primary-color: #FF9800;
            --secondary-color: #F57C00;
            --accent-color: #FB8C00;
            --background-color: #FFF3E0;
            --light-background: #FFE0B2;
            --text-on-primary: #ffffff;
            --dark-text: #E65100;
            --border-color: #FFCC80;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
            background-color: var(--background-color);
            color: #333;
            transition: background-color 0.3s ease;
        }
        
        h1 {
            color: var(--dark-text);
            margin-bottom: 10px;
            transition: color 0.3s ease;
        }
        
        h2 {
            color: var(--secondary-color);
            font-size: 18px;
            margin-bottom: 20px;
            transition: color 0.3s ease;
        }
        
        .course-selector {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            border: 2px solid var(--border-color);
            transition: border-color 0.3s ease;
        }
        
        .course-selector select {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 16px;
            margin-bottom: 10px;
            transition: border-color 0.3s ease;
        }
        
        .course-selector select:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .load-btn {
            padding: 10px 20px;
            background: var(--primary-color);
            color: var(--text-on-primary);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            transition: background-color 0.3s ease;
        }
        
        .load-btn:hover {
            background: var(--secondary-color);
        }
        
        .load-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
            display: none;
        }
        
        .loading {
            text-align: center;
            padding: 40px;
            display: none;
        }
        
        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 4px solid var(--light-background);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .student-info {
            background: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
            display: none;
            border: 2px solid var(--border-color);
            transition: border-color 0.3s ease;
        }
        
        .student-info-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .student-info input {
            padding: 5px 10px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-size: 14px;
        }
        
        .score-display {
            font-size: 14px;
            color: var(--dark-text);
        }
        
        .score-display span {
            font-weight: 600;
            margin-left: 15px;
            color: var(--primary-color);
        }
        
        .course-content {
            display: none;
        }
        
        .topic {
            background: white;
            margin-bottom: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            overflow: hidden;
            border: 2px solid var(--border-color);
            transition: all 0.3s ease;
        }
        
        .topic:hover {
            box-shadow: 0 4px 8px rgba(0,0,0,0.15);
            transform: translateY(-2px);
        }
        
        .topic-header {
            padding: 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: var(--light-background);
            transition: background-color 0.3s ease;
        }
        
        .topic-header:hover {
            background: var(--primary-color);
            color: var(--text-on-primary);
        }
        
        .topic-title {
            font-weight: 600;
            font-size: 16px;
        }
        
        .topic-stats {
            font-size: 13px;
            opacity: 0.8;
        }
        
        .topic-arrow {
            transition: transform 0.3s;
            font-size: 14px;
        }
        
        .topic-header.active .topic-arrow {
            transform: rotate(180deg);
        }
        
        .topic-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        .topic-content.active {
            max-height: none;
        }
        
        .topic-loading {
            padding: 40px;
            text-align: center;
            color: var(--primary-color);
        }
        
        .concept {
            background: white;
            margin: 10px;
            border-radius: 8px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
            border: 1px solid var(--border-color);
        }
        
        .concept-header {
            padding: 15px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            color: var(--dark-text);
            transition: background-color 0.2s;
        }
        
        .concept-header:hover {
            background-color: var(--light-background);
        }
        
        .arrow {
            transition: transform 0.3s;
            font-size: 12px;
            color: var(--primary-color);
        }
        
        .concept-header.active .arrow {
            transform: rotate(180deg);
        }
        
        .concept-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            padding: 0 20px;
        }
        
        .concept-content.active {
            max-height: 5000px;
            padding: 0 20px 20px 20px;
        }
        
        .explanation {
            margin: 10px 0;
        }
        
        .explanation h4 {
            color: var(--secondary-color);
            margin: 10px 0 5px 0;
            font-size: 14px;
            font-weight: 600;
        }
        
        .explanation p {
            margin: 0;
            line-height: 1.6;
            color: #555;
            font-size: 14px;
        }
        
        .equation {
            background: var(--light-background);
            padding: 8px 12px;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            margin: 5px 0;
            display: inline-block;
            border: 1px solid var(--border-color);
        }
        
        .why-section {
            margin-left: 20px;
            margin-top: 10px;
        }
        
        .why-header {
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            color: var(--secondary-color);
            font-size: 13px;
            font-weight: 600;
            padding: 5px 0;
            transition: color 0.2s;
        }
        
        .why-header:hover {
            color: var(--primary-color);
        }
        
        .why-arrow {
            font-size: 10px;
            transition: transform 0.3s;
            color: var(--primary-color);
        }
        
        .why-header.active .why-arrow {
            transform: rotate(180deg);
        }
        
        .why-content {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
            margin-left: 20px;
        }
        
        .why-content.active {
            max-height: 500px;
            margin-top: 5px;
            margin-bottom: 10px;
        }
        
        .why-content p {
            font-size: 13px;
            color: #666;
            line-height: 1.5;
            margin: 0;
        }
        
        .so-actually {
            font-weight: 600;
            color: var(--primary-color);
            font-style: italic;
        }
        
        .questions-section {
            background: var(--light-background);
            padding: 15px;
            border-radius: 5px;
            margin-top: 15px;
            border: 1px solid var(--border-color);
        }
        
        .question {
            margin-bottom: 20px;
            padding: 10px;
            background: white;
            border-radius: 5px;
            border: 1px solid var(--border-color);
        }
        
        .question h5 {
            margin: 0 0 10px 0;
            color: var(--secondary-color);
            font-size: 14px;
        }
        
        .mc-options {
            margin: 10px 0;
        }
        
        .mc-option {
            display: block;
            margin: 5px 0;
            padding: 8px 12px;
            background: #f8f9fa;
            border: 2px solid transparent;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .mc-option:hover {
            background: var(--light-background);
            border-color: var(--primary-color);
        }
        
        .mc-option.selected {
            border-color: var(--primary-color);
            background: var(--light-background);
        }
        
        .mc-option.correct {
            border-color: #28a745;
            background: #d4edda;
        }
        
        .mc-option.incorrect {
            border-color: #dc3545;
            background: #f8d7da;
        }
        
        .option-explanation {
            margin-top: 8px;
            padding: 8px;
            background: #f0f0f0;
            border-left: 3px solid #6c757d;
            font-size: 13px;
            color: #495057;
            line-height: 1.4;
        }
        
        .mc-option.correct .option-explanation {
            border-left-color: #28a745;
            background: #e8f5e9;
        }
        
        .mc-option.incorrect .option-explanation {
            border-left-color: #dc3545;
            background: #ffebee;
        }
        
        .submit-btn {
            padding: 6px 15px;
            background: var(--primary-color);
            color: var(--text-on-primary);
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            margin-top: 10px;
            transition: background-color 0.3s ease;
        }
        
        .submit-btn:hover {
            background: var(--secondary-color);
        }
        
        .submit-btn:disabled {
            background: #6c757d;
            cursor: not-allowed;
        }
        
        .feedback {
            margin-top: 10px;
            padding: 10px;
            border-radius: 5px;
            font-size: 13px;
        }
        
        .feedback.correct {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .feedback.incorrect {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .sa-input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            margin: 10px 0;
        }
        
        .sa-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .solution {
            background: var(--light-background);
            padding: 10px;
            border-radius: 5px;
            margin-top: 10px;
            font-size: 13px;
            border: 1px solid var(--border-color);
        }
        
        .solution pre {
            margin: 5px 0;
            font-family: 'Courier New', monospace;
            white-space: pre-wrap;
        }
        
        .binary-options {
            display: flex;
            gap: 10px;
            margin: 10px 0;
        }
        
        .binary-btn {
            padding: 8px 20px;
            border: 2px solid var(--primary-color);
            background: white;
            color: var(--primary-color);
            border-radius: 5px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.2s ease;
        }
        
        .binary-btn:hover {
            background: var(--primary-color);
            color: var(--text-on-primary);
        }
        
        .binary-btn.selected {
            background: var(--primary-color);
            color: var(--text-on-primary);
        }
        
        .explain-input {
            width: 100%;
            padding: 8px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            margin: 10px 0;
            min-height: 60px;
            font-family: inherit;
        }
        
        .explain-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }
        
        .self-mark {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .mark-btn {
            padding: 6px 15px;
            border: 1px solid #28a745;
            background: white;
            color: #28a745;
            border-radius: 4px;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s ease;
        }
        
        .mark-btn:hover {
            background: #28a745;
            color: white;
        }
        
        .mark-btn.incorrect {
            border-color: #dc3545;
            color: #dc3545;
        }
        
        .mark-btn.incorrect:hover {
            background: #dc3545;
            color: white;
        }
        
        .diagram {
            margin: 10px 0;
            text-align: center;
        }
        
        .diagram img {
            max-width: 100%;
            height: auto;
            border-radius: 5px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .diagram-caption {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }
    </style>
</head>
<body>
    <h1>Why Why Why</h1>
    
    <div class="error-message" id="error-message"></div>
    
    <div class="course-selector">
        <h3>Select Course</h3>
        <select id="subject-select">
            <option value="">-- Select Subject --</option>
            <option value="physics">Physics</option>
            <option value="chemistry">Chemistry</option>
            <option value="biology">Biology</option>
            <option value="psychology">Psychology</option>
        </select>
        <select id="unit-select" disabled>
            <option value="">-- Select Unit --</option>
            <option value="u1">Unit 1</option>
            <option value="u2">Unit 2</option>
            <option value="u3">Unit 3</option>
            <option value="u4">Unit 4</option>
        </select>
        <select id="aos-select" disabled>
            <option value="">-- Select AOS --</option>
        </select>
        <button class="load-btn" id="load-course" disabled>Load Course</button>
    </div>
    
    <div class="loading" id="loading">
        <div class="loading-spinner"></div>
        <p>Loading course content...</p>
    </div>
    
    <div class="student-info" id="student-info">
        <div class="student-info-header">
            <div>
                <label for="student-name">Name: </label>
                <input type="text" id="student-name" placeholder="Enter your name" onchange="saveStudentName()">
            </div>
            <div class="score-display">
                <span>First Try: <span id="first-try-score">0/0</span></span>
                <span>Corrected: <span id="corrected-score">0/0</span></span>
            </div>
        </div>
    </div>
    
    <div class="course-content" id="course-content">
        <h2 id="course-title"></h2>
        <div id="topics-container"></div>
    </div>

    <script>
        // Global variables
        let manifest = null;
        let currentCourse = null;
        let currentCourseOverview = null;
        let loadedTopics = {};
        let studentData = {
            name: '',
            lastCourseSelection: {
                subject: '',
                unit: '',
                aos: ''
            },
            courses: {}
        };
        
        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            loadManifest();
            loadSavedData();
            setupEventListeners();
            restoreLastSelection();
        });
        
        // Load manifest
        async function loadManifest() {
            try {
                const response = await fetch('data/manifest.json');
                if (!response.ok) throw new Error('Failed to load manifest');
                manifest = await response.json();
            } catch (error) {
                showError('Failed to load course list. Please refresh the page.');
                console.error('Manifest load error:', error);
            }
        }
        
        // Setup event listeners
        function setupEventListeners() {
            document.getElementById('subject-select').addEventListener('change', handleSubjectChange);
            document.getElementById('unit-select').addEventListener('change', handleUnitChange);
            document.getElementById('aos-select').addEventListener('change', handleAosChange);
            document.getElementById('load-course').addEventListener('click', loadSelectedCourse);
        }
        
        // Handle subject selection
        function handleSubjectChange() {
            const subject = document.getElementById('subject-select').value;
            const unitSelect = document.getElementById('unit-select');
            const aosSelect = document.getElementById('aos-select');
            const loadBtn = document.getElementById('load-course');
            
            // Clear any loaded content when subject changes
            document.getElementById('course-content').style.display = 'none';
            document.getElementById('student-info').style.display = 'none';
            loadedTopics = {};
            window.mcOptionMappings = {};
            
            if (subject) {
                unitSelect.disabled = false;
                studentData.lastCourseSelection.subject = subject;
                saveData();
                setTheme(subject);
            } else {
                unitSelect.disabled = true;
                aosSelect.disabled = true;
                loadBtn.disabled = true;
                setTheme('');
            }
            
            unitSelect.value = '';
            aosSelect.innerHTML = '<option value="">-- Select AOS --</option>';
            aosSelect.disabled = true;
            loadBtn.disabled = true;
        }
        
        // Set color theme based on subject
        function setTheme(subject) {
            if (subject) {
                document.documentElement.setAttribute('data-theme', subject);
            } else {
                document.documentElement.removeAttribute('data-theme');
            }
        }
        
        // Handle unit selection
        function handleUnitChange() {
            const subject = document.getElementById('subject-select').value;
            const unit = document.getElementById('unit-select').value;
            const aosSelect = document.getElementById('aos-select');
            const loadBtn = document.getElementById('load-course');
            
            // Clear any loaded content when unit changes
            document.getElementById('course-content').style.display = 'none';
            document.getElementById('student-info').style.display = 'none';
            loadedTopics = {};
            window.mcOptionMappings = {};
            
            if (unit && manifest) {
                studentData.lastCourseSelection.unit = unit;
                saveData();
                
                // Filter courses for this subject and unit
                const relevantCourses = manifest.courses.filter(course => 
                    course.id.includes(subject) && course.id.includes(unit)
                );
                
                // Populate AOS dropdown
                aosSelect.innerHTML = '<option value="">-- Select AOS --</option>';
                relevantCourses.forEach(course => {
                    const aosMatch = course.id.match(/aos(\d)/);
                    if (aosMatch) {
                        const option = document.createElement('option');
                        option.value = course.id;
                        option.textContent = `AOS ${aosMatch[1]}: ${course.title.split(':')[1] || course.title}`;
                        aosSelect.appendChild(option);
                    }
                });
                
                aosSelect.disabled = false;
            } else {
                aosSelect.disabled = true;
                loadBtn.disabled = true;
            }
        }
        
        // Handle AOS selection
        function handleAosChange() {
            const aos = document.getElementById('aos-select').value;
            document.getElementById('load-course').disabled = !aos;
            if (aos) {
                studentData.lastCourseSelection.aos = aos;
                saveData();
            }
        }
        
        // Load selected course (overview only)
        async function loadSelectedCourse() {
            const courseId = document.getElementById('aos-select').value;
            const course = manifest.courses.find(c => c.id === courseId);
            
            if (!course) return;
            
            showLoading(true);
            hideError();
            
            try {
                const response = await fetch(`data/${course.dataFile}`);
                if (!response.ok) throw new Error('Failed to load course overview');
                
                currentCourseOverview = await response.json();
                currentCourse = courseId;
                loadedTopics = {}; // Clear loaded topics
                window.mcOptionMappings = {}; // Clear MC mappings
                
                // Initialize course progress if not exists
                if (!studentData.courses[courseId]) {
                    studentData.courses[courseId] = {
                        firstTryCorrect: 0,
                        firstTryTotal: 0,
                        correctedCorrect: 0,
                        correctedTotal: 0,
                        concepts: {}
                    };
                }
                
                displayCourseOverview();
                document.getElementById('student-info').style.display = 'block';
                updateScoreDisplay();
                
            } catch (error) {
                showError(`Failed to load course overview for ${course.title}. Please try another course.`);
                console.error('Course load error:', error);
            } finally {
                showLoading(false);
            }
        }
        
        // Display course overview with topics
        function displayCourseOverview() {
            document.getElementById('course-title').textContent = currentCourseOverview.title;
            const container = document.getElementById('topics-container');
            container.innerHTML = '';
            
            currentCourseOverview.topics.forEach(topic => {
                const topicDiv = createTopicElement(topic);
                container.appendChild(topicDiv);
            });
            
            document.getElementById('course-content').style.display = 'block';
        }
        
        // Create topic element (collapsed by default)
        function createTopicElement(topic) {
            const div = document.createElement('div');
            div.className = 'topic';
            div.id = `topic-${topic.id}`;
            
            const header = document.createElement('div');
            header.className = 'topic-header';
            header.onclick = () => toggleTopic(topic);
            
            const titleDiv = document.createElement('div');
            
            const titleSpan = document.createElement('div');
            titleSpan.className = 'topic-title';
            titleSpan.textContent = topic.title;
            
            titleDiv.appendChild(titleSpan);
            
            const arrow = document.createElement('span');
            arrow.className = 'topic-arrow';
            arrow.textContent = '▼';
            
            header.appendChild(titleDiv);
            header.appendChild(arrow);
            div.appendChild(header);
            
            const content = document.createElement('div');
            content.className = 'topic-content';
            content.id = `topic-content-${topic.id}`;
            div.appendChild(content);
            
            return div;
        }
        
        // Toggle topic and load if needed
        async function toggleTopic(topic) {
            const header = document.querySelector(`#topic-${topic.id} .topic-header`);
            const content = document.getElementById(`topic-content-${topic.id}`);
            
            const isExpanding = !header.classList.contains('active');
            
            header.classList.toggle('active');
            content.classList.toggle('active');
            
            if (isExpanding && !loadedTopics[topic.id]) {
                // Load topic data
                content.innerHTML = '<div class="topic-loading">Loading topic content...</div>';
                
                try {
                    // Debug: Log current state
                    console.log('Current course overview:', currentCourseOverview);
                    console.log('Topic to load:', topic);
                    
                    // Construct the correct path based on course structure
                    const basePath = currentCourseOverview.metadata.subject.toLowerCase();
                    const topicPath = `data/${basePath}/${topic.dataFile}`;
                    console.log('Loading topic from:', topicPath); // Debug log
                    
                    const response = await fetch(topicPath);
                    
                    console.log('Response status:', response.status);
                    console.log('Response ok:', response.ok);
                    
                    if (!response.ok) {
                        throw new Error(`Failed to load topic data: ${response.status} ${response.statusText}`);
                    }
                    
                    const topicData = await response.json();
                    console.log('Topic data loaded:', topicData);
                    loadedTopics[topic.id] = topicData;
                    
                    displayTopicContent(topic.id, topicData);
                    
                } catch (error) {
                    content.innerHTML = `<div class="error-message">Failed to load topic content: ${error.message}</div>`;
                    console.error('Topic load error:', error);
                    console.error('Attempted path:', `data/${basePath}/${topic.dataFile}`);
                    console.error('Full error details:', error.stack);
                }
            }
        }
        
        // Display topic content
        function displayTopicContent(topicId, topicData) {
            const content = document.getElementById(`topic-content-${topicId}`);
            content.innerHTML = '';
            
            // Add topic stats at the top of expanded content
            const statsDiv = document.createElement('div');
            statsDiv.className = 'topic-stats';
            statsDiv.style.padding = '10px 20px';
            statsDiv.style.color = 'var(--dark-text)';
            statsDiv.style.fontSize = '14px';
            statsDiv.style.borderBottom = '1px solid var(--border-color)';
            
            const conceptCount = topicData.concepts.length;
            const questionCount = topicData.concepts.reduce((total, concept) => 
                total + (concept.questions ? concept.questions.length : 0), 0);
            
            statsDiv.textContent = `${conceptCount} concept${conceptCount !== 1 ? 's' : ''} • ${questionCount} question${questionCount !== 1 ? 's' : ''}`;
            content.appendChild(statsDiv);
            
            topicData.concepts.forEach(concept => {
                const conceptDiv = createConceptElement(concept);
                content.appendChild(conceptDiv);
            });
        }
        
        // Create concept element
        function createConceptElement(concept) {
            const div = document.createElement('div');
            div.className = 'concept';
            
            const header = document.createElement('div');
            header.className = 'concept-header';
            header.onclick = () => toggleContent(header);
            
            const titleSpan = document.createElement('span');
            titleSpan.textContent = concept.title;
            if (concept.equation) {
                titleSpan.innerHTML += ` <span class="equation">(${concept.equation})</span>`;
            }
            
            const arrow = document.createElement('span');
            arrow.className = 'arrow';
            arrow.textContent = '▼';
            
            header.appendChild(titleSpan);
            header.appendChild(arrow);
            div.appendChild(header);
            
            const content = document.createElement('div');
            content.className = 'concept-content';
            
            // Add explanations
            content.innerHTML = `
                <div class="explanation">
                    <h4>What you need to know:</h4>
                    <p>${concept.content.summary.text}</p>
                    ${concept.content.summary.diagram ? createDiagramHTML(concept.content.summary.diagram) : ''}
                </div>
                <div class="explanation">
                    <h4>Why it matters:</h4>
                    <p>${concept.content.importance.text}</p>
                    ${concept.content.importance.diagram ? createDiagramHTML(concept.content.importance.diagram) : ''}
                </div>
            `;
            
            // Add why sections
            concept.content.explanations.forEach(exp => {
                const whySection = createWhySection(exp);
                content.appendChild(whySection);
            });
            
            // Add questions
            if (concept.questions && concept.questions.length > 0) {
                const questionsSection = createQuestionsSection(concept);
                content.appendChild(questionsSection);
            }
            
            div.appendChild(content);
            return div;
        }
        
        // Create why section
        function createWhySection(explanation) {
            const section = document.createElement('div');
            section.className = 'why-section';
            
            const header = document.createElement('div');
            header.className = 'why-header';
            header.onclick = () => toggleWhy(header);
            
            const arrow = document.createElement('span');
            arrow.className = 'why-arrow';
            arrow.textContent = '▼';
            
            const label = document.createElement('span');
            const labels = {
                'why': 'Why?',
                'reallyWhy': 'But really why?',
                'actuallyWhy': 'But really actually why?',
                'soActually': 'So, actually.'
            };
            label.textContent = labels[explanation.level] || explanation.level;
            if (explanation.level === 'soActually') {
                label.className = 'so-actually';
            }
            
            header.appendChild(arrow);
            header.appendChild(label);
            
            const content = document.createElement('div');
            content.className = 'why-content';
            content.innerHTML = `<p>${explanation.text}</p>`;
            if (explanation.diagram) {
                content.innerHTML += createDiagramHTML(explanation.diagram);
            }
            
            section.appendChild(header);
            section.appendChild(content);
            
            return section;
        }
        
        // Create questions section
        function createQuestionsSection(concept) {
            const section = document.createElement('div');
            section.className = 'questions-section';
            section.innerHTML = '<h4>Practice Questions</h4>';
            
            // Sort questions by order
            const sortedQuestions = [...concept.questions].sort((a, b) => a.order - b.order);
            
            sortedQuestions.forEach(question => {
                const questionDiv = createQuestionElement(question, concept.id);
                section.appendChild(questionDiv);
            });
            
            return section;
        }
        
        // Create question element
        function createQuestionElement(question, conceptId) {
            const div = document.createElement('div');
            div.className = 'question';
            div.id = `${conceptId}-${question.id}`;
            
            const title = document.createElement('h5');
            title.textContent = `${question.type === 'multipleChoice' ? 'Multiple Choice' : 
                               question.type === 'shortAnswer' ? 'Short Answer' : 
                               'Binary Question'} ${question.order}: ${question.text}`;
            div.appendChild(title);
            
            if (question.diagram) {
                div.innerHTML += createDiagramHTML(question.diagram);
            }
            
            if (question.type === 'multipleChoice') {
                div.appendChild(createMCQuestion(question, conceptId));
            } else if (question.type === 'shortAnswer') {
                div.appendChild(createSAQuestion(question, conceptId));
            } else if (question.type === 'binary') {
                div.appendChild(createBinaryQuestion(question, conceptId));
            }
            
            return div;
        }
        
        // Create multiple choice question
        function createMCQuestion(question, conceptId) {
            const container = document.createElement('div');
            
            const optionsDiv = document.createElement('div');
            optionsDiv.className = 'mc-options';
            
            // Create a shuffled array of options with their original IDs
            const shuffledOptions = [...question.options].map(option => ({
                ...option,
                originalId: option.id
            }));
            
            // Fisher-Yates shuffle
            for (let i = shuffledOptions.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffledOptions[i], shuffledOptions[j]] = [shuffledOptions[j], shuffledOptions[i]];
            }
            
            // Store the mapping for this question
            const questionKey = `${conceptId}-${question.id}`;
            window.mcOptionMappings = window.mcOptionMappings || {};
            window.mcOptionMappings[questionKey] = {
                displayToOriginal: {},
                originalToDisplay: {}
            };
            
            // Create options with new display IDs
            shuffledOptions.forEach((option, index) => {
                const displayId = String.fromCharCode(65 + index); // A, B, C, D...
                
                // Store bidirectional mapping
                window.mcOptionMappings[questionKey].displayToOriginal[displayId] = option.originalId;
                window.mcOptionMappings[questionKey].originalToDisplay[option.originalId] = displayId;
                
                const label = document.createElement('label');
                label.className = 'mc-option';
                label.setAttribute('data-original-id', option.originalId);
                label.onclick = () => selectMC(questionKey, displayId);
                
                const optionContent = document.createElement('div');
                optionContent.innerHTML = `
                    <input type="radio" name="${questionKey}" value="${displayId}">
                    ${displayId}) ${option.text}
                `;
                
                // Add explanation div (hidden initially)
                if (option.explanation) {
                    const explanationDiv = document.createElement('div');
                    explanationDiv.className = 'option-explanation';
                    explanationDiv.style.display = 'none';
                    explanationDiv.innerHTML = `<em>${option.explanation}</em>`;
                    optionContent.appendChild(explanationDiv);
                }
                
                label.appendChild(optionContent);
                optionsDiv.appendChild(label);
            });
            
            container.appendChild(optionsDiv);
            
            const submitBtn = document.createElement('button');
            submitBtn.className = 'submit-btn';
            submitBtn.textContent = 'Submit';
            submitBtn.onclick = () => checkMC(questionKey, question);
            container.appendChild(submitBtn);
            
            const feedback = document.createElement('div');
            feedback.className = 'feedback';
            feedback.id = `${questionKey}-feedback`;
            feedback.style.display = 'none';
            container.appendChild(feedback);
            
            return container;
        }
        
        // Create short answer question
        function createSAQuestion(question, conceptId) {
            const container = document.createElement('div');
            
            const input = document.createElement('input');
            input.type = 'text';
            input.className = 'sa-input';
            input.id = `${conceptId}-${question.id}-input`;
            input.placeholder = 'Enter your answer with units';
            container.appendChild(input);
            
            const markDiv = document.createElement('div');
            markDiv.className = 'self-mark';
            
            const correctBtn = document.createElement('button');
            correctBtn.className = 'mark-btn';
            correctBtn.textContent = 'Mark Correct';
            correctBtn.onclick = () => markCorrect(`${conceptId}-${question.id}`, question);
            
            const incorrectBtn = document.createElement('button');
            incorrectBtn.className = 'mark-btn incorrect';
            incorrectBtn.textContent = 'Mark Incorrect';
            incorrectBtn.onclick = () => markIncorrect(`${conceptId}-${question.id}`, question);
            
            markDiv.appendChild(correctBtn);
            markDiv.appendChild(incorrectBtn);
            container.appendChild(markDiv);
            
            // Solution section
            const solutionSection = createSolutionSection(question);
            container.appendChild(solutionSection);
            
            return container;
        }
        
        // Create binary question
        function createBinaryQuestion(question, conceptId) {
            const container = document.createElement('div');
            
            const optionsDiv = document.createElement('div');
            optionsDiv.className = 'binary-options';
            
            const trueBtn = document.createElement('button');
            trueBtn.className = 'binary-btn';
            trueBtn.textContent = 'True';
            trueBtn.onclick = () => selectBinary(`${conceptId}-${question.id}`, 'true');
            
            const falseBtn = document.createElement('button');
            falseBtn.className = 'binary-btn';
            falseBtn.textContent = 'False';
            falseBtn.onclick = () => selectBinary(`${conceptId}-${question.id}`, 'false');
            
            optionsDiv.appendChild(trueBtn);
            optionsDiv.appendChild(falseBtn);
            container.appendChild(optionsDiv);
            
            const explainInput = document.createElement('textarea');
            explainInput.className = 'explain-input';
            explainInput.id = `${conceptId}-${question.id}-explain`;
            explainInput.placeholder = 'Explain your answer...';
            container.appendChild(explainInput);
            
            const submitBtn = document.createElement('button');
            submitBtn.className = 'submit-btn';
            submitBtn.textContent = 'Submit';
            submitBtn.onclick = () => checkBinary(`${conceptId}-${question.id}`, question);
            container.appendChild(submitBtn);
            
            const feedback = document.createElement('div');
            feedback.className = 'feedback';
            feedback.id = `${conceptId}-${question.id}-feedback`;
            feedback.style.display = 'none';
            container.appendChild(feedback);
            
            // Model answer section
            const modelSection = createModelAnswerSection(question);
            container.appendChild(modelSection);
            
            return container;
        }
        
        // Create solution section for SA questions
        function createSolutionSection(question) {
            const section = document.createElement('div');
            section.className = 'why-section';
            
            const header = document.createElement('div');
            header.className = 'why-header';
            header.onclick = () => toggleWhy(header);
            
            const arrow = document.createElement('span');
            arrow.className = 'why-arrow';
            arrow.textContent = '▼';
            
            const label = document.createElement('span');
            label.textContent = 'Show Solution';
            
            header.appendChild(arrow);
            header.appendChild(label);
            
            const content = document.createElement('div');
            content.className = 'why-content';
            
            const solutionDiv = document.createElement('div');
            solutionDiv.className = 'solution';
            
            let solutionHTML = '<pre>';
            question.solution.steps.forEach(step => {
                solutionHTML += step.text + '\n';
                if (step.equations) {
                    step.equations.forEach(eq => {
                        solutionHTML += eq + '\n';
                    });
                }
                solutionHTML += '\n';
            });
            solutionHTML += `Answer: ${question.solution.finalAnswer}</pre>`;
            
            solutionDiv.innerHTML = solutionHTML;
            
            if (question.solution.diagram) {
                solutionDiv.innerHTML += createDiagramHTML(question.solution.diagram);
            }
            
            content.appendChild(solutionDiv);
            section.appendChild(header);
            section.appendChild(content);
            
            return section;
        }
        
        // Create model answer section for binary questions
        function createModelAnswerSection(question) {
            const section = document.createElement('div');
            section.className = 'why-section';
            
            const header = document.createElement('div');
            header.className = 'why-header';
            header.onclick = () => toggleWhy(header);
            
            const arrow = document.createElement('span');
            arrow.className = 'why-arrow';
            arrow.textContent = '▼';
            
            const label = document.createElement('span');
            label.textContent = 'Model Answer';
            
            header.appendChild(arrow);
            header.appendChild(label);
            
            const content = document.createElement('div');
            content.className = 'why-content';
            
            const solutionDiv = document.createElement('div');
            solutionDiv.className = 'solution';
            solutionDiv.innerHTML = `<p>${question.modelAnswer.text}</p>`;
            
            if (question.modelAnswer.diagram) {
                solutionDiv.innerHTML += createDiagramHTML(question.modelAnswer.diagram);
            }
            
            content.appendChild(solutionDiv);
            section.appendChild(header);
            section.appendChild(content);
            
            return section;
        }
        
        // Create diagram HTML
        function createDiagramHTML(diagram) {
            return `
                <div class="diagram">
                    <img src="${diagram.url}" 
                         alt="${diagram.alt}" 
                         onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <div class="diagram-error" style="display:none; padding: 20px; background: #f8f9fa; border: 1px dashed #dee2e6; color: #6c757d; text-align: center;">
                        <small>Diagram not available: ${diagram.alt}</small>
                    </div>
                    ${diagram.caption ? `<div class="diagram-caption">${diagram.caption}</div>` : ''}
                </div>
            `;
        }
        
        // Toggle functions
        function toggleContent(header) {
            const content = header.nextElementSibling;
            header.classList.toggle('active');
            content.classList.toggle('active');
        }
        
        function toggleWhy(header) {
            const content = header.nextElementSibling;
            header.classList.toggle('active');
            content.classList.toggle('active');
        }
        
        // Question interaction functions
        function selectMC(questionId, displayOption) {
            const options = document.querySelectorAll(`#${questionId} .mc-option`);
            options.forEach(opt => opt.classList.remove('selected'));
            
            const selected = document.querySelector(`#${questionId} input[value="${displayOption}"]`);
            if (selected) {
                selected.checked = true;
                selected.parentElement.parentElement.classList.add('selected');
            }
        }
        
        function checkMC(questionId, question) {
            const selected = document.querySelector(`#${questionId} input:checked`);
            if (!selected) {
                alert('Please select an answer');
                return;
            }
            
            // Get the display option selected by user
            const selectedDisplay = selected.value;
            
            // Map back to original ID
            const mapping = window.mcOptionMappings[questionId];
            const selectedOriginal = mapping.displayToOriginal[selectedDisplay];
            
            const isCorrect = selectedOriginal === question.correctAnswer;
            const courseData = studentData.courses[currentCourse];
            
            // Initialize question data if not exists
            if (!courseData.concepts[questionId]) {
                courseData.concepts[questionId] = {
                    firstTry: null,
                    attempts: 0,
                    correct: false
                };
            }
            
            const questionData = courseData.concepts[questionId];
            questionData.attempts++;
            
            // Record first try
            if (questionData.firstTry === null) {
                questionData.firstTry = isCorrect;
                courseData.firstTryTotal++;
                if (isCorrect) {
                    courseData.firstTryCorrect++;
                }
            }
            
            // Update corrected score
            if (isCorrect && !questionData.correct) {
                questionData.correct = true;
                courseData.correctedCorrect++;
            }
            if (questionData.attempts === 1) {
                courseData.correctedTotal++;
            }
            
            // Show feedback
            const feedback = document.getElementById(`${questionId}-feedback`);
            const selectedOption = document.querySelector(`#${questionId} .mc-option input[value="${selectedDisplay}"]`).parentElement.parentElement;
            
            if (isCorrect) {
                selectedOption.classList.add('correct');
                feedback.className = 'feedback correct';
                feedback.innerHTML = question.feedback.correct;
                if (question.feedback.explanation) {
                    feedback.innerHTML += `<br><br><strong>Explanation:</strong> ${question.feedback.explanation}`;
                }
                feedback.style.display = 'block';
                document.querySelector(`#${questionId} .submit-btn`).disabled = true;
                
                // Show all option explanations when correct
                const allOptions = document.querySelectorAll(`#${questionId} .option-explanation`);
                allOptions.forEach(exp => {
                    exp.style.display = 'block';
                });
                
                // Highlight correct answer in the display
                const correctDisplayId = mapping.originalToDisplay[question.correctAnswer];
                const correctOption = document.querySelector(`#${questionId} .mc-option input[value="${correctDisplayId}"]`).parentElement.parentElement;
                correctOption.classList.add('correct');
            } else {
                selectedOption.classList.add('incorrect');
                feedback.className = 'feedback incorrect';
                feedback.textContent = question.feedback.incorrect;
                feedback.style.display = 'block';
                
                // Only show explanation for the selected incorrect option
                const selectedExplanation = selectedOption.querySelector('.option-explanation');
                if (selectedExplanation) {
                    selectedExplanation.style.display = 'block';
                }
            }
            
            updateScoreDisplay();
            saveData();
        }
        
        function selectBinary(questionId, value) {
            const buttons = document.querySelectorAll(`#${questionId} .binary-btn`);
            buttons.forEach(btn => btn.classList.remove('selected'));
            
            const selected = Array.from(buttons).find(btn => 
                btn.textContent.toLowerCase() === value);
            if (selected) selected.classList.add('selected');
        }
        
        function checkBinary(questionId, question) {
            const selected = document.querySelector(`#${questionId} .binary-btn.selected`);
            const explanation = document.getElementById(`${questionId}-explain`).value;
            
            if (!selected || !explanation.trim()) {
                alert('Please select an answer and provide an explanation');
                return;
            }
            
            const selectedValue = selected.textContent.toLowerCase() === 'true';
            const isCorrect = selectedValue === question.correctAnswer;
            const courseData = studentData.courses[currentCourse];
            
            // Initialize question data if not exists
            if (!courseData.concepts[questionId]) {
                courseData.concepts[questionId] = {
                    firstTry: null,
                    attempts: 0,
                    correct: false
                };
            }
            
            const questionData = courseData.concepts[questionId];
            questionData.attempts++;
            
            // Record first try
            if (questionData.firstTry === null) {
                questionData.firstTry = isCorrect;
                courseData.firstTryTotal++;
                if (isCorrect) {
                    courseData.firstTryCorrect++;
                }
            }
            
            // Update corrected score
            if (isCorrect && !questionData.correct) {
                questionData.correct = true;
                courseData.correctedCorrect++;
            }
            if (questionData.attempts === 1) {
                courseData.correctedTotal++;
            }
            
            // Show feedback
            const feedback = document.getElementById(`${questionId}-feedback`);
            if (isCorrect) {
                feedback.className = 'feedback correct';
                feedback.textContent = 'Correct choice! Check the model answer to compare your explanation.';
            } else {
                feedback.className = 'feedback incorrect';
                feedback.textContent = 'Incorrect choice. Check the model answer for clarification.';
            }
            feedback.style.display = 'block';
            
            updateScoreDisplay();
            saveData();
        }
        
        function markCorrect(questionId, question) {
            const courseData = studentData.courses[currentCourse];
            
            if (!courseData.concepts[questionId]) {
                courseData.concepts[questionId] = {
                    firstTry: true,
                    attempts: 1,
                    correct: true
                };
                courseData.firstTryTotal++;
                courseData.firstTryCorrect++;
                courseData.correctedTotal++;
                courseData.correctedCorrect++;
            }
            
            updateScoreDisplay();
            saveData();
            
            // Visual feedback
            const input = document.getElementById(`${questionId}-input`);
            input.style.borderColor = '#28a745';
            input.style.backgroundColor = '#f0f8f0';
        }
        
        function markIncorrect(questionId, question) {
            const courseData = studentData.courses[currentCourse];
            
            if (!courseData.concepts[questionId]) {
                courseData.concepts[questionId] = {
                    firstTry: false,
                    attempts: 1,
                    correct: false
                };
                courseData.firstTryTotal++;
                courseData.correctedTotal++;
            }
            
            updateScoreDisplay();
            saveData();
            
            // Visual feedback
            const input = document.getElementById(`${questionId}-input`);
            input.style.borderColor = '#dc3545';
            input.style.backgroundColor = '#fdf0f0';
        }
        
        // Score and data management
        function updateScoreDisplay() {
            if (!currentCourse) return;
            
            const courseData = studentData.courses[currentCourse];
            document.getElementById('first-try-score').textContent = 
                `${courseData.firstTryCorrect}/${courseData.firstTryTotal}`;
            document.getElementById('corrected-score').textContent = 
                `${courseData.correctedCorrect}/${courseData.correctedTotal}`;
        }
        
        function saveStudentName() {
            studentData.name = document.getElementById('student-name').value;
            saveData();
        }
        
        function saveData() {
            localStorage.setItem('vceWhyWhyWhyData', JSON.stringify(studentData));
        }
        
        function loadSavedData() {
            const saved = localStorage.getItem('vceWhyWhyWhyData');
            if (saved) {
                studentData = JSON.parse(saved);
                // Ensure lastCourseSelection exists for older saved data
                if (!studentData.lastCourseSelection) {
                    studentData.lastCourseSelection = {
                        subject: '',
                        unit: '',
                        aos: ''
                    };
                }
                document.getElementById('student-name').value = studentData.name || '';
            }
        }
        
        // Restore last selection
        function restoreLastSelection() {
            if (studentData.lastCourseSelection.subject) {
                document.getElementById('subject-select').value = studentData.lastCourseSelection.subject;
                handleSubjectChange();
                
                if (studentData.lastCourseSelection.unit) {
                    setTimeout(() => {
                        document.getElementById('unit-select').value = studentData.lastCourseSelection.unit;
                        handleUnitChange();
                        
                        if (studentData.lastCourseSelection.aos) {
                            setTimeout(() => {
                                document.getElementById('aos-select').value = studentData.lastCourseSelection.aos;
                                handleAosChange();
                            }, 100);
                        }
                    }, 100);
                }
            }
        }
        
        // Utility functions
        function showError(message) {
            const errorDiv = document.getElementById('error-message');
            errorDiv.textContent = message;
            errorDiv.style.display = 'block';
        }
        
        function hideError() {
            document.getElementById('error-message').style.display = 'none';
        }
        
        function showLoading(show) {
            document.getElementById('loading').style.display = show ? 'block' : 'none';
            document.getElementById('course-content').style.display = show ? 'none' : 'block';
        }
    </script>
</body>
</html>