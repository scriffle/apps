<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>You Can't Fake This</title>
    <style>
        /* CSS Variables for Theming */
        :root {
            /* Color scheme for dropdowns */
            --dropdown-unfilled: #fffacd; /* Light yellow */
            --dropdown-filled: #add8e6;   /* Light blue */
            --dropdown-correct: #90ee90;  /* Light green */
            --dropdown-incorrect: #ffcccb; /* Pale red */
            
            /* Default theme colors */
            --primary: #5a67d8;
            --primary-dark: #4c51bf;
            --primary-light: #667eea;
            --secondary: #764ba2;
            
            /* Dynamic gradient (will be overridden by topic) */
            --topic-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --topic-primary: #5a67d8;
            --topic-secondary: #764ba2;
            
            /* Backgrounds */
            --bg-main: #ffffff;
            --bg-secondary: #f7fafc;
            --bg-tertiary: #edf2f7;
            
            /* Text colors */
            --text-primary: #2d3748;
            --text-secondary: #4a5568;
            --text-tertiary: #718096;
            --text-inverse: #ffffff;
            
            /* Borders & shadows */
            --border-color: #e2e8f0;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.1);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1);
            
            /* Transitions */
            --transition-fast: 150ms ease;
            --transition-normal: 250ms ease;
            --transition-slow: 350ms ease;
        }
        
        /* Dark mode variables */
        [data-theme="dark"] {
            --bg-main: #1a202c;
            --bg-secondary: #2d3748;
            --bg-tertiary: #4a5568;
            --text-primary: #f7fafc;
            --text-secondary: #e2e8f0;
            --text-tertiary: #cbd5e0;
            --border-color: #4a5568;
            --dropdown-unfilled: #fef3c7;
            --dropdown-filled: #93c5fd;
            --dropdown-correct: #86efac;
            --dropdown-incorrect: #fca5a5;
        }
        
        /* Base styles */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: var(--topic-gradient);
            min-height: 100vh;
            color: var(--text-primary);
            line-height: 1.6;
        }
        
        /* Container layout */
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* Scrolling behavior */
        html {
            scroll-behavior: smooth;
        }
        
        /* Header */
        .header {
            background: var(--bg-main);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow-lg);
            transition: all var(--transition-normal);
        }
        
        .header.collapsed {
            padding: 16px 24px;
        }
        
        .header-top {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 12px;
        }
        
        .header h1 {
            font-size: 28px;
            background: var(--topic-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin: 0;
            flex: 1;
        }
        
        /* Mini status indicator when collapsed */
        .header-mini-status {
            display: none;
            align-items: center;
            gap: 8px;
            font-size: 14px;
            color: var(--text-secondary);
            padding: 6px 12px;
            background: var(--bg-secondary);
            border-radius: 6px;
            flex: 1;
            margin: 0 8px;
            min-width: 0;
        }
        
        .header.collapsed .header-mini-status {
            display: flex;
        }
        
        .header-mini-status .topic-name {
            background: var(--topic-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            font-weight: 600;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        /* Theme toggle */
        .theme-toggle {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 50%;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-fast);
            flex-shrink: 0;
            margin-left: 8px;
            position: relative;
        }
        
        .theme-toggle:hover {
            background: var(--bg-tertiary);
            border-color: var(--topic-primary);
            transform: scale(1.05);
        }
        
        .theme-toggle::after {
            content: attr(data-theme);
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 4px;
            padding: 4px 8px;
            background: var(--text-primary);
            color: var(--bg-main);
            font-size: 11px;
            border-radius: 4px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity var(--transition-fast);
            text-transform: capitalize;
        }
        
        .theme-toggle:hover::after {
            opacity: 0.9;
        }
        
        .theme-toggle svg {
            width: 20px;
            height: 20px;
            fill: var(--text-primary);
        }
        
        /* Collapse button */
        .collapse-btn {
            background: var(--bg-secondary);
            border: 2px solid var(--border-color);
            border-radius: 8px;
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all var(--transition-fast);
            flex-shrink: 0;
            position: relative;
            margin-left: 4px;
        }
        
        .collapse-btn:hover {
            background: var(--bg-tertiary);
            border-color: var(--topic-primary);
            transform: scale(1.05);
        }
        
        .collapse-btn::after {
            content: 'Ctrl+H';
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 4px;
            padding: 4px 8px;
            background: var(--text-primary);
            color: var(--bg-main);
            font-size: 11px;
            border-radius: 4px;
            white-space: nowrap;
            opacity: 0;
            pointer-events: none;
            transition: opacity var(--transition-fast);
        }
        
        .collapse-btn:hover::after {
            opacity: 0.9;
        }
        
        .mac .collapse-btn::after {
            content: 'Cmd+H';
        }
        
        .collapse-btn svg {
            width: 20px;
            height: 20px;
            fill: var(--text-primary);
            transition: transform var(--transition-normal);
        }
        
        .header.collapsed .collapse-btn svg {
            transform: rotate(180deg);
        }
        
        /* Collapsible content */
        .header-content {
            margin-top: 16px;
            overflow: hidden;
            transition: all var(--transition-normal);
            opacity: 1;
            transform: translateY(0);
        }
        
        .header.collapsed .header-content {
            max-height: 0;
            margin-top: 0;
            opacity: 0;
            transform: translateY(-10px);
            pointer-events: none;
        }
        
        /* Student name input */
        .student-info {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
            padding: 12px;
            background: var(--bg-secondary);
            border-radius: 8px;
        }
        
        .student-info label {
            font-weight: 600;
            color: var(--text-secondary);
            white-space: nowrap;
        }
        
        .student-info input {
            flex: 1;
            max-width: 300px;
            padding: 8px 12px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            background: var(--bg-main);
            color: var(--text-primary);
            font-size: 14px;
            transition: all var(--transition-fast);
        }
        
        .student-info input:focus {
            outline: none;
            border-color: var(--topic-primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .student-info .save-indicator {
            font-size: 12px;
            color: var(--dropdown-correct);
            opacity: 0;
            transition: opacity var(--transition-normal);
        }
        
        .student-info .save-indicator.show {
            opacity: 1;
        }
        
        /* Topic Selector */
        .topic-selector {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 12px;
            margin-bottom: 16px;
        }
        
        .selector-group {
            display: flex;
            flex-direction: column;
        }
        
        .selector-group label {
            font-size: 12px;
            text-transform: uppercase;
            color: var(--text-tertiary);
            margin-bottom: 4px;
            font-weight: 600;
            letter-spacing: 0.5px;
        }
        
        .selector-group select {
            padding: 10px 12px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            background: var(--bg-main);
            color: var(--text-primary);
            font-size: 14px;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .selector-group select:hover {
            border-color: var(--topic-primary);
        }
        
        .selector-group select:focus {
            outline: none;
            border-color: var(--topic-primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .selector-group select:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Action buttons */
        .selector-actions {
            display: flex;
            gap: 12px;
            margin-top: 16px;
        }
        
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .btn-primary {
            background: var(--topic-gradient);
            color: var(--text-inverse);
        }
        
        .btn-primary:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }
        
        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: var(--border-color);
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        /* Status bar */
        .status-bar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-radius: 8px;
            margin-bottom: 16px;
            font-size: 14px;
        }
        
        .status-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .status-label {
            color: var(--text-tertiary);
            font-weight: 600;
        }
        
        .status-value {
            color: var(--text-primary);
            font-weight: 700;
        }
        
        /* Round indicators */
        .round-indicator {
            display: inline-flex;
            gap: 6px;
            margin-left: 8px;
        }
        
        .round-badge {
            padding: 2px 6px;
            border-radius: 4px;
            font-size: 12px;
            font-weight: bold;
            background: var(--bg-tertiary);
            color: var(--text-tertiary);
            transition: all var(--transition-fast);
        }
        
        .round-badge.completed {
            background: var(--dropdown-correct);
            color: #16a34a;
        }
        
        .round-badge.current {
            background: var(--topic-gradient);
            color: var(--text-inverse);
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        
        /* Main content area */
        .main-content {
            background: var(--bg-main);
            border-radius: 12px;
            padding: 24px;
            box-shadow: var(--shadow-lg);
            min-height: 400px;
            position: relative;
            max-height: calc(100vh - 420px);
            overflow-y: auto;
            overflow-x: hidden;
            transition: max-height var(--transition-normal);
        }
        
        .header.collapsed ~ .main-content {
            max-height: calc(100vh - 140px);
        }
        
        /* Tabs container */
        .tabs-container {
            display: flex;
            flex-direction: column;
            height: 100%;
        }
        
        .tab-headers {
            display: flex;
            gap: 4px;
            border-bottom: 2px solid var(--border-color);
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .tab-header {
            padding: 10px 16px;
            background: transparent;
            border: none;
            border-bottom: 3px solid transparent;
            color: var(--text-secondary);
            font-weight: 600;
            cursor: pointer;
            transition: all var(--transition-fast);
            position: relative;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        
        .tab-header:hover {
            color: var(--text-primary);
            background: var(--bg-secondary);
        }
        
        .tab-header.active {
            color: var(--topic-primary);
            border-bottom-color: var(--topic-primary);
        }
        
        .tab-header .round-markers {
            display: inline-flex;
            gap: 2px;
            font-size: 10px;
            margin-left: 4px;
        }
        
        .tab-header .round-marker {
            color: var(--dropdown-correct);
            font-weight: bold;
        }
        
        /* Tab panels */
        .tab-panels {
            flex: 1;
            overflow-y: auto;
            padding-right: 8px;
        }
        
        .tab-panel {
            display: none;
        }
        
        .tab-panel.active {
            display: block;
            animation: fadeIn var(--transition-normal);
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Content inside tabs */
        .tab-content {
            max-height: calc(100vh - 300px);
            overflow-y: auto;
            padding-right: 8px;
            transition: max-height var(--transition-normal);
        }
        
        .header.collapsed ~ .main-content .tab-content {
            max-height: calc(100vh - 200px);
        }
        
        .content-section {
            margin-bottom: 20px;
        }
        
        .content-section h3 {
            color: var(--topic-primary);
            margin-bottom: 12px;
        }
        
        .content-sentence {
            font-size: 16px;
            line-height: 1.8;
            margin-bottom: 16px;
            color: var(--text-primary);
        }
        
        /* Dropdown styles */
        .content-dropdown {
            display: inline-block;
            padding: 4px 8px;
            margin: 0 4px;
            border: 2px solid var(--border-color);
            border-radius: 6px;
            background: var(--dropdown-unfilled);
            color: var(--text-primary);
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
            min-width: 120px;
        }
        
        .content-dropdown:hover:not(:disabled) {
            border-color: var(--topic-primary);
        }
        
        .content-dropdown:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .content-dropdown.filled {
            background: var(--dropdown-filled);
        }
        
        .content-dropdown.correct {
            background: var(--dropdown-correct);
            border-color: #16a34a;
        }
        
        .content-dropdown.incorrect {
            background: var(--dropdown-incorrect);
            border-color: #dc2626;
        }
        
        .content-dropdown:disabled {
            cursor: not-allowed;
            opacity: 0.8;
        }
        
        /* Content images */
        .content-image {
            margin: 20px 0;
            text-align: center;
        }
        
        .content-image img {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: var(--shadow-md);
        }
        
        .content-image figcaption {
            margin-top: 8px;
            font-size: 14px;
            color: var(--text-secondary);
            font-style: italic;
        }
        
        /* Tab footer */
        .tab-footer {
            margin-top: 24px;
            padding-top: 20px;
            border-top: 2px solid var(--border-color);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .progress-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .progress-text {
            font-size: 14px;
            color: var(--text-secondary);
        }
        
        .progress-text strong {
            color: var(--topic-primary);
        }
        
        .tab-actions {
            display: flex;
            gap: 12px;
        }
        
        /* Loading state */
        .loading-message {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 300px;
            color: var(--text-secondary);
        }
        
        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid var(--border-color);
            border-top-color: var(--topic-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        /* Error message */
        .error-message {
            padding: 16px;
            background: var(--dropdown-incorrect);
            border: 2px solid #dc2626;
            border-radius: 8px;
            color: #dc2626;
            margin: 16px 0;
        }
        
        /* Custom scrollbar */
        .main-content::-webkit-scrollbar,
        .tab-panels::-webkit-scrollbar,
        .tab-content::-webkit-scrollbar {
            width: 8px;
        }
        
        .main-content::-webkit-scrollbar-track,
        .tab-panels::-webkit-scrollbar-track,
        .tab-content::-webkit-scrollbar-track {
            background: var(--bg-secondary);
            border-radius: 4px;
        }
        
        .main-content::-webkit-scrollbar-thumb,
        .tab-panels::-webkit-scrollbar-thumb,
        .tab-content::-webkit-scrollbar-thumb {
            background: var(--topic-primary);
            border-radius: 4px;
        }
        
        .main-content::-webkit-scrollbar-thumb:hover,
        .tab-panels::-webkit-scrollbar-thumb:hover,
        .tab-content::-webkit-scrollbar-thumb:hover {
            background: var(--topic-secondary);
        }
        
        /* Utility classes */
        .hidden {
            display: none !important;
        }
        
        .text-center {
            text-align: center;
        }
        
        .mt-4 {
            margin-top: 16px;
        }
        
        .mb-4 {
            margin-bottom: 16px;
        }
        
        /* Responsive design */
        @media (max-width: 768px) {
            .app-container {
                padding: 12px;
            }
            
            .header {
                padding: 16px;
            }
            
            .header.collapsed {
                padding: 12px 16px;
            }
            
            .header-top {
                gap: 8px;
            }
            
            .header h1 {
                font-size: 24px;
            }
            
            .theme-toggle {
                width: 32px;
                height: 32px;
            }
            
            .theme-toggle::after {
                display: none;
            }
            
            .theme-toggle svg {
                width: 18px;
                height: 18px;
            }
            
            .collapse-btn {
                width: 32px;
                height: 32px;
            }
            
            .collapse-btn::after {
                display: none;
            }
            
            .collapse-btn svg {
                width: 18px;
                height: 18px;
            }
            
            .student-info {
                flex-direction: column;
                align-items: stretch;
            }
            
            .student-info input {
                max-width: 100%;
            }
            
            .topic-selector {
                grid-template-columns: 1fr;
            }
            
            .main-content {
                max-height: none;
                min-height: 500px;
                overflow-y: visible;
            }
            
            .tab-headers {
                overflow-x: auto;
                flex-wrap: nowrap;
            }
            
            .content-dropdown {
                min-width: 100px;
                font-size: 13px;
            }
        }
        
        @media (max-width: 480px) {
            .header h1 {
                font-size: 20px;
            }
            
            .header.collapsed h1 {
                font-size: 16px;
            }
            
            .header-top {
                gap: 6px;
            }
            
            .header-mini-status {
                font-size: 11px;
                padding: 4px 6px;
                margin: 0 4px;
            }
            
            .theme-toggle {
                width: 28px;
                height: 28px;
            }
            
            .theme-toggle svg {
                width: 16px;
                height: 16px;
            }
            
            .collapse-btn {
                width: 28px;
                height: 28px;
            }
            
            .collapse-btn svg {
                width: 16px;
                height: 16px;
            }
            
            .selector-actions {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                justify-content: center;
            }
            
            .tab-footer {
                flex-direction: column;
                gap: 16px;
            }
            
            .tab-actions {
                width: 100%;
            }
            
            .tab-actions .btn {
                flex: 1;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Header -->
        <header class="header" id="header">
            <div class="header-top">
                <h1>You Can't Fake This</h1>
                <div class="header-mini-status" id="headerMiniStatus" style="display: none;">
                    <span class="topic-name" id="miniTopicName">No topic loaded</span>
                </div>
                <button class="theme-toggle" id="themeToggle" aria-label="Toggle theme">
                    <svg class="sun-icon" viewBox="0 0 24 24" style="display: none;">
                        <path d="M12 17.5C9.5 17.5 7.5 15.5 7.5 13S9.5 8.5 12 8.5 16.5 10.5 16.5 13 14.5 17.5 12 17.5M12 7C8.7 7 6 9.7 6 13S8.7 19 12 19 18 16.3 18 13 15.3 7 12 7M12 2L14.4 6.4L19 5.7L16.2 9.8L18.6 14L14 12.7L9.4 14L11.8 9.8L9 5.7L13.6 6.4L12 2Z"/>
                    </svg>
                    <svg class="moon-icon" viewBox="0 0 24 24">
                        <path d="M17.75,4.09L15.22,6.03L16.13,9.09L13.5,7.28L10.87,9.09L11.78,6.03L9.25,4.09L12.44,4L13.5,1L14.56,4L17.75,4.09M21.25,11L19.61,12.25L20.2,14.23L18.5,13.06L16.8,14.23L17.39,12.25L15.75,11L17.81,10.95L18.5,9L19.19,10.95L21.25,11M18.97,15.95C19.8,15.87 20.69,17.05 20.16,17.8C19.84,18.25 19.5,18.67 19.08,19.07C15.17,23 8.84,23 4.94,19.07C1.03,15.17 1.03,8.83 4.94,4.93C5.34,4.53 5.76,4.17 6.21,3.85C6.96,3.32 8.14,4.21 8.06,5.04C7.79,7.9 8.75,10.87 10.95,13.06C13.14,15.26 16.1,16.22 18.97,15.95M17.33,17.97C14.5,17.81 11.7,16.64 9.53,14.5C7.36,12.31 6.2,9.5 6.04,6.68C3.23,9.82 3.34,14.64 6.35,17.66C9.37,20.67 14.19,20.78 17.33,17.97Z"/>
                    </svg>
                </button>
                <button class="collapse-btn" id="collapseBtn" aria-label="Toggle header">
                    <svg viewBox="0 0 24 24">
                        <path d="M7.41,8.58L12,13.17L16.59,8.58L18,10L12,16L6,10L7.41,8.58Z"/>
                    </svg>
                </button>
            </div>
            
            <div class="header-content" id="headerContent">
                <!-- Student Name Input -->
                <div class="student-info">
                    <label for="studentName">Student Name:</label>
                    <input 
                        type="text" 
                        id="studentName" 
                        placeholder="Enter your name..."
                        maxlength="50"
                        autocomplete="name"
                    >
                    <span class="save-indicator" id="nameSaveIndicator">✓ Saved</span>
                </div>
                
                <!-- Topic Selector -->
                <div class="topic-selector">
                    <div class="selector-group">
                        <label for="unitSelect">Unit</label>
                        <select id="unitSelect">
                            <option value="">Loading units...</option>
                        </select>
                    </div>
                    
                    <div class="selector-group">
                        <label for="aosSelect">Area of Study</label>
                        <select id="aosSelect" disabled>
                            <option value="">Select unit first...</option>
                        </select>
                    </div>
                    
                    <div class="selector-group">
                        <label for="topicSelect">Topic</label>
                        <select id="topicSelect" disabled>
                            <option value="">Select area first...</option>
                        </select>
                    </div>
                </div>
                
                <div class="selector-actions">
                    <button class="btn btn-primary" id="loadTopicBtn" disabled>
                        Load Topic
                    </button>
                    <button class="btn btn-secondary" id="changeTopicBtn" style="display: none;">
                        Change Topic
                    </button>
                </div>
                
                <!-- Status bar (hidden initially) -->
                <div class="status-bar hidden" id="statusBar">
                    <div class="status-item">
                        <span class="status-label">Current Round:</span>
                        <span class="status-value" id="currentRoundText">Round 1</span>
                        <div class="round-indicator" id="roundIndicator" style="display: none;">
                            <span class="round-badge" data-round="1">(1)</span>
                            <span class="round-badge" data-round="2">(2)</span>
                            <span class="round-badge" data-round="3">(3)</span>
                        </div>
                    </div>
                    <div class="status-item">
                        <span class="status-label">Started:</span>
                        <span class="status-value" id="startedDate">-</span>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- Main Content Area -->
        <main class="main-content" id="mainContent">
            <div class="loading-message">
                <div class="loading-spinner"></div>
                <p>Loading topics...</p>
            </div>
        </main>
    </div>
    
    <script>
        // ========================================
        // Global Constants
        // ========================================
        const BASE_URL = '/youcantfakethis/';
        const TOPICS_INDEX = 'topics-index.json';
        
        // ========================================
        // localStorage State Manager
        // ========================================
        class StateManager {
            constructor() {
                this.prefix = 'dropdownReview_';
                this.currentTopic = null;
                this.currentSubject = 'physics';
            }
            
            getKey(topic, dataType) {
                if (topic) {
                    return `${this.currentSubject}_${topic}_${dataType}`;
                }
                return `${this.prefix}${dataType}`;
            }
            
            save(key, value) {
                try {
                    localStorage.setItem(key, JSON.stringify(value));
                    return true;
                } catch (e) {
                    console.error('Failed to save to localStorage:', e);
                    return false;
                }
            }
            
            load(key, defaultValue = null) {
                try {
                    const item = localStorage.getItem(key);
                    return item ? JSON.parse(item) : defaultValue;
                } catch (e) {
                    console.error('Failed to load from localStorage:', e);
                    return defaultValue;
                }
            }
            
            saveTopicState(topicId, state) {
                const updates = {
                    currentRound: state.currentRound || 1,
                    currentTab: state.currentTab || null,
                    lastAccessed: new Date().toISOString(),
                    tabsCompleted: state.tabsCompleted || { round1: [], round2: [], round3: [] },
                    selections: state.selections || {},
                    scores: state.scores || {},
                    conceptErrors: state.conceptErrors || {},
                    randomSeeds: state.randomSeeds || {}
                };
                
                Object.entries(updates).forEach(([key, value]) => {
                    this.save(this.getKey(topicId, key), value);
                });
                
                this.save(this.getKey(null, 'currentTopic'), topicId);
                this.currentTopic = topicId;
            }
            
            loadTopicState(topicId) {
                return {
                    currentRound: this.load(this.getKey(topicId, 'currentRound'), 1),
                    currentTab: this.load(this.getKey(topicId, 'currentTab'), null),
                    startedDate: this.load(this.getKey(topicId, 'startedDate'), null),
                    lastAccessed: this.load(this.getKey(topicId, 'lastAccessed'), null),
                    tabsCompleted: this.load(this.getKey(topicId, 'tabsCompleted'), { round1: [], round2: [], round3: [] }),
                    selections: this.load(this.getKey(topicId, 'selections'), {}),
                    scores: this.load(this.getKey(topicId, 'scores'), {}),
                    conceptErrors: this.load(this.getKey(topicId, 'conceptErrors'), {}),
                    randomSeeds: this.load(this.getKey(topicId, 'randomSeeds'), {})
                };
            }
            
            saveSelection(topicId, round, tab, questionId, value) {
                const selections = this.load(this.getKey(topicId, 'selections'), {});
                if (!selections[`round${round}`]) selections[`round${round}`] = {};
                if (!selections[`round${round}`][tab]) selections[`round${round}`][tab] = {};
                selections[`round${round}`][tab][questionId] = value;
                this.save(this.getKey(topicId, 'selections'), selections);
            }
            
            saveTabScore(topicId, round, tab, correct, total) {
                const scores = this.load(this.getKey(topicId, 'scores'), {});
                if (!scores[`round${round}`]) scores[`round${round}`] = {};
                scores[`round${round}`][tab] = { correct, total };
                this.save(this.getKey(topicId, 'scores'), scores);
            }
            
            trackConceptError(topicId, concept, wrongAnswer, round) {
                const errors = this.load(this.getKey(topicId, 'conceptErrors'), {});
                if (!errors[concept]) {
                    errors[concept] = {
                        errors: 0,
                        wrongAnswers: [],
                        rounds: []
                    };
                }
                errors[concept].errors++;
                if (!errors[concept].wrongAnswers.includes(wrongAnswer)) {
                    errors[concept].wrongAnswers.push(wrongAnswer);
                }
                if (!errors[concept].rounds.includes(`round${round}`)) {
                    errors[concept].rounds.push(`round${round}`);
                }
                this.save(this.getKey(topicId, 'conceptErrors'), errors);
            }
            
            markTabCompleted(topicId, round, tab) {
                const state = this.loadTopicState(topicId);
                const roundKey = `round${round}`;
                if (!state.tabsCompleted[roundKey].includes(tab)) {
                    state.tabsCompleted[roundKey].push(tab);
                    this.save(this.getKey(topicId, 'tabsCompleted'), state.tabsCompleted);
                }
            }
            
            isRoundComplete(topicId, round, totalTabs) {
                const state = this.loadTopicState(topicId);
                const roundKey = `round${round}`;
                return state.tabsCompleted[roundKey].length === totalTabs;
            }
            
            resetTab(topicId, round, tab) {
                const selections = this.load(this.getKey(topicId, 'selections'), {});
                if (selections[`round${round}`] && selections[`round${round}`][tab]) {
                    delete selections[`round${round}`][tab];
                    this.save(this.getKey(topicId, 'selections'), selections);
                }
            }
            
            resetRound(topicId, round) {
                const state = this.loadTopicState(topicId);
                const roundKey = `round${round}`;
                
                state.tabsCompleted[roundKey] = [];
                if (state.selections[roundKey]) delete state.selections[roundKey];
                if (state.scores[roundKey]) delete state.scores[roundKey];
                
                this.save(this.getKey(topicId, 'tabsCompleted'), state.tabsCompleted);
                this.save(this.getKey(topicId, 'selections'), state.selections);
                this.save(this.getKey(topicId, 'scores'), state.scores);
            }
            
            resetTopic(topicId) {
                const keysToRemove = [];
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    if (key && key.startsWith(`${this.currentSubject}_${topicId}_`)) {
                        keysToRemove.push(key);
                    }
                }
                keysToRemove.forEach(key => localStorage.removeItem(key));
            }
            
            getTheme() {
                return this.load(this.getKey(null, 'theme'), 'light');
            }
            
            setTheme(theme) {
                this.save(this.getKey(null, 'theme'), theme);
            }
            
            getHeaderCollapsed() {
                return this.load(this.getKey(null, 'headerCollapsed'), false);
            }
            
            setHeaderCollapsed(collapsed) {
                this.save(this.getKey(null, 'headerCollapsed'), collapsed);
            }
            
            getStudentName() {
                return this.load(this.getKey(null, 'studentName'), '');
            }
            
            setStudentName(name) {
                this.save(this.getKey(null, 'studentName'), name);
                if (this.currentTopic) {
                    this.save(this.getKey(this.currentTopic, 'studentName'), name);
                }
            }
        }
        
        // ========================================
        // Theme Manager
        // ========================================
        class ThemeManager {
            constructor(stateManager) {
                this.stateManager = stateManager;
                this.init();
            }
            
            init() {
                const savedTheme = this.stateManager.getTheme();
                this.setTheme(savedTheme);
                
                const toggleBtn = document.getElementById('themeToggle');
                toggleBtn.addEventListener('click', () => this.toggleTheme());
                toggleBtn.setAttribute('data-theme', savedTheme === 'light' ? 'dark' : 'light');
            }
            
            setTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                this.updateIcon(theme);
                const toggleBtn = document.getElementById('themeToggle');
                toggleBtn.setAttribute('data-theme', theme === 'light' ? 'dark' : 'light');
            }
            
            toggleTheme() {
                const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
                const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                this.setTheme(newTheme);
                this.stateManager.setTheme(newTheme);
            }
            
            updateIcon(theme) {
                const sunIcon = document.querySelector('.sun-icon');
                const moonIcon = document.querySelector('.moon-icon');
                
                if (theme === 'dark') {
                    sunIcon.style.display = 'block';
                    moonIcon.style.display = 'none';
                } else {
                    sunIcon.style.display = 'none';
                    moonIcon.style.display = 'block';
                }
            }
            
            applyTopicTheme(gradientColors) {
                if (gradientColors) {
                    const gradient = `linear-gradient(135deg, ${gradientColors.start} 0%, ${gradientColors.end} 100%)`;
                    document.documentElement.style.setProperty('--topic-gradient', gradient);
                    document.documentElement.style.setProperty('--topic-primary', gradientColors.start);
                    document.documentElement.style.setProperty('--topic-secondary', gradientColors.end);
                }
            }
        }
        
        // ========================================
        // Header Collapse Manager
        // ========================================
        class HeaderCollapseManager {
            constructor(stateManager) {
                this.stateManager = stateManager;
                this.header = document.getElementById('header');
                this.collapseBtn = document.getElementById('collapseBtn');
                this.headerContent = document.getElementById('headerContent');
                this.init();
            }
            
            init() {
                const isCollapsed = this.stateManager.getHeaderCollapsed();
                if (isCollapsed) {
                    this.header.classList.add('collapsed');
                }
                
                this.collapseBtn.addEventListener('click', () => this.toggle());
                
                document.addEventListener('keydown', (e) => {
                    if ((e.ctrlKey || e.metaKey) && e.key === 'h') {
                        e.preventDefault();
                        this.toggle();
                    }
                });
            }
            
            toggle() {
                const isCollapsed = this.header.classList.toggle('collapsed');
                this.stateManager.setHeaderCollapsed(isCollapsed);
                this.collapseBtn.setAttribute('aria-expanded', !isCollapsed);
                this.headerContent.setAttribute('aria-hidden', isCollapsed);
                window.dispatchEvent(new Event('resize'));
            }
            
            expand() {
                this.header.classList.remove('collapsed');
                this.stateManager.setHeaderCollapsed(false);
                this.collapseBtn.setAttribute('aria-expanded', true);
                this.headerContent.setAttribute('aria-hidden', false);
            }
        }
        
        // ========================================
        // Student Name Manager
        // ========================================
        class StudentNameManager {
            constructor(stateManager) {
                this.stateManager = stateManager;
                this.nameInput = document.getElementById('studentName');
                this.saveIndicator = document.getElementById('nameSaveIndicator');
                this.saveTimeout = null;
                this.init();
            }
            
            init() {
                const savedName = this.stateManager.getStudentName();
                if (savedName) {
                    this.nameInput.value = savedName;
                }
                
                this.setupEventListeners();
            }
            
            setupEventListeners() {
                this.nameInput.addEventListener('input', (e) => {
                    if (this.saveTimeout) {
                        clearTimeout(this.saveTimeout);
                    }
                    
                    this.saveIndicator.classList.remove('show');
                    
                    this.saveTimeout = setTimeout(() => {
                        this.saveName(e.target.value);
                    }, 500);
                });
                
                this.nameInput.addEventListener('blur', (e) => {
                    if (this.saveTimeout) {
                        clearTimeout(this.saveTimeout);
                    }
                    this.saveName(e.target.value);
                });
                
                this.nameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        this.nameInput.blur();
                    }
                });
            }
            
            saveName(name) {
                name = name.trim();
                this.stateManager.setStudentName(name);
                this.showSaveIndicator();
            }
            
            showSaveIndicator() {
                this.saveIndicator.classList.add('show');
                setTimeout(() => {
                    this.saveIndicator.classList.remove('show');
                }, 2000);
            }
        }
        
        // ========================================
        // Content Manager
        // ========================================
        class ContentManager {
            constructor(stateManager, themeManager) {
                this.stateManager = stateManager;
                this.themeManager = themeManager;
                this.currentContent = null;
                this.currentRound = 1;
                this.currentTab = null;
            }
            
            async loadTopicContent(filename) {
                try {
                    const response = await fetch(`${BASE_URL}${filename}`);
                    if (!response.ok) {
                        throw new Error(`Failed to load topic: ${response.status}`);
                    }
                    
                    this.currentContent = await response.json();
                    
                    // Apply topic theme
                    if (this.currentContent.metadata?.colorTheme) {
                        this.themeManager.applyTopicTheme(this.currentContent.metadata.colorTheme);
                    }
                    
                    return this.currentContent;
                } catch (error) {
                    console.error('Failed to load topic content:', error);
                    throw error;
                }
            }
            
            renderTabs() {
                if (!this.currentContent) return;
                
                const mainContent = document.getElementById('mainContent');
                const state = this.stateManager.loadTopicState(this.currentContent.metadata.topicId);
                
                let tabsHTML = `
                    <div class="tabs-container">
                        <div class="tab-headers" id="tabHeaders">
                `;
                
                // Generate tab headers
                this.currentContent.tabs.forEach((tab, index) => {
                    const isActive = index === 0;
                    const completedRounds = this.getCompletedRounds(state, tab.id);
                    
                    let roundMarkers = '';
                    if (completedRounds.length > 0) {
                        roundMarkers = '<span class="round-markers">';
                        completedRounds.forEach(round => {
                            roundMarkers += `<span class="round-marker">(${round})</span>`;
                        });
                        roundMarkers += '</span>';
                    }
                    
                    tabsHTML += `
                        <button class="tab-header ${isActive ? 'active' : ''}" 
                                data-tab="${tab.id}">
                            ${tab.label}
                            ${roundMarkers}
                        </button>
                    `;
                });
                
                tabsHTML += `
                        </div>
                        <div class="tab-panels" id="tabPanels">
                `;
                
                // Generate tab panels
                this.currentContent.tabs.forEach((tab, index) => {
                    const isActive = index === 0;
                    tabsHTML += `
                        <div class="tab-panel ${isActive ? 'active' : ''}" 
                             data-tab="${tab.id}">
                            <div class="tab-content" id="content-${tab.id}">
                                ${this.renderTabContent(tab.id, state.currentRound)}
                            </div>
                        </div>
                    `;
                });
                
                tabsHTML += `
                        </div>
                    </div>
                `;
                
                mainContent.innerHTML = tabsHTML;
                
                // Setup tab switching
                this.setupTabHandlers();
                
                // Restore selections
                this.restoreSelections(state);
            }
            
            renderTabContent(tabId, round) {
                const roundKey = `round${round}`;
                const tabContent = this.currentContent.content[roundKey]?.[tabId];
                
                if (!tabContent) {
                    return '<p>Content not available for this round.</p>';
                }
                
                let html = `<div class="content-section">`;
                
                if (tabContent.title) {
                    html += `<h3>${tabContent.title}</h3>`;
                }
                
                if (tabContent.image) {
                    html += `
                        <figure class="content-image">
                            <img src="${BASE_URL}images/${this.currentContent.metadata.topicId}/${tabContent.image}" 
                                 alt="${tabContent.imageAlt || ''}">
                            ${tabContent.imageCaption ? `<figcaption>${tabContent.imageCaption}</figcaption>` : ''}
                        </figure>
                    `;
                }
                
                // Render sentences with dropdowns
                if (tabContent.sentences) {
                    tabContent.sentences.forEach(sentence => {
                        html += `<div class="content-sentence">${this.processSentence(sentence, tabId)}</div>`;
                    });
                }
                
                html += `</div>`;
                
                // Add footer with buttons
                html += `
                    <div class="tab-footer">
                        <div class="progress-info">
                            <span class="progress-text">
                                Completed: <strong id="progress-${tabId}">0/0</strong>
                            </span>
                        </div>
                        <div class="tab-actions">
                            <button class="btn btn-secondary" onclick="app.resetCurrentTab()">
                                Reset Tab
                            </button>
                            <button class="btn btn-primary" id="submit-${tabId}" disabled>
                                Submit Answers
                            </button>
                        </div>
                    </div>
                `;
                
                return html;
            }
            
            processSentence(sentence, tabId) {
                // Replace placeholders with dropdowns
                return sentence.text.replace(/\{\{(\w+)\}\}/g, (match, questionId) => {
                    const question = sentence.questions[questionId];
                    if (!question) return match;
                    
                    // Randomize options
                    const options = this.shuffleOptions(
                        [question.correct, ...question.distractors],
                        `${tabId}-${questionId}`
                    );
                    
                    let dropdownHTML = `<select class="content-dropdown" 
                                                data-tab="${tabId}"
                                                data-question="${questionId}"
                                                data-correct="${question.correct}">
                        <option value="">Select...</option>`;
                    
                    options.forEach(option => {
                        dropdownHTML += `<option value="${option}">${option}</option>`;
                    });
                    
                    dropdownHTML += `</select>`;
                    return dropdownHTML;
                });
            }
            
            shuffleOptions(options, seed) {
                // Use seed for consistent randomization
                const random = this.seededRandom(seed);
                const shuffled = [...options];
                
                for (let i = shuffled.length - 1; i > 0; i--) {
                    const j = Math.floor(random() * (i + 1));
                    [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
                }
                
                return shuffled;
            }
            
            seededRandom(seed) {
                let hash = 0;
                for (let i = 0; i < seed.length; i++) {
                    hash = ((hash << 5) - hash) + seed.charCodeAt(i);
                    hash = hash & hash;
                }
                
                return function() {
                    hash = (hash * 9301 + 49297) % 233280;
                    return hash / 233280;
                };
            }
            
            setupTabHandlers() {
                // Tab switching
                document.querySelectorAll('.tab-header').forEach(header => {
                    header.addEventListener('click', (e) => {
                        const tabId = e.currentTarget.dataset.tab;
                        this.switchTab(tabId);
                    });
                });
                
                // Dropdown change handlers
                document.querySelectorAll('.content-dropdown').forEach(dropdown => {
                    dropdown.addEventListener('change', (e) => {
                        this.handleDropdownChange(e.target);
                    });
                });
            }
            
            switchTab(tabId) {
                // Update headers
                document.querySelectorAll('.tab-header').forEach(header => {
                    header.classList.toggle('active', header.dataset.tab === tabId);
                });
                
                // Update panels
                document.querySelectorAll('.tab-panel').forEach(panel => {
                    panel.classList.toggle('active', panel.dataset.tab === tabId);
                });
                
                this.currentTab = tabId;
                this.updateProgress(tabId);
            }
            
            handleDropdownChange(dropdown) {
                const tabId = dropdown.dataset.tab;
                const questionId = dropdown.dataset.question;
                const value = dropdown.value;
                
                // Update visual state
                if (value) {
                    dropdown.classList.add('filled');
                } else {
                    dropdown.classList.remove('filled');
                }
                
                // Save selection
                const topicId = this.currentContent.metadata.topicId;
                this.stateManager.saveSelection(topicId, this.currentRound, tabId, questionId, value);
                
                // Update progress
                this.updateProgress(tabId);
            }
            
            updateProgress(tabId) {
                const dropdowns = document.querySelectorAll(`.content-dropdown[data-tab="${tabId}"]`);
                const filled = Array.from(dropdowns).filter(d => d.value).length;
                const total = dropdowns.length;
                
                const progressText = document.getElementById(`progress-${tabId}`);
                if (progressText) {
                    progressText.textContent = `${filled}/${total}`;
                }
                
                const submitBtn = document.getElementById(`submit-${tabId}`);
                if (submitBtn) {
                    submitBtn.disabled = filled < total;
                }
            }
            
            restoreSelections(state) {
                const roundKey = `round${this.currentRound}`;
                const selections = state.selections[roundKey] || {};
                
                Object.entries(selections).forEach(([tabId, questions]) => {
                    Object.entries(questions).forEach(([questionId, value]) => {
                        const dropdown = document.querySelector(
                            `.content-dropdown[data-tab="${tabId}"][data-question="${questionId}"]`
                        );
                        if (dropdown) {
                            dropdown.value = value;
                            if (value) dropdown.classList.add('filled');
                        }
                    });
                    
                    this.updateProgress(tabId);
                });
            }
            
            getCompletedRounds(state, tabId) {
                const completed = [];
                ['round1', 'round2', 'round3'].forEach((round, index) => {
                    if (state.tabsCompleted[round]?.includes(tabId)) {
                        completed.push(index + 1);
                    }
                });
                return completed;
            }
        }
        
        // ========================================
        // Topic Selector
        // ========================================
        class TopicSelector {
            constructor(stateManager) {
                this.stateManager = stateManager;
                this.contentManager = null;
                this.units = {};
                this.init();
            }
            
            setContentManager(contentManager) {
                this.contentManager = contentManager;
            }
            
            async init() {
                await this.loadTopicIndex();
                this.setupEventListeners();
                
                const lastTopic = this.stateManager.load(this.stateManager.getKey(null, 'currentTopic'));
                if (lastTopic) {
                    this.restoreSelection(lastTopic);
                }
            }
            
            async loadTopicIndex() {
                try {
                    const response = await fetch(`${BASE_URL}${TOPICS_INDEX}`);
                    if (!response.ok) {
                        throw new Error(`Failed to load topics index: ${response.status}`);
                    }
                    
                    const data = await response.json();
                    this.units = data.units || {};
                    this.populateUnits();
                    
                    // Hide loading message
                    const mainContent = document.getElementById('mainContent');
                    mainContent.innerHTML = `
                        <div class="loading-message">
                            <p>Select a topic to begin reviewing</p>
                        </div>
                    `;
                } catch (error) {
                    console.error('Failed to load topic index:', error);
                    this.showError('Failed to load topics. Please refresh the page.');
                }
            }
            
            populateUnits() {
                const unitSelect = document.getElementById('unitSelect');
                unitSelect.innerHTML = '<option value="">Select a unit...</option>';
                
                this.units.forEach(unit => {
                    const option = document.createElement('option');
                    option.value = unit.id;
                    option.textContent = unit.name;
                    unitSelect.appendChild(option);
                });
            }
            
            populateAreas(unitId) {
                const aosSelect = document.getElementById('aosSelect');
                const unit = this.units.find(u => u.id === unitId);
                
                if (!unit) {
                    aosSelect.innerHTML = '<option value="">Select unit first...</option>';
                    aosSelect.disabled = true;
                    return;
                }
                
                aosSelect.innerHTML = '<option value="">Select area of study...</option>';
                aosSelect.disabled = false;
                
                unit.areas.forEach(aos => {
                    const option = document.createElement('option');
                    option.value = aos.id;
                    option.textContent = aos.name;
                    aosSelect.appendChild(option);
                });
            }
            
            populateTopics(unitId, aosId) {
                const topicSelect = document.getElementById('topicSelect');
                const unit = this.units.find(u => u.id === unitId);
                
                if (!unit) {
                    topicSelect.innerHTML = '<option value="">Select area first...</option>';
                    topicSelect.disabled = true;
                    return;
                }
                
                const aos = unit.areas.find(a => a.id === aosId);
                if (!aos) {
                    topicSelect.innerHTML = '<option value="">Select area first...</option>';
                    topicSelect.disabled = true;
                    return;
                }
                
                topicSelect.innerHTML = '<option value="">Select topic...</option>';
                topicSelect.disabled = false;
                
                aos.topics.forEach(topic => {
                    const option = document.createElement('option');
                    option.value = topic.id;
                    option.dataset.filename = topic.filename;
                    option.textContent = topic.name;
                    
                    if (topic.available === false) {
                        option.disabled = true;
                        option.textContent += ' (Coming Soon)';
                    }
                    
                    topicSelect.appendChild(option);
                });
            }
            
            setupEventListeners() {
                const unitSelect = document.getElementById('unitSelect');
                const aosSelect = document.getElementById('aosSelect');
                const topicSelect = document.getElementById('topicSelect');
                const loadBtn = document.getElementById('loadTopicBtn');
                const changeBtn = document.getElementById('changeTopicBtn');
                
                unitSelect.addEventListener('change', (e) => {
                    this.populateAreas(e.target.value);
                    topicSelect.innerHTML = '<option value="">Select area first...</option>';
                    topicSelect.disabled = true;
                    loadBtn.disabled = true;
                });
                
                aosSelect.addEventListener('change', (e) => {
                    const unitId = unitSelect.value;
                    this.populateTopics(unitId, e.target.value);
                    loadBtn.disabled = true;
                });
                
                topicSelect.addEventListener('change', (e) => {
                    loadBtn.disabled = !e.target.value;
                });
                
                loadBtn.addEventListener('click', () => {
                    this.loadSelectedTopic();
                });
                
                changeBtn.addEventListener('click', () => {
                    this.showTopicSelector();
                });
            }
            
            async loadSelectedTopic() {
                const unitSelect = document.getElementById('unitSelect');
                const aosSelect = document.getElementById('aosSelect');
                const topicSelect = document.getElementById('topicSelect');
                
                const unitId = unitSelect.value;
                const aosId = aosSelect.value;
                const topicId = topicSelect.value;
                const filename = topicSelect.selectedOptions[0]?.dataset.filename;
                
                if (!unitId || !aosId || !topicId || !filename) {
                    this.showError('Please select a complete topic');
                    return;
                }
                
                const fullTopicId = `${unitId}-${aosId}-${topicId}`;
                
                this.hideTopicSelector();
                this.showLoadingState();
                
                try {
                    await this.contentManager.loadTopicContent(filename);
                    this.stateManager.saveTopicState(fullTopicId, { currentRound: 1 });
                    this.showTopicLoaded(fullTopicId);
                    this.contentManager.renderTabs();
                } catch (error) {
                    this.showError('Failed to load topic content. Please try again.');
                    this.showTopicSelector();
                }
            }
            
            restoreSelection(topicId) {
                const parts = topicId.split('-');
                if (parts.length !== 3) return;
                
                const [unitId, aosId, topicNum] = parts;
                
                document.getElementById('unitSelect').value = unitId;
                this.populateAreas(unitId);
                
                document.getElementById('aosSelect').value = aosId;
                this.populateTopics(unitId, aosId);
                
                document.getElementById('topicSelect').value = topicNum;
                document.getElementById('loadTopicBtn').disabled = false;
            }
            
            hideTopicSelector() {
                document.getElementById('unitSelect').disabled = true;
                document.getElementById('aosSelect').disabled = true;
                document.getElementById('topicSelect').disabled = true;
                document.getElementById('loadTopicBtn').style.display = 'none';
                document.getElementById('changeTopicBtn').style.display = 'inline-flex';
            }
            
            showTopicSelector() {
                document.getElementById('unitSelect').disabled = false;
                document.getElementById('aosSelect').disabled = false;
                document.getElementById('topicSelect').disabled = false;
                document.getElementById('loadTopicBtn').style.display = 'inline-flex';
                document.getElementById('changeTopicBtn').style.display = 'none';
                
                document.getElementById('mainContent').innerHTML = `
                    <div class="loading-message">
                        <p>Select a topic to begin reviewing</p>
                    </div>
                `;
                
                document.getElementById('statusBar').classList.add('hidden');
                document.getElementById('headerMiniStatus').style.display = 'none';
            }
            
            showLoadingState() {
                document.getElementById('mainContent').innerHTML = `
                    <div class="loading-message">
                        <div class="loading-spinner"></div>
                        <p>Loading topic content...</p>
                    </div>
                `;
            }
            
            showTopicLoaded(topicId) {
                const statusBar = document.getElementById('statusBar');
                statusBar.classList.remove('hidden');
                
                const state = this.stateManager.loadTopicState(topicId);
                
                document.getElementById('currentRoundText').textContent = `Round ${state.currentRound}`;
                
                const miniStatus = document.getElementById('headerMiniStatus');
                const miniTopicName = document.getElementById('miniTopicName');
                miniStatus.style.display = 'flex';
                miniTopicName.textContent = `${topicId} - Round ${state.currentRound}`;
                
                if (state.currentRound > 1 || state.tabsCompleted.round1.length > 0) {
                    const roundIndicator = document.getElementById('roundIndicator');
                    roundIndicator.style.display = 'inline-flex';
                    
                    roundIndicator.querySelectorAll('.round-badge').forEach((badge, index) => {
                        const round = index + 1;
                        badge.classList.remove('completed', 'current');
                        
                        if (round < state.currentRound) {
                            badge.classList.add('completed');
                        } else if (round === state.currentRound) {
                            badge.classList.add('current');
                        }
                    });
                }
                
                if (!state.startedDate) {
                    const now = new Date().toISOString();
                    this.stateManager.save(this.stateManager.getKey(topicId, 'startedDate'), now);
                    state.startedDate = now;
                }
                
                const startDate = new Date(state.startedDate);
                document.getElementById('startedDate').textContent = startDate.toLocaleDateString();
            }
            
            showError(message) {
                const mainContent = document.getElementById('mainContent');
                mainContent.innerHTML = `
                    <div class="loading-message">
                        <div class="error-message">⚠ ${message}</div>
                    </div>
                `;
            }
        }
        
        // ========================================
        // Initialize Application
        // ========================================
        document.addEventListener('DOMContentLoaded', () => {
            // Detect Mac for keyboard shortcuts
            if (navigator.platform.toUpperCase().indexOf('MAC') >= 0) {
                document.body.classList.add('mac');
            }
            
            const stateManager = new StateManager();
            const themeManager = new ThemeManager(stateManager);
            const headerCollapseManager = new HeaderCollapseManager(stateManager);
            const studentNameManager = new StudentNameManager(stateManager);
            const contentManager = new ContentManager(stateManager, themeManager);
            const topicSelector = new TopicSelector(stateManager);
            
            // Connect content manager to topic selector
            topicSelector.setContentManager(contentManager);
            
            // Debug mode handler (q+w+e)
            let debugKeys = { q: false, w: false, e: false };
            
            document.addEventListener('keydown', (e) => {
                if (e.key in debugKeys) {
                    debugKeys[e.key] = true;
                    
                    if (debugKeys.q && debugKeys.w && debugKeys.e) {
                        console.log('🔧 Debug mode activated!');
                        // Auto-fill correct answers
                        document.querySelectorAll('.content-dropdown').forEach(dropdown => {
                            dropdown.value = dropdown.dataset.correct;
                            dropdown.classList.add('filled');
                            dropdown.dispatchEvent(new Event('change'));
                        });
                        debugKeys = { q: false, w: false, e: false };
                    }
                }
            });
            
            document.addEventListener('keyup', (e) => {
                if (e.key in debugKeys) {
                    debugKeys[e.key] = false;
                }
            });
            
            // Global app reference for button handlers
            window.app = {
                resetCurrentTab: () => {
                    if (contentManager.currentTab) {
                        if (confirm('Reset all answers in this tab?')) {
                            const topicId = contentManager.currentContent?.metadata?.topicId;
                            if (topicId) {
                                stateManager.resetTab(topicId, contentManager.currentRound, contentManager.currentTab);
                                contentManager.renderTabs();
                            }
                        }
                    }
                }
            };
            
            // Expose for debugging
            window.appState = {
                stateManager,
                themeManager,
                headerCollapseManager,
                studentNameManager,
                contentManager,
                topicSelector
            };
        });
    </script>
</body>
</html>