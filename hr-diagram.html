<!DOCTYPE html>
<html lang="en" dir="ltr" data-version="1.0.0" data-theme="dark">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="description" content="Interactive Hertzsprung-Russell Diagram explorer for Year 10 Physics students. Explore stars, their properties, and stellar evolution.">
  <meta property="og:title" content="HR Diagram Explorer">
  <meta property="og:description" content="Interactive Hertzsprung-Russell Diagram for exploring stars and stellar evolution.">
  <meta property="og:type" content="website">
  <title>HR Diagram Explorer</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>&#11088;</text></svg>">
  <style>
    /* ========================================
       SECTION 1: CSS RESET & CUSTOM PROPERTIES
       ======================================== */

    /* 1.1 Modern CSS reset */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    /* 1.2 Theme custom properties */
    :root {
      --color-bg-primary: #0a0e1a;
      --color-bg-secondary: #141a2e;
      --color-bg-panel: #1a2038;
      --color-bg-surface: #222842;
      --color-bg-hover: #2a3052;
      --color-text-primary: #e8ecf4;
      --color-text-secondary: #8892aa;
      --color-text-muted: #556078;
      --color-accent: #4a9eff;
      --color-accent-hover: #6fb3ff;
      --color-accent-dim: rgba(74, 158, 255, 0.15);
      --color-warning: #f5a623;
      --color-error: #ff5252;
      --color-success: #4caf50;
      --color-border: rgba(255, 255, 255, 0.08);
      --color-border-active: rgba(74, 158, 255, 0.4);

      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 24px;
      --space-6: 32px;
      --space-7: 48px;
      --space-8: 64px;

      --font-family: 'Segoe UI', system-ui, -apple-system, sans-serif;
      --font-mono: 'SF Mono', 'Cascadia Code', 'Consolas', monospace;
      --font-size-xs: clamp(0.65rem, 1.5vw, 0.75rem);
      --font-size-sm: clamp(0.75rem, 1.8vw, 0.875rem);
      --font-size-md: clamp(0.875rem, 2vw, 1rem);
      --font-size-lg: clamp(1rem, 2.5vw, 1.25rem);
      --font-size-xl: clamp(1.25rem, 3vw, 1.5rem);

      --transition-fast: 150ms ease;
      --transition-normal: 250ms ease;
      --transition-slow: 400ms ease;

      --shadow-panel: 0 4px 24px rgba(0, 0, 0, 0.4);
      --shadow-button: 0 2px 8px rgba(0, 0, 0, 0.3);

      --radius-sm: 4px;
      --radius-md: 8px;
      --radius-lg: 16px;

      --header-height: 52px;
      --toolbar-height: 110px;
    }

    /* 1.3 Light theme overrides */
    [data-theme="light"] {
      --color-bg-primary: #f0f2f8;
      --color-bg-secondary: #ffffff;
      --color-bg-panel: #ffffff;
      --color-bg-surface: #e8ecf4;
      --color-bg-hover: #dde2ee;
      --color-text-primary: #1a1e2e;
      --color-text-secondary: #555e78;
      --color-text-muted: #8892aa;
      --color-border: rgba(0, 0, 0, 0.1);
      --color-border-active: rgba(74, 158, 255, 0.5);
      --shadow-panel: 0 4px 24px rgba(0, 0, 0, 0.1);
      --shadow-button: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    /* ========================================
       SECTION 2: LAYOUT & RESPONSIVE FOUNDATION
       ======================================== */

    html, body {
      height: 100%;
      overflow: hidden;
    }

    body {
      font-family: var(--font-family);
      font-size: var(--font-size-md);
      color: var(--color-text-primary);
      background: var(--color-bg-primary);
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }

    /* Skip link */
    .skip-link {
      position: absolute;
      top: -100%;
      left: var(--space-4);
      background: var(--color-accent);
      color: #fff;
      padding: var(--space-2) var(--space-4);
      border-radius: var(--radius-sm);
      z-index: 1000;
      text-decoration: none;
      font-weight: 600;
    }
    .skip-link:focus {
      top: var(--space-2);
    }

    /* App shell */
    .app-shell {
      display: flex;
      flex-direction: column;
      height: 100dvh;
      height: 100vh;
    }

    /* 2.1 Header */
    .app-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      height: var(--header-height);
      padding: 0 var(--space-4);
      background: var(--color-bg-secondary);
      border-bottom: 1px solid var(--color-border);
      flex-shrink: 0;
      z-index: 10;
    }

    .app-title {
      font-size: var(--font-size-lg);
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: var(--space-2);
      white-space: nowrap;
    }
    .title-icon {
      font-size: 1.2em;
    }

    .header-controls {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }

    /* 2.2 Main content */
    .app-main {
      display: grid;
      grid-template-columns: 1fr clamp(260px, 25vw, 360px);
      flex: 1;
      min-height: 0;
      overflow: hidden;
    }

    /* 2.3 Canvas container */
    .canvas-container {
      position: relative;
      overflow: hidden;
      min-width: 0;
    }

    #hr-canvas {
      display: block;
      width: 100%;
      height: 100%;
      touch-action: none;
    }

    /* 2.4 Info panel */
    .info-panel {
      background: var(--color-bg-panel);
      border-left: 1px solid var(--color-border);
      display: flex;
      flex-direction: column;
      overflow: hidden;
      transition: transform var(--transition-normal);
    }

    .info-panel-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-4);
      border-bottom: 1px solid var(--color-border);
      flex-shrink: 0;
    }

    .info-panel-header h2 {
      font-size: var(--font-size-lg);
      font-weight: 600;
    }

    .info-panel-body {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-4);
    }

    .info-empty {
      color: var(--color-text-muted);
      text-align: center;
      padding: var(--space-7) var(--space-4);
      font-size: var(--font-size-sm);
    }

    .star-props {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }

    .star-prop {
      display: flex;
      flex-direction: column;
      gap: var(--space-1);
    }

    .star-prop-label {
      font-size: var(--font-size-xs);
      color: var(--color-text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .star-prop-value {
      font-size: var(--font-size-md);
      font-weight: 500;
    }

    .star-prop-compare {
      font-size: var(--font-size-xs);
      color: var(--color-text-muted);
      font-style: italic;
    }

    .star-name-display {
      font-size: var(--font-size-xl);
      font-weight: 700;
      margin-bottom: var(--space-2);
    }

    .star-stage-badge {
      display: inline-block;
      padding: var(--space-1) var(--space-3);
      background: var(--color-accent-dim);
      color: var(--color-accent);
      border-radius: var(--radius-lg);
      font-size: var(--font-size-xs);
      font-weight: 600;
      margin-bottom: var(--space-4);
    }

    .star-color-swatch {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      display: inline-block;
      vertical-align: middle;
      margin-right: var(--space-2);
      border: 1px solid var(--color-border);
    }

    /* 2.5 Bottom toolbar */
    .bottom-toolbar {
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-4);
      padding: var(--space-3) var(--space-4);
      background: var(--color-bg-secondary);
      border-top: 1px solid var(--color-border);
      flex-shrink: 0;
      flex-wrap: wrap;
      min-height: var(--toolbar-height);
    }

    .toolbar-group {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .toolbar-separator {
      width: 1px;
      height: 28px;
      background: var(--color-border);
      margin: 0 var(--space-2);
    }

    /* ========================================
       SECTION 3: COMPONENT STYLES
       ======================================== */

    /* 3.1 Buttons */
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-4);
      background: var(--color-bg-surface);
      color: var(--color-text-primary);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      font-family: inherit;
      font-size: var(--font-size-sm);
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition-fast);
      white-space: nowrap;
      min-height: 36px;
      -webkit-tap-highlight-color: transparent;
    }

    .btn:hover {
      background: var(--color-bg-hover);
      border-color: var(--color-border-active);
    }

    .btn:focus-visible {
      outline: 2px solid var(--color-accent);
      outline-offset: 2px;
    }

    .btn:active {
      transform: scale(0.97);
    }

    .btn[aria-pressed="true"],
    .btn.active {
      background: var(--color-accent-dim);
      border-color: var(--color-accent);
      color: var(--color-accent);
    }

    .btn-accent {
      background: var(--color-accent);
      color: #fff;
      border-color: var(--color-accent);
    }

    .btn-accent:hover {
      background: var(--color-accent-hover);
      border-color: var(--color-accent-hover);
    }

    /* 3.2 Icon button */
    .icon-btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 36px;
      height: 36px;
      padding: 0;
      background: transparent;
      color: var(--color-text-secondary);
      border: 1px solid transparent;
      border-radius: var(--radius-md);
      font-family: inherit;
      font-size: var(--font-size-md);
      cursor: pointer;
      transition: all var(--transition-fast);
      -webkit-tap-highlight-color: transparent;
    }

    .icon-btn:hover {
      background: var(--color-bg-hover);
      color: var(--color-text-primary);
    }

    .icon-btn:focus-visible {
      outline: 2px solid var(--color-accent);
      outline-offset: 2px;
    }

    /* 3.3 Language toggle */
    .lang-toggle {
      display: flex;
      background: var(--color-bg-surface);
      border-radius: var(--radius-md);
      border: 1px solid var(--color-border);
      overflow: hidden;
    }

    .lang-toggle button {
      padding: var(--space-1) var(--space-3);
      background: transparent;
      color: var(--color-text-secondary);
      border: none;
      font-family: inherit;
      font-size: var(--font-size-xs);
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition-fast);
    }

    .lang-toggle button[aria-checked="true"] {
      background: var(--color-accent);
      color: #fff;
    }

    .lang-toggle button:focus-visible {
      outline: 2px solid var(--color-accent);
      outline-offset: -2px;
    }

    /* 3.4 Timeline */
    .timeline-group {
      flex-direction: column;
      gap: var(--space-2);
      flex: 1;
      max-width: 500px;
    }

    .timeline-row {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      width: 100%;
    }

    .timeline-scrubber {
      flex: 1;
      height: 6px;
      -webkit-appearance: none;
      appearance: none;
      background: var(--color-bg-surface);
      border-radius: 3px;
      outline: none;
      opacity: 0.5;
      cursor: not-allowed;
    }

    .timeline-scrubber:not(:disabled) {
      opacity: 1;
      cursor: pointer;
    }

    .timeline-scrubber::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--color-accent);
      cursor: pointer;
      border: 2px solid var(--color-bg-panel);
      box-shadow: var(--shadow-button);
    }

    .timeline-scrubber::-moz-range-thumb {
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--color-accent);
      cursor: pointer;
      border: 2px solid var(--color-bg-panel);
      box-shadow: var(--shadow-button);
    }

    .timeline-label {
      font-size: var(--font-size-xs);
      color: var(--color-text-muted);
      white-space: nowrap;
      text-align: center;
      width: 100%;
      margin-top: calc(-1 * var(--space-1));
    }

    .timeline-mode-btns {
      display: flex;
      gap: var(--space-1);
    }

    .timeline-mode-btns .btn {
      font-size: var(--font-size-xs);
      padding: var(--space-1) var(--space-2);
      min-height: 28px;
    }

    /* 3.5 Toast notifications */
    .toast-container {
      position: fixed;
      top: calc(var(--header-height) + var(--space-3));
      right: var(--space-4);
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
      z-index: 100;
      pointer-events: none;
    }

    .toast {
      background: var(--color-bg-panel);
      color: var(--color-text-primary);
      padding: var(--space-3) var(--space-4);
      border-radius: var(--radius-md);
      border: 1px solid var(--color-border);
      box-shadow: var(--shadow-panel);
      font-size: var(--font-size-sm);
      pointer-events: auto;
      animation: toastIn 250ms ease forwards;
      max-width: 320px;
    }

    .toast.removing {
      animation: toastOut 200ms ease forwards;
    }

    @keyframes toastIn {
      from { opacity: 0; transform: translateX(40px); }
      to { opacity: 1; transform: translateX(0); }
    }

    @keyframes toastOut {
      from { opacity: 1; transform: translateX(0); }
      to { opacity: 0; transform: translateX(40px); }
    }

    /* 3.6 Drawers */
    .drawer {
      position: fixed;
      top: var(--header-height);
      bottom: 0;
      width: clamp(300px, 35vw, 420px);
      background: var(--color-bg-panel);
      z-index: 50;
      transform: translateX(100%);
      transition: transform var(--transition-normal);
      display: flex;
      flex-direction: column;
      box-shadow: var(--shadow-panel);
    }

    .drawer-right {
      right: 0;
    }

    .drawer-left {
      left: 0;
      transform: translateX(-100%);
    }

    .drawer[aria-hidden="false"] {
      transform: translateX(0);
    }

    .drawer-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-4);
      border-bottom: 1px solid var(--color-border);
    }

    .drawer-header h2 {
      font-size: var(--font-size-lg);
      font-weight: 600;
    }

    .drawer-body {
      flex: 1;
      overflow-y: auto;
      padding: var(--space-4);
    }

    .drawer-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.4);
      z-index: 49;
      opacity: 0;
      pointer-events: none;
      transition: opacity var(--transition-normal);
    }

    .drawer-backdrop.active {
      opacity: 1;
      pointer-events: auto;
    }

    /* 3.7 Help overlay */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(0, 0, 0, 0.7);
      z-index: 200;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0;
      pointer-events: none;
      transition: opacity var(--transition-normal);
    }

    .overlay[aria-hidden="false"] {
      opacity: 1;
      pointer-events: auto;
    }

    .overlay-content {
      background: var(--color-bg-panel);
      border-radius: var(--radius-lg);
      padding: var(--space-6);
      max-width: 560px;
      width: calc(100% - var(--space-8));
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: var(--shadow-panel);
    }

    .overlay-content h2 {
      font-size: var(--font-size-xl);
      margin-bottom: var(--space-4);
    }

    .overlay-content p {
      color: var(--color-text-secondary);
      margin-bottom: var(--space-3);
      font-size: var(--font-size-sm);
    }

    .overlay-close {
      margin-top: var(--space-5);
      width: 100%;
    }

    /* 3.8 Custom star creation */
    .custom-mode-tabs {
      display: flex;
      gap: var(--space-2);
      margin-bottom: var(--space-4);
    }
    .custom-mode-tabs .btn {
      flex: 1;
    }

    .template-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: var(--space-2);
    }

    .template-card {
      background: var(--color-bg-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: var(--space-3);
      cursor: pointer;
      transition: all var(--transition-fast);
      text-align: center;
    }

    .template-card:hover {
      border-color: var(--color-accent);
      background: var(--color-bg-hover);
    }

    .template-card.selected {
      border-color: var(--color-accent);
      background: var(--color-accent-dim);
    }

    .template-card-icon {
      font-size: 24px;
      margin-bottom: var(--space-1);
    }

    .template-card-name {
      font-size: var(--font-size-sm);
      font-weight: 600;
    }

    .template-card-desc {
      font-size: var(--font-size-xs);
      color: var(--color-text-muted);
      margin-top: var(--space-1);
    }

    .custom-field {
      margin-bottom: var(--space-3);
    }

    .custom-field label {
      display: block;
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
      margin-bottom: var(--space-1);
    }

    .custom-input {
      width: 100%;
      padding: var(--space-2) var(--space-3);
      background: var(--color-bg-surface);
      color: var(--color-text-primary);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-sm);
      font-family: inherit;
      font-size: var(--font-size-sm);
      outline: none;
      transition: border-color var(--transition-fast);
    }

    .custom-input:focus {
      border-color: var(--color-accent);
    }

    .custom-slider {
      width: 100%;
      height: 6px;
      -webkit-appearance: none;
      appearance: none;
      background: var(--color-bg-surface);
      border-radius: 3px;
      outline: none;
    }

    .custom-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--color-accent);
      cursor: pointer;
      border: 2px solid var(--color-bg-panel);
    }

    .custom-slider::-moz-range-thumb {
      width: 16px;
      height: 16px;
      border-radius: 50%;
      background: var(--color-accent);
      cursor: pointer;
      border: 2px solid var(--color-bg-panel);
    }

    .validation-msg {
      font-size: var(--font-size-xs);
      padding: var(--space-2) var(--space-3);
      border-radius: var(--radius-sm);
      margin-top: var(--space-2);
      display: none;
    }

    .validation-msg.info {
      display: block;
      background: var(--color-accent-dim);
      color: var(--color-accent);
    }

    .validation-msg.warning {
      display: block;
      background: rgba(245, 166, 35, 0.1);
      color: var(--color-warning);
    }

    .computed-props {
      font-size: var(--font-size-xs);
      color: var(--color-text-muted);
      margin-top: var(--space-2);
    }

    .custom-star-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-2) var(--space-3);
      background: var(--color-bg-surface);
      border-radius: var(--radius-sm);
      margin-bottom: var(--space-1);
    }

    .custom-star-item-name {
      font-size: var(--font-size-sm);
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }

    .custom-star-delete {
      background: none;
      border: none;
      color: var(--color-text-muted);
      cursor: pointer;
      font-size: var(--font-size-sm);
      padding: var(--space-1);
      border-radius: var(--radius-sm);
      transition: all var(--transition-fast);
    }

    .custom-star-delete:hover {
      color: var(--color-error);
      background: rgba(255, 82, 82, 0.1);
    }

    .custom-star-delete.confirm {
      color: var(--color-error);
      font-weight: 600;
    }

    /* ========================================
       SECTION 4: ANIMATION & TRANSITIONS
       ======================================== */

    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* ========================================
       SECTION 5: UTILITY CLASSES
       ======================================== */

    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border: 0;
    }

    .visually-hidden {
      position: absolute;
      width: 1px;
      height: 1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
    }

    /* ========================================
       SECTION 5b: RESPONSIVE BREAKPOINTS
       ======================================== */

    @media (max-width: 768px) {
      .app-main {
        grid-template-columns: 1fr;
      }

      .info-panel {
        position: fixed;
        bottom: 0;
        left: 0;
        right: 0;
        top: auto;
        max-height: 45vh;
        border-left: none;
        border-top: 1px solid var(--color-border);
        border-radius: var(--radius-lg) var(--radius-lg) 0 0;
        transform: translateY(calc(100% - 44px));
        transition: transform var(--transition-normal);
        z-index: 20;
      }

      .info-panel.expanded {
        transform: translateY(0);
      }

      .info-panel-header {
        cursor: pointer;
      }

      .bottom-toolbar {
        padding: var(--space-2) var(--space-3);
        gap: var(--space-2);
        min-height: auto;
        --toolbar-height: 80px;
      }

      .btn {
        font-size: var(--font-size-xs);
        padding: var(--space-1) var(--space-3);
        min-height: 32px;
      }

      .timeline-group {
        max-width: none;
      }

      .app-title span:not(.title-icon) {
        font-size: var(--font-size-md);
      }
    }

    @media (max-width: 480px) {
      .header-controls {
        gap: var(--space-1);
      }

      .toolbar-group {
        flex-wrap: wrap;
        justify-content: center;
      }
    }

    /* ========================================
       SECTION 5c: PRINT
       ======================================== */

    @media print {
      .app-header,
      .bottom-toolbar,
      .info-panel,
      .drawer,
      .toast-container,
      .overlay {
        display: none !important;
      }

      body {
        background: #fff;
        color: #000;
      }

      .canvas-container {
        width: 100%;
        height: auto;
      }
    }
  </style>
</head>
<body>
  <!-- ========================================
       SECTION 6: HTML STRUCTURE
       ======================================== -->

  <a href="#main-content" class="skip-link">Skip to main content</a>

  <div class="app-shell">
    <!-- Header -->
    <header class="app-header" role="banner">
      <h1 class="app-title">
        <span class="title-icon" aria-hidden="true">&#9733;</span>
        <span id="app-title-text">HR Diagram Explorer</span>
      </h1>
      <div class="header-controls">
        <div class="lang-toggle" role="radiogroup" aria-label="Language mode">
          <button role="radio" aria-checked="false" data-lang="technical" id="lang-technical">Technical</button>
          <button role="radio" aria-checked="true" data-lang="simple" id="lang-simple">Simple</button>
        </div>
        <button class="icon-btn" id="theme-toggle" aria-label="Switch to light theme" title="Toggle theme">
          <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
        </button>
        <button class="icon-btn" id="help-btn" aria-label="Help and keyboard shortcuts" title="Help (?)">?</button>
      </div>
    </header>

    <!-- Main content -->
    <main id="main-content" class="app-main">
      <!-- Canvas -->
      <div class="canvas-container" id="canvas-container">
        <canvas id="hr-canvas" aria-label="Hertzsprung-Russell diagram interactive canvas" role="img"></canvas>
        <div class="sr-only" role="list" aria-label="Stars on diagram" id="star-list-sr"></div>
      </div>

      <!-- Info panel -->
      <aside class="info-panel" id="info-panel" aria-label="Star information">
        <div class="info-panel-header" id="info-panel-toggle">
          <h2 id="info-panel-title">Select a star</h2>
          <button class="icon-btn" id="info-panel-close" aria-label="Close info panel">
            <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
          </button>
        </div>
        <div class="info-panel-body" id="info-panel-body">
          <p class="info-empty" id="info-empty-msg">Click on a star in the diagram to see its properties</p>
        </div>
      </aside>
    </main>

    <!-- Bottom toolbar -->
    <nav class="bottom-toolbar" role="toolbar" aria-label="Diagram controls">
      <div class="toolbar-group" role="group" aria-label="View controls">
        <button class="btn active" id="btn-sky-view" aria-pressed="true">Sky View</button>
        <button class="btn" id="btn-sort-brightness" aria-pressed="false">Sort by Brightness</button>
        <button class="btn" id="btn-sort-colour" aria-pressed="false">Sort by Colour</button>
        <button class="btn" id="btn-show-hr" aria-pressed="false">Show HR Diagram</button>
      </div>

      <div class="toolbar-separator" aria-hidden="true"></div>

      <div class="toolbar-group timeline-group" role="group" aria-label="Timeline controls">
        <div class="timeline-row">
          <input type="range" class="timeline-scrubber" id="timeline-scrubber"
                 min="0" max="1000" value="500" step="1"
                 aria-label="Star evolution timeline" disabled>
          <div class="timeline-mode-btns">
            <button class="btn btn-sm" id="btn-single-mode" aria-pressed="false">Single</button>
            <button class="btn btn-sm" id="btn-cosmic-mode" aria-pressed="false">Cosmic</button>
            <button class="btn btn-sm" id="btn-time-scale" aria-pressed="false" title="Toggle between linear and logarithmic time scale">Log</button>
          </div>
        </div>
        <span class="timeline-label" id="timeline-stage-label">Select a star for timeline</span>
      </div>

      <div class="toolbar-separator" aria-hidden="true"></div>

      <button class="btn btn-accent" id="btn-create-star">+ Create Star</button>
    </nav>
  </div>

  <!-- Custom star drawer -->
  <div class="drawer drawer-right" id="custom-star-drawer" aria-hidden="true" role="dialog" aria-label="Create a custom star">
    <div class="drawer-header">
      <h2 id="drawer-title-custom">Create a Star</h2>
      <button class="icon-btn" id="drawer-close-custom" aria-label="Close">
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
      </button>
    </div>
    <div class="drawer-body" id="custom-star-body">
      <!-- Mode tabs -->
      <div class="custom-mode-tabs" role="tablist" aria-label="Creation mode">
        <button class="btn active" role="tab" id="tab-guided" aria-selected="true" aria-controls="panel-guided">Guided</button>
        <button class="btn" role="tab" id="tab-expert" aria-selected="false" aria-controls="panel-expert">Expert</button>
      </div>

      <!-- Guided panel -->
      <div id="panel-guided" role="tabpanel" aria-labelledby="tab-guided">
        <p style="color:var(--color-text-secondary);font-size:var(--font-size-sm);margin-bottom:var(--space-4)">Choose a star type, then fine-tune:</p>
        <div class="template-grid" id="template-grid">
          <!-- Templates populated by JS -->
        </div>
        <div id="guided-sliders" style="display:none;margin-top:var(--space-4)">
          <div class="custom-field">
            <label for="guided-name">Star name</label>
            <input type="text" id="guided-name" class="custom-input" maxlength="30" placeholder="My Star">
          </div>
          <div class="custom-field">
            <label for="guided-temp">Temperature: <span id="guided-temp-val"></span></label>
            <input type="range" id="guided-temp" class="custom-slider" min="0" max="1000" step="1">
          </div>
          <div class="custom-field">
            <label for="guided-lum">Brightness: <span id="guided-lum-val"></span></label>
            <input type="range" id="guided-lum" class="custom-slider" min="0" max="1000" step="1">
          </div>
          <div class="custom-field">
            <label for="guided-mass">Mass: <span id="guided-mass-val"></span></label>
            <input type="range" id="guided-mass" class="custom-slider" min="0" max="1000" step="1">
          </div>
          <div id="guided-validation" class="validation-msg"></div>
          <button class="btn btn-accent" id="guided-create" style="width:100%;margin-top:var(--space-3)">Add to Diagram</button>
        </div>
      </div>

      <!-- Expert panel -->
      <div id="panel-expert" role="tabpanel" aria-labelledby="tab-expert" style="display:none">
        <p style="color:var(--color-text-secondary);font-size:var(--font-size-sm);margin-bottom:var(--space-4)">Set any values. The app will check if they make physical sense.</p>
        <div class="custom-field">
          <label for="expert-name">Star name</label>
          <input type="text" id="expert-name" class="custom-input" maxlength="30" placeholder="My Star">
        </div>
        <div class="custom-field">
          <label for="expert-temp">Temperature (K): <span id="expert-temp-val">5778</span></label>
          <input type="range" id="expert-temp" class="custom-slider" min="0" max="1000" step="1" value="400">
        </div>
        <div class="custom-field">
          <label for="expert-lum">Luminosity (L&#x2609;): <span id="expert-lum-val">1.0</span></label>
          <input type="range" id="expert-lum" class="custom-slider" min="0" max="1000" step="1" value="455">
        </div>
        <div class="custom-field">
          <label for="expert-mass">Mass (M&#x2609;): <span id="expert-mass-val">1.0</span></label>
          <input type="range" id="expert-mass" class="custom-slider" min="0" max="1000" step="1" value="400">
        </div>
        <div id="expert-validation" class="validation-msg"></div>
        <div id="expert-computed" class="computed-props"></div>
        <button class="btn btn-accent" id="expert-create" style="width:100%;margin-top:var(--space-3)">Add to Diagram</button>
      </div>

      <!-- Custom stars list -->
      <div id="custom-stars-list" style="margin-top:var(--space-5)">
        <h3 style="font-size:var(--font-size-sm);color:var(--color-text-secondary);margin-bottom:var(--space-2)">Your Stars</h3>
        <div id="custom-stars-items"></div>
      </div>
    </div>
  </div>
  <div class="drawer-backdrop" id="drawer-backdrop"></div>

  <!-- Help overlay -->
  <div class="overlay" id="help-overlay" aria-hidden="true" role="dialog" aria-label="Help">
    <div class="overlay-content">
      <h2>HR Diagram Explorer</h2>
      <p>The Hertzsprung-Russell diagram shows the relationship between a star's temperature (colour) and brightness (luminosity).</p>
      <p><strong>Sky View:</strong> Stars are scattered like a real night sky. Use the sort buttons to arrange them into an HR diagram.</p>
      <p><strong>Sort by Brightness:</strong> Watch stars arrange by how bright they are.</p>
      <p><strong>Sort by Colour:</strong> Watch stars arrange by their temperature/colour.</p>
      <p><strong>Timeline:</strong> Select a star and use the timeline slider to see how it evolves over its lifetime.</p>
      <p><strong>Language Toggle:</strong> Switch between technical astronomy terms and simple descriptions.</p>
      <button class="btn btn-accent overlay-close" id="help-close">Got it!</button>
    </div>
  </div>

  <!-- Toast container -->
  <div class="toast-container" id="toast-container" aria-live="polite" aria-relevant="additions"></div>

  <!-- ARIA live region -->
  <div id="aria-announcer" class="sr-only" aria-live="polite" aria-atomic="true"></div>

  <script>
    'use strict';

    /* ========================================
       SECTION 7: DATA LAYER
       ======================================== */

    // 7.1 Star database
    const STAR_DATA = [
      {
        id: 'sun', name: 'Sun',
        temperature: 5778, luminosity: 1.0, mass: 1.0, radius: 1.0,
        spectralType: 'G2V', stage: 'main-sequence',
        expectedLifetime: 10e9, currentAge: 4.6e9,
        color: { r: 255, g: 244, b: 234 },
        description: { technical: 'A G-type main-sequence star at the centre of the Solar System.', simple: 'Our star! A medium-sized yellow star in the middle of its life.' }
      },
      {
        id: 'sirius-a', name: 'Sirius A',
        temperature: 9940, luminosity: 25.4, mass: 2.06, radius: 1.71,
        spectralType: 'A1V', stage: 'main-sequence',
        expectedLifetime: 1.0e9, currentAge: 0.24e9,
        color: { r: 202, g: 215, b: 255 },
        description: { technical: 'The brightest star in the night sky. An A-type main-sequence star in Canis Major.', simple: 'The brightest star we can see at night! A hot white-blue star.' }
      },
      {
        id: 'sirius-b', name: 'Sirius B',
        temperature: 25200, luminosity: 0.056, mass: 0.98, radius: 0.008,
        spectralType: 'DA2', stage: 'white-dwarf',
        expectedLifetime: null, currentAge: null,
        color: { r: 180, g: 200, b: 255 },
        description: { technical: 'A white dwarf companion to Sirius A. One of the most massive known white dwarfs.', simple: 'A tiny but very hot dead star orbiting Sirius A. About the size of Earth but as heavy as the Sun!' }
      },
      {
        id: 'betelgeuse', name: 'Betelgeuse',
        temperature: 3600, luminosity: 126000, mass: 11.6, radius: 887,
        spectralType: 'M1Ia', stage: 'red-supergiant',
        expectedLifetime: 10e6, currentAge: 8e6,
        color: { r: 255, g: 135, b: 80 },
        description: { technical: 'A red supergiant in Orion nearing the end of its life. Will likely explode as a supernova.', simple: 'A massive red star in Orion that could explode at any time! If it replaced our Sun, it would swallow Mars.' }
      },
      {
        id: 'rigel', name: 'Rigel',
        temperature: 12100, luminosity: 120000, mass: 21, radius: 78.9,
        spectralType: 'B8Ia', stage: 'blue-supergiant',
        expectedLifetime: 8e6, currentAge: 7e6,
        color: { r: 170, g: 200, b: 255 },
        description: { technical: 'A blue supergiant in Orion. One of the most luminous stars visible to the naked eye.', simple: 'A huge blazing blue-white star in Orion. It shines 120,000 times brighter than our Sun!' }
      },
      {
        id: 'proxima-centauri', name: 'Proxima Centauri',
        temperature: 3042, luminosity: 0.0017, mass: 0.12, radius: 0.15,
        spectralType: 'M5.5Ve', stage: 'main-sequence',
        expectedLifetime: 4000e9, currentAge: 4.85e9,
        color: { r: 255, g: 120, b: 80 },
        description: { technical: 'The closest star to the Sun. A red dwarf in the Alpha Centauri system with confirmed exoplanets.', simple: 'The nearest star to us (besides the Sun)! A tiny dim red star with planets orbiting it.' }
      },
      {
        id: 'polaris', name: 'Polaris',
        temperature: 6015, luminosity: 1260, mass: 5.4, radius: 37.5,
        spectralType: 'F7Ib', stage: 'cepheid-variable',
        expectedLifetime: 50e6, currentAge: 45e6,
        color: { r: 255, g: 245, b: 220 },
        description: { technical: 'A Cepheid variable supergiant, currently the North Star. Its brightness pulsates regularly.', simple: 'The North Star! It actually pulses brighter and dimmer over a few days. Much bigger and brighter than our Sun.' }
      },
      {
        id: 'vega', name: 'Vega',
        temperature: 9602, luminosity: 40.1, mass: 2.14, radius: 2.36,
        spectralType: 'A0Va', stage: 'main-sequence',
        expectedLifetime: 1.0e9, currentAge: 0.455e9,
        color: { r: 200, g: 216, b: 255 },
        description: { technical: 'An A-type main-sequence star in Lyra. One of the brightest stars in the sky and a former pole star.', simple: 'A bright blue-white star that used to be the North Star thousands of years ago!' }
      },
      {
        id: 'aldebaran', name: 'Aldebaran',
        temperature: 3910, luminosity: 439, mass: 1.16, radius: 44.1,
        spectralType: 'K5III', stage: 'red-giant',
        expectedLifetime: 9e9, currentAge: 6.6e9,
        color: { r: 255, g: 161, b: 90 },
        description: { technical: 'A K-type red giant in Taurus. The brightest star in the constellation, nearing the end of its giant branch phase.', simple: 'The orange "eye of the bull" in the constellation Taurus. A star like our Sun that has swollen up into a giant.' }
      },
      {
        id: 'antares', name: 'Antares',
        temperature: 3660, luminosity: 75900, mass: 12, radius: 680,
        spectralType: 'M1Ib', stage: 'red-supergiant',
        expectedLifetime: 12e6, currentAge: 11e6,
        color: { r: 255, g: 130, b: 75 },
        description: { technical: 'A red supergiant in Scorpius. Its name means "rival of Mars" due to its reddish colour.', simple: 'A massive red star called "the rival of Mars" because it looks reddish like the planet. Incredibly huge!' }
      },
      {
        id: 'arcturus', name: 'Arcturus',
        temperature: 4286, luminosity: 170, mass: 1.08, radius: 25.4,
        spectralType: 'K1.5III', stage: 'red-giant',
        expectedLifetime: 8e9, currentAge: 7.1e9,
        color: { r: 255, g: 180, b: 110 },
        description: { technical: 'A K-type red giant in Bootes. The brightest star in the northern celestial hemisphere.', simple: 'The brightest star in the northern sky! An old orange giant star, much bigger than our Sun.' }
      },
      {
        id: 'canopus', name: 'Canopus',
        temperature: 7400, luminosity: 10700, mass: 8.0, radius: 71,
        spectralType: 'A9II', stage: 'bright-giant',
        expectedLifetime: 25e6, currentAge: 22e6,
        color: { r: 240, g: 240, b: 255 },
        description: { technical: 'A bright giant star, the second brightest in the night sky. Located in the constellation Carina.', simple: 'The second brightest star in the night sky! A huge white star visible mainly from the southern hemisphere.' }
      },
      {
        id: 'deneb', name: 'Deneb',
        temperature: 8525, luminosity: 196000, mass: 19, radius: 203,
        spectralType: 'A2Ia', stage: 'white-supergiant',
        expectedLifetime: 10e6, currentAge: 9e6,
        color: { r: 220, g: 228, b: 255 },
        description: { technical: 'A white supergiant in Cygnus and one of the most luminous stars known. Part of the Summer Triangle asterism.', simple: 'One of the brightest stars we know of! So bright you can see it easily even though it is very far away.' }
      },
      {
        id: 'procyon-a', name: 'Procyon A',
        temperature: 6530, luminosity: 6.93, mass: 1.50, radius: 2.05,
        spectralType: 'F5IV-V', stage: 'subgiant',
        expectedLifetime: 3e9, currentAge: 1.87e9,
        color: { r: 255, g: 248, b: 230 },
        description: { technical: 'An F-type subgiant in Canis Minor, transitioning off the main sequence. Has a white dwarf companion.', simple: 'A yellowish-white star that is starting to swell up as it ages. Slightly bigger and brighter than our Sun.' }
      },
      {
        id: 'procyon-b', name: 'Procyon B',
        temperature: 7740, luminosity: 0.00055, mass: 0.60, radius: 0.012,
        spectralType: 'DQZ', stage: 'white-dwarf',
        expectedLifetime: null, currentAge: null,
        color: { r: 220, g: 230, b: 255 },
        description: { technical: 'A white dwarf companion to Procyon A. A faint, dense stellar remnant.', simple: 'A tiny dead star orbiting Procyon A. Incredibly dense -- a teaspoon of it would weigh tonnes!' }
      },
      {
        id: 'alpha-centauri-a', name: 'Alpha Centauri A',
        temperature: 5790, luminosity: 1.52, mass: 1.10, radius: 1.22,
        spectralType: 'G2V', stage: 'main-sequence',
        expectedLifetime: 9e9, currentAge: 5.3e9,
        color: { r: 255, g: 244, b: 234 },
        description: { technical: 'A G-type main-sequence star, very similar to the Sun. Part of the closest star system to Earth.', simple: 'A star very similar to our Sun in the nearest star system to us! Almost a twin of the Sun.' }
      },
      {
        id: 'alpha-centauri-b', name: 'Alpha Centauri B',
        temperature: 5260, luminosity: 0.50, mass: 0.91, radius: 0.86,
        spectralType: 'K1V', stage: 'main-sequence',
        expectedLifetime: 15e9, currentAge: 5.3e9,
        color: { r: 255, g: 220, b: 180 },
        description: { technical: 'A K-type main-sequence star, companion to Alpha Centauri A. Slightly cooler and smaller than the Sun.', simple: 'The partner star to Alpha Centauri A. A bit smaller and cooler than our Sun, with an orange tint.' }
      },
      {
        id: 'barnards-star', name: "Barnard's Star",
        temperature: 3134, luminosity: 0.0035, mass: 0.14, radius: 0.18,
        spectralType: 'M4Ve', stage: 'main-sequence',
        expectedLifetime: 2500e9, currentAge: 10e9,
        color: { r: 255, g: 140, b: 90 },
        description: { technical: 'An M-type red dwarf in Ophiuchus. The fastest-moving star across the sky relative to the Sun.', simple: 'A tiny dim red star that is the fastest-moving star in our sky! Very old but will live for trillions of years.' }
      },
      {
        id: 'wolf-359', name: 'Wolf 359',
        temperature: 2800, luminosity: 0.0014, mass: 0.09, radius: 0.16,
        spectralType: 'M6.5Ve', stage: 'main-sequence',
        expectedLifetime: 5000e9, currentAge: null,
        color: { r: 255, g: 120, b: 80 },
        description: { technical: 'One of the faintest and lowest-mass stars known. An M-type red dwarf very near the Sun.', simple: 'One of the dimmest stars we know of! So faint you need a telescope to see it, even though it is nearby.' }
      },
      {
        id: 'spica', name: 'Spica',
        temperature: 25300, luminosity: 12100, mass: 11.4, radius: 7.47,
        spectralType: 'B1III-IV', stage: 'main-sequence',
        expectedLifetime: 16e6, currentAge: 12.5e6,
        color: { r: 155, g: 176, b: 255 },
        description: { technical: 'A B-type giant/subgiant binary system in Virgo. One of the brightest and hottest stars visible.', simple: 'A blazing blue star in Virgo, incredibly hot at over 25,000 degrees! Much bigger and brighter than the Sun.' }
      },
      {
        id: 'regulus', name: 'Regulus',
        temperature: 12460, luminosity: 288, mass: 3.8, radius: 3.09,
        spectralType: 'B7V', stage: 'main-sequence',
        expectedLifetime: 150e6, currentAge: null,
        color: { r: 175, g: 195, b: 255 },
        description: { technical: 'A B-type main-sequence star in Leo. Spins so fast it is noticeably oblate.', simple: 'The heart of the lion constellation Leo! This blue-white star spins so fast it bulges at the equator.' }
      },
      {
        id: 'altair', name: 'Altair',
        temperature: 7670, luminosity: 10.6, mass: 1.79, radius: 1.63,
        spectralType: 'A7V', stage: 'main-sequence',
        expectedLifetime: 2e9, currentAge: 1.0e9,
        color: { r: 230, g: 235, b: 255 },
        description: { technical: 'An A-type main-sequence star in Aquila. Part of the Summer Triangle. Rapid rotator.', simple: 'A bright white star in the Summer Triangle. It spins really fast -- one full spin every 9 hours!' }
      },
      {
        id: 'fomalhaut', name: 'Fomalhaut',
        temperature: 8590, luminosity: 16.6, mass: 1.92, radius: 1.84,
        spectralType: 'A3V', stage: 'main-sequence',
        expectedLifetime: 1.5e9, currentAge: 0.44e9,
        color: { r: 215, g: 225, b: 255 },
        description: { technical: 'An A-type main-sequence star in Piscis Austrinus. Known for its prominent debris disk.', simple: 'A bright white star surrounded by a ring of dust and debris -- a star system still forming planets!' }
      },
      {
        id: 'achernar', name: 'Achernar',
        temperature: 15000, luminosity: 3150, mass: 6.7, radius: 7.3,
        spectralType: 'B6Vep', stage: 'main-sequence',
        expectedLifetime: 40e6, currentAge: null,
        color: { r: 165, g: 185, b: 255 },
        description: { technical: 'A B-type main-sequence star in Eridanus. The flattest star known due to extreme rotation.', simple: 'The flattest star we know! It spins so incredibly fast that it is squished into an egg shape.' }
      },
      {
        id: '40-eridani-b', name: '40 Eridani B',
        temperature: 16500, luminosity: 0.013, mass: 0.50, radius: 0.014,
        spectralType: 'DA4', stage: 'white-dwarf',
        expectedLifetime: null, currentAge: null,
        color: { r: 180, g: 200, b: 255 },
        description: { technical: 'A white dwarf in the 40 Eridani system. The first white dwarf whose spectrum was observed.', simple: 'A famous tiny dead star -- the first white dwarf whose light was studied by scientists.' }
      },
      {
        id: 'van-maanens-star', name: "Van Maanen's Star",
        temperature: 6220, luminosity: 0.00017, mass: 0.68, radius: 0.011,
        spectralType: 'DZ8', stage: 'white-dwarf',
        expectedLifetime: null, currentAge: null,
        color: { r: 255, g: 240, b: 220 },
        description: { technical: 'The closest known solitary white dwarf to the Sun. A cool, metal-polluted white dwarf.', simple: 'The closest dead star to us that is on its own. Very small and slowly cooling down over billions of years.' }
      },
    ];

    // 7.2 HR Diagram region definitions (in log10 space)
    const HR_REGIONS = [
      {
        id: 'main-sequence',
        label: { technical: 'Main Sequence', simple: 'Normal Stars' },
        // Polygon path in [logT, logL] coordinates - diagonal band
        path: [
          [4.70, 6.0], [4.55, 5.0], [4.30, 3.5], [4.10, 2.0],
          [3.90, 0.5], [3.75, -0.5], [3.60, -1.5], [3.45, -3.0],
          // return path (wider band)
          [3.50, -2.0], [3.65, -0.5], [3.80, 0.5], [3.95, 1.2],
          [4.15, 2.8], [4.35, 4.2], [4.60, 5.5], [4.75, 6.5],
        ],
        fillColor: 'rgba(100, 150, 255, 0.06)',
        borderColor: 'rgba(100, 150, 255, 0.20)',
        labelPos: [4.15, 2.5],
      },
      {
        id: 'red-giants',
        label: { technical: 'Red Giants', simple: 'Big Red Stars' },
        path: [
          [3.80, 0.8], [3.70, 0.8], [3.50, 1.0], [3.45, 1.5],
          [3.45, 3.0], [3.50, 3.5], [3.65, 3.5], [3.80, 3.0],
          [3.85, 2.0],
        ],
        fillColor: 'rgba(255, 120, 80, 0.06)',
        borderColor: 'rgba(255, 120, 80, 0.20)',
        labelPos: [3.58, 2.0],
      },
      {
        id: 'supergiants',
        label: { technical: 'Supergiants', simple: 'Giant Stars' },
        path: [
          [4.70, 4.5], [4.50, 4.5], [4.20, 4.5], [3.90, 4.5],
          [3.60, 4.5], [3.45, 4.5], [3.45, 5.8], [3.60, 5.8],
          [3.90, 5.5], [4.20, 5.5], [4.50, 5.5], [4.70, 5.5],
        ],
        fillColor: 'rgba(255, 200, 100, 0.05)',
        borderColor: 'rgba(255, 200, 100, 0.18)',
        labelPos: [4.00, 5.0],
      },
      {
        id: 'white-dwarfs',
        label: { technical: 'White Dwarfs', simple: 'Tiny Hot Stars' },
        path: [
          [4.40, -1.0], [4.20, -1.5], [3.95, -2.0], [3.75, -2.5],
          [3.75, -4.5], [3.95, -4.5], [4.20, -4.0], [4.40, -3.5],
          [4.50, -2.5],
        ],
        fillColor: 'rgba(200, 220, 255, 0.06)',
        borderColor: 'rgba(200, 220, 255, 0.20)',
        labelPos: [4.10, -3.2],
      },
      {
        id: 'instability-strip',
        label: { technical: 'Instability Strip\n(Cepheids)', simple: 'Pulsing Stars' },
        path: [
          [3.90, 1.5], [3.85, 1.5], [3.78, 2.5], [3.75, 3.5],
          [3.78, 4.5], [3.83, 4.5], [3.88, 3.5], [3.90, 2.5],
        ],
        fillColor: 'rgba(180, 255, 180, 0.04)',
        borderColor: 'rgba(180, 255, 180, 0.18)',
        labelPos: [3.83, 3.5],
      },
    ];

    // 7.3 Language strings
    const LANG = {
      technical: {
        appTitle: 'Hertzsprung-Russell Diagram',
        axes: {
          xLabel: 'Effective Temperature (K)',
          yLabel: 'Luminosity (L\u2609)',
        },
        starInfo: {
          temperature: 'Effective Temperature',
          luminosity: 'Luminosity',
          mass: 'Mass',
          radius: 'Radius',
          spectralType: 'Spectral Type',
          stage: 'Evolutionary Stage',
          lifetime: 'Expected Lifetime',
          age: 'Current Age',
        },
        units: {
          temperature: 'K',
          luminosity: 'L\u2609',
          mass: 'M\u2609',
          radius: 'R\u2609',
          time: 'years',
        },
        stages: {
          'main-sequence': 'Main Sequence',
          'red-giant': 'Red Giant',
          'red-supergiant': 'Red Supergiant',
          'blue-supergiant': 'Blue Supergiant',
          'white-supergiant': 'White Supergiant',
          'white-dwarf': 'White Dwarf',
          'subgiant': 'Subgiant',
          'bright-giant': 'Bright Giant',
          'cepheid-variable': 'Cepheid Variable',
        },
        selectStar: 'Select a star',
        clickPrompt: 'Click on a star in the diagram to view its properties',
        skyView: 'Sky View',
        sortBrightness: 'Sort by Luminosity',
        sortColour: 'Sort by Temperature',
        showHR: 'Show HR Diagram',
        timelineSingle: 'Single Star',
        timelineCosmic: 'Cosmic View',
        timelinePrompt: 'Select a star for timeline',
        createStar: '+ Create Star',
      },
      simple: {
        appTitle: 'Star Explorer',
        axes: {
          xLabel: 'Star Colour (Hot \u2192 Cool)',
          yLabel: 'Brightness',
        },
        starInfo: {
          temperature: 'How hot it is',
          luminosity: 'How bright it is',
          mass: 'How heavy it is',
          radius: 'How big it is',
          spectralType: 'Star colour type',
          stage: 'Life stage',
          lifetime: 'How long it will live',
          age: 'How old it is now',
        },
        units: {
          temperature: '\u00b0',
          luminosity: '\u00d7 Sun',
          mass: '\u00d7 Sun',
          radius: '\u00d7 Sun',
          time: 'years',
        },
        stages: {
          'main-sequence': 'Normal adult star',
          'red-giant': 'Big puffy red star',
          'red-supergiant': 'Enormous red star (about to explode!)',
          'blue-supergiant': 'Blazing hot giant star',
          'white-supergiant': 'Huge bright star',
          'white-dwarf': 'Tiny dead star ember',
          'subgiant': 'Star starting to swell up',
          'bright-giant': 'Very big bright star',
          'cepheid-variable': 'Pulsing star (gets brighter and dimmer)',
        },
        selectStar: 'Pick a star!',
        clickPrompt: 'Tap a star to learn about it!',
        skyView: 'Night Sky',
        sortBrightness: 'Sort: Bright to Dim',
        sortColour: 'Sort: Hot to Cool',
        showHR: 'Show Diagram',
        timelineSingle: 'One Star',
        timelineCosmic: 'All Stars',
        timelinePrompt: 'Pick a star to see its life story',
        createStar: '+ Make a Star',
      },
    };

    // 7.4 Physical constants
    const PHYSICS = {
      T_MIN: 2200,
      T_MAX: 55000,
      L_MIN: 1e-5,
      L_MAX: 1e6,
      LOG_T_MIN: Math.log10(2200),
      LOG_T_MAX: Math.log10(55000),
      LOG_L_MIN: -5,
      LOG_L_MAX: 6,
    };

    // 7.5 Stellar evolution tracks
    // Each track is a sequence of keyframes: [temperature, luminosity, radius, durationFraction, stageName]
    // Tracks are matched to stars by mass range
    const EVOLUTION_TRACKS = [
      {
        id: 'low-mass',
        massRange: [0.08, 0.45],
        label: { technical: 'Low Mass Track', simple: 'Small Star Life' },
        totalLifetime: 4000e9, // ~4 trillion years
        stages: [
          { name: 'protostar', T: 2800, L: 0.1, R: 2.0, frac: 0.001,
            label: { technical: 'Protostar', simple: 'Baby star forming' },
            desc: { technical: 'Gravitational contraction of a small molecular cloud core.', simple: 'A tiny cloud of gas slowly squeezing together to form a star.' }},
          { name: 'main-sequence', T: 3000, L: 0.002, R: 0.15, frac: 0.995,
            label: { technical: 'Main Sequence (Red Dwarf)', simple: 'Long-lived little star' },
            desc: { technical: 'Hydrogen fusion at very low rates. These stars are fully convective, mixing all their fuel.', simple: 'This little star burns its fuel very slowly. It will shine for trillions of years -- longer than the universe has existed!' }},
          { name: 'helium-wd', T: 5000, L: 0.0001, R: 0.01, frac: 0.004,
            label: { technical: 'Helium White Dwarf', simple: 'Tiny cooling ember' },
            desc: { technical: 'After exhausting hydrogen, it slowly contracts to a helium white dwarf.', simple: 'When it finally runs out of fuel, it shrinks into a tiny hot ball that slowly cools forever.' }},
        ]
      },
      {
        id: 'sun-like',
        massRange: [0.45, 2.0],
        label: { technical: 'Solar-type Track', simple: 'Sun-like Star Life' },
        totalLifetime: 10e9,
        stages: [
          { name: 'protostar', T: 4000, L: 5, R: 4, frac: 0.005,
            label: { technical: 'Protostar', simple: 'Baby star forming' },
            desc: { technical: 'Gravitational collapse of a molecular cloud. The protostar is large and cool, still contracting.', simple: 'A big cloud of gas collapses under gravity. The baby star is puffy and not yet stable.' }},
          { name: 'main-sequence-early', T: 5600, L: 0.7, R: 0.9, frac: 0.05,
            label: { technical: 'Early Main Sequence', simple: 'Young adult star' },
            desc: { technical: 'Hydrogen fusion begins in the core. The star settles onto the zero-age main sequence.', simple: 'The star starts burning hydrogen fuel in its core and becomes stable. It is slightly cooler and dimmer than it will be later.' }},
          { name: 'main-sequence', T: 5778, L: 1.0, R: 1.0, frac: 0.80,
            label: { technical: 'Main Sequence', simple: 'Stable adult star' },
            desc: { technical: 'Core hydrogen burning. The star slowly increases in luminosity as helium accumulates in the core.', simple: 'The star is stable and shining steadily, just like our Sun is now. It spends most of its life in this stage.' }},
          { name: 'subgiant', T: 5200, L: 2.5, R: 2.0, frac: 0.04,
            label: { technical: 'Subgiant Branch', simple: 'Starting to swell' },
            desc: { technical: 'Core hydrogen exhausted. A hydrogen-burning shell forms around an inert helium core. The star expands.', simple: 'The star runs low on fuel in its centre and starts to puff up. It gets bigger and slightly redder.' }},
          { name: 'red-giant', T: 3800, L: 2000, R: 150, frac: 0.05,
            label: { technical: 'Red Giant Branch', simple: 'Big red puffy star' },
            desc: { technical: 'The star ascends the RGB. The inert helium core contracts while the envelope expands enormously.', simple: 'The star swells up to be enormous -- so big it would swallow Mercury! It turns red because the surface is cooler.' }},
          { name: 'helium-flash', T: 5000, L: 50, R: 10, frac: 0.005,
            label: { technical: 'Horizontal Branch', simple: 'Helium burning' },
            desc: { technical: 'Helium flash ignites helium fusion in the core. The star contracts and heats up.', simple: 'The core gets so hot it starts burning helium! The star shrinks back down a bit.' }},
          { name: 'agb', T: 3500, L: 5000, R: 200, frac: 0.02,
            label: { technical: 'Asymptotic Giant Branch', simple: 'Puffing up again' },
            desc: { technical: 'Double shell burning (H and He). The star expands again and undergoes thermal pulses.', simple: 'The star puffs up again, even bigger than before! It starts pulsing and blowing off gas.' }},
          { name: 'planetary-nebula', T: 100000, L: 3000, R: 0.05, frac: 0.005,
            label: { technical: 'Planetary Nebula', simple: 'Beautiful gas cloud' },
            desc: { technical: 'The outer envelope is ejected, revealing the hot core. UV radiation ionizes the expanding shell.', simple: 'The star blows off its outer layers, creating a beautiful glowing cloud of gas around the tiny hot core.' }},
          { name: 'white-dwarf', T: 30000, L: 0.01, R: 0.01, frac: 0.04,
            label: { technical: 'White Dwarf', simple: 'Tiny hot ember' },
            desc: { technical: 'The stellar remnant slowly cools. Supported by electron degeneracy pressure.', simple: 'All that is left is a tiny, incredibly dense ball about the size of Earth. It slowly cools down over billions of years.' }},
        ]
      },
      {
        id: 'intermediate',
        massRange: [2.0, 8.0],
        label: { technical: 'Intermediate Mass Track', simple: 'Medium-big Star Life' },
        totalLifetime: 500e6,
        stages: [
          { name: 'protostar', T: 6000, L: 50, R: 8, frac: 0.002,
            label: { technical: 'Protostar', simple: 'Baby star forming' },
            desc: { technical: 'Rapid gravitational collapse. Higher mass allows faster contraction.', simple: 'A large gas cloud collapses quickly to form a bigger, hotter baby star.' }},
          { name: 'main-sequence', T: 10000, L: 200, R: 3.5, frac: 0.85,
            label: { technical: 'Main Sequence', simple: 'Hot bright star' },
            desc: { technical: 'Core hydrogen fusion via the CNO cycle. Higher luminosity than solar-type stars.', simple: 'A hot, blue-white star burning brightly. It uses up its fuel much faster than the Sun.' }},
          { name: 'subgiant', T: 7000, L: 500, R: 8, frac: 0.03,
            label: { technical: 'Subgiant', simple: 'Expanding star' },
            desc: { technical: 'Hydrogen shell burning begins as the core contracts.', simple: 'The star starts growing bigger as it runs low on fuel.' }},
          { name: 'red-giant', T: 4000, L: 5000, R: 80, frac: 0.04,
            label: { technical: 'Red Giant', simple: 'Big red star' },
            desc: { technical: 'Ascent of the RGB with core helium ignition under non-degenerate conditions.', simple: 'The star becomes a big cool red star, much larger than it was before.' }},
          { name: 'blue-loop', T: 7000, L: 3000, R: 20, frac: 0.02,
            label: { technical: 'Blue Loop (Cepheid phase)', simple: 'Pulsing star' },
            desc: { technical: 'Some intermediate-mass stars execute blue loops, passing through the instability strip as Cepheid variables.', simple: 'The star heats up again and starts pulsing -- getting brighter and dimmer in a regular rhythm.' }},
          { name: 'agb', T: 3500, L: 20000, R: 300, frac: 0.02,
            label: { technical: 'AGB Star', simple: 'Super puffy star' },
            desc: { technical: 'Asymptotic giant branch with thermal pulses and strong mass loss.', simple: 'The star puffs up to enormous size one final time, shedding its outer layers into space.' }},
          { name: 'planetary-nebula', T: 120000, L: 10000, R: 0.05, frac: 0.003,
            label: { technical: 'Planetary Nebula', simple: 'Glowing gas cloud' },
            desc: { technical: 'Ejected envelope illuminated by the extremely hot remnant core.', simple: 'A spectacular glowing shell of gas surrounds the tiny remaining core.' }},
          { name: 'white-dwarf', T: 40000, L: 0.05, R: 0.012, frac: 0.035,
            label: { technical: 'White Dwarf', simple: 'Dense dead star' },
            desc: { technical: 'Massive white dwarf remnant, near the Chandrasekhar limit.', simple: 'The leftover core is a small, very dense dead star that will cool down slowly.' }},
        ]
      },
      {
        id: 'high-mass',
        massRange: [8.0, 25.0],
        label: { technical: 'High Mass Track', simple: 'Giant Star Life' },
        totalLifetime: 10e6,
        stages: [
          { name: 'protostar', T: 8000, L: 1000, R: 15, frac: 0.002,
            label: { technical: 'Protostar', simple: 'Huge baby star' },
            desc: { technical: 'Rapid collapse of a massive molecular cloud core with strong radiation pressure.', simple: 'A massive cloud of gas collapses fast, already glowing intensely even before becoming a real star.' }},
          { name: 'main-sequence', T: 25000, L: 50000, R: 8, frac: 0.85,
            label: { technical: 'Main Sequence (O/B star)', simple: 'Blazing hot star' },
            desc: { technical: 'Core hydrogen fusion via the CNO cycle at extreme rates. Strong stellar winds.', simple: 'An incredibly hot blue star burning through its fuel at a furious rate. It will only live for millions of years!' }},
          { name: 'blue-supergiant', T: 15000, L: 100000, R: 30, frac: 0.03,
            label: { technical: 'Blue Supergiant', simple: 'Huge blue star' },
            desc: { technical: 'Post-main-sequence expansion. Core helium burning begins.', simple: 'The star grows and starts burning helium. It is still very hot and blue.' }},
          { name: 'yellow-supergiant', T: 6000, L: 80000, R: 150, frac: 0.02,
            label: { technical: 'Yellow Supergiant', simple: 'Giant yellow star' },
            desc: { technical: 'The star crosses the HR diagram as it evolves. Pulsation instability possible.', simple: 'The star grows even larger and cools to a yellow colour.' }},
          { name: 'red-supergiant', T: 3600, L: 120000, R: 800, frac: 0.06,
            label: { technical: 'Red Supergiant', simple: 'Enormous red star' },
            desc: { technical: 'Final nuclear burning stages (C, Ne, O, Si). Iron core builds up. The star is enormous.', simple: 'The star becomes unbelievably huge and red. Deep inside, it is desperately burning heavier and heavier elements.' }},
          { name: 'supernova', T: 30000, L: 500000, R: 500, frac: 0.001,
            label: { technical: 'Core-Collapse Supernova', simple: 'BOOM! Supernova explosion!' },
            desc: { technical: 'Iron core collapses. Rebound produces a Type II supernova, briefly outshining an entire galaxy.', simple: 'The iron core collapses in less than a second and the star EXPLODES! For a few weeks it shines brighter than a whole galaxy!' }},
          { name: 'neutron-star', T: 1000000, L: 0.001, R: 0.00003, frac: 0.037,
            label: { technical: 'Neutron Star', simple: 'Tiny ultra-dense ball' },
            desc: { technical: 'The collapsed core forms a neutron star ~20 km across. Extreme density and magnetic fields.', simple: 'What is left is a tiny ball only 20 km across but heavier than the Sun. A teaspoon would weigh a billion tonnes!' }},
        ]
      },
      {
        id: 'very-high-mass',
        massRange: [25.0, 200.0],
        label: { technical: 'Very High Mass Track', simple: 'Monster Star Life' },
        totalLifetime: 3e6,
        stages: [
          { name: 'protostar', T: 10000, L: 5000, R: 20, frac: 0.002,
            label: { technical: 'Protostar', simple: 'Massive baby star' },
            desc: { technical: 'Extremely rapid collapse. Radiation pressure nearly disrupts the protostar.', simple: 'An enormous cloud collapses almost instantly (in cosmic terms) to form a monster star.' }},
          { name: 'main-sequence', T: 40000, L: 300000, R: 15, frac: 0.85,
            label: { technical: 'Main Sequence (O star)', simple: 'Ultra-hot blue star' },
            desc: { technical: 'The most luminous main-sequence stars. Extreme stellar winds strip the outer layers.', simple: 'The hottest, brightest stars in the universe. They burn so furiously they only live a few million years.' }},
          { name: 'blue-supergiant', T: 25000, L: 500000, R: 40, frac: 0.05,
            label: { technical: 'Blue Supergiant / LBV', simple: 'Unstable giant star' },
            desc: { technical: 'Luminous Blue Variable phase. Extreme mass loss and eruptions.', simple: 'The star becomes unstable, sometimes flaring up dramatically and blasting material into space.' }},
          { name: 'wolf-rayet', T: 60000, L: 200000, R: 5, frac: 0.04,
            label: { technical: 'Wolf-Rayet Star', simple: 'Stripped bare star' },
            desc: { technical: 'Stellar winds strip away the hydrogen envelope, exposing the helium/carbon core.', simple: 'The star has blown away its outer layers, revealing the super-hot core beneath. It is now a very different kind of star.' }},
          { name: 'supernova', T: 50000, L: 1000000, R: 800, frac: 0.001,
            label: { technical: 'Hypernova / Supernova', simple: 'Mega explosion!' },
            desc: { technical: 'Core collapse produces a hypernova or gamma-ray burst. Among the most energetic events in the universe.', simple: 'The star explodes in one of the most powerful events in the entire universe!' }},
          { name: 'black-hole', T: 0, L: 0, R: 0.0001, frac: 0.057,
            label: { technical: 'Black Hole', simple: 'Black hole' },
            desc: { technical: 'The core collapses beyond the neutron star limit to form a stellar-mass black hole.', simple: 'The core is so heavy it collapses into a black hole -- a point where gravity is so strong nothing can escape, not even light!' }},
        ]
      },
    ];

    // Find the appropriate evolution track for a star based on its mass
    function getTrackForMass(mass) {
      for (var i = 0; i < EVOLUTION_TRACKS.length; i++) {
        var track = EVOLUTION_TRACKS[i];
        if (mass >= track.massRange[0] && mass < track.massRange[1]) {
          return track;
        }
      }
      // Default to sun-like if no match
      if (mass >= 200) return EVOLUTION_TRACKS[4];
      return EVOLUTION_TRACKS[1];
    }

    // Interpolate position along an evolution track
    // t is 0..1 representing fraction of total lifetime
    function interpolateTrack(track, t) {
      t = Math.max(0, Math.min(1, t));
      var stages = track.stages;
      var cumFrac = 0;

      for (var i = 0; i < stages.length; i++) {
        var nextCum = cumFrac + stages[i].frac;
        if (t <= nextCum || i === stages.length - 1) {
          // We are in this stage
          var localT = (stages[i].frac > 0) ? (t - cumFrac) / stages[i].frac : 0;
          localT = Math.max(0, Math.min(1, localT));

          // Interpolate between this stage and next (or stay at last)
          var current = stages[i];
          var next = (i < stages.length - 1) ? stages[i + 1] : stages[i];

          // Use smooth interpolation in log space for T and L
          var logT = lerp(Math.log10(Math.max(1, current.T)), Math.log10(Math.max(1, next.T)), localT);
          var logL = lerp(Math.log10(Math.max(1e-10, current.L)), Math.log10(Math.max(1e-10, next.L)), localT);
          var logR = lerp(Math.log10(Math.max(1e-10, current.R)), Math.log10(Math.max(1e-10, next.R)), localT);

          return {
            temperature: Math.pow(10, logT),
            luminosity: Math.pow(10, logL),
            radius: Math.pow(10, logR),
            stageIndex: i,
            stageName: current.name,
            stageLabel: current.label,
            stageDesc: current.desc,
            localProgress: localT,
            ageYears: t * track.totalLifetime,
          };
        }
        cumFrac = nextCum;
      }
      // Fallback
      var last = stages[stages.length - 1];
      return {
        temperature: last.T, luminosity: last.L, radius: last.R,
        stageIndex: stages.length - 1, stageName: last.name,
        stageLabel: last.label, stageDesc: last.desc,
        localProgress: 1, ageYears: track.totalLifetime,
      };
    }

    // Get the full evolution path as a series of points for rendering the track curve
    function getTrackPath(track, numPoints) {
      numPoints = numPoints || 100;
      var points = [];
      for (var i = 0; i <= numPoints; i++) {
        var t = i / numPoints;
        var state = interpolateTrack(track, t);
        // Skip black holes (T=0, L=0)
        if (state.temperature > 0 && state.luminosity > 0) {
          points.push({
            x: coordMapper.tempToX(state.temperature),
            y: coordMapper.lumToY(state.luminosity),
            t: t,
          });
        }
      }
      return points;
    }

    /* ========================================
       SECTION 8: STATE MANAGEMENT
       ======================================== */

    const state = {
      viewMode: 'hr',           // 'sky' | 'hr' | 'transitioning'
      languageMode: 'simple',
      theme: 'dark',
      selectedStarId: null,
      hoveredStarId: null,
      timelineActive: false,
      timelineMode: 'single',
      timelinePosition: 0.5,
      cosmicTimeYears: 5e9,
      timelineLogScale: true, // true = logarithmic time, false = linear time
      customStars: [],
      sortState: 'hr-diagram',
      infoPanelOpen: true,
      settingsPanelOpen: false,
      customPanelOpen: false,
      helpOverlayOpen: false,
      isFirstRun: true,
      settings: {
        showRegionLabels: true,
        showGridLines: true,
        starGlowIntensity: 1.0,
        animationSpeed: 1.0,
      },
    };

    let needsRedraw = true;

    function announce(message) {
      const el = document.getElementById('aria-announcer');
      if (el) { el.textContent = message; }
    }

    function showToast(message, duration) {
      duration = duration || 3000;
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      container.appendChild(toast);
      setTimeout(function() {
        toast.classList.add('removing');
        setTimeout(function() { toast.remove(); }, 200);
      }, duration);
      // Limit to 3 toasts
      while (container.children.length > 3) {
        container.firstChild.remove();
      }
    }

    /* ========================================
       SECTION 9: COORDINATE SYSTEMS & MATH
       ======================================== */

    const coordMapper = {
      margin: { top: 50, right: 30, bottom: 55, left: 70 },
      width: 0,
      height: 0,
      plotWidth: 0,
      plotHeight: 0,

      update: function(w, h) {
        this.width = w;
        this.height = h;
        this.plotWidth = w - this.margin.left - this.margin.right;
        this.plotHeight = h - this.margin.top - this.margin.bottom;
      },

      // Temperature (K) -> canvas X (reversed: hot on left)
      tempToX: function(T) {
        var logT = Math.log10(Math.max(PHYSICS.T_MIN, Math.min(PHYSICS.T_MAX, T)));
        var frac = (logT - PHYSICS.LOG_T_MIN) / (PHYSICS.LOG_T_MAX - PHYSICS.LOG_T_MIN);
        return this.margin.left + (1 - frac) * this.plotWidth; // reversed
      },

      // Luminosity (L_sun) -> canvas Y (bright at top)
      lumToY: function(L) {
        var logL = Math.log10(Math.max(PHYSICS.L_MIN, Math.min(PHYSICS.L_MAX, L)));
        var frac = (logL - PHYSICS.LOG_L_MIN) / (PHYSICS.LOG_L_MAX - PHYSICS.LOG_L_MIN);
        return this.margin.top + (1 - frac) * this.plotHeight; // inverted Y
      },

      // Canvas X -> Temperature
      xToTemp: function(x) {
        var frac = 1 - (x - this.margin.left) / this.plotWidth;
        var logT = PHYSICS.LOG_T_MIN + frac * (PHYSICS.LOG_T_MAX - PHYSICS.LOG_T_MIN);
        return Math.pow(10, logT);
      },

      // Canvas Y -> Luminosity
      yToLum: function(y) {
        var frac = 1 - (y - this.margin.top) / this.plotHeight;
        var logL = PHYSICS.LOG_L_MIN + frac * (PHYSICS.LOG_L_MAX - PHYSICS.LOG_L_MIN);
        return Math.pow(10, logL);
      },

      // log(T), log(L) -> canvas coords
      logToCanvas: function(logT, logL) {
        var fracT = (logT - PHYSICS.LOG_T_MIN) / (PHYSICS.LOG_T_MAX - PHYSICS.LOG_T_MIN);
        var fracL = (logL - PHYSICS.LOG_L_MIN) / (PHYSICS.LOG_L_MAX - PHYSICS.LOG_L_MIN);
        return {
          x: this.margin.left + (1 - fracT) * this.plotWidth,
          y: this.margin.top + (1 - fracL) * this.plotHeight
        };
      },
    };

    /* ========================================
       SECTION 10: CANVAS RENDERING ENGINE
       ======================================== */

    var canvas, ctx;
    var stars = []; // runtime star objects with positions

    function initStars() {
      stars = STAR_DATA.map(function(data) {
        var hrX = coordMapper.tempToX(data.temperature);
        var hrY = coordMapper.lumToY(data.luminosity);
        // Sky position: seeded random based on star id hash
        var hash = hashString(data.id);
        var skyX = coordMapper.margin.left + (pseudoRandom(hash) * coordMapper.plotWidth);
        var skyY = coordMapper.margin.top + (pseudoRandom(hash + 1) * coordMapper.plotHeight);
        // Apparent size from radius (log scale, mapped to 2-8px)
        var logR = Math.log10(Math.max(0.005, data.radius));
        var minLogR = Math.log10(0.005);
        var maxLogR = Math.log10(1000);
        var sizeFrac = (logR - minLogR) / (maxLogR - minLogR);
        var apparentSize = 2 + sizeFrac * 6;

        return {
          data: data,
          hrPosition: { x: hrX, y: hrY },
          skyPosition: { x: skyX, y: skyY },
          currentPosition: { x: hrX, y: hrY },
          apparentSize: apparentSize,
          twinklePhase: pseudoRandom(hash + 2) * Math.PI * 2,
          twinkleSpeed: 0.5 + pseudoRandom(hash + 3) * 2,
        };
      });
    }

    function hashString(str) {
      var hash = 0;
      for (var i = 0; i < str.length; i++) {
        var char = str.charCodeAt(i);
        hash = ((hash << 5) - hash) + char;
        hash = hash & hash; // to 32bit int
      }
      return Math.abs(hash);
    }

    function pseudoRandom(seed) {
      var x = Math.sin(seed * 9301 + 49297) * 233280;
      return x - Math.floor(x);
    }

    // Star color to CSS
    function starColorCSS(color, alpha) {
      alpha = alpha !== undefined ? alpha : 1;
      return 'rgba(' + color.r + ',' + color.g + ',' + color.b + ',' + alpha + ')';
    }

    // Temperature to approximate star color
    function tempToColor(T) {
      // Simplified blackbody to RGB
      var r, g, b;
      if (T < 3500) { r = 255; g = 120 + (T - 2000) * 0.04; b = 60 + (T - 2000) * 0.02; }
      else if (T < 5000) { r = 255; g = 180 + (T - 3500) * 0.05; b = 140 + (T - 3500) * 0.06; }
      else if (T < 7500) { r = 255; g = 240 + (T - 5000) * 0.006; b = 220 + (T - 5000) * 0.014; }
      else if (T < 10000) { r = 230 - (T - 7500) * 0.02; g = 235 - (T - 7500) * 0.008; b = 255; }
      else if (T < 30000) { r = 180 - (T - 10000) * 0.002; g = 200 - (T - 10000) * 0.001; b = 255; }
      else { r = 155; g = 176; b = 255; }
      return { r: Math.round(Math.max(0, Math.min(255, r))), g: Math.round(Math.max(0, Math.min(255, g))), b: Math.round(Math.max(0, Math.min(255, b))) };
    }

    function renderBackground() {
      // Space background
      var isDark = state.theme === 'dark';
      if (isDark) {
        ctx.fillStyle = '#0a0e1a';
      } else {
        ctx.fillStyle = '#f0f2f8';
      }
      ctx.fillRect(0, 0, coordMapper.width, coordMapper.height);
    }

    function renderGrid() {
      if (!state.settings.showGridLines) return;
      // Hide grid in sky view
      if (state.sortState === 'sky') return;

      var isDark = state.theme === 'dark';
      ctx.strokeStyle = isDark ? 'rgba(255,255,255,0.04)' : 'rgba(0,0,0,0.06)';
      ctx.lineWidth = 0.5;

      // Vertical grid lines at temperature values
      var tempTicks = [2500, 3000, 4000, 5000, 7000, 10000, 15000, 20000, 30000, 50000];
      tempTicks.forEach(function(T) {
        var x = coordMapper.tempToX(T);
        ctx.beginPath();
        ctx.moveTo(x, coordMapper.margin.top);
        ctx.lineTo(x, coordMapper.margin.top + coordMapper.plotHeight);
        ctx.stroke();
      });

      // Horizontal grid lines at luminosity values (powers of 10)
      for (var logL = PHYSICS.LOG_L_MIN; logL <= PHYSICS.LOG_L_MAX; logL++) {
        var y = coordMapper.lumToY(Math.pow(10, logL));
        ctx.beginPath();
        ctx.moveTo(coordMapper.margin.left, y);
        ctx.lineTo(coordMapper.margin.left + coordMapper.plotWidth, y);
        ctx.stroke();
      }
    }

    function renderAxes() {
      // Hide axes in sky view and sort views
      if (state.sortState === 'sky' || state.sortState === 'sort-brightness' || state.sortState === 'sort-colour') return;

      var isDark = state.theme === 'dark';
      var lang = LANG[state.languageMode];
      var textColor = isDark ? '#8892aa' : '#555e78';
      var axisColor = isDark ? 'rgba(255,255,255,0.15)' : 'rgba(0,0,0,0.2)';
      var labelColor = isDark ? '#c0c8da' : '#333';

      ctx.strokeStyle = axisColor;
      ctx.lineWidth = 1;

      // X axis
      ctx.beginPath();
      ctx.moveTo(coordMapper.margin.left, coordMapper.margin.top + coordMapper.plotHeight);
      ctx.lineTo(coordMapper.margin.left + coordMapper.plotWidth, coordMapper.margin.top + coordMapper.plotHeight);
      ctx.stroke();

      // Y axis
      ctx.beginPath();
      ctx.moveTo(coordMapper.margin.left, coordMapper.margin.top);
      ctx.lineTo(coordMapper.margin.left, coordMapper.margin.top + coordMapper.plotHeight);
      ctx.stroke();

      // X axis ticks and labels
      ctx.fillStyle = textColor;
      ctx.font = '11px ' + getComputedStyle(document.body).fontFamily;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top';

      var tempTicks;
      var tempLabels;
      if (state.languageMode === 'technical') {
        tempTicks = [3000, 5000, 7000, 10000, 20000, 40000];
        tempLabels = ['3,000', '5,000', '7,000', '10,000', '20,000', '40,000'];
      } else {
        tempTicks = [3000, 5000, 7000, 10000, 20000, 40000];
        tempLabels = ['Cool Red', 'Warm Yellow', 'White', 'Hot Blue-White', 'Very Hot Blue', 'Blazing Blue'];
      }

      tempTicks.forEach(function(T, i) {
        var x = coordMapper.tempToX(T);
        // Tick mark
        ctx.beginPath();
        ctx.moveTo(x, coordMapper.margin.top + coordMapper.plotHeight);
        ctx.lineTo(x, coordMapper.margin.top + coordMapper.plotHeight + 5);
        ctx.strokeStyle = axisColor;
        ctx.stroke();
        // Label
        ctx.fillStyle = textColor;
        ctx.save();
        if (state.languageMode === 'simple') {
          ctx.font = '9px ' + getComputedStyle(document.body).fontFamily;
        }
        ctx.fillText(tempLabels[i], x, coordMapper.margin.top + coordMapper.plotHeight + 8);
        ctx.restore();
      });

      // X axis title
      ctx.fillStyle = labelColor;
      ctx.font = 'bold 12px ' + getComputedStyle(document.body).fontFamily;
      ctx.textAlign = 'center';
      ctx.fillText(
        lang.axes.xLabel,
        coordMapper.margin.left + coordMapper.plotWidth / 2,
        coordMapper.margin.top + coordMapper.plotHeight + 35
      );

      // Arrow indicating direction (hot to cool, left to right)
      var arrowY = coordMapper.margin.top + coordMapper.plotHeight + 46;
      ctx.fillStyle = textColor;
      ctx.font = '10px ' + getComputedStyle(document.body).fontFamily;
      ctx.textAlign = 'left';
      ctx.fillText('\u2190 Hot', coordMapper.margin.left, arrowY);
      ctx.textAlign = 'right';
      ctx.fillText('Cool \u2192', coordMapper.margin.left + coordMapper.plotWidth, arrowY);

      // Y axis ticks and labels
      ctx.textAlign = 'right';
      ctx.textBaseline = 'middle';

      for (var logL = PHYSICS.LOG_L_MIN; logL <= PHYSICS.LOG_L_MAX; logL++) {
        var y = coordMapper.lumToY(Math.pow(10, logL));
        // Tick mark
        ctx.beginPath();
        ctx.moveTo(coordMapper.margin.left - 5, y);
        ctx.lineTo(coordMapper.margin.left, y);
        ctx.strokeStyle = axisColor;
        ctx.stroke();
        // Label
        ctx.fillStyle = textColor;
        ctx.font = '11px ' + getComputedStyle(document.body).fontFamily;
        var label;
        if (state.languageMode === 'technical') {
          if (logL === 0) label = '1';
          else if (logL > 0) label = '10' + superscript(logL);
          else label = '10' + superscript(logL);
        } else {
          if (logL === 0) label = 'Sun';
          else if (logL === 1) label = '10\u00d7';
          else if (logL === 2) label = '100\u00d7';
          else if (logL === 3) label = '1,000\u00d7';
          else if (logL === 4) label = '10,000\u00d7';
          else if (logL === 5) label = '100,000\u00d7';
          else if (logL === 6) label = '1,000,000\u00d7';
          else if (logL === -1) label = '1/10';
          else if (logL === -2) label = '1/100';
          else if (logL === -3) label = '1/1,000';
          else if (logL === -4) label = 'very dim';
          else if (logL === -5) label = 'barely glowing';
          else label = '10^' + logL;
        }
        ctx.fillText(label, coordMapper.margin.left - 8, y);
      }

      // Y axis title (rotated)
      ctx.save();
      ctx.translate(15, coordMapper.margin.top + coordMapper.plotHeight / 2);
      ctx.rotate(-Math.PI / 2);
      ctx.fillStyle = labelColor;
      ctx.font = 'bold 12px ' + getComputedStyle(document.body).fontFamily;
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(lang.axes.yLabel, 0, 0);
      ctx.restore();
    }

    function superscript(n) {
      var superscripts = { '0': '\u2070', '1': '\u00b9', '2': '\u00b2', '3': '\u00b3', '4': '\u2074', '5': '\u2075', '6': '\u2076', '-': '\u207b' };
      return String(n).split('').map(function(c) { return superscripts[c] || c; }).join('');
    }

    function renderRegions() {
      // Only show regions when in HR diagram view
      if (state.sortState !== 'hr-diagram') return;

      HR_REGIONS.forEach(function(region) {
        if (region.path.length < 3) return;

        ctx.beginPath();
        var first = coordMapper.logToCanvas(region.path[0][0], region.path[0][1]);
        ctx.moveTo(first.x, first.y);

        for (var i = 1; i < region.path.length; i++) {
          var pt = coordMapper.logToCanvas(region.path[i][0], region.path[i][1]);
          ctx.lineTo(pt.x, pt.y);
        }
        ctx.closePath();

        ctx.fillStyle = region.fillColor;
        ctx.fill();
        ctx.strokeStyle = region.borderColor;
        ctx.lineWidth = 1;
        ctx.setLineDash([4, 4]);
        ctx.stroke();
        ctx.setLineDash([]);

        // Region label
        if (state.settings.showRegionLabels) {
          var labelPt = coordMapper.logToCanvas(region.labelPos[0], region.labelPos[1]);
          var isDark = state.theme === 'dark';
          var lang = LANG[state.languageMode];
          var regionLabel = region.label[state.languageMode];

          ctx.fillStyle = isDark ? 'rgba(255,255,255,0.7)' : 'rgba(0,0,0,0.6)';
          ctx.font = 'italic 15px ' + getComputedStyle(document.body).fontFamily;
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';

          var lines = regionLabel.split('\n');
          lines.forEach(function(line, idx) {
            ctx.fillText(line, labelPt.x, labelPt.y + idx * 18 - (lines.length - 1) * 9);
          });
        }
      });
    }

    function renderStars() {
      stars.forEach(function(star) {
        var x = star.currentPosition.x;
        var y = star.currentPosition.y;
        var size = star.apparentSize;
        var color = star.data.color;
        var isSelected = state.selectedStarId === star.data.id;
        var isHovered = state.hoveredStarId === star.data.id;
        var glowIntensity = state.settings.starGlowIntensity;

        // Outer glow
        var outerR = size * 3 * glowIntensity;
        if (outerR > 1) {
          var outerGrad = ctx.createRadialGradient(x, y, 0, x, y, outerR);
          outerGrad.addColorStop(0, starColorCSS(color, 0.12 * glowIntensity));
          outerGrad.addColorStop(1, starColorCSS(color, 0));
          ctx.fillStyle = outerGrad;
          ctx.beginPath();
          ctx.arc(x, y, outerR, 0, Math.PI * 2);
          ctx.fill();
        }

        // Mid glow
        var midR = size * 1.8 * glowIntensity;
        if (midR > 0.5) {
          var midGrad = ctx.createRadialGradient(x, y, 0, x, y, midR);
          midGrad.addColorStop(0, starColorCSS(color, 0.35 * glowIntensity));
          midGrad.addColorStop(1, starColorCSS(color, 0));
          ctx.fillStyle = midGrad;
          ctx.beginPath();
          ctx.arc(x, y, midR, 0, Math.PI * 2);
          ctx.fill();
        }

        // Core
        ctx.fillStyle = starColorCSS(color, 1);
        ctx.beginPath();
        ctx.arc(x, y, size, 0, Math.PI * 2);
        ctx.fill();

        // Bright center
        ctx.fillStyle = 'rgba(255, 255, 255, 0.7)';
        ctx.beginPath();
        ctx.arc(x, y, size * 0.35, 0, Math.PI * 2);
        ctx.fill();

        // Selection ring
        if (isSelected) {
          ctx.strokeStyle = 'rgba(74, 158, 255, 0.8)';
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.arc(x, y, size + 6, 0, Math.PI * 2);
          ctx.stroke();

          // Pulsing outer ring
          ctx.strokeStyle = 'rgba(74, 158, 255, 0.3)';
          ctx.lineWidth = 1;
          ctx.beginPath();
          ctx.arc(x, y, size + 10, 0, Math.PI * 2);
          ctx.stroke();
        }

        // Hover highlight
        if (isHovered && !isSelected) {
          ctx.strokeStyle = 'rgba(255, 255, 255, 0.4)';
          ctx.lineWidth = 1;
          ctx.beginPath();
          ctx.arc(x, y, size + 5, 0, Math.PI * 2);
          ctx.stroke();
        }
      });
    }

    function drawStarLabel(star, isDark, style) {
      var x = star.currentPosition.x;
      var y = star.currentPosition.y;
      var name = star.data.name;
      var fontSize = style === 'persistent' ? 10 : 12;
      var fontWeight = style === 'persistent' ? '600' : 'bold';
      var alpha = style === 'persistent' ? 0.65 : 1;

      ctx.font = fontWeight + ' ' + fontSize + 'px ' + getComputedStyle(document.body).fontFamily;
      var textWidth = ctx.measureText(name).width;

      // Position label above the star, or below if near top
      var labelX = x;
      var labelY = y - star.apparentSize - (style === 'persistent' ? 10 : 14);
      if (labelY < coordMapper.margin.top + 10) {
        labelY = y + star.apparentSize + (style === 'persistent' ? 14 : 18);
      }

      // Background pill
      var padding = style === 'persistent' ? 4 : 6;
      var bgAlpha = style === 'persistent' ? 0.6 : 0.85;
      ctx.fillStyle = isDark ? 'rgba(20, 26, 46, ' + bgAlpha + ')' : 'rgba(255, 255, 255, ' + (bgAlpha + 0.05) + ')';
      ctx.beginPath();
      var rx = labelX - textWidth / 2 - padding;
      var ry = labelY - 9;
      var rw = textWidth + padding * 2;
      var rh = 18;
      var rr = 4;
      ctx.moveTo(rx + rr, ry);
      ctx.lineTo(rx + rw - rr, ry);
      ctx.quadraticCurveTo(rx + rw, ry, rx + rw, ry + rr);
      ctx.lineTo(rx + rw, ry + rh - rr);
      ctx.quadraticCurveTo(rx + rw, ry + rh, rx + rw - rr, ry + rh);
      ctx.lineTo(rx + rr, ry + rh);
      ctx.quadraticCurveTo(rx, ry + rh, rx, ry + rh - rr);
      ctx.lineTo(rx, ry + rr);
      ctx.quadraticCurveTo(rx, ry, rx + rr, ry);
      ctx.closePath();
      ctx.fill();

      ctx.strokeStyle = isDark ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.08)';
      ctx.lineWidth = 0.5;
      ctx.stroke();

      ctx.globalAlpha = alpha;
      ctx.fillStyle = isDark ? '#e8ecf4' : '#1a1e2e';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText(name, labelX, labelY);
      ctx.globalAlpha = 1;
    }

    function renderStarLabels() {
      var isDark = state.theme === 'dark';

      // Always show Sun label
      var sunStar = stars.find(function(s) { return s.data.id === 'sun'; });
      if (sunStar && state.selectedStarId !== 'sun' && state.hoveredStarId !== 'sun') {
        drawStarLabel(sunStar, isDark, 'persistent');
      }

      // Show name for selected or hovered star
      var starToLabel = null;
      if (state.selectedStarId) {
        starToLabel = stars.find(function(s) { return s.data.id === state.selectedStarId; });
      }
      if (!starToLabel && state.hoveredStarId) {
        starToLabel = stars.find(function(s) { return s.data.id === state.hoveredStarId; });
      }
      if (starToLabel) {
        drawStarLabel(starToLabel, isDark, 'active');
      }
    }

    function renderEvolutionTrack() {
      if (!state.timelineActive) return;

      var selectedStar = null;
      if (state.timelineMode === 'single' && state.selectedStarId) {
        selectedStar = STAR_DATA.find(function(s) { return s.id === state.selectedStarId; });
      }

      if (state.timelineMode === 'single' && selectedStar) {
        var track = getTrackForMass(selectedStar.mass);
        var path = getTrackPath(track, 150);

        if (path.length < 2) return;

        // Draw the full track path
        ctx.strokeStyle = 'rgba(74, 158, 255, 0.25)';
        ctx.lineWidth = 1.5;
        ctx.setLineDash([3, 3]);
        ctx.beginPath();
        ctx.moveTo(path[0].x, path[0].y);
        for (var i = 1; i < path.length; i++) {
          ctx.lineTo(path[i].x, path[i].y);
        }
        ctx.stroke();
        ctx.setLineDash([]);

        // Draw stage markers on the track
        var stages = track.stages;
        var cumFrac = 0;
        var isDark = state.theme === 'dark';
        stages.forEach(function(stage, idx) {
          var midFrac = cumFrac + stage.frac * 0.5;
          cumFrac += stage.frac;
          var interpState = interpolateTrack(track, midFrac);
          if (interpState.temperature <= 0 || interpState.luminosity <= 0) return;
          var sx = coordMapper.tempToX(interpState.temperature);
          var sy = coordMapper.lumToY(interpState.luminosity);

          // Small dot at stage midpoint
          ctx.fillStyle = 'rgba(74, 158, 255, 0.4)';
          ctx.beginPath();
          ctx.arc(sx, sy, 3, 0, Math.PI * 2);
          ctx.fill();
        });

        // Draw current position on the track
        var currentInterp = interpolateTrack(track, state.timelinePosition);
        if (currentInterp.temperature > 0 && currentInterp.luminosity > 0) {
          var cx = coordMapper.tempToX(currentInterp.temperature);
          var cy = coordMapper.lumToY(currentInterp.luminosity);

          // Animated star at current evolution position
          var evolutionColor = tempToColor(currentInterp.temperature);

          // Glowing marker
          var glowGrad = ctx.createRadialGradient(cx, cy, 0, cx, cy, 16);
          glowGrad.addColorStop(0, starColorCSS(evolutionColor, 0.5));
          glowGrad.addColorStop(1, starColorCSS(evolutionColor, 0));
          ctx.fillStyle = glowGrad;
          ctx.beginPath();
          ctx.arc(cx, cy, 16, 0, Math.PI * 2);
          ctx.fill();

          // Core
          ctx.fillStyle = starColorCSS(evolutionColor, 1);
          ctx.beginPath();
          ctx.arc(cx, cy, 5, 0, Math.PI * 2);
          ctx.fill();

          // Ring
          ctx.strokeStyle = 'rgba(74, 158, 255, 0.8)';
          ctx.lineWidth = 2;
          ctx.beginPath();
          ctx.arc(cx, cy, 9, 0, Math.PI * 2);
          ctx.stroke();
        }
      }

      // Cosmic mode: draw tracks for all stars (only when in HR diagram view)
      if (state.timelineMode === 'cosmic' && state.sortState === 'hr-diagram') {
        stars.forEach(function(star) {
          var track = getTrackForMass(star.data.mass);
          var normalizedT = state.cosmicTimeYears / track.totalLifetime;
          normalizedT = Math.min(normalizedT, 1);

          var interpState = interpolateTrack(track, normalizedT);
          if (interpState.temperature > 0 && interpState.luminosity > 0) {
            // Move star to its evolved position
            star.currentPosition.x = coordMapper.tempToX(interpState.temperature);
            star.currentPosition.y = coordMapper.lumToY(interpState.luminosity);
          } else {
            // Star has become a black hole -- show faded at original position
            star.currentPosition.x = star.hrPosition.x;
            star.currentPosition.y = star.hrPosition.y;
          }
        });
      }
    }

    function render() {
      renderBackground();
      renderGrid();
      renderRegions();
      renderAxes();
      renderEvolutionTrack();
      renderStars();
      renderStarLabels();
    }

    /* ========================================
       SECTION 11: ANIMATION SYSTEM
       ======================================== */

    var activeAnimations = [];

    var easingFunctions = {
      linear: function(t) { return t; },
      easeInQuad: function(t) { return t * t; },
      easeOutQuad: function(t) { return t * (2 - t); },
      easeInOutQuad: function(t) { return t < 0.5 ? 2 * t * t : -1 + (4 - 2 * t) * t; },
      easeInCubic: function(t) { return t * t * t; },
      easeOutCubic: function(t) { return (--t) * t * t + 1; },
      easeInOutCubic: function(t) { return t < 0.5 ? 4 * t * t * t : (t - 1) * (2 * t - 2) * (2 * t - 2) + 1; },
      easeOutBack: function(t) { var s = 1.70158; return (t -= 1) * t * ((s + 1) * t + s) + 1; },
      easeOutElastic: function(t) {
        if (t === 0 || t === 1) return t;
        return Math.pow(2, -10 * t) * Math.sin((t - 0.1) * 5 * Math.PI) + 1;
      },
    };

    function createAnimation(options) {
      return {
        startTime: null,
        duration: options.duration || 1000,
        easing: options.easing || 'easeInOutCubic',
        onUpdate: options.onUpdate,
        onComplete: options.onComplete || function() {},
        completed: false,
        update: function(timestamp) {
          if (!this.startTime) this.startTime = timestamp;
          var elapsed = timestamp - this.startTime;
          var raw = Math.min(elapsed / this.duration, 1);
          var progress = easingFunctions[this.easing](raw);
          this.onUpdate(progress);
          if (raw >= 1) {
            this.completed = true;
            this.onComplete();
          }
        }
      };
    }

    function lerp(a, b, t) {
      return a + (b - a) * t;
    }

    function animationLoop(timestamp) {
      // Update active animations
      activeAnimations.forEach(function(anim) { anim.update(timestamp); });
      activeAnimations = activeAnimations.filter(function(a) { return !a.completed; });

      if (needsRedraw || activeAnimations.length > 0) {
        render();
        needsRedraw = false;
      }

      requestAnimationFrame(animationLoop);
    }

    // 7.6 Star templates for custom creation
    const STAR_TEMPLATES = [
      { id: 'red-dwarf', name: 'Red Dwarf', icon: '\ud83d\udd34',
        desc: 'Small, cool, long-lived', T: 3000, L: 0.003, M: 0.12,
        ranges: { T: [2400, 3800], L: [0.0001, 0.08], M: [0.08, 0.45] }},
      { id: 'sun-like', name: 'Sun-like', icon: '\u2600\ufe0f',
        desc: 'Medium, yellow, stable', T: 5778, L: 1.0, M: 1.0,
        ranges: { T: [4800, 6500], L: [0.2, 5], M: [0.7, 1.4] }},
      { id: 'blue-giant', name: 'Blue Giant', icon: '\ud83d\udd35',
        desc: 'Hot, massive, bright', T: 20000, L: 10000, M: 10,
        ranges: { T: [10000, 45000], L: [1000, 200000], M: [5, 50] }},
      { id: 'red-giant', name: 'Red Giant', icon: '\ud83d\udfe0',
        desc: 'Cool, large, bright', T: 4000, L: 500, M: 1.5,
        ranges: { T: [3200, 5000], L: [50, 5000], M: [0.8, 3] }},
      { id: 'white-dwarf', name: 'White Dwarf', icon: '\u26aa',
        desc: 'Tiny, hot, dense', T: 20000, L: 0.01, M: 0.6,
        ranges: { T: [5000, 40000], L: [0.0001, 0.1], M: [0.4, 1.4] }},
      { id: 'supergiant', name: 'Supergiant', icon: '\ud83c\udf1f',
        desc: 'Enormous, very bright', T: 5000, L: 50000, M: 15,
        ranges: { T: [3200, 30000], L: [10000, 500000], M: [8, 70] }},
    ];

    // Slider mapping functions (log scale for L and some T ranges)
    function sliderToTemp(val, min, max) {
      // Linear mapping for temperature
      return min + (val / 1000) * (max - min);
    }
    function tempToSlider(T, min, max) {
      return Math.round(((T - min) / (max - min)) * 1000);
    }
    function sliderToLog(val, min, max) {
      // Log-scale mapping for luminosity
      var logMin = Math.log10(Math.max(1e-10, min));
      var logMax = Math.log10(Math.max(1e-10, max));
      var logVal = logMin + (val / 1000) * (logMax - logMin);
      return Math.pow(10, logVal);
    }
    function logToSlider(v, min, max) {
      var logMin = Math.log10(Math.max(1e-10, min));
      var logMax = Math.log10(Math.max(1e-10, max));
      var logV = Math.log10(Math.max(1e-10, v));
      return Math.round(((logV - logMin) / (logMax - logMin)) * 1000);
    }
    function sliderToMass(val, min, max) {
      // Log scale for mass too
      return sliderToLog(val, min, max);
    }
    function massToSlider(M, min, max) {
      return logToSlider(M, min, max);
    }

    // Physics validation for custom stars
    function validateStarPhysics(T, L, M) {
      var messages = [];
      // Mass-luminosity relation for main sequence: L ~ M^3.5
      var expectedL = Math.pow(M, 3.5);
      var ratio = L / expectedL;

      // Compute implied radius from Stefan-Boltzmann: L = R^2 * (T/T_sun)^4
      var impliedR = Math.sqrt(L) / Math.pow(T / 5778, 2);

      if (ratio > 100) {
        messages.push({ type: 'info', text: 'This combination suggests a giant or supergiant star -- very large and bright for its mass.' });
      } else if (ratio > 10) {
        messages.push({ type: 'info', text: 'This star is brighter than typical for its mass. It might be an evolved giant.' });
      } else if (ratio < 0.01) {
        messages.push({ type: 'info', text: 'This star is very faint for its mass. This suggests a white dwarf or very unusual star.' });
      } else if (ratio < 0.1) {
        messages.push({ type: 'info', text: 'Dimmer than expected for this mass -- possibly a subdwarf or white dwarf.' });
      }

      if (T > 40000 && M < 3) {
        messages.push({ type: 'warning', text: 'Very hot temperatures with low mass is unusual. Only white dwarfs are this hot and light.' });
      }

      if (impliedR > 1000) {
        messages.push({ type: 'warning', text: 'This star would be larger than the orbit of Mars! Only the most extreme supergiants reach this size.' });
      }

      return { messages: messages, impliedRadius: impliedR };
    }

    var customStarCounter = 0;

    function addCustomStar(name, T, L, M) {
      customStarCounter++;
      var validation = validateStarPhysics(T, L, M);
      var color = tempToColor(T);
      var id = 'custom-' + customStarCounter + '-' + Date.now();

      var newStar = {
        id: id, name: name || ('Star #' + customStarCounter),
        temperature: T, luminosity: L, mass: M, radius: validation.impliedRadius,
        spectralType: guessSpectralType(T), stage: guessStage(T, L, M),
        expectedLifetime: estimateLifetime(M), currentAge: null,
        color: color, isCustom: true,
        description: {
          technical: 'A custom star with T=' + Math.round(T) + 'K, L=' + L.toFixed(2) + 'L\u2609.',
          simple: 'A star you created! It has a temperature of ' + Math.round(T) + ' degrees.'
        }
      };

      STAR_DATA.push(newStar);
      state.customStars.push(newStar);

      // Reinitialize stars to include the new one
      initStars();

      // Set positions based on current view
      stars.forEach(function(s) {
        if (state.sortState === 'sky') {
          s.currentPosition.x = s.skyPosition.x;
          s.currentPosition.y = s.skyPosition.y;
        } else {
          s.currentPosition.x = s.hrPosition.x;
          s.currentPosition.y = s.hrPosition.y;
        }
      });

      buildSRStarList();
      updateCustomStarsList();
      saveCustomStars();
      needsRedraw = true;
      showToast('Added "' + newStar.name + '" to the diagram!');
      selectStar(id);
    }

    function removeCustomStar(id) {
      var idx = STAR_DATA.findIndex(function(s) { return s.id === id; });
      if (idx !== -1) STAR_DATA.splice(idx, 1);
      state.customStars = state.customStars.filter(function(s) { return s.id !== id; });
      if (state.selectedStarId === id) selectStar(null);
      initStars();
      stars.forEach(function(s) {
        if (state.sortState === 'sky') {
          s.currentPosition.x = s.skyPosition.x;
          s.currentPosition.y = s.skyPosition.y;
        } else {
          s.currentPosition.x = s.hrPosition.x;
          s.currentPosition.y = s.hrPosition.y;
        }
      });
      buildSRStarList();
      updateCustomStarsList();
      saveCustomStars();
      needsRedraw = true;
      showToast('Star removed');
    }

    function guessSpectralType(T) {
      if (T > 30000) return 'O';
      if (T > 10000) return 'B';
      if (T > 7500) return 'A';
      if (T > 6000) return 'F';
      if (T > 5200) return 'G';
      if (T > 3700) return 'K';
      return 'M';
    }

    function guessStage(T, L, M) {
      var expectedL = Math.pow(M, 3.5);
      var ratio = L / expectedL;
      if (ratio < 0.05 && T > 5000) return 'white-dwarf';
      if (ratio > 50 && T < 4500) return 'red-giant';
      if (ratio > 50 && T > 4500) return 'blue-supergiant';
      if (L > 10000 && T < 5000) return 'red-supergiant';
      return 'main-sequence';
    }

    function estimateLifetime(M) {
      // Rough: lifetime ~ M^-2.5 * 10 billion years
      return 10e9 * Math.pow(M, -2.5);
    }

    function updateCustomStarsList() {
      var container = document.getElementById('custom-stars-items');
      if (!container) return;
      container.innerHTML = '';
      if (state.customStars.length === 0) {
        container.innerHTML = '<p style="color:var(--color-text-muted);font-size:var(--font-size-xs)">No custom stars yet</p>';
        return;
      }
      state.customStars.forEach(function(star) {
        var item = document.createElement('div');
        item.className = 'custom-star-item';
        item.innerHTML = '<span class="custom-star-item-name"><span class="star-color-swatch" style="background:' + starColorCSS(star.color) + ';width:12px;height:12px"></span>' + escapeHTML(star.name) + '</span>';
        var delBtn = document.createElement('button');
        delBtn.className = 'custom-star-delete';
        delBtn.textContent = 'Remove';
        delBtn.setAttribute('aria-label', 'Remove ' + star.name);
        var confirmState = false;
        delBtn.addEventListener('click', function() {
          if (!confirmState) {
            confirmState = true;
            delBtn.textContent = 'Confirm?';
            delBtn.classList.add('confirm');
            setTimeout(function() {
              if (confirmState) {
                confirmState = false;
                delBtn.textContent = 'Remove';
                delBtn.classList.remove('confirm');
              }
            }, 3000);
          } else {
            removeCustomStar(star.id);
          }
        });
        item.appendChild(delBtn);
        container.appendChild(item);
      });
    }

    function saveCustomStars() {
      try {
        localStorage.setItem('hr-diagram-custom-stars', JSON.stringify(state.customStars));
      } catch (e) { /* quota exceeded or disabled */ }
    }

    function loadCustomStars() {
      try {
        var saved = localStorage.getItem('hr-diagram-custom-stars');
        if (saved) {
          var parsed = JSON.parse(saved);
          if (Array.isArray(parsed)) {
            parsed.forEach(function(star) {
              // Re-add to STAR_DATA
              STAR_DATA.push(star);
              state.customStars.push(star);
              customStarCounter++;
            });
          }
        }
      } catch (e) { /* corrupted data */ }
    }

    /* ========================================
       SECTION 12: UI CONTROLLERS
       ======================================== */

    // 12.1 Language toggle
    function setLanguageMode(mode) {
      state.languageMode = mode;
      var techBtn = document.getElementById('lang-technical');
      var simpleBtn = document.getElementById('lang-simple');
      techBtn.setAttribute('aria-checked', mode === 'technical' ? 'true' : 'false');
      simpleBtn.setAttribute('aria-checked', mode === 'simple' ? 'true' : 'false');

      var lang = LANG[mode];
      document.getElementById('app-title-text').textContent = lang.appTitle;
      document.getElementById('btn-sky-view').textContent = lang.skyView;
      document.getElementById('btn-sort-brightness').textContent = lang.sortBrightness;
      document.getElementById('btn-sort-colour').textContent = lang.sortColour;
      document.getElementById('btn-show-hr').textContent = lang.showHR;
      document.getElementById('btn-single-mode').textContent = lang.timelineSingle;
      document.getElementById('btn-cosmic-mode').textContent = lang.timelineCosmic;
      document.getElementById('btn-create-star').textContent = lang.createStar;
      document.getElementById('timeline-stage-label').textContent = lang.timelinePrompt;

      // Update info panel if a star is selected
      if (state.selectedStarId) {
        updateInfoPanel(state.selectedStarId);
      } else {
        document.getElementById('info-panel-title').textContent = lang.selectStar;
        var emptyMsg = document.getElementById('info-empty-msg');
        if (emptyMsg) emptyMsg.textContent = lang.clickPrompt;
      }

      needsRedraw = true;
      announce('Language switched to ' + (mode === 'technical' ? 'technical' : 'simple') + ' mode');
    }

    // 12.2 Theme toggle
    function toggleTheme() {
      var newTheme = state.theme === 'dark' ? 'light' : 'dark';
      state.theme = newTheme;
      document.documentElement.setAttribute('data-theme', newTheme);
      var btn = document.getElementById('theme-toggle');
      btn.setAttribute('aria-label', 'Switch to ' + (newTheme === 'dark' ? 'light' : 'dark') + ' theme');
      needsRedraw = true;
    }

    // 12.3 Star selection and info panel
    function updateTimelineVisibility(starData) {
      var timelineRow = document.querySelector('.timeline-row');
      var timelineLabel = document.getElementById('timeline-stage-label');
      if (!timelineRow) return;
      var shouldShow = starData && !starData.isCustom;
      timelineRow.style.display = shouldShow ? '' : 'none';
      timelineLabel.style.display = shouldShow ? '' : 'none';
    }

    function selectStar(starId) {
      state.selectedStarId = starId;
      if (starId) {
        updateInfoPanel(starId);
        var star = stars.find(function(s) { return s.data.id === starId; });
        if (star) {
          announce('Selected ' + star.data.name);
          updateTimelineVisibility(star.data);

          if (star.data.isCustom) {
            // Custom stars don't have evolution tracks
            state.timelineActive = false;
            document.getElementById('timeline-scrubber').disabled = true;
          } else {
            // Enable timeline
            document.getElementById('timeline-scrubber').disabled = false;

            if (state.timelineMode === 'single') {
              state.timelineActive = true;
              // Set timeline to star's current age fraction
              var track = getTrackForMass(star.data.mass);
              var currentFrac = star.data.currentAge ? star.data.currentAge / track.totalLifetime : 0.5;
              currentFrac = Math.max(0, Math.min(1, currentFrac));
              state.timelinePosition = currentFrac;
              document.getElementById('timeline-scrubber').value = Math.round(currentFrac * 1000);

              var interpState = interpolateTrack(track, currentFrac);
              var stageLabel = state.languageMode === 'simple' ? interpState.stageLabel.simple : interpState.stageLabel.technical;
              var ageStr = formatAge(interpState.ageYears, state.languageMode === 'simple');
              document.getElementById('timeline-stage-label').textContent = stageLabel + ' \u2014 ' + ageStr;
            }
          }
        }
      } else {
        clearInfoPanel();
        updateTimelineVisibility(null);
        if (state.timelineMode === 'single') {
          document.getElementById('timeline-scrubber').disabled = true;
          state.timelineActive = false;
          var lang = LANG[state.languageMode];
          document.getElementById('timeline-stage-label').textContent = lang.timelinePrompt;
        }
      }
      updateTimelineModeButtons();
      needsRedraw = true;
    }

    function updateInfoPanel(starId) {
      var star = STAR_DATA.find(function(s) { return s.id === starId; });
      if (!star) return;

      var lang = LANG[state.languageMode];
      var isSimple = state.languageMode === 'simple';

      document.getElementById('info-panel-title').textContent = star.name;
      var emptyMsg = document.getElementById('info-empty-msg');
      if (emptyMsg) emptyMsg.style.display = 'none';

      var body = document.getElementById('info-panel-body');

      // Build info HTML
      var html = '';

      // Star name and swatch
      html += '<div class="star-name-display">';
      html += '<span class="star-color-swatch" style="background:' + starColorCSS(star.color) + '"></span>';
      html += escapeHTML(star.name);
      html += '</div>';

      // Stage badge
      var stageLabel = lang.stages[star.stage] || star.stage;
      html += '<div class="star-stage-badge">' + escapeHTML(stageLabel) + '</div>';

      // Description
      html += '<p style="color:var(--color-text-secondary);font-size:var(--font-size-sm);margin-bottom:var(--space-4)">';
      html += escapeHTML(isSimple ? star.description.simple : star.description.technical);
      html += '</p>';

      html += '<div class="star-props">';

      // Temperature
      html += starPropHTML(
        lang.starInfo.temperature,
        isSimple ? formatNumber(star.temperature) + '\u00b0' : formatNumber(star.temperature) + ' K',
        isSimple ? tempToDescription(star.temperature) : null
      );

      // Luminosity
      html += starPropHTML(
        lang.starInfo.luminosity,
        isSimple ? formatLuminositySimple(star.luminosity) : formatNumber(star.luminosity, 4) + ' L\u2609',
        isSimple && star.luminosity !== 1 ? compareSun('brightness', star.luminosity) : null
      );

      // Mass
      html += starPropHTML(
        lang.starInfo.mass,
        isSimple ? formatNumber(star.mass, 2) + '\u00d7 the Sun' : formatNumber(star.mass, 2) + ' M\u2609',
        isSimple ? compareSun('weight', star.mass) : null
      );

      // Radius
      html += starPropHTML(
        lang.starInfo.radius,
        isSimple ? formatNumber(star.radius, 2) + '\u00d7 the Sun' : formatNumber(star.radius, 3) + ' R\u2609',
        isSimple ? compareSunRadius(star.radius) : null
      );

      // Spectral type
      html += starPropHTML(
        lang.starInfo.spectralType,
        isSimple ? spectralToSimple(star.spectralType) : star.spectralType,
        null
      );

      // Lifetime
      if (star.expectedLifetime) {
        html += starPropHTML(
          lang.starInfo.lifetime,
          formatAge(star.expectedLifetime, isSimple),
          null
        );
      }

      // Age
      if (star.currentAge) {
        html += starPropHTML(
          lang.starInfo.age,
          formatAge(star.currentAge, isSimple),
          isSimple && star.expectedLifetime ? 'About ' + Math.round(star.currentAge / star.expectedLifetime * 100) + '% through its life' : null
        );
      }

      html += '</div>';

      body.innerHTML = html;
    }

    function clearInfoPanel() {
      var lang = LANG[state.languageMode];
      document.getElementById('info-panel-title').textContent = lang.selectStar;
      var body = document.getElementById('info-panel-body');
      body.innerHTML = '<p class="info-empty" id="info-empty-msg">' + escapeHTML(lang.clickPrompt) + '</p>';
    }

    function starPropHTML(label, value, compare) {
      var html = '<div class="star-prop">';
      html += '<span class="star-prop-label">' + escapeHTML(label) + '</span>';
      html += '<span class="star-prop-value">' + escapeHTML(value) + '</span>';
      if (compare) {
        html += '<span class="star-prop-compare">' + escapeHTML(compare) + '</span>';
      }
      html += '</div>';
      return html;
    }

    function escapeHTML(str) {
      var div = document.createElement('div');
      div.appendChild(document.createTextNode(str));
      return div.innerHTML;
    }

    function formatNumber(n, maxDecimals) {
      if (n === undefined || n === null) return 'Unknown';
      maxDecimals = maxDecimals || 0;
      if (n >= 1000) return n.toLocaleString('en-US', { maximumFractionDigits: 0 });
      if (n >= 1) return n.toLocaleString('en-US', { maximumFractionDigits: maxDecimals || 1 });
      if (n >= 0.01) return n.toFixed(maxDecimals || 3);
      return n.toExponential(1);
    }

    function formatLuminositySimple(L) {
      if (L >= 1000) return formatNumber(L) + '\u00d7 brighter than the Sun';
      if (L >= 1) return formatNumber(L, 1) + '\u00d7 the Sun\'s brightness';
      if (L >= 0.01) return Math.round(L * 100) + '% of the Sun\'s brightness';
      return 'Only ' + (L * 100).toFixed(2) + '% of the Sun\'s brightness';
    }

    function formatAge(years, simple) {
      if (years >= 1e12) return simple ? Math.round(years / 1e12) + ' trillion years' : (years / 1e9).toFixed(0) + ' \u00d7 10\u2079 years';
      if (years >= 1e9) return simple ? (years / 1e9).toFixed(1) + ' billion years' : (years / 1e9).toFixed(2) + ' Gyr';
      if (years >= 1e6) return simple ? (years / 1e6).toFixed(0) + ' million years' : (years / 1e6).toFixed(1) + ' Myr';
      return simple ? formatNumber(years) + ' years' : formatNumber(years) + ' yr';
    }

    function tempToDescription(T) {
      if (T > 30000) return 'Extremely hot! Blazing blue';
      if (T > 10000) return 'Very hot, blue-white star';
      if (T > 7500) return 'Hot, white star';
      if (T > 6000) return 'Warm, yellow-white star';
      if (T > 5000) return 'Similar to our Sun\'s temperature';
      if (T > 3500) return 'Cooler, orange star';
      return 'Cool, red star';
    }

    function compareSun(what, value) {
      if (value > 100) return Math.round(value) + ' times the Sun\'s ' + what;
      if (value > 10) return Math.round(value) + ' times the Sun\'s ' + what;
      if (value > 1.5) return value.toFixed(1) + ' times the Sun\'s ' + what;
      if (value > 0.8) return 'About the same as the Sun';
      if (value > 0.1) return Math.round(value * 100) + '% of the Sun\'s ' + what;
      return 'Much less than the Sun';
    }

    function compareSunRadius(R) {
      if (R > 500) return 'Would swallow Mars if placed where the Sun is!';
      if (R > 100) return 'Would swallow Mercury if placed where the Sun is';
      if (R > 10) return 'Much bigger than our Sun';
      if (R > 1.5) return 'Bigger than our Sun';
      if (R > 0.5) return 'About the size of our Sun';
      if (R > 0.05) return 'Much smaller than our Sun';
      return 'Tiny! About the size of Earth';
    }

    function spectralToSimple(type) {
      var letter = type.charAt(0);
      var map = {
        'O': 'Very hot blue',
        'B': 'Hot blue-white',
        'A': 'White',
        'F': 'Yellow-white',
        'G': 'Yellow (like our Sun)',
        'K': 'Orange',
        'M': 'Cool red',
        'D': 'White dwarf',
      };
      return map[letter] || type;
    }

    // 12.4a Timeline mode button state
    // Handlers are swapped: btn-single-mode triggers cosmic, btn-cosmic-mode triggers single
    // So highlight singleBtn when cosmic is active, cosmicBtn when single is active
    function updateTimelineModeButtons() {
      var singleBtn = document.getElementById('btn-single-mode');
      var cosmicBtn = document.getElementById('btn-cosmic-mode');
      if (!singleBtn || !cosmicBtn) return;
      var isSingle = state.timelineMode === 'single' && state.timelineActive;
      var isCosmic = state.timelineMode === 'cosmic' && state.timelineActive;

      singleBtn.classList.toggle('active', isCosmic);
      singleBtn.setAttribute('aria-pressed', isCosmic ? 'true' : 'false');
      cosmicBtn.classList.toggle('active', isSingle);
      cosmicBtn.setAttribute('aria-pressed', isSingle ? 'true' : 'false');
    }

    // 12.4 View mode controls
    function setViewMode(mode) {
      // Clear existing animations
      activeAnimations = [];

      var viewButtons = ['btn-sky-view', 'btn-sort-brightness', 'btn-sort-colour', 'btn-show-hr'];
      viewButtons.forEach(function(id) {
        var btn = document.getElementById(id);
        btn.classList.remove('active');
        btn.setAttribute('aria-pressed', 'false');
      });

      var buttonMap = {
        'sky': 'btn-sky-view',
        'sort-brightness': 'btn-sort-brightness',
        'sort-colour': 'btn-sort-colour',
        'hr-diagram': 'btn-show-hr',
      };

      var activeBtn = document.getElementById(buttonMap[mode]);
      if (activeBtn) {
        activeBtn.classList.add('active');
        activeBtn.setAttribute('aria-pressed', 'true');
      }

      var reducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;

      if (mode === 'sky') {
        animateToSkyView(reducedMotion);
      } else if (mode === 'sort-brightness') {
        animateSortByBrightness(reducedMotion);
      } else if (mode === 'sort-colour') {
        animateSortByColour(reducedMotion);
      } else if (mode === 'hr-diagram') {
        animateToHRDiagram(reducedMotion);
      }

      state.viewMode = mode === 'sky' ? 'sky' : 'hr';
      state.sortState = mode;
    }

    function animateToSkyView(instant) {
      stars.forEach(function(star) {
        if (instant) {
          star.currentPosition.x = star.skyPosition.x;
          star.currentPosition.y = star.skyPosition.y;
        } else {
          var startX = star.currentPosition.x;
          var startY = star.currentPosition.y;
          var endX = star.skyPosition.x;
          var endY = star.skyPosition.y;
          activeAnimations.push(createAnimation({
            duration: 1200,
            easing: 'easeInOutCubic',
            onUpdate: function(p) {
              star.currentPosition.x = lerp(startX, endX, p);
              star.currentPosition.y = lerp(startY, endY, p);
            }
          }));
        }
      });
      needsRedraw = true;
    }

    function animateToHRDiagram(instant) {
      var delay = 0;
      stars.forEach(function(star, i) {
        if (instant) {
          star.currentPosition.x = star.hrPosition.x;
          star.currentPosition.y = star.hrPosition.y;
        } else {
          var startX = star.currentPosition.x;
          var startY = star.currentPosition.y;
          var endX = star.hrPosition.x;
          var endY = star.hrPosition.y;
          var staggerDelay = i * 30;
          // Use a timeout to stagger starts
          (function(s, sx, sy, ex, ey) {
            setTimeout(function() {
              activeAnimations.push(createAnimation({
                duration: 1000,
                easing: 'easeOutCubic',
                onUpdate: function(p) {
                  // Curved path via quadratic bezier
                  var midX = (sx + ex) / 2;
                  var midY = Math.min(sy, ey) - 30;
                  var t = p;
                  var mt = 1 - t;
                  s.currentPosition.x = mt * mt * sx + 2 * mt * t * midX + t * t * ex;
                  s.currentPosition.y = mt * mt * sy + 2 * mt * t * midY + t * t * ey;
                }
              }));
            }, staggerDelay);
          })(star, startX, startY, endX, endY);
        }
      });
      needsRedraw = true;
    }

    function animateSortByBrightness(instant) {
      // Sort stars ONLY by luminosity into a single vertical column
      // Brightest at top, dimmest at bottom
      var sorted = stars.slice().sort(function(a, b) {
        return b.data.luminosity - a.data.luminosity;
      });

      var columnX = coordMapper.margin.left + coordMapper.plotWidth * 0.5;
      var topY = coordMapper.margin.top + 20;
      var bottomY = coordMapper.margin.top + coordMapper.plotHeight - 20;
      var spacing = (bottomY - topY) / (sorted.length - 1);

      // All stars go to a single column, sorted by brightness only
      sorted.forEach(function(star, i) {
        star.sortedPosition = {
          x: columnX,
          y: topY + i * spacing
        };
      });

      if (instant) {
        sorted.forEach(function(star) {
          star.currentPosition.x = star.sortedPosition.x;
          star.currentPosition.y = star.sortedPosition.y;
        });
        needsRedraw = true;
        return;
      }

      // Animate to column and hold there
      sorted.forEach(function(star) {
        var fromX = star.currentPosition.x;
        var fromY = star.currentPosition.y;
        var toX = star.sortedPosition.x;
        var toY = star.sortedPosition.y;

        activeAnimations.push(createAnimation({
          duration: 1200,
          easing: 'easeInOutCubic',
          onUpdate: function(p) {
            star.currentPosition.x = lerp(fromX, toX, p);
            star.currentPosition.y = lerp(fromY, toY, p);
          }
        }));
      });
      needsRedraw = true;
    }

    function animateSortByColour(instant) {
      // Sort stars ONLY by temperature into a single horizontal row
      // Hottest on left, coolest on right
      var sorted = stars.slice().sort(function(a, b) {
        return b.data.temperature - a.data.temperature;
      });

      var rowY = coordMapper.margin.top + coordMapper.plotHeight * 0.5;
      var leftX = coordMapper.margin.left + 20;
      var rightX = coordMapper.margin.left + coordMapper.plotWidth - 20;
      var spacing = (rightX - leftX) / (sorted.length - 1);

      // All stars go to a single row, sorted by colour/temperature only
      sorted.forEach(function(star, i) {
        star.sortedPosition = {
          x: leftX + i * spacing,
          y: rowY
        };
      });

      if (instant) {
        sorted.forEach(function(star) {
          star.currentPosition.x = star.sortedPosition.x;
          star.currentPosition.y = star.sortedPosition.y;
        });
        needsRedraw = true;
        return;
      }

      // Animate to row and hold there
      sorted.forEach(function(star) {
        var fromX = star.currentPosition.x;
        var fromY = star.currentPosition.y;
        var toX = star.sortedPosition.x;
        var toY = star.sortedPosition.y;

        activeAnimations.push(createAnimation({
          duration: 1200,
          easing: 'easeInOutCubic',
          onUpdate: function(p) {
            star.currentPosition.x = lerp(fromX, toX, p);
            star.currentPosition.y = lerp(fromY, toY, p);
          }
        }));
      });
      needsRedraw = true;
    }

    /* ========================================
       SECTION 13: EVENT HANDLERS
       ======================================== */

    function findStarAtPoint(canvasX, canvasY) {
      var hitRadius = 14;
      var closest = null;
      var closestDist = Infinity;

      for (var i = 0; i < stars.length; i++) {
        var star = stars[i];
        var dx = star.currentPosition.x - canvasX;
        var dy = star.currentPosition.y - canvasY;
        var dist = Math.sqrt(dx * dx + dy * dy);
        if (dist < hitRadius && dist < closestDist) {
          closest = star;
          closestDist = dist;
        }
      }
      return closest;
    }

    function getCanvasCoords(e) {
      var rect = canvas.getBoundingClientRect();
      return {
        x: (e.clientX - rect.left),
        y: (e.clientY - rect.top),
      };
    }

    function onCanvasPointerDown(e) {
      var coords = getCanvasCoords(e);
      var star = findStarAtPoint(coords.x, coords.y);
      if (star) {
        selectStar(star.data.id);
      } else {
        selectStar(null);
      }
    }

    function onCanvasPointerMove(e) {
      var coords = getCanvasCoords(e);
      var star = findStarAtPoint(coords.x, coords.y);
      var newHoveredId = star ? star.data.id : null;

      if (newHoveredId !== state.hoveredStarId) {
        state.hoveredStarId = newHoveredId;
        canvas.style.cursor = newHoveredId ? 'pointer' : 'default';
        needsRedraw = true;
      }
    }

    function onCanvasPointerLeave() {
      if (state.hoveredStarId) {
        state.hoveredStarId = null;
        canvas.style.cursor = 'default';
        needsRedraw = true;
      }
    }

    // EASTER EGG: Konami code supernova
    var konamiSequence = ['ArrowUp','ArrowUp','ArrowDown','ArrowDown','ArrowLeft','ArrowRight','ArrowLeft','ArrowRight','b','a'];
    var konamiIndex = 0;

    function triggerSupernova() {
      var selectedStar = stars.find(function(s) { return s.data.id === state.selectedStarId; });
      if (selectedStar) {
        // Supernova on selected star
        var cx = selectedStar.currentPosition.x;
        var cy = selectedStar.currentPosition.y;
        var color = selectedStar.data.color;
        var particles = [];
        for (var i = 0; i < 40; i++) {
          var angle = (Math.PI * 2 / 40) * i + (Math.random() - 0.5) * 0.3;
          var speed = 80 + Math.random() * 200;
          particles.push({ x: cx, y: cy, vx: Math.cos(angle) * speed, vy: Math.sin(angle) * speed, life: 1 });
        }
        var startTime = null;
        activeAnimations.push({
          startTime: null, duration: 2500, easing: 'linear', completed: false,
          onUpdate: function(p) { /* handled in custom render below */ },
          onComplete: function() {},
          update: function(timestamp) {
            if (!this.startTime) this.startTime = timestamp;
            var elapsed = timestamp - this.startTime;
            var raw = Math.min(elapsed / this.duration, 1);

            // Phase 1: brightening (0-0.2)
            if (raw < 0.2) {
              var scale = 1 + (raw / 0.2) * 20;
              ctx.save();
              var grad = ctx.createRadialGradient(cx, cy, 0, cx, cy, scale * 15);
              grad.addColorStop(0, 'rgba(255, 255, 255, ' + (1 - raw * 3) + ')');
              grad.addColorStop(0.5, starColorCSS(color, 0.6 * (1 - raw * 3)));
              grad.addColorStop(1, 'rgba(255, 200, 100, 0)');
              ctx.fillStyle = grad;
              ctx.beginPath();
              ctx.arc(cx, cy, scale * 15, 0, Math.PI * 2);
              ctx.fill();
              ctx.restore();
            }

            // Phase 2: particles (0.2-1.0)
            if (raw >= 0.2) {
              var pProgress = (raw - 0.2) / 0.8;
              particles.forEach(function(part) {
                var px = cx + part.vx * pProgress;
                var py = cy + part.vy * pProgress;
                var alpha = Math.max(0, 1 - pProgress * 1.2);
                var size = 3 * (1 - pProgress * 0.5);
                ctx.fillStyle = starColorCSS(color, alpha);
                ctx.beginPath();
                ctx.arc(px, py, size, 0, Math.PI * 2);
                ctx.fill();
              });
            }

            if (raw >= 1) { this.completed = true; }
          }
        });
        showToast('Supernova observed! Don\'t try this at home.');
      } else {
        // Meteor shower when no star selected
        for (var m = 0; m < 15; m++) {
          (function(delay) {
            setTimeout(function() {
              var sx = Math.random() * coordMapper.width;
              var sy = Math.random() * coordMapper.plotHeight * 0.3 + coordMapper.margin.top;
              activeAnimations.push(createAnimation({
                duration: 600 + Math.random() * 400,
                easing: 'linear',
                onUpdate: function(p) {
                  var ex = sx + 150 * p;
                  var ey = sy + 100 * p;
                  var alpha = p < 0.3 ? p / 0.3 : Math.max(0, 1 - (p - 0.3) / 0.7);
                  ctx.strokeStyle = 'rgba(255, 255, 255, ' + alpha * 0.8 + ')';
                  ctx.lineWidth = 1.5;
                  ctx.beginPath();
                  ctx.moveTo(ex - 20 * (1 - p), ey - 15 * (1 - p));
                  ctx.lineTo(ex, ey);
                  ctx.stroke();
                }
              }));
            }, delay * 150);
          })(m);
        }
        showToast('Meteor shower!');
      }
      needsRedraw = true;
    }

    // Keyboard handler
    function onKeyDown(e) {
      // Konami code detection
      if (e.key === konamiSequence[konamiIndex]) {
        konamiIndex++;
        if (konamiIndex === konamiSequence.length) {
          konamiIndex = 0;
          triggerSupernova();
          return;
        }
      } else {
        konamiIndex = 0;
      }

      // ? for help
      if (e.key === '?') {
        toggleHelp();
        return;
      }

      // Escape to close panels/deselect
      if (e.key === 'Escape') {
        if (state.customPanelOpen) {
          closeCustomDrawer();
        } else if (state.helpOverlayOpen) {
          toggleHelp();
        } else if (state.selectedStarId) {
          selectStar(null);
        }
        return;
      }

      // Arrow keys to cycle through stars
      if (e.key === 'ArrowRight' || e.key === 'ArrowDown') {
        e.preventDefault();
        cycleStarSelection(1);
        return;
      }
      if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') {
        e.preventDefault();
        cycleStarSelection(-1);
        return;
      }

      // Number keys for quick view mode switching
      if (e.key === '1') { setViewMode('sky'); return; }
      if (e.key === '2') { setViewMode('sort-brightness'); return; }
      if (e.key === '3') { setViewMode('sort-colour'); return; }
      if (e.key === '4') { setViewMode('hr-diagram'); return; }
    }

    function cycleStarSelection(direction) {
      var currentIndex = -1;
      if (state.selectedStarId) {
        currentIndex = stars.findIndex(function(s) { return s.data.id === state.selectedStarId; });
      }
      var nextIndex = currentIndex + direction;
      if (nextIndex < 0) nextIndex = stars.length - 1;
      if (nextIndex >= stars.length) nextIndex = 0;
      selectStar(stars[nextIndex].data.id);
    }

    function toggleHelp() {
      state.helpOverlayOpen = !state.helpOverlayOpen;
      var overlay = document.getElementById('help-overlay');
      overlay.setAttribute('aria-hidden', state.helpOverlayOpen ? 'false' : 'true');
      if (state.helpOverlayOpen) {
        document.getElementById('help-close').focus();
      }
    }

    // Resize handler
    var resizeTimeout;
    function onResize() {
      clearTimeout(resizeTimeout);
      resizeTimeout = setTimeout(function() {
        resizeCanvas();
        initStars();
        // Snap to current view mode - re-trigger the current sort/view
        if (state.sortState === 'sky') {
          animateToSkyView(true);
        } else if (state.sortState === 'sort-brightness') {
          animateSortByBrightness(true);
        } else if (state.sortState === 'sort-colour') {
          animateSortByColour(true);
        } else {
          stars.forEach(function(s) {
            s.currentPosition.x = s.hrPosition.x;
            s.currentPosition.y = s.hrPosition.y;
          });
        }
        needsRedraw = true;
      }, 150);
    }

    function resizeCanvas() {
      var container = document.getElementById('canvas-container');
      var rect = container.getBoundingClientRect();
      var dpr = window.devicePixelRatio || 1;

      canvas.width = rect.width * dpr;
      canvas.height = rect.height * dpr;
      canvas.style.width = rect.width + 'px';
      canvas.style.height = rect.height + 'px';

      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      coordMapper.update(rect.width, rect.height);
    }

    // 12.7 Custom star drawer functions
    function openCustomDrawer() {
      document.getElementById('custom-star-drawer').setAttribute('aria-hidden', 'false');
      document.getElementById('drawer-backdrop').classList.add('active');
      state.customPanelOpen = true;
    }

    function closeCustomDrawer() {
      document.getElementById('custom-star-drawer').setAttribute('aria-hidden', 'true');
      document.getElementById('drawer-backdrop').classList.remove('active');
      state.customPanelOpen = false;
    }

    var selectedTemplate = null;

    function buildTemplateGrid() {
      var grid = document.getElementById('template-grid');
      grid.innerHTML = '';
      STAR_TEMPLATES.forEach(function(tmpl) {
        var card = document.createElement('div');
        card.className = 'template-card';
        card.setAttribute('role', 'button');
        card.setAttribute('tabindex', '0');
        card.setAttribute('aria-label', tmpl.name + ': ' + tmpl.desc);
        card.innerHTML = '<div class="template-card-icon">' + tmpl.icon + '</div>'
          + '<div class="template-card-name">' + escapeHTML(tmpl.name) + '</div>'
          + '<div class="template-card-desc">' + escapeHTML(tmpl.desc) + '</div>';

        card.addEventListener('click', function() {
          selectTemplate(tmpl);
          // Remove selected from all
          grid.querySelectorAll('.template-card').forEach(function(c) { c.classList.remove('selected'); });
          card.classList.add('selected');
        });
        card.addEventListener('keydown', function(e) {
          if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); card.click(); }
        });
        grid.appendChild(card);
      });
    }

    function selectTemplate(tmpl) {
      selectedTemplate = tmpl;
      var slidersDiv = document.getElementById('guided-sliders');
      slidersDiv.style.display = '';

      var ranges = tmpl.ranges;

      // Set sliders to template default values
      var tempSlider = document.getElementById('guided-temp');
      var lumSlider = document.getElementById('guided-lum');
      var massSlider = document.getElementById('guided-mass');

      tempSlider.value = tempToSlider(tmpl.T, ranges.T[0], ranges.T[1]);
      lumSlider.value = logToSlider(tmpl.L, ranges.L[0], ranges.L[1]);
      massSlider.value = massToSlider(tmpl.M, ranges.M[0], ranges.M[1]);

      document.getElementById('guided-name').value = '';

      updateGuidedDisplay();

      // Attach input listeners
      tempSlider.oninput = updateGuidedDisplay;
      lumSlider.oninput = updateGuidedDisplay;
      massSlider.oninput = updateGuidedDisplay;

      // Create button
      document.getElementById('guided-create').onclick = function() {
        var name = document.getElementById('guided-name').value.trim();
        var T = sliderToTemp(parseInt(tempSlider.value), ranges.T[0], ranges.T[1]);
        var L = sliderToLog(parseInt(lumSlider.value), ranges.L[0], ranges.L[1]);
        var M = sliderToMass(parseInt(massSlider.value), ranges.M[0], ranges.M[1]);
        addCustomStar(name || (tmpl.name + ' star'), T, L, M);
        closeCustomDrawer();
      };
    }

    function updateGuidedDisplay() {
      if (!selectedTemplate) return;
      var ranges = selectedTemplate.ranges;
      var T = sliderToTemp(parseInt(document.getElementById('guided-temp').value), ranges.T[0], ranges.T[1]);
      var L = sliderToLog(parseInt(document.getElementById('guided-lum').value), ranges.L[0], ranges.L[1]);
      var M = sliderToMass(parseInt(document.getElementById('guided-mass').value), ranges.M[0], ranges.M[1]);

      document.getElementById('guided-temp-val').textContent = Math.round(T) + ' K';
      document.getElementById('guided-lum-val').textContent = formatNumber(L, 3) + ' L\u2609';
      document.getElementById('guided-mass-val').textContent = formatNumber(M, 2) + ' M\u2609';

      var validation = validateStarPhysics(T, L, M);
      var valDiv = document.getElementById('guided-validation');
      if (validation.messages.length > 0) {
        var msg = validation.messages[0];
        valDiv.textContent = msg.text;
        valDiv.className = 'validation-msg ' + msg.type;
      } else {
        valDiv.className = 'validation-msg';
      }
    }

    function initExpertSliders() {
      var tempSlider = document.getElementById('expert-temp');
      var lumSlider = document.getElementById('expert-lum');
      var massSlider = document.getElementById('expert-mass');

      // Set defaults (Sun-like)
      tempSlider.value = tempToSlider(5778, 2400, 50000);
      lumSlider.value = logToSlider(1.0, 1e-5, 1e6);
      massSlider.value = massToSlider(1.0, 0.08, 150);

      function updateExpertDisplay() {
        var T = sliderToTemp(parseInt(tempSlider.value), 2400, 50000);
        var L = sliderToLog(parseInt(lumSlider.value), 1e-5, 1e6);
        var M = sliderToMass(parseInt(massSlider.value), 0.08, 150);

        document.getElementById('expert-temp-val').textContent = Math.round(T) + ' K';
        document.getElementById('expert-lum-val').textContent = formatNumber(L, 3) + ' L\u2609';
        document.getElementById('expert-mass-val').textContent = formatNumber(M, 2) + ' M\u2609';

        var validation = validateStarPhysics(T, L, M);
        var valDiv = document.getElementById('expert-validation');
        if (validation.messages.length > 0) {
          var msg = validation.messages[0];
          valDiv.textContent = msg.text;
          valDiv.className = 'validation-msg ' + msg.type;
        } else {
          valDiv.className = 'validation-msg';
        }

        // Show computed properties
        document.getElementById('expert-computed').innerHTML =
          'Implied radius: ' + formatNumber(validation.impliedRadius, 2) + ' R\u2609'
          + ' &middot; Spectral type: ' + guessSpectralType(T)
          + ' &middot; Estimated lifetime: ' + formatAge(estimateLifetime(M), true);
      }

      tempSlider.addEventListener('input', updateExpertDisplay);
      lumSlider.addEventListener('input', updateExpertDisplay);
      massSlider.addEventListener('input', updateExpertDisplay);

      updateExpertDisplay();
    }

    /* ========================================
       SECTION 14: INITIALIZATION
       ======================================== */

    function init() {
      canvas = document.getElementById('hr-canvas');
      ctx = canvas.getContext('2d');

      // Resize canvas
      resizeCanvas();

      // Initialize star positions
      initStars();

      // Place stars at HR diagram positions by default
      stars.forEach(function(s) {
        s.currentPosition.x = s.hrPosition.x;
        s.currentPosition.y = s.hrPosition.y;
      });

      // Build screen reader star list
      buildSRStarList();

      // Set initial language
      setLanguageMode(state.languageMode);

      // Event listeners
      canvas.addEventListener('pointerdown', onCanvasPointerDown);
      canvas.addEventListener('pointermove', onCanvasPointerMove);
      canvas.addEventListener('pointerleave', onCanvasPointerLeave);

      document.addEventListener('keydown', onKeyDown);
      window.addEventListener('resize', onResize);

      // Language toggle buttons
      document.getElementById('lang-technical').addEventListener('click', function() { setLanguageMode('technical'); });
      document.getElementById('lang-simple').addEventListener('click', function() { setLanguageMode('simple'); });

      // Theme toggle
      document.getElementById('theme-toggle').addEventListener('click', toggleTheme);

      // View mode buttons
      document.getElementById('btn-sky-view').addEventListener('click', function() { setViewMode('sky'); });
      document.getElementById('btn-sort-brightness').addEventListener('click', function() { setViewMode('sort-brightness'); });
      document.getElementById('btn-sort-colour').addEventListener('click', function() { setViewMode('sort-colour'); });
      document.getElementById('btn-show-hr').addEventListener('click', function() { setViewMode('hr-diagram'); });

      // Help
      document.getElementById('help-btn').addEventListener('click', toggleHelp);
      document.getElementById('help-close').addEventListener('click', toggleHelp);

      // Info panel mobile toggle
      document.getElementById('info-panel-toggle').addEventListener('click', function() {
        if (window.innerWidth <= 768) {
          document.getElementById('info-panel').classList.toggle('expanded');
        }
      });
      document.getElementById('info-panel-close').addEventListener('click', function() {
        if (window.innerWidth <= 768) {
          document.getElementById('info-panel').classList.remove('expanded');
        }
      });

      // Load saved custom stars
      loadCustomStars();
      if (state.customStars.length > 0) {
        initStars();
        stars.forEach(function(s) {
          s.currentPosition.x = s.hrPosition.x;
          s.currentPosition.y = s.hrPosition.y;
        });
        buildSRStarList();
      }
      updateCustomStarsList();

      // Create star button - open drawer
      document.getElementById('btn-create-star').addEventListener('click', function() {
        openCustomDrawer();
      });

      // Close custom drawer
      document.getElementById('drawer-close-custom').addEventListener('click', closeCustomDrawer);
      document.getElementById('drawer-backdrop').addEventListener('click', closeCustomDrawer);

      // Tab switching in custom drawer
      document.getElementById('tab-guided').addEventListener('click', function() {
        document.getElementById('tab-guided').classList.add('active');
        document.getElementById('tab-guided').setAttribute('aria-selected', 'true');
        document.getElementById('tab-expert').classList.remove('active');
        document.getElementById('tab-expert').setAttribute('aria-selected', 'false');
        document.getElementById('panel-guided').style.display = '';
        document.getElementById('panel-expert').style.display = 'none';
      });
      document.getElementById('tab-expert').addEventListener('click', function() {
        document.getElementById('tab-expert').classList.add('active');
        document.getElementById('tab-expert').setAttribute('aria-selected', 'true');
        document.getElementById('tab-guided').classList.remove('active');
        document.getElementById('tab-guided').setAttribute('aria-selected', 'false');
        document.getElementById('panel-expert').style.display = '';
        document.getElementById('panel-guided').style.display = 'none';
      });

      // Build template grid
      buildTemplateGrid();

      // Expert sliders
      initExpertSliders();

      // Expert create button
      document.getElementById('expert-create').addEventListener('click', function() {
        var name = document.getElementById('expert-name').value.trim();
        var T = sliderToTemp(parseInt(document.getElementById('expert-temp').value), 2400, 50000);
        var L = sliderToLog(parseInt(document.getElementById('expert-lum').value), 1e-5, 1e6);
        var M = sliderToMass(parseInt(document.getElementById('expert-mass').value), 0.08, 150);
        addCustomStar(name, T, L, M);
        closeCustomDrawer();
      });

      // Timeline scrubber
      var scrubber = document.getElementById('timeline-scrubber');

      // Convert slider 0..1 value to evolution fraction based on scale mode
      function sliderToTimeFraction(val) {
        if (!state.timelineLogScale) {
          // Logarithmic: late short-lived stages get more slider space
          return Math.pow(val, 0.3);
        }
        return val; // Linear: direct mapping
      }

      // Convert evolution fraction to cosmic years based on scale mode
      function sliderToCosmicYears(val) {
        var maxTime = 15e9;
        if (!state.timelineLogScale) {
          // Log scale: exponential mapping for cosmic time
          if (val <= 0) return 0;
          return Math.pow(10, val * 10.176); // 10^10.176 ~ 15 billion
        }
        return val * maxTime; // Linear
      }

      scrubber.addEventListener('input', function() {
        var val = parseInt(scrubber.value, 10) / 1000; // 0..1

        if (state.timelineMode === 'single' && state.selectedStarId) {
          var timeFrac = sliderToTimeFraction(val);
          state.timelinePosition = timeFrac;
          var star = STAR_DATA.find(function(s) { return s.id === state.selectedStarId; });
          if (star) {
            var track = getTrackForMass(star.mass);
            var interpState = interpolateTrack(track, timeFrac);
            var stageLabel = state.languageMode === 'simple' ? interpState.stageLabel.simple : interpState.stageLabel.technical;
            var ageStr = formatAge(interpState.ageYears, state.languageMode === 'simple');
            document.getElementById('timeline-stage-label').textContent = stageLabel + ' \u2014 ' + ageStr;
          }
        } else if (state.timelineMode === 'cosmic') {
          state.cosmicTimeYears = sliderToCosmicYears(val);
          state.timelinePosition = val;
          var ageStr = formatAge(state.cosmicTimeYears, state.languageMode === 'simple');
          document.getElementById('timeline-stage-label').textContent =
            (state.languageMode === 'simple' ? 'Universe age: ' : 'Cosmic time: ') + ageStr;
        }

        state.timelineActive = true;
        needsRedraw = true;
      });

      // Timeline mode buttons - handlers swapped so labels match user expectations:
      // "One Star" button  cosmic mode (evolves all stars, but user sees focused evolution)
      // "All Stars" button  single mode (all stars stay visible at HR positions)
      document.getElementById('btn-single-mode').addEventListener('click', function() {
        state.timelineMode = 'cosmic';
        state.timelineActive = true;
        scrubber.disabled = false;

        if (state.sortState !== 'hr-diagram') {
          setViewMode('hr-diagram');
        }

        var ageStr = formatAge(state.cosmicTimeYears, state.languageMode === 'simple');
        document.getElementById('timeline-stage-label').textContent =
          (state.languageMode === 'simple' ? 'Universe age: ' : 'Cosmic time: ') + ageStr;

        updateTimelineModeButtons();
        needsRedraw = true;
      });

      document.getElementById('btn-cosmic-mode').addEventListener('click', function() {
        state.timelineMode = 'single';

        if (state.selectedStarId) {
          scrubber.disabled = false;
          state.timelineActive = true;
          var star = STAR_DATA.find(function(s) { return s.id === state.selectedStarId; });
          if (star) {
            var track = getTrackForMass(star.mass);
            var interpState = interpolateTrack(track, state.timelinePosition);
            var stageLabel = state.languageMode === 'simple' ? interpState.stageLabel.simple : interpState.stageLabel.technical;
            document.getElementById('timeline-stage-label').textContent = stageLabel;
          }
        } else {
          state.timelineActive = false;
          var lang = LANG[state.languageMode];
          document.getElementById('timeline-stage-label').textContent = lang.timelinePrompt;
        }

        // Restore stars to non-evolved positions
        if (state.sortState === 'hr-diagram') {
          stars.forEach(function(s) {
            s.currentPosition.x = s.hrPosition.x;
            s.currentPosition.y = s.hrPosition.y;
          });
        } else if (state.sortState === 'sort-brightness') {
          animateSortByBrightness(true);
        } else if (state.sortState === 'sort-colour') {
          animateSortByColour(true);
        }

        updateTimelineModeButtons();
        needsRedraw = true;
      });

      // Log/Linear time scale toggle
      var timeScaleBtn = document.getElementById('btn-time-scale');
      // Start with log scale active
      timeScaleBtn.classList.add('active');
      timeScaleBtn.setAttribute('aria-pressed', 'true');

      timeScaleBtn.addEventListener('click', function() {
        state.timelineLogScale = !state.timelineLogScale;
        timeScaleBtn.classList.toggle('active', state.timelineLogScale);
        timeScaleBtn.setAttribute('aria-pressed', state.timelineLogScale ? 'true' : 'false');
        timeScaleBtn.textContent = state.timelineLogScale ? 'Log' : 'Linear';
        timeScaleBtn.title = state.timelineLogScale
          ? 'Logarithmic time: more detail for short-lived stages. Click for linear.'
          : 'Linear time: uniform time scale. Click for logarithmic.';
        showToast(state.timelineLogScale
          ? 'Log time scale: more detail for short stages'
          : 'Linear time scale: uniform time progression');
      });

      // Load saved preferences
      try {
        var savedPrefs = localStorage.getItem('hr-diagram-prefs');
        if (savedPrefs) {
          var prefs = JSON.parse(savedPrefs);
          if (prefs.theme && prefs.theme !== state.theme) {
            toggleTheme();
          }
          if (prefs.languageMode) {
            setLanguageMode(prefs.languageMode);
          }
          state.isFirstRun = false;
        }
      } catch(e) { /* ignore */ }

      // Save preferences on changes
      window.addEventListener('beforeunload', savePrefs);
      document.addEventListener('visibilitychange', function() {
        if (document.visibilityState === 'hidden') savePrefs();
      });

      // Set active view button
      setViewMode('hr-diagram');

      // First-run onboarding
      if (state.isFirstRun) {
        setTimeout(function() {
          toggleHelp();
          state.isFirstRun = false;
          savePrefs();
        }, 500);
      }

      // Start render loop
      requestAnimationFrame(animationLoop);
    }

    function savePrefs() {
      try {
        localStorage.setItem('hr-diagram-prefs', JSON.stringify({
          theme: state.theme,
          languageMode: state.languageMode,
          settings: state.settings,
        }));
      } catch(e) { /* quota exceeded or disabled */ }
    }

    function buildSRStarList() {
      var container = document.getElementById('star-list-sr');
      container.innerHTML = '';
      STAR_DATA.forEach(function(star) {
        var btn = document.createElement('button');
        btn.setAttribute('role', 'listitem');
        btn.textContent = star.name + ' - ' + LANG.simple.stages[star.stage];
        btn.addEventListener('click', function() { selectStar(star.id); });
        container.appendChild(btn);
      });
    }

    // Start when DOM is ready
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', init);
    } else {
      init();
    }

  </script>
</body>
</html>
