<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chord Progression Probability Explorer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            color: #fff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        h1 {
            text-align: center;
            margin-bottom: 30px;
            font-size: 2.5em;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .controls {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
            align-items: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        select, button {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        select {
            background: rgba(255,255,255,0.2);
            color: white;
            backdrop-filter: blur(5px);
        }

        select option {
            background: #2a5298;
        }

        button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            font-weight: bold;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.3);
        }

        button:active {
            transform: translateY(0);
        }

        .current-chord {
            background: rgba(255,255,255,0.2);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 30px;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .current-chord h2 {
            font-size: 3em;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
        }

        .chord-notes {
            font-size: 1.2em;
            opacity: 0.8;
            display: flex;
            justify-content: center;
            gap: 20px;
            margin-top: 15px;
        }

        .voice-note {
            background: rgba(255,255,255,0.1);
            padding: 8px 16px;
            border-radius: 8px;
            backdrop-filter: blur(5px);
        }

        .voice-label {
            font-size: 0.8em;
            opacity: 0.7;
            display: block;
        }

        .note-value {
            font-weight: bold;
            font-size: 1.1em;
        }

        .chord-option.playing {
            animation: pulse 0.5s ease;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .progression-chord {
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            animation: slideIn 0.3s ease;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .progression-chord:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }

        .voice-movement {
            margin-top: 20px;
            padding: 20px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
        }

        .voice-movement h4 {
            margin-bottom: 15px;
            opacity: 0.9;
        }

        .voice-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 15px;
        }

        .voice-name {
            width: 80px;
            font-weight: bold;
            opacity: 0.8;
        }

        .voice-progression {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .voice-note-item {
            background: rgba(255,255,255,0.15);
            padding: 5px 12px;
            border-radius: 5px;
            font-size: 0.9em;
        }

        .next-chords {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .next-chords h3 {
            margin-bottom: 20px;
            font-size: 1.5em;
        }

        .chord-options {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
        }

        .chord-option {
            background: rgba(255,255,255,0.1);
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 10px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .chord-option:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0,0,0,0.2);
        }

        .chord-name {
            font-size: 1.3em;
            font-weight: bold;
            margin-bottom: 5px;
        }

        .probability {
            font-size: 1.1em;
            opacity: 0.8;
        }

        .probability-bar {
            height: 6px;
            background: rgba(255,255,255,0.2);
            border-radius: 3px;
            margin-top: 8px;
            overflow: hidden;
        }

        .probability-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 0.3s ease;
            border-radius: 3px;
        }

        .progression-display {
            background: rgba(255,255,255,0.1);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
        }

        .progression-display h3 {
            margin-bottom: 15px;
            font-size: 1.5em;
        }

        .progression-sequence {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            min-height: 50px;
            padding: 15px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            align-items: center;
        }

        .progression-chord {
            background: rgba(255,255,255,0.2);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 1.1em;
            font-weight: bold;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-20px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .arrow {
            opacity: 0.5;
            font-size: 1.2em;
        }

        .filter-controls {
            margin-bottom: 15px;
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .threshold-slider {
            width: 200px;
        }

        .loading {
            text-align: center;
            padding: 50px;
            font-size: 1.2em;
        }

        .error {
            background: rgba(244, 67, 54, 0.2);
            border: 2px solid #f44336;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            margin: 20px 0;
        }

        @media (max-width: 768px) {
            .controls {
                flex-direction: column;
                align-items: stretch;
            }
            
            .chord-options {
                grid-template-columns: 1fr 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üéµ Chord Progression Probability Explorer</h1>
        <p style="text-align: center; opacity: 0.8; margin-bottom: 20px;">
            Four-voice SATB harmony with smooth voice leading ‚Ä¢ Hover over options to preview ‚Ä¢ Click progression chords to replay
        </p>
        
        <div class="controls">
            <div class="control-group">
                <label for="genre">Genre</label>
                <select id="genre">
                    <option value="classical">Classical</option>
                    <option value="jazz">Jazz</option>
                    <option value="popular" selected>Popular</option>
                </select>
            </div>
            
            <div class="control-group">
                <label for="keyType">Key Type</label>
                <select id="keyType">
                    <option value="major" selected>Major</option>
                    <option value="minor">Minor</option>
                </select>
            </div>
            
            <button id="resetBtn">üîÑ Reset</button>
            <button id="randomWalkBtn">üé≤ Random Walk (8 chords)</button>
            <button id="playBtn">‚ñ∂Ô∏è Play Progression (4 Voices)</button>
            <button id="exportBtn">üì• Export</button>
        </div>

        <div class="current-chord">
            <h2 id="currentChordDisplay">I</h2>
            <div class="chord-notes" id="chordNotes">
                <div class="voice-note">
                    <span class="voice-label">Bass</span>
                    <span class="note-value">C3</span>
                </div>
                <div class="voice-note">
                    <span class="voice-label">Tenor</span>
                    <span class="note-value">E4</span>
                </div>
                <div class="voice-note">
                    <span class="voice-label">Alto</span>
                    <span class="note-value">G4</span>
                </div>
                <div class="voice-note">
                    <span class="voice-label">Soprano</span>
                    <span class="note-value">C5</span>
                </div>
            </div>
        </div>

        <div class="next-chords">
            <h3>Next Chord Options</h3>
            <div class="filter-controls">
                <label>Min Probability: <span id="thresholdValue">0%</span></label>
                <input type="range" class="threshold-slider" id="threshold" min="0" max="50" value="0">
                <button id="showAllBtn">Show All</button>
            </div>
            <div class="chord-options" id="chordOptions">
                <div class="loading">Loading chord data...</div>
            </div>
        </div>

        <div class="progression-display">
            <h3>Your Progression</h3>
            <div class="progression-sequence" id="progressionSequence">
                <div class="progression-chord">I</div>
            </div>
            <div style="margin-top: 15px;">
                <button id="undoBtn">‚Ü©Ô∏è Undo</button>
                <button id="clearBtn">üóëÔ∏è Clear All</button>
                <button id="toggleVoicesBtn">üëÅÔ∏è Show Voice Movement</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/tone/14.8.49/Tone.js"></script>
    <script>
        let chordData = null;
        let currentGenre = 'popular';
        let currentKeyType = 'major';
        let currentChord = 'I';
        let progression = ['I'];
        let showVoiceMovement = false;

        // Four-voice SATB chord voicings (in C major/A minor)
        // Format: [Bass, Tenor, Alto, Soprano]
        const chordVoicings = {
            // Major key chords - Root position
            'I': ['C3', 'E4', 'G4', 'C5'],
            'ii': ['D3', 'F4', 'A4', 'D5'],
            'iii': ['E3', 'G4', 'B4', 'E5'],
            'IV': ['F3', 'A4', 'C5', 'F5'],
            'V': ['G3', 'B4', 'D5', 'G5'],
            'vi': ['A3', 'C5', 'E5', 'A5'],
            'vii¬∞': ['B3', 'D4', 'F4', 'B4'],
            
            // First inversions
            'I‚Å∂': ['E3', 'G4', 'C5', 'E5'],
            'ii‚Å∂': ['F3', 'A4', 'D5', 'F5'],
            'iii‚Å∂': ['G3', 'B4', 'E5', 'G5'],
            'IV‚Å∂': ['A3', 'C5', 'F5', 'A5'],
            'V‚Å∂': ['B3', 'D5', 'G5', 'B5'],
            'vi‚Å∂': ['C4', 'E5', 'A5', 'C6'],
            'vii¬∞‚Å∂': ['D4', 'F4', 'B4', 'D5'],
            
            // Second inversions
            'I‚Å∂‚ÇÑ': ['G3', 'C5', 'E5', 'G5'],
            'ii‚Å∂‚ÇÑ': ['A3', 'D5', 'F5', 'A5'],
            'iii‚Å∂‚ÇÑ': ['B3', 'E5', 'G5', 'B5'],
            'IV‚Å∂‚ÇÑ': ['C4', 'F5', 'A5', 'C6'],
            'V‚Å∂‚ÇÑ': ['D4', 'G5', 'B5', 'D6'],
            'vi‚Å∂‚ÇÑ': ['E4', 'A5', 'C6', 'E6'],
            'vii¬∞‚Å∂‚ÇÑ': ['F4', 'B4', 'D5', 'F5'],
            
            // Seventh chords
            'ii‚Å∑': ['D3', 'F4', 'A4', 'C5'],
            'ii‚Å∂‚ÇÖ': ['F3', 'A4', 'C5', 'D5'],
            'ii‚Å¥‚ÇÉ': ['A3', 'C5', 'D5', 'F5'],
            'ii‚Å¥‚ÇÇ': ['C4', 'D5', 'F5', 'A5'],
            'V‚Å∑': ['G3', 'B4', 'D5', 'F5'],
            'V‚Å∂‚ÇÖ': ['B3', 'D5', 'F5', 'G5'],
            'V‚Å¥‚ÇÉ': ['D4', 'F5', 'G5', 'B5'],
            'V‚Å¥‚ÇÇ': ['F4', 'G5', 'B5', 'D6'],
            'vii√∏‚Å∑': ['B3', 'D4', 'F4', 'A4'],
            'vii√∏‚Å∂‚ÇÖ': ['D4', 'F4', 'A4', 'B4'],
            'vii√∏‚Å¥‚ÇÉ': ['F4', 'A4', 'B4', 'D5'],
            'vii√∏‚Å¥‚ÇÇ': ['A3', 'B4', 'D5', 'F5'],
            
            // Borrowed chords
            'bVII': ['Bb3', 'D5', 'F5', 'Bb5'],
            'bVI': ['Ab3', 'C5', 'Eb5', 'Ab5'],
            'bIII': ['Eb3', 'G4', 'Bb4', 'Eb5'],
            'II': ['D3', 'F#4', 'A4', 'D5'],
            'II‚Å∑': ['D3', 'F#4', 'A4', 'C5'],
            'III': ['E3', 'G#4', 'B4', 'E5'],
            'III‚Å∑': ['E3', 'G#4', 'B4', 'D5'],
            'VI': ['A3', 'C#5', 'E5', 'A5'],
            'VI‚Å∑': ['A3', 'C#5', 'E5', 'G5'],
            
            // Minor key chords
            'i': ['A3', 'C5', 'E5', 'A5'],
            'i‚Å∂': ['C4', 'E5', 'A5', 'C6'],
            'i‚Å∂‚ÇÑ': ['E4', 'A5', 'C6', 'E6'],
            'ii¬∞': ['B3', 'D5', 'F5', 'B5'],
            'ii¬∞‚Å∂': ['D4', 'F5', 'B5', 'D6'],
            'ii¬∞‚Å∂‚ÇÑ': ['F4', 'B5', 'D6', 'F6'],
            'ii√∏‚Å∑': ['B3', 'D5', 'F5', 'A5'],
            'ii√∏‚Å∂‚ÇÖ': ['D4', 'F5', 'A5', 'B5'],
            'III': ['C4', 'E5', 'G5', 'C6'],
            'III‚Å∂': ['E4', 'G5', 'C6', 'E6'],
            'iv': ['D4', 'F5', 'A5', 'D6'],
            'iv‚Å∂': ['F4', 'A5', 'D6', 'F6'],
            'v': ['E4', 'G5', 'B5', 'E6'],
            'v‚Å∂': ['G4', 'B5', 'E6', 'G6'],
            'VI': ['F4', 'A5', 'C6', 'F6'],
            'VI‚Å∂': ['A4', 'C6', 'F6', 'A6'],
            'VII': ['G4', 'B5', 'D6', 'G6'],
            'VII‚Å∂': ['B4', 'D6', 'G6', 'B6'],
            'vii¬∞': ['G#4', 'B5', 'D6', 'G#6'],
            'vii¬∞‚Å∂': ['B4', 'D6', 'G#6', 'B6'],
            'vii¬∞‚Å∑': ['G#4', 'B5', 'D6', 'F6'],
            
            // Jazz voicings (rootless voicings for some)
            'Imaj7': ['E3', 'G4', 'B4', 'C5'],
            'Imaj9': ['E3', 'G4', 'B4', 'D5'],
            'I6': ['C3', 'E4', 'G4', 'A4'],
            'I6/9': ['C3', 'E4', 'A4', 'D5'],
            'iim7': ['F3', 'A4', 'C5', 'D5'],
            'iim9': ['F3', 'A4', 'C5', 'E5'],
            'iiim7': ['G3', 'B4', 'D5', 'E5'],
            'IVmaj7': ['A3', 'C5', 'E5', 'F5'],
            'IVmaj9': ['A3', 'C5', 'E5', 'G5'],
            'V7': ['B3', 'D5', 'F5', 'G5'],
            'V9': ['B3', 'D5', 'F5', 'A5'],
            'V7sus': ['G3', 'C5', 'D5', 'F5'],
            'V13': ['B3', 'E5', 'F5', 'A5'],
            'vim7': ['C4', 'E5', 'G5', 'A5'],
            'vim9': ['C4', 'E5', 'G5', 'B5'],
            'viim7‚ô≠5': ['D4', 'F5', 'A5', 'B5'],
            'bII7': ['Db3', 'F4', 'Ab4', 'B4'],
            'bIImaj7': ['Db3', 'F4', 'Ab4', 'C5'],
            '#IVm7‚ô≠5': ['F#3', 'A4', 'C5', 'E5'],
            '#IV¬∞7': ['F#3', 'A4', 'C5', 'Eb5'],
            'bVIImaj7': ['Bb3', 'D5', 'F5', 'A5'],
            
            // Minor jazz
            'im7': ['C4', 'Eb5', 'G5', 'A5'],
            'im9': ['C4', 'Eb5', 'G5', 'B5'],
            'im6': ['A3', 'C5', 'E5', 'F#5'],
            'im(maj7)': ['A3', 'C5', 'E5', 'G#5'],
            'iim7‚ô≠5': ['D4', 'F5', 'A5', 'B5'],
            'iim7‚ô≠5(9)': ['D4', 'F5', 'A5', 'C6'],
            'IIImaj7': ['E4', 'G5', 'B5', 'C6'],
            'IIImaj9': ['E4', 'G5', 'B5', 'D6'],
            'ivm7': ['F4', 'A5', 'C6', 'D6'],
            'ivm9': ['F4', 'A5', 'C6', 'E6'],
            'V7alt': ['B3', 'D#5', 'F5', 'G5'],
            'V7‚ô≠9': ['B3', 'D5', 'F5', 'Gb5'],
            'VImaj7': ['A4', 'C6', 'E6', 'F6'],
            'VImaj9': ['A4', 'C6', 'E6', 'G6'],
            'VIIm7‚ô≠5': ['B4', 'D6', 'F6', 'G6']
        };

        // Voice names for display
        const voiceNames = ['Bass', 'Tenor', 'Alto', 'Soprano'];

        // Initialize Tone.js with four separate voices
        let voices = {
            bass: null,
            tenor: null,
            alto: null,
            soprano: null
        };

        async function initAudio() {
            await Tone.start();
            
            // Create four distinct synthesizers for each voice
            voices.bass = new Tone.Synth({
                oscillator: { type: 'sine' },
                envelope: { attack: 0.1, decay: 0.3, sustain: 0.7, release: 1 }
            }).toDestination();
            voices.bass.volume.value = -12;
            
            voices.tenor = new Tone.Synth({
                oscillator: { type: 'triangle' },
                envelope: { attack: 0.1, decay: 0.3, sustain: 0.6, release: 1 }
            }).toDestination();
            voices.tenor.volume.value = -14;
            
            voices.alto = new Tone.Synth({
                oscillator: { type: 'sawtooth' },
                envelope: { attack: 0.15, decay: 0.3, sustain: 0.5, release: 1 }
            }).toDestination();
            voices.alto.volume.value = -16;
            
            voices.soprano = new Tone.Synth({
                oscillator: { type: 'sine' },
                envelope: { attack: 0.05, decay: 0.2, sustain: 0.6, release: 0.8 }
            }).toDestination();
            voices.soprano.volume.value = -14;
        }

        // Get chord notes for display
        function getChordNotes(chord) {
            const voicing = chordVoicings[chord];
            if (!voicing) return chordVoicings['I']; // Default fallback
            return voicing;
        }

        // Load chord data
        async function loadChordData() {
            try {
                const response = await fetch('progression probabilities.json');
                if (!response.ok) {
                    throw new Error('Failed to load chord data');
                }
                chordData = await response.json();
                updateDisplay();
            } catch (error) {
                console.error('Error loading chord data:', error);
                document.getElementById('chordOptions').innerHTML = 
                    '<div class="error">Error loading chord data. Please ensure "progression probabilities.json" is in the same directory.</div>';
            }
        }

        // Update the display based on current state
        function updateDisplay() {
            if (!chordData) return;
            
            // Update current chord display
            document.getElementById('currentChordDisplay').textContent = currentChord;
            
            // Update chord notes display with four voices
            const notes = getChordNotes(currentChord);
            const noteDisplay = notes.map((note, i) => `
                <div class="voice-note">
                    <span class="voice-label">${voiceNames[i]}</span>
                    <span class="note-value">${note}</span>
                </div>
            `).join('');
            document.getElementById('chordNotes').innerHTML = noteDisplay;
            
            // Get next chord options
            const genreData = chordData[currentGenre];
            if (!genreData) return;
            
            const keyData = genreData[currentKeyType];
            if (!keyData) return;
            
            const currentChordData = keyData[currentChord];
            if (!currentChordData) return;
            
            // Display next chord options
            displayChordOptions(currentChordData);
            
            // Update progression display
            updateProgressionDisplay();
        }

        // Display chord options with probabilities
        function displayChordOptions(chordProbabilities) {
            const container = document.getElementById('chordOptions');
            const threshold = document.getElementById('threshold').value / 100;
            
            // Convert to array and sort by probability
            const chords = Object.entries(chordProbabilities)
                .filter(([chord, prob]) => prob >= threshold)
                .sort((a, b) => b[1] - a[1]);
            
            if (chords.length === 0) {
                container.innerHTML = '<div style="grid-column: 1/-1; text-align: center; opacity: 0.7;">No chords meet the threshold. Lower the minimum probability.</div>';
                return;
            }
            
            container.innerHTML = chords.map(([chord, probability]) => {
                const percentage = (probability * 100).toFixed(1);
                const color = getColorForProbability(probability);
                
                return `
                    <div class="chord-option" 
                         onclick="selectChord('${chord}')" 
                         onmouseenter="previewChord('${chord}')"
                         style="border-color: ${color}">
                        <div class="chord-name">${chord}</div>
                        <div class="probability">${percentage}%</div>
                        <div class="probability-bar">
                            <div class="probability-fill" style="width: ${percentage}%; background: ${color}"></div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Get color based on probability
        function getColorForProbability(probability) {
            if (probability > 0.3) return '#4CAF50';
            if (probability > 0.15) return '#FFC107';
            if (probability > 0.08) return '#FF9800';
            return '#9E9E9E';
        }

        // Select a chord and add to progression
        function selectChord(chord) {
            currentChord = chord;
            progression.push(chord);
            updateDisplay();
        }

        // Preview chord on hover
        function previewChord(chord) {
            // Visual feedback
            event.target.closest('.chord-option').classList.add('playing');
            setTimeout(() => {
                event.target.closest('.chord-option').classList.remove('playing');
            }, 500);
            
            // Play the chord
            playChord(chord);
        }

        // Update progression display with clickable chords
        function updateProgressionDisplay() {
            const container = document.getElementById('progressionSequence');
            container.innerHTML = progression.map((chord, index) => {
                const html = `<div class="progression-chord" onclick="playChord('${chord}')" title="Click to play">${chord}</div>`;
                if (index < progression.length - 1) {
                    return html + '<div class="arrow">‚Üí</div>';
                }
                return html;
            }).join('');
            
            // Update voice movement display
            updateVoiceMovement();
        }

        // Display voice movement through the progression
        function updateVoiceMovement() {
            const progressionDisplay = document.querySelector('.progression-display');
            const existingVoiceMovement = progressionDisplay.querySelector('.voice-movement');
            
            if (!showVoiceMovement || progression.length <= 1) {
                if (existingVoiceMovement) {
                    existingVoiceMovement.remove();
                }
                return;
            }
            
            const voiceMovementHtml = `
                <div class="voice-movement">
                    <h4>Voice Movement</h4>
                    ${voiceNames.map((voice, voiceIndex) => {
                        const voiceNotes = progression.map(chord => {
                            const notes = getChordNotes(chord);
                            return notes[voiceIndex];
                        });
                        
                        return `
                            <div class="voice-row">
                                <div class="voice-name">${voice}:</div>
                                <div class="voice-progression">
                                    ${voiceNotes.map((note, i) => {
                                        const html = `<div class="voice-note-item">${note}</div>`;
                                        if (i < voiceNotes.length - 1) {
                                            return html + '<div class="arrow" style="opacity: 0.5;">‚Üí</div>';
                                        }
                                        return html;
                                    }).join('')}
                                </div>
                            </div>
                        `;
                    }).join('')}
                </div>
            `;
            
            if (existingVoiceMovement) {
                existingVoiceMovement.outerHTML = voiceMovementHtml;
            } else {
                progressionDisplay.insertAdjacentHTML('beforeend', voiceMovementHtml);
            }
        }

        // Random walk
        function randomWalk() {
            const steps = 8;
            progression = [currentChord];
            
            for (let i = 1; i < steps; i++) {
                const genreData = chordData[currentGenre];
                const keyData = genreData[currentKeyType];
                const currentChordData = keyData[currentChord];
                
                if (!currentChordData) break;
                
                // Weighted random selection
                const random = Math.random();
                let sum = 0;
                
                for (const [chord, probability] of Object.entries(currentChordData)) {
                    sum += probability;
                    if (random <= sum) {
                        currentChord = chord;
                        progression.push(chord);
                        break;
                    }
                }
            }
            
            updateDisplay();
        }

        // Play progression with smooth voice leading
        async function playProgression() {
            if (!voices.bass) await initAudio();
            
            const now = Tone.now();
            const duration = 0.6; // Duration between chords
            
            progression.forEach((chord, index) => {
                const notes = getChordNotes(chord);
                const time = now + index * duration;
                
                // Play each voice separately for better voice leading
                voices.bass.triggerAttackRelease(notes[0], '2n', time);
                voices.tenor.triggerAttackRelease(notes[1], '2n', time);
                voices.alto.triggerAttackRelease(notes[2], '2n', time);
                voices.soprano.triggerAttackRelease(notes[3], '2n', time);
            });
        }

        // Play a single chord (for preview)
        async function playChord(chord) {
            if (!voices.bass) await initAudio();
            
            const notes = getChordNotes(chord);
            const now = Tone.now();
            
            voices.bass.triggerAttackRelease(notes[0], '2n', now);
            voices.tenor.triggerAttackRelease(notes[1], '2n', now);
            voices.alto.triggerAttackRelease(notes[2], '2n', now);
            voices.soprano.triggerAttackRelease(notes[3], '2n', now);
        }

        // Event listeners
        document.getElementById('genre').addEventListener('change', (e) => {
            currentGenre = e.target.value;
            currentChord = currentGenre === 'jazz' ? 
                (currentKeyType === 'major' ? 'Imaj7' : 'im7') : 
                (currentKeyType === 'major' ? 'I' : 'i');
            progression = [currentChord];
            updateDisplay();
        });

        document.getElementById('keyType').addEventListener('change', (e) => {
            currentKeyType = e.target.value;
            currentChord = currentGenre === 'jazz' ? 
                (currentKeyType === 'major' ? 'Imaj7' : 'im7') : 
                (currentKeyType === 'major' ? 'I' : 'i');
            progression = [currentChord];
            updateDisplay();
        });

        document.getElementById('threshold').addEventListener('input', (e) => {
            document.getElementById('thresholdValue').textContent = e.target.value + '%';
            updateDisplay();
        });

        document.getElementById('showAllBtn').addEventListener('click', () => {
            document.getElementById('threshold').value = 0;
            document.getElementById('thresholdValue').textContent = '0%';
            updateDisplay();
        });

        document.getElementById('resetBtn').addEventListener('click', () => {
            currentChord = currentGenre === 'jazz' ? 
                (currentKeyType === 'major' ? 'Imaj7' : 'im7') : 
                (currentKeyType === 'major' ? 'I' : 'i');
            progression = [currentChord];
            updateDisplay();
        });

        document.getElementById('clearBtn').addEventListener('click', () => {
            progression = [currentChord];
            updateDisplay();
        });

        document.getElementById('undoBtn').addEventListener('click', () => {
            if (progression.length > 1) {
                progression.pop();
                currentChord = progression[progression.length - 1];
                updateDisplay();
            }
        });

        document.getElementById('randomWalkBtn').addEventListener('click', randomWalk);
        document.getElementById('playBtn').addEventListener('click', playProgression);

        document.getElementById('exportBtn').addEventListener('click', () => {
            let text = `Genre: ${currentGenre}\nKey: ${currentKeyType}\nProgression: ${progression.join(' - ')}\n\n`;
            
            // Add voice movement
            text += 'Voice Movement:\n';
            voiceNames.forEach((voice, voiceIndex) => {
                const voiceNotes = progression.map(chord => {
                    const notes = getChordNotes(chord);
                    return notes[voiceIndex];
                });
                text += `${voice}: ${voiceNotes.join(' ‚Üí ')}\n`;
            });
            
            const blob = new Blob([text], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'chord_progression_4voices.txt';
            a.click();
        });

        document.getElementById('toggleVoicesBtn').addEventListener('click', () => {
            showVoiceMovement = !showVoiceMovement;
            document.getElementById('toggleVoicesBtn').textContent = 
                showVoiceMovement ? 'üëÅÔ∏è Hide Voice Movement' : 'üëÅÔ∏è Show Voice Movement';
            updateVoiceMovement();
        });

        // Make functions available globally for onclick handlers
        window.selectChord = selectChord;
        window.previewChord = previewChord;
        window.playChord = playChord;

        // Initialize
        loadChordData();
        initAudio();
    </script>
</body>
</html>