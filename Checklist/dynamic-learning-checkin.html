<!DOCTYPE html>
<html lang="en" data-theme="light" data-version="1.0.0">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="description" content="Dynamic Learning Check-in - Track your understanding and growth through structured check-ins">
    <title>Dynamic Learning Check-in</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700;800&family=DM+Sans:wght@400;500;600&display=swap" rel="stylesheet">
    <style>
:root {
    /* Primary palette - Growth/Nature themed */
    --color-primary: #2d9d78;
    --color-primary-dark: #1e7d5e;
    --color-primary-light: #4db896;
    --color-primary-pale: #e8f5f0;
    
    /* Secondary - Warm accent */
    --color-secondary: #f59e0b;
    --color-secondary-dark: #d97706;
    --color-secondary-light: #fbbf24;
    
    /* Understanding levels */
    --level-1: #94a3b8;  /* Not started - Neutral grey */
    --level-2: #f97316;  /* Beginning - Orange */
    --level-3: #eab308;  /* Developing - Yellow */
    --level-4: #22c55e;  /* Confident - Green */
    --level-5: #8b5cf6;  /* Mastered - Purple star */
    
    /* Understanding levels - Light/pale backgrounds */
    --level-1-light: #f1f5f9;  /* Light grey */
    --level-2-light: #fff7ed;  /* Light orange */
    --level-3-light: #fefce8;  /* Light yellow */
    --level-4-light: #f0fdf4;  /* Light green */
    --level-5-light: #faf5ff;  /* Light purple */
    
    /* Backgrounds */
    --color-bg: #fafdf9;
    --color-bg-warm: #f0f7f4;
    --color-bg-card: #ffffff;
    --color-bg-hover: #e8f0ed;
    --color-bg-active: #d4e5de;
    
    /* Text */
    --color-text: #1e3a32;
    --color-text-secondary: #4a6358;
    --color-text-muted: #7a9088;
    --color-text-inverse: #ffffff;
    
    /* Borders */
    --color-border: #d4e5de;
    --color-border-light: #e8f0ed;
    --color-border-focus: var(--color-primary);
    
    /* Status colors */
    --color-success: #22c55e;
    --color-success-bg: #dcfce7;
    --color-warning: #f59e0b;
    --color-warning-bg: #fef3c7;
    --color-info: #3b82f6;
    --color-info-bg: #dbeafe;
    --color-error: #ef4444;
    --color-error-bg: #fee2e2;
    
    /* Spacing - Compact */
    --space-1: 0.125rem;
    --space-2: 0.25rem;
    --space-3: 0.375rem;
    --space-4: 0.5rem;
    --space-5: 0.75rem;
    --space-6: 1rem;
    --space-7: 1.25rem;
    --space-8: 1.5rem;
    --space-9: 2rem;
    --space-10: 2.5rem;
    
    /* Typography */
    --font-display: 'Nunito', -apple-system, BlinkMacSystemFont, sans-serif;
    --font-body: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
    --text-xs: 0.75rem;
    --text-sm: 0.85rem;
    --text-base: 0.95rem;
    --text-lg: 1.05rem;
    --text-xl: 1.2rem;
    --text-2xl: 1.4rem;
    --text-3xl: 1.75rem;
    --line-height-tight: 1.25;
    --line-height-normal: 1.5;
    --line-height-relaxed: 1.65;
    
    /* Effects */
    --shadow-sm: 0 1px 2px rgba(30, 58, 50, 0.04);
    --shadow-md: 0 4px 8px rgba(30, 58, 50, 0.06), 0 2px 4px rgba(30, 58, 50, 0.04);
    --shadow-lg: 0 12px 24px rgba(30, 58, 50, 0.1), 0 4px 8px rgba(30, 58, 50, 0.05);
    --shadow-focus: 0 0 0 3px rgba(45, 157, 120, 0.25);
    
    /* Borders */
    --radius-sm: 6px;
    --radius-md: 10px;
    --radius-lg: 14px;
    --radius-xl: 20px;
    --radius-full: 9999px;
    
    /* Transitions */
    --transition-fast: 0.15s ease;
    --transition-normal: 0.25s ease;
    --transition-slow: 0.4s ease;
    --transition-bounce: 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
}

[data-theme="dark"] {
    --color-primary: #4db896;
    --color-primary-dark: #2d9d78;
    --color-primary-light: #6fcfaa;
    --color-primary-pale: #1a2f28;
    
    --color-bg: #0f1a16;
    --color-bg-warm: #162420;
    --color-bg-card: #1c2d27;
    --color-bg-hover: #243832;
    --color-bg-active: #2d453d;
    
    --color-text: #e8f5f0;
    --color-text-secondary: #a8c4ba;
    --color-text-muted: #6b8f82;
    
    --color-border: #2d453d;
    --color-border-light: #243832;
    
    --color-success-bg: #14301e;
    --color-warning-bg: #302814;
    --color-info-bg: #142030;
    --color-error-bg: #301414;
    
    --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.2);
    --shadow-md: 0 4px 8px rgba(0, 0, 0, 0.25), 0 2px 4px rgba(0, 0, 0, 0.15);
    --shadow-lg: 0 12px 24px rgba(0, 0, 0, 0.3), 0 4px 8px rgba(0, 0, 0, 0.2);
    
    /* Adjusted purple for dark mode - less saturated with glow */
    --level-5: #a78bfa;
    --level-5-light: #2d2640;
}

/* Dark mode purple text glow */
[data-theme="dark"] .level-notch[data-level="5"],
[data-theme="dark"] .level-segment[data-level="5"],
[data-theme="dark"] .level-was-value[data-level="5"],
[data-theme="dark"] [style*="var(--level-5)"] {
    text-shadow: 0 0 8px rgba(255, 255, 255, 0.3), 0 0 2px rgba(255, 255, 255, 0.2);
}

[data-theme="dark"] .level-notch.active[data-level="5"] {
    box-shadow: 0 0 8px rgba(167, 139, 250, 0.4), 0 0 2px rgba(255, 255, 255, 0.2);
}

/* Reset */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html { 
    font-size: 16px; 
    scroll-behavior: smooth;
    height: 100%;
}

@media (prefers-reduced-motion: reduce) {
    html { scroll-behavior: auto; }
    *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
    }
}

body {
    font-family: var(--font-body);
    font-size: var(--text-base);
    line-height: var(--line-height-normal);
    color: var(--color-text);
    background: var(--color-bg);
    min-height: 100vh;
    min-height: 100dvh;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

/* Accessibility */
.skip-link {
    position: absolute;
    top: -100%;
    left: var(--space-4);
    padding: var(--space-3) var(--space-5);
    background: var(--color-primary);
    color: var(--color-text-inverse);
    border-radius: var(--radius-md);
    text-decoration: none;
    font-weight: 600;
    z-index: 10000;
    transition: top var(--transition-fast);
}
.skip-link:focus { top: var(--space-4); outline: none; }

:focus-visible {
    outline: 2px solid var(--color-border-focus);
    outline-offset: 2px;
}

.sr-only {
    position: absolute;
    width: 1px;
    height: 1px;
    padding: 0;
    margin: -1px;
    overflow: hidden;
    clip: rect(0, 0, 0, 0);
    white-space: nowrap;
    border: 0;
}

/* App Layout */
.app-container {
    display: flex;
    flex-direction: column;
    min-height: 100vh;
    min-height: 100dvh;
}

/* Header */
.app-header {
    background: linear-gradient(135deg, var(--color-primary-dark) 0%, var(--color-primary) 50%, #3aa882 100%);
    color: var(--color-text-inverse);
    padding: var(--space-3) var(--space-4);
    position: sticky;
    top: 0;
    z-index: 100;
    box-shadow: var(--shadow-md);
}

/* Topic Selector Bar */
.topic-selector-bar {
    background: var(--color-bg-warm);
    border-bottom: 1px solid var(--color-border);
    padding: var(--space-2) var(--space-4);
}

.topic-selector-content {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    gap: var(--space-3);
    flex-wrap: wrap;
}

.topic-selector-label {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    font-weight: 600;
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

.topic-selector-dropdowns {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    flex-wrap: wrap;
    flex: 1;
}

.topic-dropdown {
    padding: var(--space-2) var(--space-3);
    padding-right: var(--space-5);
    font-size: var(--text-sm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    background: var(--color-bg-card);
    color: var(--color-text);
    cursor: pointer;
    min-width: 140px;
    appearance: none;
    background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236b7280' d='M2 4l4 4 4-4'/%3E%3C/svg%3E");
    background-repeat: no-repeat;
    background-position: right 10px center;
}

.topic-dropdown:hover {
    border-color: var(--color-primary);
}

.topic-dropdown:focus {
    outline: none;
    border-color: var(--color-primary);
    box-shadow: 0 0 0 2px var(--color-primary-pale);
}

.topic-dropdown:disabled {
    opacity: 0.5;
    cursor: not-allowed;
    background-color: var(--color-bg-warm);
}

.topic-dropdown-separator {
    color: var(--color-text-muted);
    font-size: var(--text-sm);
}

.topic-current-display {
    margin-left: auto;
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.topic-current-name {
    font-weight: 600;
    color: var(--color-text);
}

.topic-loading-indicator {
    display: none;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-xs);
    color: var(--color-text-muted);
}

.topic-loading-indicator.active {
    display: flex;
}

.topic-loading-spinner {
    width: 14px;
    height: 14px;
    border: 2px solid var(--color-border);
    border-top-color: var(--color-primary);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
}

@keyframes spin {
    to { transform: rotate(360deg); }
}

.header-content {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-3);
    flex-wrap: wrap;
}

.app-title {
    font-family: var(--font-display);
    font-size: var(--text-lg);
    font-weight: 800;
    letter-spacing: -0.02em;
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.app-title-icon {
    font-size: 1.2rem;
    animation: float 3s ease-in-out infinite;
}

@keyframes float {
    0%, 100% { transform: translateY(0); }
    50% { transform: translateY(-2px); }
}

.header-actions {
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.header-btn {
    background: rgba(255, 255, 255, 0.15);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: var(--color-text-inverse);
    padding: var(--space-1) var(--space-3);
    border-radius: var(--radius-md);
    cursor: pointer;
    font-size: var(--text-xs);
    font-weight: 600;
    font-family: var(--font-body);
    transition: all var(--transition-fast);
    min-height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-2);
}

.header-btn:hover { background: rgba(255, 255, 255, 0.25); }
.header-btn:disabled { opacity: 0.4; cursor: not-allowed; }

.student-info {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    background: rgba(255, 255, 255, 0.1);
    padding: var(--space-2) var(--space-4);
    border-radius: var(--radius-full);
    font-size: var(--text-sm);
}

.student-avatar {
    width: 28px;
    height: 28px;
    background: rgba(255, 255, 255, 0.3);
    border-radius: var(--radius-full);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--text-base);
}

/* Sub Navigation */
.sub-nav {
    background: var(--color-bg-card);
    border-bottom: 1px solid var(--color-border);
    padding: 0 var(--space-4);
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
}

.sub-nav::-webkit-scrollbar { display: none; }

.sub-nav-content {
    max-width: 1200px;
    margin: 0 auto;
    display: flex;
    gap: var(--space-1);
}

.nav-tab {
    background: transparent;
    border: none;
    padding: var(--space-2) var(--space-3);
    font-family: var(--font-display);
    font-size: var(--text-xs);
    font-weight: 600;
    color: var(--color-text-muted);
    cursor: pointer;
    position: relative;
    transition: color var(--transition-fast);
    white-space: nowrap;
    min-height: 36px;
    display: flex;
    align-items: center;
    gap: var(--space-1);
}

.nav-tab:hover { color: var(--color-text); }

.nav-tab[aria-selected="true"] { color: var(--color-primary); }

.nav-tab[aria-selected="true"]::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: var(--space-1);
    right: var(--space-1);
    height: 2px;
    background: var(--color-primary);
    border-radius: 2px 2px 0 0;
}

.nav-tab-icon { font-size: 1em; }

.nav-tab-badge {
    background: var(--color-primary);
    color: white;
    font-size: 10px;
    padding: 0 5px;
    border-radius: var(--radius-full);
    font-weight: 700;
}

/* Main Content */
.main-content {
    flex: 1;
    max-width: 1200px;
    width: 100%;
    margin: 0 auto;
    padding: var(--space-3);
}

/* Panel Content */
.panel-content {
    display: none;
    animation: fadeSlideIn var(--transition-normal);
}

.panel-content.active { display: block; }

@keyframes fadeSlideIn {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
}

/* Cards */
.card {
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--space-4);
    margin-bottom: var(--space-3);
    box-shadow: var(--shadow-sm);
    transition: box-shadow var(--transition-fast);
}

.card:hover { box-shadow: var(--shadow-md); }

.card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-3);
    gap: var(--space-2);
    flex-wrap: wrap;
}

.card-title {
    font-family: var(--font-display);
    font-size: var(--text-base);
    font-weight: 700;
    color: var(--color-text);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.card-title-icon { font-size: 1.1em; }

.card-subtitle {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    margin-top: var(--space-1);
}

/* Progress Overview Card */
.progress-overview {
    background: linear-gradient(135deg, var(--color-primary-pale) 0%, var(--color-bg-warm) 100%);
    border: 1px solid var(--color-primary);
    border-left: 4px solid var(--color-primary);
}

.progress-stats {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
    gap: var(--space-3);
    margin-top: var(--space-3);
}

.progress-stat {
    background: var(--color-bg-card);
    border-radius: var(--radius-md);
    padding: var(--space-3);
    text-align: center;
    border: 1px solid var(--color-border-light);
}

.progress-stat-value {
    font-family: var(--font-display);
    font-size: var(--text-3xl);
    font-weight: 800;
    color: var(--color-primary);
    line-height: 1;
}

.progress-stat-label {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    margin-top: var(--space-2);
    font-weight: 500;
}

.progress-bar-container {
    margin-top: var(--space-4);
}

.progress-bar-label {
    display: flex;
    justify-content: space-between;
    font-size: var(--text-sm);
    margin-bottom: var(--space-2);
}

.progress-bar {
    height: 12px;
    background: var(--color-bg-card);
    border-radius: var(--radius-full);
    overflow: hidden;
    border: 1px solid var(--color-border);
}

.progress-bar-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--color-primary) 0%, var(--color-success) 100%);
    border-radius: var(--radius-full);
    transition: width var(--transition-slow) ease-out;
    position: relative;
}

.progress-bar-fill::after {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    background: linear-gradient(90deg, transparent 0%, rgba(255,255,255,0.3) 50%, transparent 100%);
    animation: shimmer 2s infinite;
}

@keyframes shimmer {
    0% { transform: translateX(-100%); }
    100% { transform: translateX(100%); }
}

/* Topic Section */
.topic-section {
    margin-bottom: var(--space-3);
}

.topic-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-3);
    background: var(--color-bg-warm);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
    min-height: 44px;
}

.topic-header:hover { background: var(--color-bg-hover); }

.topic-header[aria-expanded="true"] {
    border-radius: var(--radius-md) var(--radius-md) 0 0;
    border-bottom-color: transparent;
}

.topic-header-left {
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.topic-icon {
    width: 28px;
    height: 28px;
    background: var(--color-primary-pale);
    border: 2px solid var(--color-primary);
    border-radius: var(--radius-sm);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--text-sm);
}

.topic-info {
    flex: 1;
}

.topic-title {
    font-family: var(--font-display);
    font-size: var(--text-sm);
    font-weight: 700;
    color: var(--color-text);
}

.topic-meta {
    font-size: 10px;
    color: var(--color-text-muted);
    display: flex;
    align-items: center;
    gap: var(--space-2);
    margin-top: 1px;
}

.topic-progress {
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.topic-progress-bar {
    width: 60px;
    height: 5px;
    background: var(--color-border);
    border-radius: var(--radius-full);
    overflow: hidden;
}

.topic-progress-fill {
    height: 100%;
    background: var(--color-primary);
    border-radius: var(--radius-full);
    transition: width var(--transition-normal);
}

.topic-progress-text {
    font-size: 10px;
    font-weight: 600;
    color: var(--color-primary);
    min-width: 30px;
}

.topic-toggle {
    font-size: var(--text-sm);
    color: var(--color-text-muted);
    transition: transform var(--transition-fast);
}

.topic-header[aria-expanded="true"] .topic-toggle {
    transform: rotate(180deg);
}

.topic-content {
    display: none;
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-top: none;
    border-radius: 0 0 var(--radius-md) var(--radius-md);
    padding: var(--space-2);
}

.topic-content.expanded { display: block; }

/* Learning Item */
.learning-item {
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-1);
    overflow: hidden;
    transition: box-shadow var(--transition-fast);
}

.learning-item:hover { box-shadow: var(--shadow-sm); }

.learning-item:last-child { margin-bottom: 0; }

/* Simple Learning Item (dropdown-based) */
.learning-item-simple {
    padding: var(--space-2) var(--space-3);
    border-bottom: 1px solid var(--color-border-light);
    transition: background var(--transition-fast);
}

.learning-item-simple:last-child {
    border-bottom: none;
}

.learning-item-simple:hover {
    background: var(--color-bg-hover);
}

/* Level-based left border indicator */
.learning-item-simple[data-level="1"] { border-left: 3px solid var(--level-1); }
.learning-item-simple[data-level="2"] { border-left: 3px solid var(--level-2); }
.learning-item-simple[data-level="3"] { border-left: 3px solid var(--level-3); }
.learning-item-simple[data-level="4"] { border-left: 3px solid var(--level-4); }
.learning-item-simple[data-level="5"] { border-left: 3px solid var(--level-5); }

/* New single-row layout */
.learning-item-row {
    display: flex;
    align-items: center;
    gap: var(--space-3);
}

.learning-item-left {
    flex: 1;
    min-width: 0;
    display: flex;
    flex-wrap: wrap;
    align-items: baseline;
    gap: var(--space-2);
}

.learning-item-title {
    font-size: var(--text-sm);
    font-weight: 500;
    color: var(--color-text);
    line-height: 1.3;
}

.learning-item-code {
    font-family: var(--font-mono);
    font-size: 10px;
    background: var(--color-bg-warm);
    padding: 0 4px;
    border-radius: var(--radius-xs);
    color: var(--color-text-muted);
    white-space: nowrap;
}

.help-toggle-inline {
    font-size: 10px;
    font-family: var(--font-body);
    color: var(--color-text);
    background: #fffde7;
    border: none;
    border-radius: var(--radius-xs);
    cursor: pointer;
    padding: 2px 6px;
    white-space: nowrap;
    box-shadow: 0 1px 3px rgba(255, 235, 59, 0.3);
}

[data-theme="dark"] .help-toggle-inline {
    background: rgba(255, 253, 231, 0.15);
    color: var(--color-text);
}

.help-toggle-inline:hover {
    background: #fff9c4;
    box-shadow: 0 1px 4px rgba(255, 235, 59, 0.5);
}

[data-theme="dark"] .help-toggle-inline:hover {
    background: rgba(255, 253, 231, 0.25);
}

.learning-item-updated {
    font-size: 10px;
    color: var(--color-text-muted);
    white-space: nowrap;
}

.learning-item-right {
    flex-shrink: 0;
}

/* Inline help content (expands below) */
.help-content-inline {
    display: none;
    padding-top: var(--space-2);
    font-size: var(--text-xs);
    color: var(--color-text-secondary);
    line-height: 1.4;
}

.help-content-inline.expanded {
    display: block;
}

.help-inline-item {
    display: block;
    margin-bottom: var(--space-3);
    padding: var(--space-2) var(--space-3);
    background: var(--color-bg-warm);
    border-radius: var(--radius-sm);
    border-left: 3px solid var(--color-primary);
}

.help-inline-item:last-child {
    margin-bottom: 0;
}

.help-inline-item strong {
    color: var(--color-text);
}

/* Check-in mode controls - two lines, Was and Now */
.level-controls-checkin {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 2px;
}

.level-was {
    font-size: 10px;
    color: var(--color-text-muted);
    white-space: nowrap;
}

.level-was-value {
    font-weight: 500;
    padding: 1px 5px;
    border-radius: var(--radius-xs);
    color: var(--color-text-secondary);
}

/* Was value background colors based on level */
.level-was-value[data-level="1"] { background: var(--level-1-light); border: 1px solid var(--level-1); }
.level-was-value[data-level="2"] { background: var(--level-2-light); border: 1px solid var(--level-2); }
.level-was-value[data-level="3"] { background: var(--level-3-light); border: 1px solid var(--level-3); }
.level-was-value[data-level="4"] { background: var(--level-4-light); border: 1px solid var(--level-4); }
.level-was-value[data-level="5"] { background: var(--level-5-light); border: 1px solid var(--level-5); }

.level-now {
    display: flex;
    align-items: center;
    gap: var(--space-1);
    white-space: nowrap;
}

.level-now-label {
    font-size: 10px;
    font-weight: 600;
    color: var(--color-primary);
}

/* 5-Notch Level Selector */
.level-notches {
    display: flex;
    align-items: center;
    gap: 2px;
    background: var(--color-bg-warm);
    border-radius: var(--radius-full);
    padding: 3px;
    border: 1px solid var(--color-border);
}

.level-notch {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 28px;
    height: 28px;
    border-radius: var(--radius-full);
    cursor: pointer;
    font-size: 14px;
    line-height: 1;
    transition: all var(--transition-fast);
    background: transparent;
    border: 2px solid transparent;
    position: relative;
    text-align: center;
}

/* Star emoji needs slight adjustment for centering */
.level-notch[data-level="5"] {
    padding-left: 1px;
}

.level-notch:hover {
    transform: scale(1.15);
    z-index: 2;
}

/* Notch states - unfilled (future levels) */
.level-notch[data-level="1"] { color: var(--level-1); opacity: 0.4; }
.level-notch[data-level="2"] { color: var(--level-2); opacity: 0.4; }
.level-notch[data-level="3"] { color: var(--level-3); opacity: 0.4; }
.level-notch[data-level="4"] { color: var(--level-4); opacity: 0.4; }
.level-notch[data-level="5"] { color: var(--level-5); opacity: 0.4; }

/* Filled state (at or below current level) */
.level-notch.filled {
    opacity: 1;
}

/* Active/selected notch */
.level-notch.active {
    opacity: 1;
    transform: scale(1.1);
    z-index: 1;
}

.level-notch.active[data-level="1"] { background: var(--level-1-light); border-color: var(--level-1); }
.level-notch.active[data-level="2"] { background: var(--level-2-light); border-color: var(--level-2); }
.level-notch.active[data-level="3"] { background: var(--level-3-light); border-color: var(--level-3); }
.level-notch.active[data-level="4"] { background: var(--level-4-light); border-color: var(--level-4); }
.level-notch.active[data-level="5"] { background: var(--level-5-light); border-color: var(--level-5); }

.level-notch:hover.active {
    transform: scale(1.2);
}

/* Tooltip on hover */
.level-notch::after {
    content: attr(data-label);
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: var(--color-text);
    color: var(--color-bg);
    padding: 2px 6px;
    border-radius: var(--radius-xs);
    font-size: 9px;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.15s;
    margin-bottom: 4px;
}

.level-notch:hover::after {
    opacity: 1;
}

/* Check-in mode: show was indicator above */
.level-controls-checkin .level-notches {
    margin-top: 2px;
}

/* Legacy dropdown - hidden but kept for compatibility */
.level-dropdown {
    display: none;
}

/* Help Toggle (What & Why) */
.learning-item-help {
    margin-top: var(--space-1);
    padding-top: var(--space-1);
}

.help-toggle {
    display: inline-flex;
    align-items: center;
    gap: var(--space-1);
    padding: 2px var(--space-2);
    background: transparent;
    border: none;
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    transition: all var(--transition-fast);
}

.help-toggle:hover {
    background: var(--color-bg-warm);
    color: var(--color-primary);
}

.help-toggle-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 16px;
    height: 16px;
    background: var(--color-bg-warm);
    border-radius: var(--radius-full);
    font-size: 10px;
    font-weight: 600;
    color: var(--color-text-muted);
}

.help-toggle:hover .help-toggle-icon {
    background: var(--color-primary);
    color: white;
}

.help-toggle[aria-expanded="true"] .help-toggle-icon {
    background: var(--color-primary);
    color: white;
}

.help-content {
    display: none;
    margin-top: var(--space-2);
    padding: var(--space-3);
    background: var(--color-bg-warm);
    border-radius: var(--radius-md);
    font-size: var(--text-sm);
    line-height: var(--line-height-relaxed);
    color: var(--color-text-secondary);
}

.help-content.expanded {
    display: block;
    animation: fadeIn 0.2s ease-out;
}

.help-section {
    margin-bottom: var(--space-2);
}

.help-section:last-child {
    margin-bottom: 0;
}

.help-section strong {
    color: var(--color-text);
}

/* Old styles kept for backwards compatibility */
.learning-header {
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-3) var(--space-4);
    cursor: pointer;
    transition: background var(--transition-fast);
    min-height: 52px;
}

.learning-header:hover { background: var(--color-bg-hover); }

.learning-level-indicator {
    width: 8px;
    height: 8px;
    border-radius: var(--radius-full);
    flex-shrink: 0;
    transition: all var(--transition-fast);
}

.learning-level-indicator[data-level="1"] { background: var(--level-1); }
.learning-level-indicator[data-level="2"] { background: var(--level-2); }
.learning-level-indicator[data-level="3"] { background: var(--level-3); }
.learning-level-indicator[data-level="4"] { background: var(--level-4); }
.learning-level-indicator[data-level="5"] { background: var(--level-5); }

.learning-info {
    flex: 1;
    min-width: 0;
}

.learning-title {
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-text);
    line-height: var(--line-height-tight);
}

.learning-code {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    margin-top: 2px;
}

.learning-controls {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    flex-shrink: 0;
}

/* Level Selector (button version - kept for reference) */
.level-selector {
    display: flex;
    gap: 2px;
    background: var(--color-bg-warm);
    padding: 3px;
    border-radius: var(--radius-md);
}

.level-btn {
    width: 28px;
    height: 28px;
    border: none;
    background: transparent;
    border-radius: var(--radius-sm);
    cursor: pointer;
    font-size: 14px;
    line-height: 1;
    transition: all var(--transition-fast);
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
    padding: 0;
}

.level-btn:hover { background: var(--color-bg-card); transform: scale(1.1); }

.level-btn[data-level="1"].active { background: var(--level-1); color: white; }
.level-btn[data-level="2"].active { background: var(--level-2); color: white; }
.level-btn[data-level="3"].active { background: var(--level-3); color: white; }
.level-btn[data-level="4"].active { background: var(--level-4); color: white; }
.level-btn[data-level="5"].active { background: var(--level-5); color: white; }

.learning-expand-btn {
    width: 28px;
    height: 28px;
    background: transparent;
    border: none;
    border-radius: var(--radius-sm);
    color: var(--color-text-muted);
    cursor: pointer;
    font-size: var(--text-sm);
    transition: all var(--transition-fast);
    display: flex;
    align-items: center;
    justify-content: center;
}

.learning-expand-btn:hover { background: var(--color-bg-hover); color: var(--color-text); }

.learning-header[aria-expanded="true"] .learning-expand-btn {
    transform: rotate(180deg);
}

/* Learning Details */
.learning-details {
    display: none;
    padding: var(--space-4);
    background: var(--color-bg-warm);
    border-top: 1px solid var(--color-border-light);
}

.learning-details.expanded { display: block; }

.detail-section {
    margin-bottom: var(--space-4);
}

.detail-section:last-child { margin-bottom: 0; }

.detail-label {
    font-size: var(--text-xs);
    font-weight: 600;
    color: var(--color-text-secondary);
    margin-bottom: var(--space-2);
    text-transform: uppercase;
    letter-spacing: 0.05em;
}

/* Explanation Toggle & Content */
.subtopic-explanation-wrapper {
    margin-bottom: var(--space-4);
    padding-bottom: var(--space-4);
    border-bottom: 1px solid var(--color-border);
}

.explanation-toggle {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    width: 100%;
    padding: var(--space-3);
    background: linear-gradient(135deg, rgba(45, 157, 120, 0.08), rgba(45, 157, 120, 0.03));
    border: 1px solid rgba(45, 157, 120, 0.2);
    border-radius: var(--radius-md);
    cursor: pointer;
    font-size: var(--text-sm);
    font-weight: 500;
    color: var(--color-primary);
    text-align: left;
    transition: all var(--transition-fast);
}

.explanation-toggle:hover {
    background: linear-gradient(135deg, rgba(45, 157, 120, 0.12), rgba(45, 157, 120, 0.06));
    border-color: rgba(45, 157, 120, 0.3);
}

.subtopic-explanation-toggle {
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.08), rgba(139, 92, 246, 0.03));
    border-color: rgba(139, 92, 246, 0.2);
    color: #8b5cf6;
}

.subtopic-explanation-toggle:hover {
    background: linear-gradient(135deg, rgba(139, 92, 246, 0.12), rgba(139, 92, 246, 0.06));
    border-color: rgba(139, 92, 246, 0.3);
}

.explanation-toggle-icon {
    font-size: 10px;
    transition: transform var(--transition-fast);
}

.explanation-toggle[aria-expanded="true"] .explanation-toggle-icon {
    transform: rotate(180deg);
}

.explanation-content {
    display: none;
    padding: var(--space-4);
    margin-top: var(--space-2);
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
}

.explanation-content.expanded {
    display: block;
    animation: slideDown 0.2s ease-out;
}

@keyframes slideDown {
    from {
        opacity: 0;
        transform: translateY(-8px);
    }
    to {
        opacity: 1;
        transform: translateY(0);
    }
}

.explanation-section {
    margin-bottom: var(--space-4);
}

.explanation-section:last-child {
    margin-bottom: 0;
}

.explanation-heading {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-text-primary);
    margin-bottom: var(--space-2);
}

.explanation-heading-icon {
    font-size: var(--text-base);
}

.explanation-text {
    font-size: var(--text-sm);
    line-height: 1.6;
    color: var(--color-text-secondary);
    margin: 0;
}

/* Progress History */
.progress-history {
    display: flex;
    gap: var(--space-2);
    flex-wrap: wrap;
}

.history-entry {
    display: flex;
    flex-direction: column;
    align-items: center;
    padding: var(--space-2);
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    min-width: 60px;
}

.history-date {
    font-size: 9px;
    color: var(--color-text-muted);
    margin-bottom: var(--space-1);
}

.history-level {
    width: 24px;
    height: 24px;
    border-radius: var(--radius-full);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--text-xs);
    font-weight: 700;
    color: white;
}

.history-level[data-level="1"] { background: var(--level-1); }
.history-level[data-level="2"] { background: var(--level-2); }
.history-level[data-level="3"] { background: var(--level-3); }
.history-level[data-level="4"] { background: var(--level-4); }
.history-level[data-level="5"] { background: var(--level-5); }

/* Sparkline */
.sparkline {
    display: flex;
    align-items: flex-end;
    gap: 2px;
    height: 24px;
    padding: var(--space-2);
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
}

.sparkline-bar {
    width: 8px;
    background: var(--color-primary);
    border-radius: 2px 2px 0 0;
    transition: height var(--transition-normal);
}

/* Notes */
.notes-input-group {
    display: flex;
    gap: var(--space-2);
}

.notes-input-group .form-textarea {
    flex: 1;
}

.notes-list {
    max-height: 150px;
    overflow-y: auto;
    margin-top: var(--space-2);
}

.note-item {
    background: var(--color-bg-card);
    border: 1px solid var(--color-border-light);
    border-radius: var(--radius-sm);
    padding: var(--space-2) var(--space-3);
    margin-bottom: var(--space-2);
}

.note-item:last-child { margin-bottom: 0; }

.note-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-1);
}

.note-timestamp {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
}

.note-type {
    font-size: 9px;
    padding: 1px 6px;
    border-radius: var(--radius-full);
    font-weight: 600;
    text-transform: uppercase;
}

.note-type.question { background: var(--color-info-bg); color: var(--color-info); }
.note-type.reflection { background: var(--color-success-bg); color: var(--color-success); }
.note-type.goal { background: var(--color-warning-bg); color: var(--color-warning); }

.note-text {
    font-size: var(--text-sm);
    color: var(--color-text);
}

/* Check-in Card */
.checkin-card {
    background: linear-gradient(135deg, var(--color-info-bg) 0%, var(--color-bg-card) 100%);
    border: 2px solid var(--color-info);
    border-radius: var(--radius-lg);
    padding: var(--space-5);
    text-align: center;
}

.checkin-icon {
    font-size: 3rem;
    margin-bottom: var(--space-3);
}

.checkin-title {
    font-family: var(--font-display);
    font-size: var(--text-xl);
    font-weight: 700;
    color: var(--color-text);
    margin-bottom: var(--space-2);
}

.checkin-desc {
    color: var(--color-text-secondary);
    margin-bottom: var(--space-4);
}

/* Level Legend */
.level-legend {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-3);
    padding: var(--space-3);
    background: var(--color-bg-warm);
    border-radius: var(--radius-md);
    margin-bottom: var(--space-4);
}

.level-legend-item {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: var(--text-xs);
    color: var(--color-text-secondary);
}

.level-legend-dot {
    width: 12px;
    height: 12px;
    border-radius: var(--radius-full);
}

.level-legend-dot[data-level="1"] { background: var(--level-1); }
.level-legend-dot[data-level="2"] { background: var(--level-2); }
.level-legend-dot[data-level="3"] { background: var(--level-3); }
.level-legend-dot[data-level="4"] { background: var(--level-4); }
.level-legend-dot[data-level="5"] { background: var(--level-5); }

/* Form Elements */
.form-group {
    margin-bottom: var(--space-3);
}

.form-label {
    display: block;
    font-size: 10px;
    font-weight: 600;
    color: var(--color-text-secondary);
    margin-bottom: var(--space-1);
}

.form-input, .form-textarea, .form-select {
    width: 100%;
    padding: var(--space-2);
    font-family: var(--font-body);
    font-size: var(--text-xs);
    color: var(--color-text);
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
}

.form-input:hover, .form-textarea:hover, .form-select:hover {
    border-color: var(--color-text-muted);
}

.form-input:focus, .form-textarea:focus, .form-select:focus {
    outline: none;
    border-color: var(--color-border-focus);
    box-shadow: var(--shadow-focus);
}

.form-textarea {
    min-height: 60px;
    resize: vertical;
}

/* Buttons */
.btn {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-1);
    padding: var(--space-2) var(--space-3);
    font-family: var(--font-body);
    font-size: var(--text-xs);
    font-weight: 600;
    border-radius: var(--radius-sm);
    border: none;
    cursor: pointer;
    transition: all var(--transition-fast);
    min-height: 32px;
    text-decoration: none;
}

.btn-primary {
    background: var(--color-primary);
    color: var(--color-text-inverse);
}

.btn-primary:hover { background: var(--color-primary-dark); transform: translateY(-1px); }

.btn-secondary {
    background: var(--color-bg-warm);
    color: var(--color-text);
    border: 1px solid var(--color-border);
}

.btn-secondary:hover { background: var(--color-bg-hover); }

.btn-success {
    background: var(--color-success);
    color: white;
}

.btn-success:hover { background: #16a34a; }

.btn-sm {
    padding: var(--space-2) var(--space-3);
    font-size: var(--text-xs);
    min-height: 32px;
}

.btn-lg {
    padding: var(--space-4) var(--space-6);
    font-size: var(--text-base);
    min-height: 48px;
}

/* Dashboard Grid */
.dashboard-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
    gap: var(--space-4);
}

.stat-card {
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-lg);
    padding: var(--space-4);
}

.stat-card-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    margin-bottom: var(--space-3);
}

.stat-card-title {
    font-family: var(--font-display);
    font-size: var(--text-sm);
    font-weight: 700;
    color: var(--color-text);
}

.stat-card-icon {
    font-size: var(--text-lg);
}

.stat-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: var(--space-2) 0;
    border-bottom: 1px solid var(--color-border-light);
    font-size: var(--text-sm);
}

.stat-row:last-child { border-bottom: none; }

.stat-label { color: var(--color-text-secondary); }
.stat-value { font-weight: 600; color: var(--color-text); }

/* Check-in History Timeline */
.checkin-timeline {
    position: relative;
    padding-left: var(--space-6);
}

.checkin-timeline::before {
    content: '';
    position: absolute;
    left: 11px;
    top: 0;
    bottom: 0;
    width: 2px;
    background: var(--color-border);
}

.timeline-item {
    position: relative;
    padding-bottom: var(--space-3);
}

.timeline-item:last-child { padding-bottom: 0; }

.timeline-dot {
    position: absolute;
    left: -18px;
    top: 3px;
    width: 10px;
    height: 10px;
    border-radius: var(--radius-full);
    background: var(--color-primary);
    border: 2px solid var(--color-bg-card);
}

.timeline-dot.current { 
    background: var(--color-success);
    box-shadow: 0 0 0 3px var(--color-success-bg);
}

.timeline-content {
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    padding: var(--space-2);
}

.timeline-date {
    font-size: 10px;
    font-weight: 600;
    color: var(--color-text-muted);
    margin-bottom: var(--space-1);
}

.timeline-type {
    font-size: 10px;
    padding: 1px 6px;
    border-radius: var(--radius-full);
    font-weight: 600;
    margin-left: var(--space-1);
}

.timeline-type.pretopic { background: #e0f2fe; color: #0369a1; }
.timeline-type.weekly { background: var(--color-info-bg); color: var(--color-info); }
.timeline-type.revision { background: var(--color-warning-bg); color: var(--color-warning); }
.timeline-type.posttest { background: var(--color-success-bg); color: var(--color-success); }

.timeline-stats {
    display: flex;
    gap: var(--space-3);
    font-size: var(--text-xs);
}

/* Goals Section */
.goal-item {
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-left: 3px solid var(--color-secondary);
    border-radius: var(--radius-sm);
    padding: var(--space-2);
    margin-bottom: var(--space-1);
}

.goal-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
}

.goal-text {
    font-size: var(--text-xs);
    color: var(--color-text);
}

.goal-checkbox {
    width: 16px;
    height: 16px;
    accent-color: var(--color-success);
}

.goal-meta {
    font-size: 10px;
    color: var(--color-text-muted);
    margin-top: 2px;
}

.focus-area-link {
    transition: transform var(--transition-fast), box-shadow var(--transition-fast);
}

.focus-area-link:hover {
    transform: translateX(4px);
    box-shadow: var(--shadow-sm);
    background: var(--color-bg-hover);
}

/* Toast Notifications */
.toast-container {
    position: fixed;
    bottom: var(--space-5);
    right: var(--space-5);
    z-index: 1000;
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
}

.toast {
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--space-3) var(--space-4);
    box-shadow: var(--shadow-lg);
    display: flex;
    align-items: center;
    gap: var(--space-3);
    min-width: 250px;
    max-width: 350px;
    animation: slideInRight var(--transition-normal);
}

@keyframes slideInRight {
    from { opacity: 0; transform: translateX(100%); }
    to { opacity: 1; transform: translateX(0); }
}

.toast-success { border-left: 4px solid var(--color-success); }
.toast-error { border-left: 4px solid var(--color-error); }
.toast-info { border-left: 4px solid var(--color-info); }
.toast-warning { border-left: 4px solid var(--color-warning); }

.toast-icon { font-size: var(--text-lg); }
.toast-message { flex: 1; font-size: var(--text-sm); }

.toast-close {
    background: none;
    border: none;
    color: var(--color-text-muted);
    cursor: pointer;
    padding: var(--space-1);
    font-size: var(--text-base);
}

/* Settings Overlay */
.overlay {
    display: none;
    position: fixed;
    inset: 0;
    background: rgba(0, 0, 0, 0.5);
    z-index: 2000;
    align-items: center;
    justify-content: center;
}

.overlay.active { display: flex; }

.overlay-panel {
    background: var(--color-bg-card);
    border-radius: var(--radius-xl);
    max-width: 500px;
    width: 94%;
    max-height: 90vh;
    overflow: hidden;
    display: flex;
    flex-direction: column;
    box-shadow: var(--shadow-lg);
}

.overlay-header {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-4) var(--space-5);
    border-bottom: 1px solid var(--color-border);
}

.overlay-title {
    font-family: var(--font-display);
    font-size: var(--text-lg);
    font-weight: 700;
}

.overlay-close {
    background: none;
    border: none;
    font-size: var(--text-xl);
    color: var(--color-text-muted);
    cursor: pointer;
    padding: var(--space-2);
    border-radius: var(--radius-sm);
    line-height: 1;
}

.overlay-close:hover { background: var(--color-bg-hover); color: var(--color-text); }

.overlay-content {
    flex: 1;
    overflow-y: auto;
    padding: var(--space-4);
}

/* Quiz Overlay */
.quiz-panel {
    max-width: 520px;
}

.quiz-context {
    background: var(--color-bg-warm);
    border-radius: var(--radius-md);
    padding: var(--space-3);
    margin-bottom: var(--space-4);
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
}

.quiz-context-label {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    text-transform: uppercase;
    letter-spacing: 0.05em;
    margin-bottom: var(--space-1);
}

.quiz-context-title {
    color: var(--color-text);
    font-weight: 600;
}

.quiz-level-indicator {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    margin-top: var(--space-2);
    font-size: var(--text-xs);
}

.quiz-level-badge {
    padding: var(--space-1) var(--space-2);
    border-radius: var(--radius-sm);
    font-weight: 600;
}

.quiz-level-badge.from { background: var(--color-bg-warm); }
.quiz-level-badge.to { background: var(--color-primary-pale); color: var(--color-primary-dark); }

.quiz-question {
    font-size: var(--text-base);
    font-weight: 600;
    color: var(--color-text);
    margin-bottom: var(--space-4);
    line-height: 1.5;
}

.quiz-options {
    display: flex;
    flex-direction: column;
    gap: var(--space-2);
}

.quiz-option {
    display: flex;
    align-items: flex-start;
    gap: var(--space-3);
    padding: var(--space-3) var(--space-4);
    background: var(--color-bg-warm);
    border: 2px solid var(--color-border);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
    text-align: left;
    font-size: var(--text-sm);
    color: var(--color-text);
    width: 100%;
}

.quiz-option:hover:not(:disabled) {
    border-color: var(--color-primary);
    background: var(--color-primary-pale);
}

.quiz-option:disabled {
    cursor: default;
}

.quiz-option.selected {
    border-color: var(--color-primary);
    background: var(--color-primary-pale);
}

.quiz-option.correct {
    border-color: var(--color-success);
    background: rgba(34, 197, 94, 0.1);
}

.quiz-option.incorrect {
    border-color: var(--color-error);
    background: rgba(239, 68, 68, 0.1);
}

.quiz-option-marker {
    width: 24px;
    height: 24px;
    border-radius: 50%;
    border: 2px solid var(--color-border);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: var(--text-xs);
    font-weight: 700;
    flex-shrink: 0;
    transition: all var(--transition-fast);
}

.quiz-option:hover:not(:disabled) .quiz-option-marker {
    border-color: var(--color-primary);
}

.quiz-option.selected .quiz-option-marker {
    background: var(--color-primary);
    border-color: var(--color-primary);
    color: white;
}

.quiz-option.correct .quiz-option-marker {
    background: var(--color-success);
    border-color: var(--color-success);
    color: white;
}

.quiz-option.incorrect .quiz-option-marker {
    background: var(--color-error);
    border-color: var(--color-error);
    color: white;
}

.quiz-option-text {
    flex: 1;
    line-height: 1.5;
}

.quiz-result {
    margin-top: var(--space-4);
    padding: var(--space-4);
    border-radius: var(--radius-md);
    display: none;
}

.quiz-result.visible {
    display: block;
    animation: fadeIn 0.3s ease;
}

.quiz-result.correct {
    background: rgba(34, 197, 94, 0.1);
    border: 1px solid var(--color-success);
}

.quiz-result.incorrect {
    background: rgba(239, 68, 68, 0.1);
    border: 1px solid var(--color-error);
}

.quiz-result-header {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-weight: 700;
    margin-bottom: var(--space-2);
}

.quiz-result.correct .quiz-result-header { color: var(--color-success); }
.quiz-result.incorrect .quiz-result-header { color: var(--color-error); }

.quiz-result-explanation {
    font-size: var(--text-sm);
    color: var(--color-text-secondary);
    line-height: 1.5;
}

.quiz-footer {
    padding: var(--space-4) var(--space-5);
    border-top: 1px solid var(--color-border);
    display: flex;
    justify-content: flex-end;
    gap: var(--space-2);
}

.quiz-streak-info {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    text-align: center;
    margin-top: var(--space-3);
    padding-top: var(--space-3);
    border-top: 1px solid var(--color-border);
}

.quiz-streak-progress {
    display: flex;
    align-items: center;
    justify-content: center;
    gap: var(--space-1);
    margin-top: var(--space-2);
}

.quiz-streak-dot {
    width: 10px;
    height: 10px;
    border-radius: 50%;
    background: var(--color-border);
}

.quiz-streak-dot.filled {
    background: var(--color-success);
}

.quiz-streak-dot.current {
    border: 2px solid var(--color-primary);
}

/* Locked notch state */
.level-notch.locked {
    opacity: 0.4;
    cursor: not-allowed;
    position: relative;
}

.level-notch.locked::after {
    content: 'ðŸ”‘';
    position: absolute;
    font-size: 8px;
    top: -4px;
    right: -4px;
}

/* Check-in Type Grid */
.checkin-type-grid {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: var(--space-2);
}

.checkin-type-btn {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: var(--space-1);
    padding: var(--space-3);
    background: var(--color-bg-card);
    border: 2px solid var(--color-border);
    border-radius: var(--radius-md);
    cursor: pointer;
    transition: all var(--transition-fast);
    text-align: center;
}

.checkin-type-btn:hover {
    border-color: var(--color-primary);
    background: var(--color-bg-hover);
}

.checkin-type-btn.active {
    border-color: var(--color-primary);
    background: rgba(45, 157, 120, 0.1);
}

.checkin-type-icon {
    font-size: 1.2rem;
}

.checkin-type-name {
    font-weight: 600;
    font-size: var(--text-xs);
    color: var(--color-text);
}

.checkin-type-desc {
    font-size: 10px;
    color: var(--color-text-muted);
    line-height: 1.2;
}

.checkin-instructions {
    background: var(--color-bg-warm);
    border-radius: var(--radius-sm);
    padding: var(--space-2);
    margin-bottom: var(--space-3);
}

.checkin-instructions p {
    font-size: var(--text-xs);
    color: var(--color-text-secondary);
    margin: 0 0 2px 0;
}

.checkin-instructions p:last-child {
    margin-bottom: 0;
}

/* Check-in Mode Styling - VERY VISIBLE */
.checkin-mode-active {
    position: relative;
    border: 3px solid var(--color-primary);
    border-radius: var(--radius-lg);
    animation: checkinBorderPulse 1.5s ease-in-out infinite;
}

.checkin-mode-active::before {
    content: '';
    position: absolute;
    inset: 0;
    background: rgba(45, 157, 120, 0.12);
    border-radius: var(--radius-lg);
    pointer-events: none;
    animation: checkinPulse 1.5s ease-in-out infinite;
    z-index: 0;
}

@keyframes checkinPulse {
    0%, 100% { 
        background: rgba(45, 157, 120, 0.08);
    }
    50% { 
        background: rgba(45, 157, 120, 0.18);
    }
}

@keyframes checkinBorderPulse {
    0%, 100% { 
        border-color: var(--color-primary);
        box-shadow: 0 0 0 0 rgba(45, 157, 120, 0.4);
    }
    50% { 
        border-color: #1a7a5a;
        box-shadow: 0 0 20px 5px rgba(45, 157, 120, 0.3);
    }
}

.checkin-mode-active > * {
    position: relative;
    z-index: 1;
}

/* Floating Check-in Status Bar */
.checkin-floating-bar {
    position: fixed;
    bottom: 12px;
    left: 50%;
    transform: translateX(-50%);
    display: flex;
    align-items: center;
    gap: var(--space-3);
    padding: var(--space-2) var(--space-4);
    background: linear-gradient(135deg, var(--color-primary), #1a7a5a);
    color: white;
    border-radius: var(--radius-full);
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    z-index: 1000;
    animation: floatIn 0.3s ease-out, floatingPulse 2s ease-in-out infinite;
}

@keyframes floatIn {
    from {
        opacity: 0;
        transform: translateX(-50%) translateY(20px);
    }
    to {
        opacity: 1;
        transform: translateX(-50%) translateY(0);
    }
}

@keyframes floatingPulse {
    0%, 100% {
        box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
    }
    50% {
        box-shadow: 0 4px 30px rgba(45, 157, 120, 0.5);
    }
}

.checkin-floating-icon {
    font-size: 1rem;
    animation: iconPulse 1s ease-in-out infinite;
}

@keyframes iconPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.2); }
}

.checkin-floating-text {
    font-weight: 600;
    font-size: 11px;
}

.checkin-floating-progress {
    font-size: 10px;
    opacity: 0.9;
}

.checkin-floating-timer {
    font-size: 10px;
    background: rgba(255, 255, 255, 0.2);
    padding: 2px 6px;
    border-radius: var(--radius-full);
}

.checkin-floating-stop {
    padding: var(--space-1) var(--space-3);
    background: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: var(--radius-full);
    color: white;
    font-size: var(--text-xs);
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-fast);
}

.checkin-floating-stop:hover {
    background: rgba(255, 255, 255, 0.3);
}

/* Progress Visualization Styles */
.progress-section {
    margin-bottom: var(--space-3);
}

.progress-section-title {
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-text);
    margin-bottom: var(--space-2);
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

/* Overall Progress Bar */
.overall-progress {
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    padding: var(--space-3);
    margin-bottom: var(--space-3);
}

.overall-progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-2);
}

.overall-progress-title {
    font-size: var(--text-sm);
    font-weight: 600;
    color: var(--color-text);
}

.overall-progress-percent {
    font-size: var(--text-lg);
    font-weight: 700;
    color: var(--color-primary);
}

.overall-progress-bar {
    height: 12px;
    background: var(--color-bg-warm);
    border-radius: var(--radius-full);
    overflow: hidden;
    margin-bottom: var(--space-2);
}

.overall-progress-fill {
    height: 100%;
    background: linear-gradient(90deg, var(--color-primary), var(--color-primary-light));
    border-radius: var(--radius-full);
    transition: width 0.5s ease-out;
}

.overall-progress-stats {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-3);
    font-size: var(--text-xs);
    color: var(--color-text-secondary);
}

.overall-stat {
    display: flex;
    align-items: center;
    gap: var(--space-1);
}

.overall-stat-value {
    font-weight: 600;
    color: var(--color-text);
}

.change-badge {
    display: inline-flex;
    align-items: center;
    gap: 2px;
    padding: 2px 6px;
    border-radius: var(--radius-full);
    font-size: 10px;
    font-weight: 600;
}

.change-badge.positive {
    background: var(--color-success-bg);
    color: var(--color-success);
}

.change-badge.negative {
    background: var(--color-error-bg);
    color: var(--color-error);
}

.change-badge.neutral {
    background: var(--color-bg-warm);
    color: var(--color-text-muted);
}

/* Subtopic Progress Cards */
.subtopic-progress {
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-sm);
    padding: var(--space-2) var(--space-3);
    margin-bottom: var(--space-2);
}

.subtopic-progress:last-child {
    margin-bottom: 0;
}

.subtopic-progress-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: var(--space-2);
}

.subtopic-progress-name {
    font-size: var(--text-xs);
    font-weight: 600;
    color: var(--color-text);
    display: flex;
    align-items: center;
    gap: var(--space-1);
}

.subtopic-progress-change {
    font-size: 10px;
}

/* Level Distribution Stack */
.level-distribution {
    display: flex;
    height: 20px;
    border-radius: var(--radius-sm);
    overflow: hidden;
    background: var(--color-bg-warm);
    margin-bottom: var(--space-1);
}

.level-segment {
    height: 100%;
    transition: width 0.4s ease-out;
    position: relative;
    min-width: 0;
}

.level-segment[data-level="1"] { background: var(--level-1); }
.level-segment[data-level="2"] { background: var(--level-2); }
.level-segment[data-level="3"] { background: var(--level-3); }
.level-segment[data-level="4"] { background: var(--level-4); }
.level-segment[data-level="5"] { background: var(--level-5); }

.level-segment:hover {
    filter: brightness(1.1);
}

.level-segment-tooltip {
    position: absolute;
    bottom: 100%;
    left: 50%;
    transform: translateX(-50%);
    background: var(--color-text);
    color: var(--color-bg);
    padding: 3px 6px;
    border-radius: var(--radius-xs);
    font-size: 9px;
    white-space: nowrap;
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.15s;
    margin-bottom: 4px;
    z-index: 10;
}

.level-segment:hover .level-segment-tooltip {
    opacity: 1;
}

/* Level Distribution Legend (inline) */
.level-distribution-legend {
    display: flex;
    flex-wrap: wrap;
    gap: var(--space-2);
    font-size: 9px;
    color: var(--color-text-muted);
}

.level-legend-item {
    display: flex;
    align-items: center;
    gap: 3px;
}

.level-legend-dot {
    width: 8px;
    height: 8px;
    border-radius: 2px;
}

.level-legend-dot[data-level="1"] { background: var(--level-1); }
.level-legend-dot[data-level="2"] { background: var(--level-2); }
.level-legend-dot[data-level="3"] { background: var(--level-3); }
.level-legend-dot[data-level="4"] { background: var(--level-4); }
.level-legend-dot[data-level="5"] { background: var(--level-5); }

/* Comparison section */
.comparison-row {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    font-size: 10px;
    color: var(--color-text-muted);
    margin-top: var(--space-1);
}

.comparison-label {
    min-width: 60px;
}

.comparison-bar {
    flex: 1;
    display: flex;
    height: 8px;
    border-radius: var(--radius-xs);
    overflow: hidden;
    background: var(--color-bg-warm);
}

.comparison-bar .level-segment {
    height: 100%;
}

/* Check-in Mode Banner */
.checkin-mode-banner {
    display: flex;
    align-items: center;
    justify-content: space-between;
    gap: var(--space-3);
    padding: var(--space-3) var(--space-4);
    background: linear-gradient(135deg, var(--color-primary), #228b6b);
    color: white;
    border-radius: var(--radius-md);
    margin-bottom: var(--space-4);
    animation: slideDown 0.3s ease-out;
}

.checkin-mode-info {
    display: flex;
    align-items: center;
    gap: var(--space-3);
}

.checkin-mode-type {
    font-weight: 600;
    font-size: var(--text-sm);
}

.checkin-mode-progress {
    font-size: var(--text-xs);
    opacity: 0.9;
}

.checkin-stop-btn {
    padding: var(--space-2) var(--space-3);
    background: rgba(255, 255, 255, 0.2);
    border: 1px solid rgba(255, 255, 255, 0.3);
    border-radius: var(--radius-md);
    color: white;
    font-size: var(--text-sm);
    font-weight: 500;
    cursor: pointer;
    transition: all var(--transition-fast);
}

.checkin-stop-btn:hover {
    background: rgba(255, 255, 255, 0.3);
}

/* Item reviewed indicator */
.learning-item-simple.reviewed {
    background: rgba(45, 157, 120, 0.05);
}

.learning-item-simple.reviewed::after {
    content: 'âœ“';
    position: absolute;
    top: var(--space-2);
    right: var(--space-2);
    font-size: var(--text-xs);
    color: var(--color-primary);
    opacity: 0.7;
}

.learning-item-simple {
    position: relative;
}

/* Settings Specific */
.settings-section {
    margin-bottom: var(--space-6);
}

.settings-section:last-child { margin-bottom: 0; }

.settings-section-title {
    font-size: var(--text-xs);
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.05em;
    color: var(--color-text-muted);
    margin-bottom: var(--space-3);
    padding-bottom: var(--space-2);
    border-bottom: 1px solid var(--color-border-light);
}

.settings-row {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-2) 0;
}

.settings-row-label {
    font-size: var(--text-sm);
    color: var(--color-text);
}

.settings-row input[type="checkbox"] {
    width: 20px;
    height: 20px;
    accent-color: var(--color-primary);
    cursor: pointer;
}

/* Onboarding Panel */
.onboarding-panel {
    max-width: 480px;
}

.onboarding-content {
    min-height: 320px;
    display: flex;
    flex-direction: column;
    justify-content: center;
}

.onboarding-page {
    display: none;
    text-align: center;
    animation: fadeIn 0.3s ease;
}

.onboarding-page.active {
    display: block;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
}

.onboarding-emoji {
    font-size: 48px;
    margin-bottom: var(--space-3);
}

.onboarding-page h3 {
    font-family: var(--font-display);
    font-size: var(--text-lg);
    color: var(--color-text);
    margin-bottom: var(--space-3);
}

.onboarding-page p {
    color: var(--color-text-secondary);
    font-size: var(--text-sm);
    line-height: 1.6;
    margin-bottom: var(--space-2);
}

.onboarding-hint {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    font-style: italic;
    margin-top: var(--space-3);
}

.onboarding-levels {
    text-align: left;
    margin-top: var(--space-3);
}

.onboarding-level {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) 0;
    font-size: var(--text-xs);
    color: var(--color-text-secondary);
}

.onboarding-level span {
    font-size: 18px;
    width: 24px;
    text-align: center;
}

.onboarding-level strong {
    color: var(--color-text);
}

.onboarding-features {
    text-align: left;
    margin-top: var(--space-3);
}

.onboarding-feature {
    display: flex;
    gap: var(--space-3);
    padding: var(--space-2) 0;
    border-bottom: 1px solid var(--color-border);
}

.onboarding-feature:last-child {
    border-bottom: none;
}

.onboarding-feature .feature-icon {
    font-size: 20px;
    width: 32px;
    text-align: center;
    flex-shrink: 0;
}

.onboarding-feature strong {
    font-size: var(--text-sm);
    color: var(--color-text);
    display: block;
    margin-bottom: 2px;
}

.onboarding-feature p {
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    margin: 0;
}

.onboarding-footer {
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: var(--space-4) var(--space-5);
    border-top: 1px solid var(--color-border);
}

.onboarding-dots {
    display: flex;
    gap: var(--space-2);
}

.onboarding-dot {
    width: 8px;
    height: 8px;
    border-radius: 50%;
    border: none;
    background: var(--color-border);
    cursor: pointer;
    padding: 0;
    transition: all var(--transition-fast);
}

.onboarding-dot.active {
    background: var(--color-primary);
    transform: scale(1.2);
}

.onboarding-dot:hover {
    background: var(--color-primary-dark);
}

.onboarding-buttons {
    display: flex;
    gap: var(--space-2);
}

/* Empty State */
.empty-state {
    text-align: center;
    padding: var(--space-5);
    color: var(--color-text-muted);
}

.empty-state-icon {
    font-size: 2.5rem;
    margin-bottom: var(--space-2);
    opacity: 0.5;
}

.empty-state-title {
    font-family: var(--font-display);
    font-size: var(--text-sm);
    font-weight: 700;
    color: var(--color-text-secondary);
    margin-bottom: var(--space-1);
}

.empty-state-desc {
    font-size: var(--text-xs);
    max-width: 280px;
    margin: 0 auto;
}

/* Status Bar */
.status-bar {
    position: fixed;
    bottom: 0;
    left: 0;
    right: 0;
    background: var(--color-bg-card);
    border-top: 1px solid var(--color-border);
    padding: var(--space-2) var(--space-5);
    font-size: var(--text-xs);
    color: var(--color-text-muted);
    display: flex;
    justify-content: space-between;
    align-items: center;
    z-index: 50;
}

.status-indicator {
    display: flex;
    align-items: center;
    gap: var(--space-2);
}

.status-indicator::before {
    content: '';
    width: 8px;
    height: 8px;
    background: var(--color-success);
    border-radius: var(--radius-full);
}

/* Mobile Responsive */
@media (max-width: 768px) {
    .header-content { flex-wrap: wrap; }
    .app-title { font-size: var(--text-xl); }
    .student-info { display: none; }
    .main-content { padding: var(--space-3); }
    
    .topic-selector-bar {
        padding: var(--space-2);
    }
    
    .topic-selector-content {
        flex-direction: column;
        align-items: stretch;
        gap: var(--space-2);
    }
    
    .topic-selector-label {
        display: none;
    }
    
    .topic-selector-dropdowns {
        flex-direction: column;
        gap: var(--space-2);
    }
    
    .topic-dropdown {
        width: 100%;
        min-width: unset;
    }
    
    .topic-dropdown-separator {
        display: none;
    }
    
    .topic-current-display {
        margin-left: 0;
        justify-content: center;
        padding-top: var(--space-2);
        border-top: 1px solid var(--color-border);
    }
    
    .level-selector { 
        position: fixed;
        bottom: 60px;
        left: var(--space-3);
        right: var(--space-3);
        background: var(--color-bg-card);
        border: 1px solid var(--color-border);
        box-shadow: var(--shadow-lg);
        padding: var(--space-3);
        border-radius: var(--radius-lg);
        justify-content: space-around;
        display: none;
    }
    
    .level-selector.mobile-visible { display: flex; }
    
    .level-btn {
        width: 44px;
        height: 44px;
        font-size: 20px;
        line-height: 1;
    }
    
    .topic-header { flex-wrap: wrap; gap: var(--space-2); }
    .topic-progress { width: 100%; justify-content: flex-end; }
    
    .progress-stats { grid-template-columns: repeat(2, 1fr); }
    
    .dashboard-grid { grid-template-columns: 1fr; }
}

/* Text Selection Popup */
.selection-popup {
    position: absolute;
    z-index: 1000;
    background: var(--color-bg-card);
    border: 1px solid var(--color-border);
    border-radius: var(--radius-md);
    box-shadow: var(--shadow-lg);
    padding: var(--space-1);
    display: flex;
    flex-direction: column;
    gap: 2px;
    min-width: 180px;
    animation: popupFadeIn 0.15s ease-out;
}

@keyframes popupFadeIn {
    from { opacity: 0; transform: translateY(-4px); }
    to { opacity: 1; transform: translateY(0); }
}

.selection-popup-btn {
    display: flex;
    align-items: center;
    gap: var(--space-2);
    padding: var(--space-2) var(--space-3);
    background: transparent;
    border: none;
    border-radius: var(--radius-sm);
    font-size: var(--text-xs);
    color: var(--color-text);
    cursor: pointer;
    text-align: left;
    transition: background var(--transition-fast);
}

.selection-popup-btn:hover {
    background: var(--color-bg-hover);
}

.selection-popup-btn .popup-icon {
    font-size: 14px;
    width: 20px;
    text-align: center;
}

.selection-popup-btn .popup-label {
    flex: 1;
}

.selection-popup-btn.teacher { color: var(--color-primary); }
.selection-popup-btn.google { color: #4285f4; }
.selection-popup-btn.chatgpt { color: #10a37f; }

.selection-popup-btn.teacher:hover { background: var(--color-primary-pale); }
.selection-popup-btn.google:hover { background: rgba(66, 133, 244, 0.1); }
.selection-popup-btn.chatgpt:hover { background: rgba(16, 163, 127, 0.1); }

/* Print Styles */
@media print {
    .app-header, .sub-nav, .header-actions, .status-bar,
    .toast-container, .overlay, .btn, .level-selector { display: none !important; }
    
    body { background: white; color: black; font-size: 11pt; }
    
    .main-content { max-width: none; padding: 0; }
    
    .card, .topic-section { break-inside: avoid; border: 1px solid #ccc; box-shadow: none; }
    
    .topic-content, .learning-details { display: block !important; }
}
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <div class="app-container">
        <header class="app-header" role="banner">
            <div class="header-content">
                <h1 class="app-title">
                    <span class="app-title-icon">ðŸŒ±</span>
                    <span>Dynamic Learning Check-in</span>
                </h1>
                
                <div class="student-info" id="student-info">
                    <span class="student-avatar">ðŸ‘¤</span>
                    <span id="student-name-display">Student</span>
                </div>
                
                <div class="header-actions">
                    <button class="header-btn" id="new-checkin-btn" title="Start a new check-in">
                        <span>ðŸ“</span> Check In
                    </button>
                    <button class="header-btn" id="undo-btn" title="Undo (Ctrl+Z)" disabled>â†¶</button>
                    <button class="header-btn" id="redo-btn" title="Redo (Ctrl+Y)" disabled>â†·</button>
                    <button class="header-btn" id="settings-btn" title="Settings">âš™ï¸</button>
                </div>
            </div>
        </header>
        
        <!-- Topic Selector Bar -->
        <div class="topic-selector-bar">
            <div class="topic-selector-content">
                <span class="topic-selector-label">Topic:</span>
                <div class="topic-selector-dropdowns">
                    <select class="topic-dropdown" id="year-level-dropdown" aria-label="Select year level">
                        <option value="">Select Year Level</option>
                    </select>
                    <span class="topic-dropdown-separator">â†’</span>
                    <select class="topic-dropdown" id="subject-dropdown" aria-label="Select subject" disabled>
                        <option value="">Select Subject</option>
                    </select>
                    <span class="topic-dropdown-separator">â†’</span>
                    <select class="topic-dropdown" id="topic-dropdown" aria-label="Select topic" disabled>
                        <option value="">Select Topic</option>
                    </select>
                </div>
                <div class="topic-loading-indicator" id="topic-loading-indicator">
                    <div class="topic-loading-spinner"></div>
                    <span>Loading...</span>
                </div>
                <div class="topic-current-display" id="topic-current-display">
                    <span>Current:</span>
                    <span class="topic-current-name" id="topic-current-name">No topic selected</span>
                </div>
            </div>
        </div>
        
        <nav class="sub-nav" role="navigation" aria-label="Main sections">
            <div class="sub-nav-content" role="tablist">
                <button class="nav-tab" role="tab" aria-selected="true" aria-controls="overview-panel" id="overview-tab">
                    <span class="nav-tab-icon">ðŸ“Š</span> Overview
                </button>
                <button class="nav-tab" role="tab" aria-selected="false" aria-controls="learning-panel" id="learning-tab">
                    <span class="nav-tab-icon">ðŸ“š</span> Learning Content
                    <span class="nav-tab-badge" id="learning-badge">0</span>
                </button>
                <button class="nav-tab" role="tab" aria-selected="false" aria-controls="history-panel" id="history-tab">
                    <span class="nav-tab-icon">ðŸ“…</span> Check-in History
                </button>
                <button class="nav-tab" role="tab" aria-selected="false" aria-controls="goals-panel" id="goals-tab">
                    <span class="nav-tab-icon">ðŸŽ¯</span> My Goals
                </button>
                <button class="nav-tab" role="tab" aria-selected="false" aria-controls="export-panel" id="export-tab">
                    <span class="nav-tab-icon">ðŸ“¤</span> Export
                </button>
            </div>
        </nav>
        
        <main class="main-content" id="main-content" role="main">
            
            <!-- Overview Panel -->
            <div class="panel-content active" id="overview-panel" role="tabpanel" aria-labelledby="overview-tab">
                
                <!-- Progress Overview Card -->
                <div class="card progress-overview">
                    <div class="card-header">
                        <div>
                            <h2 class="card-title">
                                <span class="card-title-icon">ðŸŒŸ</span>
                                Your Progress
                            </h2>
                            <p class="card-subtitle" id="topic-name-display">Loading topic...</p>
                        </div>
                        <div>
                            <span class="stat-label">Last check-in: </span>
                            <span class="stat-value" id="last-checkin-date">â€”</span>
                        </div>
                    </div>
                    
                    <div class="progress-stats" id="progress-stats">
                        <!-- Dynamically populated -->
                    </div>
                    
                    <div class="progress-bar-container">
                        <div class="progress-bar-label">
                            <span>Overall Understanding</span>
                            <span id="overall-percentage">0%</span>
                        </div>
                        <div class="progress-bar">
                            <div class="progress-bar-fill" id="overall-progress-fill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                
                <!-- Level Legend -->
                <div class="level-legend">
                    <div class="level-legend-item">
                        <span class="level-legend-dot" data-level="1"></span>
                        <span>Not started yet</span>
                    </div>
                    <div class="level-legend-item">
                        <span class="level-legend-dot" data-level="2"></span>
                        <span>Just beginning</span>
                    </div>
                    <div class="level-legend-item">
                        <span class="level-legend-dot" data-level="3"></span>
                        <span>Developing</span>
                    </div>
                    <div class="level-legend-item">
                        <span class="level-legend-dot" data-level="4"></span>
                        <span>Confident</span>
                    </div>
                    <div class="level-legend-item">
                        <span class="level-legend-dot" data-level="5"></span>
                        <span>Can teach others</span>
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="dashboard-grid">
                    <div class="checkin-card" id="next-checkin-card">
                        <div class="checkin-icon">ðŸ“</div>
                        <h3 class="checkin-title">Ready for your next check-in?</h3>
                        <p class="checkin-desc">Track your progress by checking in on your understanding</p>
                        <button class="btn btn-primary btn-lg" id="start-checkin-btn">Start Check-in</button>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <h3 class="stat-card-title">Quick Stats</h3>
                            <span class="stat-card-icon">ðŸ“ˆ</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Total check-ins</span>
                            <span class="stat-value" id="total-checkins">0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Items mastered</span>
                            <span class="stat-value" id="items-mastered">0</span>
                        </div>
                        <div class="stat-row">
                            <span class="stat-label">Growth this week</span>
                            <span class="stat-value" id="weekly-growth">â€”</span>
                        </div>
                    </div>
                </div>
                
                <!-- Areas to Focus -->
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <span class="card-title-icon">ðŸŽ¯</span>
                            Focus Areas
                        </h2>
                    </div>
                    <div id="focus-areas">
                        <p class="empty-state-desc">Complete your first check-in to see your focus areas.</p>
                    </div>
                </div>
                
            </div>
            
            <!-- Learning Content Panel -->
            <div class="panel-content" id="learning-panel" role="tabpanel" aria-labelledby="learning-tab">
                
                <div class="card">
                    <div class="card-header">
                        <div>
                            <h2 class="card-title">
                                <span class="card-title-icon">ðŸ“š</span>
                                <span id="topic-title">Learning Content</span>
                            </h2>
                            <p class="card-subtitle" id="curriculum-code">Curriculum alignment will appear here</p>
                        </div>
                        <div>
                            <button class="btn btn-secondary btn-sm" id="expand-all-btn">Expand All</button>
                            <button class="btn btn-secondary btn-sm" id="collapse-all-btn">Collapse All</button>
                        </div>
                    </div>
                    
                    <!-- Level Legend -->
                    <div class="level-legend">
                        <div class="level-legend-item">
                            <span class="level-legend-dot" data-level="1"></span>
                            <span>ðŸŒ± Not started</span>
                        </div>
                        <div class="level-legend-item">
                            <span class="level-legend-dot" data-level="2"></span>
                            <span>ðŸŒ¿ Beginning</span>
                        </div>
                        <div class="level-legend-item">
                            <span class="level-legend-dot" data-level="3"></span>
                            <span>ðŸŒ³ Developing</span>
                        </div>
                        <div class="level-legend-item">
                            <span class="level-legend-dot" data-level="4"></span>
                            <span>ðŸŒ² Confident</span>
                        </div>
                        <div class="level-legend-item">
                            <span class="level-legend-dot" data-level="5"></span>
                            <span>â­Â Mastered</span>
                        </div>
                    </div>
                </div>
                
                <div id="topics-container">
                    <!-- Dynamically populated -->
                </div>
                
            </div>
            
            <!-- History Panel -->
            <div class="panel-content" id="history-panel" role="tabpanel" aria-labelledby="history-tab">
                
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <span class="card-title-icon">ðŸ“…</span>
                            Check-in History
                        </h2>
                    </div>
                    
                    <div class="checkin-timeline" id="checkin-timeline">
                        <div class="empty-state">
                            <div class="empty-state-icon">ðŸ“</div>
                            <div class="empty-state-title">No check-ins yet</div>
                            <p class="empty-state-desc">Start your first check-in to track your learning journey over time.</p>
                        </div>
                    </div>
                </div>
                
            </div>
            
            <!-- Goals Panel -->
            <div class="panel-content" id="goals-panel" role="tabpanel" aria-labelledby="goals-tab">
                
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <span class="card-title-icon">ðŸŽ¯</span>
                            My Learning Goals
                        </h2>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="new-goal-input">Add a new goal</label>
                        <div class="notes-input-group">
                            <textarea id="new-goal-input" class="form-textarea" placeholder="What do you want to achieve? (e.g., 'I want to be confident in solving quadratic equations by Friday')" rows="2"></textarea>
                            <button class="btn btn-primary" id="add-goal-btn">Add Goal</button>
                        </div>
                    </div>
                    
                    <div id="goals-list">
                        <div class="empty-state">
                            <div class="empty-state-icon">ðŸŽ¯</div>
                            <div class="empty-state-title">No goals set</div>
                            <p class="empty-state-desc">Set goals to help focus your learning!</p>
                        </div>
                    </div>
                </div>
                
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">
                            <span class="card-title-icon">â“</span>
                            Questions for My Teacher
                        </h2>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="new-question-input">Ask a question</label>
                        <div class="notes-input-group">
                            <textarea id="new-question-input" class="form-textarea" placeholder="What would you like to ask your teacher?" rows="2"></textarea>
                            <button class="btn btn-primary" id="add-question-btn">Add Question</button>
                        </div>
                    </div>
                    
                    <div id="questions-list">
                        <div class="empty-state">
                            <p class="empty-state-desc">No questions yet. If you're stuck, ask here!</p>
                        </div>
                    </div>
                </div>
                
            </div>
            
            <!-- Export Panel -->
            <div class="panel-content" id="export-panel" role="tabpanel" aria-labelledby="export-tab">
                
                <div class="dashboard-grid">
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <h3 class="stat-card-title">Export Your Progress</h3>
                            <span class="stat-card-icon">ðŸ“¤</span>
                        </div>
                        <p style="color: var(--color-text-secondary); font-size: var(--text-sm); margin-bottom: var(--space-4);">
                            Share your learning progress with your teacher or parents.
                        </p>
                        <div style="display: flex; flex-direction: column; gap: var(--space-2);">
                            <button class="btn btn-primary" id="export-pdf-btn">ðŸ“„ Print Report</button>
                            <button class="btn btn-secondary" id="export-json-btn">ðŸ’¾ Backup Data (JSON)</button>
                            <button class="btn btn-secondary" id="email-report-btn">âœ‰ï¸ Email Summary</button>
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <h3 class="stat-card-title">Data Summary</h3>
                            <span class="stat-card-icon">ðŸ“Š</span>
                        </div>
                        <div id="data-summary">
                            <!-- Dynamically populated -->
                        </div>
                    </div>
                    
                    <div class="stat-card">
                        <div class="stat-card-header">
                            <h3 class="stat-card-title">Import Data</h3>
                            <span class="stat-card-icon">ðŸ“¥</span>
                        </div>
                        <p style="color: var(--color-text-secondary); font-size: var(--text-sm); margin-bottom: var(--space-4);">
                            Restore from a previous backup.
                        </p>
                        <input type="file" id="import-file" accept=".json" style="display: none;">
                        <button class="btn btn-secondary" id="import-btn">ðŸ“¤ Import Backup</button>
                    </div>
                </div>
                
            </div>
            
        </main>
        
        <footer class="status-bar" role="contentinfo">
            <div class="status-indicator" id="save-status">All changes saved</div>
            <div>
                <span id="version-display">v1.0.0</span>
            </div>
        </footer>
    </div>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toast-container" role="alert" aria-live="polite"></div>
    
    <!-- Settings Overlay -->
    <div class="overlay" id="settings-overlay" role="dialog" aria-modal="true" aria-labelledby="settings-title">
        <div class="overlay-panel">
            <div class="overlay-header">
                <h2 class="overlay-title" id="settings-title">âš™ï¸ Settings</h2>
                <button class="overlay-close" id="settings-close-btn" aria-label="Close settings">Ã—</button>
            </div>
            <div class="overlay-content">
                
                <div class="settings-section">
                    <h3 class="settings-section-title">Your Details</h3>
                    <div class="form-group">
                        <label class="form-label" for="student-name-input">Your Name</label>
                        <input type="text" id="student-name-input" class="form-input" placeholder="Enter your name">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="class-input">Class</label>
                        <input type="text" id="class-input" class="form-input" placeholder="e.g., 9A Maths">
                        <small style="color: var(--color-text-muted); font-size: 10px;">Will auto-populate from topic file</small>
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3 class="settings-section-title">Appearance</h3>
                    <div class="settings-row">
                        <label class="settings-row-label" for="dark-mode-toggle">Dark Mode</label>
                        <input type="checkbox" id="dark-mode-toggle">
                    </div>
                </div>
                
                <div class="settings-section">
                    <h3 class="settings-section-title">Help</h3>
                    <button class="btn btn-secondary" id="show-onboarding-btn" style="width: 100%;">ðŸ“– How to Use This App</button>
                </div>
                
                <div class="settings-section">
                    <h3 class="settings-section-title">Reset Data</h3>
                    <p style="color: var(--color-text-muted); font-size: var(--text-xs); margin-bottom: var(--space-3);">
                        Start fresh with a new topic. This cannot be undone.
                    </p>
                    <button class="btn btn-secondary" id="clear-data-btn" style="width: 100%; color: var(--color-error);">ðŸ—‘ï¸ Clear All Data</button>
                </div>
                
            </div>
        </div>
    </div>
    
    <!-- Onboarding Overlay -->
    <div class="overlay" id="onboarding-overlay" role="dialog" aria-modal="true" aria-labelledby="onboarding-title">
        <div class="overlay-panel onboarding-panel">
            <div class="overlay-header">
                <h2 class="overlay-title" id="onboarding-title">ðŸ‘‹ Welcome</h2>
                <button class="overlay-close" id="onboarding-close-btn" aria-label="Close">Ã—</button>
            </div>
            <div class="overlay-content onboarding-content">
                <div class="onboarding-page active" data-page="1">
                    <div class="onboarding-emoji">ðŸŽ¯</div>
                    <h3>Track Your Learning Journey</h3>
                    <p>This app helps you understand where you're at with your learning â€” no stress, no grades, just honest self-reflection.</p>
                    <p class="onboarding-hint">Your progress stays private on your device. You choose when to share it with your teacher by emailing or printing a report.</p>
                </div>
                
                <div class="onboarding-page" data-page="2">
                    <div class="onboarding-emoji">ðŸŒ±</div>
                    <h3>The 5 Levels</h3>
                    <p>Rate yourself honestly on each learning goal:</p>
                    <div class="onboarding-levels">
                        <div class="onboarding-level"><span>ðŸŒ±</span> <strong>Not started</strong> â€” Haven't looked at this yet</div>
                        <div class="onboarding-level"><span>ðŸŒ¿</span> <strong>Beginning</strong> â€” Just getting started, still confused</div>
                        <div class="onboarding-level"><span>ðŸŒ³</span> <strong>Developing</strong> â€” Starting to get it, need more practice</div>
                        <div class="onboarding-level"><span>ðŸŒ²</span> <strong>Confident</strong> â€” I've got this, could explain it to someone</div>
                        <div class="onboarding-level"><span>â­Â</span> <strong>Mastered</strong> â€” Could teach it, can apply it anywhere</div>
                    </div>
                </div>
                
                <div class="onboarding-page" data-page="3">
                    <div class="onboarding-emoji">ðŸ’¡</div>
                    <h3>Helpful Features</h3>
                    <div class="onboarding-features">
                        <div class="onboarding-feature">
                            <span class="feature-icon">ðŸ“–</span>
                            <div>
                                <strong>What, Why, Example</strong>
                                <p>Click this button on any item to understand what you're learning and why it matters</p>
                            </div>
                        </div>
                        <div class="onboarding-feature">
                            <span class="feature-icon">ðŸ“</span>
                            <div>
                                <strong>Select Any Text</strong>
                                <p>Highlight text to search Google, ask ChatGPT, or save a question for later</p>
                            </div>
                        </div>
                        <div class="onboarding-feature">
                            <span class="feature-icon">â“</span>
                            <div>
                                <strong>Questions Tab</strong>
                                <p>Save questions as you go â€” include them in your report when you're ready to ask your teacher</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="onboarding-page" data-page="4">
                    <div class="onboarding-emoji">ðŸ“</div>
                    <h3>Check-ins and Sharing</h3>
                    <p>Your teacher might ask you to do a "check-in" â€” that's when you go through all the items and rate yourself honestly.</p>
                    <p>When you're ready, use <strong>Email Report</strong> or <strong>Print Report</strong> to share your progress and questions with your teacher.</p>
                    <p class="onboarding-hint">The Export/Load buttons are for moving your data to a different device or browser â€” your teacher doesn't need those files.</p>
                </div>
                
                <div class="onboarding-page" data-page="5">
                    <div class="onboarding-emoji">ðŸš€</div>
                    <h3>You're Ready</h3>
                    <p>That's everything. Start by looking at your learning goals and rating where you think you are.</p>
                    <p>Remember: Being honest helps your teacher help you. There's no wrong answer here.</p>
                    <p class="onboarding-hint">Your progress saves automatically. You can come back to this guide anytime from Settings.</p>
                </div>
            </div>
            <div class="onboarding-footer">
                <div class="onboarding-dots">
                    <button class="onboarding-dot active" data-page="1" aria-label="Page 1"></button>
                    <button class="onboarding-dot" data-page="2" aria-label="Page 2"></button>
                    <button class="onboarding-dot" data-page="3" aria-label="Page 3"></button>
                    <button class="onboarding-dot" data-page="4" aria-label="Page 4"></button>
                    <button class="onboarding-dot" data-page="5" aria-label="Page 5"></button>
                </div>
                <div class="onboarding-buttons">
                    <button class="btn btn-secondary" id="onboarding-prev-btn" disabled>Back</button>
                    <button class="btn btn-primary" id="onboarding-next-btn">Next</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Quiz Overlay -->
    <div class="overlay" id="quiz-overlay" role="dialog" aria-modal="true" aria-labelledby="quiz-title">
        <div class="overlay-panel quiz-panel">
            <div class="overlay-header">
                <h2 class="overlay-title" id="quiz-title">ðŸ“ Quick Check</h2>
                <button class="overlay-close" id="quiz-close-btn" aria-label="Close quiz">Ã—</button>
            </div>
            <div class="overlay-content">
                <div class="quiz-context">
                    <div class="quiz-context-label">Levelling up on:</div>
                    <div class="quiz-context-title" id="quiz-item-title">Loading...</div>
                    <div class="quiz-level-indicator">
                        <span class="quiz-level-badge from" id="quiz-from-level">ðŸŒ² Confident</span>
                        <span>â†’</span>
                        <span class="quiz-level-badge to" id="quiz-to-level">â­Â Mastered</span>
                    </div>
                </div>
                
                <div class="quiz-question" id="quiz-question-text">
                    Loading question...
                </div>
                
                <div class="quiz-options" id="quiz-options">
                    <!-- Options populated dynamically -->
                </div>
                
                <div class="quiz-result" id="quiz-result">
                    <div class="quiz-result-header">
                        <span id="quiz-result-icon">âœ“</span>
                        <span id="quiz-result-text">Correct</span>
                    </div>
                    <div class="quiz-result-explanation" id="quiz-result-explanation">
                        Explanation will appear here.
                    </div>
                </div>
                
                <div class="quiz-streak-info" id="quiz-streak-info" style="display: none;">
                    <span id="quiz-streak-text">You need 2 correct answers to advance</span>
                    <div class="quiz-streak-progress" id="quiz-streak-progress">
                        <!-- Dots populated dynamically -->
                    </div>
                </div>
            </div>
            <div class="quiz-footer">
                <button class="btn btn-secondary" id="quiz-cancel-btn">Cancel</button>
                <button class="btn btn-primary" id="quiz-submit-btn" disabled>Check Answer</button>
            </div>
        </div>
    </div>
    
    <!-- Check-in Overlay -->
    <div class="overlay" id="checkin-overlay" role="dialog" aria-modal="true" aria-labelledby="checkin-title">
        <div class="overlay-panel" style="max-width: 600px;">
            <div class="overlay-header">
                <h2 class="overlay-title" id="checkin-title">ðŸ“ Start a Check-in</h2>
                <button class="overlay-close" id="checkin-close-btn" aria-label="Close check-in">Ã—</button>
            </div>
            <div class="overlay-content">
                
                <div class="form-group">
                    <label class="form-label">What type of check-in is this?</label>
                    <div class="checkin-type-grid">
                        <button class="checkin-type-btn" data-type="pretopic">
                            <span class="checkin-type-icon">ðŸš€</span>
                            <span class="checkin-type-name">Pre-Topic</span>
                            <span class="checkin-type-desc">Before starting a new topic</span>
                        </button>
                        <button class="checkin-type-btn active" data-type="weekly">
                            <span class="checkin-type-icon">ðŸ“…</span>
                            <span class="checkin-type-name">Weekly</span>
                            <span class="checkin-type-desc">Regular weekly progress check</span>
                        </button>
                        <button class="checkin-type-btn" data-type="revision">
                            <span class="checkin-type-icon">ðŸ“š</span>
                            <span class="checkin-type-name">Final Revision</span>
                            <span class="checkin-type-desc">Before a test or exam</span>
                        </button>
                        <button class="checkin-type-btn" data-type="posttest">
                            <span class="checkin-type-icon">âœ…</span>
                            <span class="checkin-type-name">Post-Test</span>
                            <span class="checkin-type-desc">After completing an assessment</span>
                        </button>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="checkin-notes">Any notes before you start? (optional)</label>
                    <textarea id="checkin-notes" class="form-textarea" placeholder="How are you feeling about this topic?" rows="2"></textarea>
                </div>
                
                <div class="checkin-instructions">
                    <p>ðŸ‘‰ You'll review each learning item and update your understanding level.</p>
                    <p>The check-in will finish when you've reviewed all items, or you can stop early.</p>
                </div>
                
                <div style="display: flex; gap: var(--space-3); justify-content: flex-end;">
                    <button class="btn btn-secondary" id="checkin-cancel-btn">Cancel</button>
                    <button class="btn btn-success" id="checkin-start-btn">â–¶ï¸ Begin Check-in</button>
                </div>
                
            </div>
        </div>
    </div>

    <script>
'use strict';

// ============================================
// EMBEDDED TOPICS (for offline/local file use)
// ============================================
const EMBEDDED_TOPICS = {"year-7-forces": {"id": "year-7-forces", "name": "Forces", "subject": "Science", "yearLevel": "Year 7", "class": "Y7 Forces", "curriculumCode": "VC2S8U13, VC2S8I04, VC2S8I05, VC2S8I06", "description": "An introduction to forces, including types of forces, simple machines, balanced and unbalanced forces, and gravity.", "subtopics": [{"id": "understanding-forces", "name": "Understanding Forces", "icon": "ðŸ’ª", "what": "This subtopic covers the fundamental concept of what a force is, how forces affect objects, and how we represent and measure forces. You will learn that forces are pushes or pulls that always involve an interaction between two objects.", "why": "Understanding forces is essential because forces explain why objects move, stop, speed up, slow down, or change shape. Every physical interaction you experience involves forces, from opening a door to catching a ball.", "items": [{"id": 1, "title": "I can define a force as a push or a pull that involves an interaction between two objects", "code": "1.1.1", "what": "A force is not something an object contains. It always involves one object exerting a push or pull on another object.", "why": "This definition helps you identify forces in any situation by looking for the two objects involved in the interaction.", "example": "When you kick a football, your foot (object 1) exerts a push force on the ball (object 2). The force is the interaction between your foot and the ball.", "questions": {"toLevel2": [], "toLevel3": [], "toLevel4": [], "toLevel5": [{"question": "A student says: 'When I throw a ball, I give it force, and it keeps that force until it hits the ground.' Which response best explains why this statement is incorrect?", "correct": "Forces are interactions between two objects, not something stored inside an object. Once the ball leaves your hand, your hand no longer exerts a force on it.", "correctExplanation": "This correctly identifies the core misconceptionâ€”forces require ongoing interaction between two objects and cannot be 'given' to or 'stored' in an object.", "distractors": [{"answer": "The statement is correct because your throwing force stays in the ball and gradually runs out as it flies through the air.", "explanation": "This reinforces the misconception. Forces cannot be stored in objects or 'run out'â€”they exist only during interactions between objects."}, {"answer": "The statement is incorrect because the ball actually gains more force from gravity as it falls, replacing the throwing force.", "explanation": "This replaces one misconception with another. Forces don't 'replace' each other inside objects. Gravity is a separate interaction between the ball and Earth."}, {"answer": "The statement is incorrect because only living things can give force to objects, and the ball is not alive.", "explanation": "This reflects the misconception that only animate objects can exert forces. Non-living things like walls, springs, and the ground also exert forces through interactions."}]}, {"question": "A heavy truck is parked on a flat road. A student claims: 'There are no forces acting on the truck because it isn't moving.' How should you respond?", "correct": "There are forces acting on the truck. Gravity pulls it downward, and the road pushes it upward. These forces are balanced, which is why the truck stays still.", "correctExplanation": "This correctly identifies that forces exist even on stationary objects and explains the balanced force situation.", "distractors": [{"answer": "The student is correct. Forces only exist when objects are moving or about to move, so a parked truck has no forces on it.", "explanation": "This reflects the misconception that forces only exist during motion. Stationary objects can have multiple balanced forces acting on them."}, {"answer": "The truck has internal forces from its engine and brakes, but no external forces are acting on it from outside.", "explanation": "This confuses internal mechanisms with the forces we study in physics. Gravity and the road's support force are external forces acting on the truck."}, {"answer": "The only force is gravity, but it stops working when the truck touches the ground, which is why the truck stays still.", "explanation": "Gravity doesn't 'stop working' when objects touch the ground. The truck stays still because the road exerts an upward force equal to gravity."}]}]}}, {"id": 2, "title": "I can classify a force as either a push or a pull", "code": "1.1.2", "what": "Every force can be categorised as either pushing (moving objects away) or pulling (drawing objects closer).", "why": "Being able to identify the type of force helps you predict how an object will respond to that force.", "example": "Dragging a sled over snow is a pull. Pressing a button on a keyboard is a push.", "questions": {"toLevel2": [], "toLevel3": [], "toLevel4": [], "toLevel5": [{"question": "A student is confused about gravity. They ask: 'Is gravity a push or a pull? It seems different from normal forces.' Which response correctly addresses this?", "correct": "Gravity is a pull. It attracts objects toward each other. When you drop something, Earth pulls it downward toward Earth's centre.", "correctExplanation": "This correctly classifies gravity as a pull force and explains the direction of attraction.", "distractors": [{"answer": "Gravity is neither a push nor a pull. It is a special type of force that simply makes objects fall without pushing or pulling them.", "explanation": "This reflects the misconception that gravity is somehow different from other forces. All forces are pushes or pullsâ€”gravity pulls objects toward massive bodies."}, {"answer": "Gravity is a push. The air above objects pushes them down toward the ground, which is why gravity only works where there is air.", "explanation": "This confuses gravity with air pressure and incorrectly claims gravity requires air. Gravity works in a vacuum and is a pull, not a push."}, {"answer": "Gravity can be either a push or a pull depending on the situation. It pulls light objects but pushes heavy objects toward the ground.", "explanation": "Gravity is always a pull, regardless of an object's mass. Heavier objects experience a stronger pull, but the force direction is always attractive."}]}]}}, {"id": 3, "title": "I can identify the six effects that forces can have on objects", "code": "1.1.3", "what": "Forces can: start an object moving, stop an object moving, speed up a moving object, slow down a moving object, change the direction of a moving object, or change the shape of an object.", "why": "Recognising these effects allows you to work backwards from what you observe to identify what forces must be acting.", "example": "When a tennis player hits a ball with a racquet, the force changes the direction the ball is moving. When you knead dough, the force changes its shape.", "questions": {"toLevel2": [], "toLevel3": [], "toLevel4": [], "toLevel5": [{"question": "A rolling basketball gradually slows down and stops on the gym floor. A student says: 'The ball stopped on its own because moving objects naturally come to rest.' What is wrong with this explanation?", "correct": "Objects don't naturally stop on their own. A force (friction from the floor) acted on the ball to slow it down. Without friction, the ball would keep rolling.", "correctExplanation": "This correctly identifies that slowing down requires a force (friction) and challenges the misconception that objects naturally come to rest.", "distractors": [{"answer": "The student is correct. All moving objects naturally slow down over time because their motion gradually wears out.", "explanation": "This reinforces the Aristotelian misconception. Motion doesn't 'wear out'â€”objects change speed only when forces act on them."}, {"answer": "The ball stopped because it ran out of the force that was making it move. Once the pushing force was used up, it had to stop.", "explanation": "This reflects the 'force as fuel' misconception. Forces are not stored or used up. The ball slowed because friction continuously acted against its motion."}, {"answer": "The ball stopped because gravity eventually overpowered its forward motion and pulled it to a stop on the floor.", "explanation": "On a flat floor, gravity acts downward, not against horizontal motion. Friction, not gravity, slowed the ball's horizontal movement."}]}, {"question": "When you squeeze a stress ball, it changes shape. When you release it, it returns to its original shape. A student asks: 'Is changing shape really an effect of force, or is it just what soft materials do?' How do you explain?", "correct": "Changing shape is definitely a force effect. Your hand exerts a squeezing force that deforms the ball. When you release it, elastic forces inside the ball push it back to its original shape.", "correctExplanation": "This correctly identifies both the applied force causing deformation and the internal elastic force causing shape recovery.", "distractors": [{"answer": "Changing shape isn't really a force effect. It's just a property of soft materials. Forces only affect motion, not shape.", "explanation": "This is incorrectâ€”changing shape is one of the six recognised effects of forces. Forces can affect both motion and shape."}, {"answer": "The shape change is caused by force, but the ball returning to shape happens automatically without any forceâ€”it's just the material's memory.", "explanation": "The recovery also involves force. Elastic forces within the deformed material actively push it back toward its original shape."}, {"answer": "Forces can only change the shape of soft objects. Hard objects like rocks cannot have their shape changed by forces.", "explanation": "Forces can change the shape of any object if strong enough. Hard objects require much larger forces to deform, but they still respond to force."}]}]}}, {"id": 4, "title": "I can use force arrows to represent the strength and direction of forces", "code": "1.1.4", "what": "In diagrams, arrows represent forces. The length of the arrow shows the strength of the force (longer = stronger), and the direction of the arrow shows which way the force acts.", "why": "Force diagrams allow you to visualise and compare multiple forces acting on an object, which helps predict how the object will move.", "example": "A diagram of a book on a table shows a short arrow pointing down (gravity) and an equally short arrow pointing up (the table pushing back). Equal arrow lengths show balanced forces.", "questions": {"toLevel2": [], "toLevel3": [], "toLevel4": [], "toLevel5": [{"question": "Two students draw force diagrams for a book on a table. Student A draws equal-length arrows pointing up and down. Student B draws a long arrow pointing down and a short arrow pointing up. The book is stationary. Which diagram is correct and why?", "correct": "Student A is correct. Since the book is stationary, the forces must be balanced. Equal arrow lengths correctly show that gravity downward equals the table's support force upward.", "correctExplanation": "This correctly links the physical situation (stationary object) to the diagram requirement (equal arrows for balanced forces).", "distractors": [{"answer": "Student B is correct. Gravity is always stronger than other forces, so the downward arrow should be longer even when objects aren't moving.", "explanation": "If gravity were stronger, the book would accelerate downward. A stationary object proves the forces are balanced, requiring equal arrow lengths."}, {"answer": "Both diagrams could be correct. Arrow length is just for decoration and doesn't need to represent anything specific about the forces.", "explanation": "Arrow length is meaningfulâ€”it represents force magnitude. Diagrams with incorrect arrow lengths misrepresent the physical situation."}, {"answer": "Neither diagram is correct. A stationary book has no forces acting on it, so no arrows should be drawn.", "explanation": "Stationary objects can have multiple balanced forces. The book has gravity and support force acting on itâ€”both should be shown with equal arrows."}]}, {"question": "A student draws a force arrow for a ball being thrown upward. The arrow points upward from the ball while it's in mid-air (after leaving the hand). What feedback should you give?", "correct": "The arrow is incorrect. Once the ball leaves the thrower's hand, the only significant force is gravity pulling downward. There should be a downward arrow, not an upward one.", "correctExplanation": "This correctly identifies that the throwing force only acts during contact. In mid-air, only gravity (and small air resistance) act on the ball.", "distractors": [{"answer": "The arrow is correct. The throwing force stays with the ball as it travels upward, so an upward arrow correctly shows this force.", "explanation": "Forces don't stay with objects. The throwing force existed only while hand contacted ball. In mid-air, no upward force acts on the ball."}, {"answer": "The arrow should point in the direction the ball is moving. Since the ball moves upward, an upward arrow is correct.", "explanation": "Force arrows show force direction, not motion direction. A ball can move upward while the only force (gravity) acts downward."}, {"answer": "The arrow should point upward because the ball is fighting against gravity. The upward arrow shows the ball's resistance to falling.", "explanation": "Objects don't 'fight' or 'resist' forces. The ball moves upward due to its initial velocity, not because of an upward force. Only gravity acts on it."}]}]}}, {"id": 5, "title": "I can state that forces are measured in newtons (N)", "code": "1.1.5", "what": "The newton is the unit of force, named after Isaac Newton. The symbol is a capital N.", "why": "Using standard units allows scientists to communicate and compare force measurements precisely.", "example": "The force of gravity on an apple is about 1 N. A 1-litre carton of milk pushes down on your hand with about 10 N.", "questions": {"toLevel2": [], "toLevel3": [], "toLevel4": [], "toLevel5": [{"question": "A student measures an object and writes: 'The force of gravity on this object is 15 kg.' Another student says this is wrong. Who is correct and why?", "correct": "The second student is correct. Force is measured in newtons (N), not kilograms. Kilograms measure mass. The student should have written the force in newtons.", "correctExplanation": "This correctly distinguishes between force (measured in N) and mass (measured in kg)â€”a fundamental distinction.", "distractors": [{"answer": "The first student is correct. Kilograms and newtons are interchangeable units that both measure how heavy something is.", "explanation": "Kilograms and newtons measure different quantities. Kilograms measure mass (amount of matter); newtons measure force (push or pull strength)."}, {"answer": "Both students could be correct. Scientists use kilograms for small forces and newtons for large forces.", "explanation": "The choice of unit doesn't depend on force size. Forces are always measured in newtons; mass is always measured in kilograms. They measure different things."}, {"answer": "The second student is being too picky. Everyone knows what the first student meant, so either unit is acceptable in everyday situations.", "explanation": "In science, precision matters. Using the wrong unit indicates confusion between mass and forceâ€”fundamentally different concepts that shouldn't be conflated."}]}]}}, {"id": 6, "title": "I can use a spring balance to measure forces", "code": "1.1.6", "what": "A spring balance measures force by showing how much a spring stretches when a force is applied to it.", "why": "Spring balances are practical tools for measuring forces in experiments, allowing you to collect quantitative data.", "example": "To measure the force needed to drag a jug across a desk, attach the spring balance to the jug and pull steadily while reading the scale at the moment the jug starts moving.", "questions": {"toLevel2": [], "toLevel3": [], "toLevel4": [], "toLevel5": [{"question": "A student attaches a spring balance to a heavy box and pulls. While the box is accelerating (speeding up), the scale shows 45 N. When pulling at constant speed, it shows 30 N. The student records '45 N' as the force needed to move the box. What mistake did they make?", "correct": "They read the scale while accelerating instead of at constant speed. The 45 N includes extra force for acceleration. The 30 N reading at constant speed correctly shows the force needed to overcome friction.", "correctExplanation": "This identifies the key measurement principle: read spring balances during steady motion, not during acceleration.", "distractors": [{"answer": "They should have recorded the average of both readings: (45 + 30) Ã· 2 = 37.5 N. Taking the average gives the most accurate measurement.", "explanation": "Averaging isn't appropriate here. The two readings measure different situations. The constant-speed reading is the relevant one for friction force."}, {"answer": "They should have recorded 45 N because the highest reading always shows the true force required. Lower readings mean the spring isn't fully stretched.", "explanation": "Higher readings during acceleration include the extra force needed to speed up the box, not just overcome friction. The highest reading isn't automatically the most useful."}, {"answer": "Both readings are equally valid. Spring balances work the same whether objects are accelerating or moving at constant speed.", "explanation": "The readings measure different things. During acceleration, you measure friction plus the force causing acceleration. At constant speed, you measure only the force balancing friction."}]}, {"question": "A student wants to measure the weight of a small rock using a spring balance. They hold the spring balance with the rock attached and read '2.5 N' while lowering their hand quickly. Is this measurement likely to be accurate?", "correct": "No, the measurement is likely inaccurate. Lowering quickly reduces the tension in the spring. They should hold the spring balance still or move it very slowly to get an accurate weight reading.", "correctExplanation": "This correctly identifies that accelerating the spring balance (lowering quickly) affects the reading by reducing apparent weight.", "distractors": [{"answer": "Yes, the measurement is accurate. Spring balances give correct readings regardless of how you move them, as long as the object stays attached.", "explanation": "Movement affects readings. Accelerating the balance changes the tension in the spring, giving readings that don't represent the object's true weight."}, {"answer": "Yes, the measurement is accurate. Moving quickly gives a better reading because the spring has less time to bounce and wobble.", "explanation": "Quick movement introduces acceleration effects that distort readings. Steady or slow movement allows the spring to settle to a true weight reading."}, {"answer": "No, lowering quickly makes the reading too high because the spring stretches more when moving. The rock's weight would actually be less than 2.5 N.", "explanation": "This gets the direction wrong. Lowering quickly reduces spring tension and gives a reading that's too low, not too high."}]}]}}]}, {"id": "types-of-forces", "name": "Types of Forces", "icon": "ðŸ§²", "what": "This subtopic covers the different types of forces you encounter in everyday life, including applied force, gravity, tension, magnetism, friction, air resistance, water resistance, and elastic force. You will also learn to classify these as contact or non-contact forces.", "why": "Different types of forces have different causes and behave differently. Identifying the type of force helps you understand and predict how objects will interact in various situations.", "items": [{"id": 7, "title": "I can identify an applied force as a push or pull exerted by a person, animal, or machine", "code": "1.4.1", "what": "An applied force is any force that is deliberately exerted on an object by something else.", "why": "Applied forces are the most common forces we control in everyday life, from pushing a shopping trolley to pulling open a drawer.", "example": "When a person pushes a couch across the floor, they are exerting an applied force on the couch.", "questions": {"toLevel2": [], "toLevel3": [], "toLevel4": [], "toLevel5": []}}, {"id": 8, "title": "I can describe gravity as a force of attraction between all objects with mass", "code": "1.4.2", "what": "Gravity pulls objects toward each other. The more massive the objects, the stronger the gravitational attraction.", "why": "Gravity keeps us on Earth, causes objects to fall, and holds planets in orbit around the Sun.", "example": "When you drop a ball, gravity pulls it toward the Earth. The Earth is also pulled slightly toward the ball, but the Earth is so massive that this movement is undetectable.", "questions": {"toLevel2": [], "toLevel3": [], "toLevel4": [], "toLevel5": []}}, {"id": 9, "title": "I can define tension as an inward pulling force in a stretched object", "code": "1.4.3", "what": "Tension occurs in ropes, cables, and strings when they are pulled tight. The force acts along the length of the object.", "why": "Tension forces are important in structures like bridges and in everyday objects like bags with straps.", "example": "When you carry a bag by its strap, the strap experiences tension. The tension force pulls inward along the strap, supporting the weight of the bag.", "questions": {"toLevel2": [], "toLevel3": [], "toLevel4": [], "toLevel5": []}}, {"id": 10, "title": "I can explain that magnetism is a force of attraction or repulsion between certain materials", "code": "1.4.4", "what": "Magnetic forces act between materials containing iron, cobalt, or nickel. Unlike gravity, magnetism can either attract or repel.", "why": "Magnetism is used in many technologies, from fridge magnets to electric motors and computer hard drives.", "example": "Magnetic letters stick to a fridge door because the magnetic force attracts them to the metal surface of the fridge.", "questions": {"toLevel2": [], "toLevel3": [], "toLevel4": [], "toLevel5": []}}, {"id": 11, "title": "I can describe friction as a force that resists the motion of one object relative to another", "code": "1.4.5", "what": "Friction occurs when surfaces rub against each other. It acts in the opposite direction to the motion or attempted motion.", "why": "Friction allows us to walk without slipping and helps cars grip the road. It also causes wear on moving parts and generates heat.", "example": "When a coffee cup slides across a table, friction between the cup and table acts in the opposite direction to the cup's motion, causing it to slow down and stop.", "questions": {"toLevel2": [], "toLevel3": [], "toLevel4": [], "toLevel5": []}}, {"id": 12, "title": "I can identify air resistance and water resistance as types of friction", "code": "1.4.6", "what": "Air resistance slows objects moving through air. Water resistance slows objects moving through water. Both act opposite to the direction of motion.", "why": "These forces affect the speed of vehicles, falling objects, and swimmers, and must be considered in design and performance.", "example": "A parachute works by increasing air resistance. The large surface area of the parachute creates a strong upward air resistance force that slows the skydiver's fall.", "questions": {"toLevel2": [], "toLevel3": [], "toLevel4": [], "toLevel5": []}}, {"id": 13, "title": "I can explain that elastic force causes stretched or compressed objects to return to their original shape", "code": "1.4.7", "what": "When you stretch or squash an elastic object, it exerts a force trying to return to its original shape.", "why": "Elastic forces are used in springs, rubber bands, and bouncy balls, and explain why these objects behave the way they do.", "example": "When a soft ball hits the ground and bounces, the ball compresses on impact. The elastic force pushes the ball back up as it returns to its original shape.", "questions": {"toLevel2": [], "toLevel3": [], "toLevel4": [], "toLevel5": []}}, {"id": 14, "title": "I can classify forces as either contact or non-contact forces", "code": "1.4.8", "what": "Contact forces require objects to be touching (friction, applied force, tension, elastic force, air resistance, water resistance). Non-contact forces can act at a distance without touching (gravity, magnetism).", "why": "This classification helps identify what forces might be acting on an object by checking what it's touching and what non-contact forces might apply.", "example": "A ball flying through the air experiences gravity (non-contact, always present) and air resistance (contact, because the ball touches the air molecules).", "questions": {"toLevel2": [], "toLevel3": [], "toLevel4": [], "toLevel5": []}}]}, {"id": "simple-machines", "name": "Simple Machines", "icon": "âš™ï¸", "what": "This subtopic covers how simple machines like ramps, levers, and pulleys change the magnitude or direction of forces. You will learn about effort force, the parts of a lever, and how to calculate the efficiency of simple machines.", "why": "Simple machines have been used throughout history to accomplish tasks that would otherwise be impossible, from building pyramids to modern construction. Understanding them helps you see how engineering makes work easier.", "items": [{"id": 15, "title": "I can explain that a simple machine changes the magnitude or direction of a force", "code": "1.2.1", "what": "Simple machines are devices with few or no moving parts that make work easier by changing how forces are applied.", "why": "Simple machines allow us to lift heavy objects, move things more easily, or apply forces in more convenient directions.", "example": "A ramp allows you to move a heavy box to a higher level by pushing it along a slope instead of lifting it straight up. You use less force, but over a longer distance.", "questions": {"toLevel2": [], "toLevel3": [], "toLevel4": [], "toLevel5": []}}, {"id": 16, "title": "I can identify the six types of simple machines", "code": "1.3.1", "what": "The six simple machines are: lever, inclined plane (ramp), wedge, pulley, screw, and wheel and axle.", "why": "Recognising these categories helps you identify how different tools and devices work to make tasks easier.", "example": "A hammer removing a nail uses lever action. A corkscrew combines a screw and a lever. A skateboard ramp is an inclined plane.", "questions": {"toLevel2": [], "toLevel3": [], "toLevel4": [], "toLevel5": []}}, {"id": 17, "title": "I can define effort force as the force used to move an object", "code": "1.2.2", "what": "The effort force is the force you apply to a simple machine to move a load. Simple machines can reduce the effort force needed.", "why": "Understanding effort force helps you predict how much force you need to apply when using different machines.", "example": "When dragging a bag of rice up a ramp, the effort force is the force you apply by pulling. A gentler ramp requires less effort force than a steep one.", "questions": {"toLevel2": [], "toLevel3": [], "toLevel4": [], "toLevel5": []}}, {"id": 18, "title": "I can describe how the angle of inclination of a ramp affects the effort force required", "code": "1.2.3", "what": "A smaller angle of inclination (gentler slope) requires less effort force but a longer distance. A larger angle requires more effort force over a shorter distance.", "why": "This trade-off between force and distance is fundamental to how ramps work and must be considered in practical applications.", "example": "The ancient Egyptians used long, gently sloped ramps to move heavy stone blocks up the pyramids. The gentle slope reduced the effort force needed, even though the total distance was much longer.", "questions": {"toLevel2": [], "toLevel3": [], "toLevel4": [], "toLevel5": []}}, {"id": 19, "title": "I can identify the three parts of a lever: fulcrum, effort arm, and resistance arm", "code": "2.2.1", "what": "The fulcrum is the pivot point. The effort arm is where force is applied. The resistance arm is connected to the object being moved.", "why": "Knowing these parts allows you to understand how different lever designs change the force or speed of movement.", "example": "On a see-saw, the fulcrum is the central pivot. Your legs push down on one effort arm, and your friend on the other side is the resistance.", "questions": {"toLevel2": [], "toLevel3": [], "toLevel4": [], "toLevel5": []}}, {"id": 20, "title": "I can distinguish between force multipliers and speed multipliers", "code": "2.2.2", "what": "Force multipliers have a longer effort arm than resistance arm, reducing the effort needed. Speed multipliers have a longer resistance arm, increasing the speed of the output.", "why": "Different tasks require different lever designs. Lifting heavy loads needs force multiplication; throwing far needs speed multiplication.", "example": "A wheelbarrow is a force multiplierâ€”the long handles let you lift heavy loads with less effort. A cricket bat is a speed multiplierâ€”the long bat makes the ball travel faster than your hands move.", "questions": {"toLevel2": [], "toLevel3": [], "toLevel4": [], "toLevel5": []}}, {"id": 21, "title": "I can explain how pulleys change the force needed to lift an object", "code": "1.3.2", "what": "A single pulley changes the direction of a force. Multiple pulleys can reduce the effort force needed to lift a load.", "why": "Pulleys are used in construction, sailing, and many other applications where heavy loads need to be lifted or moved.", "example": "With a single pulley, you pull down to lift something upâ€”same force, different direction. With two pulleys, you might need only half the effort force to lift the same load.", "questions": {"toLevel2": [], "toLevel3": [], "toLevel4": [], "toLevel5": []}}, {"id": 22, "title": "I can calculate the efficiency of a simple machine using the formula: efficiency = (force without machine Ã· force with machine) Ã— 100", "code": "1.3.3", "what": "Efficiency tells you how much easier a simple machine makes a task, expressed as a percentage.", "why": "Comparing efficiency helps you choose the best tool for a job and understand the trade-offs involved.", "example": "If lifting a bag of rice requires 2.1 N without a machine and 1.5 N with a wheel and axle, the efficiency is (2.1 Ã· 1.5) Ã— 100 = 140%. The higher the percentage, the more the machine helps.", "questions": {"toLevel2": [], "toLevel3": [], "toLevel4": [], "toLevel5": []}}]}, {"id": "balanced-unbalanced-forces", "name": "Balanced and Unbalanced Forces", "icon": "âš–ï¸", "what": "This subtopic covers how multiple forces acting on an object combine to produce balanced or unbalanced situations, and how to calculate the net force. You will learn to predict whether an object will change its motion based on the forces acting on it.", "why": "Understanding balanced and unbalanced forces explains why some objects stay still, others move at constant speed, and others speed up, slow down, or change direction. This is fundamental to predicting motion.", "items": [{"id": 23, "title": "I can explain that balanced forces are equal in size and opposite in direction", "code": "2.1.1", "what": "When forces on an object are balanced, they cancel each other out and have no effect on the object's motion.", "why": "Recognising balanced forces explains why objects at rest stay at rest and why moving objects can continue at constant speed.", "example": "A book on a table has gravity pulling it down and the table pushing it up. These forces are equal and opposite, so the book stays still.", "questions": {"toLevel2": [], "toLevel3": [], "toLevel4": [], "toLevel5": []}}, {"id": 24, "title": "I can identify that balanced forces can act on both stationary and moving objects", "code": "2.1.2", "what": "An object with balanced forces will maintain its current stateâ€”if stationary, it stays still; if moving, it continues at the same speed and direction.", "why": "This corrects the common misconception that balanced forces only apply to objects that are not moving.", "example": "A skydiver at terminal velocity has balanced forcesâ€”gravity pulling down equals air resistance pushing up. Even though the forces are balanced, the skydiver continues falling at a constant speed.", "questions": {"toLevel2": [], "toLevel3": [], "toLevel4": [], "toLevel5": []}}, {"id": 25, "title": "I can explain that unbalanced forces cause a change in an object's motion", "code": "2.1.3", "what": "When forces are unbalanced, the object will speed up, slow down, start moving, stop moving, or change direction.", "why": "Unbalanced forces are responsible for all changes in motion, which is essential for understanding how objects accelerate or decelerate.", "example": "When a car brakes, friction from the brakes creates an unbalanced force that slows the car down. The backward friction force is greater than any forward force, so the car decelerates.", "questions": {"toLevel2": [], "toLevel3": [], "toLevel4": [], "toLevel5": []}}, {"id": 26, "title": "I can define net force as the overall force acting on an object", "code": "2.7.1", "what": "Net force is the result of combining all forces acting on an object. It tells you the overall effect of those forces.", "why": "Calculating net force allows you to predict how an object will move without having to consider each individual force separately.", "example": "If three people push a trolleyâ€”two pushing left with 100 N each and one pushing right with 50 Nâ€”the net force is 200 N âˆ’ 50 N = 150 N to the left.", "questions": {"toLevel2": [], "toLevel3": [], "toLevel4": [], "toLevel5": []}}, {"id": 27, "title": "I can calculate net force when forces act in opposite directions by subtracting the smaller from the larger", "code": "2.7.2", "what": "When forces act in opposite directions, they partially cancel. Subtract the smaller force from the larger to find the net force, which acts in the direction of the larger force.", "why": "This calculation is used constantly in physics to determine how objects will move when multiple opposing forces act on them.", "example": "A parachutist experiences 1500 N of gravity downward and 800 N of air resistance upward. Net force = 1500 N âˆ’ 800 N = 700 N downward. The parachutist accelerates downward.", "questions": {"toLevel2": [], "toLevel3": [], "toLevel4": [], "toLevel5": []}}, {"id": 28, "title": "I can calculate net force when forces act in the same direction by adding them", "code": "2.7.3", "what": "When forces act in the same direction, they combine to produce a larger net force in that direction.", "why": "This explains why two people pushing together can move something that neither could move alone.", "example": "Two cyclists on a tandem bike push with 200 N and 150 N in the same direction. Net force = 200 N + 150 N = 350 N forward.", "questions": {"toLevel2": [], "toLevel3": [], "toLevel4": [], "toLevel5": []}}, {"id": 29, "title": "I can determine that the net force is zero when forces are balanced", "code": "2.7.4", "what": "When all forces cancel out exactly, the net force is 0 N, and there is no change in the object's motion.", "why": "A net force of zero is the condition for equilibrium, where objects either remain stationary or continue moving at constant velocity.", "example": "In a tug-of-war where neither team is moving, the pulling forces are equal and opposite. Net force = 0 N, so the rope stays in place.", "questions": {"toLevel2": [], "toLevel3": [], "toLevel4": [], "toLevel5": []}}]}, {"id": "gravity-and-weight", "name": "Gravity and Weight", "icon": "ðŸŒ", "what": "This subtopic covers gravitational fields, gravitational field strength, and the important distinction between mass and weight. You will learn to calculate weight using the formula W = m Ã— g and understand why astronauts appear weightless.", "why": "Gravity affects everything on Earth and beyond. Understanding gravitational fields and the difference between mass and weight is essential for understanding space travel, planetary motion, and everyday phenomena like falling objects.", "items": [{"id": 30, "title": "I can explain that a gravitational field is the region around an object where another object experiences gravitational force", "code": "3.1.1", "what": "Every object with mass has a gravitational field surrounding it. Any other object within that field will experience a gravitational pull toward the first object.", "why": "The concept of fields helps explain how gravity can act at a distance without objects touching.", "example": "The Earth has a gravitational field extending far into space. The Moon is within Earth's gravitational field, which is why it orbits Earth rather than drifting away.", "questions": {"toLevel2": [], "toLevel3": [], "toLevel4": [], "toLevel5": []}}, {"id": 31, "title": "I can describe how gravitational field strength decreases with distance from an object", "code": "3.1.2", "what": "The further you are from an object, the weaker its gravitational pull on you. Gravitational field strength is measured in newtons per kilogram (N/kg).", "why": "This explains why astronauts in orbit experience weaker gravity than people on Earth's surface, and why distant planets have little gravitational effect on us.", "example": "Earth's gravitational field strength is 9.8 N/kg at the surface but only about 8.8 N/kg at the height of the International Space Station (370 km up).", "questions": {"toLevel2": [], "toLevel3": [], "toLevel4": [], "toLevel5": []}}, {"id": 32, "title": "I can distinguish between mass and weight", "code": "3.1.3", "what": "Mass is the amount of matter in an object, measured in kilograms (kg). Weight is the gravitational force on an object, measured in newtons (N). Mass stays constant; weight changes depending on gravitational field strength.", "why": "Confusing mass and weight is a common error. Understanding the difference is essential for solving problems involving gravity and for understanding space travel.", "example": "A 50 kg person has the same mass on Earth and the Moon. But their weight on Earth is about 490 N, while on the Moon (weaker gravity) it is only about 81 N.", "questions": {"toLevel2": [], "toLevel3": [], "toLevel4": [], "toLevel5": []}}, {"id": 33, "title": "I can calculate weight using the formula W = m Ã— g", "code": "3.1.4", "what": "Weight equals mass multiplied by gravitational field strength. W is weight in newtons, m is mass in kilograms, and g is gravitational field strength in N/kg.", "why": "This formula allows you to calculate the gravitational force on any object at any location if you know its mass and the local gravitational field strength.", "example": "Calculate the weight of a 2 kg brick on Venus (g = 8.8 N/kg): W = m Ã— g = 2 kg Ã— 8.8 N/kg = 17.6 N", "questions": {"toLevel2": [], "toLevel3": [], "toLevel4": [], "toLevel5": []}}, {"id": 34, "title": "I can explain why astronauts on the International Space Station appear weightless", "code": "3.2.1", "what": "Astronauts appear weightless because they and the space station are both falling toward Earth at the same rate while moving sideways fast enough to keep missing it (orbiting). They still have weightâ€”gravity still acts on them.", "why": "This corrects the misconception that there is no gravity in space. Astronauts are not truly weightless; they are in continuous free fall.", "example": "An 80 kg astronaut on the ISS still has a weight of about 704 N (using g = 8.8 N/kg at that altitude). They float because the station falls with them, not because gravity has disappeared.", "questions": {"toLevel2": [], "toLevel3": [], "toLevel4": [], "toLevel5": []}}]}]}};



// ============================================
// EXAMPLE TOPIC DATA - Replace with your curriculum content
// ============================================

// ============================================
// STATE MANAGEMENT
// ============================================
const STORAGE_KEY = 'dynamicLearningCheckin';
const MAX_UNDO = 50;

let appState = {
    student: {
        name: '',
        class: ''
    },
    topic: null,
    currentTopicId: null,
    learningItems: {},
    checkins: [],
    goals: [],
    questions: [],
    theme: 'light',
    lastSaved: null
};

// Manifest data (loaded from manifest.json)
let manifest = null;

// Per-topic progress storage
let topicProgressStore = {};

// Currently selected dropdown values
let selectedYearLevel = null;
let selectedSubject = null;

let undoStack = [];
let redoStack = [];

// ============================================
// QUIZ SYSTEM STATE
// ============================================
const QUIZ_STATE_KEY = 'learning-checkin-quiz-state';
const QUIZ_LOCKOUT_DURATION = 5 * 60 * 1000; // 5 minutes in milliseconds

let quizState = {}; // Per-item, per-level quiz tracking
let currentQuiz = null; // Currently active quiz data

const levelNames = ['Not started', 'Beginning', 'Developing', 'Confident', 'Mastered'];
const levelEmojis = ['ðŸŒ±', 'ðŸŒ¿', 'ðŸŒ³', 'ðŸŒ²', 'â­Â'];

// ============================================
// STORAGE
// ============================================
const PROGRESS_STORE_KEY = 'learning-checkin-progress-store';

function saveData() {
    appState.lastSaved = new Date().toISOString();
    try {
        // Save current topic's progress to the per-topic store
        if (appState.currentTopicId) {
            topicProgressStore[appState.currentTopicId] = {
                learningItems: appState.learningItems,
                checkins: appState.checkins,
                goals: appState.goals,
                questions: appState.questions
            };
        }
        
        // Save app state (without topic-specific data duplicated)
        localStorage.setItem(STORAGE_KEY, JSON.stringify({
            student: appState.student,
            currentTopicId: appState.currentTopicId,
            topic: appState.topic,
            learningItems: appState.learningItems,
            checkins: appState.checkins,
            goals: appState.goals,
            questions: appState.questions,
            theme: appState.theme,
            lastSaved: appState.lastSaved
        }));
        
        // Save per-topic progress store
        localStorage.setItem(PROGRESS_STORE_KEY, JSON.stringify(topicProgressStore));
        
        updateSaveStatus();
    } catch (e) {
        console.error('Save failed:', e);
    }
}

function loadData() {
    try {
        // Load per-topic progress store
        const progressStore = localStorage.getItem(PROGRESS_STORE_KEY);
        if (progressStore) {
            topicProgressStore = JSON.parse(progressStore);
        }
        
        // Load app state
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
            const parsed = JSON.parse(saved);
            appState.student = parsed.student || appState.student;
            appState.currentTopicId = parsed.currentTopicId || null;
            appState.topic = parsed.topic || null;
            appState.learningItems = parsed.learningItems || {};
            appState.checkins = parsed.checkins || [];
            appState.goals = parsed.goals || [];
            appState.questions = parsed.questions || [];
            appState.theme = parsed.theme || 'light';
            
            if (appState.theme) applyTheme(appState.theme);
        }
        
        // Fall back to example topic if none loaded
        if (!appState.topic) {
            // No default topic - user must select from manifest
            // No default topic ID
        }
    } catch (e) {
        console.error('Load failed:', e);
        // Fall back to example topic
        // No default topic - user must select from manifest
        // No default topic ID
    }
    initLearningItems();
}

function initLearningItems() {
    if (!appState.topic || !appState.topic.subtopics) return;
    
    appState.topic.subtopics.forEach(subtopic => {
        subtopic.items.forEach(item => {
            if (!appState.learningItems[item.id]) {
                appState.learningItems[item.id] = {
                    level: 1,
                    history: [],
                    notes: []
                };
            }
        });
    });
}

function updateSaveStatus() {
    const el = document.getElementById('save-status');
    if (el) el.textContent = 'All changes saved';
}

// ============================================
// TOPIC LOADING
// ============================================
function showTopicLoading(show) {
    const indicator = document.getElementById('topic-loading-indicator');
    if (indicator) {
        indicator.classList.toggle('active', show);
    }
}

function updateTopicCurrentDisplay() {
    const display = document.getElementById('topic-current-name');
    if (display) {
        if (appState.topic) {
            display.textContent = `${appState.topic.name} (${appState.topic.yearLevel})`;
        } else {
            display.textContent = 'No topic selected';
        }
    }
}

// Save current topic progress before switching
function saveCurrentTopicProgress() {
    if (appState.currentTopicId) {
        topicProgressStore[appState.currentTopicId] = {
            learningItems: { ...appState.learningItems },
            checkins: [...appState.checkins],
            goals: [...appState.goals],
            questions: [...appState.questions]
        };
    }
}

// Restore progress for a topic (or initialize fresh)
function restoreTopicProgress(topicId) {
    if (topicProgressStore[topicId]) {
        const stored = topicProgressStore[topicId];
        appState.learningItems = stored.learningItems || {};
        appState.checkins = stored.checkins || [];
        appState.goals = stored.goals || [];
        appState.questions = stored.questions || [];
    } else {
        // Fresh start for this topic
        appState.learningItems = {};
        appState.checkins = [];
        appState.goals = [];
        appState.questions = [];
    }
}

// Load manifest from server
async function loadManifest() {
    try {
        showTopicLoading(true);
        
        const response = await fetch('manifest.json');
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}`);
        }
        manifest = await response.json();
        
        // Populate year level dropdown
        populateYearLevelDropdown();
        
        // Try to restore previous selection
        restoreDropdownSelection();
        
    } catch (error) {
        console.log('Manifest not available, using example topic:', error.message);
        // Manifest not available - that's okay, example topic is loaded by default
        // Hide the topic selector if no manifest
        const selectorBar = document.querySelector('.topic-selector-bar');
        if (selectorBar && !manifest) {
            selectorBar.style.display = 'none';
        }
    } finally {
        showTopicLoading(false);
    }
}

// Load a specific topic from server
async function loadTopicFromServer(topicFile) {
    try {
        showTopicLoading(true);
        
        // Check for embedded topic first (for local file use)
        const topicFileName = topicFile.split('/').pop().replace('.json', '');
        console.log('loadTopicFromServer called with:', topicFile);
        console.log('topicFileName extracted:', topicFileName);
        console.log('EMBEDDED_TOPICS defined?', typeof EMBEDDED_TOPICS !== 'undefined');
        
        if (typeof EMBEDDED_TOPICS !== 'undefined' && EMBEDDED_TOPICS) {
            console.log('EMBEDDED_TOPICS keys:', Object.keys(EMBEDDED_TOPICS));
            for (const [id, data] of Object.entries(EMBEDDED_TOPICS)) {
                // Match if the embedded ID contains the filename, or filename contains key part of ID
                const idParts = id.split('-');
                const lastPart = idParts[idParts.length - 1]; // e.g., "forces" from "year-7-forces"
                
                console.log('Checking:', id, 'lastPart:', lastPart, 'includes?', id.includes(topicFileName), 'equals?', topicFileName === lastPart);
                
                if (id.includes(topicFileName) || topicFileName === lastPart) {
                    console.log('MATCH FOUND! Returning embedded topic:', id);
                    showTopicLoading(false);
                    return data;
                }
            }
            console.log('No embedded match found');
        } else {
            console.log('EMBEDDED_TOPICS is not available');
        }
        
        // Try to fetch from server
        const response = await fetch(topicFile);
        if (!response.ok) {
            throw new Error(`HTTP ${response.status}: Could not load ${topicFile}`);
        }
        const topicData = await response.json();
        
        // Validate the topic data
        if (!topicData.name || !topicData.subtopics || !Array.isArray(topicData.subtopics)) {
            throw new Error('Invalid topic format: missing name or subtopics');
        }
        
        return topicData;
        
    } catch (error) {
        console.error('Failed to load topic:', error);
        showToast(`Failed to load topic: ${error.message}`, 'error');
        return null;
    } finally {
        showTopicLoading(false);
    }
}

// Switch to a new topic
async function switchTopic(topicId, topicFile) {
    // Save current progress
    saveCurrentTopicProgress();
    
    // Load topic data from server
    const topicData = await loadTopicFromServer(topicFile);
    
    if (topicData) {
        // Set new topic
        appState.topic = topicData;
        appState.currentTopicId = topicId;
        
        // Update class from topic if provided
        if (topicData.class) {
            appState.student.class = topicData.class;
            const classInput = document.getElementById('class-input');
            if (classInput) classInput.value = topicData.class;
        }
        
        // Restore or initialize progress for this topic
        restoreTopicProgress(topicId);
        
        // Initialize any new learning items
        initLearningItems();
        
        // Save and render
        saveData();
        renderAll();
        updateTopicCurrentDisplay();
        
        showToast(`Loaded: ${topicData.name}`, 'success');
    }
}

// Populate dropdown functions
function populateYearLevelDropdown() {
    const dropdown = document.getElementById('year-level-dropdown');
    if (!dropdown || !manifest) return;
    
    dropdown.innerHTML = '<option value="">Select Year Level</option>';
    
    manifest.yearLevels.forEach(yearLevel => {
        const option = document.createElement('option');
        option.value = yearLevel.id;
        option.textContent = yearLevel.name;
        dropdown.appendChild(option);
    });
}

function populateSubjectDropdown(yearLevelId) {
    const dropdown = document.getElementById('subject-dropdown');
    const topicDropdown = document.getElementById('topic-dropdown');
    
    if (!dropdown || !manifest) return;
    
    // Reset subject and topic dropdowns
    dropdown.innerHTML = '<option value="">Select Subject</option>';
    dropdown.disabled = true;
    topicDropdown.innerHTML = '<option value="">Select Topic</option>';
    topicDropdown.disabled = true;
    selectedSubject = null;
    
    if (!yearLevelId) return;
    
    const yearLevel = manifest.yearLevels.find(y => y.id === yearLevelId);
    if (!yearLevel) return;
    
    yearLevel.subjects.forEach(subject => {
        const option = document.createElement('option');
        option.value = subject.id;
        option.textContent = subject.name;
        dropdown.appendChild(option);
    });
    
    dropdown.disabled = false;
}

function populateTopicDropdown(yearLevelId, subjectId) {
    const dropdown = document.getElementById('topic-dropdown');
    
    if (!dropdown || !manifest) return;
    
    dropdown.innerHTML = '<option value="">Select Topic</option>';
    dropdown.disabled = true;
    
    if (!yearLevelId || !subjectId) return;
    
    const yearLevel = manifest.yearLevels.find(y => y.id === yearLevelId);
    if (!yearLevel) return;
    
    const subject = yearLevel.subjects.find(s => s.id === subjectId);
    if (!subject) return;
    
    subject.topics.forEach(topic => {
        const option = document.createElement('option');
        option.value = topic.id;
        option.dataset.file = topic.file;
        option.textContent = topic.name;
        dropdown.appendChild(option);
    });
    
    dropdown.disabled = false;
}

// Dropdown event handlers
function onYearLevelChange(event) {
    selectedYearLevel = event.target.value;
    populateSubjectDropdown(selectedYearLevel);
    saveDropdownSelection();
}

function onSubjectChange(event) {
    selectedSubject = event.target.value;
    populateTopicDropdown(selectedYearLevel, selectedSubject);
    saveDropdownSelection();
}

function onTopicChange(event) {
    const select = event.target;
    const selectedOption = select.options[select.selectedIndex];
    
    if (selectedOption && selectedOption.value) {
        const topicId = selectedOption.value;
        const topicFile = selectedOption.dataset.file;
        saveDropdownSelection();
        switchTopic(topicId, topicFile);
    }
}

// Save dropdown selection to localStorage
function saveDropdownSelection() {
    const selection = {
        yearLevel: selectedYearLevel,
        subject: selectedSubject,
        topicId: document.getElementById('topic-dropdown')?.value || null
    };
    localStorage.setItem('learning-checkin-dropdown-selection', JSON.stringify(selection));
}

// Restore dropdown selection from localStorage
function restoreDropdownSelection() {
    try {
        const saved = localStorage.getItem('learning-checkin-dropdown-selection');
        if (!saved || !manifest) return;
        
        const selection = JSON.parse(saved);
        
        // Restore year level
        if (selection.yearLevel) {
            const yearDropdown = document.getElementById('year-level-dropdown');
            if (yearDropdown) {
                yearDropdown.value = selection.yearLevel;
                selectedYearLevel = selection.yearLevel;
                populateSubjectDropdown(selection.yearLevel);
            }
        }
        
        // Restore subject
        if (selection.subject) {
            const subjectDropdown = document.getElementById('subject-dropdown');
            if (subjectDropdown) {
                subjectDropdown.value = selection.subject;
                selectedSubject = selection.subject;
                populateTopicDropdown(selection.yearLevel, selection.subject);
            }
        }
        
        // Restore topic selection (visual only, don't reload if already loaded)
        if (selection.topicId && appState.currentTopicId === selection.topicId) {
            const topicDropdown = document.getElementById('topic-dropdown');
            if (topicDropdown) {
                topicDropdown.value = selection.topicId;
            }
        }
    } catch (e) {
        console.log('Could not restore dropdown selection:', e);
    }
}

// ============================================
// QUIZ SYSTEM
// ============================================

function saveQuizState() {
    try {
        localStorage.setItem(QUIZ_STATE_KEY, JSON.stringify(quizState));
    } catch (e) {
        console.error('Failed to save quiz state:', e);
    }
}

function loadQuizState() {
    try {
        const saved = localStorage.getItem(QUIZ_STATE_KEY);
        if (saved) {
            quizState = JSON.parse(saved);
            // Clean up expired lockouts
            const now = Date.now();
            Object.keys(quizState).forEach(key => {
                if (quizState[key].lockedUntil && quizState[key].lockedUntil < now) {
                    // Reset state after lockout expires
                    quizState[key] = {
                        usedQuestions: [],
                        wrongCount: 0,
                        correctStreak: 0,
                        requiredCorrect: 1,
                        lockedUntil: null
                    };
                }
            });
            saveQuizState();
        }
    } catch (e) {
        console.error('Failed to load quiz state:', e);
        quizState = {};
    }
}

function getQuizStateKey(itemId, toLevel) {
    return `${appState.currentTopicId || 'default'}-${itemId}-toLevel${toLevel}`;
}

function getQuizState(itemId, toLevel) {
    const key = getQuizStateKey(itemId, toLevel);
    if (!quizState[key]) {
        quizState[key] = {
            usedQuestions: [],
            wrongCount: 0,
            correctStreak: 0,
            requiredCorrect: 1,
            lockedUntil: null
        };
    }
    return quizState[key];
}

function isLevelLocked(itemId, toLevel) {
    const state = getQuizState(itemId, toLevel);
    if (state.lockedUntil) {
        if (Date.now() < state.lockedUntil) {
            return true;
        } else {
            // Lockout expired, reset state
            state.usedQuestions = [];
            state.wrongCount = 0;
            state.correctStreak = 0;
            state.requiredCorrect = 1;
            state.lockedUntil = null;
            saveQuizState();
        }
    }
    return false;
}

function getLockoutRemainingTime(itemId, toLevel) {
    const state = getQuizState(itemId, toLevel);
    if (state.lockedUntil && Date.now() < state.lockedUntil) {
        return Math.ceil((state.lockedUntil - Date.now()) / 1000);
    }
    return 0;
}

function getQuestionsForLevel(itemId, toLevel) {
    if (!appState.topic) return [];
    
    // Find the item in subtopics
    for (const subtopic of appState.topic.subtopics) {
        const item = subtopic.items.find(i => i.id === itemId);
        if (item && item.questions) {
            const levelKey = `toLevel${toLevel}`;
            return item.questions[levelKey] || [];
        }
    }
    return [];
}

function getItemById(itemId) {
    if (!appState.topic) return null;
    for (const subtopic of appState.topic.subtopics) {
        const item = subtopic.items.find(i => i.id === itemId);
        if (item) return item;
    }
    return null;
}

function selectRandomQuestion(itemId, toLevel) {
    const questions = getQuestionsForLevel(itemId, toLevel);
    if (questions.length === 0) return null;
    
    const state = getQuizState(itemId, toLevel);
    
    // Find unused questions
    let availableIndices = [];
    for (let i = 0; i < questions.length; i++) {
        if (!state.usedQuestions.includes(i)) {
            availableIndices.push(i);
        }
    }
    
    // If all used, reshuffle
    if (availableIndices.length === 0) {
        state.usedQuestions = [];
        availableIndices = questions.map((_, i) => i);
        saveQuizState();
    }
    
    // Pick random from available
    const randomIndex = availableIndices[Math.floor(Math.random() * availableIndices.length)];
    return { question: questions[randomIndex], index: randomIndex };
}

function shuffleArray(array) {
    const shuffled = [...array];
    for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
    }
    return shuffled;
}

function showQuiz(itemId, fromLevel, toLevel) {
    const item = getItemById(itemId);
    if (!item) return false;
    
    const questionData = selectRandomQuestion(itemId, toLevel);
    if (!questionData) return false;
    
    const state = getQuizState(itemId, toLevel);
    const { question, index } = questionData;
    
    // Build options array with correct answer and distractors
    const options = [
        { text: question.correct, isCorrect: true, explanation: question.correctExplanation || 'That is correct.' }
    ];
    
    question.distractors.forEach(d => {
        if (typeof d === 'string') {
            options.push({ text: d, isCorrect: false, explanation: '' });
        } else {
            options.push({ text: d.answer, isCorrect: false, explanation: d.explanation || '' });
        }
    });
    
    // Shuffle options
    const shuffledOptions = shuffleArray(options);
    
    // Store current quiz data
    currentQuiz = {
        itemId,
        fromLevel,
        toLevel,
        questionIndex: index,
        question,
        options: shuffledOptions,
        selectedIndex: null,
        answered: false
    };
    
    // Update UI
    document.getElementById('quiz-item-title').textContent = item.title;
    document.getElementById('quiz-from-level').textContent = `${levelEmojis[fromLevel - 1]} ${levelNames[fromLevel - 1]}`;
    document.getElementById('quiz-to-level').textContent = `${levelEmojis[toLevel - 1]} ${levelNames[toLevel - 1]}`;
    document.getElementById('quiz-question-text').textContent = question.question;
    
    // Render options
    const optionsContainer = document.getElementById('quiz-options');
    optionsContainer.innerHTML = shuffledOptions.map((opt, i) => `
        <button class="quiz-option" data-index="${i}">
            <span class="quiz-option-marker">${String.fromCharCode(65 + i)}</span>
            <span class="quiz-option-text">${escapeHtml(opt.text)}</span>
        </button>
    `).join('');
    
    // Add option click listeners
    optionsContainer.querySelectorAll('.quiz-option').forEach(btn => {
        btn.addEventListener('click', () => selectQuizOption(parseInt(btn.dataset.index)));
    });
    
    // Reset result section and button state
    document.getElementById('quiz-result').classList.remove('visible', 'correct', 'incorrect');
    document.getElementById('quiz-submit-btn').disabled = true;
    document.getElementById('quiz-submit-btn').textContent = 'Check Answer';
    document.getElementById('quiz-submit-btn').onclick = submitQuizAnswer;
    document.getElementById('quiz-cancel-btn').textContent = 'Cancel';
    document.getElementById('quiz-cancel-btn').style.display = '';
    
    // Show streak info if required > 1
    const streakInfo = document.getElementById('quiz-streak-info');
    if (state.requiredCorrect > 1) {
        streakInfo.style.display = 'block';
        document.getElementById('quiz-streak-text').textContent = 
            `You need ${state.requiredCorrect} correct answer${state.requiredCorrect > 1 ? 's' : ''} to advance`;
        
        // Render progress dots
        const progressContainer = document.getElementById('quiz-streak-progress');
        let dotsHtml = '';
        for (let i = 0; i < state.requiredCorrect; i++) {
            const filled = i < state.correctStreak;
            dotsHtml += `<span class="quiz-streak-dot ${filled ? 'filled' : ''}"></span>`;
        }
        progressContainer.innerHTML = dotsHtml;
    } else {
        streakInfo.style.display = 'none';
    }
    
    // Show overlay
    document.getElementById('quiz-overlay').classList.add('active');
    
    return true;
}

function selectQuizOption(index) {
    if (currentQuiz.answered) return;
    
    currentQuiz.selectedIndex = index;
    
    // Update visual selection
    document.querySelectorAll('.quiz-option').forEach((btn, i) => {
        btn.classList.toggle('selected', i === index);
    });
    
    document.getElementById('quiz-submit-btn').disabled = false;
}

function submitQuizAnswer() {
    if (currentQuiz.selectedIndex === null || currentQuiz.answered) return;
    
    currentQuiz.answered = true;
    const selectedOption = currentQuiz.options[currentQuiz.selectedIndex];
    const isCorrect = selectedOption.isCorrect;
    const state = getQuizState(currentQuiz.itemId, currentQuiz.toLevel);
    
    // Mark question as used
    if (!state.usedQuestions.includes(currentQuiz.questionIndex)) {
        state.usedQuestions.push(currentQuiz.questionIndex);
    }
    
    // Update options visual state
    document.querySelectorAll('.quiz-option').forEach((btn, i) => {
        btn.disabled = true;
        if (currentQuiz.options[i].isCorrect) {
            btn.classList.add('correct');
        } else if (i === currentQuiz.selectedIndex) {
            btn.classList.add('incorrect');
        }
    });
    
    // Show result
    const resultEl = document.getElementById('quiz-result');
    resultEl.classList.remove('correct', 'incorrect');
    resultEl.classList.add('visible', isCorrect ? 'correct' : 'incorrect');
    
    document.getElementById('quiz-result-icon').textContent = isCorrect ? 'âœ“' : 'âœ—';
    document.getElementById('quiz-result-text').textContent = isCorrect ? 'Correct' : 'Incorrect';
    document.getElementById('quiz-result-explanation').textContent = selectedOption.explanation;
    
    if (isCorrect) {
        state.correctStreak++;
        state.wrongCount = 0; // Reset wrong count on correct answer
        
        // Update streak dots
        const dots = document.querySelectorAll('.quiz-streak-dot');
        dots.forEach((dot, i) => {
            if (i < state.correctStreak) {
                dot.classList.add('filled');
            }
        });
        
        // Check if they've earned the level
        if (state.correctStreak >= state.requiredCorrect) {
            // Success! Apply the level change
            document.getElementById('quiz-submit-btn').textContent = 'Continue';
            document.getElementById('quiz-submit-btn').disabled = false;
            // Capture values before closeQuiz nullifies currentQuiz
            const successItemId = currentQuiz.itemId;
            const successToLevel = currentQuiz.toLevel;
            document.getElementById('quiz-submit-btn').onclick = () => {
                closeQuiz();
                applyLevelChange(successItemId, successToLevel);
                // Reset state for this transition
                state.usedQuestions = [];
                state.wrongCount = 0;
                state.correctStreak = 0;
                state.requiredCorrect = 1;
                saveQuizState();
            };
            document.getElementById('quiz-cancel-btn').style.display = 'none';
        } else {
            // Need more correct answers
            document.getElementById('quiz-submit-btn').textContent = 'Next Question';
            document.getElementById('quiz-submit-btn').disabled = false;
            // Capture values before closeQuiz nullifies currentQuiz
            const nextItemId = currentQuiz.itemId;
            const nextFromLevel = currentQuiz.fromLevel;
            const nextToLevel = currentQuiz.toLevel;
            document.getElementById('quiz-submit-btn').onclick = () => {
                saveQuizState();
                closeQuiz();
                // Show next question
                setTimeout(() => {
                    if (!showQuiz(nextItemId, nextFromLevel, nextToLevel)) {
                        showToast('No more questions available', 'error');
                    }
                }, 100);
            };
        }
    } else {
        state.wrongCount++;
        state.correctStreak = 0; // Reset streak on wrong answer
        
        if (state.wrongCount >= 3) {
            // Lockout
            state.lockedUntil = Date.now() + QUIZ_LOCKOUT_DURATION;
            state.usedQuestions = []; // Reshuffle
            state.requiredCorrect = 1; // Reset for after lockout
            
            document.getElementById('quiz-result-explanation').textContent = 
                selectedOption.explanation + '\n\nThis level is now locked for 5 minutes. Take some time to review this concept.';
            
            document.getElementById('quiz-submit-btn').textContent = 'Close';
            document.getElementById('quiz-submit-btn').disabled = false;
            document.getElementById('quiz-submit-btn').onclick = () => {
                saveQuizState();
                const uiState = captureUIState(); // Preserve expanded sections
                closeQuiz();
                renderLearningContent(); // Re-render to show locked state
                restoreUIState(uiState); // Keep sections open
            };
            document.getElementById('quiz-cancel-btn').style.display = 'none';
        } else {
            // Increase required correct answers
            state.requiredCorrect = state.wrongCount + 1;
            
            // Capture values before closeQuiz nullifies currentQuiz
            const retryItemId = currentQuiz.itemId;
            const retryFromLevel = currentQuiz.fromLevel;
            const retryToLevel = currentQuiz.toLevel;
            
            document.getElementById('quiz-submit-btn').textContent = 'Try Again';
            document.getElementById('quiz-submit-btn').disabled = false;
            document.getElementById('quiz-submit-btn').onclick = () => {
                saveQuizState();
                closeQuiz();
                // Show a new question
                setTimeout(() => {
                    if (!showQuiz(retryItemId, retryFromLevel, retryToLevel)) {
                        showToast('No more questions available', 'error');
                    }
                }, 100);
            };
        }
    }
    
    saveQuizState();
}

function closeQuiz() {
    document.getElementById('quiz-overlay').classList.remove('active');
    currentQuiz = null;
    
    // Reset button handlers
    document.getElementById('quiz-submit-btn').onclick = submitQuizAnswer;
    document.getElementById('quiz-cancel-btn').style.display = '';
}

function applyLevelChange(itemId, level) {
    // This applies the level change without triggering a quiz
    if (!appState.learningItems[itemId]) {
        appState.learningItems[itemId] = { level: 1, history: [], notes: [] };
    }
    
    const oldLevel = appState.learningItems[itemId].level;
    
    if (oldLevel !== level) {
        const uiState = captureUIState();
        pushUndoState();
        
        appState.learningItems[itemId].level = level;
        appState.learningItems[itemId].history.push({
            date: new Date().toISOString(),
            level: level,
            previousLevel: oldLevel
        });
        
        // Update visuals
        const notchContainer = document.querySelector(`.level-notches[data-item-id="${itemId}"]`);
        if (notchContainer) {
            notchContainer.querySelectorAll('.level-notch').forEach(notch => {
                const notchLevel = parseInt(notch.dataset.level);
                notch.classList.toggle('filled', notchLevel <= level);
                notch.classList.toggle('active', notchLevel === level);
                notch.setAttribute('aria-checked', notchLevel === level);
                notch.setAttribute('tabindex', notchLevel === level ? '0' : '-1');
            });
        }
        
        const itemEl = document.querySelector(`.learning-item-simple[data-item-id="${itemId}"]`);
        if (itemEl) {
            itemEl.dataset.level = level;
        }
        
        saveData();
        renderOverview();
        renderHistory();
        restoreUIState(uiState);
        
        showToast(`Level up: ${levelEmojis[level - 1]} ${levelNames[level - 1]}`, 'success');
    }
}

function handleLevelChange(itemId, newLevel) {
    const currentLevel = appState.learningItems[itemId]?.level || 1;
    
    // Check if moving up
    if (newLevel > currentLevel) {
        // Check if locked
        if (isLevelLocked(itemId, newLevel)) {
            const remaining = getLockoutRemainingTime(itemId, newLevel);
            const mins = Math.floor(remaining / 60);
            const secs = remaining % 60;
            showToast(`This level is locked. Try again in ${mins}:${secs.toString().padStart(2, '0')}`, 'error');
            return;
        }
        
        // Check if questions exist for this transition
        const questions = getQuestionsForLevel(itemId, newLevel);
        if (questions.length > 0) {
            // Show quiz
            showQuiz(itemId, currentLevel, newLevel);
        } else {
            // No questions, allow immediate change
            applyLevelChange(itemId, newLevel);
        }
    } else {
        // Moving down or same - allow immediately
        if (newLevel !== currentLevel) {
            applyLevelChange(itemId, newLevel);
        }
    }
}

// ============================================
// UNDO/REDO
// ============================================
function pushUndoState() {
    undoStack.push(JSON.stringify(appState));
    if (undoStack.length > MAX_UNDO) undoStack.shift();
    redoStack = [];
    updateUndoRedoButtons();
}

function undo() {
    if (undoStack.length === 0) return;
    redoStack.push(JSON.stringify(appState));
    appState = JSON.parse(undoStack.pop());
    saveData();
    renderAll();
    showToast('Undone', 'info');
    updateUndoRedoButtons();
}

function redo() {
    if (redoStack.length === 0) return;
    undoStack.push(JSON.stringify(appState));
    appState = JSON.parse(redoStack.pop());
    saveData();
    renderAll();
    showToast('Redone', 'info');
    updateUndoRedoButtons();
}

function updateUndoRedoButtons() {
    document.getElementById('undo-btn').disabled = undoStack.length === 0;
    document.getElementById('redo-btn').disabled = redoStack.length === 0;
}

// ============================================
// UI STATE PRESERVATION
// ============================================
function captureUIState() {
    const state = {
        expandedTopics: [],
        expandedExplanations: [],
        expandedHelp: []
    };
    
    document.querySelectorAll('.topic-header[aria-expanded="true"]').forEach(h => {
        state.expandedTopics.push(h.id);
    });
    
    document.querySelectorAll('.explanation-toggle[aria-expanded="true"]').forEach(t => {
        state.expandedExplanations.push(t.id);
    });
    
    document.querySelectorAll('.help-toggle[aria-expanded="true"]').forEach(t => {
        state.expandedHelp.push(t.id);
    });
    
    return state;
}

function restoreUIState(state) {
    if (!state) return;
    
    state.expandedTopics.forEach(id => {
        const header = document.getElementById(id);
        if (header) {
            header.setAttribute('aria-expanded', 'true');
            const content = document.getElementById(header.getAttribute('aria-controls'));
            if (content) content.classList.add('expanded');
        }
    });
    
    state.expandedExplanations.forEach(id => {
        const toggle = document.getElementById(id);
        if (toggle) {
            toggle.setAttribute('aria-expanded', 'true');
            const contentId = toggle.getAttribute('aria-controls');
            const content = contentId ? document.getElementById(contentId) : toggle.nextElementSibling;
            if (content) content.classList.add('expanded');
        }
    });
    
    if (state.expandedHelp) {
        state.expandedHelp.forEach(id => {
            const toggle = document.getElementById(id);
            if (toggle) {
                toggle.setAttribute('aria-expanded', 'true');
                const contentId = toggle.getAttribute('aria-controls');
                const content = contentId ? document.getElementById(contentId) : toggle.nextElementSibling;
                if (content) content.classList.add('expanded');
            }
        });
    }
}

// ============================================
// THEME
// ============================================
function applyTheme(theme) {
    appState.theme = theme;
    document.documentElement.setAttribute('data-theme', theme);
    const toggle = document.getElementById('dark-mode-toggle');
    if (toggle) {
        toggle.checked = (theme === 'dark');
    }
}

function toggleTheme() {
    const toggle = document.getElementById('dark-mode-toggle');
    applyTheme(toggle && toggle.checked ? 'dark' : 'light');
    saveData();
}

// ============================================
// CALCULATIONS
// ============================================
function calculateStats() {
    const items = Object.values(appState.learningItems);
    const total = items.length || 1;
    
    const counts = { 1: 0, 2: 0, 3: 0, 4: 0, 5: 0 };
    let totalScore = 0;
    
    items.forEach(item => {
        counts[item.level]++;
        totalScore += item.level;
    });
    
    const avgLevel = totalScore / total;
    const overallPercentage = Math.round(((avgLevel - 1) / 4) * 100);
    
    return {
        total,
        counts,
        avgLevel,
        overallPercentage,
        mastered: counts[5],
        confident: counts[4],
        developing: counts[3],
        beginning: counts[2],
        notStarted: counts[1]
    };
}

function calculateSubtopicProgress(subtopic) {
    let totalScore = 0;
    let count = 0;
    
    subtopic.items.forEach(item => {
        const itemData = appState.learningItems[item.id];
        if (itemData) {
            totalScore += itemData.level;
            count++;
        }
    });
    
    if (count === 0) return 0;
    const avgLevel = totalScore / count;
    return Math.round(((avgLevel - 1) / 4) * 100);
}

function getFocusAreas() {
    const items = [];
    
    if (!appState.topic || !appState.topic.subtopics) return items;
    
    appState.topic.subtopics.forEach(subtopic => {
        subtopic.items.forEach(item => {
            const itemData = appState.learningItems[item.id];
            if (itemData && itemData.level <= 2) {
                items.push({
                    ...item,
                    subtopic: subtopic.name,
                    level: itemData.level
                });
            }
        });
    });
    
    return items.slice(0, 5);
}

// ============================================
// RENDERING
// ============================================
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text || '';
    return div.innerHTML;
}

function renderAll() {
    renderStudentInfo();
    renderOverview();
    renderLearningContent();
    renderHistory();
    renderGoals();
    renderQuestions();
    renderDataSummary();
    updateUndoRedoButtons();
    updateBadges();
}

function renderStudentInfo() {
    const nameDisplay = document.getElementById('student-name-display');
    if (nameDisplay) {
        nameDisplay.textContent = appState.student.name || 'Student';
    }
    
    const nameInput = document.getElementById('student-name-input');
    if (nameInput) nameInput.value = appState.student.name || '';
    
    const classInput = document.getElementById('class-input');
    if (classInput) classInput.value = appState.student.class || '';
}

function renderOverview() {
    // Topic info
    document.getElementById('topic-name-display').textContent = 
        appState.topic ? `${appState.topic.name} â€¢ ${appState.topic.yearLevel}` : 'No topic loaded';
    
    // Stats
    const stats = calculateStats();
    
    document.getElementById('overall-percentage').textContent = stats.overallPercentage + '%';
    document.getElementById('overall-progress-fill').style.width = stats.overallPercentage + '%';
    
    document.getElementById('progress-stats').innerHTML = `
        <div class="progress-stat">
            <div class="progress-stat-value" style="color: var(--level-5)">${stats.mastered}</div>
            <div class="progress-stat-label">Mastered</div>
        </div>
        <div class="progress-stat">
            <div class="progress-stat-value" style="color: var(--level-4)">${stats.confident}</div>
            <div class="progress-stat-label">Confident</div>
        </div>
        <div class="progress-stat">
            <div class="progress-stat-value" style="color: var(--level-3)">${stats.developing}</div>
            <div class="progress-stat-label">Developing</div>
        </div>
        <div class="progress-stat">
            <div class="progress-stat-value" style="color: var(--level-2)">${stats.beginning}</div>
            <div class="progress-stat-label">Beginning</div>
        </div>
        <div class="progress-stat">
            <div class="progress-stat-value" style="color: var(--level-1)">${stats.notStarted}</div>
            <div class="progress-stat-label">Not Started</div>
        </div>
    `;
    
    // Quick stats
    document.getElementById('total-checkins').textContent = appState.checkins.length;
    document.getElementById('items-mastered').textContent = stats.mastered;
    
    // Last check-in
    if (appState.checkins.length > 0) {
        const lastCheckin = appState.checkins[appState.checkins.length - 1];
        document.getElementById('last-checkin-date').textContent = 
            new Date(lastCheckin.date).toLocaleDateString();
    }
    
    // Focus areas
    const focusAreas = getFocusAreas();
    const focusContainer = document.getElementById('focus-areas');
    
    if (focusAreas.length === 0) {
        focusContainer.innerHTML = `
            <div class="empty-state" style="padding: var(--space-4);">
                <p class="empty-state-desc">
                    ${stats.total === stats.mastered ? 
                        'ðŸŽ‰ Amazing! You\'ve mastered all content!' : 
                        'Complete a check-in to identify your focus areas.'}
                </p>
            </div>
        `;
    } else {
        focusContainer.innerHTML = focusAreas.map(item => `
            <div class="goal-item focus-area-link" style="border-left-color: var(--level-${item.level}); cursor: pointer;" 
                 data-item-id="${item.id}" 
                 title="Click to go to this item">
                <div class="goal-text">${escapeHtml(item.title)}</div>
                <div class="goal-meta">${escapeHtml(item.subtopic)} â€¢ ${escapeHtml(item.code)} <span style="color: var(--color-primary);">â†’ Go</span></div>
            </div>
        `).join('');
        
        // Add click handlers to focus area items
        focusContainer.querySelectorAll('.focus-area-link').forEach(el => {
            el.addEventListener('click', () => {
                const itemId = parseInt(el.dataset.itemId);
                navigateToLearningItem(itemId);
            });
        });
    }
}

function renderLearningContent() {
    const container = document.getElementById('topics-container');
    const learningPanel = document.getElementById('learning-panel');
    
    // Add/remove check-in mode styling
    if (learningPanel) {
        learningPanel.classList.toggle('checkin-mode-active', checkinModeActive);
    }
    
    if (!appState.topic || !appState.topic.subtopics) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">ðŸ“š</div>
                <div class="empty-state-title">No topic loaded</div>
                <p class="empty-state-desc">Ask your teacher for the topic JSON or load an example from settings.</p>
            </div>
        `;
        return;
    }
    
    document.getElementById('topic-title').textContent = appState.topic.name;
    document.getElementById('curriculum-code').textContent = 
        `${appState.topic.subject} â€¢ ${appState.topic.yearLevel} â€¢ ${appState.topic.curriculumCode}`;
    
    // Check-in mode banner
    const checkinBanner = checkinModeActive ? `
        <div class="checkin-mode-banner">
            <div class="checkin-mode-info">
                <span class="checkin-mode-type">${checkinTypeLabels[currentCheckinType]} Check-in</span>
                <span class="checkin-mode-progress" id="checkin-progress-text">0/${Object.keys(checkinStartLevels).length} items reviewed</span>
            </div>
            <button class="checkin-stop-btn" onclick="stopCheckinMode(false)">â¹ Stop Check-in</button>
        </div>
    ` : '';
    
    container.innerHTML = checkinBanner + appState.topic.subtopics.map(subtopic => {
        const progress = calculateSubtopicProgress(subtopic);
        const headerId = `subtopic-${subtopic.id}-header`;
        const contentId = `subtopic-${subtopic.id}-content`;
        const subtopicExplanationId = `subtopic-explanation-${subtopic.id}`;
        const subtopicExplanationContentId = `subtopic-explanation-content-${subtopic.id}`;
        const hasSubtopicExplanation = subtopic.what || subtopic.why;
        
        return `
            <div class="topic-section">
                <div class="topic-header" id="${headerId}" aria-expanded="${checkinModeActive ? 'true' : 'false'}" aria-controls="${contentId}">
                    <div class="topic-header-left">
                        <div class="topic-icon">${subtopic.icon}</div>
                        <div class="topic-info">
                            <div class="topic-title">${escapeHtml(subtopic.name)}</div>
                            <div class="topic-meta">
                                <span>${subtopic.items.length} learning outcomes</span>
                            </div>
                        </div>
                    </div>
                    <div class="topic-progress">
                        <div class="topic-progress-bar">
                            <div class="topic-progress-fill" style="width: ${progress}%"></div>
                        </div>
                        <div class="topic-progress-text">${progress}%</div>
                    </div>
                    <span class="topic-toggle">â–¼</span>
                </div>
                <div class="topic-content ${checkinModeActive ? 'expanded' : ''}" id="${contentId}">
                    ${hasSubtopicExplanation ? `
                        <div class="subtopic-explanation-wrapper">
                            <button class="explanation-toggle subtopic-explanation-toggle" id="${subtopicExplanationId}" aria-expanded="false" aria-controls="${subtopicExplanationContentId}">
                                <span class="explanation-toggle-icon">â–¼</span>
                                <span>ðŸ“– What is this section about & Why does it matter?</span>
                            </button>
                            <div class="explanation-content subtopic-explanation-content" id="${subtopicExplanationContentId}">
                                ${subtopic.what ? `
                                    <div class="explanation-section">
                                        <div class="explanation-heading">
                                            <span class="explanation-heading-icon">ðŸ“–</span> What is this section?
                                        </div>
                                        <p class="explanation-text">${escapeHtml(subtopic.what)}</p>
                                    </div>
                                ` : ''}
                                ${subtopic.why ? `
                                    <div class="explanation-section">
                                        <div class="explanation-heading">
                                            <span class="explanation-heading-icon">ðŸ’¡</span> Why does it matter?
                                        </div>
                                        <p class="explanation-text">${escapeHtml(subtopic.why)}</p>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    ` : ''}
                    ${subtopic.items.map(item => renderLearningItem(item)).join('')}
                </div>
            </div>
        `;
    }).join('');
    
    setupLearningContentListeners();
}

function renderLearningItem(item) {
    const data = appState.learningItems[item.id] || { level: 1, history: [], notes: [] };
    const explanationId = `explanation-${item.id}`;
    const explanationContentId = `explanation-content-${item.id}`;
    
    const hasExplanation = item.what || item.why || item.example;
    const levelEmojis = ['ðŸŒ±', 'ðŸŒ¿', 'ðŸŒ³', 'ðŸŒ²', 'â­Â'];
    const levelNames = ['Not started', 'Beginning', 'Developing', 'Confident', 'Mastered'];
    
    // Get last change date if any
    const lastChange = data.history.length > 0 ? data.history[data.history.length - 1] : null;
    const lastChangeText = lastChange 
        ? `${new Date(lastChange.date).toLocaleDateString('en-AU', { day: 'numeric', month: 'short' })} ${new Date(lastChange.date).toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit' })}`
        : '';
    
    // Check-in mode: get "was" level
    const wasLevel = getWasLevel(item.id);
    const isReviewed = checkinReviewedItems.has(item.id);
    
    // Build notch selector HTML
    const notchesHtml = `
        <div class="level-notches" data-item-id="${item.id}" role="radiogroup" aria-label="Understanding level">
            ${[1, 2, 3, 4, 5].map(level => {
                const isFilled = level <= data.level;
                const isActive = level === data.level;
                const isLocked = level > data.level && isLevelLocked(item.id, level);
                return `<button class="level-notch ${isFilled ? 'filled' : ''} ${isActive ? 'active' : ''} ${isLocked ? 'locked' : ''}" 
                    data-level="${level}" 
                    data-label="${levelNames[level - 1]}"
                    role="radio"
                    aria-checked="${isActive}"
                    aria-label="${levelEmojis[level - 1]} ${levelNames[level - 1]}${isLocked ? ' (locked)' : ''}"
                    tabindex="${isActive ? '0' : '-1'}">${levelEmojis[level - 1]}</button>`;
            }).join('')}
        </div>
    `;
    
    // Build the controls section based on mode
    let controlsHtml;
    if (checkinModeActive) {
        controlsHtml = `
            <div class="level-controls-checkin">
                <div class="level-was">Was: <span class="level-was-value" data-level="${wasLevel}">${levelEmojis[wasLevel - 1]} ${levelNames[wasLevel - 1]}</span></div>
                ${notchesHtml}
            </div>
        `;
    } else {
        controlsHtml = notchesHtml;
    }
    
    return `
        <div class="learning-item-simple ${isReviewed ? 'reviewed' : ''}" data-level="${data.level}" data-item-id="${item.id}">
            <div class="learning-item-row">
                <div class="learning-item-left">
                    <span class="learning-item-title">${escapeHtml(item.title)}</span>
                    <span class="learning-item-code">${escapeHtml(item.code)}</span>
                    ${hasExplanation ? `<button class="help-toggle-inline" id="${explanationId}" aria-expanded="false" aria-controls="${explanationContentId}">What Why Example</button>` : ''}
                    ${lastChangeText ? `<span class="learning-item-updated">${lastChangeText}</span>` : ''}
                </div>
                <div class="learning-item-right">
                    ${controlsHtml}
                </div>
            </div>
            ${hasExplanation ? `
                <div class="help-content-inline" id="${explanationContentId}">
                    ${item.what ? `<span class="help-inline-item"><strong>ðŸ“– What:</strong> ${escapeHtml(item.what)}</span>` : ''}
                    ${item.why ? `<span class="help-inline-item"><strong>ðŸ’¡ Why:</strong> ${escapeHtml(item.why)}</span>` : ''}
                    ${item.example ? `<span class="help-inline-item"><strong>âœï¸ Example:</strong> ${escapeHtml(item.example)}</span>` : ''}
                </div>
            ` : ''}
        </div>
    `;
}

function setupLearningContentListeners() {
    // Topic headers (subtopic collapsing)
    document.querySelectorAll('.topic-header').forEach(header => {
        header.addEventListener('click', () => {
            const expanded = header.getAttribute('aria-expanded') === 'true';
            header.setAttribute('aria-expanded', !expanded);
            document.getElementById(header.getAttribute('aria-controls')).classList.toggle('expanded', !expanded);
        });
    });
    
    // Level notches - main interaction
    document.querySelectorAll('.level-notch').forEach(notch => {
        notch.addEventListener('click', (e) => {
            e.stopPropagation();
            const notchContainer = notch.closest('.level-notches');
            const itemId = parseInt(notchContainer.dataset.itemId);
            const level = parseInt(notch.dataset.level);
            
            // Check if this level is locked
            if (notch.classList.contains('locked')) {
                const remaining = getLockoutRemainingTime(itemId, level);
                const mins = Math.floor(remaining / 60);
                const secs = remaining % 60;
                showToast(`Locked for ${mins}:${secs.toString().padStart(2, '0')}`, 'error');
                return;
            }
            
            // Mark as reviewed in check-in mode
            if (checkinModeActive) {
                markItemReviewed(itemId);
            }
            
            // Update level (may trigger quiz for upward moves)
            handleLevelChange(itemId, level);
        });
        
        // Keyboard navigation within notch group
        notch.addEventListener('keydown', (e) => {
            const notchContainer = notch.closest('.level-notches');
            const notches = Array.from(notchContainer.querySelectorAll('.level-notch'));
            const currentIndex = notches.indexOf(notch);
            
            let newIndex = currentIndex;
            if (e.key === 'ArrowRight' || e.key === 'ArrowUp') {
                newIndex = Math.min(currentIndex + 1, notches.length - 1);
                e.preventDefault();
            } else if (e.key === 'ArrowLeft' || e.key === 'ArrowDown') {
                newIndex = Math.max(currentIndex - 1, 0);
                e.preventDefault();
            } else if (e.key === 'Home') {
                newIndex = 0;
                e.preventDefault();
            } else if (e.key === 'End') {
                newIndex = notches.length - 1;
                e.preventDefault();
            }
            
            if (newIndex !== currentIndex) {
                notches[newIndex].focus();
                notches[newIndex].click();
            }
        });
    });
    
    // Help toggles (What & Why for individual items) - both old and new inline style
    document.querySelectorAll('.help-toggle, .help-toggle-inline').forEach(toggle => {
        toggle.addEventListener('click', (e) => {
            e.stopPropagation();
            const expanded = toggle.getAttribute('aria-expanded') === 'true';
            toggle.setAttribute('aria-expanded', !expanded);
            const content = document.getElementById(toggle.getAttribute('aria-controls'));
            if (content) content.classList.toggle('expanded', !expanded);
        });
    });
    
    // Subtopic explanation toggles
    document.querySelectorAll('.explanation-toggle').forEach(toggle => {
        toggle.addEventListener('click', (e) => {
            e.stopPropagation();
            const expanded = toggle.getAttribute('aria-expanded') === 'true';
            toggle.setAttribute('aria-expanded', !expanded);
            const content = document.getElementById(toggle.getAttribute('aria-controls'));
            if (content) content.classList.toggle('expanded', !expanded);
        });
    });
}

// New function that sets level AND records history with timestamp
function setItemLevelWithHistory(itemId, level) {
    if (!appState.learningItems[itemId]) {
        appState.learningItems[itemId] = { level: 1, history: [], notes: [] };
    }
    
    const oldLevel = appState.learningItems[itemId].level;
    
    // Only record if level actually changed
    if (oldLevel !== level) {
        // Capture UI state before changes
        const uiState = captureUIState();
        
        pushUndoState();
        
        appState.learningItems[itemId].level = level;
        
        // Automatically add to history with timestamp
        appState.learningItems[itemId].history.push({
            date: new Date().toISOString(),
            level: level,
            previousLevel: oldLevel
        });
        
        // Update the notches visually in place for instant feedback
        const notchContainer = document.querySelector(`.level-notches[data-item-id="${itemId}"]`);
        if (notchContainer) {
            notchContainer.querySelectorAll('.level-notch').forEach(notch => {
                const notchLevel = parseInt(notch.dataset.level);
                notch.classList.toggle('filled', notchLevel <= level);
                notch.classList.toggle('active', notchLevel === level);
                notch.setAttribute('aria-checked', notchLevel === level);
                notch.setAttribute('tabindex', notchLevel === level ? '0' : '-1');
            });
        }
        
        // Update the item's left border color
        const itemEl = document.querySelector(`.learning-item-simple[data-item-id="${itemId}"]`);
        if (itemEl) {
            itemEl.dataset.level = level;
        }
        
        saveData();
        
        // Only do lightweight updates - overview and history
        renderOverview();
        renderHistory();
        
        // Restore UI state
        restoreUIState(uiState);
    }
}

function toggleLearningItem(header) {
    const expanded = header.getAttribute('aria-expanded') === 'true';
    header.setAttribute('aria-expanded', !expanded);
    document.getElementById(header.getAttribute('aria-controls')).classList.toggle('expanded', !expanded);
}

function addItemNote(itemId, text) {
    pushUndoState();
    
    if (!appState.learningItems[itemId]) {
        appState.learningItems[itemId] = { level: 1, history: [], notes: [] };
    }
    
    appState.learningItems[itemId].notes.unshift({
        text,
        timestamp: new Date().toISOString()
    });
    
    saveData();
    renderLearningContent();
    showToast('Note added', 'success');
}

function renderHistory() {
    const container = document.getElementById('checkin-timeline');
    
    if (!appState.topic || !appState.topic.subtopics) {
        container.innerHTML = `
            <div class="empty-state">
                <div class="empty-state-icon">ðŸ“Š</div>
                <div class="empty-state-title">No topic loaded</div>
                <p class="empty-state-desc">Load a topic to see progress.</p>
            </div>
        `;
        return;
    }
    
    const levelEmojis = ['ðŸŒ±', 'ðŸŒ¿', 'ðŸŒ³', 'ðŸŒ²', 'â­Â'];
    const levelNames = ['Not started', 'Beginning', 'Developing', 'Confident', 'Mastered'];
    
    // Calculate overall stats
    let totalItems = 0;
    let totalPoints = 0;
    let maxPoints = 0;
    let levelCounts = [0, 0, 0, 0, 0];
    let totalImproved = 0;
    let totalDropped = 0;
    
    // Get previous check-in for comparison
    const lastCheckin = appState.checkins.length > 0 ? appState.checkins[appState.checkins.length - 1] : null;
    
    // Calculate per-subtopic stats
    const subtopicStats = appState.topic.subtopics.map(subtopic => {
        const stats = {
            name: subtopic.name,
            icon: subtopic.icon,
            items: subtopic.items.length,
            levelCounts: [0, 0, 0, 0, 0],
            totalPoints: 0,
            maxPoints: subtopic.items.length * 5,
            improved: 0,
            dropped: 0,
            same: 0
        };
        
        subtopic.items.forEach(item => {
            const itemData = appState.learningItems[item.id] || { level: 1, history: [] };
            const level = itemData.level;
            
            stats.levelCounts[level - 1]++;
            stats.totalPoints += level;
            levelCounts[level - 1]++;
            totalPoints += level;
            totalItems++;
            maxPoints += 5;
            
            // Calculate change since last check-in
            if (lastCheckin && itemData.history.length > 0) {
                const historyBeforeCheckin = itemData.history.filter(h => new Date(h.date) <= new Date(lastCheckin.date));
                const levelAtLastCheckin = historyBeforeCheckin.length > 0 
                    ? historyBeforeCheckin[historyBeforeCheckin.length - 1].level 
                    : 1;
                
                if (level > levelAtLastCheckin) {
                    stats.improved++;
                    totalImproved++;
                } else if (level < levelAtLastCheckin) {
                    stats.dropped++;
                    totalDropped++;
                } else {
                    stats.same++;
                }
            }
        });
        
        stats.percentage = Math.round((stats.totalPoints / stats.maxPoints) * 100);
        return stats;
    });
    
    const overallPercentage = maxPoints > 0 ? Math.round((totalPoints / maxPoints) * 100) : 0;
    
    // Build overall progress section
    const overallHtml = `
        <div class="overall-progress">
            <div class="overall-progress-header">
                <div class="overall-progress-title">ðŸ“ˆ Overall Progress</div>
                <div class="overall-progress-percent">${overallPercentage}%</div>
            </div>
            <div class="overall-progress-bar">
                <div class="overall-progress-fill" style="width: ${overallPercentage}%;"></div>
            </div>
            <div class="overall-progress-stats">
                <div class="overall-stat">
                    <span>â­Â</span>
                    <span class="overall-stat-value">${levelCounts[4]}</span>
                    <span>mastered</span>
                </div>
                <div class="overall-stat">
                    <span>ðŸŒ²</span>
                    <span class="overall-stat-value">${levelCounts[3]}</span>
                    <span>confident</span>
                </div>
                <div class="overall-stat">
                    <span>ðŸ“š</span>
                    <span class="overall-stat-value">${totalItems}</span>
                    <span>total items</span>
                </div>
                ${lastCheckin ? `
                    <div class="overall-stat">
                        ${totalImproved > 0 ? `<span class="change-badge positive">â†‘${totalImproved}</span>` : ''}
                        ${totalDropped > 0 ? `<span class="change-badge negative">â†“${totalDropped}</span>` : ''}
                        ${totalImproved === 0 && totalDropped === 0 ? `<span class="change-badge neutral">No change</span>` : ''}
                        <span>since last check-in</span>
                    </div>
                ` : ''}
            </div>
        </div>
    `;
    
    // Build legend
    const legendHtml = `
        <div class="level-distribution-legend" style="margin-bottom: var(--space-3);">
            <div class="level-legend-item"><div class="level-legend-dot" data-level="1"></div> Not started</div>
            <div class="level-legend-item"><div class="level-legend-dot" data-level="2"></div> Beginning</div>
            <div class="level-legend-item"><div class="level-legend-dot" data-level="3"></div> Developing</div>
            <div class="level-legend-item"><div class="level-legend-dot" data-level="4"></div> Confident</div>
            <div class="level-legend-item"><div class="level-legend-dot" data-level="5"></div> Mastered</div>
        </div>
    `;
    
    // Build subtopic progress cards
    const subtopicsHtml = `
        <div class="progress-section">
            <div class="progress-section-title">ðŸ“Š Progress by Section</div>
            ${subtopicStats.map(stats => {
                // Calculate widths for level distribution
                const widths = stats.levelCounts.map(count => 
                    stats.items > 0 ? (count / stats.items) * 100 : 0
                );
                
                // Build change badge
                let changeBadge = '';
                if (lastCheckin) {
                    if (stats.improved > 0) {
                        changeBadge = `<span class="change-badge positive">â†‘${stats.improved}</span>`;
                    } else if (stats.dropped > 0) {
                        changeBadge = `<span class="change-badge negative">â†“${stats.dropped}</span>`;
                    }
                }
                
                return `
                    <div class="subtopic-progress">
                        <div class="subtopic-progress-header">
                            <div class="subtopic-progress-name">
                                <span>${stats.icon}</span>
                                <span>${stats.name}</span>
                            </div>
                            <div class="subtopic-progress-change">
                                <span style="font-weight: 600; color: var(--color-primary);">${stats.percentage}%</span>
                                ${changeBadge}
                            </div>
                        </div>
                        <div class="level-distribution">
                            ${[1, 2, 3, 4, 5].map(level => {
                                const count = stats.levelCounts[level - 1];
                                const width = widths[level - 1];
                                if (width === 0) return '';
                                return `<div class="level-segment" data-level="${level}" style="width: ${width}%;">
                                    <div class="level-segment-tooltip">${levelEmojis[level - 1]} ${levelNames[level - 1]}: ${count} item${count !== 1 ? 's' : ''}</div>
                                </div>`;
                            }).join('')}
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
    `;
    
    // Build timeline of formal check-ins
    const typeLabels = {
        pretopic: 'ðŸš€ Pre-Topic',
        weekly: 'ðŸ“… Weekly',
        revision: 'ðŸ“š Final Revision',
        posttest: 'âœ… Post-Test'
    };
    
    const timelineHtml = appState.checkins.length > 0 ? `
        <div class="progress-section">
            <div class="progress-section-title">ðŸ“‹ Check-in History</div>
            ${appState.checkins.slice().reverse().map((checkin, index) => {
                const improvementText = checkin.improved !== undefined 
                    ? `<span class="change-badge positive">â†‘${checkin.improved}</span> <span class="change-badge negative">â†“${checkin.dropped}</span>`
                    : '';
                
                return `
                    <div class="timeline-item">
                        <div class="timeline-dot ${index === 0 ? 'current' : ''}"></div>
                        <div class="timeline-content">
                            <div class="timeline-date">
                                ${new Date(checkin.date).toLocaleDateString('en-AU', { 
                                    weekday: 'short', 
                                    day: 'numeric', 
                                    month: 'short',
                                    hour: '2-digit',
                                    minute: '2-digit'
                                })}
                                <span class="timeline-type ${checkin.type}">${typeLabels[checkin.type] || checkin.type}</span>
                            </div>
                            <div class="timeline-stats">
                                <span style="font-weight: 600;">${checkin.stats.overallPercentage}%</span>
                                <span>â­Â ${checkin.stats.mastered}</span>
                                ${improvementText}
                            </div>
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
    ` : '';
    
    container.innerHTML = overallHtml + legendHtml + subtopicsHtml + timelineHtml;
}

function renderGoals() {
    const container = document.getElementById('goals-list');
    
    if (appState.goals.length === 0) {
        container.innerHTML = `
            <div class="empty-state" style="padding: var(--space-4);">
                <p class="empty-state-desc">Set goals to help focus your learning!</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = appState.goals.map((goal, index) => `
        <div class="goal-item" style="${goal.completed ? 'opacity: 0.6;' : ''}">
            <div class="goal-header">
                <div class="goal-text" style="${goal.completed ? 'text-decoration: line-through;' : ''}">${escapeHtml(goal.text)}</div>
                <input type="checkbox" class="goal-checkbox" data-goal-index="${index}" ${goal.completed ? 'checked' : ''}>
            </div>
            <div class="goal-meta">${new Date(goal.created).toLocaleDateString()}</div>
        </div>
    `).join('');
    
    // Add checkbox listeners
    container.querySelectorAll('.goal-checkbox').forEach(checkbox => {
        checkbox.addEventListener('change', () => {
            const index = parseInt(checkbox.dataset.goalIndex);
            toggleGoal(index);
        });
    });
}

function renderQuestions() {
    const container = document.getElementById('questions-list');
    
    if (appState.questions.length === 0) {
        container.innerHTML = `
            <div class="empty-state" style="padding: var(--space-4);">
                <p class="empty-state-desc">No questions yet. If you're stuck, ask here!</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = appState.questions.map(q => `
        <div class="note-item">
            <div class="note-header">
                <span class="note-timestamp">${new Date(q.created).toLocaleDateString()}</span>
                <span class="note-type question">Question</span>
            </div>
            <div class="note-text">${escapeHtml(q.text)}</div>
        </div>
    `).join('');
}

function renderDataSummary() {
    const stats = calculateStats();
    document.getElementById('data-summary').innerHTML = `
        <div class="stat-row">
            <span class="stat-label">Student</span>
            <span class="stat-value">${appState.student.name || 'Not set'}</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Topic</span>
            <span class="stat-value">${appState.topic?.name || 'None'}</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Learning Items</span>
            <span class="stat-value">${stats.total}</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Check-ins</span>
            <span class="stat-value">${appState.checkins.length}</span>
        </div>
        <div class="stat-row">
            <span class="stat-label">Goals</span>
            <span class="stat-value">${appState.goals.length}</span>
        </div>
    `;
}

function updateBadges() {
    const stats = calculateStats();
    document.getElementById('learning-badge').textContent = stats.total;
}

// ============================================
// ACTIONS
// ============================================
function addGoal() {
    const input = document.getElementById('new-goal-input');
    const text = input.value.trim();
    if (!text) return;
    
    pushUndoState();
    appState.goals.unshift({
        text,
        completed: false,
        created: new Date().toISOString()
    });
    input.value = '';
    saveData();
    renderGoals();
    showToast('Goal added!', 'success');
}

function toggleGoal(index) {
    pushUndoState();
    appState.goals[index].completed = !appState.goals[index].completed;
    saveData();
    renderGoals();
    
    if (appState.goals[index].completed) {
        showToast('ðŸŽ‰ Goal achieved!', 'success');
    }
}

function addQuestion() {
    const input = document.getElementById('new-question-input');
    const text = input.value.trim();
    if (!text) return;
    
    pushUndoState();
    appState.questions.unshift({
        text,
        created: new Date().toISOString()
    });
    input.value = '';
    saveData();
    renderQuestions();
    showToast('Question added', 'success');
}

// ============================================
// CHECK-IN SYSTEM
// ============================================
let currentCheckinType = 'weekly';
let checkinModeActive = false;
let checkinStartLevels = {}; // Stores levels at start of check-in
let checkinReviewedItems = new Set(); // Tracks which items have been interacted with
let checkinTimerId = null; // Timer for auto-cancel
let checkinStartTime = null; // When check-in started
let checkinTimerUpdateId = null; // Interval for updating timer display

const CHECKIN_TIMEOUT_MS = 10 * 60 * 1000; // 10 minutes

const checkinTypeLabels = {
    pretopic: 'ðŸš€ Pre-Topic',
    weekly: 'ðŸ“… Weekly',
    revision: 'ðŸ“š Final Revision',
    posttest: 'âœ… Post-Test'
};

function openCheckinOverlay() {
    document.getElementById('checkin-overlay').classList.add('active');
}

function closeCheckinOverlay() {
    document.getElementById('checkin-overlay').classList.remove('active');
    document.getElementById('checkin-notes').value = '';
}

function setCheckinType(type) {
    currentCheckinType = type;
    document.querySelectorAll('.checkin-type-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.type === type);
    });
}

function startCheckinMode() {
    // Capture current levels as the "was" baseline
    checkinStartLevels = {};
    checkinReviewedItems = new Set();
    
    // Get the "was" level - either from last history entry or current level
    if (appState.topic && appState.topic.subtopics) {
        appState.topic.subtopics.forEach(subtopic => {
            subtopic.items.forEach(item => {
                const itemData = appState.learningItems[item.id];
                if (itemData) {
                    // Use the level from last check-in/change, or current if no history
                    const lastHistoryEntry = itemData.history && itemData.history.length > 0 
                        ? itemData.history[itemData.history.length - 1] 
                        : null;
                    checkinStartLevels[item.id] = lastHistoryEntry ? lastHistoryEntry.level : itemData.level;
                } else {
                    checkinStartLevels[item.id] = 1;
                }
            });
        });
    }
    
    checkinModeActive = true;
    checkinStartTime = Date.now();
    closeCheckinOverlay();
    
    // Switch to Learning Content tab
    switchTab('learning');
    
    // Create floating status bar
    createCheckinFloatingBar();
    
    // Start 10-minute timeout
    checkinTimerId = setTimeout(() => {
        if (checkinModeActive) {
            stopCheckinMode(false, true); // auto-timeout
        }
    }, CHECKIN_TIMEOUT_MS);
    
    // Start timer display update
    checkinTimerUpdateId = setInterval(updateCheckinTimerDisplay, 1000);
    
    // Re-render to show check-in mode UI
    renderLearningContent();
    
    showToast(`${checkinTypeLabels[currentCheckinType]} check-in started - 10 minutes`, 'info');
}

function createCheckinFloatingBar() {
    // Remove existing if any
    const existing = document.getElementById('checkin-floating-bar');
    if (existing) existing.remove();
    
    const totalItems = Object.keys(checkinStartLevels).length;
    
    const bar = document.createElement('div');
    bar.id = 'checkin-floating-bar';
    bar.className = 'checkin-floating-bar';
    bar.innerHTML = `
        <span class="checkin-floating-icon">âœï¸</span>
        <div>
            <div class="checkin-floating-text">${checkinTypeLabels[currentCheckinType]} Check-in</div>
            <div class="checkin-floating-progress" id="floating-progress">0/${totalItems} reviewed</div>
        </div>
        <div class="checkin-floating-timer" id="floating-timer">10:00</div>
        <button class="checkin-floating-stop" onclick="stopCheckinMode(false)">âœ“ Finish</button>
    `;
    
    document.body.appendChild(bar);
}

function removeCheckinFloatingBar() {
    const bar = document.getElementById('checkin-floating-bar');
    if (bar) bar.remove();
}

function updateCheckinTimerDisplay() {
    if (!checkinModeActive || !checkinStartTime) return;
    
    const elapsed = Date.now() - checkinStartTime;
    const remaining = Math.max(0, CHECKIN_TIMEOUT_MS - elapsed);
    const minutes = Math.floor(remaining / 60000);
    const seconds = Math.floor((remaining % 60000) / 1000);
    
    const timerEl = document.getElementById('floating-timer');
    if (timerEl) {
        timerEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        // Change color when low on time
        if (remaining < 60000) {
            timerEl.style.background = 'rgba(239, 68, 68, 0.3)';
        } else if (remaining < 180000) {
            timerEl.style.background = 'rgba(245, 158, 11, 0.3)';
        }
    }
}

function stopCheckinMode(completed = false, timedOut = false) {
    if (!checkinModeActive) return;
    
    // Clear timers
    if (checkinTimerId) {
        clearTimeout(checkinTimerId);
        checkinTimerId = null;
    }
    if (checkinTimerUpdateId) {
        clearInterval(checkinTimerUpdateId);
        checkinTimerUpdateId = null;
    }
    
    pushUndoState();
    
    const stats = calculateStats();
    const reviewedCount = checkinReviewedItems.size;
    const totalItems = Object.keys(checkinStartLevels).length;
    
    // Count changes
    let improved = 0;
    let same = 0;
    let dropped = 0;
    
    Object.keys(checkinStartLevels).forEach(itemId => {
        const wasLevel = checkinStartLevels[itemId];
        const nowLevel = appState.learningItems[itemId]?.level || 1;
        if (nowLevel > wasLevel) improved++;
        else if (nowLevel < wasLevel) dropped++;
        else same++;
    });
    
    // Save the check-in record
    appState.checkins.push({
        date: new Date().toISOString(),
        type: currentCheckinType,
        stats: {
            overallPercentage: stats.overallPercentage,
            mastered: stats.mastered,
            confident: stats.confident,
            developing: stats.developing,
            beginning: stats.beginning,
            notStarted: stats.notStarted
        },
        reviewedCount,
        totalItems,
        improved,
        dropped,
        same,
        timedOut,
        notes: ''
    });
    
    // Reset check-in mode
    checkinModeActive = false;
    checkinStartLevels = {};
    checkinReviewedItems = new Set();
    checkinStartTime = null;
    
    // Remove floating bar
    removeCheckinFloatingBar();
    
    saveData();
    renderAll();
    
    // Show summary toast
    const summaryParts = [];
    if (improved > 0) summaryParts.push(`â†‘${improved} improved`);
    if (dropped > 0) summaryParts.push(`â†“${dropped} dropped`);
    summaryParts.push(`${reviewedCount}/${totalItems} reviewed`);
    
    if (timedOut) {
        showToast(`â±ï¸ Check-in timed out. ${summaryParts.join(', ')}`, 'info');
    } else {
        showToast(`âœ… Check-in complete! ${summaryParts.join(', ')}`, 'success');
    }
}

function markItemReviewed(itemId) {
    if (!checkinModeActive) return;
    
    checkinReviewedItems.add(itemId);
    
    // Update the reviewed indicator
    const itemEl = document.querySelector(`.learning-item-simple[data-item-id="${itemId}"]`);
    if (itemEl) {
        itemEl.classList.add('reviewed');
    }
    
    // Update progress in floating bar
    updateCheckinProgress();
    
    // Check if all items reviewed
    const totalItems = Object.keys(checkinStartLevels).length;
    if (checkinReviewedItems.size >= totalItems) {
        // Auto-complete after a short delay
        setTimeout(() => {
            if (checkinModeActive && checkinReviewedItems.size >= totalItems) {
                stopCheckinMode(true);
            }
        }, 500);
    }
}

function updateCheckinProgress() {
    const reviewed = checkinReviewedItems.size;
    const total = Object.keys(checkinStartLevels).length;
    
    // Update banner
    const progressEl = document.getElementById('checkin-progress-text');
    if (progressEl) {
        progressEl.textContent = `${reviewed}/${total} items reviewed`;
    }
    
    // Update floating bar
    const floatingProgress = document.getElementById('floating-progress');
    if (floatingProgress) {
        floatingProgress.textContent = `${reviewed}/${total} reviewed`;
    }
}

function getWasLevel(itemId) {
    if (!checkinModeActive) return null;
    return checkinStartLevels[itemId] || 1;
}

// Legacy function for compatibility
function saveCheckin() {
    stopCheckinMode(true);
}

// ============================================
// EXPORT/IMPORT
// ============================================
function exportData() {
    const dataStr = JSON.stringify(appState, null, 2);
    const blob = new Blob([dataStr], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    const name = appState.student.name ? appState.student.name.replace(/\s+/g, '-').toLowerCase() : 'student';
    const date = new Date().toISOString().split('T')[0];
    link.download = `dynamic-learning-checkin-${name}-${date}.json`;
    link.click();
    URL.revokeObjectURL(url);
    showToast('Data exported', 'success');
}

function importData(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const imported = JSON.parse(e.target.result);
            if (confirm('This will replace all current data. Continue?')) {
                pushUndoState();
                appState = { ...appState, ...imported };
                saveData();
                renderAll();
                showToast('Data imported', 'success');
            }
        } catch (error) {
            showToast('Invalid file format', 'error');
        }
    };
    reader.readAsText(file);
    event.target.value = '';
}

function printReport() {
    const stats = calculateStats();
    const now = new Date();
    const levelNames = ['Not started', 'Beginning', 'Developing', 'Confident', 'Mastered'];
    const levelEmojis = ['ðŸŒ±', 'ðŸŒ¿', 'ðŸŒ³', 'ðŸŒ²', 'â­Â'];
    
    // Count pending questions
    const pendingQuestions = appState.questions.filter(q => q.status === 'pending');
    const answeredQuestions = appState.questions.filter(q => q.status === 'answered');
    
    let reportHtml = `
<!DOCTYPE html>
<html>
<head>
    <title>Learning Progress Report - ${appState.student.name || 'Student'}</title>
    <style>
        * { box-sizing: border-box; }
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            max-width: 850px; 
            margin: 0 auto; 
            padding: 30px; 
            color: #2c3e50; 
            line-height: 1.6;
        }
        h1 { 
            color: #2d9d78; 
            border-bottom: 3px solid #2d9d78; 
            padding-bottom: 15px; 
            margin-bottom: 25px;
            font-size: 28px;
        }
        h2 { 
            color: #1e7d5e; 
            margin-top: 35px;
            margin-bottom: 15px;
            font-size: 20px;
            border-left: 4px solid #2d9d78;
            padding-left: 12px;
        }
        h3 {
            color: #34495e;
            font-size: 16px;
            margin-top: 25px;
            margin-bottom: 10px;
        }
        .header-box { 
            background: linear-gradient(135deg, #f0f9f6 0%, #e8f5f0 100%); 
            padding: 20px 25px; 
            border-radius: 12px; 
            margin-bottom: 25px;
            border: 1px solid #c8e6d9;
        }
        .header-box p { margin: 5px 0; }
        .header-box strong { color: #1e7d5e; }
        
        .alert-box {
            background: #fff3cd;
            border: 1px solid #ffc107;
            border-left: 4px solid #ffc107;
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 25px;
        }
        .alert-box.questions {
            background: #ffe8e8;
            border-color: #dc3545;
            border-left-color: #dc3545;
        }
        .alert-box h3 { margin-top: 0; color: #856404; }
        .alert-box.questions h3 { color: #721c24; }
        
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(5, 1fr); 
            gap: 12px; 
            margin: 20px 0; 
        }
        .stat-box { 
            background: #f8f9fa; 
            padding: 18px 12px; 
            border-radius: 10px; 
            text-align: center;
            border: 1px solid #e9ecef;
        }
        .stat-number { font-size: 28px; font-weight: bold; color: #2d9d78; }
        .stat-label { font-size: 11px; color: #6c757d; text-transform: uppercase; letter-spacing: 0.5px; }
        
        .question-item {
            background: #fff;
            border: 1px solid #dee2e6;
            border-left: 4px solid #dc3545;
            padding: 15px;
            margin-bottom: 12px;
            border-radius: 8px;
        }
        .question-item.answered {
            border-left-color: #28a745;
            background: #f8fff8;
        }
        .question-text { font-weight: 500; margin-bottom: 8px; }
        .question-context { font-size: 12px; color: #6c757d; font-style: italic; }
        .question-answer { 
            margin-top: 10px; 
            padding-top: 10px; 
            border-top: 1px dashed #dee2e6;
            color: #28a745;
        }
        
        .goal-item {
            padding: 10px 15px;
            background: #f8f9fa;
            border-radius: 6px;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .goal-item.completed { text-decoration: line-through; opacity: 0.7; }
        .goal-checkbox { font-size: 16px; }
        
        .subtopic-section {
            background: #fafbfc;
            border: 1px solid #e9ecef;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        .subtopic-header {
            font-size: 17px;
            font-weight: 600;
            color: #2c3e50;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid #e9ecef;
        }
        
        .learning-item {
            padding: 10px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        .learning-item:last-child { border-bottom: none; }
        .learning-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 15px;
        }
        .learning-item-title { font-weight: 500; flex: 1; }
        .level-badge { 
            padding: 4px 12px; 
            border-radius: 15px; 
            font-size: 11px; 
            font-weight: 600;
            white-space: nowrap;
        }
        .level-1 { background: #e2e8f0; color: #64748b; }
        .level-2 { background: #ffedd5; color: #c2410c; }
        .level-3 { background: #fef9c3; color: #a16207; }
        .level-4 { background: #dcfce7; color: #16a34a; }
        .level-5 { background: #f3e8ff; color: #7c3aed; }
        
        .item-meta {
            font-size: 11px;
            color: #6c757d;
            margin-top: 4px;
            font-style: italic;
        }
        
        .checkin-item {
            display: flex;
            justify-content: space-between;
            padding: 12px 15px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 8px;
        }
        .checkin-type {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            background: #e9ecef;
        }
        
        .footer { 
            margin-top: 50px; 
            text-align: center; 
            color: #6c757d; 
            font-size: 11px;
            padding-top: 20px;
            border-top: 1px solid #e9ecef;
        }
        
        @media print {
            body { padding: 15px; }
            .subtopic-section { break-inside: avoid; }
            .question-item { break-inside: avoid; }
        }
    </style>
</head>
<body>
    <h1>ðŸŒ± Learning Progress Report</h1>
    
    <div class="header-box">
        <p><strong>Student:</strong> ${appState.student.name || 'Not specified'}</p>
        <p><strong>Class:</strong> ${appState.student.class || 'Not specified'}</p>
        <p><strong>Topic:</strong> ${appState.topic?.name || 'Not specified'}</p>
        <p><strong>Subject:</strong> ${appState.topic?.subject || 'Not specified'} Â· ${appState.topic?.yearLevel || ''}</p>
        <p><strong>Report Generated:</strong> ${now.toLocaleDateString('en-AU', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })} at ${now.toLocaleTimeString('en-AU', { hour: '2-digit', minute: '2-digit' })}</p>
    </div>`;
    
    // QUESTIONS FIRST - Most important for teachers
    if (appState.questions.length > 0) {
        reportHtml += `
    <h2>â“ Questions for Teacher</h2>`;
        
        if (pendingQuestions.length > 0) {
            reportHtml += `
    <div class="alert-box questions">
        <h3>âš ï¸ ${pendingQuestions.length} Question${pendingQuestions.length > 1 ? 's' : ''} Awaiting Response</h3>
        <p>The student has submitted the following questions and is waiting for your help:</p>
    </div>`;
            
            pendingQuestions.forEach(q => {
                reportHtml += `
    <div class="question-item">
        <div class="question-text">${escapeHtml(q.text)}</div>
        ${q.context ? `<div class="question-context">Related to: ${escapeHtml(q.context)}</div>` : ''}
        <div class="question-context">Asked on: ${new Date(q.created).toLocaleDateString('en-AU', { day: 'numeric', month: 'short', year: 'numeric' })}</div>
    </div>`;
            });
        }
        
        if (answeredQuestions.length > 0) {
            reportHtml += `<h3>âœ… Previously Answered Questions (${answeredQuestions.length})</h3>`;
            answeredQuestions.forEach(q => {
                reportHtml += `
    <div class="question-item answered">
        <div class="question-text">${escapeHtml(q.text)}</div>
        ${q.answer ? `<div class="question-answer"><strong>Answer:</strong> ${escapeHtml(q.answer)}</div>` : ''}
    </div>`;
            });
        }
    }
    
    // GOALS
    if (appState.goals.length > 0) {
        const activeGoals = appState.goals.filter(g => !g.completed);
        const completedGoals = appState.goals.filter(g => g.completed);
        
        reportHtml += `
    <h2>ðŸŽ¯ Student Goals</h2>`;
        
        if (activeGoals.length > 0) {
            reportHtml += `<h3>Active Goals (${activeGoals.length})</h3>`;
            activeGoals.forEach(g => {
                reportHtml += `<div class="goal-item"><span class="goal-checkbox">â˜</span> ${escapeHtml(g.text)}</div>`;
            });
        }
        
        if (completedGoals.length > 0) {
            reportHtml += `<h3>Completed Goals (${completedGoals.length})</h3>`;
            completedGoals.forEach(g => {
                reportHtml += `<div class="goal-item completed"><span class="goal-checkbox">â˜‘</span> ${escapeHtml(g.text)}</div>`;
            });
        }
    }
    
    // OVERALL PROGRESS
    reportHtml += `
    <h2>ðŸ“Š Overall Progress Summary</h2>
    <div class="stats-grid">
        <div class="stat-box"><div class="stat-number">${stats.overallPercentage}%</div><div class="stat-label">Overall</div></div>
        <div class="stat-box"><div class="stat-number">${stats.mastered}</div><div class="stat-label">â­Â Mastered</div></div>
        <div class="stat-box"><div class="stat-number">${stats.confident}</div><div class="stat-label">ðŸŒ² Confident</div></div>
        <div class="stat-box"><div class="stat-number">${stats.developing}</div><div class="stat-label">ðŸŒ³ Developing</div></div>
        <div class="stat-box"><div class="stat-number">${stats.beginning + stats.notStarted}</div><div class="stat-label">ðŸŒ±ðŸŒ¿ Needs Work</div></div>
    </div>`;
    
    // DETAILED LEARNING OUTCOMES
    if (appState.topic && appState.topic.subtopics) {
        reportHtml += `<h2>ðŸ“š Learning Outcomes by Section</h2>`;
        
        appState.topic.subtopics.forEach(subtopic => {
            // Calculate subtopic stats
            let subtopicTotal = 0;
            let subtopicPoints = 0;
            subtopic.items.forEach(item => {
                const data = appState.learningItems[item.id] || { level: 1 };
                subtopicTotal++;
                subtopicPoints += data.level;
            });
            const subtopicPercent = Math.round((subtopicPoints / (subtopicTotal * 5)) * 100);
            
            reportHtml += `
    <div class="subtopic-section">
        <div class="subtopic-header">${subtopic.icon} ${subtopic.name} <span style="float: right; font-size: 14px; color: #2d9d78;">${subtopicPercent}%</span></div>`;
            
            // Each learning item - only dynamic data (level and last updated)
            subtopic.items.forEach(item => {
                const data = appState.learningItems[item.id] || { level: 1 };
                const lastChange = data.history && data.history.length > 0 
                    ? data.history[data.history.length - 1] 
                    : null;
                
                reportHtml += `
        <div class="learning-item">
            <div class="learning-item-header">
                <span class="learning-item-title">${escapeHtml(item.title)}</span>
                <span class="level-badge level-${data.level}">${levelEmojis[data.level - 1]} ${levelNames[data.level - 1]}</span>
            </div>
            ${lastChange ? `<div class="item-meta">Last updated: ${new Date(lastChange.date).toLocaleDateString('en-AU', { day: 'numeric', month: 'short', year: 'numeric' })}</div>` : ''}
        </div>`;
            });
            
            reportHtml += `</div>`;
        });
    }
    
    // CHECK-IN HISTORY
    reportHtml += `<h2>ðŸ“… Check-in History</h2>`;
    
    if (appState.checkins.length > 0) {
        const typeLabels = {
            pretopic: 'ðŸš€ Pre-Topic Assessment',
            weekly: 'ðŸ“… Weekly Check-in',
            revision: 'ðŸ“š Revision Session',
            posttest: 'âœ… Post-Test'
        };
        
        appState.checkins.slice().reverse().forEach(checkin => {
            reportHtml += `
    <div class="checkin-item">
        <div>
            <span class="checkin-type">${typeLabels[checkin.type] || checkin.type}</span>
            <span style="margin-left: 10px; color: #6c757d;">${new Date(checkin.date).toLocaleDateString('en-AU', { weekday: 'short', day: 'numeric', month: 'short', year: 'numeric', hour: '2-digit', minute: '2-digit' })}</span>
        </div>
        <div>
            <strong>${checkin.stats.overallPercentage}%</strong> Â· 
            ${checkin.stats.mastered} mastered
            ${checkin.improved !== undefined ? ` Â· <span style="color: #28a745;">â†‘${checkin.improved}</span> <span style="color: #dc3545;">â†“${checkin.dropped}</span>` : ''}
        </div>
    </div>`;
        });
    } else {
        reportHtml += `<p style="color: #6c757d; font-style: italic;">No formal check-ins recorded yet.</p>`;
    }
    
    reportHtml += `
    <div class="footer">
        <p>Generated by Dynamic Learning Check-in Â· ${now.toLocaleDateString('en-AU')} Â· ${appState.topic?.curriculumCode || ''}</p>
    </div>
</body>
</html>`;
    
    // Try to open in new window, fallback to current window print
    try {
        const printWindow = window.open('', '_blank');
        
        if (!printWindow || printWindow.closed || typeof printWindow.closed === 'undefined') {
            showToast('Opening print dialog...', 'info');
            window.print();
            return;
        }
        
        printWindow.document.write(reportHtml);
        printWindow.document.close();
        printWindow.onload = function() {
            printWindow.print();
        };
    } catch (e) {
        showToast('Opening print dialog...', 'info');
        window.print();
    }
}

function emailReport() {
    const stats = calculateStats();
    const now = new Date();
    const levelNames = ['Not started', 'Beginning', 'Developing', 'Confident', 'Mastered'];
    const levelEmojis = ['ðŸŒ±', 'ðŸŒ¿', 'ðŸŒ³', 'ðŸŒ²', 'â­Â'];
    
    const pendingQuestions = appState.questions.filter(q => q.status === 'pending');
    
    const subject = encodeURIComponent(`Learning Progress Report - ${appState.student.name || 'Student'} - ${appState.topic?.name || 'Topic'}`);
    
    let body = `LEARNING PROGRESS REPORT
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Student: ${appState.student.name || 'Not specified'}
Class: ${appState.student.class || 'Not specified'}
Topic: ${appState.topic?.name || 'Not specified'}
Subject: ${appState.topic?.subject || 'Not specified'} Â· ${appState.topic?.yearLevel || ''}
Report Date: ${now.toLocaleDateString('en-AU', { weekday: 'long', day: 'numeric', month: 'long', year: 'numeric' })}

`;

    // QUESTIONS FIRST - Most important for teachers
    if (pendingQuestions.length > 0) {
        body += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
â“ QUESTIONS FOR TEACHER (${pendingQuestions.length} pending)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

âš ï¸ The student needs help with the following:

`;
        pendingQuestions.forEach((q, i) => {
            body += `Question ${i + 1}:
${q.text}
${q.context ? `(Related to: ${q.context})` : ''}
Asked: ${new Date(q.created).toLocaleDateString('en-AU')}

`;
        });
    }

    // GOALS
    if (appState.goals.length > 0) {
        const activeGoals = appState.goals.filter(g => !g.completed);
        const completedGoals = appState.goals.filter(g => g.completed);
        
        body += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸŽ¯ STUDENT GOALS
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

`;
        if (activeGoals.length > 0) {
            body += `Active Goals:\n`;
            activeGoals.forEach(g => {
                body += `â˜ ${g.text}\n`;
            });
            body += `\n`;
        }
        if (completedGoals.length > 0) {
            body += `Completed Goals:\n`;
            completedGoals.forEach(g => {
                body += `â˜‘ ${g.text}\n`;
            });
            body += `\n`;
        }
    }

    // PROGRESS SUMMARY
    body += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸ“Š PROGRESS SUMMARY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

Overall Understanding: ${stats.overallPercentage}%

â­Â Mastered:     ${stats.mastered} items
ðŸŒ² Confident:    ${stats.confident} items
ðŸŒ³ Developing:   ${stats.developing} items
ðŸŒ¿ Beginning:    ${stats.beginning} items
ðŸŒ± Not Started:  ${stats.notStarted} items

Total Check-ins Completed: ${appState.checkins.length}

`;

    // DETAILED BREAKDOWN BY SECTION
    if (appState.topic && appState.topic.subtopics) {
        body += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸ“š LEARNING OUTCOMES BY SECTION
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

`;
        
        appState.topic.subtopics.forEach(subtopic => {
            // Calculate subtopic stats
            let subtopicTotal = 0;
            let subtopicPoints = 0;
            subtopic.items.forEach(item => {
                const data = appState.learningItems[item.id] || { level: 1 };
                subtopicTotal++;
                subtopicPoints += data.level;
            });
            const subtopicPercent = Math.round((subtopicPoints / (subtopicTotal * 5)) * 100);
            
            body += `â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
${subtopic.icon} ${subtopic.name} (${subtopicPercent}%)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

`;
            
            subtopic.items.forEach(item => {
                const data = appState.learningItems[item.id] || { level: 1 };
                const lastChange = data.history && data.history.length > 0 
                    ? data.history[data.history.length - 1] 
                    : null;
                const dateStr = lastChange 
                    ? ` (${new Date(lastChange.date).toLocaleDateString('en-AU', { day: 'numeric', month: 'short' })})` 
                    : '';
                body += `${levelEmojis[data.level - 1]} [${levelNames[data.level - 1]}] ${item.title}${dateStr}\n`;
            });
            body += `\n`;
        });
    }

    // CHECK-IN HISTORY
    if (appState.checkins.length > 0) {
        const typeLabels = {
            pretopic: 'Pre-Topic',
            weekly: 'Weekly',
            revision: 'Revision',
            posttest: 'Post-Test'
        };
        
        body += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
ðŸ“… CHECK-IN HISTORY
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

`;
        appState.checkins.slice().reverse().forEach(checkin => {
            body += `${new Date(checkin.date).toLocaleDateString('en-AU')} - ${typeLabels[checkin.type] || checkin.type}: ${checkin.stats.overallPercentage}% (${checkin.stats.mastered} mastered)\n`;
        });
        body += `\n`;
    }

    body += `â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
Generated by Dynamic Learning Check-in
${appState.topic?.curriculumCode || ''}
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•`;
    
    window.location.href = `mailto:?subject=${subject}&body=${encodeURIComponent(body)}`;
}

function clearAllData() {
    if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
        if (confirm('This is your last chance. All progress will be permanently deleted.')) {
            localStorage.removeItem(STORAGE_KEY);
            location.reload();
        }
    }
}

function loadTopic(jsonString) {
    try {
        const topic = JSON.parse(jsonString);
        if (!topic.name || !topic.subtopics) {
            throw new Error('Invalid topic format');
        }
        pushUndoState();
        appState.topic = topic;
        appState.learningItems = {};
        
        // Auto-populate class if provided in topic
        if (topic.class) {
            appState.student.class = topic.class;
            const classInput = document.getElementById('class-input');
            if (classInput) classInput.value = topic.class;
        }
        
        initLearningItems();
        saveData();
        renderAll();
        showToast('Topic loaded!', 'success');
        return true;
    } catch (e) {
        showToast('Invalid topic format', 'error');
        return false;
    }
}

// ============================================
// ONBOARDING
// ============================================
let currentOnboardingPage = 1;
const totalOnboardingPages = 5;

function showOnboarding() {
    currentOnboardingPage = 1;
    updateOnboardingUI();
    document.getElementById('onboarding-overlay').classList.add('active');
}

function closeOnboarding() {
    document.getElementById('onboarding-overlay').classList.remove('active');
    // Mark as seen
    localStorage.setItem('onboardingSeen', 'true');
}

function updateOnboardingUI() {
    // Update pages
    document.querySelectorAll('.onboarding-page').forEach(page => {
        page.classList.toggle('active', parseInt(page.dataset.page) === currentOnboardingPage);
    });
    
    // Update dots
    document.querySelectorAll('.onboarding-dot').forEach(dot => {
        dot.classList.toggle('active', parseInt(dot.dataset.page) === currentOnboardingPage);
    });
    
    // Update buttons
    const prevBtn = document.getElementById('onboarding-prev-btn');
    const nextBtn = document.getElementById('onboarding-next-btn');
    
    prevBtn.disabled = currentOnboardingPage === 1;
    
    if (currentOnboardingPage === totalOnboardingPages) {
        nextBtn.textContent = "Let's Go";
    } else {
        nextBtn.textContent = 'Next';
    }
}

function nextOnboardingPage() {
    if (currentOnboardingPage === totalOnboardingPages) {
        closeOnboarding();
    } else {
        currentOnboardingPage++;
        updateOnboardingUI();
    }
}

function prevOnboardingPage() {
    if (currentOnboardingPage > 1) {
        currentOnboardingPage--;
        updateOnboardingUI();
    }
}

function goToOnboardingPage(page) {
    currentOnboardingPage = page;
    updateOnboardingUI();
}

// ============================================
// UI HELPERS
// ============================================
function showToast(message, type = 'info') {
    const container = document.getElementById('toast-container');
    const toast = document.createElement('div');
    toast.className = `toast toast-${type}`;
    
    const icons = { success: 'âœ…', error: 'âŒ', info: 'â„¹ï¸', warning: 'âš ï¸' };
    
    toast.innerHTML = `
        <span class="toast-icon">${icons[type] || icons.info}</span>
        <span class="toast-message">${escapeHtml(message)}</span>
        <button class="toast-close">Ã—</button>
    `;
    
    container.appendChild(toast);
    toast.querySelector('.toast-close').addEventListener('click', () => toast.remove());
    setTimeout(() => toast.remove(), 4000);
}

function openSettings() {
    document.getElementById('settings-overlay').classList.add('active');
}

function closeSettings() {
    document.getElementById('settings-overlay').classList.remove('active');
    saveStudentInfo();
}

function saveStudentInfo() {
    appState.student.name = document.getElementById('student-name-input').value;
    appState.student.class = document.getElementById('class-input').value;
    saveData();
    renderStudentInfo();
}

function expandAll() {
    document.querySelectorAll('.topic-header').forEach(header => {
        header.setAttribute('aria-expanded', 'true');
        document.getElementById(header.getAttribute('aria-controls')).classList.add('expanded');
    });
}

function collapseAll() {
    document.querySelectorAll('.topic-header').forEach(header => {
        header.setAttribute('aria-expanded', 'false');
        document.getElementById(header.getAttribute('aria-controls')).classList.remove('expanded');
    });
}

// ============================================
// TAB NAVIGATION
// ============================================
function setupTabNavigation() {
    const tabs = document.querySelectorAll('.nav-tab');
    const panels = document.querySelectorAll('.panel-content');
    
    tabs.forEach(tab => {
        tab.addEventListener('click', () => {
            tabs.forEach(t => t.setAttribute('aria-selected', 'false'));
            panels.forEach(p => p.classList.remove('active'));
            
            tab.setAttribute('aria-selected', 'true');
            document.getElementById(tab.getAttribute('aria-controls')).classList.add('active');
        });
    });
}

function switchTab(tabName) {
    const tabs = document.querySelectorAll('.nav-tab');
    const panels = document.querySelectorAll('.panel-content');
    const targetTab = document.getElementById(`${tabName}-tab`);
    const targetPanel = document.getElementById(`${tabName}-panel`);
    
    if (targetTab && targetPanel) {
        tabs.forEach(t => t.setAttribute('aria-selected', 'false'));
        panels.forEach(p => p.classList.remove('active'));
        
        targetTab.setAttribute('aria-selected', 'true');
        targetPanel.classList.add('active');
    }
}

function navigateToLearningItem(itemId) {
    // Switch to learning tab
    switchTab('learning');
    
    // Find which subtopic contains this item
    let targetSubtopicId = null;
    for (const subtopic of (appState.topic?.subtopics || [])) {
        if (subtopic.items.some(item => item.id === itemId)) {
            targetSubtopicId = subtopic.id;
            break;
        }
    }
    
    // Wait a tick for the tab switch to complete
    setTimeout(() => {
        // Expand the subtopic section if collapsed
        if (targetSubtopicId) {
            const subtopicHeader = document.getElementById(`subtopic-${targetSubtopicId}-header`);
            const subtopicContent = document.getElementById(`subtopic-${targetSubtopicId}-content`);
            
            if (subtopicHeader && subtopicContent && !subtopicContent.classList.contains('expanded')) {
                subtopicHeader.setAttribute('aria-expanded', 'true');
                subtopicContent.classList.add('expanded');
            }
        }
        
        // Find and scroll to the learning item
        const itemEl = document.querySelector(`.learning-item-simple[data-item-id="${itemId}"]`);
        if (itemEl) {
            // Scroll into view with some offset
            itemEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
            
            // Highlight it briefly
            itemEl.style.transition = 'background-color 0.3s';
            itemEl.style.backgroundColor = 'var(--color-primary-pale)';
            setTimeout(() => {
                itemEl.style.backgroundColor = '';
            }, 2000);
            
            // Open the What/Why/Example section
            const helpToggle = itemEl.querySelector('.help-toggle-inline');
            const helpContentId = helpToggle?.getAttribute('aria-controls');
            const helpContent = helpContentId ? document.getElementById(helpContentId) : null;
            
            if (helpToggle && helpContent && !helpContent.classList.contains('expanded')) {
                helpToggle.setAttribute('aria-expanded', 'true');
                helpContent.classList.add('expanded');
            }
        }
    }, 100);
}

// ============================================
// KEYBOARD SHORTCUTS
// ============================================
// Track pressed keys for simultaneous key detection
const pressedKeys = new Set();

function setupKeyboardShortcuts() {
    const isMac = navigator.platform.toUpperCase().indexOf('MAC') >= 0;
    
    document.addEventListener('keydown', (e) => {
        const ctrlKey = isMac ? e.metaKey : e.ctrlKey;
        
        // Track pressed keys
        pressedKeys.add(e.key.toLowerCase());
        
        // Check for Q+W+E simultaneous press (debug feature)
        if (pressedKeys.has('q') && pressedKeys.has('w') && pressedKeys.has('e')) {
            e.preventDefault();
            generateTestData();
            pressedKeys.clear();
            return;
        }
        
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
            if (e.key !== 'Escape') return;
        }
        
        if (ctrlKey && e.key === 'z' && !e.shiftKey) { e.preventDefault(); undo(); }
        if (ctrlKey && (e.key === 'y' || (e.key === 'z' && e.shiftKey))) { e.preventDefault(); redo(); }
        if (ctrlKey && e.key === 'd') { e.preventDefault(); toggleTheme(); }
        
        if (e.key === 'Escape') {
            // If quiz overlay is open and not answered yet, close it properly
            if (document.getElementById('quiz-overlay').classList.contains('active') && currentQuiz && !currentQuiz.answered) {
                closeQuiz();
            } else {
                document.querySelectorAll('.overlay.active').forEach(o => o.classList.remove('active'));
            }
        }
    });
    
    document.addEventListener('keyup', (e) => {
        pressedKeys.delete(e.key.toLowerCase());
    });
    
    // Clear pressed keys when window loses focus
    window.addEventListener('blur', () => {
        pressedKeys.clear();
    });
}

// ============================================
// TEST DATA GENERATION (QWE debug feature)
// ============================================
function generateTestData() {
    if (!appState.topic || !appState.topic.subtopics) {
        showToast('No topic loaded - load a topic first', 'error');
        return;
    }
    
    pushUndoState();
    
    // Find the most recent date in existing history, or use 30 days ago
    let lastDate = new Date();
    lastDate.setDate(lastDate.getDate() - 30);
    
    Object.values(appState.learningItems).forEach(item => {
        if (item.history && item.history.length > 0) {
            const itemLastDate = new Date(item.history[item.history.length - 1].date);
            if (itemLastDate > lastDate) {
                lastDate = itemLastDate;
            }
        }
    });
    
    // Generate data points over the next few weeks
    const daysToAdd = Math.floor(Math.random() * 5) + 3; // 3-7 days ahead
    const newDate = new Date(lastDate);
    newDate.setDate(newDate.getDate() + daysToAdd);
    newDate.setHours(Math.floor(Math.random() * 10) + 8); // Between 8am-6pm
    newDate.setMinutes(Math.floor(Math.random() * 60));
    
    // Get all items and gradually improve them
    let itemIndex = 0;
    appState.topic.subtopics.forEach(subtopic => {
        subtopic.items.forEach(item => {
            if (!appState.learningItems[item.id]) {
                appState.learningItems[item.id] = { level: 1, history: [], notes: [] };
            }
            
            const itemData = appState.learningItems[item.id];
            const currentLevel = itemData.level;
            
            // Probability of improvement based on position (earlier items more likely to improve)
            const improvementChance = 0.7 - (itemIndex * 0.02);
            const shouldImprove = Math.random() < improvementChance && currentLevel < 5;
            
            // Sometimes drop a level (rarely)
            const shouldDrop = Math.random() < 0.05 && currentLevel > 1;
            
            let newLevel = currentLevel;
            if (shouldImprove) {
                newLevel = Math.min(5, currentLevel + 1);
            } else if (shouldDrop) {
                newLevel = Math.max(1, currentLevel - 1);
            }
            
            // Record history entry
            if (newLevel !== currentLevel || Math.random() < 0.3) { // Sometimes record even if same level
                // Add slight time variance per item
                const itemDate = new Date(newDate);
                itemDate.setMinutes(itemDate.getMinutes() + (itemIndex * 2));
                
                itemData.history.push({
                    date: itemDate.toISOString(),
                    level: newLevel,
                    previousLevel: currentLevel
                });
                itemData.level = newLevel;
            }
            
            itemIndex++;
        });
    });
    
    saveData();
    renderAll();
    
    const dateStr = newDate.toLocaleDateString('en-AU', { day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' });
    showToast(`ðŸ“Š Test data generated for ${dateStr}`, 'success');
}

// ============================================
// INITIALIZATION
// ============================================
function init() {
    loadData();
    loadQuizState();
    setupTabNavigation();
    setupKeyboardShortcuts();
    renderAll();
    
    // Header buttons
    document.getElementById('undo-btn').addEventListener('click', undo);
    document.getElementById('redo-btn').addEventListener('click', redo);
    document.getElementById('settings-btn').addEventListener('click', openSettings);
    document.getElementById('new-checkin-btn').addEventListener('click', openCheckinOverlay);
    document.getElementById('start-checkin-btn').addEventListener('click', openCheckinOverlay);
    
    // Topic selector dropdowns
    document.getElementById('year-level-dropdown').addEventListener('change', onYearLevelChange);
    document.getElementById('subject-dropdown').addEventListener('change', onSubjectChange);
    document.getElementById('topic-dropdown').addEventListener('change', onTopicChange);
    
    // Initialize topic display
    updateTopicCurrentDisplay();
    
    // Load manifest (will populate dropdowns when ready)
    loadManifest();
    
    // Settings
    document.getElementById('settings-close-btn').addEventListener('click', closeSettings);
    document.getElementById('settings-overlay').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) closeSettings();
    });
    document.getElementById('dark-mode-toggle').addEventListener('change', toggleTheme);
    document.getElementById('show-onboarding-btn').addEventListener('click', () => {
        closeSettings();
        showOnboarding();
    });
    
    // Onboarding
    document.getElementById('onboarding-close-btn').addEventListener('click', closeOnboarding);
    document.getElementById('onboarding-next-btn').addEventListener('click', nextOnboardingPage);
    document.getElementById('onboarding-prev-btn').addEventListener('click', prevOnboardingPage);
    document.getElementById('onboarding-overlay').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) closeOnboarding();
    });
    document.querySelectorAll('.onboarding-dot').forEach(dot => {
        dot.addEventListener('click', () => goToOnboardingPage(parseInt(dot.dataset.page)));
    });
    
    // Check-in
    document.getElementById('checkin-close-btn').addEventListener('click', closeCheckinOverlay);
    document.getElementById('checkin-cancel-btn').addEventListener('click', closeCheckinOverlay);
    document.getElementById('checkin-start-btn').addEventListener('click', startCheckinMode);
    document.getElementById('checkin-overlay').addEventListener('click', (e) => {
        if (e.target === e.currentTarget) closeCheckinOverlay();
    });
    document.querySelectorAll('.checkin-type-btn').forEach(btn => {
        btn.addEventListener('click', () => setCheckinType(btn.dataset.type));
    });
    
    // Quiz overlay
    document.getElementById('quiz-close-btn').addEventListener('click', closeQuiz);
    document.getElementById('quiz-cancel-btn').addEventListener('click', closeQuiz);
    // Note: quiz-submit-btn uses onclick (set in showQuiz/submitQuizAnswer), not addEventListener
    // to avoid double-firing when both onclick and listener exist
    document.getElementById('quiz-submit-btn').onclick = submitQuizAnswer;
    document.getElementById('quiz-overlay').addEventListener('click', (e) => {
        if (e.target === e.currentTarget && !currentQuiz?.answered) closeQuiz();
    });
    
    // Goals & Questions
    document.getElementById('add-goal-btn').addEventListener('click', addGoal);
    document.getElementById('add-question-btn').addEventListener('click', addQuestion);
    
    // Export
    document.getElementById('expand-all-btn').addEventListener('click', expandAll);
    document.getElementById('collapse-all-btn').addEventListener('click', collapseAll);
    document.getElementById('export-pdf-btn').addEventListener('click', printReport);
    document.getElementById('export-json-btn').addEventListener('click', exportData);
    document.getElementById('email-report-btn').addEventListener('click', emailReport);
    document.getElementById('import-btn').addEventListener('click', () => document.getElementById('import-file').click());
    document.getElementById('import-file').addEventListener('change', importData);
    document.getElementById('clear-data-btn').addEventListener('click', clearAllData);
    
    // Auto-save student info on change
    ['student-name-input', 'class-input'].forEach(id => {
        document.getElementById(id).addEventListener('change', saveStudentInfo);
    });
    
    // System theme preference
    if (window.matchMedia && !appState.lastSaved) {
        if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
            applyTheme('dark');
        }
    }
    
    // Initialize text selection popup feature
    initSelectionPopup();
    
    // Show hint toast after 2 minutes (once per session)
    if (!sessionStorage.getItem('selectionHintShown')) {
        setTimeout(() => {
            showToast('ðŸ’¡ Tip: Select any text for learning options', 'info', 5000);
            sessionStorage.setItem('selectionHintShown', 'true');
        }, 120000); // 2 minutes
    }
    
    // Show onboarding on first run
    if (!localStorage.getItem('onboardingSeen')) {
        setTimeout(() => showOnboarding(), 500);
    }
}

// ============================================
// TEXT SELECTION POPUP FEATURE
// ============================================
let selectionPopup = null;
let selectionTimeout = null;

function initSelectionPopup() {
    // Create popup element
    selectionPopup = document.createElement('div');
    selectionPopup.className = 'selection-popup';
    selectionPopup.style.display = 'none';
    selectionPopup.innerHTML = `
        <button class="selection-popup-btn teacher" data-action="teacher">
            <span class="popup-icon">ðŸ‘©â€ðŸ«</span>
            <span class="popup-label">Ask my teacher</span>
        </button>
        <button class="selection-popup-btn google" data-action="google">
            <span class="popup-icon">ðŸ“</span>
            <span class="popup-label">Search Google</span>
        </button>
        <button class="selection-popup-btn chatgpt" data-action="chatgpt">
            <span class="popup-icon">ðŸ¤–</span>
            <span class="popup-label">Ask ChatGPT</span>
        </button>
    `;
    document.body.appendChild(selectionPopup);
    
    // Handle popup button clicks
    selectionPopup.addEventListener('click', (e) => {
        const btn = e.target.closest('.selection-popup-btn');
        if (!btn) return;
        
        const action = btn.dataset.action;
        const selectedText = window.getSelection().toString().trim();
        const context = getSelectionContext();
        
        if (action === 'teacher') {
            handleTeacherQuestion(selectedText, context);
        } else if (action === 'google') {
            handleGoogleSearch(selectedText, context);
        } else if (action === 'chatgpt') {
            handleChatGPT(selectedText, context);
        }
        
        hideSelectionPopup();
    });
    
    // Listen for text selection
    document.addEventListener('mouseup', handleTextSelection);
    document.addEventListener('touchend', handleTextSelection);
    
    // Hide popup when clicking elsewhere
    document.addEventListener('mousedown', (e) => {
        if (!selectionPopup.contains(e.target)) {
            hideSelectionPopup();
        }
    });
    
    // Hide on scroll
    document.addEventListener('scroll', hideSelectionPopup, true);
}

function handleTextSelection(e) {
    // Clear any pending timeout
    if (selectionTimeout) {
        clearTimeout(selectionTimeout);
        selectionTimeout = null;
    }
    
    const selection = window.getSelection();
    const selectedText = selection.toString().trim();
    
    // Need at least 3 characters selected
    if (selectedText.length < 3) {
        return;
    }
    
    // Don't show if selection is inside the popup itself
    if (selectionPopup.contains(e.target)) {
        return;
    }
    
    // Only show popup for learning content (not headings, instructions, etc.)
    // Check if selection is within: learning item title, or What/Why/Example content
    const range = selection.getRangeAt(0);
    const container = range.commonAncestorContainer;
    const element = container.nodeType === Node.ELEMENT_NODE 
        ? container 
        : container.parentElement;
    
    if (!element) return;
    
    // Check if within allowed areas
    const isInLearningTitle = element.closest('.learning-item-title');
    const isInHelpContent = element.closest('.help-content-inline');
    const isInSubtopicExplanation = element.closest('.explanation-content');
    const isInLearningItem = element.closest('.learning-item-simple');
    
    // Only proceed if in learning item title, help content, or subtopic explanation
    if (!isInLearningTitle && !isInHelpContent && !isInSubtopicExplanation) {
        return;
    }
    
    // Wait 1 second before showing popup
    selectionTimeout = setTimeout(() => {
        const currentSelection = window.getSelection();
        const currentText = currentSelection.toString().trim();
        
        // Make sure selection still exists and is the same
        if (currentText.length >= 3 && currentText === selectedText) {
            showSelectionPopup(currentSelection);
        }
    }, 1000);
}

function showSelectionPopup(selection) {
    if (!selection.rangeCount) return;
    
    const range = selection.getRangeAt(0);
    const rect = range.getBoundingClientRect();
    
    // Position popup above or below selection
    const popupHeight = 120; // Approximate height
    const spaceAbove = rect.top;
    const spaceBelow = window.innerHeight - rect.bottom;
    
    selectionPopup.style.display = 'flex';
    
    // Get actual popup dimensions after showing
    const popupRect = selectionPopup.getBoundingClientRect();
    
    let top, left;
    
    // Position horizontally centered on selection
    left = rect.left + (rect.width / 2) - (popupRect.width / 2);
    left = Math.max(8, Math.min(left, window.innerWidth - popupRect.width - 8));
    
    // Position above or below based on available space
    if (spaceBelow > popupHeight + 10 || spaceBelow > spaceAbove) {
        top = rect.bottom + window.scrollY + 8;
    } else {
        top = rect.top + window.scrollY - popupRect.height - 8;
    }
    
    selectionPopup.style.left = `${left}px`;
    selectionPopup.style.top = `${top}px`;
}

function hideSelectionPopup() {
    if (selectionPopup) {
        selectionPopup.style.display = 'none';
    }
    if (selectionTimeout) {
        clearTimeout(selectionTimeout);
        selectionTimeout = null;
    }
}

function getSelectionContext() {
    const selection = window.getSelection();
    if (!selection.rangeCount) return null;
    
    const range = selection.getRangeAt(0);
    const container = range.commonAncestorContainer;
    
    // Find the learning item element
    const itemEl = container.nodeType === Node.ELEMENT_NODE 
        ? container.closest('.learning-item-simple')
        : container.parentElement?.closest('.learning-item-simple');
    
    if (!itemEl) {
        // Maybe in subtopic header area
        const subtopicEl = container.nodeType === Node.ELEMENT_NODE
            ? container.closest('.subtopic-section')
            : container.parentElement?.closest('.subtopic-section');
        
        if (subtopicEl) {
            const subtopicId = subtopicEl.dataset.subtopicId;
            const subtopic = appState.topic?.subtopics?.find(s => s.id === subtopicId);
            return {
                subtopic: subtopic?.name || 'Unknown section',
                subtopicIcon: subtopic?.icon || '',
                topic: appState.topic?.name || 'Unknown topic'
            };
        }
        
        return {
            topic: appState.topic?.name || 'Unknown topic'
        };
    }
    
    const itemId = parseInt(itemEl.dataset.itemId);
    const itemData = appState.learningItems[itemId] || { level: 1 };
    const levelNames = ['Not started', 'Beginning', 'Developing', 'Confident', 'Mastered'];
    
    // Find the item in the topic structure
    let foundItem = null;
    let foundSubtopic = null;
    
    for (const subtopic of (appState.topic?.subtopics || [])) {
        const item = subtopic.items.find(i => i.id === itemId);
        if (item) {
            foundItem = item;
            foundSubtopic = subtopic;
            break;
        }
    }
    
    return {
        itemId: itemId,
        itemTitle: foundItem?.title || 'Unknown item',
        itemWhat: foundItem?.what || '',
        itemWhy: foundItem?.why || '',
        itemExample: foundItem?.example || '',
        level: itemData.level,
        levelName: levelNames[itemData.level - 1],
        subtopic: foundSubtopic?.name || 'Unknown section',
        subtopicIcon: foundSubtopic?.icon || '',
        topic: appState.topic?.name || 'Unknown topic',
        subject: appState.topic?.subject || '',
        yearLevel: appState.topic?.yearLevel || ''
    };
}

function handleTeacherQuestion(selectedText, context) {
    // Navigate to Questions tab and add the question
    switchTab('questions');
    
    // Build the question text
    let questionText = `I need help understanding: "${selectedText}"`;
    
    if (context?.itemTitle) {
        questionText += `\n\n(This is about: ${context.itemTitle})`;
    }
    
    // Add to questions
    const question = {
        id: Date.now(),
        text: questionText,
        context: context?.itemTitle || '',
        status: 'pending',
        created: new Date().toISOString(),
        answer: ''
    };
    
    appState.questions.push(question);
    saveData();
    renderQuestions();
    
    showToast('Question added for your teacher!', 'success');
}

function handleGoogleSearch(selectedText, context) {
    let searchQuery = `please explain "${selectedText}"`;
    
    if (context?.subject) {
        searchQuery += ` ${context.subject}`;
    }
    if (context?.yearLevel) {
        searchQuery += ` ${context.yearLevel}`;
    }
    
    const url = `https://www.google.com/search?q=${encodeURIComponent(searchQuery)}`;
    window.open(url, '_blank');
}

function handleChatGPT(selectedText, context) {
    // Build a rich prompt with context
    let prompt = `I'm a student studying ${context?.subject || 'this topic'} at ${context?.yearLevel || 'school'} level.\n\n`;
    
    prompt += `I need help understanding: "${selectedText}"\n\n`;
    
    if (context?.topic) {
        prompt += `Topic: ${context.topic}\n`;
    }
    if (context?.subtopic) {
        prompt += `Section: ${context.subtopic}\n`;
    }
    if (context?.itemTitle) {
        prompt += `Learning goal: ${context.itemTitle}\n`;
    }
    if (context?.levelName) {
        prompt += `My current level: ${context.levelName}\n`;
    }
    
    prompt += `\nPlease help me understand this by:\n`;
    prompt += `1. Explaining it simply\n`;
    prompt += `2. Giving me a clear example\n`;
    prompt += `3. Asking me a question to check my understanding`;
    
    // Add the What/Why/Example context if available
    if (context?.itemWhat || context?.itemWhy || context?.itemExample) {
        prompt += `\n\nHere's some context about what I'm learning:\n`;
        if (context.itemWhat) prompt += `What it is: ${context.itemWhat}\n`;
        if (context.itemWhy) prompt += `Why it matters: ${context.itemWhy}\n`;
        if (context.itemExample) prompt += `Example: ${context.itemExample}\n`;
    }
    
    const url = `https://chatgpt.com/?prompt=${encodeURIComponent(prompt)}`;
    window.open(url, '_blank');
}

document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>
