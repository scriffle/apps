<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Colour Me</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background-color: #121213;
            color: #ffffff;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            overflow-y: auto;
        }
        
        body.light {
            background-color: #ffffff;
            color: #121213;
        }
        
        /* Header */
        #header {
            width: 100%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 20px;
            position: relative;
        }
        
        h1 {
            font-size: 32px;
            font-weight: 700;
            letter-spacing: 0.1em;
            cursor: pointer;
            user-select: none;
            transition: opacity 0.2s;
        }
        
        h1:hover {
            opacity: 0.8;
        }
        
        #settingsButton {
            position: absolute;
            top: 0;
            right: 0;
        }
        
        .icon-button {
            background: none;
            border: none;
            color: inherit;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
            border-radius: 4px;
            transition: background-color 0.2s;
        }
        
        .icon-button:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }
        
        body.light .icon-button:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }
        
        /* Game Container */
        #gameContainer {
            width: 100%;
            max-width: 800px;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 10px;
        }
        
        /* Color Display Area */
        #colorDisplay {
            display: flex;
            gap: 20px;
            align-items: center;
        }
        
        .colorSwatch {
            width: 120px;
            height: 120px;
            border: 2px solid #3a3a3c;
            border-radius: 8px;
            position: relative;
            transition: background-color 0.3s;
        }
        
        #targetColor {
            cursor: pointer;
        }
        
        #targetColor:hover {
            border-color: #565758;
            transform: scale(1.02);
        }
        
        .colorSwatch.empty {
            background-color: #000000;
        }
        
        .swatchLabel {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 12px;
            opacity: 0.7;
            white-space: nowrap;
        }
        
        .colorName {
            position: absolute;
            top: -20px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 11px;
            font-weight: bold;
            opacity: 0.9;
            white-space: nowrap;
        }
        
        /* Game Board Container */
        #gameBoardContainer {
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
            margin: 10px 0 80px 0;
        }
        
        /* Game Board */
        #gameBoard {
            position: relative;
            display: flex;
            align-items: center;
            margin-left: 180px; /* Space for absolute positioned swatches */
        }
        
        /* Guess Rows */
        #guessArea {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin: 0 auto;
            position: relative;
        }
        
        .guessRow {
            display: none;
            gap: 10px;
            position: relative;
        }
        
        .guessRow.active {
            display: flex;
        }
        
        .mixedColorName {
            position: absolute;
            top: calc(50% - 27px); /* Move up by 1/3 of 80px tile height */
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 14px;
            font-weight: bold;
            z-index: 20;
            pointer-events: none;
            white-space: nowrap;
            padding: 4px 12px;
            border-radius: 12px;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
        }
        
        .mixedColorName.light-bg {
            background: rgba(255, 255, 255, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.9);
            color: #000000;
        }
        
        .mixedColorName.dark-bg {
            background: rgba(0, 0, 0, 0.85);
            border: 1px solid rgba(0, 0, 0, 0.9);
            color: #ffffff;
        }
        
        .colorBackground {
            position: absolute;
            top: -5px;
            left: -10px;
            right: -10px;
            bottom: -5px;
            border-radius: 12px;
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .colorBackground.show {
            opacity: 1;
        }
        
        .tile {
            width: 80px;
            height: 80px;
            border: 2px solid #3a3a3c;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            font-weight: bold;
            transition: all 0.2s;
            position: relative;
            background-color: #000000;
        }
        
        body.light .tile {
            border-color: #d0d0d0;
            background-color: #000000;
        }
        
        .tile.filled {
            border-color: #565758;
        }
        
        .tile.locked {
            cursor: not-allowed;
        }
        
        .checkmark {
            position: absolute;
            bottom: 4px;
            left: 4px;
            color: #ffffff;
            font-size: 16px;
            font-weight: bold;
            display: none;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.8);
            z-index: 10;
        }
        
        .tile.correct .checkmark {
            display: block;
        }
        
        /* Saturation Swatches */
        .swatchPanel {
            position: absolute;
            display: flex;
            flex-direction: column;
            gap: 8px;
            top: 0;
        }
        
        #redSwatches {
            left: -180px;
        }
        
        #greenSwatches {
            left: -120px;
        }
        
        #blueSwatches {
            left: -60px;
        }
        
        .saturationSwatch {
            width: 50px;
            height: 50px;
            border: 2px solid #3a3a3c;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            position: relative;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-size: 9px;
            font-weight: bold;
            user-select: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            line-height: 1.2;
            text-align: center;
            padding: 2px;
        }
        
        .swatchValue {
            font-size: 11px;
            margin-bottom: 2px;
        }
        
        .swatchName {
            font-size: 8px;
            opacity: 0.9;
            max-width: 46px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        .saturationSwatch:hover {
            transform: scale(1.1);
            border-color: #ffffff;
        }
        
        .saturationSwatch.inactive {
            opacity: 0.3;
            cursor: not-allowed;
        }
        
        .saturationSwatch.inactive:hover {
            transform: none;
            border-color: #3a3a3c;
        }
        
        body.light .saturationSwatch {
            border-color: #d0d0d0;
        }
        
        body.light .saturationSwatch:hover {
            border-color: #000000;
        }
        
        /* New Game Button */
        #newGameButton {
            position: absolute;
            left: 50%;
            transform: translateX(-50%);
            top: calc(100% + 20px);
            padding: 10px 20px;
            border: 1px solid #3a3a3c;
            border-radius: 4px;
            background-color: rgba(255, 255, 255, 0.1);
            color: #ffffff;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            display: none;
            white-space: nowrap;
        }
        
        #newGameButton.show {
            display: block;
        }
        
        body.light #newGameButton {
            border-color: #d0d0d0;
            background-color: rgba(0, 0, 0, 0.05);
            color: #121213;
        }
        
        #newGameButton:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        body.light #newGameButton:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }
        
        /* Target color win animation */
        @keyframes pulseWin {
            0% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(83, 141, 78, 0.7);
            }
            50% {
                transform: scale(1.05);
                box-shadow: 0 0 0 10px rgba(83, 141, 78, 0);
            }
            100% {
                transform: scale(1);
                box-shadow: 0 0 0 0 rgba(83, 141, 78, 0);
            }
        }
        
        #targetColor.win-animation {
            animation: pulseWin 0.6s ease-out 2;
        }
        #congratsMessage {
            font-size: 18px;
            font-weight: normal;
            color: #538d4e;
            text-align: center;
            margin: 10px 0 5px 0;
            opacity: 0;
            transition: opacity 0.5s;
            min-height: 24px;
        }
        
        #congratsMessage.show {
            opacity: 1;
        }
        
        /* Side Panel */
        #sidePanel {
            position: fixed;
            right: 0;
            top: 0;
            height: 100%;
            width: 300px;
            background-color: #1a1a1b;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            z-index: 900;
            overflow-y: auto;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.3);
        }
        
        body.light #sidePanel {
            background-color: #f8f8f8;
            box-shadow: -2px 0 10px rgba(0, 0, 0, 0.1);
        }
        
        #sidePanel.open {
            transform: translateX(0);
        }
        
        .panelHeader {
            padding: 20px;
            border-bottom: 1px solid #3a3a3c;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        body.light .panelHeader {
            border-bottom-color: #e0e0e0;
        }
        
        .panelContent {
            padding: 20px;
        }
        
        .settingSection {
            margin-bottom: 30px;
        }
        
        .settingSection h3 {
            margin-bottom: 15px;
            font-size: 16px;
            opacity: 0.8;
        }
        
        /* Difficulty Radio Buttons */
        .radioGroup {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        .radioGroup label {
            display: flex;
            align-items: center;
            gap: 10px;
            cursor: pointer;
        }
        
        .radioGroup input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        /* Toggle Switch */
        .toggle {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 0;
        }
        
        .toggleSwitch {
            position: relative;
            width: 50px;
            height: 26px;
            background-color: #3a3a3c;
            border-radius: 13px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        
        .toggleSwitch.active {
            background-color: #538d4e;
        }
        
        .toggleSwitch::after {
            content: '';
            position: absolute;
            width: 22px;
            height: 22px;
            background-color: #ffffff;
            border-radius: 50%;
            top: 2px;
            left: 2px;
            transition: transform 0.3s;
        }
        
        .toggleSwitch.active::after {
            transform: translateX(24px);
        }
        
        /* Clear Stats Button */
        #clearStatsBtn {
            margin-left: 10px;
            padding: 4px 8px;
            font-size: 11px;
            background-color: rgba(255, 255, 255, 0.1);
            border: 1px solid #3a3a3c;
            border-radius: 3px;
            color: #ffffff;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        body.light #clearStatsBtn {
            background-color: rgba(0, 0, 0, 0.05);
            border-color: #d0d0d0;
            color: #121213;
        }
        
        #clearStatsBtn:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        body.light #clearStatsBtn:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }
        
        /* Confirmation Popup */
        .confirmPopup {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background-color: #2a2a2b;
            border: 1px solid #3a3a3c;
            border-radius: 8px;
            padding: 20px;
            z-index: 1000;
            display: none;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.5);
        }
        
        body.light .confirmPopup {
            background-color: #ffffff;
            border-color: #d0d0d0;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }
        
        .confirmPopup.show {
            display: block;
        }
        
        .confirmPopup h4 {
            margin-bottom: 10px;
            font-size: 16px;
        }
        
        .confirmPopup p {
            margin-bottom: 20px;
            font-size: 14px;
            opacity: 0.8;
        }
        
        .confirmButtons {
            display: flex;
            gap: 10px;
            justify-content: center;
        }
        
        .confirmButtons button {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .confirmYes {
            background-color: #ff6b6b;
            color: white;
        }
        
        .confirmYes:hover {
            background-color: #ff5252;
        }
        
        .confirmNo {
            background-color: rgba(255, 255, 255, 0.1);
            color: white;
            border: 1px solid #3a3a3c;
        }
        
        body.light .confirmNo {
            background-color: rgba(0, 0, 0, 0.05);
            color: #121213;
            border-color: #d0d0d0;
        }
        
        .confirmNo:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        body.light .confirmNo:hover {
            background-color: rgba(0, 0, 0, 0.1);
        }
        .statsGrid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 15px;
        }
        
        .statItem {
            text-align: center;
            padding: 10px;
            background-color: rgba(255, 255, 255, 0.05);
            border-radius: 4px;
        }
        
        body.light .statItem {
            background-color: rgba(0, 0, 0, 0.05);
        }
        
        .statNumber {
            font-size: 24px;
            font-weight: bold;
        }
        
        /* Lore Section */
        .loreSection {
            margin-top: 30px;
            border-top: 1px solid #3a3a3c;
            padding-top: 20px;
        }
        
        body.light .loreSection {
            border-top-color: #e0e0e0;
        }
        
        #loreButton {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;
            padding: 10px 0;
            background: none;
            border: none;
            color: inherit;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            text-align: left;
        }
        
        #loreButton:hover {
            opacity: 0.8;
        }
        
        .loreArrow {
            transition: transform 0.3s;
            font-size: 12px;
        }
        
        .loreArrow.open {
            transform: rotate(180deg);
        }
        
        #loreContent {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.3s ease-out;
        }
        
        #loreContent.open {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .loreText {
            padding: 15px 0;
            line-height: 1.6;
            font-size: 14px;
            opacity: 0.9;
        }
        
        .loreText h4 {
            margin-top: 15px;
            margin-bottom: 8px;
            font-size: 15px;
            opacity: 1;
        }
        
        .loreText h4:first-child {
            margin-top: 0;
        }
        
        .loreText p {
            margin-bottom: 10px;
        }
    </style>
</head>
<body>

<div id="header">
    <h1>COLOUR ME</h1>
    <div id="guessCounter">1/6</div>

<div class="confirmPopup" id="confirmPopup">
    <h4>Clear Statistics?</h4>
    <p>This will permanently clear all statistics for <span id="confirmLevel"></span> difficulty.</p>
    <div class="confirmButtons">
        <button class="confirmYes" id="confirmYes">Clear</button>
        <button class="confirmNo" id="confirmNo">Cancel</button>
    </div>
</div>

</body>
    <button class="icon-button" id="settingsButton">⚙️</button>
</div>

<div id="gameContainer">
    <div id="colorDisplay">
        <div class="colorSwatch" id="targetColor">
            <span class="colorName" id="targetColorName"></span>
            <span class="swatchLabel">Target</span>
        </div>
        <div class="colorSwatch empty" id="guessColor">
            <span class="colorName" id="guessColorName"></span>
            <span class="swatchLabel">Your Mix</span>
        </div>
    </div>
    
    <div id="congratsMessage"></div>
    
    <div id="gameBoardContainer">
        <div id="gameBoard">
            <div class="swatchPanel" id="redSwatches"></div>
            <div class="swatchPanel" id="greenSwatches"></div>
            <div class="swatchPanel" id="blueSwatches"></div>
            
            <div id="guessArea">
                <!-- 6 rows will be generated -->
                <button id="newGameButton">New Game</button>
            </div>
        </div>
    </div>
</div>

<div id="sidePanel">
    <div class="panelHeader">
        <h2>Settings</h2>
        <button class="icon-button" id="closePanel">✕</button>
    </div>
    <div class="panelContent">
        <div class="settingSection">
            <h3>Level</h3>
            <div class="radioGroup">
                <label>
                    <input type="radio" name="difficulty" value="easy">
                    Easy (4 saturations)
                </label>
                <label>
                    <input type="radio" name="difficulty" value="medium" checked>
                    Medium (6 saturations)
                </label>
                <label>
                    <input type="radio" name="difficulty" value="hard">
                    Hard (8 saturations)
                </label>
            </div>
        </div>
        
        <div class="loreSection">
            <button id="loreButton">
                <span>Lore</span>
                <span class="loreArrow" id="loreArrow">▼</span>
            </button>
            <div id="loreContent">
                <div class="loreText">
                    <h4>About</h4>
                    <p>Match the target color by mixing red, green, and blue light.</p>
                    
                    <h4>How to Play</h4>
                    <p>Pick R, G, B values from the left. Correct channels lock. Six tries.</p>
                    
                    <h4>RGB Mixing</h4>
                    <p>Start with black. Add light:<br>
                    <span style="display: inline-block; width: 12px; height: 12px; background: red; vertical-align: middle;"></span> + <span style="display: inline-block; width: 12px; height: 12px; background: lime; vertical-align: middle;"></span> = <span style="display: inline-block; width: 12px; height: 12px; background: yellow; vertical-align: middle;"></span><br>
                    <span style="display: inline-block; width: 12px; height: 12px; background: red; vertical-align: middle;"></span> + <span style="display: inline-block; width: 12px; height: 12px; background: blue; vertical-align: middle;"></span> = <span style="display: inline-block; width: 12px; height: 12px; background: magenta; vertical-align: middle;"></span><br>
                    <span style="display: inline-block; width: 12px; height: 12px; background: lime; vertical-align: middle;"></span> + <span style="display: inline-block; width: 12px; height: 12px; background: blue; vertical-align: middle;"></span> = <span style="display: inline-block; width: 12px; height: 12px; background: cyan; vertical-align: middle;"></span><br>
                    <span style="display: inline-block; width: 12px; height: 12px; background: red; vertical-align: middle;"></span> + <span style="display: inline-block; width: 12px; height: 12px; background: lime; vertical-align: middle;"></span> + <span style="display: inline-block; width: 12px; height: 12px; background: blue; vertical-align: middle;"></span> = <span style="display: inline-block; width: 12px; height: 12px; background: white; vertical-align: middle;"></span></p>
                    <p>0 = no light. 255 = full brightness.</p>
                </div>
            </div>
        </div>
        
        <div class="settingSection">
            <h3>Theme</h3>
            <div class="toggle">
                <span>Dark Mode</span>
                <div class="toggleSwitch active" id="themeToggle"></div>
            </div>
        </div>
        
        <div class="settingSection">
            <h3>Statistics - <span id="statsLevel">Medium</span><button id="clearStatsBtn">Clear</button></h3>
            <div class="statsGrid">
                <div class="statItem">
                    <div class="statNumber" id="gamesPlayed">0</div>
                    <div class="statLabel">Played</div>
                </div>
                <div class="statItem">
                    <div class="statNumber" id="winRate">0%</div>
                    <div class="statLabel">Win Rate</div>
                </div>
                <div class="statItem">
                    <div class="statNumber" id="avgGuesses">-</div>
                    <div class="statLabel">Avg Guesses</div>
                </div>
                <div class="statItem">
                    <div class="statNumber" id="failures">0</div>
                    <div class="statLabel">Failed</div>
                </div>
                <div class="statItem">
                    <div class="statNumber" id="currentStreak">0</div>
                    <div class="statLabel">Streak</div>
                </div>
                <div class="statItem">
                    <div class="statNumber" id="bestStreak">0</div>
                    <div class="statLabel">Best</div>
                </div>
            </div>
            <div style="margin-top: 15px; font-size: 12px; opacity: 0.7;">
                <div>Guess Distribution:</div>
                <div id="guessDistribution" style="margin-top: 5px;"></div>
            </div>
        </div>
    </div>
</div>

<script>
    // Color names for Easy mode (4 levels)
    const colorNamesEasy = {
        '0,0,0': 'Black',
        '0,0,85': 'Navy',
        '0,0,170': 'Medium Blue',
        '0,0,255': 'Blue',
        '0,85,0': 'Dark Green',
        '0,85,85': 'Teal',
        '0,85,170': 'Ocean Blue',
        '0,85,255': 'Deep Sky Blue',
        '0,170,0': 'Lime',
        '0,170,85': 'Spring Green',
        '0,170,170': 'Dark Turquoise',
        '0,170,255': 'Deep Turquoise',
        '0,255,0': 'Green',
        '0,255,85': 'Bright Spring Green',
        '0,255,170': 'Medium Spring Green',
        '0,255,255': 'Cyan',
        '85,0,0': 'Maroon',
        '85,0,85': 'Dark Magenta',
        '85,0,170': 'Dark Violet',
        '85,0,255': 'Electric Violet',
        '85,85,0': 'Olive',
        '85,85,85': 'Gray',
        '85,85,170': 'Slate Blue',
        '85,85,255': 'Light Slate Blue',
        '85,170,0': 'Olive Drab',
        '85,170,85': 'Dark Sea Green',
        '85,170,170': 'Cadet Blue',
        '85,170,255': 'Cornflower Blue',
        '85,255,0': 'Chartreuse',
        '85,255,85': 'Light Green',
        '85,255,170': 'Pale Green',
        '85,255,255': 'Light Cyan',
        '170,0,0': 'Crimson',
        '170,0,85': 'Medium Violet Red',
        '170,0,170': 'Medium Purple',
        '170,0,255': 'Blue Violet',
        '170,85,0': 'Dark Goldenrod',
        '170,85,85': 'Terra Rose',
        '170,85,170': 'Orchid',
        '170,85,255': 'Medium Orchid',
        '170,170,0': 'Dark Khaki',
        '170,170,85': 'Tan',
        '170,170,170': 'Silver',
        '170,170,255': 'Light Steel Blue',
        '170,255,0': 'Green Yellow',
        '170,255,85': 'Pale Goldenrod',
        '170,255,170': 'Pale Green',
        '170,255,255': 'Pale Turquoise',
        '255,0,0': 'Red',
        '255,0,85': 'Deep Pink',
        '255,0,170': 'Hot Pink',
        '255,0,255': 'Magenta',
        '255,85,0': 'Dark Orange',
        '255,85,85': 'Light Coral',
        '255,85,170': 'Pale Violet Red',
        '255,85,255': 'Violet',
        '255,170,0': 'Orange',
        '255,170,85': 'Sandy Brown',
        '255,170,170': 'Light Pink',
        '255,170,255': 'Plum',
        '255,255,0': 'Yellow',
        '255,255,85': 'Khaki',
        '255,255,170': 'Pale Goldenrod',
        '255,255,255': 'White'
    };
    
    // Color names for Medium mode (6 levels) - abbreviated for space
    const colorNamesMedium = {
        '0,0,0': 'Black',
        '0,0,51': 'Midnight Blue',
        '0,0,102': 'Dark Blue',
        '0,0,153': 'Medium Blue',
        '0,0,204': 'Dodger Blue',
        '0,0,255': 'Blue',
        '0,51,0': 'Very Dark Green',
        '0,51,51': 'Dark Teal',
        '0,51,102': 'Deep Ocean',
        '0,51,153': 'Sea Blue',
        '0,51,204': 'Ocean Blue',
        '0,51,255': 'Bright Ocean',
        '0,102,0': 'Dark Green',
        '0,102,51': 'Forest Shade',
        '0,102,102': 'Teal',
        '0,102,153': 'Jade Blue',
        '0,102,204': 'Turquoise Blue',
        '0,102,255': 'Bright Turquoise',
        '0,153,0': 'Forest Green',
        '0,153,51': 'Emerald Shade',
        '0,153,102': 'Sea Green',
        '0,153,153': 'Medium Teal',
        '0,153,204': 'Light Teal',
        '0,153,255': 'Aqua Blue',
        '0,204,0': 'Medium Green',
        '0,204,51': 'Spring Meadow',
        '0,204,102': 'Mint Green',
        '0,204,153': 'Seafoam',
        '0,204,204': 'Light Turquoise',
        '0,204,255': 'Bright Cyan',
        '0,255,0': 'Lime',
        '0,255,51': 'Bright Lime',
        '0,255,102': 'Spring Green',
        '0,255,153': 'Light Spring',
        '0,255,204': 'Pale Cyan',
        '0,255,255': 'Cyan',
        '51,0,0': 'Very Dark Red',
        '51,0,51': 'Dark Plum',
        '51,0,102': 'Deep Purple',
        '51,0,153': 'Royal Purple',
        '51,0,204': 'Bright Purple',
        '51,0,255': 'Electric Purple',
        '51,51,0': 'Dark Olive',
        '51,51,51': 'Dark Charcoal',
        '51,51,102': 'Dark Slate',
        '51,51,153': 'Storm Blue',
        '51,51,204': 'Periwinkle',
        '51,51,255': 'Bright Periwinkle',
        '51,102,0': 'Olive Green',
        '51,102,51': 'Army Green',
        '51,102,102': 'Slate Gray',
        '51,102,153': 'Steel Blue',
        '51,102,204': 'Sky Blue',
        '51,102,255': 'Bright Sky',
        '51,153,0': 'Moss Green',
        '51,153,51': 'Sage Green',
        '51,153,102': 'Dusty Teal',
        '51,153,153': 'Cadet Blue',
        '51,153,204': 'Powder Blue',
        '51,153,255': 'Light Sky Blue',
        '51,204,0': 'Yellow Green',
        '51,204,51': 'Pale Lime',
        '51,204,102': 'Pistachio',
        '51,204,153': 'Mint',
        '51,204,204': 'Pale Turquoise',
        '51,204,255': 'Pale Cyan Blue',
        '51,255,0': 'Chartreuse',
        '51,255,51': 'Light Chartreuse',
        '51,255,102': 'Lime Green',
        '51,255,153': 'Pale Green',
        '51,255,204': 'Aquamarine',
        '51,255,255': 'Light Cyan',
        '102,0,0': 'Dark Red',
        '102,0,51': 'Wine',
        '102,0,102': 'Maroon',
        '102,0,153': 'Dark Magenta',
        '102,0,204': 'Medium Magenta',
        '102,0,255': 'Bright Magenta',
        '102,51,0': 'Burnt Sienna',
        '102,51,51': 'Russet',
        '102,51,102': 'Dusty Purple',
        '102,51,153': 'Muted Purple',
        '102,51,204': 'Lavender Blue',
        '102,51,255': 'Bright Lavender',
        '102,102,0': 'Dark Khaki',
        '102,102,51': 'Bronze',
        '102,102,102': 'Dim Gray',
        '102,102,153': 'Cool Gray',
        '102,102,204': 'Light Slate',
        '102,102,255': 'Cornflower Blue',
        '102,153,0': 'Olive Drab',
        '102,153,51': 'Moss',
        '102,153,102': 'Sage',
        '102,153,153': 'Dusty Teal',
        '102,153,204': 'Soft Blue',
        '102,153,255': 'Sky Blue',
        '102,204,0': 'Lime Yellow',
        '102,204,51': 'Spring Yellow',
        '102,204,102': 'Khaki Green',
        '102,204,153': 'Pale Sage',
        '102,204,204': 'Pale Blue',
        '102,204,255': 'Baby Blue',
        '102,255,0': 'Lawn Green',
        '102,255,51': 'Bright Yellow Green',
        '102,255,102': 'Light Lime',
        '102,255,153': 'Mint Green',
        '102,255,204': 'Pale Aqua',
        '102,255,255': 'Electric Cyan',
        '153,0,0': 'Medium Red',
        '153,0,51': 'Crimson',
        '153,0,102': 'Ruby',
        '153,0,153': 'Medium Purple',
        '153,0,204': 'Orchid',
        '153,0,255': 'Violet',
        '153,51,0': 'Rust',
        '153,51,51': 'Brick Red',
        '153,51,102': 'Mauve',
        '153,51,153': 'Dusty Rose',
        '153,51,204': 'Lilac',
        '153,51,255': 'Light Violet',
        '153,102,0': 'Copper',
        '153,102,51': 'Clay',
        '153,102,102': 'Rosy Brown',
        '153,102,153': 'Dusty Lavender',
        '153,102,204': 'Wisteria',
        '153,102,255': 'Medium Slate Blue',
        '153,153,0': 'Dark Yellow',
        '153,153,51': 'Brass',
        '153,153,102': 'Tan',
        '153,153,153': 'Medium Gray',
        '153,153,204': 'Blue Gray',
        '153,153,255': 'Light Blue',
        '153,204,0': 'Yellow Lime',
        '153,204,51': 'Citrus',
        '153,204,102': 'Sand',
        '153,204,153': 'Ash Gray',
        '153,204,204': 'Silver Blue',
        '153,204,255': 'Pale Blue',
        '153,255,0': 'Green Yellow',
        '153,255,51': 'Lemon Lime',
        '153,255,102': 'Pale Yellow Green',
        '153,255,153': 'Celadon',
        '153,255,204': 'Mint Blue',
        '153,255,255': 'Pale Turquoise',
        '204,0,0': 'Light Red',
        '204,0,51': 'Cherry',
        '204,0,102': 'Rose Red',
        '204,0,153': 'Hot Pink',
        '204,0,204': 'Pink',
        '204,0,255': 'Fuchsia',
        '204,51,0': 'Vermillion',
        '204,51,51': 'Tomato',
        '204,51,102': 'Salmon',
        '204,51,153': 'Rose',
        '204,51,204': 'Pink Lavender',
        '204,51,255': 'Pink Purple',
        '204,102,0': 'Burnt Orange',
        '204,102,51': 'Terra Cotta',
        '204,102,102': 'Dusty Rose',
        '204,102,153': 'Antique Rose',
        '204,102,204': 'Mauve Pink',
        '204,102,255': 'Light Purple',
        '204,153,0': 'Goldenrod',
        '204,153,51': 'Gold',
        '204,153,102': 'Buff',
        '204,153,153': 'Warm Gray',
        '204,153,204': 'Lavender Gray',
        '204,153,255': 'Periwinkle Blue',
        '204,204,0': 'Light Yellow',
        '204,204,51': 'Pale Gold',
        '204,204,102': 'Champagne',
        '204,204,153': 'Beige',
        '204,204,204': 'Light Gray',
        '204,204,255': 'Lavender',
        '204,255,0': 'Electric Lime',
        '204,255,51': 'Lemon',
        '204,255,102': 'Pale Lemon',
        '204,255,153': 'Cream',
        '204,255,204': 'Pearl',
        '204,255,255': 'Pale Cyan',
        '255,0,0': 'Red',
        '255,0,51': 'Scarlet',
        '255,0,102': 'Rose',
        '255,0,153': 'Deep Pink',
        '255,0,204': 'Hot Pink',
        '255,0,255': 'Magenta',
        '255,51,0': 'Red Orange',
        '255,51,51': 'Coral',
        '255,51,102': 'Light Coral',
        '255,51,153': 'Salmon Pink',
        '255,51,204': 'Bubblegum',
        '255,51,255': 'Shocking Pink',
        '255,102,0': 'Dark Orange',
        '255,102,51': 'Orange',
        '255,102,102': 'Light Salmon',
        '255,102,153': 'Peach',
        '255,102,204': 'Light Pink',
        '255,102,255': 'Orchid Pink',
        '255,153,0': 'Orange Yellow',
        '255,153,51': 'Apricot',
        '255,153,102': 'Peach Orange',
        '255,153,153': 'Peach Bisque',
        '255,153,204': 'Pink Beige',
        '255,153,255': 'Plum',
        '255,204,0': 'Gold Yellow',
        '255,204,51': 'Dandelion',
        '255,204,102': 'Butter',
        '255,204,153': 'Vanilla',
        '255,204,204': 'Misty Rose',
        '255,204,255': 'Thistle',
        '255,255,0': 'Yellow',
        '255,255,51': 'Lemon Yellow',
        '255,255,102': 'Cream Yellow',
        '255,255,153': 'Ivory',
        '255,255,204': 'Light Ivory',
        '255,255,255': 'White'
    };
    
    // Get color name based on RGB values and difficulty
    function getColorName(r, g, b) {
        const key = `${r},${g},${b}`;
        if (difficulty === 'easy') {
            return colorNamesEasy[key] || 'Unknown';
        } else if (difficulty === 'medium') {
            return colorNamesMedium[key] || 'Unknown';
        }
        return 'Unknown'; // For hard mode, no names yet
    }
    
    // Title variations
    const titleVariations = [
        'Colour Me',
        'Color Me',
        'Cordle',
        'Colourdle',
        'Colour Wordle',
        'Chromle',
        'Huedle',
        'RGBle',
        'Tintl',
        'Shadedle',
        'Spectrle',
        'Rainbowdle',
        'Mixle',
        'Prisml',
        'Saturdle'
    ];
    
    // Game state
    let targetRGB = { r: 0, g: 0, b: 0 };
    let currentRow = 0;
    let gameOver = false;
    let difficulty = 'medium';
    let levelCounts = { easy: 4, medium: 6, hard: 8 };
    let currentGuess = { r: null, g: null, b: null };
    let lockedChannels = { r: false, g: false, b: false };
    
    // Stats - organized by difficulty
    let stats = {
        easy: {
            gamesPlayed: 0,
            gamesWon: 0,
            gamesFailed: 0,
            currentStreak: 0,
            bestStreak: 0,
            totalGuesses: 0,
            guessDistribution: [0, 0, 0, 0, 0, 0] // wins on guess 1-6
        },
        medium: {
            gamesPlayed: 0,
            gamesWon: 0,
            gamesFailed: 0,
            currentStreak: 0,
            bestStreak: 0,
            totalGuesses: 0,
            guessDistribution: [0, 0, 0, 0, 0, 0]
        },
        hard: {
            gamesPlayed: 0,
            gamesWon: 0,
            gamesFailed: 0,
            currentStreak: 0,
            bestStreak: 0,
            totalGuesses: 0,
            guessDistribution: [0, 0, 0, 0, 0, 0]
        }
    };
    
    // Elements
    const targetColorDiv = document.getElementById('targetColor');
    const guessColorDiv = document.getElementById('guessColor');
    const guessArea = document.getElementById('guessArea');
    const congratsMessage = document.getElementById('congratsMessage');
    const sidePanel = document.getElementById('sidePanel');
    const settingsButton = document.getElementById('settingsButton');
    const closePanel = document.getElementById('closePanel');
    const themeToggle = document.getElementById('themeToggle');
    const newGameButton = document.getElementById('newGameButton');
    const clearStatsBtn = document.getElementById('clearStatsBtn');
    const confirmPopup = document.getElementById('confirmPopup');
    const confirmYes = document.getElementById('confirmYes');
    const confirmNo = document.getElementById('confirmNo');
    const confirmLevel = document.getElementById('confirmLevel');
    const loreButton = document.getElementById('loreButton');
    const loreContent = document.getElementById('loreContent');
    const loreArrow = document.getElementById('loreArrow');
    const titleElement = document.querySelector('h1');
    
    // Initialize
    function init() {
        loadSettings();
        loadStats();
        createGuessRows();
        setupEventListeners();
        newGame();
    }
    
    function loadSettings() {
        const savedDifficulty = localStorage.getItem('colourMeDifficulty');
        if (savedDifficulty) {
            difficulty = savedDifficulty;
            document.querySelector(`input[value="${difficulty}"]`).checked = true;
        }
        
        const savedTheme = localStorage.getItem('colourMeTheme');
        if (savedTheme === 'light') {
            document.body.classList.add('light');
            themeToggle.classList.remove('active');
        }
    }
    
    function loadStats() {
        const saved = localStorage.getItem('colourMeStats');
        if (saved) {
            const loadedStats = JSON.parse(saved);
            // Check if it's the old format (flat structure) or new format (per-difficulty)
            if (loadedStats.easy || loadedStats.medium || loadedStats.hard) {
                stats = loadedStats;
            } else {
                // Convert old format to new format
                stats = {
                    easy: {
                        gamesPlayed: 0,
                        gamesWon: 0,
                        gamesFailed: 0,
                        currentStreak: 0,
                        bestStreak: 0,
                        totalGuesses: 0,
                        guessDistribution: [0, 0, 0, 0, 0, 0]
                    },
                    medium: {
                        gamesPlayed: loadedStats.gamesPlayed || 0,
                        gamesWon: loadedStats.gamesWon || 0,
                        gamesFailed: 0,
                        currentStreak: loadedStats.currentStreak || 0,
                        bestStreak: loadedStats.bestStreak || 0,
                        totalGuesses: 0,
                        guessDistribution: [0, 0, 0, 0, 0, 0]
                    },
                    hard: {
                        gamesPlayed: 0,
                        gamesWon: 0,
                        gamesFailed: 0,
                        currentStreak: 0,
                        bestStreak: 0,
                        totalGuesses: 0,
                        guessDistribution: [0, 0, 0, 0, 0, 0]
                    }
                };
                // Save the converted stats
                saveStats();
            }
        }
        updateStatsDisplay();
    }
    
    function saveStats() {
        localStorage.setItem('colourMeStats', JSON.stringify(stats));
        updateStatsDisplay();
    }
    
    function updateStatsDisplay() {
        const currentStats = stats[difficulty];
        
        // Update difficulty label
        document.getElementById('statsLevel').textContent = 
            difficulty.charAt(0).toUpperCase() + difficulty.slice(1);
        
        // Update basic stats
        document.getElementById('gamesPlayed').textContent = currentStats.gamesPlayed;
        
        // Calculate and display win rate
        const winRate = currentStats.gamesPlayed > 0 
            ? Math.round((currentStats.gamesWon / currentStats.gamesPlayed) * 100)
            : 0;
        document.getElementById('winRate').textContent = winRate + '%';
        
        // Calculate average guesses (only for wins)
        const avgGuesses = currentStats.gamesWon > 0
            ? (currentStats.totalGuesses / currentStats.gamesWon).toFixed(1)
            : '-';
        document.getElementById('avgGuesses').textContent = avgGuesses;
        
        // Failed games
        document.getElementById('failures').textContent = currentStats.gamesFailed;
        
        // Streaks
        document.getElementById('currentStreak').textContent = currentStats.currentStreak;
        document.getElementById('bestStreak').textContent = currentStats.bestStreak;
        
        // Guess distribution
        const distDiv = document.getElementById('guessDistribution');
        distDiv.innerHTML = '';
        currentStats.guessDistribution.forEach((count, index) => {
            if (count > 0) {
                const bar = document.createElement('div');
                bar.style.marginBottom = '2px';
                bar.innerHTML = `${index + 1}: ${'■'.repeat(Math.min(count, 20))} ${count}`;
                distDiv.appendChild(bar);
            }
        });
    }
    
    function createGuessRows() {
        for (let i = 0; i < 6; i++) {
            const row = document.createElement('div');
            row.className = 'guessRow';
            row.id = `row-${i}`;
            
            // Add color background div
            const colorBg = document.createElement('div');
            colorBg.className = 'colorBackground';
            row.appendChild(colorBg);
            
            // Create tiles for R, G, B
            ['r', 'g', 'b'].forEach(channel => {
                const tile = document.createElement('div');
                tile.className = 'tile';
                tile.id = `tile-${i}-${channel}`;
                tile.dataset.row = i;
                tile.dataset.channel = channel;
                
                // Add checkmark
                const checkmark = document.createElement('span');
                checkmark.className = 'checkmark';
                checkmark.textContent = '✓';
                tile.appendChild(checkmark);
                
                row.appendChild(tile);
            });
            
            guessArea.appendChild(row);
        }
    }
    
    function generateTargetColor() {
        const levels = levelCounts[difficulty];
        const step = 255 / (levels - 1);
        
        targetRGB = {
            r: Math.round(Math.floor(Math.random() * levels) * step),
            g: Math.round(Math.floor(Math.random() * levels) * step),
            b: Math.round(Math.floor(Math.random() * levels) * step)
        };
        
        targetColorDiv.style.backgroundColor = `rgb(${targetRGB.r}, ${targetRGB.g}, ${targetRGB.b})`;
        
        // Update target color name
        if (difficulty === 'easy' || difficulty === 'medium') {
            const colorName = getColorName(targetRGB.r, targetRGB.g, targetRGB.b);
            document.getElementById('targetColorName').textContent = colorName;
        } else {
            document.getElementById('targetColorName').textContent = '';
        }
    }
    
    function createSwatches() {
        const levels = levelCounts[difficulty];
        const step = 255 / (levels - 1);
        
        // Clear existing swatches
        document.getElementById('redSwatches').innerHTML = '';
        document.getElementById('greenSwatches').innerHTML = '';
        document.getElementById('blueSwatches').innerHTML = '';
        
        // Create swatches for each color
        for (let i = 0; i < levels; i++) {
            const value = Math.round(i * step);
            
            // Red swatch
            const redSwatch = createSwatch('r', value);
            document.getElementById('redSwatches').appendChild(redSwatch);
            
            // Green swatch
            const greenSwatch = createSwatch('g', value);
            document.getElementById('greenSwatches').appendChild(greenSwatch);
            
            // Blue swatch
            const blueSwatch = createSwatch('b', value);
            document.getElementById('blueSwatches').appendChild(blueSwatch);
        }
    }
    
    function createSwatch(channel, value) {
        const swatch = document.createElement('div');
        swatch.className = 'saturationSwatch';
        swatch.dataset.channel = channel;
        swatch.dataset.value = value;
        swatch.id = `swatch-${channel}-${value}`;
        
        // Set color
        const color = { r: 0, g: 0, b: 0 };
        color[channel] = value;
        swatch.style.backgroundColor = `rgb(${color.r}, ${color.g}, ${color.b})`;
        
        // Get individual color name for this swatch
        let colorName = '';
        if (difficulty === 'easy' || difficulty === 'medium') {
            const colorKey = `${color.r},${color.g},${color.b}`;
            const names = difficulty === 'easy' ? colorNamesEasy : colorNamesMedium;
            colorName = names[colorKey] || '';
        }
        
        // Create inner HTML with value and name
        let innerHTML = `<div class="swatchValue">${channel.toUpperCase()}${value}</div>`;
        if (colorName && colorName !== 'Black') { // Don't show "Black" for 0 values
            innerHTML += `<div class="swatchName">${colorName}</div>`;
        }
        
        swatch.innerHTML = innerHTML;
        
        // Set text color based on contrast
        if (channel === 'b') {
            swatch.style.color = '#fff';
        } else {
            swatch.style.color = value > 128 ? '#000' : '#fff';
        }
        
        // Click event
        swatch.addEventListener('click', () => handleSwatchClick(channel, value));
        
        return swatch;
    }
    
    function handleSwatchClick(channel, value) {
        if (gameOver || lockedChannels[channel]) return;
        
        // Update current guess
        currentGuess[channel] = value;
        
        // Update tile
        const tile = document.getElementById(`tile-${currentRow}-${channel}`);
        const color = { r: 0, g: 0, b: 0 };
        color[channel] = value;
        tile.style.backgroundColor = `rgb(${color.r}, ${color.g}, ${color.b})`;
        
        // Get individual color name
        let colorName = '';
        if (difficulty === 'easy' || difficulty === 'medium') {
            const colorKey = `${color.r},${color.g},${color.b}`;
            const names = difficulty === 'easy' ? colorNamesEasy : colorNamesMedium;
            colorName = names[colorKey] || '';
        }
        
        // Create text span for better control
        const existingSpan = tile.querySelector('.value-text');
        if (existingSpan) {
            existingSpan.remove();
        }
        const textSpan = document.createElement('span');
        textSpan.className = 'value-text';
        textSpan.innerHTML = `${channel.toUpperCase()}${value}`;
        if (colorName && colorName !== 'Black') {
            textSpan.innerHTML += `<br><span style="font-size: 9px; opacity: 0.9;">${colorName}</span>`;
        }
        
        // Set text color - blue tiles always get white text
        if (channel === 'b') {
            textSpan.style.color = '#fff';
        } else {
            textSpan.style.color = value > 128 ? '#000' : '#fff';
        }
        
        textSpan.style.position = 'relative';
        textSpan.style.zIndex = '5';
        textSpan.style.textAlign = 'center';
        textSpan.style.lineHeight = '1.2';
        tile.appendChild(textSpan);
        
        tile.classList.add('filled');
        
        // Check if all channels are filled
        if (currentGuess.r !== null && currentGuess.g !== null && currentGuess.b !== null) {
            // Show mixed color name on top of tiles
            showMixedColorName();
            showMixedColor();
        }
    }
    
    function showMixedColorName() {
        if (difficulty === 'easy' || difficulty === 'medium') {
            const colorName = getColorName(currentGuess.r, currentGuess.g, currentGuess.b);
            const row = document.getElementById(`row-${currentRow}`);
            
            // Remove any existing mixed color name
            const existingName = row.querySelector('.mixedColorName');
            if (existingName) {
                existingName.remove();
            }
            
            // Create and add mixed color name
            const nameDiv = document.createElement('div');
            nameDiv.className = 'mixedColorName';
            nameDiv.textContent = colorName;
            
            // Determine background based on luminance
            const luminance = getLuminance(currentGuess);
            if (luminance > 0.5) {
                nameDiv.classList.add('dark-bg');
            } else {
                nameDiv.classList.add('light-bg');
            }
            
            row.appendChild(nameDiv);
        }
    }
    
    function showMixedColor() {
        // Show mixed color in "Your Mix"
        guessColorDiv.style.backgroundColor = 
            `rgb(${currentGuess.r}, ${currentGuess.g}, ${currentGuess.b})`;
        guessColorDiv.classList.remove('empty');
        
        // Update guess color name
        if (difficulty === 'easy' || difficulty === 'medium') {
            const colorName = getColorName(currentGuess.r, currentGuess.g, currentGuess.b);
            document.getElementById('guessColorName').textContent = colorName;
        } else {
            document.getElementById('guessColorName').textContent = '';
        }
        
        // Show color background behind row with name
        const colorBg = document.querySelector(`#row-${currentRow} .colorBackground`);
        colorBg.style.backgroundColor = 
            `rgb(${currentGuess.r}, ${currentGuess.g}, ${currentGuess.b})`;
        colorBg.classList.add('show');
        
        // Add color name to background if not correct
        if (difficulty === 'easy' || difficulty === 'medium') {
            const isCorrect = currentGuess.r === targetRGB.r && 
                            currentGuess.g === targetRGB.g && 
                            currentGuess.b === targetRGB.b;
            if (!isCorrect) {
                const colorName = getColorName(currentGuess.r, currentGuess.g, currentGuess.b);
                colorBg.innerHTML = `<span style="position: absolute; left: 50%; top: 50%; transform: translate(-50%, -50%); color: ${getLuminance(currentGuess) > 0.5 ? '#000' : '#fff'}; font-size: 12px; font-weight: bold; text-shadow: 1px 1px 2px rgba(0,0,0,0.5);">${colorName}</span>`;
            }
        }
        
        // Check each channel for correctness
        ['r', 'g', 'b'].forEach(channel => {
            if (currentGuess[channel] === targetRGB[channel] && !lockedChannels[channel]) {
                lockedChannels[channel] = true;
                markChannelCorrect(channel);
            }
        });
        
        // Check for win
        if (currentGuess.r === targetRGB.r && 
            currentGuess.g === targetRGB.g && 
            currentGuess.b === targetRGB.b) {
            handleWin();
        } else {
            // Auto-advance after delay
            setTimeout(() => {
                advanceToNextRow();
            }, 0); // Immediate advance
            
            // Clear "Your Mix" after 3 seconds
            setTimeout(() => {
                guessColorDiv.style.backgroundColor = '';
                guessColorDiv.classList.add('empty');
                document.getElementById('guessColorName').textContent = '';
            }, 3000);
        }
    }
    
    function getLuminance(rgb) {
        return (0.299 * rgb.r + 0.587 * rgb.g + 0.114 * rgb.b) / 255;
    }
    
    function markChannelCorrect(channel) {
        // Mark all tiles of this channel as correct
        for (let i = currentRow; i < 6; i++) {
            const tile = document.getElementById(`tile-${i}-${channel}`);
            tile.classList.add('correct');
            tile.classList.add('locked');
            
            // Pre-fill future rows with correct value
            if (i > currentRow) {
                const color = { r: 0, g: 0, b: 0 };
                color[channel] = targetRGB[channel];
                tile.style.backgroundColor = `rgb(${color.r}, ${color.g}, ${color.b})`;
                
                // Create text span
                const existingSpan = tile.querySelector('.value-text');
                if (existingSpan) {
                    existingSpan.remove();
                }
                const textSpan = document.createElement('span');
                textSpan.className = 'value-text';
                textSpan.innerHTML = `${channel.toUpperCase()}${targetRGB[channel]}`;
                
                // Get individual color name for locked channel
                if (difficulty === 'easy' || difficulty === 'medium') {
                    const color = { r: 0, g: 0, b: 0 };
                    color[channel] = targetRGB[channel];
                    const colorKey = `${color.r},${color.g},${color.b}`;
                    const names = difficulty === 'easy' ? colorNamesEasy : colorNamesMedium;
                    const colorName = names[colorKey] || '';
                    if (colorName && colorName !== 'Black') {
                        textSpan.innerHTML += `<br><span style="font-size: 9px; opacity: 0.9;">${colorName}</span>`;
                    }
                }
                
                // Set text color - blue tiles always get white text
                if (channel === 'b') {
                    textSpan.style.color = '#fff';
                } else {
                    textSpan.style.color = targetRGB[channel] > 128 ? '#000' : '#fff';
                }
                
                textSpan.style.position = 'relative';
                textSpan.style.zIndex = '5';
                textSpan.style.textAlign = 'center';
                textSpan.style.lineHeight = '1.2';
                tile.appendChild(textSpan);
                
                tile.classList.add('filled');
            }
        }
        
        // Disable swatches for this channel
        document.querySelectorAll(`#${channel}Swatches .saturationSwatch`).forEach(swatch => {
            swatch.classList.add('inactive');
        });
    }
    
    function advanceToNextRow() {
        currentRow++;
        if (currentRow >= 6) {
            handleLoss();
            return;
        }
        
        // Reset current guess for unlocked channels
        ['r', 'g', 'b'].forEach(channel => {
            if (lockedChannels[channel]) {
                currentGuess[channel] = targetRGB[channel];
            } else {
                currentGuess[channel] = null;
            }
        });
        
        // Show next row
        document.getElementById(`row-${currentRow}`).classList.add('active');
        
        // Check if all channels are already locked (auto-win)
        if (lockedChannels.r && lockedChannels.g && lockedChannels.b) {
            showMixedColor();
        }
    }
    
    function handleWin() {
        gameOver = true;
        const currentStats = stats[difficulty];
        
        currentStats.gamesPlayed++;
        currentStats.gamesWon++;
        currentStats.currentStreak++;
        currentStats.totalGuesses += (currentRow + 1);
        currentStats.guessDistribution[currentRow]++;
        
        if (currentStats.currentStreak > currentStats.bestStreak) {
            currentStats.bestStreak = currentStats.currentStreak;
        }
        
        saveStats();
        
        // Show congratulations
        congratsMessage.textContent = `Correct match in ${currentRow + 1} ${currentRow === 0 ? 'try' : 'tries'}`;
        congratsMessage.classList.add('show');
        
        // Animate target color
        targetColorDiv.classList.add('win-animation');
        setTimeout(() => {
            targetColorDiv.classList.remove('win-animation');
        }, 1200);
        
        // Show new game button
        newGameButton.classList.add('show');
    }
    
    function handleLoss() {
        gameOver = true;
        const currentStats = stats[difficulty];
        
        currentStats.gamesPlayed++;
        currentStats.gamesFailed++;
        currentStats.currentStreak = 0;
        
        saveStats();
        
        // Show target values
        congratsMessage.textContent = `Target was RGB(${targetRGB.r}, ${targetRGB.g}, ${targetRGB.b})`;
        congratsMessage.style.color = '#ff6b6b';
        congratsMessage.classList.add('show');
        
        // Show new game button
        newGameButton.classList.add('show');
    }
    
    function newGame() {
        gameOver = false;
        currentRow = 0;
        currentGuess = { r: null, g: null, b: null };
        lockedChannels = { r: false, g: false, b: false };
        
        // Reset display
        guessColorDiv.style.backgroundColor = '';
        guessColorDiv.classList.add('empty');
        congratsMessage.classList.remove('show');
        congratsMessage.style.color = '#538d4e';
        
        // Hide new game button
        newGameButton.classList.remove('show');
        
        // Clear all rows
        document.querySelectorAll('.guessRow').forEach((row, index) => {
            row.classList.remove('active');
            const colorBg = row.querySelector('.colorBackground');
            colorBg.classList.remove('show');
            colorBg.innerHTML = ''; // Clear any color name text
            
            // Remove mixed color name
            const mixedName = row.querySelector('.mixedColorName');
            if (mixedName) {
                mixedName.remove();
            }
            
            row.querySelectorAll('.tile').forEach(tile => {
                tile.style.backgroundColor = '';
                // Remove text spans
                const textSpan = tile.querySelector('.value-text');
                if (textSpan) {
                    textSpan.remove();
                }
                tile.classList.remove('filled', 'correct', 'locked');
            });
        });
        
        // Clear color names
        document.getElementById('targetColorName').textContent = '';
        document.getElementById('guessColorName').textContent = '';
        
        // Reset swatches
        document.querySelectorAll('.saturationSwatch').forEach(swatch => {
            swatch.classList.remove('inactive');
        });
        
        // Show first row
        document.getElementById('row-0').classList.add('active');
        
        // Generate new target
        generateTargetColor();
        createSwatches();
    }
    
    function setupEventListeners() {
        // Settings panel
        settingsButton.addEventListener('click', () => {
            sidePanel.classList.add('open');
        });
        
        closePanel.addEventListener('click', () => {
            sidePanel.classList.remove('open');
        });
        
        // Theme toggle
        themeToggle.addEventListener('click', () => {
            themeToggle.classList.toggle('active');
            document.body.classList.toggle('light');
            localStorage.setItem('colourMeTheme', 
                document.body.classList.contains('light') ? 'light' : 'dark');
        });
        
        // Difficulty
        document.querySelectorAll('input[name="difficulty"]').forEach(radio => {
            radio.addEventListener('change', (e) => {
                difficulty = e.target.value;
                localStorage.setItem('colourMeDifficulty', difficulty);
                updateStatsDisplay(); // Update display for new difficulty
                newGame();
            });
        });
        
        // New Game button
        newGameButton.addEventListener('click', () => {
            newGame();
        });
        
        // Clear Stats button
        clearStatsBtn.addEventListener('click', () => {
            confirmLevel.textContent = difficulty.charAt(0).toUpperCase() + difficulty.slice(1);
            confirmPopup.classList.add('show');
        });
        
        // Confirm Yes button
        confirmYes.addEventListener('click', () => {
            // Clear stats for current difficulty only
            stats[difficulty] = {
                gamesPlayed: 0,
                gamesWon: 0,
                gamesFailed: 0,
                currentStreak: 0,
                bestStreak: 0,
                totalGuesses: 0,
                guessDistribution: [0, 0, 0, 0, 0, 0]
            };
            
            // Save and update display
            saveStats();
            confirmPopup.classList.remove('show');
        });
        
        // Confirm No button
        confirmNo.addEventListener('click', () => {
            confirmPopup.classList.remove('show');
        });
        
        // Lore button
        loreButton.addEventListener('click', () => {
            loreContent.classList.toggle('open');
            loreArrow.classList.toggle('open');
        });
        
        // Title click
        titleElement.addEventListener('click', () => {
            const randomIndex = Math.floor(Math.random() * titleVariations.length);
            titleElement.textContent = titleVariations[randomIndex];
        });
        
        // Target color click - open Google image search
        targetColorDiv.addEventListener('click', () => {
            const colorName = document.getElementById('targetColorName').textContent;
            const rgbString = `RGB(${targetRGB.r},${targetRGB.g},${targetRGB.b})`;
            
            // Create search query
            let searchQuery = rgbString;
            if (colorName && colorName !== '') {
                searchQuery = `${colorName} ${rgbString}`;
            }
            
            // Open Google Images search in new tab
            const searchUrl = `https://www.google.com/search?q=${encodeURIComponent(searchQuery)}&tbm=isch`;
            window.open(searchUrl, '_blank');
        });
    }
    
    // Start the game
    init();
</script>

</body>
</html>