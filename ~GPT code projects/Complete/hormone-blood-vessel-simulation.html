<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bloodstream Hormone Simulation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f0f0f0;
        }
        canvas {
            border: 1px solid #000;
            background-color: #fff;
        }
        .controls {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .slider-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        label {
            margin-right: 10px;
            width: 150px;
        }
    </style>
</head>
<body>
    <h1>Bloodstream Hormone Simulation</h1>
    <canvas id="vesselCanvas" width="800" height="400"></canvas>
    <div class="controls">
        <div class="slider-container">
            <label for="heartRateSlider">Heart Rate (BPM): </label>
            <input type="range" id="heartRateSlider" min="55" max="145" value="60">
            <span id="heartRateValue">60</span>
        </div>
        <div class="slider-container">
            <label for="dilationSlider">Vessel Dilation (%): </label>
            <input type="range" id="dilationSlider" min="50" max="150" value="100">
            <span id="dilationValue">100</span>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('vesselCanvas');
        const ctx = canvas.getContext('2d');
        const heartRateSlider = document.getElementById('heartRateSlider');
        const heartRateValue = document.getElementById('heartRateValue');
        const dilationSlider = document.getElementById('dilationSlider');
        const dilationValue = document.getElementById('dilationValue');

        let heartRate = 60;
        let dilation = 100;
        let targetDilation = 100;
        let bloodCells = [];
        let hormones = [];
        let lastPulseTime = 0;
        let pulseIntensity = 0;
        let lastTimestamp = 0;
        let clickMeOpacity = 1;
        let simulationStartTime = Date.now();

        const baseVesselHeight = 200;
        const glandReceptorPairs = [
            { position: 0.3, color: 'yellow', effect: 'increase', name: 'Epinephrine' },
            { position: 0.4, color: 'blue', effect: 'decrease', name: 'Acetylcholine' },
            { position: 0.6, color: 'green', effect: 'none', name: 'Hormone C' },
            { position: 0.7, color: 'orange', effect: 'none', name: 'Hormone D' }
        ];

        class Particle {
            constructor(x, y, color, radius) {
                this.x = x;
                this.y = y;
                this.color = color;
                this.radius = radius;
                this.baseSpeed = 0.1 + Math.random() * 0.1;
                this.speed = this.baseSpeed;
                this.verticalPosition = (this.y - canvas.height / 2) / (baseVesselHeight / 2);
            }

            update(deltaTime, pulseFactor, vesselHeight, speedMultiplier) {
                this.speed = this.baseSpeed * speedMultiplier * (1 + pulseFactor * 0.5);
                this.x += this.speed * deltaTime;
                if (this.x > canvas.width) {
                    this.x = 0;
                }

                const maxY = canvas.height / 2 + vesselHeight / 2;
                const minY = canvas.height / 2 - vesselHeight / 2;
                this.y = canvas.height / 2 + this.verticalPosition * vesselHeight / 2;
                this.y = Math.max(minY + this.radius, Math.min(maxY - this.radius, this.y));
            }

            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.fill();
            }
        }

        class BloodCell extends Particle {
            constructor() {
                super(
                    Math.random() * canvas.width,
                    canvas.height / 2 + (Math.random() - 0.5) * baseVesselHeight * 0.8,
                    'red',
                    5 + Math.random() * 3
                );
            }
        }

        class Hormone extends Particle {
            constructor(x, color) {
                super(
                    x,
                    canvas.height / 2 + (Math.random() - 0.5) * baseVesselHeight * 0.8,
                    color,
                    6
                );
            }

            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.fill();
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 1;
                ctx.stroke();
            }
        }

        class Receptor {
            constructor(x, color, effect, name) {
                this.x = x;
                this.color = color;
                this.effect = effect;
                this.name = name;
                this.radius = 20;
                this.isFlashing = false;
                this.flashDuration = 500; // ms
                this.flashStartTime = 0;
            }

            draw(vesselHeight) {
                const y = canvas.height / 2 - vesselHeight / 2 - this.radius;
                ctx.beginPath();
                ctx.arc(this.x, y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = this.isFlashing ? 'white' : this.color;
                ctx.fill();
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 2;
                ctx.stroke();

                // Draw label
                ctx.font = '12px Arial';
                ctx.fillStyle = 'black';
                ctx.textAlign = 'center';
                ctx.fillText(this.name, this.x, y - this.radius - 5);
            }

            startFlashing() {
                this.isFlashing = true;
                this.flashStartTime = Date.now();
            }

            updateFlashing() {
                if (this.isFlashing && Date.now() - this.flashStartTime > this.flashDuration) {
                    this.isFlashing = false;
                }
            }

            scan(hormones, vesselHeight) {
                const vesselTop = canvas.height / 2 - vesselHeight / 2;
                const vesselBottom = canvas.height / 2 + vesselHeight / 2;
                
                for (let i = hormones.length - 1; i >= 0; i--) {
                    const hormone = hormones[i];
                    if (hormone.color === this.color && 
                        hormone.y >= vesselTop && 
                        hormone.y <= vesselBottom && 
                        Math.abs(hormone.x - this.x) < this.radius) {
                        this.startFlashing();
                        this.applyEffect();
                        return i; // Return the index of the hormone to be removed
                    }
                }
                return -1; // Return -1 if no hormone is detected
            }

            applyEffect() {
                if (this.effect === 'increase') {
                    heartRate = Math.min(heartRate + 5, 145);
                    targetDilation = Math.min(targetDilation + 5, 150);
                } else if (this.effect === 'decrease') {
                    heartRate = Math.max(heartRate - 5, 55);
                    targetDilation = Math.max(targetDilation - 5, 50);
                }
                updateSliders();
            }
        }

        const receptors = glandReceptorPairs.map(pair => new Receptor(pair.position * canvas.width, pair.color, pair.effect, pair.name));

        function createBloodCells(count) {
            for (let i = 0; i < count; i++) {
                bloodCells.push(new BloodCell());
            }
        }

        function drawVessel(height) {
            ctx.beginPath();
            ctx.moveTo(0, canvas.height / 2 - height / 2);
            ctx.lineTo(canvas.width, canvas.height / 2 - height / 2);
            ctx.moveTo(0, canvas.height / 2 + height / 2);
            ctx.lineTo(canvas.width, canvas.height / 2 + height / 2);
            ctx.strokeStyle = 'purple';
            ctx.lineWidth = 10;
            ctx.stroke();
        }

        function drawGlands(vesselHeight) {
            const glandSize = 20;
            const glandOffset = 25;
            
            glandReceptorPairs.forEach(pair => {
                const x = pair.position * canvas.width + glandOffset;
                const y = canvas.height / 2 + vesselHeight / 2 + glandSize;

                ctx.beginPath();
                ctx.arc(x, y, glandSize, 0, Math.PI * 2);
                ctx.fillStyle = pair.color;
                ctx.fill();
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 2;
                ctx.stroke();

                // Draw label
                ctx.font = '12px Arial';
                ctx.fillStyle = 'black';
                ctx.textAlign = 'center';
                ctx.fillText(pair.name, x, y + glandSize + 15);
            });
        }

        function drawClickMeText(vesselHeight) {
            const elapsedTime = Date.now() - simulationStartTime;
            if (elapsedTime < 10000) {
                const flashingIntensity = Math.sin(elapsedTime / 200) * 0.5 + 0.5;
                clickMeOpacity = 1 - elapsedTime / 10000;
                
                ctx.save();
                ctx.font = 'bold 20px Arial';
                ctx.fillStyle = `rgba(255, 0, 0, ${clickMeOpacity * flashingIntensity})`;
                ctx.textAlign = 'center';
                ctx.fillText('Click me!', canvas.width / 2, canvas.height / 2 + vesselHeight / 2 + 80);
                ctx.restore();
            }
        }

        function getSpeedMultiplier(heartRate) {
            const minRate = 55;
            const maxRate = 145;
            const minMultiplier = 0.5;
            const maxMultiplier = 2.5;
            return minMultiplier + (maxMultiplier - minMultiplier) * (heartRate - minRate) / (maxRate - minRate);
        }

        function updateSliders() {
            heartRateSlider.value = heartRate;
            heartRateValue.textContent = heartRate;
            dilationSlider.value = dilation;
            dilationValue.textContent = Math.round(dilation);
        }

        function animateDilation(deltaTime) {
            const dilationDiff = targetDilation - dilation;
            if (Math.abs(dilationDiff) > 0.1) {
                dilation += dilationDiff * 0.1;
            } else {
                dilation = targetDilation;
            }
            updateSliders();
        }

        function update(timestamp) {
            const deltaTime = timestamp - lastTimestamp;
            lastTimestamp = timestamp;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            animateDilation(deltaTime);

            const vesselHeight = baseVesselHeight * dilation / 100;
            drawVessel(vesselHeight);
            drawGlands(vesselHeight);
            drawClickMeText(vesselHeight);

            const pulsePeriod = 60000 / heartRate;
            const pulseProgress = (timestamp % pulsePeriod) / pulsePeriod;
            
            pulseIntensity = Math.sin(pulseProgress * Math.PI) ** 2;

            const speedMultiplier = getSpeedMultiplier(heartRate);

            bloodCells.forEach(cell => {
                cell.update(deltaTime, pulseIntensity, vesselHeight, speedMultiplier);
                cell.draw();
            });

            hormones.forEach(hormone => {
                hormone.update(deltaTime, pulseIntensity, vesselHeight, speedMultiplier);
                hormone.draw();
            });

            receptors.forEach(receptor => {
                const detectedHormoneIndex = receptor.scan(hormones, vesselHeight);
                if (detectedHormoneIndex !== -1) {
                    hormones.splice(detectedHormoneIndex, 1);
                }
                receptor.updateFlashing();
                receptor.draw(vesselHeight);
            });

            requestAnimationFrame(update);
        }

        function isClickOnGland(x, y, glandX, glandY, glandSize) {
            return Math.sqrt((x - glandX) ** 2 + (y - glandY) ** 2) <= glandSize;
        }

        canvas.addEventListener('click', (event) => {
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            const vesselHeight = baseVesselHeight * dilation / 100;
            const glandSize = 20;
            const glandOffset = 25;

            glandReceptorPairs.forEach(pair => {
                const glandX = pair.position * canvas.width + glandOffset;
                const glandY = canvas.height / 2 + vesselHeight / 2 + glandSize;

                if (isClickOnGland(x, y, glandX, glandY, glandSize)) {
                    hormones.push(new Hormone(glandX, pair.color));
                }
            });
        });

        heartRateSlider.addEventListener('input', (e) => {
            heartRate = parseInt(e.target.value);
            heartRateValue.textContent = heartRate;
        });

        dilationSlider.addEventListener('input', (e) => {
            targetDilation = parseInt(e.target.value);
            dilationValue.textContent = Math.round(dilation);
        });

        createBloodCells(50);
        requestAnimationFrame(update);
    </script>
</body>
</html>
