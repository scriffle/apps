<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Torus Electron Simulation with Adjustable Geometry</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.js"></script>
    <style>
        body { margin: 0; padding: 20px; font-family: Arial, sans-serif; }
        #canvas-container { width: 800px; height: 600px; }
        canvas { display: block; }
        #controls { margin-top: 20px; }
        .slider { width: 500px; }
        .checkbox-group { margin-top: 10px; }
    </style>
</head>
<body>
    <div id="canvas-container"></div>
    <div id="controls">
        <label for="electronSlider">Number of Electrons: </label>
        <input type="range" id="electronSlider" class="slider" min="0" max="500" value="50">
        <span id="electronCount">50</span>
        <br><br>
        <label for="brownianSlider">Brownian Motion Strength: </label>
        <input type="range" id="brownianSlider" class="slider" min="0" max="100" value="10">
        <span id="brownianStrength">0.01</span>
        <br><br>
        <label for="dampingSlider">Electron Damping: </label>
        <input type="range" id="dampingSlider" class="slider" min="0" max="100" value="95">
        <span id="dampingValue">0.95</span>
        <br><br>
        <label for="frequencySlider">Electron Source Frequency (/sec): </label>
        <input type="range" id="frequencySlider" class="slider" min="0" max="100" value="10">
        <span id="frequencyValue">1</span>
        <br><br>
        <label for="girthSlider">Torus Girth: </label>
        <input type="range" id="girthSlider" class="slider" min="10" max="100" value="40">
        <span id="girthValue">40</span>
        <br><br>
        <label for="elongationSlider">Torus Elongation: </label>
        <input type="range" id="elongationSlider" class="slider" min="50" max="200" value="100">
        <span id="elongationValue">100</span>
        <br><br>
        <div class="checkbox-group">
            <label><input type="checkbox" id="rotateX"> Rotate X</label>
            <label><input type="checkbox" id="rotateY"> Rotate Y</label>
            <label><input type="checkbox" id="rotateZ"> Rotate Z</label>
            <label><input type="checkbox" id="sourceActive" checked> Electron Source</label>
            <label><input type="checkbox" id="sinkActive"> Electron Sink</label>
        </div>
    </div>

    <script>
        let electrons = [];
        let brownianStrength = 0.01;
        let damping = 0.95;
        let sourceFrequency = 1;
        const COULOMB_CONSTANT = 5000;
        let TORUS_RADIUS = 100;
        let TUBE_RADIUS = 40;
        const ELECTRON_SPEED = 0.02;
        const SINK_ATTRACTION = 5000;
        let rotationX = 0, rotationY = 0, rotationZ = 0;
        let userRotationX = 0;
        let userRotationY = 0;
        let dragStartX, dragStartY;
        let lastSourceTime = 0;
        let electronSource, electronSink;
        let canvas;

        function setup() {
            canvas = createCanvas(800, 600, WEBGL);
            canvas.parent('canvas-container');
            updateElectronCount();
            electronSource = new ElectronSource(0, PI/4);
            electronSink = new ElectronSink(PI, PI);
        }

        function draw() {
            background(220);
            
            camera(0, 0, 400);
            ambientLight(100);
            pointLight(255, 255, 255, 0, 0, 400);

            rotateX(userRotationY + rotationX);
            rotateY(userRotationX + rotationY);
            rotateZ(rotationZ);

            if (document.getElementById('rotateX').checked) rotationX += 0.005;
            if (document.getElementById('rotateY').checked) rotationY += 0.005;
            if (document.getElementById('rotateZ').checked) rotationZ += 0.005;

            noStroke();
            fill(200);
            torus(TORUS_RADIUS, TUBE_RADIUS);

            if (document.getElementById('sourceActive').checked) {
                electronSource.display();
                if (millis() - lastSourceTime > 1000 / sourceFrequency && electrons.length < 500) {
                    electrons.push(new Electron(electronSource.theta, electronSource.phi));
                    lastSourceTime = millis();
                }
            }

            if (document.getElementById('sinkActive').checked) {
                electronSink.display();
            }

            fill(0, 0, 255);
            for (let i = electrons.length - 1; i >= 0; i--) {
                electrons[i].update();
                electrons[i].display();
                if (document.getElementById('sinkActive').checked && electronSink.checkCollision(electrons[i])) {
                    electrons.splice(i, 1);
                }
            }

            updateDisplays();
        }

        function updateDisplays() {
            document.getElementById('electronCount').textContent = electrons.length;
            document.getElementById('brownianStrength').textContent = brownianStrength.toFixed(3);
            document.getElementById('dampingValue').textContent = damping.toFixed(2);
            document.getElementById('frequencyValue').textContent = sourceFrequency.toFixed(1);
            document.getElementById('girthValue').textContent = TUBE_RADIUS.toFixed(0);
            document.getElementById('elongationValue').textContent = TORUS_RADIUS.toFixed(0);
        }

        function updateElectronCount() {
            let targetCount = parseInt(document.getElementById('electronSlider').value);
            while (electrons.length < targetCount) {
                electrons.push(new Electron());
            }
            while (electrons.length > targetCount) {
                electrons.pop();
            }
        }

        function updateBrownianStrength() {
            brownianStrength = document.getElementById('brownianSlider').value / 10000;
        }

        function updateDamping() {
            damping = 1 - document.getElementById('dampingSlider').value / 100;
        }

        function updateFrequency() {
            sourceFrequency = document.getElementById('frequencySlider').value / 10;
        }

        function updateGirth() {
            TUBE_RADIUS = parseInt(document.getElementById('girthSlider').value);
        }

        function updateElongation() {
            TORUS_RADIUS = parseInt(document.getElementById('elongationSlider').value);
        }

        class Electron {
            constructor(theta = random(TWO_PI), phi = random(TWO_PI)) {
                this.theta = theta;
                this.phi = phi;
                this.velocity = createVector(0, 0);
            }

            update() {
                this.velocity.add(p5.Vector.random2D().mult(brownianStrength));
                
                let totalForce = createVector(0, 0);
                for (let other of electrons) {
                    if (other !== this) {
                        let force = this.calculateForce(other);
                        totalForce.add(force);
                    }
                }

                if (document.getElementById('sinkActive').checked) {
                    let sinkForce = electronSink.calculateAttraction(this);
                    totalForce.add(sinkForce);
                }

                this.velocity.add(totalForce);

                this.theta += this.velocity.x * ELECTRON_SPEED;
                this.phi += this.velocity.y * ELECTRON_SPEED;

                this.theta = (this.theta + TWO_PI) % TWO_PI;
                this.phi = constrain(this.phi, 0, TWO_PI);

                this.velocity.mult(1 - damping);
            }

            calculateForce(other) {
                let d_theta = (this.theta - other.theta + TWO_PI) % TWO_PI;
                let d_phi = (this.phi - other.phi + TWO_PI) % TWO_PI;
                
                if (d_theta > PI) d_theta -= TWO_PI;
                if (d_phi > PI) d_phi -= TWO_PI;

                let r = TORUS_RADIUS + TUBE_RADIUS * cos(this.phi);
                let dx = r * d_theta;
                let dy = TUBE_RADIUS * d_phi;
                let distSq = dx * dx + dy * dy;

                if (distSq < 0.1) distSq = 0.1;

                let force = COULOMB_CONSTANT / distSq;

                let forceTheta = force * dx / sqrt(distSq);
                let forcePhi = force * dy / sqrt(distSq);

                return createVector(forceTheta, forcePhi);
            }

            display() {
                let x = (TORUS_RADIUS + TUBE_RADIUS * cos(this.phi)) * cos(this.theta);
                let y = (TORUS_RADIUS + TUBE_RADIUS * cos(this.phi)) * sin(this.theta);
                let z = TUBE_RADIUS * sin(this.phi);
                push();
                translate(x, y, z);
                sphere(3);
                pop();
            }
        }

        class ElectronSource {
            constructor(theta, phi) {
                this.theta = theta;
                this.phi = phi;
            }

            display() {
                let x = (TORUS_RADIUS + TUBE_RADIUS * cos(this.phi)) * cos(this.theta);
                let y = (TORUS_RADIUS + TUBE_RADIUS * cos(this.phi)) * sin(this.theta);
                let z = TUBE_RADIUS * sin(this.phi);
                push();
                translate(x, y, z);
                fill(0);
                sphere(5);
                pop();
            }
        }

        class ElectronSink {
            constructor(theta, phi) {
                this.theta = theta;
                this.phi = phi;
            }

            display() {
                let x = (TORUS_RADIUS + TUBE_RADIUS * cos(this.phi)) * cos(this.theta);
                let y = (TORUS_RADIUS + TUBE_RADIUS * cos(this.phi)) * sin(this.theta);
                let z = TUBE_RADIUS * sin(this.phi);
                push();
                translate(x, y, z);
                fill(255);
                sphere(5);
                pop();
            }

            calculateAttraction(electron) {
                let d_theta = (this.theta - electron.theta + TWO_PI) % TWO_PI;
                let d_phi = (this.phi - electron.phi + TWO_PI) % TWO_PI;
                
                if (d_theta > PI) d_theta -= TWO_PI;
                if (d_phi > PI) d_phi -= TWO_PI;

                let r = TORUS_RADIUS + TUBE_RADIUS * cos(electron.phi);
                let dx = r * d_theta;
                let dy = TUBE_RADIUS * d_phi;
                let distSq = dx * dx + dy * dy;

                if (distSq < 0.1) distSq = 0.1;

                let force = SINK_ATTRACTION / distSq;

                let forceTheta = force * dx / sqrt(distSq);
                let forcePhi = force * dy / sqrt(distSq);

                return createVector(forceTheta, forcePhi);
            }

            checkCollision(electron) {
                let d_theta = (this.theta - electron.theta + TWO_PI) % TWO_PI;
                let d_phi = (this.phi - electron.phi + TWO_PI) % TWO_PI;
                
                if (d_theta > PI) d_theta -= TWO_PI;
                if (d_phi > PI) d_phi -= TWO_PI;

                let r = TORUS_RADIUS + TUBE_RADIUS * cos(electron.phi);
                let dx = r * d_theta;
                let dy = TUBE_RADIUS * d_phi;
                let distSq = dx * dx + dy * dy;

                return distSq < 25; // Collision if distance is less than 5 units
            }
        }

        function mousePressed() {
            if (mouseX >= 0 && mouseX < width && mouseY >= 0 && mouseY < height) {
                dragStartX = mouseX;
                dragStartY = mouseY;
            }
        }

        function mouseDragged() {
            if (mouseX >= 0 && mouseX < width && mouseY >= 0 && mouseY < height) {
                userRotationX += (mouseX - dragStartX) * 0.01;
                userRotationY += (mouseY - dragStartY) * 0.01;
                dragStartX = mouseX;
                dragStartY = mouseY;
            }
        }

        document.getElementById('electronSlider').addEventListener('input', updateElectronCount);
        document.getElementById('brownianSlider').addEventListener('input', updateBrownianStrength);
        document.getElementById('dampingSlider').addEventListener('input', updateDamping);
        document.getElementById('frequencySlider').addEventListener('input', updateFrequency);
        document.getElementById('girthSlider').addEventListener('input', updateGirth);
        document.getElementById('elongationSlider').addEventListener('input', updateElongation);
    </script>
</body>
</html>
