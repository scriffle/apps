<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Barcode Scanner System</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
        }

        .header h1 {
            color: #4a5568;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            color: #718096;
            font-size: 1.1rem;
        }

        .debug-console {
            background: rgba(0, 0, 0, 0.8);
            color: #00ff00;
            font-family: 'Courier New', monospace;
            font-size: 0.8rem;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            max-height: 150px;
            overflow-y: auto;
            display: none;
        }

        .debug-console.active {
            display: block;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #4a5568;
        }

        .tab:hover {
            background: rgba(255, 255, 255, 1);
            transform: translateY(-2px);
        }

        .tab.active {
            background: #4299e1;
            color: white;
            box-shadow: 0 4px 15px rgba(66, 153, 225, 0.4);
        }

        .content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(10px);
            min-height: 500px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Scanning Mode Styles */
        .scan-status {
            text-align: center;
            padding: 40px;
            border-radius: 15px;
            margin-bottom: 30px;
            font-size: 1.2rem;
            transition: all 0.3s ease;
        }

        .scan-status.ready {
            background: linear-gradient(135deg, #48bb78, #38a169);
            color: white;
        }

        .scan-status.scanning {
            background: linear-gradient(135deg, #ed8936, #dd6b20);
            color: white;
            animation: pulse 1s infinite;
        }

        .scan-status.success {
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: white;
        }

        .scan-status.flash {
            background: #fff200 !important;
            color: #333 !important;
            animation: flash 0.5s ease-out;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        @keyframes flash {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .recent-scans {
            max-height: 300px;
            overflow-y: auto;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
        }

        .scan-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 8px;
            background: #f7fafc;
            border-left: 4px solid #4299e1;
        }

        .scan-item.new {
            border-left-color: #48bb78;
            background: #f0fff4;
        }

        .scan-item.existing {
            border-left-color: #ed8936;
            background: #fffaf0;
        }

        /* Learning Mode Styles */
        .learning-form {
            display: grid;
            gap: 20px;
            max-width: 600px;
        }

        /* Flag Styles */
        .flag-management {
            background: #f7fafc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .flag-type-list {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .flag-type-item {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .flag-options {
            font-size: 0.8rem;
            color: #718096;
        }

        .flags-section {
            border-top: 1px solid #e2e8f0;
            padding-top: 15px;
            margin-top: 15px;
        }

        .flag-inputs {
            display: grid;
            gap: 10px;
            margin-top: 10px;
        }

        .flag-display {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 8px;
        }

        .flag-badge {
            background: #805ad5;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .flag-badge.null {
            background: #a0aec0;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group label {
            font-weight: 600;
            color: #4a5568;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            padding: 12px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #4299e1;
        }

        .btn {
            background: #4299e1;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: #3182ce;
            transform: translateY(-2px);
        }

        .btn.secondary {
            background: #718096;
        }

        .btn.secondary:hover {
            background: #4a5568;
        }

        .btn.danger {
            background: #e53e3e;
        }

        .btn.danger:hover {
            background: #c53030;
        }

        /* Management Mode Styles */
        .management-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 20px;
        }

        .search-filter {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
        }

        .search-filter input,
        .search-filter select {
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 0.9rem;
        }

        .barcode-grid {
            display: grid;
            gap: 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .barcode-card {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s ease;
        }

        .barcode-card:hover {
            border-color: #4299e1;
            transform: translateY(-2px);
        }

        .barcode-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 15px;
        }

        .barcode-info h3 {
            color: #2d3748;
            margin-bottom: 5px;
        }

        .barcode-info .barcode-value {
            font-family: 'Courier New', monospace;
            color: #4a5568;
            font-size: 0.9rem;
        }

        .barcode-tags {
            display: flex;
            gap: 8px;
            margin-top: 10px;
            flex-wrap: wrap;
        }

        .tag {
            background: #4299e1;
            color: white;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .tag.type {
            background: #48bb78;
        }

        .tag.group {
            background: #ed8936;
        }

        .barcode-actions {
            display: flex;
            gap: 10px;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.8rem;
        }

        .export-import {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .file-input {
            display: none;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #4299e1, #3182ce);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 2rem;
            margin-bottom: 5px;
        }

        .stat-card p {
            opacity: 0.9;
        }

        .hidden {
            display: none !important;
        }

        .group-management {
            background: #f7fafc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .group-list {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .group-item {
            background: white;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .delete-group {
            background: #e53e3e;
            color: white;
            border: none;
            border-radius: 50%;
            width: 20px;
            height: 20px;
            cursor: pointer;
            font-size: 12px;
        }

        .debug-toggle {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #333;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üì± Barcode Scanner System</h1>
            <p>School scanning game management system</p>
        </div>

        <div class="debug-console" id="debugConsole">
            <div id="debugOutput">Debug Console Active...</div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('scanning')">üîç Scanning</button>
            <button class="tab" onclick="switchTab('learning')">üìö Learning</button>
            <button class="tab" onclick="switchTab('management')">‚öôÔ∏è Management</button>
        </div>

        <div class="content">
            <!-- Scanning Tab -->
            <div id="scanning" class="tab-content active">
                <div class="scan-status ready" id="scanStatus">
                    Ready to scan - Point scanner at barcode
                </div>
                
                <div class="recent-scans">
                    <h3 style="margin-bottom: 20px;">Recent Scans</h3>
                    <div id="recentScans">
                        <p style="text-align: center; color: #718096; font-style: italic;">No scans yet</p>
                    </div>
                </div>
            </div>

            <!-- Learning Tab -->
            <div id="learning" class="tab-content">
                <h2 style="margin-bottom: 30px;">üìö Learn New Barcodes</h2>
                
                <div class="scan-status ready" id="learningScanStatus">
                    Scan a barcode to learn it
                </div>

                <div class="learning-form" id="learningForm" style="display: none;">
                    <div class="form-group">
                        <label>Scanned Barcode: <span id="scannedBarcodeDisplay" style="font-family: monospace; color: #4299e1;"></span></label>
                    </div>
                    
                    <div class="form-group">
                        <label for="barcodeName">Name:</label>
                        <input type="text" id="barcodeName" placeholder="Enter a name for this barcode">
                    </div>
                    
                    <div class="form-group">
                        <label for="barcodeDescription">Description:</label>
                        <textarea id="barcodeDescription" rows="3" placeholder="Enter description"></textarea>
                    </div>
                    
                    <div class="form-group">
                        <label for="barcodeGroup">Group:</label>
                        <select id="barcodeGroup">
                            <option value="">Select a group (optional)</option>
                        </select>
                    </div>
                    
                    <div class="flags-section">
                        <label>Flags:</label>
                        <div class="flag-inputs" id="flagInputs">
                            <!-- Flag inputs will be added dynamically -->
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 15px;">
                        <button class="btn" onclick="saveBarcode()">üíæ Save Barcode</button>
                        <button class="btn secondary" onclick="cancelLearning()">‚ùå Cancel</button>
                    </div>
                </div>
            </div>

            <!-- Management Tab -->
            <div id="management" class="tab-content">
                <div class="stats">
                    <div class="stat-card">
                        <h3 id="totalBarcodes">0</h3>
                        <p>Total Barcodes</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="totalGroups">0</h3>
                        <p>Groups</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="totalScans">0</h3>
                        <p>Total Scans</p>
                    </div>
                </div>

                <div class="group-management">
                    <h3>Group Management</h3>
                    <div style="display: flex; gap: 15px; margin-top: 15px;">
                        <input type="text" id="newGroupName" placeholder="New group name" style="flex: 1;">
                        <button class="btn" onclick="addGroup()">Add Group</button>
                    </div>
                    <div class="group-list" id="groupList"></div>
                </div>

                <div class="flag-management">
                    <h3>Flag Management</h3>
                    <div style="display: flex; gap: 15px; margin-top: 15px;">
                        <input type="text" id="newFlagName" placeholder="Flag name (e.g., House)" style="flex: 1;">
                        <input type="text" id="newFlagOptions" placeholder="Options (comma-separated, e.g., Red,Blue,Green,Yellow)" style="flex: 2;">
                        <button class="btn" onclick="addFlagType()">Add Flag Type</button>
                    </div>
                    <div class="flag-type-list" id="flagTypeList"></div>
                </div>

                <div class="export-import">
                    <button class="btn" onclick="exportCSV()">üì§ Export All CSV</button>
                    <button class="btn" onclick="exportGroupCSV()">üì§ Export Group CSV</button>
                    <button class="btn secondary" onclick="document.getElementById('importFile').click()">üì• Import CSV</button>
                    <input type="file" id="importFile" class="file-input" accept=".csv" onchange="importCSV(event)">
                    <button class="btn secondary" onclick="clearAllData()">üóëÔ∏è Clear All Data</button>
                </div>

                <div class="management-header">
                    <h2>üìã Barcode Library</h2>
                    <div class="search-filter">
                        <input type="text" id="searchInput" placeholder="Search barcodes..." onkeyup="filterBarcodes()">
                        <select id="groupFilter" onchange="filterBarcodes()">
                            <option value="">All Groups</option>
                        </select>
                        <select id="typeFilter" onchange="filterBarcodes()">
                            <option value="">All Types</option>
                        </select>
                    </div>
                </div>

                <div class="barcode-grid" id="barcodeGrid">
                    <p style="text-align: center; color: #718096; font-style: italic;">No barcodes yet</p>
                </div>
            </div>
        </div>
    </div>

    <button class="debug-toggle" onclick="toggleDebug()">üêõ Debug</button>

    <audio id="beepSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+D...." type="audio/wav">
    </audio>

    <script>
        // Global variables
        let barcodeLibrary = new Map();
        let groups = new Set();
        let flagTypes = new Map(); // Stores flag definitions { name: string, options: string[] }
        let scanBuffer = '';
        let scanTimeout = null;
        let currentLearningBarcode = null;
        let totalScans = 0;
        let debugMode = false;

        // Debug logging function
        function debugLog(message) {
            if (debugMode) {
                const debugOutput = document.getElementById('debugOutput');
                const timestamp = new Date().toLocaleTimeString();
                debugOutput.innerHTML = `${timestamp} - ${message}<br>` + debugOutput.innerHTML;
                // Keep only last 20 lines
                const lines = debugOutput.innerHTML.split('<br>');
                if (lines.length > 20) {
                    debugOutput.innerHTML = lines.slice(0, 20).join('<br>');
                }
            }
            console.log(message);
        }

        function toggleDebug() {
            debugMode = !debugMode;
            document.getElementById('debugConsole').classList.toggle('active', debugMode);
            if (debugMode) {
                debugLog('Debug mode activated');
            }
        }

        // Initialize the application
        function init() {
            debugLog('Initializing application...');
            
            // Add some sample flag types
            flagTypes.set('House', ['Red', 'Blue', 'Green', 'Yellow']);
            flagTypes.set('Status', ['Active', 'Inactive', 'Pending']);
            
            // Add some sample data for demonstration
            const sampleBarcodes = [
                { 
                    value: '123456789012', 
                    name: 'Sample Book', 
                    description: 'A sample book barcode', 
                    group: 'Books', 
                    type: 'UPC-A',
                    flags: { House: 'Blue', Status: 'Active' }
                },
                { 
                    value: '987654321098', 
                    name: 'Sample Product', 
                    description: 'A sample product barcode', 
                    group: 'Products', 
                    type: 'UPC-A',
                    flags: { House: 'Red', Status: null }
                }
            ];
            
            sampleBarcodes.forEach(barcode => {
                barcodeLibrary.set(barcode.value, {
                    ...barcode,
                    dateAdded: new Date().toISOString(),
                    scanCount: 0,
                    flags: barcode.flags || {}
                });
                groups.add(barcode.group);
            });

            updateStats();
            updateGroupSelectors();
            updateFilters();
            renderBarcodes();
            renderGroups();
            renderFlagTypes();
            updateFlagInputs();

            // Set up barcode scanning
            document.addEventListener('keydown', handleKeyDown);
            document.addEventListener('keypress', handleKeyPress);
            
            debugLog('Application initialized successfully');
        }

        // Barcode scanning logic
        function handleKeyDown(event) {
            // Ignore if typing in an input field
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA' || event.target.tagName === 'SELECT') {
                return;
            }

            debugLog(`KeyDown: ${event.key}, Code: ${event.code}, CharCode: ${event.keyCode}`);

            // Clear timeout
            if (scanTimeout) {
                clearTimeout(scanTimeout);
            }

            // Handle Enter key
            if (event.key === 'Enter' && scanBuffer.length > 0) {
                event.preventDefault();
                debugLog(`Processing scan buffer: "${scanBuffer}"`);
                processScan(scanBuffer.trim());
                scanBuffer = '';
                return;
            }

            // Add character to buffer
            if (event.key.length === 1) {
                scanBuffer += event.key;
                debugLog(`Buffer updated: "${scanBuffer}"`);
                
                // Update scan status
                const currentTab = document.querySelector('.tab-content.active').id;
                const statusElement = currentTab === 'learning' ? 
                    document.getElementById('learningScanStatus') : 
                    document.getElementById('scanStatus');
                
                statusElement.className = 'scan-status scanning';
                statusElement.textContent = `Scanning... ${scanBuffer}`;
            }

            // Set timeout to clear buffer
            scanTimeout = setTimeout(() => {
                if (scanBuffer.length > 0) {
                    debugLog(`Timeout reached, processing buffer: "${scanBuffer}"`);
                    processScan(scanBuffer.trim());
                }
                scanBuffer = '';
                resetScanStatus();
            }, 1000); // Increased timeout to 1 second
        }

        function handleKeyPress(event) {
            // Some scanners send keypress events instead of keydown
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA' || event.target.tagName === 'SELECT') {
                return;
            }
            
            if (event.key && event.key.length === 1 && event.key !== 'Enter') {
                debugLog(`KeyPress: ${event.key}`);
            }
        }

        function processScan(barcode) {
            if (!barcode || barcode.length === 0) {
                debugLog('Empty barcode, ignoring...');
                return;
            }

            debugLog(`Processing barcode: "${barcode}"`);
            totalScans++;
            const currentTab = document.querySelector('.tab-content.active').id;
            const isExisting = barcodeLibrary.has(barcode);
            
            debugLog(`Current tab: ${currentTab}, Existing barcode: ${isExisting}`);
            
            // Play beep sound
            try {
                const audio = document.getElementById('beepSound');
                audio.currentTime = 0;
                audio.play().catch(() => {});
            } catch (e) {
                debugLog('Error playing sound: ' + e.message);
            }

            // Flash effect
            const statusElement = currentTab === 'learning' ? 
                document.getElementById('learningScanStatus') : 
                document.getElementById('scanStatus');
            
            statusElement.classList.add('flash');
            setTimeout(() => statusElement.classList.remove('flash'), 500);

            if (currentTab === 'scanning') {
                handleScanningScan(barcode, isExisting);
            } else if (currentTab === 'learning') {
                handleLearningScan(barcode, isExisting);
            }

            updateStats();
        }

        function handleScanningScan(barcode, isExisting) {
            debugLog(`Handling scanning mode scan: ${barcode}`);
            const statusElement = document.getElementById('scanStatus');
            const recentScans = document.getElementById('recentScans');

            if (isExisting) {
                const barcodeData = barcodeLibrary.get(barcode);
                barcodeData.scanCount++;
                statusElement.className = 'scan-status success';
                statusElement.textContent = `‚úÖ Found: ${barcodeData.name}`;
            } else {
                statusElement.className = 'scan-status success';
                statusElement.textContent = `üÜï New barcode: ${barcode}`;
            }

            // Add to recent scans
            const scanItem = document.createElement('div');
            scanItem.className = `scan-item ${isExisting ? 'existing' : 'new'}`;
            scanItem.innerHTML = `
                <div>
                    <strong>${isExisting ? barcodeLibrary.get(barcode).name : 'Unknown'}</strong>
                    <div class="barcode-value">${barcode}</div>
                </div>
                <div class="tag ${isExisting ? 'existing' : 'new'}">
                    ${isExisting ? 'Known' : 'New'}
                </div>
            `;

            if (recentScans.firstChild && recentScans.firstChild.tagName === 'P') {
                recentScans.innerHTML = '';
            }
            
            recentScans.insertBefore(scanItem, recentScans.firstChild);

            // Keep only last 10 scans
            while (recentScans.children.length > 10) {
                recentScans.removeChild(recentScans.lastChild);
            }

            setTimeout(resetScanStatus, 3000);
        }

        function handleLearningScan(barcode, isExisting) {
            debugLog(`Handling learning mode scan: ${barcode}, existing: ${isExisting}`);
            const statusElement = document.getElementById('learningScanStatus');
            const learningForm = document.getElementById('learningForm');

            currentLearningBarcode = barcode;

            if (isExisting) {
                const existing = barcodeLibrary.get(barcode);
                statusElement.className = 'scan-status success';
                statusElement.textContent = `‚ö†Ô∏è Already exists: ${existing.name}`;
                debugLog(`Barcode already exists: ${existing.name}`);
                setTimeout(() => {
                    resetScanStatus();
                    currentLearningBarcode = null;
                }, 3000);
            } else {
                statusElement.className = 'scan-status success';
                statusElement.textContent = `üìù New barcode scanned!`;
                learningForm.style.display = 'grid';
                
                // Display the scanned barcode
                document.getElementById('scannedBarcodeDisplay').textContent = barcode;
                
                // Pre-fill with detected type
                const type = detectBarcodeType(barcode);
                document.getElementById('barcodeName').value = '';
                document.getElementById('barcodeDescription').value = `Barcode of type: ${type}`;
                document.getElementById('barcodeGroup').value = '';
                
                debugLog(`Showing learning form for new barcode: ${barcode}, type: ${type}`);
                
                // Focus on name input
                setTimeout(() => {
                    document.getElementById('barcodeName').focus();
                }, 100);
                
                // Update flag inputs for the learning form
                updateFlagInputs();
            }
        }

        function resetScanStatus() {
            const currentTab = document.querySelector('.tab-content.active').id;
            const statusElement = currentTab === 'learning' ? 
                document.getElementById('learningScanStatus') : 
                document.getElementById('scanStatus');
            
            statusElement.className = 'scan-status ready';
            statusElement.textContent = currentTab === 'learning' ? 
                'Scan a barcode to learn it' : 
                'Ready to scan - Point scanner at barcode';
            
            debugLog('Scan status reset');
        }

        function detectBarcodeType(barcode) {
            const length = barcode.length;
            const firstDigit = barcode[0];

            if (length === 12 && /^\d+$/.test(barcode)) return 'UPC-A';
            if (length === 13 && /^\d+$/.test(barcode)) return 'EAN-13';
            if (length === 8 && /^\d+$/.test(barcode)) return 'EAN-8';
            if (/^[0-9A-Z\-\.\s\$\/\+\%]+$/.test(barcode)) return 'Code 39';
            if (length >= 6) return 'Code 128';
            return 'Unknown';
        }

        // Learning mode functions
        function saveBarcode() {
            if (!currentLearningBarcode) {
                debugLog('No current learning barcode to save');
                return;
            }

            const name = document.getElementById('barcodeName').value.trim();
            const description = document.getElementById('barcodeDescription').value.trim();
            const group = document.getElementById('barcodeGroup').value;

            if (!name) {
                alert('Please enter a name for the barcode');
                return;
            }

            // Collect flag values
            const flags = {};
            flagTypes.forEach((options, flagName) => {
                const select = document.getElementById(`flag_${flagName}`);
                if (select && select.value) {
                    flags[flagName] = select.value;
                } else {
                    flags[flagName] = null;
                }
            });

            const barcodeData = {
                value: currentLearningBarcode,
                name: name,
                description: description,
                group: group,
                type: detectBarcodeType(currentLearningBarcode),
                dateAdded: new Date().toISOString(),
                scanCount: 0,
                flags: flags
            };

            barcodeLibrary.set(currentLearningBarcode, barcodeData);
            debugLog(`Saved barcode: ${currentLearningBarcode} as "${name}" with flags:`, flags);
            
            if (group) {
                groups.add(group);
            }

            updateStats();
            updateGroupSelectors();
            updateFilters();
            renderBarcodes();
            renderGroups();

            // Reset learning form
            cancelLearning();

            // Show success message
            const statusElement = document.getElementById('learningScanStatus');
            statusElement.className = 'scan-status success';
            statusElement.textContent = `‚úÖ Saved: ${name}`;
            setTimeout(resetScanStatus, 3000);
        }

        function cancelLearning() {
            currentLearningBarcode = null;
            document.getElementById('learningForm').style.display = 'none';
            document.getElementById('barcodeName').value = '';
            document.getElementById('barcodeDescription').value = '';
            document.getElementById('barcodeGroup').value = '';
            document.getElementById('scannedBarcodeDisplay').textContent = '';
            debugLog('Learning cancelled');
            resetScanStatus();
        }

        // Management functions
        function updateStats() {
            document.getElementById('totalBarcodes').textContent = barcodeLibrary.size;
            document.getElementById('totalGroups').textContent = groups.size;
            document.getElementById('totalScans').textContent = totalScans;
        }

        function updateGroupSelectors() {
            const selectors = ['barcodeGroup', 'groupFilter'];
            selectors.forEach(id => {
                const select = document.getElementById(id);
                const currentValue = select.value;
                
                // Clear and add default option
                select.innerHTML = id === 'barcodeGroup' ? 
                    '<option value="">Select a group (optional)</option>' :
                    '<option value="">All Groups</option>';
                
                // Add group options
                Array.from(groups).sort().forEach(group => {
                    const option = document.createElement('option');
                    option.value = group;
                    option.textContent = group;
                    select.appendChild(option);
                });
                
                // Restore previous value
                select.value = currentValue;
            });
        }

        function updateFilters() {
            const typeFilter = document.getElementById('typeFilter');
            const currentValue = typeFilter.value;
            
            typeFilter.innerHTML = '<option value="">All Types</option>';
            
            const types = new Set();
            barcodeLibrary.forEach(barcode => types.add(barcode.type));
            
            Array.from(types).sort().forEach(type => {
                const option = document.createElement('option');
                option.value = type;
                option.textContent = type;
                typeFilter.appendChild(option);
            });
            
            typeFilter.value = currentValue;
        }

        function renderBarcodes() {
            const grid = document.getElementById('barcodeGrid');
            
            if (barcodeLibrary.size === 0) {
                grid.innerHTML = '<p style="text-align: center; color: #718096; font-style: italic;">No barcodes yet</p>';
                return;
            }

            grid.innerHTML = '';
            
            Array.from(barcodeLibrary.values()).forEach(barcode => {
                const card = document.createElement('div');
                card.className = 'barcode-card';
                card.innerHTML = `
                    <div class="barcode-header">
                        <div class="barcode-info">
                            <h3>${barcode.name}</h3>
                            <div class="barcode-value">${barcode.value}</div>
                            <p style="margin-top: 10px; color: #718096;">${barcode.description}</p>
                        </div>
                        <div class="barcode-actions">
                            <button class="btn btn-small secondary" onclick="editBarcode('${barcode.value}')">‚úèÔ∏è Edit</button>
                            <button class="btn btn-small danger" onclick="deleteBarcode('${barcode.value}')">üóëÔ∏è Delete</button>
                        </div>
                    </div>
                    <div class="barcode-tags">
                        <span class="tag type">${barcode.type}</span>
                        ${barcode.group ? `<span class="tag group">${barcode.group}</span>` : ''}
                        <span class="tag">Scanned: ${barcode.scanCount}</span>
                        <span class="tag">Added: ${new Date(barcode.dateAdded).toLocaleDateString()}</span>
                    </div>
                    ${renderBarcodeFlags(barcode)}
                `;
                grid.appendChild(card);
            });
        }

        function renderGroups() {
            const groupList = document.getElementById('groupList');
            groupList.innerHTML = '';
            
            Array.from(groups).sort().forEach(group => {
                const groupItem = document.createElement('div');
                groupItem.className = 'group-item';
                groupItem.innerHTML = `
                    <span>${group}</span>
                    <button class="delete-group" onclick="deleteGroup('${group}')" title="Delete group">√ó</button>
                `;
                groupList.appendChild(groupItem);
            });
        }

        function filterBarcodes() {
            const searchTerm = document.getElementById('searchInput').value.toLowerCase();
            const groupFilter = document.getElementById('groupFilter').value;
            const typeFilter = document.getElementById('typeFilter').value;
            
            const cards = document.querySelectorAll('.barcode-card');
            
            cards.forEach(card => {
                const text = card.textContent.toLowerCase();
                const matchesSearch = text.includes(searchTerm);
                const matchesGroup = !groupFilter || text.includes(groupFilter.toLowerCase());
                const matchesType = !typeFilter || text.includes(typeFilter.toLowerCase());
                
                card.style.display = matchesSearch && matchesGroup && matchesType ? 'block' : 'none';
            });
        }

        function addGroup() {
            const groupName = document.getElementById('newGroupName').value.trim();
            if (groupName && !groups.has(groupName)) {
                groups.add(groupName);
                document.getElementById('newGroupName').value = '';
                updateGroupSelectors();
                renderGroups();
                updateStats();
                debugLog(`Added group: ${groupName}`);
            }
        }

        function deleteGroup(groupName) {
            if (confirm(`Delete group "${groupName}"? Barcodes in this group will not be deleted.`)) {
                groups.delete(groupName);
                updateGroupSelectors();
                renderGroups();
                updateStats();
                debugLog(`Deleted group: ${groupName}`);
            }
        }

        function editBarcode(barcodeValue) {
            const barcode = barcodeLibrary.get(barcodeValue);
            if (!barcode) return;
            
            const name = prompt('Name:', barcode.name);
            if (name === null) return;
            
            const description = prompt('Description:', barcode.description);
            if (description === null) return;
            
            const group = prompt('Group:', barcode.group || '');
            if (group === null) return;
            
            // Edit flags
            const flags = { ...barcode.flags };
            flagTypes.forEach((options, flagName) => {
                const currentValue = flags[flagName] || 'null';
                const optionsStr = ['null', ...options].join(', ');
                const newValue = prompt(`${flagName} (options: ${optionsStr}):`, currentValue);
                if (newValue === null) return;
                flags[flagName] = newValue === 'null' || newValue === '' ? null : newValue;
            });
            
            barcode.name = name.trim();
            barcode.description = description.trim();
            barcode.group = group.trim();
            barcode.flags = flags;
            
            if (barcode.group) {
                groups.add(barcode.group);
            }
            
            updateGroupSelectors();
            updateFilters();
            renderBarcodes();
            renderGroups();
            debugLog(`Edited barcode: ${barcodeValue}`);
        }

        function deleteBarcode(barcodeValue) {
            const barcode = barcodeLibrary.get(barcodeValue);
            if (barcode && confirm(`Delete barcode "${barcode.name}"?`)) {
                barcodeLibrary.delete(barcodeValue);
                updateStats();
                updateFilters();
                renderBarcodes();
                debugLog(`Deleted barcode: ${barcodeValue}`);
            }
        }

        // Flag management functions
        function addFlagType() {
            const flagName = document.getElementById('newFlagName').value.trim();
            const flagOptions = document.getElementById('newFlagOptions').value.trim();
            
            if (!flagName || !flagOptions) {
                alert('Please enter both flag name and options');
                return;
            }
            
            const options = flagOptions.split(',').map(opt => opt.trim()).filter(opt => opt);
            if (options.length === 0) {
                alert('Please enter at least one option');
                return;
            }
            
            flagTypes.set(flagName, options);
            document.getElementById('newFlagName').value = '';
            document.getElementById('newFlagOptions').value = '';
            
            renderFlagTypes();
            updateFlagInputs();
            debugLog(`Added flag type: ${flagName} with options: ${options.join(', ')}`);
        }

        function deleteFlagType(flagName) {
            if (confirm(`Delete flag type "${flagName}"? This will remove this flag from all barcodes.`)) {
                flagTypes.delete(flagName);
                
                // Remove flag from all barcodes
                barcodeLibrary.forEach(barcode => {
                    if (barcode.flags && barcode.flags[flagName]) {
                        delete barcode.flags[flagName];
                    }
                });
                
                renderFlagTypes();
                updateFlagInputs();
                renderBarcodes();
                debugLog(`Deleted flag type: ${flagName}`);
            }
        }

        function renderFlagTypes() {
            const flagTypeList = document.getElementById('flagTypeList');
            flagTypeList.innerHTML = '';
            
            flagTypes.forEach((options, flagName) => {
                const flagItem = document.createElement('div');
                flagItem.className = 'flag-type-item';
                flagItem.innerHTML = `
                    <span><strong>${flagName}</strong></span>
                    <span class="flag-options">${options.join(', ')}</span>
                    <button class="delete-group" onclick="deleteFlagType('${flagName}')" title="Delete flag type">√ó</button>
                `;
                flagTypeList.appendChild(flagItem);
            });
        }

        function updateFlagInputs() {
            const flagInputs = document.getElementById('flagInputs');
            if (!flagInputs) return; // Only update if we're in learning mode
            
            flagInputs.innerHTML = '';
            
            flagTypes.forEach((options, flagName) => {
                const formGroup = document.createElement('div');
                formGroup.className = 'form-group';
                formGroup.innerHTML = `
                    <label for="flag_${flagName}">${flagName}:</label>
                    <select id="flag_${flagName}">
                        <option value="">None</option>
                        ${options.map(opt => `<option value="${opt}">${opt}</option>`).join('')}
                    </select>
                `;
                flagInputs.appendChild(formGroup);
            });
        }

        function renderBarcodeFlags(barcode) {
            if (!barcode.flags || Object.keys(barcode.flags).length === 0) {
                return '';
            }
            
            const flagsHtml = Object.entries(barcode.flags)
                .filter(([_, value]) => value !== null)
                .map(([flag, value]) => `<span class="flag-badge">${flag}: ${value}</span>`)
                .join('');
            
            return flagsHtml ? `<div class="flag-display">${flagsHtml}</div>` : '';
        }

        // CSV Import/Export functions
        function exportCSV() {
            const csvData = [];
            
            // Build header with flag columns
            const headers = ['Barcode', 'Name', 'Description', 'Group', 'Type', 'Date Added', 'Scan Count'];
            flagTypes.forEach((_, flagName) => {
                headers.push(`Flag: ${flagName}`);
            });
            csvData.push(headers);
            
            barcodeLibrary.forEach(barcode => {
                const row = [
                    barcode.value,
                    barcode.name,
                    barcode.description,
                    barcode.group || '',
                    barcode.type,
                    barcode.dateAdded,
                    barcode.scanCount
                ];
                
                // Add flag values
                flagTypes.forEach((_, flagName) => {
                    row.push(barcode.flags && barcode.flags[flagName] || '');
                });
                
                csvData.push(row);
            });
            
            downloadCSV(csvData, 'barcode_library.csv');
            debugLog(`Exported ${barcodeLibrary.size} barcodes to CSV`);
        }

        function exportGroupCSV() {
            const group = prompt('Enter group name to export:');
            if (!group) return;
            
            const csvData = [];
            csvData.push(['Barcode', 'Name', 'Description', 'Group', 'Type', 'Date Added', 'Scan Count']);
            
            barcodeLibrary.forEach(barcode => {
                if (barcode.group === group) {
                    csvData.push([
                        barcode.value,
                        barcode.name,
                        barcode.description,
                        barcode.group || '',
                        barcode.type,
                        barcode.dateAdded,
                        barcode.scanCount
                    ]);
                }
            });
            
            if (csvData.length > 1) {
                downloadCSV(csvData, `barcode_library_${group}.csv`);
                debugLog(`Exported ${csvData.length - 1} barcodes from group "${group}" to CSV`);
            } else {
                alert('No barcodes found in that group');
            }
        }

        function downloadCSV(data, filename) {
            const csv = Papa.unparse(data);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            link.setAttribute('href', url);
            link.setAttribute('download', filename);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function importCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            Papa.parse(file, {
                header: true,
                dynamicTyping: true,
                skipEmptyLines: true,
                complete: function(results) {
                    let importCount = 0;
                    
                    results.data.forEach(row => {
                        if (row.Barcode && row.Name) {
                            const flags = {};
                            
                            // Extract flag values from CSV
                            Object.keys(row).forEach(key => {
                                if (key.startsWith('Flag: ')) {
                                    const flagName = key.substring(6);
                                    const value = row[key];
                                    if (value && value !== '') {
                                        flags[flagName] = value;
                                        
                                        // Add flag type if it doesn't exist
                                        if (!flagTypes.has(flagName)) {
                                            flagTypes.set(flagName, [value]);
                                        } else {
                                            const options = flagTypes.get(flagName);
                                            if (!options.includes(value)) {
                                                options.push(value);
                                            }
                                        }
                                    }
                                }
                            });
                            
                            const barcodeData = {
                                value: row.Barcode,
                                name: row.Name,
                                description: row.Description || '',
                                group: row.Group || '',
                                type: row.Type || detectBarcodeType(row.Barcode),
                                dateAdded: row['Date Added'] || new Date().toISOString(),
                                scanCount: row['Scan Count'] || 0,
                                flags: flags
                            };
                            
                            barcodeLibrary.set(row.Barcode, barcodeData);
                            
                            if (barcodeData.group) {
                                groups.add(barcodeData.group);
                            }
                            
                            importCount++;
                        }
                    });
                    
                    updateStats();
                    updateGroupSelectors();
                    updateFilters();
                    renderBarcodes();
                    renderGroups();
                    renderFlagTypes();
                    updateFlagInputs();
                    
                    alert(`Imported ${importCount} barcodes successfully!`);
                    debugLog(`Imported ${importCount} barcodes from CSV`);
                },
                error: function(error) {
                    alert('Error importing CSV: ' + error.message);
                    debugLog(`CSV import error: ${error.message}`);
                }
            });
            
            // Reset file input
            event.target.value = '';
        }

        function clearAllData() {
            if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
                barcodeLibrary.clear();
                groups.clear();
                totalScans = 0;
                updateStats();
                updateGroupSelectors();
                updateFilters();
                renderBarcodes();
                renderGroups();
                
                // Clear recent scans
                document.getElementById('recentScans').innerHTML = 
                    '<p style="text-align: center; color: #718096; font-style: italic;">No scans yet</p>';
                
                debugLog('All data cleared');
            }
        }

        // Tab switching
        function switchTab(tabName) {
            // Update tab buttons
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update tab content
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            
            // Reset scan status when switching tabs
            setTimeout(resetScanStatus, 100);
            
            debugLog(`Switched to ${tabName} tab`);
        }

        // Initialize when page loads
        window.addEventListener('load', init);
    </script>
</body>
</html>