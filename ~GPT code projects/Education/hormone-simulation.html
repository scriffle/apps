<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bloodstream Hormone Simulation</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #f0f0f0;
        }
        canvas {
            border: 1px solid #000;
            background-color: #fff;
        }
        .controls {
            margin-top: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .slider-container {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
        }
        label {
            margin-right: 10px;
            width: 150px;
        }
        #glucoseGraphCanvas {
            margin-top: 20px;
            border: 1px solid #000;
            background-color: #fff;
        }
    </style>
</head>
<body>
    <h1>Bloodstream Hormone Simulation</h1>
    <canvas id="vesselCanvas" width="800" height="400"></canvas>
    <div class="controls">
        <div class="slider-container">
            <label for="heartRateSlider">Heart Rate (BPM): </label>
            <input type="range" id="heartRateSlider" min="55" max="145" value="60">
            <span id="heartRateValue">60</span>
        </div>
        <div class="slider-container">
            <label for="dilationSlider">Vessel Dilation (%): </label>
            <input type="range" id="dilationSlider" min="50" max="150" value="100">
            <span id="dilationValue">100</span>
        </div>
    </div>

    <!-- Add canvas for glucose graph -->
    <canvas id="glucoseGraphCanvas" width="800" height="200"></canvas>

    <script>
        const canvas = document.getElementById('vesselCanvas');
        const ctx = canvas.getContext('2d');
        const glucoseGraphCanvas = document.getElementById('glucoseGraphCanvas');
        const glucoseGraphCtx = glucoseGraphCanvas.getContext('2d');

        const heartRateSlider = document.getElementById('heartRateSlider');
        const heartRateValue = document.getElementById('heartRateValue');
        const dilationSlider = document.getElementById('dilationSlider');
        const dilationValue = document.getElementById('dilationValue');

        let heartRate = 60;
        let dilation = 100;
        let targetDilation = 100;
        let bloodCells = [];
        let glucoseParticles = [];
        let hormones = [];
        let lastPulseTime = 0;
        let pulseIntensity = 0;
        let lastTimestamp = 0;
        let timeElapsed = 0;
        let glucoseTimeElapsed = 0;  // Time to track glucose removal
        const glucoseUsageInterval = 2000; // 2 seconds

        const baseVesselHeight = 200;
        const glandReceptorPairs = [
            { position: 0.3, color: 'yellow', effect: 'increase', name: 'Epinephrine' },
            { position: 0.4, color: 'blue', effect: 'decrease', name: 'Acetylcholine' },
            { position: 0.6, color: 'green', effect: 'none', name: 'Insulin' },
            { position: 0.7, color: 'orange', effect: 'none', name: 'Glucagon' }
        ];

        const glucoseLevels = [];
        const maxTime = 30;  // 30 seconds for the glucose level graph

        class Particle {
            constructor(x, y, color, radius) {
                this.x = x;
                this.y = y;
                this.color = color;
                this.radius = radius;
                this.baseSpeed = 0.1 + Math.random() * 0.1;
                this.speed = this.baseSpeed;
                this.verticalPosition = (this.y - canvas.height / 2) / (baseVesselHeight / 2);
            }

            update(deltaTime, pulseFactor, vesselHeight, speedMultiplier) {
                this.speed = this.baseSpeed * speedMultiplier * (1 + pulseFactor * 0.5);
                this.x += this.speed * deltaTime;
                if (this.x > canvas.width) {
                    this.x = 0;
                }

                const maxY = canvas.height / 2 + vesselHeight / 2;
                const minY = canvas.height / 2 - vesselHeight / 2;
                this.y = canvas.height / 2 + this.verticalPosition * vesselHeight / 2;
                this.y = Math.max(minY + this.radius, Math.min(maxY - this.radius, this.y));
            }

            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.fill();
            }
        }

        class BloodCell extends Particle {
            constructor() {
                super(
                    Math.random() * canvas.width,
                    canvas.height / 2 + (Math.random() - 0.5) * baseVesselHeight * 0.8,
                    'red',
                    3 + Math.random() * 2
                );
            }
        }

        class GlucoseParticle extends Particle {
            constructor() {
                super(
                    Math.random() * canvas.width,
                    canvas.height / 2 + (Math.random() - 0.5) * baseVesselHeight * 0.8,
                    'cyan',
                    2 + Math.random() * 1.5
                );
            }

            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.fill();
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 1;
                ctx.stroke();
            }
        }

        class Hormone extends Particle {
            constructor(x, color) {
                super(
                    x,
                    canvas.height / 2 + (Math.random() - 0.5) * baseVesselHeight * 0.8,
                    color,
                    4
                );
            }

            draw() {
                ctx.beginPath();
                ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = this.color;
                ctx.fill();
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 1;
                ctx.stroke();
            }
        }

        class Receptor {
            constructor(x, color, effect, name) {
                this.x = x;
                this.color = color;
                this.effect = effect;
                this.name = name;
                this.radius = 15;
                this.isFlashing = false;
                this.flashDuration = 500;
                this.flashStartTime = 0;
            }

            draw(vesselHeight) {
                const y = canvas.height / 2 - vesselHeight / 2 - this.radius;
                ctx.beginPath();
                ctx.arc(this.x, y, this.radius, 0, Math.PI * 2);
                ctx.fillStyle = this.isFlashing ? 'white' : this.color;
                ctx.fill();
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 2;
                ctx.stroke();

                ctx.font = '12px Arial';
                ctx.fillStyle = 'black';
                ctx.textAlign = 'center';
                ctx.fillText(this.name, this.x, y - this.radius - 5);
            }

            startFlashing() {
                this.isFlashing = true;
                this.flashStartTime = Date.now();
            }

            updateFlashing() {
                if (this.isFlashing && Date.now() - this.flashStartTime > this.flashDuration) {
                    this.isFlashing = false;
                }
            }

            scan(hormones, vesselHeight) {
                const vesselTop = canvas.height / 2 - vesselHeight / 2;
                const vesselBottom = canvas.height / 2 + vesselHeight / 2;
                
                for (let i = hormones.length - 1; i >= 0; i--) {
                    const hormone = hormones[i];
                    if (hormone.color === this.color && 
                        hormone.y >= vesselTop && 
                        hormone.y <= vesselBottom && 
                        Math.abs(hormone.x - this.x) < this.radius) {
                        this.startFlashing();
                        this.applyEffect();
                        return i;
                    }
                }
                return -1;
            }

            applyEffect() {
                if (this.name === 'Insulin') {
                    if (glucoseParticles.length > 0) {
                        glucoseParticles.pop();
                    }
                } else if (this.name === 'Glucagon') {
                    glucoseParticles.push(new GlucoseParticle());
                } else if (this.effect === 'increase') {
                    heartRate = Math.min(heartRate + 5, 145);
                    targetDilation = Math.min(targetDilation + 5, 150);
                } else if (this.effect === 'decrease') {
                    heartRate = Math.max(heartRate - 5, 55);
                    targetDilation = Math.max(targetDilation - 5, 50);
                }
                updateSliders();
            }
        }

        const receptors = glandReceptorPairs.map(pair => new Receptor(pair.position * canvas.width, pair.color, pair.effect, pair.name));

        function createBloodCells(count) {
            for (let i = 0; i < count; i++) {
                bloodCells.push(new BloodCell());
            }
        }

        function createGlucoseParticles(count) {
            for (let i = 0; i < count; i++) {
                glucoseParticles.push(new GlucoseParticle());
            }
        }

        function drawVessel(height) {
            ctx.beginPath();
            ctx.moveTo(0, canvas.height / 2 - height / 2);
            ctx.lineTo(canvas.width, canvas.height / 2 - height / 2);
            ctx.moveTo(0, canvas.height / 2 + height / 2);
            ctx.lineTo(canvas.width, canvas.height / 2 + height / 2);
            ctx.strokeStyle = 'purple';
            ctx.lineWidth = 10;
            ctx.stroke();
        }

        function drawGlands(vesselHeight) {
            const glandSize = 15;
            const glandOffset = 20;
            
            glandReceptorPairs.forEach(pair => {
                const x = pair.position * canvas.width + glandOffset;
                const y = canvas.height / 2 + vesselHeight / 2 + glandSize;

                ctx.beginPath();
                ctx.arc(x, y, glandSize, 0, Math.PI * 2);
                ctx.fillStyle = pair.color;
                ctx.fill();
                ctx.strokeStyle = 'black';
                ctx.lineWidth = 2;
                ctx.stroke();

                ctx.font = '12px Arial';
                ctx.fillStyle = 'black';
                ctx.textAlign = 'center';
                ctx.fillText(pair.name, x, y + glandSize + 15);
            });
        }

        function getSpeedMultiplier(heartRate) {
            const minRate = 55;
            const maxRate = 145;
            const minMultiplier = 0.5;
            const maxMultiplier = 2.5;
            return minMultiplier + (maxMultiplier - minMultiplier) * (heartRate - minRate) / (maxRate - minRate);
        }

        function updateSliders() {
            heartRateSlider.value = heartRate;
            heartRateValue.textContent = heartRate;
            dilationSlider.value = dilation;
            dilationValue.textContent = Math.round(dilation);
        }

        function animateDilation(deltaTime) {
            const dilationDiff = targetDilation - dilation;
            if (Math.abs(dilationDiff) > 0.1) {
                dilation += dilationDiff * 0.1;
            } else {
                dilation = targetDilation;
            }
            updateSliders();
        }

        function updateGlucoseGraph() {
            glucoseGraphCtx.clearRect(0, 0, glucoseGraphCanvas.width, glucoseGraphCanvas.height);

            // Draw axes labels
            glucoseGraphCtx.font = '14px Arial';
            glucoseGraphCtx.fillStyle = 'black';
            glucoseGraphCtx.fillText('Blood Sugar', 10, 20);  // Y-axis label
            glucoseGraphCtx.fillText('Minutes', glucoseGraphCanvas.width - 60, glucoseGraphCanvas.height - 10);  // X-axis label

            glucoseGraphCtx.beginPath();
            glucoseGraphCtx.moveTo(0, glucoseGraphCanvas.height);
            glucoseLevels.forEach((level, index) => {
                const x = (index / maxTime) * glucoseGraphCanvas.width;
                const y = glucoseGraphCanvas.height - (level / 100 * glucoseGraphCanvas.height);  // Scale glucose level
                glucoseGraphCtx.lineTo(x, y);
            });
            glucoseGraphCtx.lineTo(glucoseGraphCanvas.width, glucoseGraphCanvas.height);  // Close the area
            glucoseGraphCtx.fillStyle = 'rgba(0, 255, 255, 0.4)';
            glucoseGraphCtx.fill();
        }

        function recordGlucoseLevel() {
            glucoseLevels.push(glucoseParticles.length);
            if (glucoseLevels.length > maxTime) {
                glucoseLevels.shift();  // Keep the data for the last 30 seconds
            }
            updateGlucoseGraph();
        }

        function adjustGlucoseUsage(deltaTime) {
            glucoseTimeElapsed += deltaTime;
            if (glucoseTimeElapsed >= glucoseUsageInterval) {
                // Remove glucose based on heart rate
                let glucoseToRemove = 1;  // Default for low heart rate
                const maxRate = 145;
                const minRate = 55;
                const maxGlucoseRemoval = 2;  // Max glucose dots to remove at max heart rate

                if (heartRate > minRate) {
                    const rateFactor = (heartRate - minRate) / (maxRate - minRate);
                    glucoseToRemove = 1 + rateFactor * (maxGlucoseRemoval - 1);  // Scale glucose removal
                }

                glucoseToRemove = Math.min(glucoseToRemove, glucoseParticles.length);  // Ensure not to remove more than available
                for (let i = 0; i < glucoseToRemove; i++) {
                    if (glucoseParticles.length > 0) {
                        glucoseParticles.pop();
                    }
                }

                glucoseTimeElapsed = 0;
            }
        }

        function update(timestamp) {
            const deltaTime = timestamp - lastTimestamp;
            lastTimestamp = timestamp;

            ctx.clearRect(0, 0, canvas.width, canvas.height);

            animateDilation(deltaTime);

            const vesselHeight = baseVesselHeight * dilation / 100;
            drawVessel(vesselHeight);
            drawGlands(vesselHeight);

            const pulsePeriod = 60000 / heartRate;
            const pulseProgress = (timestamp % pulsePeriod) / pulsePeriod;
            
            pulseIntensity = Math.sin(pulseProgress * Math.PI) ** 2;

            const speedMultiplier = getSpeedMultiplier(heartRate);

            bloodCells.forEach(cell => {
                cell.update(deltaTime, pulseIntensity, vesselHeight, speedMultiplier);
                cell.draw();
            });

            glucoseParticles.forEach(particle => {
                particle.update(deltaTime, pulseIntensity, vesselHeight, speedMultiplier);
                particle.draw();
            });

            hormones.forEach(hormone => {
                hormone.update(deltaTime, pulseIntensity, vesselHeight, speedMultiplier);
                hormone.draw();
            });

            receptors.forEach(receptor => {
                const detectedHormoneIndex = receptor.scan(hormones, vesselHeight);
                if (detectedHormoneIndex !== -1) {
                    hormones.splice(detectedHormoneIndex, 1);
                }
                receptor.updateFlashing();
                receptor.draw(vesselHeight);
            });

            adjustGlucoseUsage(deltaTime);

            timeElapsed += deltaTime;
            if (timeElapsed >= 1000) {  // Record glucose level every second
                recordGlucoseLevel();
                timeElapsed = 0;
            }

            requestAnimationFrame(update);
        }

        function isClickOnGland(x, y, glandX, glandY, glandSize) {
            return Math.sqrt((x - glandX) ** 2 + (y - glandY) ** 2) <= glandSize;
        }

        canvas.addEventListener('click', (event) => {
            const rect = canvas.getBoundingClientRect();
            const x = event.clientX - rect.left;
            const y = event.clientY - rect.top;
            const vesselHeight = baseVesselHeight * dilation / 100;
            const glandSize = 15;
            const glandOffset = 20;

            glandReceptorPairs.forEach(pair => {
                const glandX = pair.position * canvas.width + glandOffset;
                const glandY = canvas.height / 2 + vesselHeight / 2 + glandSize;

                if (isClickOnGland(x, y, glandX, glandY, glandSize)) {
                    hormones.push(new Hormone(glandX, pair.color));
                }
            });
        });

        heartRateSlider.addEventListener('input', (e) => {
            heartRate = parseInt(e.target.value);
            heartRateValue.textContent = heartRate;
        });

        dilationSlider.addEventListener('input', (e) => {
            targetDilation = parseInt(e.target.value);
            dilationValue.textContent = Math.round(dilation);
        });

        createBloodCells(100);
        createGlucoseParticles(50);
        requestAnimationFrame(update);
    </script>
</body>
</html>
