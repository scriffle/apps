<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Container Return Program</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .header h1 {
            color: #27ae60;
            font-size: 2.5rem;
            margin-bottom: 10px;
        }

        .header p {
            color: #718096;
            font-size: 1.1rem;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            justify-content: center;
        }

        .tab {
            background: rgba(255, 255, 255, 0.9);
            border: none;
            padding: 15px 30px;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1rem;
            font-weight: 600;
            transition: all 0.3s ease;
            color: #4a5568;
        }

        .tab:hover {
            background: rgba(255, 255, 255, 1);
            transform: translateY(-2px);
        }

        .tab.active {
            background: #27ae60;
            color: white;
            box-shadow: 0 4px 15px rgba(39, 174, 96, 0.4);
        }

        .content {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            min-height: 500px;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Scanning Mode Styles */
        .scanning-layout {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 300px);
            min-height: 400px;
        }

        .scanning-top {
            flex-shrink: 0;
        }

        .scan-status {
            text-align: center;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        .current-person {
            background: rgba(39, 174, 96, 0.1);
            border: 2px solid #27ae60;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            text-align: center;
        }

        .current-person h3 {
            color: #27ae60;
            margin-bottom: 10px;
        }

        .current-person .name {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2d3748;
        }

        .current-person .stats {
            display: flex;
            justify-content: center;
            gap: 30px;
            margin-top: 15px;
        }

        .current-person .stat {
            text-align: center;
        }

        .current-person .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: #27ae60;
        }

        .current-person .stat-label {
            color: #718096;
            font-size: 0.9rem;
        }

        .house-badge {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            color: white;
            margin-left: 10px;
        }

        .house-yellow { background: #f1c40f; }
        .house-green { background: #27ae60; }
        .house-blue { background: #3498db; }
        .house-red { background: #e74c3c; }

        .recent-scans-container {
            flex: 1;
            display: flex;
            flex-direction: column;
            min-height: 0;
        }

        .recent-scans {
            flex: 1;
            overflow-y: auto;
            border: 2px solid #e2e8f0;
            border-radius: 10px;
            padding: 20px;
        }

        .scan-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 8px;
            background: #f7fafc;
            border-left: 4px solid #3498db;
        }

        .scan-item.person {
            border-left-color: #27ae60;
            background: #f0fff4;
        }

        .scan-item.container {
            border-left-color: #3498db;
            background: #ebf8ff;
        }

        .scan-item.invalid {
            border-left-color: #e74c3c;
            background: #fff5f5;
            opacity: 0.7;
        }

        .inline-learn {
            background: #fff3cd;
            border: 2px solid #ffc107;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .inline-learn h4 {
            color: #856404;
            margin-bottom: 15px;
        }

        .inline-options {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin-bottom: 15px;
        }

        .btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:hover {
            background: #229954;
            transform: translateY(-2px);
        }

        .btn.secondary {
            background: #718096;
        }

        .btn.secondary:hover {
            background: #4a5568;
        }

        .btn.primary {
            background: #3498db;
        }

        .btn.primary:hover {
            background: #2980b9;
        }

        .btn-small {
            padding: 6px 12px;
            font-size: 0.9rem;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            font-weight: 600;
            color: #4a5568;
            margin-bottom: 5px;
        }

        .form-group input,
        .form-group select {
            width: 100%;
            padding: 10px;
            border: 2px solid #e2e8f0;
            border-radius: 8px;
            font-size: 1rem;
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: #3498db;
        }

        .form-inline {
            display: flex;
            gap: 10px;
            align-items: flex-end;
        }

        .form-inline .form-group {
            flex: 1;
        }

        /* Statistics Styles */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
            padding: 20px;
            border-radius: 12px;
            text-align: center;
        }

        .stat-card h3 {
            font-size: 2.5rem;
            margin-bottom: 5px;
        }

        .stat-card p {
            opacity: 0.9;
        }

        .leaderboard {
            background: #f7fafc;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
        }

        .leaderboard h3 {
            margin-bottom: 15px;
            color: #2d3748;
        }

        .leaderboard-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            margin-bottom: 8px;
            background: white;
            border-radius: 8px;
            border: 1px solid #e2e8f0;
        }

        .leaderboard-item:nth-child(1) {
            background: linear-gradient(135deg, #ffd700, #ffed4e);
            border: none;
        }

        .leaderboard-item:nth-child(2) {
            background: linear-gradient(135deg, #c0c0c0, #e8e8e8);
            border: none;
        }

        .leaderboard-item:nth-child(3) {
            background: linear-gradient(135deg, #cd7f32, #daa520);
            border: none;
        }

        .rank {
            font-weight: bold;
            font-size: 1.2rem;
            width: 30px;
        }

        /* Management Styles */
        .management-controls {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .data-grid {
            display: grid;
            gap: 20px;
            max-height: 500px;
            overflow-y: auto;
        }

        .data-card {
            background: #f7fafc;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
        }

        .data-card h4 {
            color: #2d3748;
            margin-bottom: 10px;
        }

        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .undo-redo {
            position: fixed;
            bottom: 20px;
            right: 20px;
            display: flex;
            gap: 10px;
            z-index: 1000;
        }

        .undo-redo button {
            background: #333;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }

        .undo-redo button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .undo-redo button:hover:not(:disabled) {
            transform: scale(1.1);
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }
            
            .header h1 {
                font-size: 1.8rem;
            }
            
            .tabs {
                flex-wrap: wrap;
            }
            
            .tab {
                padding: 10px 20px;
                font-size: 0.9rem;
            }
            
            .content {
                padding: 20px;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚ôªÔ∏è Container Return Program</h1>
            <p>School Recycling Initiative</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('scanning')">üì± Scanning</button>
            <button class="tab" onclick="switchTab('statistics')">üìä Statistics</button>
            <button class="tab" onclick="switchTab('management')">‚öôÔ∏è Management</button>
        </div>

        <div class="content">
            <!-- Scanning Tab -->
            <div id="scanning" class="tab-content active">
                <div class="scanning-layout">
                    <div class="scanning-top">
                        <div class="scan-status" id="scanStatus">
                            Ready to scan - Start by scanning a person
                        </div>

                        <div class="current-person" id="currentPerson" style="display: none;">
                            <h3>Current Returner</h3>
                            <div class="name">
                                <span id="currentPersonName"></span>
                                <span id="currentPersonHouse" class="house-badge"></span>
                            </div>
                            <div class="stats">
                                <div class="stat">
                                    <div class="stat-value" id="sessionCount">0</div>
                                    <div class="stat-label">This Session</div>
                                </div>
                                <div class="stat">
                                    <div class="stat-value" id="totalCount">0</div>
                                    <div class="stat-label">Total Returns</div>
                                </div>
                            </div>
                        </div>

                        <div class="inline-learn" id="inlineLearn" style="display: none;">
                            <h4>Unknown Barcode: <span id="unknownBarcode"></span></h4>
                            <div class="inline-options">
                                <button class="btn primary" onclick="startLearnPerson()">üë§ Add as Person</button>
                                <button class="btn primary" onclick="startLearnContainer()">üì¶ Add as Container</button>
                                <button class="btn secondary" onclick="cancelLearn()">Cancel</button>
                            </div>
                            <div id="learnForm"></div>
                        </div>
                    </div>

                    <div class="recent-scans-container">
                        <h3 style="margin-bottom: 15px;">Recent Scans</h3>
                        <div class="recent-scans" id="recentScans">
                            <p style="text-align: center; color: #718096; font-style: italic;">No scans yet</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Statistics Tab -->
            <div id="statistics" class="tab-content">
                <div class="stats-grid">
                    <div class="stat-card">
                        <h3 id="totalContainers">0</h3>
                        <p>Total Containers</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="totalPeople">0</h3>
                        <p>Active Participants</p>
                    </div>
                    <div class="stat-card">
                        <h3 id="todayContainers">0</h3>
                        <p>Today's Returns</p>
                    </div>
                </div>

                <div class="leaderboard">
                    <h3>üèÜ House Standings</h3>
                    <div id="houseLeaderboard"></div>
                </div>

                <div class="leaderboard">
                    <h3>üåü Top Returners</h3>
                    <div id="personLeaderboard"></div>
                </div>

                <div class="leaderboard">
                    <h3>üìÖ Daily Statistics</h3>
                    <div id="dailyStats"></div>
                </div>
            </div>

            <!-- Management Tab -->
            <div id="management" class="tab-content">
                <div class="management-controls">
                    <button class="btn" onclick="exportData()">üì§ Export CSV</button>
                    <button class="btn secondary" onclick="document.getElementById('importFile').click()">üì• Import CSV</button>
                    <input type="file" id="importFile" style="display: none;" accept=".csv" onchange="importData(event)">
                    <button class="btn secondary" onclick="clearData()">üóëÔ∏è Clear All Data</button>
                </div>

                <h3 style="margin-bottom: 15px;">People Database</h3>
                <div class="data-grid" id="peopleGrid"></div>

                <h3 style="margin: 20px 0 15px 0;">Container Database</h3>
                <div class="data-grid" id="containersGrid"></div>
            </div>
        </div>
    </div>

    <div class="undo-redo">
        <button id="undoBtn" onclick="performUndo()" title="Undo" disabled>‚Ü∂</button>
        <button id="redoBtn" onclick="performRedo()" title="Redo" disabled>‚Ü∑</button>
    </div>

    <audio id="beepSound" preload="auto">
        <source src="data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+D...." type="audio/wav">
    </audio>

    <script>
        // Global state
        let people = new Map(); // barcode -> {forename, surname, house, returns: [{containerId, timestamp}]}
        let containers = new Map(); // barcode -> {description, valid}
        let currentPerson = null;
        let sessionReturns = new Map(); // personId -> count for this session
        let scanBuffer = '';
        let scanTimeout = null;
        let unknownBarcode = null;
        
        // Undo/Redo system
        let actionHistory = [];
        let historyIndex = -1;
        const MAX_HISTORY = 100;

        // Initialize
        function init() {
            loadSampleData();
            updateStatistics();
            updateUndoRedoButtons();
            
            // Set up barcode scanning
            document.addEventListener('keydown', handleKeyDown);
        }

        function loadSampleData() {
            // Sample people
            people.set('1234567890', {
                forename: 'John',
                surname: 'Smith',
                house: 'Blue',
                returns: []
            });
            people.set('0987654321', {
                forename: 'Emma',
                surname: 'Wilson',
                house: 'Red',
                returns: []
            });
            
            // Sample containers
            containers.set('5449000000996', {
                description: 'Coca-Cola Can 330ml',
                valid: true
            });
            containers.set('5000112546415', {
                description: 'Pepsi Bottle 500ml',
                valid: true
            });
        }

        // Barcode scanning
        function handleKeyDown(event) {
            // Ignore if typing in input
            if (event.target.tagName === 'INPUT' || event.target.tagName === 'TEXTAREA') {
                return;
            }

            if (scanTimeout) {
                clearTimeout(scanTimeout);
            }

            if (event.key === 'Enter' && scanBuffer.length > 0) {
                event.preventDefault();
                processScan(scanBuffer.trim());
                scanBuffer = '';
                return;
            }

            if (event.key.length === 1) {
                scanBuffer += event.key;
                updateScanStatus('Scanning...');
            }

            scanTimeout = setTimeout(() => {
                if (scanBuffer.length > 0) {
                    processScan(scanBuffer.trim());
                }
                scanBuffer = '';
            }, 500);
        }

        function processScan(barcode) {
            if (!barcode) return;
            
            playBeep();
            
            // Check if it's a known person
            if (people.has(barcode)) {
                recordAction('scanPerson', { barcode });
                handlePersonScan(barcode);
                return;
            }
            
            // Check if it's a known container
            if (containers.has(barcode)) {
                recordAction('scanContainer', { barcode, personId: currentPerson });
                handleContainerScan(barcode);
                return;
            }
            
            // Unknown barcode
            handleUnknownScan(barcode);
        }

        function handlePersonScan(barcode) {
            const person = people.get(barcode);
            if (!person) {
                console.error(`Person not found for barcode: ${barcode}`);
                return;
            }
            
            currentPerson = barcode;
            
            // Reset session count for new person
            if (!sessionReturns.has(barcode)) {
                sessionReturns.set(barcode, 0);
            }
            
            // Update UI
            document.getElementById('currentPerson').style.display = 'block';
            document.getElementById('currentPersonName').textContent = `${person.forename} ${person.surname}`;
            document.getElementById('currentPersonHouse').textContent = person.house;
            document.getElementById('currentPersonHouse').className = `house-badge house-${person.house.toLowerCase()}`;
            document.getElementById('sessionCount').textContent = sessionReturns.get(barcode);
            document.getElementById('totalCount').textContent = person.returns.length;
            
            updateScanStatus(`Scanning for ${person.forename} ${person.surname}`);
            addRecentScan('person', `${person.forename} ${person.surname}`, person.house);
        }

        function handleContainerScan(barcode) {
            if (!currentPerson) {
                updateScanStatus('Please scan a person first');
                return;
            }
            
            const container = containers.get(barcode);
            const person = people.get(currentPerson);
            
            if (!container || !person) {
                console.error('Container or person not found');
                return;
            }
            
            if (container.valid) {
                // Add to person's returns
                person.returns.push({
                    containerId: barcode,
                    timestamp: new Date().toISOString()
                });
                
                // Update session count
                sessionReturns.set(currentPerson, sessionReturns.get(currentPerson) + 1);
                
                // Update UI
                document.getElementById('sessionCount').textContent = sessionReturns.get(currentPerson);
                document.getElementById('totalCount').textContent = person.returns.length;
                
                addRecentScan('container', container.description, 'Valid');
                updateStatistics();
            } else {
                addRecentScan('invalid', container.description, 'Invalid');
            }
            
            updateScanStatus(`Scanned: ${container.description}`);
        }

        function handleUnknownScan(barcode) {
            unknownBarcode = barcode;
            document.getElementById('unknownBarcode').textContent = barcode;
            document.getElementById('inlineLearn').style.display = 'block';
            updateScanStatus('Unknown barcode - please classify');
        }

        function startLearnPerson() {
            const form = document.getElementById('learnForm');
            form.innerHTML = `
                <div class="form-inline">
                    <div class="form-group">
                        <label>Forename</label>
                        <input type="text" id="learnForename" placeholder="First name">
                    </div>
                    <div class="form-group">
                        <label>Surname</label>
                        <input type="text" id="learnSurname" placeholder="Last name">
                    </div>
                    <div class="form-group">
                        <label>House</label>
                        <select id="learnHouse">
                            <option value="Yellow">Yellow</option>
                            <option value="Green">Green</option>
                            <option value="Blue">Blue</option>
                            <option value="Red">Red</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button class="btn" onclick="savePerson()">Save Person</button>
                    </div>
                </div>
            `;
            document.getElementById('learnForename').focus();
        }

        function startLearnContainer() {
            const form = document.getElementById('learnForm');
            form.innerHTML = `
                <div class="form-inline">
                    <div class="form-group" style="flex: 2;">
                        <label>Description</label>
                        <input type="text" id="learnDescription" placeholder="e.g., Coca-Cola Can 330ml">
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <div class="checkbox-label">
                            <input type="checkbox" id="learnValid" checked>
                            <label for="learnValid">Valid Container</label>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>&nbsp;</label>
                        <button class="btn" onclick="saveContainer()">Save Container</button>
                    </div>
                </div>
            `;
            document.getElementById('learnDescription').focus();
        }

        function savePerson() {
            const forename = document.getElementById('learnForename').value.trim();
            const surname = document.getElementById('learnSurname').value.trim();
            const house = document.getElementById('learnHouse').value;
            
            if (!forename || !surname) {
                alert('Please enter both forename and surname');
                return;
            }
            
            if (!unknownBarcode) {
                console.error('No barcode to save');
                return;
            }
            
            const personData = {
                forename,
                surname,
                house,
                returns: []
            };
            
            recordAction('addPerson', {
                barcode: unknownBarcode,
                data: personData
            });
            
            people.set(unknownBarcode, personData);
            
            // Store the barcode before canceling
            const barcodeToScan = unknownBarcode;
            
            cancelLearn();
            handlePersonScan(barcodeToScan);
            updateManagementView();
        }

        function saveContainer() {
            const description = document.getElementById('learnDescription').value.trim();
            const valid = document.getElementById('learnValid').checked;
            
            if (!description) {
                alert('Please enter a description');
                return;
            }
            
            if (!unknownBarcode) {
                console.error('No barcode to save');
                return;
            }
            
            const containerData = {
                description,
                valid
            };
            
            recordAction('addContainer', {
                barcode: unknownBarcode,
                data: containerData
            });
            
            containers.set(unknownBarcode, containerData);
            
            // Store the barcode before canceling
            const barcodeToScan = unknownBarcode;
            
            cancelLearn();
            if (currentPerson) {
                handleContainerScan(barcodeToScan);
            }
            updateManagementView();
        }

        function cancelLearn() {
            document.getElementById('inlineLearn').style.display = 'none';
            document.getElementById('learnForm').innerHTML = '';
            unknownBarcode = null;
            
            let statusMessage = 'Ready to scan - Start by scanning a person';
            if (currentPerson && people.has(currentPerson)) {
                const person = people.get(currentPerson);
                if (person) {
                    statusMessage = `Scanning for ${person.forename} ${person.surname}`;
                }
            }
            updateScanStatus(statusMessage);
        }

        function addRecentScan(type, name, extra) {
            const recentScans = document.getElementById('recentScans');
            
            if (recentScans.firstChild && recentScans.firstChild.tagName === 'P') {
                recentScans.innerHTML = '';
            }
            
            const scanItem = document.createElement('div');
            scanItem.className = `scan-item ${type}`;
            scanItem.innerHTML = `
                <div>
                    <strong>${name}</strong>
                    <div style="font-size: 0.8rem; color: #718096;">${new Date().toLocaleTimeString()}</div>
                </div>
                <div>${extra}</div>
            `;
            
            recentScans.insertBefore(scanItem, recentScans.firstChild);
            
            // Keep only last 20 scans
            while (recentScans.children.length > 20) {
                recentScans.removeChild(recentScans.lastChild);
            }
        }

        function updateScanStatus(message) {
            document.getElementById('scanStatus').textContent = message;
        }

        function playBeep() {
            try {
                const audio = document.getElementById('beepSound');
                audio.currentTime = 0;
                audio.play().catch(() => {});
            } catch (e) {}
        }

        // Statistics functions
        function updateStatistics() {
            // Total containers (valid only)
            let totalContainers = 0;
            people.forEach(person => {
                person.returns.forEach(ret => {
                    if (containers.has(ret.containerId) && containers.get(ret.containerId).valid) {
                        totalContainers++;
                    }
                });
            });
            document.getElementById('totalContainers').textContent = totalContainers;
            
            // Total people
            document.getElementById('totalPeople').textContent = people.size;
            
            // Today's returns
            const today = new Date().toDateString();
            let todayCount = 0;
            people.forEach(person => {
                person.returns.forEach(ret => {
                    if (new Date(ret.timestamp).toDateString() === today && 
                        containers.has(ret.containerId) && 
                        containers.get(ret.containerId).valid) {
                        todayCount++;
                    }
                });
            });
            document.getElementById('todayContainers').textContent = todayCount;
            
            // Update leaderboards
            updateHouseLeaderboard();
            updatePersonLeaderboard();
            updateDailyStats();
        }

        function updateHouseLeaderboard() {
            const houses = { Yellow: 0, Green: 0, Blue: 0, Red: 0 };
            
            people.forEach(person => {
                const validReturns = person.returns.filter(ret => 
                    containers.has(ret.containerId) && containers.get(ret.containerId).valid
                ).length;
                houses[person.house] += validReturns;
            });
            
            const sorted = Object.entries(houses)
                .sort((a, b) => b[1] - a[1])
                .filter(([_, count]) => count > 0);
            
            const leaderboard = document.getElementById('houseLeaderboard');
            leaderboard.innerHTML = sorted.map((item, index) => `
                <div class="leaderboard-item">
                    <div>
                        <span class="rank">#${index + 1}</span>
                        <span>${item[0]}</span>
                    </div>
                    <strong>${item[1]} containers</strong>
                </div>
            `).join('');
            
            if (sorted.length === 0) {
                leaderboard.innerHTML = '<p style="text-align: center; color: #718096;">No returns yet</p>';
            }
        }

        function updatePersonLeaderboard() {
            const personStats = [];
            
            people.forEach((person, barcode) => {
                const validReturns = person.returns.filter(ret => 
                    containers.has(ret.containerId) && containers.get(ret.containerId).valid
                ).length;
                
                if (validReturns > 0) {
                    personStats.push({
                        name: `${person.forename} ${person.surname}`,
                        house: person.house,
                        count: validReturns
                    });
                }
            });
            
            personStats.sort((a, b) => b.count - a.count);
            
            const leaderboard = document.getElementById('personLeaderboard');
            leaderboard.innerHTML = personStats.slice(0, 10).map((person, index) => `
                <div class="leaderboard-item">
                    <div>
                        <span class="rank">#${index + 1}</span>
                        <span>${person.name}</span>
                        <span class="house-badge house-${person.house.toLowerCase()}">${person.house}</span>
                    </div>
                    <strong>${person.count} containers</strong>
                </div>
            `).join('');
            
            if (personStats.length === 0) {
                leaderboard.innerHTML = '<p style="text-align: center; color: #718096;">No returns yet</p>';
            }
        }

        function updateDailyStats() {
            const dailyStats = new Map();
            
            people.forEach(person => {
                person.returns.forEach(ret => {
                    if (containers.has(ret.containerId) && containers.get(ret.containerId).valid) {
                        const date = new Date(ret.timestamp).toLocaleDateString();
                        dailyStats.set(date, (dailyStats.get(date) || 0) + 1);
                    }
                });
            });
            
            const sorted = Array.from(dailyStats.entries())
                .sort((a, b) => new Date(b[0]) - new Date(a[0]))
                .slice(0, 7);
            
            const statsDiv = document.getElementById('dailyStats');
            statsDiv.innerHTML = sorted.map(([date, count]) => `
                <div class="leaderboard-item">
                    <span>${date}</span>
                    <strong>${count} containers</strong>
                </div>
            `).join('');
            
            if (sorted.length === 0) {
                statsDiv.innerHTML = '<p style="text-align: center; color: #718096;">No returns yet</p>';
            }
        }

        // Management functions
        function updateManagementView() {
            // Update people grid
            const peopleGrid = document.getElementById('peopleGrid');
            peopleGrid.innerHTML = Array.from(people.entries()).map(([barcode, person]) => `
                <div class="data-card">
                    <h4>${person.forename} ${person.surname}</h4>
                    <p>Barcode: ${barcode}</p>
                    <p>House: <span class="house-badge house-${person.house.toLowerCase()}">${person.house}</span></p>
                    <p>Total Returns: ${person.returns.filter(r => containers.has(r.containerId) && containers.get(r.containerId).valid).length}</p>
                </div>
            `).join('');
            
            // Update containers grid
            const containersGrid = document.getElementById('containersGrid');
            containersGrid.innerHTML = Array.from(containers.entries()).map(([barcode, container]) => `
                <div class="data-card">
                    <h4>${container.description}</h4>
                    <p>Barcode: ${barcode}</p>
                    <p>Status: ${container.valid ? '‚úÖ Valid' : '‚ùå Invalid'}</p>
                </div>
            `).join('');
        }

        // Undo/Redo system
        function recordAction(type, data) {
            // Remove any actions after current index
            actionHistory = actionHistory.slice(0, historyIndex + 1);
            
            // Add new action
            actionHistory.push({
                type,
                data,
                timestamp: new Date().toISOString()
            });
            
            // Limit history size
            if (actionHistory.length > MAX_HISTORY) {
                actionHistory.shift();
            } else {
                historyIndex++;
            }
            
            updateUndoRedoButtons();
        }

        function performUndo() {
            if (historyIndex < 0) return;
            
            const action = actionHistory[historyIndex];
            
            switch (action.type) {
                case 'scanPerson':
                    // Can't really undo person selection
                    break;
                    
                case 'scanContainer':
                    if (action.data.personId && people.has(action.data.personId)) {
                        const person = people.get(action.data.personId);
                        person.returns.pop();
                        sessionReturns.set(action.data.personId, 
                            Math.max(0, sessionReturns.get(action.data.personId) - 1));
                    }
                    break;
                    
                case 'addPerson':
                    people.delete(action.data.barcode);
                    break;
                    
                case 'addContainer':
                    containers.delete(action.data.barcode);
                    break;
            }
            
            historyIndex--;
            updateUndoRedoButtons();
            updateStatistics();
            updateManagementView();
            
            // Update current person display if needed
            if (currentPerson && people.has(currentPerson)) {
                const person = people.get(currentPerson);
                if (person) {
                    document.getElementById('sessionCount').textContent = sessionReturns.get(currentPerson) || 0;
                    document.getElementById('totalCount').textContent = person.returns.length;
                }
            }
        }

        function performRedo() {
            if (historyIndex >= actionHistory.length - 1) return;
            
            historyIndex++;
            const action = actionHistory[historyIndex];
            
            switch (action.type) {
                case 'scanPerson':
                    handlePersonScan(action.data.barcode);
                    break;
                    
                case 'scanContainer':
                    if (action.data.personId) {
                        const currentPersonData = people.get(action.data.personId);
                        if (currentPersonData) {
                            currentPerson = action.data.personId;
                            handleContainerScan(action.data.barcode);
                        }
                    }
                    break;
                    
                case 'addPerson':
                    people.set(action.data.barcode, action.data.data);
                    break;
                    
                case 'addContainer':
                    containers.set(action.data.barcode, action.data.data);
                    break;
            }
            
            updateUndoRedoButtons();
            updateStatistics();
            updateManagementView();
        }

        function updateUndoRedoButtons() {
            document.getElementById('undoBtn').disabled = historyIndex < 0;
            document.getElementById('redoBtn').disabled = historyIndex >= actionHistory.length - 1;
        }

        // Import/Export functions
        function exportData() {
            const data = [];
            
            // Export people
            people.forEach((person, barcode) => {
                data.push({
                    Type: 'Person',
                    Barcode: barcode,
                    Forename: person.forename,
                    Surname: person.surname,
                    House: person.house,
                    Description: '',
                    Valid: '',
                    Returns: JSON.stringify(person.returns)
                });
            });
            
            // Export containers
            containers.forEach((container, barcode) => {
                data.push({
                    Type: 'Container',
                    Barcode: barcode,
                    Forename: '',
                    Surname: '',
                    House: '',
                    Description: container.description,
                    Valid: container.valid ? 'Yes' : 'No',
                    Returns: ''
                });
            });
            
            const csv = Papa.unparse(data);
            const blob = new Blob([csv], { type: 'text/csv' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `container_returns_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
        }

        function importData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            Papa.parse(file, {
                header: true,
                complete: function(results) {
                    let importedPeople = 0;
                    let importedContainers = 0;
                    
                    results.data.forEach(row => {
                        if (row.Type === 'Person' && row.Barcode) {
                            people.set(row.Barcode, {
                                forename: row.Forename || '',
                                surname: row.Surname || '',
                                house: row.House || 'Yellow',
                                returns: row.Returns ? JSON.parse(row.Returns) : []
                            });
                            importedPeople++;
                        } else if (row.Type === 'Container' && row.Barcode) {
                            containers.set(row.Barcode, {
                                description: row.Description || '',
                                valid: row.Valid === 'Yes'
                            });
                            importedContainers++;
                        }
                    });
                    
                    updateStatistics();
                    updateManagementView();
                    alert(`Imported ${importedPeople} people and ${importedContainers} containers`);
                }
            });
            
            event.target.value = '';
        }

        function clearData() {
            if (confirm('Are you sure you want to clear all data? This cannot be undone.')) {
                people.clear();
                containers.clear();
                sessionReturns.clear();
                currentPerson = null;
                actionHistory = [];
                historyIndex = -1;
                
                document.getElementById('currentPerson').style.display = 'none';
                document.getElementById('recentScans').innerHTML = 
                    '<p style="text-align: center; color: #718096; font-style: italic;">No scans yet</p>';
                
                updateStatistics();
                updateManagementView();
                updateUndoRedoButtons();
                updateScanStatus('Ready to scan - Start by scanning a person');
            }
        }

        // Tab switching
        function switchTab(tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            event.target.classList.add('active');
            
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            
            if (tabName === 'statistics') {
                updateStatistics();
            } else if (tabName === 'management') {
                updateManagementView();
            }
        }

        // Initialize on load
        window.addEventListener('load', init);
    </script>
</body>
</html>