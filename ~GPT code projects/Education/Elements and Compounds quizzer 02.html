<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Element Compound Lattice Quizzer</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      background: linear-gradient(135deg, #f6d365, #fda085);
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color: #333;
      text-align: center;
    }
    #app {
      max-width: 600px;
      margin: 10px auto;
      background: #fff;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.1);
      padding: 15px;
      transition: background-color 0.5s ease;
    }
    h1 {
      font-size: 2em;
      margin-bottom: 10px;
    }
    #scoreboard {
      margin-bottom: 10px;
      font-size: 1em;
    }
    #question {
      margin-bottom: 10px;
    }
    #question h2 {
      font-size: 1.8em;
      margin-bottom: 5px;
    }
    #formula {
      font-size: 1.2em;
      margin-bottom: 8px;
    }
    #diagram {
      background: #f9f9f9;
      border: 1px solid #ccc;
      margin: 0 auto 10px auto;
      display: block;
    }
    #choices {
      margin-bottom: 10px;
    }
    .choice {
      background: #4A90E2;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 1em;
      padding: 8px 12px;
      margin: 3px;
      cursor: pointer;
      transition: background 0.3s, border 0.3s;
    }
    .choice:hover:not([disabled]) {
      background: #357ABD;
    }
    /* Highlight for correct answer if a wrong answer was chosen */
    .correct-choice {
      border: 3px solid #7ED321 !important;
      background-color: #dfffd9 !important;
      color: #000 !important;
    }
    #feedback {
      font-size: 1.2em;
      margin-bottom: 10px;
      height: 1.5em;
    }
    #nextBtn, #jokeBtn {
      background: #7ED321;
      color: white;
      border: none;
      border-radius: 5px;
      font-size: 1em;
      padding: 8px 15px;
      cursor: pointer;
      transition: background 0.3s;
      margin: 5px;
    }
    #nextBtn:hover:not([disabled]), #jokeBtn:hover:not([disabled]) {
      background: #5BA91B;
    }
    #nextBtn:disabled, #jokeBtn:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    /* Fade-in and fade-out animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeOut {
      from { opacity: 1; transform: translateY(0); }
      to { opacity: 0; transform: translateY(10px); }
    }
    /* Modal styling */
    .modal {
      display: none; 
      position: fixed; 
      z-index: 1000; 
      left: 0;
      top: 0;
      width: 100%; 
      height: 100%; 
      overflow: hidden; 
      background-color: rgba(0,0,0,0.5);
    }
    .modal-content {
      background-color: #fff;
      margin: 15% auto;
      padding: 20px;
      border-radius: 10px;
      width: 80%;
      max-width: 400px;
      text-align: center;
      position: relative;
    }
    .close {
      position: absolute;
      right: 10px;
      top: 5px;
      font-size: 28px;
      font-weight: bold;
      color: #333;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <div id="app">
    <h1>Element Compound Lattice Quizzer</h1>
    <div id="scoreboard">
      Correct: <span id="correct">0</span> | 
      Incorrect: <span id="incorrect">0</span> | 
      Percentage: <span id="percentage">0%</span> | 
      Streak: <span id="streak">0</span>
    </div>
    <div id="question">
      <h2 id="substanceName"></h2>
      <p id="formula"></p>
      <svg id="diagram" width="300" height="200"></svg>
    </div>
    <div id="choices">
      <button class="choice" data-choice="Element">Element</button>
      <button class="choice" data-choice="Elemental Molecule">Elemental Molecule</button>
      <button class="choice" data-choice="Compound Molecule">Compound Molecule</button>
      <button class="choice" data-choice="Lattice">Lattice</button>
      <button class="choice" data-choice="Compound Lattice">Compound Lattice</button>
    </div>
    <div id="feedback"></div>
    <button id="nextBtn" disabled>Next</button>
    <button id="jokeBtn" disabled>Joke pls</button>
  </div>

  <!-- Joke Modal -->
  <div id="jokeModal" class="modal">
    <div class="modal-content">
      <span id="closeModal" class="close">&times;</span>
      <p id="jokeSetup" style="font-weight: bold;"></p>
      <button id="revealPunchline">Show me</button>
      <p id="jokePunchline" style="display: none; margin-top: 10px;"></p>
    </div>
  </div>

  <script>
    // List of 30 substances
    const substances = [
      { name: "Helium", formula: "He", category: "Element" },
      { name: "Neon", formula: "Ne", category: "Element" },
      { name: "Argon", formula: "Ar", category: "Element" },
      { name: "Hydrogen", formula: "H₂", category: "Elemental Molecule" },
      { name: "Oxygen", formula: "O₂", category: "Elemental Molecule" },
      { name: "Nitrogen", formula: "N₂", category: "Elemental Molecule" },
      { name: "Phosphorus", formula: "P₄", category: "Elemental Molecule" },
      { name: "Sulfur", formula: "S₈", category: "Elemental Molecule" },
      { name: "Water", formula: "H₂O", category: "Compound Molecule", drawType: "water" },
      { name: "Carbon Dioxide", formula: "CO₂", category: "Compound Molecule", drawType: "co2" },
      { name: "Methane", formula: "CH₄", category: "Compound Molecule", drawType: "methane" },
      { name: "Ammonia", formula: "NH₃", category: "Compound Molecule", drawType: "ammonia" },
      { name: "Hydrogen Chloride", formula: "HCl", category: "Compound Molecule", drawType: "diatomic", colors: ["#4A90E2", "#D0021B"] },
      { name: "Ethane", formula: "C₂H₆", category: "Compound Molecule", drawType: "ethane" },
      { name: "Propane", formula: "C₃H₈", category: "Compound Molecule", drawType: "propane" },
      { name: "Iron", formula: "Fe", category: "Lattice" },
      { name: "Copper", formula: "Cu", category: "Lattice" },
      { name: "Gold", formula: "Au", category: "Lattice" },
      { name: "Diamond", formula: "C", category: "Lattice" },
      { name: "Graphite", formula: "C", category: "Lattice" },
      { name: "Sodium Chloride", formula: "NaCl", category: "Compound Lattice" },
      { name: "Magnesium Oxide", formula: "MgO", category: "Compound Lattice" },
      { name: "Calcium Carbonate", formula: "CaCO₃", category: "Compound Lattice" },
      { name: "Potassium Bromide", formula: "KBr", category: "Compound Lattice" },
      { name: "Lithium Fluoride", formula: "LiF", category: "Compound Lattice" },
      { name: "Aluminum Oxide", formula: "Al₂O₃", category: "Compound Lattice" },
      { name: "Nitric Acid", formula: "HNO₃", category: "Compound Molecule", drawType: "generic", atoms: 5 },
      { name: "Sulfur Dioxide", formula: "SO₂", category: "Compound Molecule", drawType: "so2" },
      { name: "Silicon Dioxide", formula: "SiO₂", category: "Compound Lattice" },
      { name: "Carbon Monoxide", formula: "CO", category: "Compound Molecule", drawType: "diatomic", colors: ["#7ED321", "#D0021B"] }

    ];

    // Expanded list of 20 science/chemistry-themed jokes
    const jokes = [
      { setup: "Why can you never trust atoms?", punchline: "Because they make up everything." },
      { setup: "What do you do with a sick chemist?", punchline: "If you can't helium, and you can't curium, then you might as well barium." },
      { setup: "Why did the noble gas cry?", punchline: "Because all his friends argon." },
      { setup: "What did the scientist say when he found two isotopes of helium?", punchline: "HeHe." },
      { setup: "Why did the chemist sole and heel his shoes with silicone rubber?", punchline: "To reduce his carbon footprint." },
      { setup: "What do you call a tooth in a glass of water?", punchline: "A one-molar solution." },
      { setup: "Why do chemists like nitrates so much?", punchline: "They're cheaper than day rates." },
      { setup: "What is the chemical formula for \"banana\"?", punchline: "BaNa₂." },
      { setup: "What is the most important rule in chemistry?", punchline: "Never lick the spoon!" },
      { setup: "What did the bartender say when oxygen, hydrogen, sulfur, sodium, and phosphorus walked into his bar?", punchline: "\"OH SNaP!\"" },
      { setup: "What do you call a clown who's in jail?", punchline: "A silicon." },
      { setup: "Why did the attacking army use acid?", punchline: "To neutralize the enemy's base." },
      { setup: "What do you call a benzene ring with iron atoms replacing the carbon atoms?", punchline: "A ferrous wheel." },
      { setup: "If H₂O is the formula for water, what is the formula for ice?", punchline: "H₂O cubed." },
      { setup: "What did one charged atom say to the other?", punchline: "I've got my ion you." },
      { setup: "Why did the chemist like the book about helium so much?", punchline: "He just couldn't put it down." },
      { setup: "What did one charged atom say to the other?", punchline: "\"I've got my ion you.\"" },
      { setup: "Why did the white bear dissolve in water?", punchline: "Because it was polar." },
      { setup: "What do you call a fish made of two sodium atoms?", punchline: "2 Na." },
      { setup: "Why are chemists excellent for solving problems?", punchline: "They have all the solutions." }
    ];


    // Global variables and DOM element references
    let currentIndex = 0, correctCount = 0, incorrectCount = 0, streak = 0;
    let lastJokeStreak = 0; // Tracks the streak for which a joke was last shown
    let autoNextTimeout;
    const substanceNameEl = document.getElementById('substanceName');
    const formulaEl = document.getElementById('formula');
    const diagram = document.getElementById('diagram');
    const feedbackEl = document.getElementById('feedback');
    const nextBtn = document.getElementById('nextBtn');
    const jokeBtn = document.getElementById('jokeBtn');
    const choiceButtons = document.querySelectorAll('.choice');
    const correctEl = document.getElementById('correct');
    const incorrectEl = document.getElementById('incorrect');
    const percentageEl = document.getElementById('percentage');
    const streakEl = document.getElementById('streak');
    const appContainer = document.getElementById('app');
    const jokeModal = document.getElementById('jokeModal');
    const closeModal = document.getElementById('closeModal');
    const jokeSetupEl = document.getElementById('jokeSetup');
    const revealPunchlineBtn = document.getElementById('revealPunchline');
    const jokePunchlineEl = document.getElementById('jokePunchline');

    function updateScore() {
      correctEl.textContent = correctCount;
      incorrectEl.textContent = incorrectCount;
      const total = correctCount + incorrectCount;
      const percent = total > 0 ? Math.round((correctCount / total) * 100) : 0;
      percentageEl.textContent = percent + '%';
      streakEl.textContent = streak;
      // Enable joke button if streak is a multiple of 3 and not already used for this streak.
      if (streak >= 3 && streak % 3 === 0 && streak !== lastJokeStreak) {
        jokeBtn.disabled = false;
      } else {
        jokeBtn.disabled = true;
      }
    }

    function clearSVG() {
      while (diagram.firstChild) {
        diagram.removeChild(diagram.firstChild);
      }
    }

    // ---------- Flash Function ----------
    function flashColor(color) {
      appContainer.style.backgroundColor = color;
      setTimeout(() => {
        appContainer.style.backgroundColor = "#fff";
      }, 300);
    }

    // ---------- Drawing functions ----------
    function drawElement(svg) {
      const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
      circle.setAttribute("cx", 150);
      circle.setAttribute("cy", 100);
      circle.setAttribute("r", 20);
      circle.setAttribute("fill", "#4A90E2");
      svg.appendChild(circle);
    }

    // Updated drawDiatomic to accept two optional color parameters
    function drawDiatomic(svg, color1 = "#50E3C2", color2 = "#50E3C2") {
      const circle1 = document.createElementNS("http://www.w3.org/2000/svg", "circle");
      circle1.setAttribute("cx", 110);
      circle1.setAttribute("cy", 100);
      circle1.setAttribute("r", 15);
      circle1.setAttribute("fill", color1);
      svg.appendChild(circle1);
      
      const circle2 = document.createElementNS("http://www.w3.org/2000/svg", "circle");
      circle2.setAttribute("cx", 190);
      circle2.setAttribute("cy", 100);
      circle2.setAttribute("r", 15);
      circle2.setAttribute("fill", color2);
      svg.appendChild(circle2);
      
      const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
      line.setAttribute("x1", 110);
      line.setAttribute("y1", 100);
      line.setAttribute("x2", 190);
      line.setAttribute("y2", 100);
      line.setAttribute("stroke", "#333");
      line.setAttribute("stroke-width", 2);
      svg.appendChild(line);
    }

    function drawElementalMolecule(svg, formula) {
      if (formula.includes("₂") || (!formula.match(/[₀-₉]/) && formula.length <= 2)) {
        drawDiatomic(svg);
      } else if (formula.includes("₄")) {
        const positions = [
          { x: 120, y: 80 },
          { x: 180, y: 80 },
          { x: 120, y: 140 },
          { x: 180, y: 140 }
        ];
        positions.forEach(pos => {
          const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
          circle.setAttribute("cx", pos.x);
          circle.setAttribute("cy", pos.y);
          circle.setAttribute("r", 12);
          circle.setAttribute("fill", "#F5A623");
          svg.appendChild(circle);
        });
        positions.forEach((pos, i) => {
          const next = positions[(i + 1) % positions.length];
          const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
          line.setAttribute("x1", pos.x);
          line.setAttribute("y1", pos.y);
          line.setAttribute("x2", next.x);
          line.setAttribute("y2", next.y);
          line.setAttribute("stroke", "#333");
          line.setAttribute("stroke-width", 2);
          svg.appendChild(line);
        });
      } else if (formula.includes("₈")) {
        const centerX = 150, centerY = 100, radius = 50;
        for (let i = 0; i < 8; i++) {
          const angle = (2 * Math.PI / 8) * i;
          const x = centerX + radius * Math.cos(angle);
          const y = centerY + radius * Math.sin(angle);
          const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
          circle.setAttribute("cx", x);
          circle.setAttribute("cy", y);
          circle.setAttribute("r", 10);
          circle.setAttribute("fill", "#F8E71C");
          svg.appendChild(circle);
          const line = document.createElementNS("http://www.w3.org/2000/svg", "line");
          line.setAttribute("x1", centerX);
          line.setAttribute("y1", centerY);
          line.setAttribute("x2", x);
          line.setAttribute("y2", y);
          line.setAttribute("stroke", "#333");
          line.setAttribute("stroke-width", 1);
          svg.appendChild(line);
        }
      } else {
        drawDiatomic(svg);
      }
    }

    // --- Compound Molecule Drawings ---
    function drawWater(svg) {
      const oxygen = document.createElementNS("http://www.w3.org/2000/svg", "circle");
      oxygen.setAttribute("cx", 150);
      oxygen.setAttribute("cy", 70);
      oxygen.setAttribute("r", 20);
      oxygen.setAttribute("fill", "#D0021B");
      svg.appendChild(oxygen);
      
      const h1 = document.createElementNS("http://www.w3.org/2000/svg", "circle");
      h1.setAttribute("cx", 120);
      h1.setAttribute("cy", 120);
      h1.setAttribute("r", 15);
      h1.setAttribute("fill", "#4A90E2");
      svg.appendChild(h1);
      
      const h2 = document.createElementNS("http://www.w3.org/2000/svg", "circle");
      h2.setAttribute("cx", 180);
      h2.setAttribute("cy", 120);
      h2.setAttribute("r", 15);
      h2.setAttribute("fill", "#4A90E2");
      svg.appendChild(h2);
      
      const bond1 = document.createElementNS("http://www.w3.org/2000/svg", "line");
      bond1.setAttribute("x1", 150);
      bond1.setAttribute("y1", 70);
      bond1.setAttribute("x2", 120);
      bond1.setAttribute("y2", 120);
      bond1.setAttribute("stroke", "#333");
      bond1.setAttribute("stroke-width", 2);
      svg.appendChild(bond1);
      
      const bond2 = document.createElementNS("http://www.w3.org/2000/svg", "line");
      bond2.setAttribute("x1", 150);
      bond2.setAttribute("y1", 70);
      bond2.setAttribute("x2", 180);
      bond2.setAttribute("y2", 120);
      bond2.setAttribute("stroke", "#333");
      bond2.setAttribute("stroke-width", 2);
      svg.appendChild(bond2);
    }

    function drawCO2(svg) {
      const oxygen1 = document.createElementNS("http://www.w3.org/2000/svg", "circle");
      oxygen1.setAttribute("cx", 80);
      oxygen1.setAttribute("cy", 100);
      oxygen1.setAttribute("r", 15);
      oxygen1.setAttribute("fill", "#D0021B");
      svg.appendChild(oxygen1);
      
      const carbon = document.createElementNS("http://www.w3.org/2000/svg", "circle");
      carbon.setAttribute("cx", 150);
      carbon.setAttribute("cy", 100);
      carbon.setAttribute("r", 20);
      carbon.setAttribute("fill", "#7ED321");
      svg.appendChild(carbon);
      
      const oxygen2 = document.createElementNS("http://www.w3.org/2000/svg", "circle");
      oxygen2.setAttribute("cx", 220);
      oxygen2.setAttribute("cy", 100);
      oxygen2.setAttribute("r", 15);
      oxygen2.setAttribute("fill", "#D0021B");
      svg.appendChild(oxygen2);
      
      const bond1 = document.createElementNS("http://www.w3.org/2000/svg", "line");
      bond1.setAttribute("x1", 80);
      bond1.setAttribute("y1", 100);
      bond1.setAttribute("x2", 150);
      bond1.setAttribute("y2", 100);
      bond1.setAttribute("stroke", "#333");
      bond1.setAttribute("stroke-width", 2);
      svg.appendChild(bond1);
      
      const bond2 = document.createElementNS("http://www.w3.org/2000/svg", "line");
      bond2.setAttribute("x1", 150);
      bond2.setAttribute("y1", 100);
      bond2.setAttribute("x2", 220);
      bond2.setAttribute("y2", 100);
      bond2.setAttribute("stroke", "#333");
      bond2.setAttribute("stroke-width", 2);
      svg.appendChild(bond2);
    }

    function drawMethane(svg) {
      const carbon = document.createElementNS("http://www.w3.org/2000/svg", "circle");
      carbon.setAttribute("cx", 150);
      carbon.setAttribute("cy", 100);
      carbon.setAttribute("r", 20);
      carbon.setAttribute("fill", "#7ED321");
      svg.appendChild(carbon);
      
      const positions = [
        { x: 150, y: 50 },
        { x: 200, y: 100 },
        { x: 150, y: 150 },
        { x: 100, y: 100 }
      ];
      positions.forEach(pos => {
        const h = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        h.setAttribute("cx", pos.x);
        h.setAttribute("cy", pos.y);
        h.setAttribute("r", 15);
        h.setAttribute("fill", "#4A90E2");
        svg.appendChild(h);
        
        const bond = document.createElementNS("http://www.w3.org/2000/svg", "line");
        bond.setAttribute("x1", 150);
        bond.setAttribute("y1", 100);
        bond.setAttribute("x2", pos.x);
        bond.setAttribute("y2", pos.y);
        bond.setAttribute("stroke", "#333");
        bond.setAttribute("stroke-width", 2);
        svg.appendChild(bond);
      });
    }

    function drawAmmonia(svg) {
      const nitrogen = document.createElementNS("http://www.w3.org/2000/svg", "circle");
      nitrogen.setAttribute("cx", 150);
      nitrogen.setAttribute("cy", 90);
      nitrogen.setAttribute("r", 20);
      nitrogen.setAttribute("fill", "#F8E71C");
      svg.appendChild(nitrogen);
      
      const positions = [
        { x: 120, y: 140 },
        { x: 150, y: 140 },
        { x: 180, y: 140 }
      ];
      positions.forEach(pos => {
        const h = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        h.setAttribute("cx", pos.x);
        h.setAttribute("cy", pos.y);
        h.setAttribute("r", 15);
        h.setAttribute("fill", "#4A90E2");
        svg.appendChild(h);
        
        const bond = document.createElementNS("http://www.w3.org/2000/svg", "line");
        bond.setAttribute("x1", 150);
        bond.setAttribute("y1", 90);
        bond.setAttribute("x2", pos.x);
        bond.setAttribute("y2", pos.y);
        bond.setAttribute("stroke", "#333");
        bond.setAttribute("stroke-width", 2);
        svg.appendChild(bond);
      });
    }

    function drawEthane(svg) {
      const carbon1 = document.createElementNS("http://www.w3.org/2000/svg", "circle");
      carbon1.setAttribute("cx", 120);
      carbon1.setAttribute("cy", 100);
      carbon1.setAttribute("r", 20);
      carbon1.setAttribute("fill", "#7ED321");
      svg.appendChild(carbon1);
      
      const carbon2 = document.createElementNS("http://www.w3.org/2000/svg", "circle");
      carbon2.setAttribute("cx", 180);
      carbon2.setAttribute("cy", 100);
      carbon2.setAttribute("r", 20);
      carbon2.setAttribute("fill", "#7ED321");
      svg.appendChild(carbon2);
      
      const bond = document.createElementNS("http://www.w3.org/2000/svg", "line");
      bond.setAttribute("x1", 120);
      bond.setAttribute("y1", 100);
      bond.setAttribute("x2", 180);
      bond.setAttribute("y2", 100);
      bond.setAttribute("stroke", "#333");
      bond.setAttribute("stroke-width", 2);
      svg.appendChild(bond);
      
      const positions1 = [ { x: 90, y: 70 }, { x: 90, y: 130 } ];
      positions1.forEach(pos => {
        const h = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        h.setAttribute("cx", pos.x);
        h.setAttribute("cy", pos.y);
        h.setAttribute("r", 15);
        h.setAttribute("fill", "#4A90E2");
        svg.appendChild(h);
        
        const bond = document.createElementNS("http://www.w3.org/2000/svg", "line");
        bond.setAttribute("x1", 120);
        bond.setAttribute("y1", 100);
        bond.setAttribute("x2", pos.x);
        bond.setAttribute("y2", pos.y);
        bond.setAttribute("stroke", "#333");
        bond.setAttribute("stroke-width", 2);
        svg.appendChild(bond);
      });
      
      const positions2 = [ { x: 210, y: 70 }, { x: 210, y: 130 } ];
      positions2.forEach(pos => {
        const h = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        h.setAttribute("cx", pos.x);
        h.setAttribute("cy", pos.y);
        h.setAttribute("r", 15);
        h.setAttribute("fill", "#4A90E2");
        svg.appendChild(h);
        
        const bond = document.createElementNS("http://www.w3.org/2000/svg", "line");
        bond.setAttribute("x1", 180);
        bond.setAttribute("y1", 100);
        bond.setAttribute("x2", pos.x);
        bond.setAttribute("y2", pos.y);
        bond.setAttribute("stroke", "#333");
        bond.setAttribute("stroke-width", 2);
        svg.appendChild(bond);
      });
    }

    function drawPropane(svg) {
      const carbon1 = document.createElementNS("http://www.w3.org/2000/svg", "circle");
      carbon1.setAttribute("cx", 90);
      carbon1.setAttribute("cy", 100);
      carbon1.setAttribute("r", 20);
      carbon1.setAttribute("fill", "#7ED321");
      svg.appendChild(carbon1);
      
      const carbon2 = document.createElementNS("http://www.w3.org/2000/svg", "circle");
      carbon2.setAttribute("cx", 150);
      carbon2.setAttribute("cy", 100);
      carbon2.setAttribute("r", 20);
      carbon2.setAttribute("fill", "#7ED321");
      svg.appendChild(carbon2);
      
      const carbon3 = document.createElementNS("http://www.w3.org/2000/svg", "circle");
      carbon3.setAttribute("cx", 210);
      carbon3.setAttribute("cy", 100);
      carbon3.setAttribute("r", 20);
      carbon3.setAttribute("fill", "#7ED321");
      svg.appendChild(carbon3);
      
      const bond1 = document.createElementNS("http://www.w3.org/2000/svg", "line");
      bond1.setAttribute("x1", 90);
      bond1.setAttribute("y1", 100);
      bond1.setAttribute("x2", 150);
      bond1.setAttribute("y2", 100);
      bond1.setAttribute("stroke", "#333");
      bond1.setAttribute("stroke-width", 2);
      svg.appendChild(bond1);
      
      const bond2 = document.createElementNS("http://www.w3.org/2000/svg", "line");
      bond2.setAttribute("x1", 150);
      bond2.setAttribute("y1", 100);
      bond2.setAttribute("x2", 210);
      bond2.setAttribute("y2", 100);
      bond2.setAttribute("stroke", "#333");
      bond2.setAttribute("stroke-width", 2);
      svg.appendChild(bond2);
      
      const positions = [
        { x: 90, y: 60 },
        { x: 150, y: 60 },
        { x: 210, y: 60 }
      ];
      positions.forEach((pos) => {
        const h = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        h.setAttribute("cx", pos.x);
        h.setAttribute("cy", pos.y);
        h.setAttribute("r", 15);
        h.setAttribute("fill", "#4A90E2");
        svg.appendChild(h);
        
        const bond = document.createElementNS("http://www.w3.org/2000/svg", "line");
        bond.setAttribute("x1", pos.x);
        bond.setAttribute("y1", 100);
        bond.setAttribute("x2", pos.x);
        bond.setAttribute("y2", pos.y);
        bond.setAttribute("stroke", "#333");
        bond.setAttribute("stroke-width", 2);
        svg.appendChild(bond);
      });
    }

    function drawSO2(svg) {
      const sulfur = document.createElementNS("http://www.w3.org/2000/svg", "circle");
      sulfur.setAttribute("cx", 150);
      sulfur.setAttribute("cy", 100);
      sulfur.setAttribute("r", 20);
      sulfur.setAttribute("fill", "#F8E71C");
      svg.appendChild(sulfur);
      
      const oxygen1 = document.createElementNS("http://www.w3.org/2000/svg", "circle");
      oxygen1.setAttribute("cx", 120);
      oxygen1.setAttribute("cy", 60);
      oxygen1.setAttribute("r", 15);
      oxygen1.setAttribute("fill", "#D0021B");
      svg.appendChild(oxygen1);
      
      const oxygen2 = document.createElementNS("http://www.w3.org/2000/svg", "circle");
      oxygen2.setAttribute("cx", 180);
      oxygen2.setAttribute("cy", 60);
      oxygen2.setAttribute("r", 15);
      oxygen2.setAttribute("fill", "#D0021B");
      svg.appendChild(oxygen2);
      
      const bond1 = document.createElementNS("http://www.w3.org/2000/svg", "line");
      bond1.setAttribute("x1", 150);
      bond1.setAttribute("y1", 100);
      bond1.setAttribute("x2", 120);
      bond1.setAttribute("y2", 60);
      bond1.setAttribute("stroke", "#333");
      bond1.setAttribute("stroke-width", 2);
      svg.appendChild(bond1);
      
      const bond2 = document.createElementNS("http://www.w3.org/2000/svg", "line");
      bond2.setAttribute("x1", 150);
      bond2.setAttribute("y1", 100);
      bond2.setAttribute("x2", 180);
      bond2.setAttribute("y2", 60);
      bond2.setAttribute("stroke", "#333");
      bond2.setAttribute("stroke-width", 2);
      svg.appendChild(bond2);
    }

    // Generic compound molecule: central atom with (atomCount - 1) peripheral atoms
    function drawGenericCompound(svg, atomCount) {
      const centerX = 150, centerY = 100;
      const central = document.createElementNS("http://www.w3.org/2000/svg", "circle");
      central.setAttribute("cx", centerX);
      central.setAttribute("cy", centerY);
      central.setAttribute("r", 20);
      central.setAttribute("fill", "#7ED321");
      svg.appendChild(central);
      const n = atomCount - 1;
      const radius = 50;
      for (let i = 0; i < n; i++) {
        const angle = (2 * Math.PI / n) * i;
        const x = centerX + radius * Math.cos(angle);
        const y = centerY + radius * Math.sin(angle);
        const atom = document.createElementNS("http://www.w3.org/2000/svg", "circle");
        atom.setAttribute("cx", x);
        atom.setAttribute("cy", y);
        atom.setAttribute("r", 15);
        atom.setAttribute("fill", "#4A90E2");
        svg.appendChild(atom);
        
        const bond = document.createElementNS("http://www.w3.org/2000/svg", "line");
        bond.setAttribute("x1", centerX);
        bond.setAttribute("y1", centerY);
        bond.setAttribute("x2", x);
        bond.setAttribute("y2", y);
        bond.setAttribute("stroke", "#333");
        bond.setAttribute("stroke-width", 2);
        svg.appendChild(bond);
      }
    }

    function drawCompoundMolecule(svg, substance) {
      const type = substance.drawType;
      switch (type) {
        case "water":
          drawWater(svg);
          break;
        case "co2":
          drawCO2(svg);
          break;
        case "methane":
          drawMethane(svg);
          break;
        case "ammonia":
          drawAmmonia(svg);
          break;
        case "diatomic":
          // If the substance provides colors (for heteronuclear diatomic compounds), use them.
          if (substance.colors) {
            drawDiatomic(svg, substance.colors[0], substance.colors[1]);
          } else {
            drawDiatomic(svg);
          }
          break;
        case "ethane":
          drawEthane(svg);
          break;
        case "propane":
          drawPropane(svg);
          break;
        case "so2":
          drawSO2(svg);
          break;
        case "generic":
          const atomCount = substance.atoms || 4;
          drawGenericCompound(svg, atomCount);
          break;
        default:
          drawGenericCompound(svg, 4);
      }
    }

    // --- Lattice drawings ---
    function drawLattice(svg) {
      const startX = 80, startY = 40, spacing = 50;
      for (let i = 0; i < 3; i++) {
        for (let j = 0; j < 3; j++) {
          const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
          circle.setAttribute("cx", startX + j * spacing);
          circle.setAttribute("cy", startY + i * spacing);
          circle.setAttribute("r", 15);
          circle.setAttribute("fill", "#9B9B9B");
          svg.appendChild(circle);
        }
      }
    }

    function drawCompoundLattice(svg) {
      const startX = 80, startY = 40, spacing = 50;
      for (let i = 0; i < 3; i++) {
        for (let j = 0; j < 3; j++) {
          const circle = document.createElementNS("http://www.w3.org/2000/svg", "circle");
          circle.setAttribute("cx", startX + j * spacing);
          circle.setAttribute("cy", startY + i * spacing);
          circle.setAttribute("r", 15);
          const fillColor = ((i + j) % 2 === 0) ? "#D0021B" : "#4A90E2";
          circle.setAttribute("fill", fillColor);
          svg.appendChild(circle);
        }
      }
    }

    // ---------- App Logic ----------
    function showSubstance() {
      clearSVG();
      feedbackEl.textContent = "";
      nextBtn.disabled = true;
      choiceButtons.forEach(btn => {
        btn.disabled = false;
        btn.classList.remove("correct-choice");
      });
      
      // Hide joke modal if it's open.
      jokeModal.style.display = "none";
      jokePunchlineEl.style.display = "none";
      
      // Fade-in animation for new substance
      appContainer.style.animation = "fadeIn 0.5s ease-out";
      setTimeout(() => { appContainer.style.animation = ""; }, 500);
      
      const substance = substances[currentIndex];
      substanceNameEl.textContent = substance.name;
      formulaEl.textContent = "Formula: " + substance.formula;
      
      switch (substance.category) {
        case "Element":
          drawElement(diagram);
          break;
        case "Elemental Molecule":
          drawElementalMolecule(diagram, substance.formula);
          break;
        case "Compound Molecule":
          drawCompoundMolecule(diagram, substance);
          break;
        case "Lattice":
          drawLattice(diagram);
          break;
        case "Compound Lattice":
          drawCompoundLattice(diagram);
          break;
        default:
          clearSVG();
      }
    }

    choiceButtons.forEach(button => {
      button.addEventListener('click', () => {
        // Disable all buttons immediately
        choiceButtons.forEach(btn => btn.disabled = true);
        const chosen = button.getAttribute("data-choice");
        const substance = substances[currentIndex];
        if (chosen === substance.category) {
          feedbackEl.textContent = "Correct!";
          feedbackEl.style.color = "green";
          correctCount++;
          streak++;
          flashColor('#e0f8e0');
        } else {
          feedbackEl.textContent = "Incorrect! Correct answer: " + substance.category;
          feedbackEl.style.color = "red";
          incorrectCount++;
          streak = 0;
          flashColor('#f8e0e0');
          // Highlight the correct answer button
          let correctBtn = document.querySelector('.choice[data-choice="'+substance.category+'"]');
          if (correctBtn) {
            correctBtn.classList.add('correct-choice');
          }
        }
        updateScore();
        nextBtn.disabled = false;
        // Set auto-advance timer for 3 seconds
        autoNextTimeout = setTimeout(() => {
          nextBtn.click();
        }, 3000);
      });
    });

    nextBtn.addEventListener('click', () => {
      clearTimeout(autoNextTimeout);
      // Fade out current substance before transitioning
      appContainer.style.animation = "fadeOut 0.5s ease-out";
      setTimeout(() => {
        currentIndex++;
        if (currentIndex >= substances.length) {
          currentIndex = 0;
          substances.sort(() => Math.random() - 0.5);
        }
        showSubstance();
      }, 500);
    });

    // Joke button event listener
    jokeBtn.addEventListener('click', () => {
      // Pause auto-next timer if running
      clearTimeout(autoNextTimeout);
      // Pick a random joke
      const randomJoke = jokes[Math.floor(Math.random() * jokes.length)];
      jokeSetupEl.textContent = randomJoke.setup;
      jokePunchlineEl.textContent = randomJoke.punchline;
      jokePunchlineEl.style.display = "none";
      // Show modal
      jokeModal.style.display = "block";
      // Mark this streak as having used a joke so it won't re-enable until a new mod3 streak is reached.
      lastJokeStreak = streak;
      jokeBtn.disabled = true;
    });

    // Reveal punchline when button is clicked
    revealPunchlineBtn.addEventListener('click', () => {
      jokePunchlineEl.style.display = "block";
    });

    // Close modal when the close button is clicked and resume auto-next timer
    closeModal.addEventListener('click', () => {
      jokeModal.style.display = "none";
      // Restart auto-next timer after closing modal (3 seconds)
      autoNextTimeout = setTimeout(() => {
        nextBtn.click();
      }, 3000);
    });

    // Start by shuffling substances and showing the first one.
    substances.sort(() => Math.random() - 0.5);
    showSubstance();
  </script>
</body>
</html>
