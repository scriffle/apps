<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Color Matching Game</title>
    <style>
        body, html {
            margin: 0;
            padding: 0;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            font-family: Arial, sans-serif;
            box-sizing: border-box;
            background-color: black;
            color: white;
            transition: background-color 0.3s, color 0.3s;
            /* Prevent touch callout */
            -webkit-touch-callout: none;
            -webkit-user-select: none;
            -khtml-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
            /* Disable iOS tap highlight */
            -webkit-tap-highlight-color: transparent;
        }
        #gameContainer {
            display: flex;
            flex-direction: column;
            width: 100%;
            height: 100%;
            max-width: 800px;
            padding: 10px;
            box-sizing: border-box;
        }
        #topPane {
            display: flex;
            height: 50%;
        }
        #bottomPane {
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            align-items: center;
            height: 50%;
        }
        .quadrant {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .swatch {
            position: relative;
            margin: 5px;
            display: flex;
            flex-direction: column;
            height: 100px;
            width: 50px;
            cursor: pointer;
            /* Add touch-action manipulation for better touch control */
            touch-action: manipulation;
        }
        .stripe {
            flex: 1;
        }
        .sumColor {
            position: absolute;
            top: 110%;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 50px;
            display: none;
        }
        #controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            margin: 10px;
        }
        #controls > div {
            margin: 5px 0;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        #controls button, #controls label, #controls input, #controls span {
            margin: 0 10px;
            /* Increase touch target size */
            min-height: 44px;
            min-width: 44px;
            padding: 10px;
        }
        #slider {
            margin: 0 10px;
            /* Increase touch target size for slider */
            height: 44px;
        }
        #difficultyLabel {
            margin-left: 10px;
            font-weight: bold;
        }
        #betterThanRandom {
            margin-left: 10px;
        }
        #infoModal, #colorInfoModal, #onboardingModal {
            display: none;
            position: fixed;
            z-index: 1;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            padding-top: 60px;
        }
        #infoContent, #colorInfoContent, #onboardingContent {
            background-color: #fefefe;
            color: black;
            margin: 5% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 600px;
            text-align: center;
        }
        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            /* Increase touch target size */
            padding: 10px;
            min-height: 44px;
            min-width: 44px;
        }
        .close:hover,
        .close:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
        .navigation {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        .navButton {
            padding: 10px;
            cursor: pointer;
            border: none;
            background-color: #ddd;
            color: black;
            font-size: 16px;
            transition: background-color 0.3s;
            /* Increase touch target size */
            min-height: 44px;
            min-width: 44px;
        }
        .navButton:hover {
            background-color: #ccc;
        }
        /* Add styles for radio buttons to increase touch target size */
        input[type="radio"] {
            width: 44px;
            height: 44px;
            margin: 0;
            vertical-align: middle;
        }
        /* Make labels more touch-friendly */
        label {
            padding: 10px;
            min-height: 44px;
            display: inline-flex;
            align-items: center;
        }
    </style>
</head>
<body>

<div id="gameContainer">
    <div id="topPane">
        <div id="targetColor" class="quadrant"></div>
        <div id="guessedColor" class="quadrant"></div>
    </div>
    <div id="controls">
        <div>
            <label for="slider">Number of swatches:</label>
            <input type="range" id="slider" min="2" max="13" value="5" list="tickmarks">
            <datalist id="tickmarks">
                <option value="2" label="Potato">
                <option value="3" label="Child's Play">
                <option value="4" label="Breezy">
                <option value="5" label="Normal">
                <option value="6" label="Spicy">
                <option value="7" label="Edgy">
                <option value="8" label="Tricky">
                <option value="9" label="Challenging">
                <option value="10" label="Beast Mode">
                <option value="11" label="Monster">
                <option value="12" label="Savage">
                <option value="13" label="Insane">
            </datalist>
            <span id="difficultyLabel">5 - Normal</span>
            <span id="betterThanRandom">Much better than random: 40%</span>
        </div>
        <div>
            <button id="newGameButton">New Game</button>
            <button id="clueButton">Clue</button>
            <button id="infoButton">What's Going On?</button>
            <button id="colorInfoButton">Color Principles</button>
        </div>
        <div>
            <label for="visionToggle">Vision:</label>
            <input type="radio" id="visionToggleNormal" name="vision" value="Normal" checked> Normal
            <input type="radio" id="visionToggleRB" name="vision" value="RB"> Red/Blue
            <input type="radio" id="visionToggleGB" name="vision" value="GB"> Green/Blue
        </div>
        <div>
            <label for="modeToggle">Mode:</label>
            <input type="radio" id="modeToggleRGB" name="mode" value="RGB"> Light (RGB)
            <input type="radio" id="modeToggleCMY" name="mode" value="CMY"> Pigment (CMY)
        </div>
        <div>
            <label for="themeToggle">Theme:</label>
            <input type="radio" id="themeToggleClassic" name="theme" value="Classic"> Classic
            <input type="radio" id="themeToggleDark" name="theme" value="Dark" checked> Dark
        </div>
        <div>
            <span id="guesses">Guesses: 0</span>
            <span id="correct">Correct: 0</span>
            <span id="percentage">Percentage: 0%</span>
            <span id="avgTime">Average Time: 0.00 s</span>
        </div>
    </div>
    <div id="bottomPane"></div>
</div>

<div id="infoModal">
    <div id="infoContent">
        <span class="close">&times;</span>
        <p><strong>Welcome to the Color Matching Game!</strong></p>
        <p>Your goal is to match the target color displayed in the top left quadrant by selecting the correct combination of color swatches from the bottom panel. Each swatch represents either a dyad of colors (Red and Blue or Green and Blue) or a triad of colors (Red, Green, and Blue).</p>
        <p>Use the slider to choose the number of swatches and adjust the difficulty level. Click the "Clue" button to briefly reveal the combined color of each swatch, but using a clue will prevent your correct guesses from being counted in the current game.</p>
        <p>Select the vision mode that best suits your color vision: Normal, Red/Blue (for green deficiency), or Green/Blue (for red deficiency). In Red/Blue mode, the green component is always zero, and in Green/Blue mode, the red component is always zero.</p>
        <p>You can also choose between Light (RGB) and Pigment (CMY) modes to see how different color mixing principles affect the target color and swatches.</p>
        <p>Note: This game includes options for those with color vision deficiency to help match colors more accurately.</p>
        <p>Happy matching!</p>
    </div>
</div>

<div id="colorInfoModal">
    <div id="colorInfoContent">
        <span class="close">&times;</span>
        <h2>Color Principles</h2>
        <p><strong>Color Light Addition (RGB):</strong></p>
        <ul>
            <li>Red + Green = Yellow</li>
            <li>Red + Blue = Magenta</li>
            <li>Green + Blue = Cyan</li>
            <li>Red + Green + Blue = White</li>
        </ul>
        <p><strong>Pigment Color Subtraction (CMY):</strong></p>
        <ul>
            <li>Cyan + Magenta = Blue</li>
            <li>Cyan + Yellow = Green</li>
            <li>Magenta + Yellow = Red</li>
            <li>Cyan + Magenta + Yellow = Black</li>
        </ul>
        <p>Use these principles to help you choose the correct swatch:</p>
        <ul>
            <li>If you're in RGB mode and see a target color that looks yellow, it's likely a combination of red and green.</li>
            <li>If you're in CMY mode and see a target color that looks green, it's likely a combination of cyan and yellow.</li>
        </ul>
        <p>Understanding these principles can help you make better guesses and improve your chances of matching the target color correctly.</p>
    </div>
</div>

<div id="onboardingModal">
    <div id="onboardingContent">
        <span class="close" id="skipOnboarding">&times;</span>
        <div class="onboardingPage" id="onboardingPage1">
            <h2>Welcome to the Color Matching Game!</h2>
            <p>Your goal is to match the target color displayed in the top left quadrant by selecting the correct combination of color swatches from the bottom panel.</p>
        </div>
        <div class="onboardingPage" id="onboardingPage2" style="display: none;">
            <h2>Light Color Addition (RGB)</h2>
            <ul>
                <li>Red + Green = Yellow</li>
                <li>Red + Blue = Magenta</li>
                <li>Green + Blue = Cyan</li>
                <li>Red + Green + Blue = White</li>
            </ul>
        </div>
        <div class="onboardingPage" id="onboardingPage3" style="display: none;">
            <h2>Pigment Color Subtraction (CMY)</h2>
            <ul>
                <li>Cyan + Magenta = Blue</li>
                <li>Cyan + Yellow = Green</li>
                <li>Magenta + Yellow = Red</li>
                <li>Cyan + Magenta + Yellow = Black</li>
            </ul>
        </div>
        <div class="onboardingPage" id="onboardingPage4" style="display: none;">
            <h2>Interface Options</h2>
            <p>Use the slider to choose the number of swatches and adjust the difficulty level.</p>
            <p>Select the vision mode that best suits your color vision: Normal, Red/Blue (for green deficiency), or Green/Blue (for red deficiency).</p>
            <p>Choose between Light (RGB) and Pigment (CMY) modes to see how different color mixing principles affect the target color and swatches.</p>
            <p>You can also switch between Dark and Classic themes for a better visual experience.</p>
        </div>
        <div class="onboardingPage" id="onboardingPage5" style="display: none;">
            <h2>Tips for Choosing the Right Color Swatch</h2>
            <p>Understanding color mixing principles can help you make better guesses and improve your chances of matching the target color correctly.</p>
            <p>Use the "Clue" button to get a hint, but remember it will prevent your correct guesses from being counted in the current game.</p>
        </div>
        <div class="navigation">
            <button class="navButton" id="prevButton" style="display: none;">Previous</button>
            <button class="navButton" id="nextButton">Next</button>
            <button class="navButton" id="skipButton">Skip</button>
        </div>
    </div>
</div>

<script>
    const targetColorDiv = document.getElementById('targetColor');
    const guessedColorDiv = document.getElementById('guessedColor');
    const slider = document.getElementById('slider');
    const newGameButton = document.getElementById('newGameButton');
    const clueButton = document.getElementById('clueButton');
    const infoButton = document.getElementById('infoButton');
    const colorInfoButton = document.getElementById('colorInfoButton');
    const visionToggles = document.getElementsByName('vision');
    const modeToggles = document.getElementsByName('mode');
    const themeToggles = document.getElementsByName('theme');
    const bottomPane = document.getElementById('bottomPane');
    const guessesSpan = document.getElementById('guesses');
    const correctSpan = document.getElementById('correct');
    const percentageSpan = document.getElementById('percentage');
    const avgTimeSpan = document.getElementById('avgTime');
    const difficultyLabel = document.getElementById('difficultyLabel');
    const betterThanRandomSpan = document.getElementById('betterThanRandom');
    const infoModal = document.getElementById('infoModal');
    const colorInfoModal = document.getElementById('colorInfoModal');
    const onboardingModal = document.getElementById('onboardingModal');
    const closeButtons = document.querySelectorAll('.close');
    const onboardingPages = document.querySelectorAll('.onboardingPage');
    const prevButton = document.getElementById('prevButton');
    const nextButton = document.getElementById('nextButton');
    const skipButton = document.getElementById('skipButton');
    const skipOnboarding = document.getElementById('skipOnboarding');

    let targetColor;
    let guesses = 0;
    let correctGuesses = 0;
    let totalTime = 0;
    let visionMode = 'Normal';
    let isRGBMode = true;
    let isDarkMode = true;
    let clueUsed = false;
    let gameEnded = false;
    let startTime = 0;
    let currentPage = 0;

    function randomColor() {
        return Math.floor(Math.random() * 256);
    }

    function generateTargetColor() {
        if (visionMode === 'RB') {
            targetColor = `rgb(${randomColor()}, 0, ${randomColor()})`;
        } else if (visionMode === 'GB') {
            targetColor = `rgb(0, ${randomColor()}, ${randomColor()})`;
        } else {
            targetColor = `rgb(${randomColor()}, ${randomColor()}, ${randomColor()})`;
        }
        targetColorDiv.style.backgroundColor = targetColor;
    }

    function rgbToCmy(rgb) {
        const [r, g, b] = rgb.match(/\d+/g).map(Number);
        const c = 255 - r;
        const m = 255 - g;
        const y = 255 - b;
        return [c, m, y];
    }

    function createSwatch(color) {
        const swatch = document.createElement('div');
        swatch.className = 'swatch';

        let stripes;
        if (visionMode === 'RB') {
            const [r, , b] = color.match(/\d+/g).map(Number);
            stripes = [
                `rgb(${r}, 0, 0)`,
                `rgb(0, 0, ${b})`
            ];
            if (!isRGBMode) {
                const [c, , y] = rgbToCmy(color);
                stripes = [
                    `rgb(${255 - c}, 255, 255)`,
                    `rgb(255, 255, ${255 - y})`
                ];
            }
        } else if (visionMode === 'GB') {
            const [, g, b] = color.match(/\d+/g).map(Number);
            stripes = [
                `rgb(0, ${g}, 0)`,
                `rgb(0, 0, ${b})`
            ];
            if (!isRGBMode) {
                const [, m, y] = rgbToCmy(color);
                stripes = [
                    `rgb(255, ${255 - m}, 255)`,
                    `rgb(255, 255, ${255 - y})`
                ];
            }
        } else {
            const [r, g, b] = color.match(/\d+/g).map(Number);
            stripes = [
                `rgb(${r}, 0, 0)`,
                `rgb(0, ${g}, 0)`,
                `rgb(0, 0, ${b})`
            ];
            if (!isRGBMode) {
                const [c, m, y] = rgbToCmy(color);
                stripes = [
                    `rgb(${255 - c}, 255, 255)`,
                    `rgb(255, ${255 - m}, 255)`,
                    `rgb(255, 255, ${255 - y})`
                ];
            }
        }

        stripes.forEach((stripeColor, index) => {
            const stripe = document.createElement('div');
            stripe.className = 'stripe';
            stripe.style.backgroundColor = stripeColor;
            swatch.appendChild(stripe);
        });

        const sumColorDiv = document.createElement('div');
        sumColorDiv.className = 'sumColor';
        sumColorDiv.style.backgroundColor = color;
        swatch.appendChild(sumColorDiv);

        // Add both click and touch event handlers
        swatch.addEventListener('click', () => handleSwatchClick(color));
        swatch.addEventListener('touchstart', (e) => {
            e.preventDefault(); // Prevent default touch behavior
            handleSwatchClick(color);
        });

        return swatch;
    }

    function handleSwatchClick(color) {
        if (gameEnded) return;
        if (!clueUsed) {
            guesses++;
            guessesSpan.innerText = `Guesses: ${guesses}`;
        }
        guessedColorDiv.style.backgroundColor = color;
        if (color === targetColor) {
            if (!clueUsed) {
                correctGuesses++;
                correctSpan.innerText = `Correct: ${correctGuesses}`;
                const endTime = new Date().getTime();
                const timeTaken = (endTime - startTime) / 1000;
                totalTime += timeTaken;
                const averageTime = (totalTime / correctGuesses).toFixed(2);
                avgTimeSpan.innerText = `Average Time: ${averageTime} s`;
            }
            document.body.style.backgroundColor = targetColor;
            setTimeout(() => document.body.style.backgroundColor = isDarkMode ? 'black' : 'white', 200);
            gameEnded = true;
            const swatches = document.querySelectorAll('.swatch');
            swatches.forEach(swatch => swatch.style.pointerEvents = 'none');
        }
        updatePercentage();
    }

    function updatePercentage() {
        const percentage = correctGuesses > 0 ? ((correctGuesses / guesses) * 100).toFixed(2) : 0;
        percentageSpan.innerText = `Percentage: ${percentage}%`;
    }

    function newGame() {
        bottomPane.innerHTML = '';
        guessedColorDiv.style.backgroundColor = isDarkMode ? 'black' : 'white';
        clueUsed = false;
        gameEnded = false;
        const numberOfSwatches = slider.value;

        const betterThanRandom = Math.floor((2 / numberOfSwatches) * 100);
        betterThanRandomSpan.innerText = `Much better than random: ${betterThanRandom}%`;

        generateTargetColor();

        const targetSwatch = createSwatch(targetColor);
        bottomPane.appendChild(targetSwatch);

        for (let i = 1; i < numberOfSwatches; i++) {
            let randomSwatchColor;
            if (visionMode === 'RB') {
                randomSwatchColor = `rgb(${randomColor()}, 0, ${randomColor()})`;
            } else if (visionMode === 'GB') {
                randomSwatchColor = `rgb(0, ${randomColor()}, ${randomColor()})`;
            } else {
                randomSwatchColor = `rgb(${randomColor()}, ${randomColor()}, ${randomColor()})`;
            }
            const randomSwatch = createSwatch(randomSwatchColor);
            bottomPane.appendChild(randomSwatch);
        }

        for (let i = bottomPane.children.length; i >= 0; i--) {
            bottomPane.appendChild(bottomPane.children[Math.random() * i | 0]);
        }

        startTime = new Date().getTime();
    }

    function toggleVision() {
        visionMode = document.querySelector('input[name="vision"]:checked').value;
        guesses = 0;
        correctGuesses = 0;
        totalTime = 0;
        guessesSpan.innerText = `Guesses: ${guesses}`;
        correctSpan.innerText = `Correct: ${correctGuesses}`;
        avgTimeSpan.innerText = `Average Time: 0.00 s`;
        updatePercentage();
        newGame();
    }

    function toggleMode() {
        isRGBMode = document.querySelector('input[name="mode"]:checked').value === 'RGB';
        newGame();
    }

    function toggleTheme() {
        isDarkMode = document.querySelector('input[name="theme"]:checked').value === 'Dark';
        document.body.style.backgroundColor = isDarkMode ? 'black' : 'white';
        document.body.style.color = isDarkMode ? 'white' : 'black';
        guessedColorDiv.style.backgroundColor = isDarkMode ? 'black' : 'white';
    }

    function showClues() {
        clueUsed = true;
        const sumColorDivs = document.querySelectorAll('.sumColor');
        sumColorDivs.forEach(div => div.style.display = 'block');
        setTimeout(() => {
            sumColorDivs.forEach(div => div.style.display = 'none');
        }, 1000);
    }

    function showOnboarding(page) {
        onboardingPages.forEach((p, index) => {
            p.style.display = index === page ? 'block' : 'none';
        });
        prevButton.style.display = page === 0 ? 'none' : 'inline-block';
        nextButton.style.display = page === onboardingPages.length - 1 ? 'none' : 'inline-block';
        skipButton.style.display = page === onboardingPages.length - 1 ? 'none' : 'inline-block';
        currentPage = page;
    }

    // Add touch event listeners
    slider.addEventListener('touchstart', function(e) {
        e.preventDefault(); // Prevent default touch zoom behavior
    });

    slider.addEventListener('input', function() {
        const levelNames = {
            2: "Potato",
            3: "Child's Play",
            4: "Breezy",
            5: "Normal",
            6: "Spicy",
            7: "Edgy",
            8: "Tricky",
            9: "Challenging",
            10: "Beast Mode",
            11: "Monster",
            12: "Savage",
            13: "Insane"
        };
        difficultyLabel.innerText = `${slider.value} - ${levelNames[slider.value]}`;
        guesses = 0;
        correctGuesses = 0;
        totalTime = 0;
        guessesSpan.innerText = `Guesses: ${guesses}`;
        correctSpan.innerText = `Correct: ${correctGuesses}`;
        avgTimeSpan.innerText = `Average Time: 0.00 s`;
        updatePercentage();
        newGame();
    });

    // Add both click and touch event listeners for buttons
    newGameButton.addEventListener('click', newGame);
    newGameButton.addEventListener('touchstart', (e) => {
        e.preventDefault();
        newGame();
    });

    clueButton.addEventListener('click', showClues);
    clueButton.addEventListener('touchstart', (e) => {
        e.preventDefault();
        showClues();
    });

    infoButton.addEventListener('click', () => {
        infoButton.blur();
        infoModal.style.display = "block";
    });
    infoButton.addEventListener('touchstart', (e) => {
        e.preventDefault();
        infoButton.blur();
        infoModal.style.display = "block";
    });

    colorInfoButton.addEventListener('click', () => {
        colorInfoButton.blur();
        colorInfoModal.style.display = "block";
    });
    colorInfoButton.addEventListener('touchstart', (e) => {
        e.preventDefault();
        colorInfoButton.blur();
        colorInfoModal.style.display = "block";
    });

    closeButtons.forEach(button => {
        button.addEventListener('click', () => {
            infoModal.style.display = "none";
            colorInfoModal.style.display = "none";
            onboardingModal.style.display = "none";
        });
        button.addEventListener('touchstart', (e) => {
            e.preventDefault();
            infoModal.style.display = "none";
            colorInfoModal.style.display = "none";
            onboardingModal.style.display = "none";
        });
    });

    window.addEventListener('click', (event) => {
        if (event.target == infoModal) {
            infoModal.style.display = "none";
        } else if (event.target == colorInfoModal) {
            colorInfoModal.style.display = "none";
        } else if (event.target == onboardingModal) {
            onboardingModal.style.display = "none";
        }
    });

    window.addEventListener('touchstart', (event) => {
        if (event.target == infoModal) {
            infoModal.style.display = "none";
        } else if (event.target == colorInfoModal) {
            colorInfoModal.style.display = "none";
        } else if (event.target == onboardingModal) {
            onboardingModal.style.display = "none";
        }
    });

    visionToggles.forEach(toggle => {
        toggle.addEventListener('change', toggleVision);
        toggle.addEventListener('touchstart', (e) => {
            e.preventDefault();
            toggleVision();
        });
    });

    modeToggles.forEach(toggle => {
        toggle.addEventListener('change', toggleMode);
        toggle.addEventListener('touchstart', (e) => {
            e.preventDefault();
            toggleMode();
        });
    });

    themeToggles.forEach(toggle => {
        toggle.addEventListener('change', toggleTheme);
        toggle.addEventListener('touchstart', (e) => {
            e.preventDefault();
            toggleTheme();
        });
    });

    // Add touch events for navigation buttons
    prevButton.addEventListener('click', () => showOnboarding(currentPage - 1));
    prevButton.addEventListener('touchstart', (e) => {
        e.preventDefault();
        showOnboarding(currentPage - 1);
    });

    nextButton.addEventListener('click', () => showOnboarding(currentPage + 1));
    nextButton.addEventListener('touchstart', (e) => {
        e.preventDefault();
        showOnboarding(currentPage + 1);
    });

    skipButton.addEventListener('click', () => onboardingModal.style.display = "none");
    skipButton.addEventListener('touchstart', (e) => {
        e.preventDefault();
        onboardingModal.style.display = "none";
    });

    skipOnboarding.addEventListener('click', () => onboardingModal.style.display = "none");
    skipOnboarding.addEventListener('touchstart', (e) => {
        e.preventDefault();
        onboardingModal.style.display = "none";
    });

    // Initialize with Dark Mode RGB and Normal Vision
    document.querySelector('input[name="vision"][value="Normal"]').checked = true;
    document.querySelector('input[name="mode"][value="RGB"]').checked = true;
    document.querySelector('input[name="theme"][value="Dark"]').checked = true;
    document.body.style.backgroundColor = 'black';
    document.body.style.color = 'white';
    newGame();

    // Show onboarding modal
    onboardingModal.style.display = "block";
    showOnboarding(0);
</script>

</body>
</html>