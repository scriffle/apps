<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>OpenTrivia+ | Quiz App</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <style>
    :root {
      --bg: #f8f8fd;
      --fg: #222446;
      --card: #fff;
      --primary: #6256e5;
      --primary-dark: #4731b6;
      --accent: #43cbcc;
      --accent-fade: #e2f8fa;
      --error: #e15656;
      --ok: #3ec58d;
      --gray: #a6accd;
    }
    html, body { margin:0; padding:0; font-family:'Segoe UI',Roboto,sans-serif; background: var(--bg); color: var(--fg);}
    #app { max-width:480px; margin:1em auto; background:var(--card); border-radius:1em; box-shadow:0 3px 20px #0001; overflow:hidden; min-height:340px;}
    h2, h3 { margin:.5em 0 .25em 0; font-size:1.28em;}
    #settings, #quiz, #summary, #stats { padding:1.1em .8em .8em .8em; }
    label { margin:0 .6em 0 0; font-size:.98em; }
    select, button { font-size:.98em; margin:.1em .4em .4em 0; padding:.38em 1em; border-radius:1em; border:1px solid #ccc; }
    button.primary { background:var(--primary); color:#fff; border:none; font-weight:bold; }
    button.primary:hover, button.primary:focus { background:var(--primary-dark); }
    button:disabled { opacity:.5; }
    #biteBtn { background:var(--accent); color:#222; border:none; font-weight:bold; }
    #biteBtn:hover, #biteBtn:focus { background:var(--primary); color:#fff; }
    .top-bar {
      display:flex; justify-content: flex-end; align-items:center; gap:.55em;
      margin-bottom:.3em; margin-top: -.5em;
    }
    .bite-bar {
      background: var(--accent-fade);
      color: var(--primary-dark);
      border-radius: .8em;
      margin-bottom: .6em;
      margin-top: .3em;
      padding: .25em .9em;
      font-size:.99em;
      font-style: italic;
      min-height: 1.2em;
      transition: opacity .4s;
      pointer-events: none;
      user-select: none;
    }
    .bite-bar.hide { opacity:0; }
    .bite-bar.in { opacity:1; }
    .q-progress { color:var(--gray); margin-bottom:.5em; }
    .timer-bar-wrap { height:1.3em; display:flex; align-items:center; margin:.2em 0 .2em 0;}
    .timer-bar-bg {
      background:#eee; width:100%; height:1em; border-radius:.7em; overflow:hidden; margin-right:.6em;
      border:1px solid #ececff; flex:1 1 auto;
    }
    .timer-bar-fg {
      background: linear-gradient(90deg, #43cbcc 50%, #6256e5 100%);
      height:100%; border-radius:.7em; transition:width .2s cubic-bezier(.8,.2,.4,1.15);
    }
    .timer-txt { font-size:.98em; font-weight:500; min-width:2.6em; text-align:right; color:var(--primary-dark);}
    .q-card { background:var(--accent-fade); border-radius:.6em; box-shadow:0 1px 5px #0001; padding:.75em 1em; margin-bottom:.5em; margin-top:.5em; position:relative;
      animation: fadein 0.28s cubic-bezier(.6,0,.5,1.2);}
    @keyframes fadein { 0%{ opacity:0; transform:translateY(12px) scale(.98);} 100%{opacity:1;transform:none;} }
    .answers { margin:.5em 0; display: flex; flex-direction: column; gap: .3em; }
    .answer-btn {
      border-radius: 2em; border: 1px solid #dedcff; background: #fff;
      padding: .68em 1em; cursor:pointer; text-align:left; transition:background .16s, box-shadow .18s, border .17s, color .19s;
      font-size:.99em; box-shadow:0 0 0 0 #6256e566; position:relative;
    }
    .answer-btn.selected, .answer-btn:focus { background: #e8e7fa; border-color: var(--primary); color:var(--primary); outline: none;}
    .answer-btn.correct { background:var(--ok); border-color:#39b97a; color:#fff; font-weight:bold;}
    .answer-btn.incorrect { background:var(--error); border-color:#b73c3c; color:#fff;}
    .score {
      font-size:1.04em; margin: 0 0 .7em 0;
      animation: pop 0.33s cubic-bezier(.6,0,.5,1.09);
    }
    @keyframes pop {0%{transform:scale(.97);opacity:0;} 60%{transform:scale(1.04);} 100%{transform:none;opacity:1;}}
    .hidden { display:none !important; }
    .review-card { margin:.4em 0; padding: .7em; border-radius:.6em; background:#fafaff; border-left:4px solid #eee; box-shadow:0 1px 2px #0001;
      animation: fadein 0.28s cubic-bezier(.5,0,.5,1.1);}
    .review-card.correct { border-left:4px solid var(--ok); background: #e9f9f1;}
    .review-card.incorrect { border-left:4px solid var(--error); background: #fff0f3;}
    #statsBtn, #reviewBtn, #menuBtn { background:var(--accent); color:#222; border:none; font-weight:bold; padding: .4em 1.1em;}
    #statsBtn:hover, #reviewBtn:hover, #menuBtn:hover { background: var(--primary); color:#fff;}
    #summary .score { text-align:center; }
    .stat-table { width:100%; border-collapse:collapse; font-size:.97em; margin:.7em 0;}
    .stat-table th, .stat-table td { text-align:left; padding:.25em .5em; }
    .stat-table th { color:var(--primary-dark);}
    .stat-table tr { border-bottom:1px solid #efeffb;}
    .stat-table tr:last-child { border-bottom:none;}
    .stat-title { font-size:1.05em; font-weight:bold; margin-top:.7em; }
    .missed-q { color:var(--error); font-size:.93em;}
    .fade { opacity: 0; transition: opacity .25s; }
    .fade.in { opacity: 1; }
    .auto-advance-wrap { margin:.2em 0 .2em 0; display: flex; align-items:center; font-size:.97em; color:var(--primary-dark);}
    .auto-advance-wrap input[type=checkbox] { accent-color: var(--primary); margin-right:.3em; }
    @media (max-width:700px) {
      #app { max-width:100vw; margin:0; border-radius:0; box-shadow:none; }
      #settings, #quiz, #summary, #stats { padding:.8em .15em .4em .15em; }
      .q-card, .review-card { margin-left:-.1em; margin-right:-.1em;}
      .answer-btn { font-size:.97em; padding:.7em .6em;}
      .top-bar { flex-direction: column; gap:.35em; margin-bottom:.2em;}
      .bite-bar { margin-left:-.13em; margin-right:-.13em;}
    }
    @media (max-width:420px){
      #app { min-height:220px;}
      .q-card, .review-card { padding:.5em .15em;}
      #settings, #quiz, #summary, #stats { padding:.4em .08em .3em .08em;}
    }
  </style>
</head>
<body>
  <div id="app">
    <div id="settings">
      <h2>OpenTrivia+ Quiz</h2>
      <div class="top-bar">
        <button id="statsBtn" type="button" title="View Stats">üìä Stats</button>
        <button id="biteBtn" type="button" title="Surprise Me!">üçî Bite Me!</button>
      </div>
      <div id="biteBar" class="bite-bar hide"></div>
      <div style="margin-bottom:.35em;">
        <label>
          Category:
          <select id="catSel"><option value="">Any</option></select>
        </label>
        <label>
          Difficulty:
          <select id="diffSel">
            <option value="">Any</option>
            <option value="easy">Easy</option>
            <option value="medium">Medium</option>
            <option value="hard">Hard</option>
          </select>
        </label>
        <label>
          Type:
          <select id="typeSel">
            <option value="">Any</option>
            <option value="multiple">Multiple Choice</option>
            <option value="boolean">True / False</option>
          </select>
        </label>
        <label>
          Questions:
          <select id="amountSel">
            <option>5</option>
            <option selected>10</option>
            <option>15</option>
            <option>20</option>
          </select>
        </label>
      </div>
      <div class="auto-advance-wrap">
        <input type="checkbox" id="autoAdvance" checked>
        <label for="autoAdvance" style="margin:0;cursor:pointer;">Auto-advance after answer (5s)</label>
      </div>
      <button id="startBtn" class="primary">Start Quiz</button>
      <div id="settingsMsg" style="color:var(--error);margin-top:.4em;"></div>
    </div>
    <div id="quiz" class="hidden fade"></div>
    <div id="summary" class="hidden fade"></div>
    <div id="stats" class="hidden fade"></div>
  </div>
  <script>
    const $ = sel => document.querySelector(sel);
    const decode = str => decodeURIComponent(str.replace(/\+/g, ' '));
    let allQuestionsAsked = {}, questions = [], userAnswers = [], current = 0, score = 0, lastGameInfo = null, sessionQuestionsSeen = new Set();
    let categoriesList = [];
    let timerInterval = null, timerTimeout = null, timerValue = 30, timerActive = false, autoAdvanceOn = true, timerExpired = false;

    fetch('https://opentdb.com/api_category.php')
      .then(r=>r.json())
      .then(data=>{
        let cats = data.trivia_categories;
        categoriesList = cats;
        let catSel = $('#catSel');
        cats.forEach(c=>{
          let o = document.createElement('option');
          o.value = c.id; o.textContent = c.name;
          catSel.appendChild(o);
        });
      });

    function getStats() {
      return JSON.parse(localStorage.getItem("opentriviaplus_stats_v1") || "{}");
    }
    function saveStats(stats) {
      localStorage.setItem("opentriviaplus_stats_v1", JSON.stringify(stats));
    }
    function updateStats(game) {
      let stats = getStats();
      stats.overall = stats.overall || {games:0, questions:0, correct:0, wrong:0, streak:0, bestStreak:0};
      stats.overall.games++;
      stats.overall.questions += game.questions.length;
      stats.overall.correct += game.questions.filter((q,i)=>game.answers[i]===q.correct).length;
      stats.overall.wrong += game.questions.filter((q,i)=>game.answers[i]!==q.correct).length;
      if(game.score === game.questions.length) {
        stats.overall.streak = (stats.overall.streak||0)+1;
        stats.overall.bestStreak = Math.max(stats.overall.streak, stats.overall.bestStreak||0);
      } else {
        stats.overall.streak = 0;
      }
      game.questions.forEach((q,i)=>{
        let key = [q.category, q.difficulty, q.type].join('|');
        stats[key] = stats[key] || {games:0, questions:0, correct:0, wrong:0, mostMissed: {}};
        stats[key].games++; stats[key].questions++;
        if(game.answers[i]===q.correct) stats[key].correct++;
        else {
          stats[key].wrong++;
          stats[key].mostMissed[q.question] = (stats[key].mostMissed[q.question]||0)+1;
        }
      });
      saveStats(stats);
    }

    $('#biteBtn').onclick = ()=>{
      if(!categoriesList.length) return;
      let c = categoriesList[Math.floor(Math.random()*categoriesList.length)];
      let dArr = ["easy","medium","hard",""];
      let tArr = ["multiple","boolean",""];
      let d = dArr[Math.floor(Math.random()*dArr.length)];
      let t = tArr[Math.floor(Math.random()*tArr.length)];
      $('#catSel').value = c.id;
      $('#diffSel').value = d;
      $('#typeSel').value = t;
      let funMsgs = [
        "Here comes the spice! üå∂Ô∏è",
        "Mixing it up for you!",
        "This one's a surprise meal!",
        "Randomised... ready to quiz!",
        "You asked for chaos. üçî"
      ];
      let msg = `Category: <b>${c.name}</b> &mdash; Difficulty: <b>${d ? d[0].toUpperCase()+d.slice(1):'Any'}</b> &mdash; Type: <b>${t ? (t==="multiple"?"MCQ":"T/F"):"Any"}</b> <span style="font-weight:400;">‚Äî ${funMsgs[Math.floor(Math.random()*funMsgs.length)]}</span>`;
      let biteBar = $('#biteBar');
      biteBar.innerHTML = msg;
      biteBar.classList.remove('hide');
      setTimeout(()=>biteBar.classList.add('in'), 10);
      setTimeout(()=>{
        biteBar.classList.remove('in');
        setTimeout(()=>biteBar.classList.add('hide'), 340);
      }, 2600);
    };

    $('#autoAdvance').onchange = () => { autoAdvanceOn = $('#autoAdvance').checked; };

    $('#startBtn').onclick = async ()=>{
      $('#settingsMsg').textContent = '';
      $('#startBtn').disabled = true;
      try {
        let base = 'https://opentdb.com/api.php?encode=url3986';
        base += '&amount=' + $('#amountSel').value;
        if($('#catSel').value) base += '&category=' + $('#catSel').value;
        if($('#diffSel').value) base += '&difficulty=' + $('#diffSel').value;
        if($('#typeSel').value) base += '&type=' + $('#typeSel').value;
        let sessionKey = ['session', $('#catSel').value, $('#diffSel').value, $('#typeSel').value].join('|');
        allQuestionsAsked[sessionKey] = allQuestionsAsked[sessionKey] || new Set();
        sessionQuestionsSeen = allQuestionsAsked[sessionKey];

        let attempt = 0, maxTries = 4, newQs;
        do {
          let r = await fetch(base);
          let data = await r.json();
          newQs = data.results.filter(q=>!sessionQuestionsSeen.has(q.question));
          attempt++;
        } while (newQs.length < $('#amountSel').value && attempt < maxTries);

        if(!newQs.length){
          $('#settingsMsg').textContent = "No new questions found for these settings. Try different options!";
          $('#startBtn').disabled = false;
          return;
        }

        questions = newQs.map(q=>{
          let all = q.incorrect_answers.map(decode);
          all.push(decode(q.correct_answer));
          all = q.type=="multiple" ? shuffle(all) : ["True","False"];
          return {
            question: decode(q.question),
            correct: decode(q.correct_answer),
            all,
            type: q.type,
            category: decode(q.category),
            difficulty: q.difficulty,
          };
        });
        questions.forEach(q=>sessionQuestionsSeen.add(q.question));
        userAnswers = []; score = 0; current = 0;
        $('#settings').classList.add('hidden');
        fadeOutIn('#summary', false);
        fadeOutIn('#stats', false);
        fadeOutIn('#quiz', true);
        renderQuiz();
      } catch (e) {
        $('#settingsMsg').textContent = "Network or server error. Please try again.";
        $('#startBtn').disabled = false;
      }
    };

    function renderQuiz(){
      clearTimers();
      timerValue = 30; timerExpired = false; timerActive = true;
      let q = questions[current];
      let html = `
        <div class="top-bar" style="margin-bottom:.3em;margin-top:.02em;">
          <button id="menuBtn" type="button" title="Menu">üè† Menu</button>
          <button id="reviewBtn" type="button" title="Review">üìù Review</button>
        </div>
        <div class="q-progress">Question ${current+1} of ${questions.length}</div>
        <div class="timer-bar-wrap">
          <div class="timer-bar-bg"><div class="timer-bar-fg" id="timerFG" style="width:100%"></div></div>
          <div class="timer-txt" id="timerTxt">30s</div>
        </div>
        <div class="q-card">
          <div style="font-size:1.05em; font-weight:600; margin-bottom:.19em">${q.question}</div>
          <div style="color:var(--primary);font-size:.94em;">${q.category}</div>
          <div style="color:var(--gray);font-size:.92em;">Difficulty: ${capitalize(q.difficulty)}</div>
          <div class="answers">`;
      q.all.forEach(a=>{
        html += `<button class="answer-btn" data-answer="${a}" tabindex="0">${a}</button>`;
      });
      html += `</div></div>
        <div class="score">Score: <span id="scoreVal">${score}</span> / ${questions.length}</div>
        <button id="nextBtn" class="primary" disabled>${current<questions.length-1?"Next":"Finish"}</button>
      `;
      $('#quiz').innerHTML = html;

      $('#menuBtn').onclick = ()=>{ clearTimers(); backToMenu(); };
      $('#reviewBtn').onclick = ()=>{ clearTimers(); renderSummary(); };

      document.querySelectorAll('.answer-btn').forEach(btn=>{
        btn.onclick = ()=>{
          if(userAnswers[current]) return;
          let ans = btn.getAttribute('data-answer');
          userAnswers[current] = ans;
          document.querySelectorAll('.answer-btn').forEach(b=>{
            let bAns = b.getAttribute('data-answer');
            b.classList.remove('selected');
            if(bAns == q.correct) b.classList.add('correct');
            else if(bAns == ans) b.classList.add('incorrect');
          });
          btn.classList.add('selected');
          if(ans==q.correct) score++;
          $('#scoreVal').textContent = score;
          $('#nextBtn').disabled = false;
          timerActive = false;
          if(autoAdvanceOn) timerTimeout = setTimeout(()=>advanceQuiz(), 5000);
        };
        btn.onkeyup = e => {
          if((e.key === "Enter" || e.key === " ")){
            btn.click();
          }
        };
      });
      $('#nextBtn').onclick = ()=>{
        advanceQuiz();
      };
      // Timer logic
      updateTimerBar();
      timerInterval = setInterval(()=>{
        if(!timerActive) return;
        timerValue--;
        updateTimerBar();
        if(timerValue <= 0) {
          timerExpired = true;
          timerActive = false;
          handleTimeout();
        }
      }, 1000);
    }

    function handleTimeout() {
      if(!userAnswers[current]) {
        userAnswers[current] = "(timeout)";
        document.querySelectorAll('.answer-btn').forEach(b=>{
          let bAns = b.getAttribute('data-answer');
          if(bAns == questions[current].correct) b.classList.add('correct');
        });
        $('#nextBtn').disabled = false;
      }
      if(autoAdvanceOn) timerTimeout = setTimeout(()=>advanceQuiz(), 2200);
    }

    function updateTimerBar() {
      let percent = (timerValue/30)*100;
      $('#timerFG').style.width = percent + "%";
      $('#timerTxt').textContent = timerValue + "s";
      if(timerValue <= 5) $('#timerTxt').style.color = "var(--error)";
      else $('#timerTxt').style.color = "var(--primary-dark)";
    }
    function clearTimers() {
      clearInterval(timerInterval);
      clearTimeout(timerTimeout);
      timerActive = false;
    }
    function advanceQuiz() {
      clearTimers();
      if(current < questions.length-1) {
        current++;
        fadeOutIn('#quiz', true, renderQuiz);
      } else {
        renderSummary();
      }
    }

    function renderSummary(){
      clearTimers();
      fadeOutIn('#quiz', false);
      let html = `<h3>Quiz Complete!</h3>
      <div class="score" style="font-size:1.13em;">Final Score: <b>${score}</b> / ${questions.length}</div>
      <button class="primary" id="playAgainBtn">Play Again</button>
      <button id="menuBtn" type="button" style="float:right">üè† Menu</button>
      <h4 style="margin:1em 0 .4em 0">Review Answers:</h4>`;
      questions.forEach((q,i)=>{
        let user = userAnswers[i];
        let correct = user==q.correct;
        let displayUser = (user === "(timeout)") ? "<em>Timed out</em>" : (user||"<em>No answer</em>");
        html += `<div class="review-card ${correct?'correct':'incorrect'}">
          <div style="font-weight:bold">${i+1}. ${q.question}</div>
          <div>Your answer: <span style="color:${correct?'#388e3c':'#d32f2f'}">${displayUser}</span></div>
          <div>Correct answer: <b>${q.correct}</b></div>
          <div style="color:var(--primary);font-size:.92em;">${q.category}, Difficulty: ${capitalize(q.difficulty)}</div>
        </div>`;
      });
      $('#summary').innerHTML = html;
      fadeOutIn('#summary', true);
      $('#playAgainBtn').onclick = ()=>{
        fadeOutIn('#summary', false);
        $('#settings').classList.remove('hidden');
        $('#startBtn').disabled = false;
      };
      document.querySelectorAll('#summary #menuBtn').forEach(btn=>{
        btn.onclick = ()=>{ backToMenu(); };
      });
      if(questions.length) {
        lastGameInfo = {
          questions: questions.map(q=>({...q})),
          answers: userAnswers.slice(),
          score,
          date: Date.now()
        };
        updateStats(lastGameInfo);
      }
    }

    function backToMenu() {
      clearTimers();
      fadeOutIn('#quiz', false);
      fadeOutIn('#summary', false);
      fadeOutIn('#stats', false);
      $('#settings').classList.remove('hidden');
      $('#startBtn').disabled = false;
    }

    $('#statsBtn').onclick = renderStats;
    function renderStats() {
      clearTimers();
      fadeOutIn('#settings', false);
      fadeOutIn('#quiz', false);
      fadeOutIn('#summary', false);
      let stats = getStats();
      let html = `<h3>üìä Your Stats</h3>
      <button id="menuBtn" type="button" style="float:right">üè† Menu</button>
      <div class="stat-title">Overall</div>
      <table class="stat-table">
        <tr><th>Games Played</th><td>${stats.overall?.games||0}</td></tr>
        <tr><th>Questions</th><td>${stats.overall?.questions||0}</td></tr>
        <tr><th>Correct</th><td>${stats.overall?.correct||0}</td></tr>
        <tr><th>Wrong</th><td>${stats.overall?.wrong||0}</td></tr>
        <tr><th>Perfect Streak</th><td>${stats.overall?.bestStreak||0}</td></tr>
      </table>
      `;
      for(let k in stats){
        if(k === 'overall') continue;
        let [cat, diff, type] = k.split('|');
        html += `<div class="stat-title">${cat} | ${capitalize(diff)} | ${capitalize(type)}</div>
        <table class="stat-table">
          <tr><th>Games</th><td>${stats[k].games}</td></tr>
          <tr><th>Questions</th><td>${stats[k].questions}</td></tr>
          <tr><th>Correct</th><td>${stats[k].correct}</td></tr>
          <tr><th>Wrong</th><td>${stats[k].wrong}</td></tr>
        </table>`;
        let missed = Object.entries(stats[k].mostMissed||{}).sort((a,b)=>b[1]-a[1]).slice(0,3);
        if(missed.length){
          html += `<div class="missed-q">Most missed:<ul style="margin:.2em 0 .2em .2em;padding:0;">`;
          missed.forEach(([q,n])=>{
            html += `<li>${q} <span style="color:#999;">(${n}x)</span></li>`;
          });
          html += `</ul></div>`;
        }
      }
      html += `<button class="primary" id="clearStatsBtn" style="margin-top:.7em;">Reset All Stats</button>`;
      $('#stats').innerHTML = html;
      fadeOutIn('#stats', true);
      document.querySelectorAll('#stats #menuBtn').forEach(btn=>{
        btn.onclick = ()=>{ backToMenu(); };
      });
      $('#clearStatsBtn').onclick = ()=>{
        if(confirm("Clear all local stats? This cannot be undone!")){
          localStorage.removeItem("opentriviaplus_stats_v1");
          renderStats();
        }
      };
    }

    function capitalize(s){ return s ? s[0].toUpperCase()+s.slice(1) : ""; }
    function shuffle(a){
      for(let i=a.length-1;i>0;i--){
        let j=Math.floor(Math.random()*(i+1));
        [a[i],a[j]]=[a[j],a[i]];
      } return a;
    }
    function fadeOutIn(sel, show, cb) {
      let el = $(sel);
      if(!el) return;
      if(show) {
        el.classList.remove('hidden'); setTimeout(()=>el.classList.add('in'), 20);
        if(cb) setTimeout(cb, 230);
      } else {
        el.classList.remove('in');
        setTimeout(()=>el.classList.add('hidden'), 230);
      }
    }
    document.body.onkeyup = e=>{
      if(e.key==="Escape") {clearTimers(); backToMenu();}
    };
  </script>
</body>
</html>
