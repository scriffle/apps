<!DOCTYPE html>
<html>
<head>
    <title>Multiple Genetic Car Evolutions</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        .controls {
            position: fixed;
            top: 10px;
            left: 10px;
            background: rgba(255, 255, 255, 0.9);
            padding: 10px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0,0,0,0.1);
            z-index: 1000;
        }
        .container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            padding: 10px;
            padding-top: 60px;
        }
        .sim-container {
            border: 1px solid #ccc;
            padding: 5px;
            transition: all 0.3s ease;
        }
        .stats {
            font-size: 12px;
            text-align: center;
        }
        #simulationCount {
            width: 100px;
        }
    </style>
</head>
<body>
    <div class="controls">
        <input type="range" id="simulationCount" min="4" max="11" step="1" value="4">
        <span id="simCount">16 simulations</span>
    </div>
    <div class="container" id="simulations"></div>
    <script>
        const {
            Engine,
            Render,
            World,
            Bodies,
            Constraint,
            Events,
            Runner,
            Bounds
        } = Matter;

        let activeSimulations = [];

        class Car {
            constructor(x, y, genome, world, direction) {
                this.direction = direction; // 1 for right, -1 for left
                this.genome = genome || {
                    bodyWidth: Math.random() * 60 + 40,
                    bodyHeight: Math.random() * 30 + 20,
                    wheelSize: Math.random() * 20 + 10,
                    wheelOffset: Math.random() * 20 - 10
                };
                
                this.body = Bodies.rectangle(x, y, this.genome.bodyWidth, this.genome.bodyHeight, {
                    density: 0.002,
                    friction: 0.5,
                    render: {
                        fillStyle: direction === 1 ? '#3498db' : '#e74c3c'
                    }
                });

                const wheelOpts = {
                    density: 0.002,
                    friction: 0.7,
                    render: {
                        fillStyle: direction === 1 ? '#2980b9' : '#c0392b'
                    }
                };

                this.wheelA = Bodies.circle(
                    x - this.genome.bodyWidth/2 + this.genome.wheelOffset, 
                    y + this.genome.bodyHeight/2,
                    this.genome.wheelSize, 
                    wheelOpts
                );

                this.wheelB = Bodies.circle(
                    x + this.genome.bodyWidth/2 + this.genome.wheelOffset,
                    y + this.genome.bodyHeight/2,
                    this.genome.wheelSize,
                    wheelOpts
                );

                this.constraintA = Constraint.create({
                    bodyA: this.body,
                    bodyB: this.wheelA,
                    stiffness: 0.5
                });

                this.constraintB = Constraint.create({
                    bodyA: this.body,
                    bodyB: this.wheelB,
                    stiffness: 0.5
                });

                World.add(world, [
                    this.body,
                    this.wheelA,
                    this.wheelB,
                    this.constraintA,
                    this.constraintB
                ]);

                this.startX = x;
            }

            getDistance() {
                return Math.abs(this.body.position.x - this.startX);
            }

            destroy(world) {
                World.remove(world, [
                    this.body,
                    this.wheelA,
                    this.wheelB,
                    this.constraintA,
                    this.constraintB
                ]);
            }
        }

        class Simulation {
            constructor(containerId, index) {
                this.engine = Engine.create();
                this.container = document.getElementById(containerId);
                this.index = index;
                this.direction = index % 2 === 0 ? 1 : -1;
                
                this.render = Render.create({
                    element: this.container,
                    engine: this.engine,
                    options: {
                        width: 250,
                        height: 150,
                        wireframes: false,
                        hasBounds: true
                    }
                });

                // Create ground with bumps
                const ground = [];
                for (let i = 0; i < 100; i++) {
                    const segment = Bodies.rectangle(
                        i * 30, 
                        100 + Math.sin(i * 0.3) * 20, 
                        30, 
                        20, 
                        { 
                            isStatic: true,
                            render: {
                                fillStyle: '#2c3e50'
                            }
                        }
                    );
                    ground.push(segment);
                }
                World.add(this.engine.world, ground);

                this.generation = 1;
                this.bestDistance = 0;
                this.simulationTime = 0;
                this.car = new Car(this.direction === 1 ? 50 : 1500, 50, null, this.engine.world, this.direction);

                this.statsDiv = document.createElement('div');
                this.statsDiv.className = 'stats';
                this.container.appendChild(this.statsDiv);
                this.updateStats();

                Events.on(this.engine, 'beforeUpdate', () => {
                    this.simulationTime++;
                    if (this.simulationTime >= 300) {
                        this.evolve();
                    }
                    
                    const centerX = this.car.body.position.x;
                    const centerY = this.car.body.position.y;
                    Render.lookAt(this.render, {
                        min: { x: centerX - 100, y: 0 },
                        max: { x: centerX + 100, y: 150 }
                    });
                });

                this.runner = Runner.create();
                Runner.run(this.runner, this.engine);
                Render.run(this.render);
            }

            evolve() {
                const distance = this.car.getDistance();
                if (distance > this.bestDistance) {
                    this.bestDistance = distance;
                }

                const newGenome = {
                    bodyWidth: this.car.genome.bodyWidth + (Math.random() - 0.5) * 10,
                    bodyHeight: this.car.genome.bodyHeight + (Math.random() - 0.5) * 10,
                    wheelSize: this.car.genome.wheelSize + (Math.random() - 0.5) * 5,
                    wheelOffset: this.car.genome.wheelOffset + (Math.random() - 0.5) * 5
                };

                this.car.destroy(this.engine.world);
                this.car = new Car(
                    this.direction === 1 ? 50 : 1500,
                    50, 
                    newGenome, 
                    this.engine.world,
                    this.direction
                );
                
                this.generation++;
                this.simulationTime = 0;
                this.updateStats();
            }

            updateStats() {
                this.statsDiv.innerHTML = `Gen: ${this.generation}<br>Best: ${Math.round(this.bestDistance)}`;
            }

            destroy() {
                Render.stop(this.render);
                Runner.stop(this.runner);
                World.clear(this.engine.world);
                Engine.clear(this.engine);
                this.render.canvas.remove();
                this.statsDiv.remove();
            }
        }

        function sortSimulations() {
            // Sort simulations by best distance
            activeSimulations.sort((a, b) => b.bestDistance - a.bestDistance);
            
            // Reorder DOM elements
            const container = document.getElementById('simulations');
            activeSimulations.forEach(sim => {
                container.appendChild(sim.container);
            });
        }

        function updateSimulations(count) {
            // Clean up existing simulations
            activeSimulations.forEach(sim => sim.destroy());
            activeSimulations = [];
            
            // Clear container
            const container = document.getElementById('simulations');
            container.innerHTML = '';
            
            // Create new simulations
            for (let i = 0; i < count; i++) {
                const simContainer = document.createElement('div');
                simContainer.className = 'sim-container';
                simContainer.id = `sim${i}`;
                container.appendChild(simContainer);
                activeSimulations.push(new Simulation(`sim${i}`, i));
            }

            // Start periodic sorting
            if (window.sortInterval) {
                clearInterval(window.sortInterval);
            }
            window.sortInterval = setInterval(sortSimulations, 1000);
        }

        // Initialize slider
        const slider = document.getElementById('simulationCount');
        const simCountDisplay = document.getElementById('simCount');
        
        slider.addEventListener('input', (e) => {
            const count = Math.pow(2, parseInt(e.target.value));
            simCountDisplay.textContent = `${count} simulations`;
            updateSimulations(count);
        });

        // Initial setup
        updateSimulations(16);
    </script>
</body>
</html>