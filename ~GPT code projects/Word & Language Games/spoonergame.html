<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Contrepèterie</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 20px;
            background-color: #f4f7fa;
        }
        h1 {
            margin: 0 0 10px;
            font-size: 2em;
        }
        .status-bar {
            width: 100%;
            text-align: center;
            margin-bottom: 10px;
            font-size: 1.2em;
        }
        .panels {
            display: flex;
            justify-content: space-around;
            width: 100%;
            margin-bottom: 20px;
        }
        .panel {
            border: 2px dashed #aaa;
            border-radius: 10px;
            width: 45%;
            padding: 15px;
            min-height: 100px;
            background-color: white;
        }
        .panel strong {
            display: block;
            margin-bottom: 10px;
            font-weight: bold;
        }
        .container {
            display: flex;
            justify-content: space-around;
            width: 100%;
        }
        .word-list {
            border: 2px dashed #aaa;
            border-radius: 10px;
            width: 40%;
            padding: 15px;
            min-height: 150px;
            background-color: white;
            margin-bottom: 20px;
        }
        .word {
            margin: 10px;
            padding: 8px;
            background-color: #cce5ff;
            border-radius: 6px;
            cursor: grab;
            text-align: center;
            font-weight: bold;
        }
        .highlight {
            background-color: #ffe58f;
        }
        .pair {
            padding: 5px;
            margin: 5px 0;
            background-color: #d4edda;
            border-radius: 4px;
            text-align: center;
            font-weight: bold;
        }
    </style>
</head>
<body>

<h1>Contrepèterie</h1>
<div class="status-bar" id="statusBar"></div>
<div class="panels">
    <div class="panel" id="foundPairs">
        <strong>Found Spoonerisms:</strong>
    </div>
    <div class="panel" id="selectedPairs">
        <strong>Selected Pairs (Debug):</strong>
    </div>
</div>
<div class="container">
    <div class="word-list" id="listA"></div>
    <div class="word-list" id="listB"></div>
</div>

<script>
const fullSpoonerisms = {
    "row,wear":"whoa,rare","row,wedding":"whoa,reading","row,west":"whoa,rest","row,whale":"whoa,rail","row,wheel":"whoa,real",
    "row,which":"whoa,rich","row,whip":"whoa,rip","row,white":"whoa,right","row,wide":"whoa,ride","row,wing":"whoa,ring",
    "row,wise":"whoa,rise","row,wound":"whoa,round","rule,scale":"school,rail","rule,scare":"school,rare","rule,scope":"school,rope",
    "rule,skip":"school,rip","rule,tail":"tool,rail","rule,tank":"tool,rank","rule,tap":"tool,wrap","rule,tape":"tool,rape",
    "rule,teach":"tool,reach","rule,tear":"tool,rare","rule,tender":"tool,render","rule,tent":"tool,rent","rule,test":"tool,rest",
    "rule,tide":"tool,ride","rule,tight":"tool,right","rule,tip":"tool,rip","rule,toe":"tool,row","rule,toll":"tool,role",
    "rule,tough":"tool,rough","rule,toward":"tool,reward","rule,tumor":"tool,rumor","rumor,tail":"tumor,rail","rumor,tank":"tumor,rank",
    "rumor,tap":"tumor,wrap","rumor,tape":"tumor,rape","rumor,teach":"tumor,reach","rumor,tear":"tumor,rare","rumor,tender":"tumor,render",
    "rumor,tent":"tumor,rent","rumor,test":"tumor,rest","rumor,tide":"tumor,ride","rumor,tight":"tumor,right","rumor,tip":"tumor,rip",
    "rumor,toe":"tumor,row","rumor,toll":"tumor,role","rumor,tool":"tumor,rule","rumor,tough":"tumor,rough","rumor,toward":"tumor,reward",
    "run,sack":"son,rack","run,sail":"son,rail","run,say":"son,ray","run,seal":"son,real","run,season":"son,reason",
    "run,side":"son,ride","run,silly":"son,really","run,sing":"son,ring","run,size":"son,rise","run,so":"son,row",
    "run,soap":"son,rope","run,sock":"son,rock","run,sole":"son,role","run,song":"son,wrong","run,sound":"son,round",
    "run,suffer":"son,refer","run,suit":"son,root","run,supply":"son,reply","run,supporter":"son,reporter","run,suspect":"son,respect",
    "run,wage":"one,rage","run,wait":"one,rate","run,walk":"one,rock","run,way":"one,ray","run,wear":"one,rare",
    "run,wedding":"one,reading","run,west":"one,rest","run,whale":"one,rail","run,wheel":"one,real","run,which":"one,rich",
    "run,whip":"one,rip","run,white":"one,right","run,whoa":"one,row","run,wide":"one,ride","run,wing":"one,ring",
    "run,wise":"one,rise","run,wound":"one,round","runner,training":"trainer,running","running,stack":"stunning,rack",
    "running,stage":"stunning,rage","running,stair":"stunning,rare","running,state":"stunning,rate","running,steady":"stunning,ready",
    "running,steal":"stunning,real","running,step":"stunning,rep","running,stock":"stunning,rock","running,stuff":"stunning,rough",
    "sack,stake":"stack,sake","sack,stand":"stack,sand","sack,steal":"stack,seal"
};

let selectedPairs = [];
let validWordsA = [], validWordsB = [];
let distractorWordsA = [], distractorWordsB = [];
let foundCount = 0, wrongCount = 0;
let timer = 0;
let timerInterval;
let draggingWord = null;
let lastSpoken = '';
let voice = null;

function speakText(text) {
    const utter = new SpeechSynthesisUtterance(text.replace(/,/g, ' '));
    utter.voice = voice;
    window.speechSynthesis.speak(utter);
}

function loadVoice() {
    return new Promise(resolve => {
        const synth = window.speechSynthesis;
        function setVoice() {
            const voices = synth.getVoices();
            voice = voices.find(v => v.lang === 'en-US') || voices[0];
            const preload = new SpeechSynthesisUtterance('Hello');
            preload.voice = voice;
            synth.speak(preload);
            resolve();
        }
        synth.onvoiceschanged = setVoice;
        const voices = synth.getVoices();
        if (voices.length > 0) setVoice();
    });
}

function pickRandomPairs() {
    selectedPairs = [];
    validWordsA = [];
    validWordsB = [];
    const entries = Object.entries(fullSpoonerisms).sort(() => 0.5 - Math.random());
    const usedSet = new Set();
    for (let [pair, result] of entries) {
        if (selectedPairs.length === 5) break;
        const [first, second] = pair.split(',');
        if (!usedSet.has(first) && !usedSet.has(second)) {
            selectedPairs.push([pair, result]);
            usedSet.add(first);
            usedSet.add(second);
            validWordsA.push(first);
            validWordsB.push(second);
        }
    }
}

function pickDistractors() {
    let pool = new Set();
    Object.keys(fullSpoonerisms).forEach(key => key.split(',').forEach(w => pool.add(w)));
    [...validWordsA, ...validWordsB].forEach(w => pool.delete(w));
    const arr = Array.from(pool).sort(() => 0.5 - Math.random());
    distractorWordsA = arr.slice(0, 5);
    distractorWordsB = arr.slice(5, 10);
}

function updateStatus() {
    document.getElementById('statusBar').textContent = `Time: ${timer}s | Found: ${foundCount}/5 | Mistakes: ${wrongCount}/5`;
}

function populateSelectedPanel() {
    const selDiv = document.getElementById('selectedPairs');
    selDiv.innerHTML = '<strong>Selected Pairs (Debug):</strong>';
    selectedPairs.forEach(([pair, result]) => {
        let p = document.createElement('div');
        p.className = 'pair';
        p.textContent = `${pair} → ${result}`;
        selDiv.appendChild(p);
    });
}

function createWordElement(word) {
    const div = document.createElement('div');
    div.textContent = word;
    div.className = 'word';
    div.draggable = true;

    div.addEventListener('dragstart', () => { draggingWord = word; });

    div.addEventListener('dragover', e => {
        e.preventDefault();
        div.classList.add('highlight');
        if (draggingWord && draggingWord !== word) {
            const candidate = `${draggingWord} ${word}`;
            if (candidate !== lastSpoken) {
                speakText(candidate);
                lastSpoken = candidate;
            }
        }
    });

    div.addEventListener('dragleave', () => {
        div.classList.remove('highlight');
        window.speechSynthesis.cancel();
        lastSpoken = ''; 
    });

    div.addEventListener('drop', e => {
        e.preventDefault();
        div.classList.remove('highlight');
        checkSpoonerism(draggingWord, word);
        draggingWord = null;
        lastSpoken = '';
    });

    return div;
}

function loadWords() {
    const listA = document.getElementById('listA');
    const listB = document.getElementById('listB');
    listA.innerHTML = '';
    listB.innerHTML = '';
    [...validWordsA, ...distractorWordsA].sort(() => 0.5 - Math.random()).forEach(w => listA.appendChild(createWordElement(w)));
    [...validWordsB, ...distractorWordsB].sort(() => 0.5 - Math.random()).forEach(w => listB.appendChild(createWordElement(w)));
}

function checkSpoonerism(w1, w2) {
    const candidate = `${w1},${w2}`;
    const rev = `${w2},${w1}`;
    const match = selectedPairs.find(([pair) => pair === candidate || pair === rev);
    if (match) {
        const div = document.getElementById('foundPairs');
        let el = document.createElement('div');
        el.className = 'pair';
        el.textContent = `${match[0]} → ${match[1]}`;
        div.appendChild(el);
        removeWord(w1);
        removeWord(w2);
        foundCount++;
        speakText(`${match[0]} ${match[1]}`);
    } else {
        wrongCount++;
        speakText('nope');
    }
    updateStatus();
}

function removeWord(w) {
    document.querySelectorAll('.word').forEach(d => { if (d.textContent === w) d.remove(); });
}

async function startGame() {
    foundCount = 0; wrongCount = 0; timer = 0;
    document.getElementById('foundPairs').innerHTML = '<strong>Found Spoonerisms:</strong>';
    pickRandomPairs();
    pickDistractors();
    populateSelectedPanel();
    loadWords();
    updateStatus();
    await loadVoice();
    const welcome = new SpeechSynthesisUtterance('Welcome to Contrepèterie');
    welcome.voice = voice;
    welcome.onend = () => {
        timerInterval = setInterval(() => { timer++; updateStatus(); }, 1000);
    };
    window.speechSynthesis.speak(welcome);
}

startGame();
</script>

</body>
</html>