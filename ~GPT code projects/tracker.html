<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Food & Exercise Tracker</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        h1, h2 {
            color: #333;
            margin-bottom: 20px;
        }
        .settings-section {
            background-color: #f9f9f9;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }
        .input-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .input-group {
            display: flex;
            flex-direction: column;
        }
        label {
            font-weight: bold;
            margin-bottom: 5px;
            color: #555;
        }
        input, select {
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        button {
            background-color: #4CAF50;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            margin-right: 10px;
        }
        button:hover {
            background-color: #45a049;
        }
        .danger {
            background-color: #f44336;
        }
        .danger:hover {
            background-color: #da190b;
        }
        .secondary {
            background-color: #2196F3;
        }
        .secondary:hover {
            background-color: #0b7dda;
        }
        .table-container {
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #ddd;
            margin-top: 20px;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            font-size: 14px;
        }
        thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        th, td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center;
        }
        th {
            background-color: #4CAF50;
            color: white;
            font-weight: bold;
        }
        tr:nth-child(even) {
            background-color: #f9f9f9;
        }
        .negative {
            color: green;  /* Negative deficit is good for weight loss */
        }
        .positive {
            color: red;    /* Positive means eating over target */
        }
        .chart-container {
            position: relative;
            height: 400px;
            margin-top: 30px;
        }
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        .stat-card {
            background-color: #f0f0f0;
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        .stat-value {
            font-size: 24px;
            font-weight: bold;
            color: #4CAF50;
        }
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        .date-range-selector {
            display: flex;
            gap: 15px;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        .chart-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        @media (max-width: 768px) {
            .chart-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Food & Exercise Tracker</h1>
        
        <div class="settings-section">
            <h3>Settings</h3>
            <div class="input-section">
                <div class="input-group">
                    <label for="dailyTarget">Daily kJ Target:</label>
                    <input type="number" id="dailyTarget" value="8700" onchange="updateSettings()">
                </div>
                <div class="input-group">
                    <label for="deficitTarget">Daily Deficit Target:</label>
                    <input type="number" id="deficitTarget" value="-1700" onchange="updateSettings()">
                </div>
                <div class="input-group">
                    <label for="kjPerKg">kJ per kg weight loss:</label>
                    <input type="number" id="kjPerKg" value="32000" onchange="updateSettings()">
                </div>
            </div>
        </div>
        
        <div class="stats" id="stats">
            <div class="stat-card">
                <div class="stat-value" id="avgDeficit">0</div>
                <div class="stat-label">Avg Daily Deficit (kJ)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="totalDeficit">0</div>
                <div class="stat-label">Total Deficit (kJ)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="currentWeight">0</div>
                <div class="stat-label">Current Weight (kg)</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="progressPercent">0%</div>
                <div class="stat-label">Progress to 1kg Loss</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="projectedLoss">0</div>
                <div class="stat-label">Projected kg Loss/Month</div>
            </div>
            <div class="stat-card">
                <div class="stat-value" id="avgProteinRatio">0</div>
                <div class="stat-label">Avg Protein g/kJ</div>
            </div>
        </div>

        <div class="input-section">
            <div class="input-group">
                <label for="date">Date:</label>
                <input type="date" id="date" value="" onchange="checkExistingEntry()">
            </div>
            <div class="input-group">
                <label for="foodKj">Food (kJ):</label>
                <input type="number" id="foodKj" placeholder="0">
            </div>
            <div class="input-group">
                <label for="exerciseKj">Exercise (kJ):</label>
                <input type="number" id="exerciseKj" placeholder="0">
            </div>
            <div class="input-group">
                <label for="weight">Weight (kg):</label>
                <input type="number" id="weight" step="0.1" placeholder="0.0">
            </div>
            <div class="input-group">
                <label for="protein">Protein (g):</label>
                <input type="number" id="protein" placeholder="0">
            </div>
        </div>
        
        <button onclick="addEntry()">Add Entry</button>
        <button onclick="exportCSV()">Export CSV</button>
        <button onclick="importCSV()">Import CSV</button>
        <button class="danger" onclick="clearAllData()">Clear All Data</button>
        <input type="file" id="importFile" style="display: none;" accept=".csv" onchange="handleImport(event)">
        
        <div class="table-container">
            <table id="dataTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Food (kJ)</th>
                        <th>Exercise (kJ)</th>
                        <th>Net (kJ)</th>
                        <th>Deficit</th>
                        <th>1 Week Avg</th>
                        <th>Cumulative (kJ)</th>
                        <th>% of 1kg</th>
                        <th>Weight (kg)</th>
                        <th>Protein (g)</th>
                        <th>g/kJ</th>
                        <th>Target kJ</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                </tbody>
            </table>
        </div>
    </div>

    <div class="container">
        <h2>Progress Charts</h2>
        
        <div class="date-range-selector">
            <label>Date Range:</label>
            <select id="dateRange" onchange="updateDateRange()">
                <option value="all">All Data</option>
                <option value="7">Last 7 Days</option>
                <option value="14">Last 14 Days</option>
                <option value="30">Last 30 Days</option>
                <option value="90">Last 90 Days</option>
                <option value="custom">Custom Range</option>
            </select>
            <div id="customDateRange" style="display: none;">
                <input type="date" id="startDate" onchange="updateCharts()">
                <span>to</span>
                <input type="date" id="endDate" onchange="updateCharts()">
            </div>
        </div>
        
        <div class="chart-grid">
            <div class="chart-container">
                <canvas id="deficitChart"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="weightChart"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="proteinChart"></canvas>
            </div>
            <div class="chart-container">
                <canvas id="proteinRatioChart"></canvas>
            </div>
        </div>
        
        <div class="chart-container" style="margin-top: 20px;">
            <canvas id="projectionChart"></canvas>
        </div>
    </div>

    <script>
        // Settings
        let settings = {
            dailyTarget: 8700,
            deficitTarget: -1700,
            kjPerKg: 32000
        };

        // Data storage
        let entries = [];

        // Charts
        let deficitChart, weightChart, proteinChart, proteinRatioChart, projectionChart;

        // Initialize
        document.addEventListener('DOMContentLoaded', function() {
            // Set today's date as default
            document.getElementById('date').value = new Date().toISOString().split('T')[0];
            
            // Load settings and data
            loadSettings();
            loadData();
            
            // Initialize charts
            initCharts();
            
            // Update display
            updateTable();
            updateStats();
            updateCharts();
        });

        function loadSettings() {
            const saved = localStorage.getItem('foodTrackerSettings');
            if (saved) {
                settings = JSON.parse(saved);
                document.getElementById('dailyTarget').value = settings.dailyTarget;
                document.getElementById('deficitTarget').value = settings.deficitTarget;
                document.getElementById('kjPerKg').value = settings.kjPerKg;
            }
        }

        function saveSettings() {
            localStorage.setItem('foodTrackerSettings', JSON.stringify(settings));
        }

        function updateSettings() {
            settings.dailyTarget = parseInt(document.getElementById('dailyTarget').value) || 8700;
            settings.deficitTarget = parseInt(document.getElementById('deficitTarget').value) || -1700;
            settings.kjPerKg = parseInt(document.getElementById('kjPerKg').value) || 32000;
            saveSettings();
            updateTable();
            updateStats();
            updateCharts();
        }

        function loadData() {
            const saved = localStorage.getItem('foodTrackerData');
            if (saved) {
                entries = JSON.parse(saved);
            }
        }

        function saveData() {
            localStorage.setItem('foodTrackerData', JSON.stringify(entries));
        }

        function addEntry() {
            const date = document.getElementById('date').value;
            const foodKj = parseInt(document.getElementById('foodKj').value) || 0;
            const exerciseKj = parseInt(document.getElementById('exerciseKj').value) || 0;
            const weight = parseFloat(document.getElementById('weight').value) || 0;
            const protein = parseInt(document.getElementById('protein').value) || 0;

            if (!date) {
                alert('Please select a date');
                return;
            }

            // Check if entry for this date already exists
            const existingIndex = entries.findIndex(e => e.date === date);
            
            const entry = {
                date,
                foodKj,
                exerciseKj,
                weight,
                protein,
                targetKj: settings.dailyTarget // Store the target used for this entry
            };

            if (existingIndex >= 0) {
                entries[existingIndex] = entry;
            } else {
                entries.push(entry);
            }

            // Sort entries by date
            entries.sort((a, b) => new Date(a.date) - new Date(b.date));

            saveData();
            updateTable();
            updateStats();
            updateCharts();

            // Clear inputs except date
            document.getElementById('foodKj').value = '';
            document.getElementById('exerciseKj').value = '';
            document.getElementById('weight').value = '';
            document.getElementById('protein').value = '';
        }

        function deleteEntry(index) {
            if (confirm('Are you sure you want to delete this entry?')) {
                entries.splice(index, 1);
                saveData();
                updateTable();
                updateStats();
                updateCharts();
            }
        }

        function updateTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            let cumulativeDeficit = 0;

            entries.forEach((entry, index) => {
                const netKj = entry.foodKj - entry.exerciseKj;
                const targetForEntry = entry.targetKj || settings.dailyTarget;
                const deficit = netKj - targetForEntry;
                cumulativeDeficit += deficit;

                // Calculate 1 week average
                let weekAvg = 0;
                if (index >= 6) {
                    let sum = 0;
                    for (let i = index - 6; i <= index; i++) {
                        const net = entries[i].foodKj - entries[i].exerciseKj;
                        const target = entries[i].targetKj || settings.dailyTarget;
                        sum += (net - target);
                    }
                    weekAvg = Math.round(sum / 7);
                }

                // Calculate % of 1kg
                const percentOf1kg = ((cumulativeDeficit / settings.kjPerKg) * 100).toFixed(1);

                // Calculate protein per kJ
                const proteinPerKj = entry.foodKj > 0 ? (entry.protein / entry.foodKj).toFixed(4) : 0;

                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${formatDate(entry.date)}</td>
                    <td>${entry.foodKj}</td>
                    <td>${entry.exerciseKj}</td>
                    <td>${netKj}</td>
                    <td class="${deficit < 0 ? 'negative' : 'positive'}">${deficit}</td>
                    <td>${index >= 6 ? weekAvg : ''}</td>
                    <td>${cumulativeDeficit}</td>
                    <td>${percentOf1kg}%</td>
                    <td>${entry.weight || ''}</td>
                    <td>${entry.protein}</td>
                    <td>${proteinPerKj}</td>
                    <td>${targetForEntry}</td>
                    <td><button onclick="deleteEntry(${index})" style="background-color: #f44336; padding: 5px 10px;">Delete</button></td>
                `;
            });
        }

        function updateStats() {
            if (entries.length === 0) {
                document.getElementById('avgDeficit').textContent = '0';
                document.getElementById('totalDeficit').textContent = '0';
                document.getElementById('currentWeight').textContent = '0';
                document.getElementById('progressPercent').textContent = '0%';
                document.getElementById('projectedLoss').textContent = '0';
                document.getElementById('avgProteinRatio').textContent = '0';
                return;
            }

            // Calculate average daily deficit (excluding placeholder entries)
            let totalDeficit = 0;
            let totalProteinRatio = 0;
            let proteinRatioCount = 0;
            let deficitCount = 0;
            
            entries.forEach(entry => {
                if (entry.foodKj > 0) {  // Only count non-placeholder entries
                    const net = entry.foodKj - entry.exerciseKj;
                    const target = entry.targetKj || settings.dailyTarget;
                    totalDeficit += (net - target);
                    deficitCount++;
                    
                    totalProteinRatio += (entry.protein / entry.foodKj);
                    proteinRatioCount++;
                }
            });
            
            const avgDeficit = deficitCount > 0 ? Math.round(totalDeficit / deficitCount) : 0;
            const avgProteinRatio = proteinRatioCount > 0 ? (totalProteinRatio / proteinRatioCount).toFixed(4) : 0;

            // Get current weight (last entry with weight)
            let currentWeight = 0;
            for (let i = entries.length - 1; i >= 0; i--) {
                if (entries[i].weight > 0) {
                    currentWeight = entries[i].weight;
                    break;
                }
            }

            // Calculate progress percentage
            const progressPercent = ((totalDeficit / settings.kjPerKg) * 100).toFixed(1);

            // Calculate projected monthly weight loss
            const projectedMonthlyLoss = (avgDeficit * 30 / settings.kjPerKg).toFixed(2);

            // Update display
            document.getElementById('avgDeficit').textContent = avgDeficit;
            document.getElementById('totalDeficit').textContent = totalDeficit;
            document.getElementById('currentWeight').textContent = currentWeight.toFixed(1);
            document.getElementById('progressPercent').textContent = progressPercent + '%';
            document.getElementById('projectedLoss').textContent = projectedMonthlyLoss;
            document.getElementById('avgProteinRatio').textContent = avgProteinRatio;
        }

        function initCharts() {
            // Deficit Chart
            const deficitCtx = document.getElementById('deficitChart').getContext('2d');
            deficitChart = new Chart(deficitCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Daily Deficit',
                            data: [],
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            tension: 0.1,
                            fill: {
                                target: 'origin',
                                above: 'rgba(255, 99, 132, 0.1)',   // Red fill above zero (surplus/bad)
                                below: 'rgba(75, 192, 192, 0.1)'    // Green fill below zero (deficit/good)
                            }
                        },
                        {
                            label: '7-Day Average',
                            data: [],
                            borderColor: 'rgb(54, 162, 235)',
                            backgroundColor: 'rgba(54, 162, 235, 0.1)',
                            tension: 0.1
                        },
                        {
                            label: 'Target Deficit',
                            data: [],
                            borderColor: 'rgb(75, 192, 192)',
                            borderDash: [5, 5],
                            fill: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Daily Deficit Tracking'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: {
                                drawBorder: false,
                                color: function(context) {
                                    if (context.tick.value === 0) {
                                        return '#000';  // Bold line at y=0
                                    }
                                    return 'rgba(0, 0, 0, 0.1)';
                                }
                            },
                            ticks: {
                                callback: function(value) {
                                    return value + ' kJ';
                                }
                            }
                        }
                    }
                }
            });

            // Weight Chart
            const weightCtx = document.getElementById('weightChart').getContext('2d');
            weightChart = new Chart(weightCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Weight (kg)',
                        data: [],
                        borderColor: 'rgb(75, 192, 192)',
                        backgroundColor: 'rgba(75, 192, 192, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Weight Progress'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });

            // Protein Chart
            const proteinCtx = document.getElementById('proteinChart').getContext('2d');
            proteinChart = new Chart(proteinCtx, {
                type: 'bar',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Protein (g)',
                        data: [],
                        backgroundColor: 'rgba(153, 102, 255, 0.6)',
                        borderColor: 'rgb(153, 102, 255)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Daily Protein Intake'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Protein Ratio Chart
            const proteinRatioCtx = document.getElementById('proteinRatioChart').getContext('2d');
            proteinRatioChart = new Chart(proteinRatioCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Protein g/kJ',
                        data: [],
                        borderColor: 'rgb(255, 159, 64)',
                        backgroundColor: 'rgba(255, 159, 64, 0.1)',
                        tension: 0.1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Protein Efficiency (g/kJ)'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true
                        }
                    }
                }
            });

            // Projection Chart
            const projectionCtx = document.getElementById('projectionChart').getContext('2d');
            projectionChart = new Chart(projectionCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        {
                            label: 'Actual Weight',
                            data: [],
                            borderColor: 'rgb(75, 192, 192)',
                            backgroundColor: 'rgba(75, 192, 192, 0.1)',
                            tension: 0.1
                        },
                        {
                            label: 'Projected Weight',
                            data: [],
                            borderColor: 'rgb(255, 99, 132)',
                            backgroundColor: 'rgba(255, 99, 132, 0.1)',
                            borderDash: [5, 5],
                            tension: 0.1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        title: {
                            display: true,
                            text: 'Weight Loss Projection'
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: false
                        }
                    }
                }
            });
        }

        function updateDateRange() {
            const rangeSelect = document.getElementById('dateRange');
            const customRange = document.getElementById('customDateRange');
            
            if (rangeSelect.value === 'custom') {
                customRange.style.display = 'flex';
                customRange.style.gap = '10px';
                customRange.style.alignItems = 'center';
            } else {
                customRange.style.display = 'none';
                updateCharts();
            }
        }

        function getFilteredEntries() {
            const rangeSelect = document.getElementById('dateRange').value;
            let filteredEntries = [...entries];
            
            if (rangeSelect === 'custom') {
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                if (startDate && endDate) {
                    filteredEntries = entries.filter(e => e.date >= startDate && e.date <= endDate);
                }
            } else if (rangeSelect !== 'all') {
                const days = parseInt(rangeSelect);
                const cutoffDate = new Date();
                cutoffDate.setDate(cutoffDate.getDate() - days);
                const cutoffStr = cutoffDate.toISOString().split('T')[0];
                filteredEntries = entries.filter(e => e.date >= cutoffStr);
            }
            
            return filteredEntries;
        }

        function updateCharts() {
            const filteredEntries = getFilteredEntries();
            // Filter out entries with 0 foodKj (placeholder entries)
            const chartEntries = filteredEntries.filter(e => e.foodKj > 0);
            
            const labels = chartEntries.map(e => formatDate(e.date));
            const deficits = [];
            const weekAvgs = [];
            const targets = [];
            const weights = [];
            const proteins = chartEntries.map(e => e.protein);
            const proteinRatios = [];

            chartEntries.forEach((entry, index) => {
                const net = entry.foodKj - entry.exerciseKj;
                const target = entry.targetKj || settings.dailyTarget;
                const deficit = net - target;  // This will be negative when in deficit
                deficits.push(deficit);
                targets.push(settings.deficitTarget);  // This is already negative (-1700)

                // Calculate 7-day average (using original filtered entries for consistency)
                const origIndex = filteredEntries.indexOf(entry);
                if (origIndex >= 6) {
                    let sum = 0;
                    let count = 0;
                    for (let i = origIndex - 6; i <= origIndex; i++) {
                        if (filteredEntries[i].foodKj > 0) {
                            const net = filteredEntries[i].foodKj - filteredEntries[i].exerciseKj;
                            const target = filteredEntries[i].targetKj || settings.dailyTarget;
                            sum += (net - target);
                            count++;
                        }
                    }
                    weekAvgs.push(count > 0 ? Math.round(sum / count) : null);
                } else {
                    weekAvgs.push(null);
                }

                // Add weight if available AND if there's food data
                if (entry.foodKj > 0 && entry.weight) {
                    weights.push(entry.weight);
                } else {
                    weights.push(null);
                }
                
                // Calculate protein ratio
                const ratio = entry.foodKj > 0 ? entry.protein / entry.foodKj : null;
                proteinRatios.push(ratio);
            });

            // Update deficit chart
            deficitChart.data.labels = labels;
            deficitChart.data.datasets[0].data = deficits;
            deficitChart.data.datasets[1].data = weekAvgs;
            deficitChart.data.datasets[2].data = targets;
            deficitChart.update();

            // Update weight chart
            weightChart.data.labels = labels;
            weightChart.data.datasets[0].data = weights;
            weightChart.update();

            // Update protein chart
            proteinChart.data.labels = labels;
            proteinChart.data.datasets[0].data = proteins;
            proteinChart.update();

            // Update protein ratio chart
            proteinRatioChart.data.labels = labels;
            proteinRatioChart.data.datasets[0].data = proteinRatios;
            proteinRatioChart.update();

            // Update projection chart
            updateProjectionChart(filteredEntries);
        }

        function updateProjectionChart(filteredEntries) {
            if (filteredEntries.length === 0) return;

            // Get starting weight
            let startWeight = 0;
            for (let entry of filteredEntries) {
                if (entry.weight > 0) {
                    startWeight = entry.weight;
                    break;
                }
            }

            if (startWeight === 0) return;

            // Calculate average daily deficit
            let totalDeficit = 0;
            let deficitDays = 0;
            filteredEntries.forEach(entry => {
                if (entry.foodKj > 0) {  // Only count non-placeholder entries
                    const net = entry.foodKj - entry.exerciseKj;
                    const target = entry.targetKj || settings.dailyTarget;
                    totalDeficit += (net - target);
                    deficitDays++;
                }
            });
            const avgDailyDeficit = deficitDays > 0 ? totalDeficit / deficitDays : 0;

            // Create projection data
            const labels = [];
            const actualWeights = [];
            const projectedWeights = [];

            // Add actual data
            filteredEntries.forEach((entry, index) => {
                labels.push(formatDate(entry.date));
                
                // Only add weight if there's food data
                if (entry.foodKj > 0 && entry.weight) {
                    actualWeights.push(entry.weight);
                } else {
                    actualWeights.push(null);
                }
                
                // Calculate projected weight based on cumulative deficit
                let cumulativeDeficit = 0;
                for (let i = 0; i <= index; i++) {
                    if (filteredEntries[i].foodKj > 0) {  // Only count entries with food data
                        const net = filteredEntries[i].foodKj - filteredEntries[i].exerciseKj;
                        const target = filteredEntries[i].targetKj || settings.dailyTarget;
                        cumulativeDeficit += (net - target);
                    }
                }
                const projectedLoss = cumulativeDeficit / settings.kjPerKg;
                projectedWeights.push(startWeight - projectedLoss);
            });

            // Add future projection (30 days)
            const lastDate = new Date(filteredEntries[filteredEntries.length - 1].date);
            let cumulativeDeficit = totalDeficit;
            
            for (let i = 1; i <= 30; i++) {
                const futureDate = new Date(lastDate);
                futureDate.setDate(futureDate.getDate() + i);
                labels.push(formatDate(futureDate.toISOString().split('T')[0]));
                actualWeights.push(null);
                
                cumulativeDeficit += avgDailyDeficit;
                const projectedLoss = cumulativeDeficit / settings.kjPerKg;
                projectedWeights.push(startWeight - projectedLoss);  // Subtract loss, not add
            }

            // Update chart
            projectionChart.data.labels = labels;
            projectionChart.data.datasets[0].data = actualWeights;
            projectionChart.data.datasets[1].data = projectedWeights;
            projectionChart.update();
        }

        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const days = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun', 'Jul', 'Aug', 'Sep', 'Oct', 'Nov', 'Dec'];
            return `${days[date.getDay()]}, ${months[date.getMonth()]} ${date.getDate()}, ${date.getFullYear()}`;
        }

        function exportCSV() {
            if (entries.length === 0) {
                alert('No data to export');
                return;
            }

            const csvData = entries.map(entry => ({
                Date: entry.date,
                'Food (kJ)': entry.foodKj,
                'Exercise (kJ)': entry.exerciseKj,
                'Weight (kg)': entry.weight || '',
                'Protein (g)': entry.protein,
                'Target (kJ)': entry.targetKj || settings.dailyTarget
            }));

            const csv = Papa.unparse(csvData);
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            const url = URL.createObjectURL(blob);
            
            link.setAttribute('href', url);
            link.setAttribute('download', `food-tracker-${new Date().toISOString().split('T')[0]}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function importCSV() {
            document.getElementById('importFile').click();
        }

        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;

            Papa.parse(file, {
                header: true,
                dynamicTyping: false, // Changed to false to keep dates as strings
                complete: function(results) {
                    try {
                        const imported = results.data.filter(row => row.Date).map(row => {
                            // Parse the date string and ensure it's in YYYY-MM-DD format
                            let dateStr = row.Date;
                            
                            // Handle DD/MM/YYYY format (like 28/06/2025)
                            if (dateStr.includes('/')) {
                                const parts = dateStr.split('/');
                                if (parts.length === 3) {
                                    // Check if year is 4 digits
                                    let day, month, year;
                                    if (parts[2].length === 4) {
                                        // DD/MM/YYYY format
                                        day = parts[0].padStart(2, '0');
                                        month = parts[1].padStart(2, '0');
                                        year = parts[2];
                                    } else if (parts[0].length === 4) {
                                        // YYYY/MM/DD format
                                        year = parts[0];
                                        month = parts[1].padStart(2, '0');
                                        day = parts[2].padStart(2, '0');
                                    } else {
                                        // Try to parse as US format MM/DD/YYYY
                                        if (parseInt(parts[1]) > 12) {
                                            // Must be DD/MM/YYYY
                                            day = parts[0].padStart(2, '0');
                                            month = parts[1].padStart(2, '0');
                                            year = '20' + parts[2];
                                        } else {
                                            // MM/DD/YYYY
                                            month = parts[0].padStart(2, '0');
                                            day = parts[1].padStart(2, '0');
                                            year = parts[2].length === 2 ? '20' + parts[2] : parts[2];
                                        }
                                    }
                                    dateStr = `${year}-${month}-${day}`;
                                }
                            } else if (!dateStr.match(/^\d{4}-\d{2}-\d{2}$/)) {
                                // Try to parse other date formats
                                const parsedDate = new Date(dateStr);
                                if (!isNaN(parsedDate)) {
                                    dateStr = parsedDate.toISOString().split('T')[0];
                                }
                            }
                            
                            return {
                                date: dateStr,
                                foodKj: parseInt(row['Food (kJ)']) || 0,
                                exerciseKj: parseInt(row['Exercise (kJ)']) || 0,
                                weight: parseFloat(row['Weight (kg)']) || 0,
                                protein: parseInt(row['Protein (g)']) || 0,
                                targetKj: parseInt(row['Target (kJ)']) || settings.dailyTarget
                            };
                        });

                        if (imported.length > 0) {
                            entries = imported;
                            entries.sort((a, b) => new Date(a.date) - new Date(b.date));
                            saveData();
                            updateTable();
                            updateStats();
                            updateCharts();
                            alert(`Successfully imported ${imported.length} entries!`);
                        } else {
                            alert('No valid data found in CSV file');
                        }
                    } catch (error) {
                        alert('Error importing CSV: ' + error.message);
                    }
                },
                error: function(error) {
                    alert('Error parsing CSV: ' + error.message);
                }
            });
        }

        function checkExistingEntry() {
            const selectedDate = document.getElementById('date').value;
            const existingEntry = entries.find(e => e.date === selectedDate);
            
            if (existingEntry) {
                // Populate fields with existing data
                document.getElementById('foodKj').value = existingEntry.foodKj || '';
                document.getElementById('exerciseKj').value = existingEntry.exerciseKj || '';
                document.getElementById('weight').value = existingEntry.weight || '';
                document.getElementById('protein').value = existingEntry.protein || '';
            } else {
                // Clear fields for new entry
                document.getElementById('foodKj').value = '';
                document.getElementById('exerciseKj').value = '';
                document.getElementById('weight').value = '';
                document.getElementById('protein').value = '';
            }
        }
    </script>
</body>
</html>