<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crumple Zone Tournament Manager</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            font-size: 22px;
            margin: 0;
            padding: 0;
            background-color: #f5f5f5;
        }
        .container {
            padding: 20px;
            min-height: 100vh;
        }
        .hidden {
            display: none;
        }
        .panel {
            background: white;
            border-radius: 10px;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        button {
            font-size: 20px;
            padding: 10px 20px;
            margin: 5px;
            border: none;
            border-radius: 5px;
            background: #4CAF50;
            color: white;
            cursor: pointer;
        }
        button:hover {
            background: #45a049;
        }
        button.danger {
            background: #f44336;
        }
        button.danger:hover {
            background: #da190b;
        }
        button.secondary {
            background: #008CBA;
        }
        button.secondary:hover {
            background: #007399;
        }
        .menu-button {
            display: block;
            width: 300px;
            margin: 20px auto;
            padding: 20px;
            font-size: 24px;
        }
        input[type="text"], textarea {
            font-size: 20px;
            padding: 8px;
            margin: 5px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .class-item, .student-item {
            background: #f0f0f0;
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .group-management-layout {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 20px;
            height: calc(100vh - 220px);
            margin-top: 10px;
        }
        .class-sidebar {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 15px;
            overflow-y: auto;
        }
        .class-selector-item {
            padding: 10px;
            margin: 5px 0;
            border-radius: 5px;
            cursor: pointer;
            background: white;
            border: 2px solid transparent;
        }
        .class-selector-item:hover {
            background: #e3f2fd;
        }
        .class-selector-item.active {
            border-color: #2196F3;
            background: #e3f2fd;
        }
        .group-area {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }
        .group-container {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            grid-template-rows: repeat(2, auto);
            gap: 10px;
            flex-grow: 1;
            align-content: start;
        }
        .group-box {
            background: #e8f4f8;
            border: 2px dashed #2196F3;
            border-radius: 8px;
            padding: 10px;
            min-height: auto;
            height: fit-content;
            overflow-y: auto;
            font-family: 'Arial Narrow', Arial, sans-serif;
        }
        .group-box.drag-over {
            background: #bbdefb;
            border-color: #1976D2;
        }
        .group-header {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 5px;
        }
        .group-emoji {
            font-size: 24px;
            cursor: pointer;
            padding: 2px;
            border: 2px solid transparent;
            flex-shrink: 0;
        }
        .group-emoji:hover {
            border-color: #2196F3;
            border-radius: 5px;
        }
        .group-name {
            font-size: 16px;
            flex-grow: 1;
            border: none;
            background: transparent;
            font-weight: bold;
            width: calc(100% - 50px);
            font-family: 'Arial Narrow', Arial, sans-serif;
        }
        .group-students {
            min-height: 30px;
        }
        .student-pill {
            background: white;
            padding: 3px 8px;
            margin: 2px 0;
            border-radius: 12px;
            cursor: move;
            font-size: 14px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .group-box .student-pill,
        .unassigned-pool .student-pill {
            font-family: 'Arial Narrow', Arial, sans-serif;
        }
        .student-pill.dragging {
            opacity: 0.5;
        }
        .unassigned-pool {
            background: #fff3cd;
            border: 2px dashed #ffc107;
            border-radius: 8px;
            padding: 10px;
            min-height: 150px;
            max-height: 250px;
            overflow-y: auto;
            font-family: 'Arial Narrow', Arial, sans-serif;
        }
        .emoji-picker {
            position: fixed;
            background: white;
            border: 2px solid #2196F3;
            border-radius: 8px;
            padding: 10px;
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 5px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
            z-index: 1000;
            max-width: 320px;
        }
        .emoji-option {
            font-size: 24px;
            padding: 5px;
            cursor: pointer;
            text-align: center;
            border-radius: 5px;
        }
        .emoji-option:hover {
            background: #e3f2fd;
        }
        .match {
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .match h3 {
            margin: 10px 0;
        }
        .radio-label {
            margin-right: 15px;
        }
        .running-total {
            background: #e8f5e9;
            padding: 15px;
            border-radius: 8px;
            position: sticky;
            top: 20px;
        }
        .wrapper {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 20px;
        }
        .navigation {
            margin: 20px 0;
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }
        .navigation h2 {
            margin: 0;
            font-size: 28px;
        }
        .navigation-vertical {
            display: block;
        }
        .pulsing-bg {
            animation: pulse 4s infinite;
        }
        @keyframes pulse {
            0% { background-color: #ffffff; }
            50% { background-color: var(--pastel-color); }
            100% { background-color: #ffffff; }
        }
        h1, h2 {
            margin-top: 10px;
            text-align: center;
        }
        .navigation h2 {
            margin: 0;
            font-size: 28px;
        }
        .centered {
            text-align: center;
        }
    </style>
</head>
<body>

<!-- Landing Page -->
<div id="landing" class="container pulsing-bg" style="--pastel-color: #e8f5e9;">
    <h1>Crumple Zone Tournament Manager</h1>
    <div class="centered">
        <button class="menu-button" onclick="showClassAdmin()">Class Administration</button>
        <button class="menu-button" onclick="showGroupManagement()">Group Management</button>
        <button class="menu-button" onclick="showClassSelection()">Start Tournament</button>
    </div>
</div>

<!-- Class Administration -->
<div id="classAdmin" class="container hidden">
    <h2>Class Administration</h2>
    <div class="navigation navigation-vertical">
        <button onclick="showLanding()">Back to Menu</button>
    </div>
    <div class="panel">
        <h3>Create New Class</h3>
        <input type="text" id="newClassName" placeholder="Enter class name" style="width: 300px;">
        <button onclick="createClass()">Create Class</button>
    </div>
    <div class="panel">
        <h3>Existing Classes</h3>
        <div id="classList"></div>
    </div>
    <div class="panel">
        <h3>Edit Students</h3>
        <div id="selectedClass" style="display: none;">
            <h4 id="editingClassName"></h4>
            <textarea id="studentList" rows="10" cols="40" placeholder="Paste student names (one per line)"></textarea>
            <br>
            <button onclick="saveStudents()">Save Students</button>
            <button onclick="cancelEdit()" class="secondary">Cancel</button>
        </div>
        <p id="noClassSelected">Select a class to edit students</p>
    </div>
</div>

<!-- Group Management -->
<div id="groupManagement" class="container hidden">
    <h2>Group Management</h2>
    <div class="navigation navigation-vertical">
        <button onclick="showLanding()">Back to Menu</button>
        <button onclick="dissolveMembers()" class="danger">Dissolve Group Members</button>
        <button onclick="dissolveGroupsAndNames()" class="danger">Dissolve Groups and Names</button>
    </div>
    <div class="panel group-management-layout">
        <div class="class-sidebar">
            <h3>Classes</h3>
            <div id="classListSidebar"></div>
        </div>
        <div class="group-area">
            <div class="unassigned-pool" id="unassignedPool" ondrop="drop(event, 'unassigned')" ondragover="allowDrop(event)" ondragleave="dragLeave(event)" style="display: none;">
                <strong style="font-family: 'Arial Narrow', Arial, sans-serif;">Unassigned Students</strong>
                <div id="unassignedStudents"></div>
            </div>
            <div class="group-container" id="groupContainer"></div>
        </div>
    </div>
    <div id="emojiPicker" class="emoji-picker hidden"></div>
</div>

<!-- Class Selection for Tournament -->
<div id="classSelection" class="container hidden">
    <h2>Select Class for Tournament</h2>
    <div class="navigation navigation-vertical">
        <button onclick="showLanding()">Back to Menu</button>
    </div>
    <div class="panel centered">
        <h3>Choose a Class</h3>
        <div id="classListForTournament"></div>
    </div>
</div>

<!-- Tournament Rounds -->
<div id="collision" class="hidden container pulsing-bg">
    <div class="navigation">
        <button onclick="prevCollision()">Previous</button>
        <h2 id="collisionTitle"></h2>
        <button onclick="nextCollision()">Next</button>
    </div>
    <div class="wrapper">
        <div id="matches"></div>
        <div class="panel running-total" id="runningTotal"></div>
    </div>
</div>

<!-- Final Results -->
<div id="results" class="hidden container centered pulsing-bg" style="--pastel-color: #fffacd;">
    <div class="navigation" style="justify-content: center;">
        <button onclick="goBackToLastCollision()">Back</button>
        <button onclick="showLanding()">Back to Menu</button>
        <button onclick="confirmRestart()">Restart Tournament</button>
    </div>
    <h2 style="font-size: 36px;">Final Results</h2>
    <div id="finalScores" style="font-size: 28px;"></div>
</div>

<script>
// Data structures
let classes = {};
let currentClass = null;
let currentEditingClass = null;
let selectedEmoji = null;
let groups = [];
let points = [0, 0, 0, 0, 0, 0];
let resultsByCollision = [];
let currentCollision = 0;
let matchups = [];

// Available emojis
const emojis = [
    'ðŸ˜€', 'ðŸ˜Ž', 'ðŸ¤–', 'ðŸ‘»', 'ðŸ¦„', 'ðŸ‰', 'ðŸ¦', 'ðŸ¯',
    'ðŸ¸', 'ðŸ¦Š', 'ðŸ¼', 'ðŸ¨', 'ðŸµ', 'ðŸ¦…', 'ðŸ¦‰', 'ðŸ¦‹',
    'ðŸ¢', 'ðŸ¦•', 'ðŸ¦ˆ', 'ðŸ™', 'ðŸ¦€', 'ðŸŒŸ', 'ðŸŒˆ', 'ðŸŒº',
    'ðŸ•', 'ðŸ”', 'ðŸŒ®', 'ðŸ°', 'ðŸŽ¨', 'ðŸŽ­', 'ðŸŽª', 'ðŸŽ¯',
    'ðŸš€', 'ðŸ›¸', 'âš¡', 'ðŸ”¥', 'ðŸ’Ž', 'ðŸ†', 'ðŸŽµ', 'ðŸŽ¸',
    'ðŸŒ', 'ðŸŒ™', 'â˜€ï¸', 'â›ˆï¸', 'ðŸŒŠ', 'ðŸ”ï¸', 'ðŸŒ´', 'ðŸŒ¸',
    'ðŸ¦¸', 'ðŸ§™', 'ðŸ§š', 'ðŸ§›', 'ðŸ§Ÿ', 'ðŸ‘½', 'ðŸ¤º', 'ðŸ¥·',
    'ðŸŽƒ', 'ðŸŽ„', 'ðŸŽˆ', 'ðŸŽ', 'ðŸ”®', 'ðŸŽ²', 'ðŸ§©', 'ðŸŽ®'
];

// Test if localStorage is available
function isLocalStorageAvailable() {
    try {
        const test = '__storage_test__';
        localStorage.setItem(test, test);
        localStorage.removeItem(test);
        return true;
    } catch(e) {
        return false;
    }
}

// Initialize - load from localStorage if available
window.onload = function() {
    loadClasses();
    initializeGroups();
    createEmojiPicker();
    currentClass = null;
};

// Navigation functions
function showLanding() {
    hideAllPanels();
    document.getElementById('landing').classList.remove('hidden');
}

function showClassAdmin() {
    hideAllPanels();
    document.getElementById('classAdmin').classList.remove('hidden');
    displayClasses();
}

function showGroupManagement() {
    hideAllPanels();
    document.getElementById('groupManagement').classList.remove('hidden');
    populateClassSelector();
}

function showClassSelection() {
    hideAllPanels();
    document.getElementById('classSelection').classList.remove('hidden');
    displayClassesForTournament();
}

function hideAllPanels() {
    document.getElementById('landing').classList.add('hidden');
    document.getElementById('classAdmin').classList.add('hidden');
    document.getElementById('groupManagement').classList.add('hidden');
    document.getElementById('classSelection').classList.add('hidden');
    document.getElementById('collision').classList.add('hidden');
    document.getElementById('results').classList.add('hidden');
}

// Class Administration functions
function loadClasses() {
    const stored = localStorage.getItem('crumpleClasses');
    if (stored) {
        try {
            classes = JSON.parse(stored);
        } catch (e) {
            console.error('Error loading classes:', e);
            classes = {};
        }
    } else {
        classes = {};
    }
}

function saveClasses() {
    localStorage.setItem('crumpleClasses', JSON.stringify(classes));
}

function createClass() {
    const name = document.getElementById('newClassName').value.trim();
    if (name && !classes[name]) {
        classes[name] = {
            students: [],
            groups: initializeGroups()
        };
        saveClasses();
        document.getElementById('newClassName').value = '';
        displayClasses();
    } else if (classes[name]) {
        alert('A class with this name already exists.');
    }
}

function displayClasses() {
    const list = document.getElementById('classList');
    list.innerHTML = '';
    
    Object.keys(classes).forEach(className => {
        const div = document.createElement('div');
        div.className = 'class-item';
        div.innerHTML = `
            <span>${className} (${classes[className].students.length} students)</span>
            <div>
                <button onclick="editClass('${className}')">Edit</button>
                <button onclick="copyClass('${className}')" class="secondary">Copy</button>
                <button onclick="renameClass('${className}')" class="secondary">Rename</button>
                <button onclick="deleteClass('${className}')" class="danger">Delete</button>
            </div>
        `;
        list.appendChild(div);
    });
}

function editClass(className) {
    currentEditingClass = className;
    document.getElementById('selectedClass').style.display = 'block';
    document.getElementById('noClassSelected').style.display = 'none';
    document.getElementById('editingClassName').textContent = className;
    document.getElementById('studentList').value = classes[className].students.join('\n');
}

function saveStudents() {
    if (currentEditingClass) {
        const studentText = document.getElementById('studentList').value;
        const students = studentText.split('\n').filter(s => s.trim()).map(s => s.trim());
        classes[currentEditingClass].students = students;
        
        // Ensure groups exist for this class
        if (!classes[currentEditingClass].groups) {
            classes[currentEditingClass].groups = initializeGroups();
        }
        
        saveClasses();
        cancelEdit();
        displayClasses();
    }
}

function cancelEdit() {
    currentEditingClass = null;
    document.getElementById('selectedClass').style.display = 'none';
    document.getElementById('noClassSelected').style.display = 'block';
    document.getElementById('studentList').value = '';
}

function copyClass(className) {
    let newName = className + ' (Copy)';
    let counter = 1;
    while (classes[newName]) {
        newName = className + ' (Copy ' + counter + ')';
        counter++;
    }
    
    // Deep copy including customName property
    const originalClass = classes[className];
    classes[newName] = {
        students: [...originalClass.students],
        groups: originalClass.groups ? originalClass.groups.map(group => ({
            name: group.name,
            emoji: group.emoji,
            students: [...group.students],
            customName: group.customName || false
        })) : initializeGroups()
    };
    
    saveClasses();
    displayClasses();
}

function renameClass(className) {
    const newName = prompt('Enter new name for ' + className);
    if (newName && newName !== className && !classes[newName]) {
        classes[newName] = classes[className];
        delete classes[className];
        saveClasses();
        displayClasses();
    }
}

function deleteClass(className) {
    if (confirm('Delete class ' + className + '? This cannot be undone.')) {
        delete classes[className];
        saveClasses();
        displayClasses();
    }
}

// Group Management functions
function initializeGroups() {
    const defaultGroups = [];
    for (let i = 0; i < 6; i++) {
        defaultGroups.push({
            name: 'Group ' + (i + 1),
            emoji: emojis[i],
            students: [],
            customName: false
        });
    }
    return defaultGroups;
}

function generateGroupName(students) {
    if (students.length === 0) return '';
    return students.map(student => student.substring(0, 2)).join('');
}

function populateClassSelector() {
    const sidebar = document.getElementById('classListSidebar');
    sidebar.innerHTML = '';
    
    Object.keys(classes).forEach(className => {
        const div = document.createElement('div');
        div.className = 'class-selector-item';
        div.textContent = className + ' (' + classes[className].students.length + ' students)';
        div.onclick = () => selectClassForGroups(className);
        sidebar.appendChild(div);
    });
    
    if (sidebar.innerHTML === '') {
        sidebar.innerHTML = '<p style="text-align: center; color: #666;">No classes created yet</p>';
    }
}

function selectClassForGroups(className) {
    // Update active class visual state
    document.querySelectorAll('.class-selector-item').forEach(item => {
        item.classList.remove('active');
    });
    event.target.classList.add('active');
    
    // Load the class
    currentClass = className;
    groups = classes[className].groups || initializeGroups();
    
    // Ensure backward compatibility - add customName property if missing
    groups.forEach((group, index) => {
        if (group.customName === undefined) {
            // If the name is not the default, mark it as custom
            group.customName = group.name !== 'Group ' + (index + 1);
        }
    });
    
    if (!classes[className].groups) {
        classes[className].groups = groups;
        saveClasses();
    }
    
    // Show the unassigned pool and display groups
    document.getElementById('unassignedPool').style.display = 'block';
    displayGroups();
    displayUnassignedStudents();
}

function displayGroups() {
    const container = document.getElementById('groupContainer');
    container.innerHTML = '';
    
    groups.forEach((group, index) => {
        const groupDiv = document.createElement('div');
        groupDiv.className = 'group-box';
        groupDiv.setAttribute('ondrop', `drop(event, ${index})`);
        groupDiv.setAttribute('ondragover', 'allowDrop(event)');
        groupDiv.setAttribute('ondragleave', 'dragLeave(event)');
        
        const studentsList = group.students.map((student, sIndex) => 
            `<div class="student-pill" draggable="true" ondragstart="drag(event, ${index}, ${sIndex})" ondragend="dragEnd(event)">${student}</div>`
        ).join('');
        
        // Use generated name if not custom
        const displayName = group.customName ? group.name : (generateGroupName(group.students) || group.name);
        
        groupDiv.innerHTML = `
            <div class="group-header">
                <span class="group-emoji" onclick="showEmojiPicker(event, ${index})">${group.emoji}</span>
                <input type="text" class="group-name" value="${displayName}" onchange="updateGroupName(${index}, this.value)" onfocus="markGroupNameCustom(${index})">
            </div>
            <div class="group-students">${studentsList}</div>
        `;
        
        container.appendChild(groupDiv);
    });
}

function dragEnd(ev) {
    ev.target.classList.remove('dragging');
}

function displayUnassignedStudents() {
    const assignedStudents = new Set();
    groups.forEach(group => {
        group.students.forEach(student => assignedStudents.add(student));
    });
    
    const unassigned = classes[currentClass].students.filter(student => !assignedStudents.has(student));
    const container = document.getElementById('unassignedStudents');
    
    container.innerHTML = unassigned.map((student, index) => 
        `<div class="student-pill" draggable="true" ondragstart="drag(event, 'unassigned', ${index})" ondragend="dragEnd(event)">${student}</div>`
    ).join('');
}

function markGroupNameCustom(groupIndex) {
    // Mark as custom when user focuses on the input to edit
    groups[groupIndex].customName = true;
}

function updateGroupName(groupIndex, newName) {
    groups[groupIndex].name = newName;
    groups[groupIndex].customName = true;
    classes[currentClass].groups = groups;
    saveClasses();
}

// Emoji picker functions
function createEmojiPicker() {
    const picker = document.getElementById('emojiPicker');
    picker.innerHTML = emojis.map(emoji => 
        `<div class="emoji-option" onclick="selectEmoji('${emoji}')">${emoji}</div>`
    ).join('');
}

function showEmojiPicker(event, groupIndex) {
    event.stopPropagation();
    selectedEmoji = groupIndex;
    const picker = document.getElementById('emojiPicker');
    const rect = event.target.getBoundingClientRect();
    picker.style.left = rect.left + 'px';
    picker.style.top = (rect.bottom + 5) + 'px';
    picker.classList.remove('hidden');
    
    // Remove any existing listeners before adding new ones
    document.removeEventListener('click', hideEmojiPickerOnClick);
    document.removeEventListener('focusin', hideEmojiPickerOnFocus);
    
    // Add event listeners to hide picker
    setTimeout(() => {
        document.addEventListener('click', hideEmojiPickerOnClick);
        document.addEventListener('focusin', hideEmojiPickerOnFocus);
    }, 10);
}

function hideEmojiPickerOnClick(event) {
    const picker = document.getElementById('emojiPicker');
    if (!picker.contains(event.target)) {
        hideEmojiPicker();
    }
}

function hideEmojiPickerOnFocus(event) {
    const picker = document.getElementById('emojiPicker');
    const groupEmojis = document.querySelectorAll('.group-emoji');
    let clickedEmoji = false;
    
    groupEmojis.forEach(emoji => {
        if (emoji.contains(event.target)) {
            clickedEmoji = true;
        }
    });
    
    if (!picker.contains(event.target) && !clickedEmoji) {
        hideEmojiPicker();
    }
}

function hideEmojiPicker() {
    document.getElementById('emojiPicker').classList.add('hidden');
    document.removeEventListener('click', hideEmojiPickerOnClick);
    document.removeEventListener('focusin', hideEmojiPickerOnFocus);
}

function selectEmoji(emoji) {
    if (selectedEmoji !== null) {
        groups[selectedEmoji].emoji = emoji;
        classes[currentClass].groups = groups;
        saveClasses();
        displayGroups();
    }
    hideEmojiPicker();
}

// Drag and drop functions
function allowDrop(ev) {
    ev.preventDefault();
    ev.currentTarget.classList.add('drag-over');
}

function drag(ev, fromGroup, studentIndex) {
    ev.dataTransfer.setData('fromGroup', fromGroup);
    ev.dataTransfer.setData('studentIndex', studentIndex);
    ev.target.classList.add('dragging');
}

function dragLeave(ev) {
    ev.currentTarget.classList.remove('drag-over');
}

function drop(ev, toGroup) {
    ev.preventDefault();
    ev.currentTarget.classList.remove('drag-over');
    
    const fromGroup = ev.dataTransfer.getData('fromGroup');
    const studentIndex = parseInt(ev.dataTransfer.getData('studentIndex'));
    
    let student;
    if (fromGroup === 'unassigned') {
        const assignedStudents = new Set();
        groups.forEach(group => {
            group.students.forEach(s => assignedStudents.add(s));
        });
        const unassigned = classes[currentClass].students.filter(s => !assignedStudents.has(s));
        student = unassigned[studentIndex];
    } else {
        const fromGroupIndex = parseInt(fromGroup);
        student = groups[fromGroupIndex].students[studentIndex];
        groups[fromGroupIndex].students.splice(studentIndex, 1);
        
        // Update source group name if not custom
        if (!groups[fromGroupIndex].customName) {
            const newName = generateGroupName(groups[fromGroupIndex].students);
            if (newName === '') {
                groups[fromGroupIndex].name = 'Group ' + (fromGroupIndex + 1);
            }
        }
    }
    
    if (toGroup !== 'unassigned' && student) {
        groups[toGroup].students.push(student);
        
        // Update destination group name if not custom
        if (!groups[toGroup].customName) {
            groups[toGroup].name = generateGroupName(groups[toGroup].students);
        }
    }
    
    classes[currentClass].groups = groups;
    saveClasses();
    displayGroups();
    displayUnassignedStudents();
}

function dissolveMembers() {
    if (!currentClass) {
        alert('Please select a class first.');
        return;
    }
    if (confirm('Remove all students from groups? Group names and emojis will be kept.')) {
        groups.forEach((group, index) => {
            group.students = [];
            // Reset to default name if it was auto-generated
            if (!group.customName) {
                group.name = 'Group ' + (index + 1);
            }
        });
        classes[currentClass].groups = groups;
        saveClasses();
        displayGroups();
        displayUnassignedStudents();
    }
}

function dissolveGroupsAndNames() {
    if (!currentClass) {
        alert('Please select a class first.');
        return;
    }
    if (confirm('Reset all groups to default? This will remove all students and reset names/emojis.')) {
        groups = initializeGroups();
        classes[currentClass].groups = groups;
        saveClasses();
        displayGroups();
        displayUnassignedStudents();
    }
}

// Tournament functions
function displayClassesForTournament() {
    const container = document.getElementById('classListForTournament');
    container.innerHTML = '';
    
    Object.keys(classes).forEach(className => {
        // Check if class has groups set up and at least has students to assign
        const hasStudents = classes[className].students && classes[className].students.length >= 6;
        const hasGroups = classes[className].groups && classes[className].groups.length === 6;
        
        // Count how many groups have students
        let groupsWithStudents = 0;
        if (hasGroups) {
            groupsWithStudents = classes[className].groups.filter(g => g.students.length > 0).length;
        }
        
        const button = document.createElement('button');
        button.className = 'menu-button';
        button.innerHTML = `${className}<br><small style="font-size: 16px; color: rgba(255,255,255,0.8);">${groupsWithStudents}/6 groups ready</small>`;
        
        if (groupsWithStudents === 6) {
            button.onclick = () => startTournamentWithClass(className);
        } else {
            button.style.opacity = '0.6';
            button.style.cursor = 'not-allowed';
            button.onclick = () => alert('This class needs all 6 groups to have students assigned before starting a tournament.');
        }
        
        container.appendChild(button);
    });
    
    if (container.innerHTML === '') {
        container.innerHTML = '<p>No classes created yet.<br>Create classes in Class Administration first.</p>';
    }
}

function startTournamentWithClass(className) {
    currentClass = className;
    const allGroups = classes[className].groups;
    
    // Filter groups with students and apply generated names if needed
    groups = allGroups.map(group => ({
        ...group,
        name: group.customName ? group.name : (generateGroupName(group.students) || group.name)
    })).filter(g => g.students.length > 0);
    
    if (groups.length !== 6) {
        alert('This class needs exactly 6 groups with students to start a tournament.');
        return;
    }
    
    // Reset tournament state
    points = [0, 0, 0, 0, 0, 0];
    resultsByCollision = [];
    for (let i = 0; i < 5; i++) {
        resultsByCollision.push([
            {team1Result: null, team2Result: null},
            {team1Result: null, team2Result: null},
            {team1Result: null, team2Result: null}
        ]);
    }
    currentCollision = 0;
    
    // Generate matchups
    generateMatchups();
    
    // Start tournament
    hideAllPanels();
    document.getElementById('collision').classList.remove('hidden');
    setPastelColor(0);
    displayCollision(0);
}

function generateMatchups() {
    // Round-robin tournament structure for 6 teams
    matchups = [
        [[0, 1], [2, 5], [3, 4]],  // Round 1
        [[0, 2], [1, 4], [5, 3]],  // Round 2
        [[0, 3], [2, 4], [1, 5]],  // Round 3
        [[0, 4], [1, 3], [2, 5]],  // Round 4
        [[0, 5], [1, 2], [4, 3]]   // Round 5
    ];
}

function displayCollision(collisionIndex) {
    const roundTitles = ["Round 1", "Round 2", "Round 3", "Round 4", "Round 5"];
    document.getElementById('collisionTitle').textContent = roundTitles[collisionIndex];
    
    const matchDiv = document.getElementById('matches');
    matchDiv.innerHTML = '';
    
    matchups[collisionIndex].forEach((match, index) => {
        const team1Index = match[0];
        const team2Index = match[1];
        const team1 = groups[team1Index];
        const team2 = groups[team2Index];

        matchDiv.innerHTML += `
            <div class="match">
                <div>
                    <h3>${team1.emoji} ${team1.name} vs ${team2.emoji} ${team2.name}</h3>
                    <div style="font-size: 16px; color: #666; margin-bottom: 10px;">
                        ${team1.name}: ${team1.students.join(', ')}<br>
                        ${team2.name}: ${team2.students.join(', ')}
                    </div>
                    ${team1.name}: 
                    <label class="radio-label"><input type="radio" name="result${index}team1" value="2" onclick="setResult(${collisionIndex}, ${index}, 'team1', 2)" ${resultsByCollision[collisionIndex][index].team1Result === 2 ? 'checked' : ''}> Survived</label>
                    <label class="radio-label"><input type="radio" name="result${index}team1" value="1" onclick="setResult(${collisionIndex}, ${index}, 'team1', 1)" ${resultsByCollision[collisionIndex][index].team1Result === 1 ? 'checked' : ''}> Injured</label>
                    <label class="radio-label"><input type="radio" name="result${index}team1" value="0" onclick="setResult(${collisionIndex}, ${index}, 'team1', 0)" ${resultsByCollision[collisionIndex][index].team1Result === 0 ? 'checked' : ''}> Fatal</label><br>
                    ${team2.name}: 
                    <label class="radio-label"><input type="radio" name="result${index}team2" value="2" onclick="setResult(${collisionIndex}, ${index}, 'team2', 2)" ${resultsByCollision[collisionIndex][index].team2Result === 2 ? 'checked' : ''}> Survived</label>
                    <label class="radio-label"><input type="radio" name="result${index}team2" value="1" onclick="setResult(${collisionIndex}, ${index}, 'team2', 1)" ${resultsByCollision[collisionIndex][index].team2Result === 1 ? 'checked' : ''}> Injured</label>
                    <label class="radio-label"><input type="radio" name="result${index}team2" value="0" onclick="setResult(${collisionIndex}, ${index}, 'team2', 0)" ${resultsByCollision[collisionIndex][index].team2Result === 0 ? 'checked' : ''}> Fatal</label>
                </div>
            </div>
        `;
    });

    displayRunningTotal();
}

function setPastelColor(collisionIndex) {
    const pastelColors = ["#ffe4e1", "#e6e6fa", "#e0ffff", "#f5f5dc", "#fafad2"];
    document.getElementById('collision').style.setProperty("--pastel-color", pastelColors[collisionIndex % pastelColors.length]);
}

function setResult(collisionIndex, matchIndex, team, value) {
    resultsByCollision[collisionIndex][matchIndex][`${team}Result`] = parseInt(value);
    updatePoints();
}

function updatePoints() {
    points = [0, 0, 0, 0, 0, 0];

    resultsByCollision.forEach((collision, collisionIndex) => {
        collision.forEach((match, matchIndex) => {
            const team1Index = matchups[collisionIndex][matchIndex][0];
            const team2Index = matchups[collisionIndex][matchIndex][1];
            if (match.team1Result !== null) points[team1Index] += match.team1Result;
            if (match.team2Result !== null) points[team2Index] += match.team2Result;
        });
    });

    displayCollision(currentCollision);
}

// Function to get ranking color based on actual ranking (considering ties)
function getRankingColor(points, teamPoints) {
    // Get unique point values in descending order
    const uniquePoints = [...new Set(points)].sort((a, b) => b - a);
    
    // Find which rank this team's points represent
    const rank = uniquePoints.indexOf(teamPoints);
    
    const colors = [
        '#4CAF50', // 1st - Green
        '#8BC34A', // 2nd - Light Green
        '#CDDC39', // 3rd - Lime
        '#FFEB3B', // 4th - Yellow
        '#FF9800', // 5th - Orange
        '#F44336'  // 6th - Red
    ];
    
    return colors[rank] || '#f0f0f0';
}

// Function to calculate S/I/F counts for each team
function calculateSIFCounts() {
    const sifCounts = Array(6).fill(null).map(() => ({ survived: 0, injured: 0, fatal: 0 }));
    
    resultsByCollision.forEach((collision, collisionIndex) => {
        collision.forEach((match, matchIndex) => {
            const team1Index = matchups[collisionIndex][matchIndex][0];
            const team2Index = matchups[collisionIndex][matchIndex][1];
            
            // Team 1 results
            if (match.team1Result !== null) {
                if (match.team1Result === 2) sifCounts[team1Index].survived++;
                else if (match.team1Result === 1) sifCounts[team1Index].injured++;
                else if (match.team1Result === 0) sifCounts[team1Index].fatal++;
            }
            
            // Team 2 results
            if (match.team2Result !== null) {
                if (match.team2Result === 2) sifCounts[team2Index].survived++;
                else if (match.team2Result === 1) sifCounts[team2Index].injured++;
                else if (match.team2Result === 0) sifCounts[team2Index].fatal++;
            }
        });
    });
    
    return sifCounts;
}

function displayRunningTotal() {
    const runningTotalDiv = document.getElementById('runningTotal');
    runningTotalDiv.innerHTML = '<h3>Current Points</h3>';
    
    const sifCounts = calculateSIFCounts();
    const hasPoints = points.some(p => p > 0);
    
    const sortedTeams = groups.map((group, index) => ({
        name: group.name,
        emoji: group.emoji,
        points: points[index],
        sif: sifCounts[index],
        originalIndex: index
    })).sort((a, b) => b.points - a.points);
    
    sortedTeams.forEach((team) => {
        const bgColor = hasPoints ? getRankingColor(points, team.points) : 'transparent';
        const sifText = `${team.sif.survived}S, ${team.sif.injured}I, ${team.sif.fatal}F`;
        runningTotalDiv.innerHTML += `<div style="padding: 5px; margin: 2px 0; background-color: ${bgColor}; border-radius: 5px;">${team.emoji} ${team.name}: ${team.points} ${team.points === 1 ? 'point' : 'points'} <span style="font-size: 16px; font-family: 'Arial Narrow', Arial, sans-serif;">${sifText}</span></div>`;
    });
}

function nextCollision() {
    currentCollision++;
    if (currentCollision < 5) {
        setPastelColor(currentCollision);
        displayCollision(currentCollision);
    } else {
        showResults();
    }
}

function prevCollision() {
    if (currentCollision > 0) {
        currentCollision--;
        setPastelColor(currentCollision);
        displayCollision(currentCollision);
    } else if (currentCollision === 0) {
        showClassSelection();
    }
}

function showResults() {
    hideAllPanels();
    document.getElementById('results').classList.remove('hidden');

    const resultsDiv = document.getElementById('finalScores');
    resultsDiv.innerHTML = '<h3>Final Scores</h3>';
    
    const sifCounts = calculateSIFCounts();
    const hasPoints = points.some(p => p > 0);
    
    const sortedTeams = groups.map((group, index) => ({
        name: group.name,
        emoji: group.emoji,
        points: points[index],
        students: group.students,
        sif: sifCounts[index]
    })).sort((a, b) => b.points - a.points);
    
    sortedTeams.forEach((team, rank) => {
        const bgColor = hasPoints ? getRankingColor(points, team.points) : 'transparent';
        const sifText = `${team.sif.survived}S, ${team.sif.injured}I, ${team.sif.fatal}F`;
        resultsDiv.innerHTML += `
            <div style="margin: 15px 0; padding: 10px; background-color: ${bgColor}; border-radius: 8px;">
                <strong>${rank + 1}. ${team.emoji} ${team.name}: ${team.points} ${team.points === 1 ? 'point' : 'points'}</strong> <span style="font-size: 18px; font-family: 'Arial Narrow', Arial, sans-serif;">${sifText}</span><br>
                <span style="font-size: 18px; color: #666;">${team.students.join(', ')}</span>
            </div>
        `;
    });
}

function goBackToLastCollision() {
    currentCollision = 4;
    hideAllPanels();
    document.getElementById('collision').classList.remove('hidden');
    setPastelColor(currentCollision);
    displayCollision(currentCollision);
}

function confirmRestart() {
    if (confirm('Are you sure you want to restart the tournament? All progress will be lost.')) {
        showClassSelection();
    }
}
</script>

</body>
</html>