<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Trovu</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Instrument+Serif:ital@0;1&family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&family=Barlow+Condensed:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
    <style>
        :root {
            /* Light Theme - Warm Paper */
            --bg-primary: #FAF8F5;
            --bg-secondary: #F2EDE6;
            --bg-tertiary: #E8E2D9;
            --bg-card: #FFFFFF;
            --bg-card-hover: #FFFDF9;
            
            --text-primary: #1A1814;
            --text-secondary: #4A4640;
            --text-tertiary: #7A756D;
            --text-muted: #9A958D;
            
            --accent-primary: #C45D35;
            --accent-primary-hover: #A84D2B;
            --accent-secondary: #2D5A4A;
            --accent-tertiary: #8B6914;
            
            --border-light: rgba(26, 24, 20, 0.08);
            --border-medium: rgba(26, 24, 20, 0.15);
            --border-heavy: rgba(26, 24, 20, 0.25);
            
            --shadow-sm: 0 1px 2px rgba(26, 24, 20, 0.04), 0 1px 3px rgba(26, 24, 20, 0.06);
            --shadow-md: 0 4px 6px rgba(26, 24, 20, 0.05), 0 2px 4px rgba(26, 24, 20, 0.04);
            --shadow-lg: 0 10px 25px rgba(26, 24, 20, 0.08), 0 4px 10px rgba(26, 24, 20, 0.05);
            
            --success: #2D7A5A;
            --warning: #B8860B;
            --error: #C44536;
            --info: #3D6B99;
            
            --font-display: 'Instrument Serif', Georgia, serif;
            --font-body: 'DM Sans', -apple-system, BlinkMacSystemFont, sans-serif;
            --font-condensed: 'Barlow Condensed', sans-serif;
            --font-mono: 'JetBrains Mono', monospace;
            
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --radius-xl: 16px;
            
            --transition-fast: 0.15s ease;
            --transition-normal: 0.25s ease;
            --transition-slow: 0.4s ease;
            
            --header-height: 64px;
            --nav-height: 56px;
            --progress-height: 48px;
        }
        
        [data-theme="dark"] {
            --bg-primary: #141210;
            --bg-secondary: #1C1A17;
            --bg-tertiary: #252320;
            --bg-card: #1E1C19;
            --bg-card-hover: #26241F;
            
            --text-primary: #F5F3F0;
            --text-secondary: #C5C2BD;
            --text-tertiary: #8A867F;
            --text-muted: #5A5752;
            
            --accent-primary: #E07A54;
            --accent-primary-hover: #F08A64;
            --accent-secondary: #4A9A7A;
            --accent-tertiary: #D4A828;
            
            --border-light: rgba(245, 243, 240, 0.06);
            --border-medium: rgba(245, 243, 240, 0.12);
            --border-heavy: rgba(245, 243, 240, 0.2);
            
            --shadow-sm: 0 1px 2px rgba(0, 0, 0, 0.2), 0 1px 3px rgba(0, 0, 0, 0.15);
            --shadow-md: 0 4px 6px rgba(0, 0, 0, 0.2), 0 2px 4px rgba(0, 0, 0, 0.15);
            --shadow-lg: 0 10px 25px rgba(0, 0, 0, 0.3), 0 4px 10px rgba(0, 0, 0, 0.2);
            
            --success: #4ABA7A;
            --warning: #E8B84A;
            --error: #E86A5B;
            --info: #5A9AD4;
        }
        
        /* Reset & Base */
        *, *::before, *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }
        
        html {
            font-size: 16px;
            scroll-behavior: smooth;
            -webkit-text-size-adjust: 100%;
        }
        
        body {
            font-family: var(--font-body);
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100vh;
            min-height: 100dvh;
            overflow-x: hidden;
            transition: background var(--transition-normal), color var(--transition-normal);
        }
        
        /* Texture overlay for depth */
        body::before {
            content: '';
            position: fixed;
            inset: 0;
            pointer-events: none;
            opacity: 0.03;
            background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
            z-index: 9999;
        }
        
        [data-theme="dark"] body::before {
            opacity: 0.015;
        }
        
        /* Typography */
        h1, h2, h3, h4, h5, h6 {
            font-family: var(--font-display);
            font-weight: 400;
            line-height: 1.3;
            letter-spacing: -0.01em;
        }
        
        h1 { font-size: clamp(1.75rem, 4vw, 2.5rem); }
        h2 { font-size: clamp(1.5rem, 3vw, 2rem); }
        h3 { font-size: clamp(1.25rem, 2.5vw, 1.5rem); }
        h4 { font-size: clamp(1.1rem, 2vw, 1.25rem); }
        
        p {
            max-width: 70ch;
        }
        
        /* App Container */
        .app-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            min-height: 100dvh;
        }
        
        /* Header */
        .app-header {
            position: sticky;
            top: 0;
            z-index: 100;
            background: var(--bg-card);
            border-bottom: 1px solid var(--border-light);
            height: var(--header-height);
            display: flex;
            align-items: center;
            padding: 0 clamp(1rem, 3vw, 2rem);
            gap: 1rem;
            box-shadow: var(--shadow-sm);
            transition: background var(--transition-normal), border-color var(--transition-normal);
        }
        
        .header-brand {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-shrink: 0;
        }
        
        .brand-icon {
            width: 36px;
            height: 36px;
            background: linear-gradient(135deg, var(--accent-primary) 0%, #ff6b4a 100%);
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 800;
            font-size: 1.3rem;
            font-family: var(--font-display);
            letter-spacing: -0.05em;
            box-shadow: 0 2px 8px rgba(233, 87, 63, 0.3);
        }
        
        .brand-text {
            font-family: var(--font-display);
            font-size: 1.4rem;
            font-weight: 700;
            letter-spacing: -0.03em;
            background: linear-gradient(135deg, var(--accent-primary) 0%, #ff6b4a 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: none;
        }
        
        [data-theme="dark"] .brand-text {
            background: linear-gradient(135deg, #ff8a70 0%, #ffa07a 100%);
            -webkit-background-clip: text;
            background-clip: text;
        }
        
        @media (min-width: 768px) {
            .brand-text { display: block; }
        }
        
        .header-context {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            min-width: 0;
        }
        
        .curriculum-code {
            font-family: var(--font-mono);
            font-size: 0.85rem;
            font-weight: 500;
            color: var(--accent-primary);
            background: var(--bg-secondary);
            padding: 0.35rem 0.75rem;
            border-radius: var(--radius-sm);
            white-space: nowrap;
        }
        
        .topic-title {
            font-family: var(--font-display);
            font-size: 1.1rem;
            color: var(--text-secondary);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            display: none;
        }
        
        @media (min-width: 640px) {
            .topic-title { display: block; }
        }
        
        .header-actions {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-shrink: 0;
        }
        
        /* Icon Buttons */
        .icon-btn {
            width: 40px;
            height: 40px;
            border: none;
            background: transparent;
            color: var(--text-secondary);
            border-radius: var(--radius-md);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
            position: relative;
        }
        
        .icon-btn:hover {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }
        
        .icon-btn:active {
            transform: scale(0.95);
        }
        
        .icon-btn svg {
            width: 20px;
            height: 20px;
        }
        
        /* Theme Toggle */
        .theme-toggle {
            position: relative;
            overflow: hidden;
        }
        
        .theme-toggle .icon-sun,
        .theme-toggle .icon-moon {
            position: absolute;
            transition: transform var(--transition-normal), opacity var(--transition-normal);
        }
        
        .theme-toggle .icon-sun {
            opacity: 1;
            transform: rotate(0deg);
        }
        
        .theme-toggle .icon-moon {
            opacity: 0;
            transform: rotate(-90deg);
        }
        
        [data-theme="dark"] .theme-toggle .icon-sun {
            opacity: 0;
            transform: rotate(90deg);
        }
        
        [data-theme="dark"] .theme-toggle .icon-moon {
            opacity: 1;
            transform: rotate(0deg);
        }
        
        /* Navigation Strip */
        .nav-strip {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-light);
            padding: 0.5rem clamp(0.75rem, 2vw, 1.5rem);
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            scrollbar-width: none;
            transition: background var(--transition-normal);
        }
        
        .nav-strip::-webkit-scrollbar {
            display: none;
        }
        
        .nav-selectors {
            display: flex;
            gap: 0.4rem;
            align-items: flex-end;
        }
        
        .nav-divider {
            width: 1px;
            height: 24px;
            background: var(--border-light);
            margin: 0 0.3rem;
            flex-shrink: 0;
            align-self: flex-end;
            margin-bottom: 4px;
        }
        
        .nav-divider.hidden {
            display: none;
        }
        
        .nav-selector {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }
        
        .nav-selector.hidden {
            display: none;
        }
        
        .nav-selector label {
            font-family: var(--font-condensed);
            font-size: 0.65rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            color: var(--text-tertiary);
            padding-left: 0.2rem;
            white-space: nowrap;
        }
        
        .nav-selector select {
            appearance: none;
            font-family: var(--font-condensed);
            font-size: 0.9rem;
            font-weight: 500;
            color: var(--text-primary);
            background: var(--bg-card);
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-sm);
            padding: 0.4rem 1.4rem 0.4rem 0.5rem;
            cursor: pointer;
            transition: all var(--transition-fast);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%237A756D' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.3rem center;
            white-space: nowrap;
            width: auto;
        }
        
        .nav-selector select:hover {
            border-color: var(--border-heavy);
            background-color: var(--bg-card-hover);
        }
        
        .nav-selector select:focus {
            outline: none;
            border-color: var(--accent-primary);
            box-shadow: 0 0 0 2px rgba(196, 93, 53, 0.15);
        }
        
        /* Reading level selector special styling */
        .nav-selector.reading-level select {
            background-color: var(--accent-secondary);
            color: white;
            border-color: var(--accent-secondary);
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3E%3Cpolyline points='6 9 12 15 18 9'%3E%3C/polyline%3E%3C/svg%3E");
        }
        
        .nav-selector.reading-level select:hover {
            background-color: var(--accent-secondary);
            filter: brightness(1.1);
        }
        
        /* Main Content */
        .main-content {
            flex: 1;
            padding: clamp(1rem, 3vw, 2rem);
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }
        
        /* Content Sections */
        .content-sections {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .content-section {
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-lg);
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            transition: all var(--transition-normal);
        }
        
        .content-section:hover {
            box-shadow: var(--shadow-md);
        }
        
        .section-header {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 1.25rem;
            cursor: pointer;
            user-select: none;
            transition: background var(--transition-fast);
            border: none;
            background: transparent;
            width: 100%;
            text-align: left;
            color: var(--text-primary);
        }
        
        .section-header:hover {
            background: var(--bg-secondary);
        }
        
        .section-icon {
            width: 32px;
            height: 32px;
            border-radius: var(--radius-md);
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            transition: transform var(--transition-normal);
        }
        
        .section-icon svg {
            width: 18px;
            height: 18px;
        }
        
        .section-icon.learning { background: linear-gradient(135deg, #E8D5B7, #D4BC94); color: #6B5D3F; }
        .section-icon.content { background: linear-gradient(135deg, #D5E8D5, #B4D4B4); color: #3F6B3F; }
        .section-icon.case { background: linear-gradient(135deg, #D5D8E8, #B4BAD4); color: #3F456B; }
        .section-icon.check { background: linear-gradient(135deg, #E8D5D8, #D4B4BA); color: #6B3F45; }
        .section-icon.show { background: linear-gradient(135deg, #E8E5D5, #D4D0B4); color: #6B653F; }
        .section-icon.reflect { background: linear-gradient(135deg, #D5E5E8, #B4D0D4); color: #3F5F6B; }
        
        .section-title {
            flex: 1;
            font-family: var(--font-display);
            font-size: 1.1rem;
            font-weight: 400;
        }
        
        .section-chevron {
            width: 20px;
            height: 20px;
            color: var(--text-tertiary);
            transition: transform var(--transition-normal);
            flex-shrink: 0;
        }
        
        .content-section.expanded .section-chevron {
            transform: rotate(180deg);
        }
        
        .section-body {
            display: grid;
            grid-template-rows: 0fr;
            transition: grid-template-rows var(--transition-normal);
        }
        
        .content-section.expanded .section-body {
            grid-template-rows: 1fr;
        }
        
        .section-body-inner {
            overflow: hidden;
        }
        
        .section-content {
            padding: 0 1.25rem 1.25rem;
            border-top: 1px solid var(--border-light);
        }
        
        .section-content > *:first-child {
            margin-top: 1.25rem;
        }
        
        /* Learning Goals & How I'll Know I've Got It */
        .learning-goals {
            margin-bottom: 1.5rem;
        }
        
        .learning-goals h4 {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
        }
        
        .goal-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .goal-list li {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            font-size: 0.95rem;
        }
        
        .goal-list li::before {
            content: 'â†’';
            color: var(--accent-primary);
            font-weight: 600;
            flex-shrink: 0;
        }
        
        .success-box {
            background: linear-gradient(135deg, var(--bg-secondary), var(--bg-tertiary));
            border-radius: var(--radius-lg);
            padding: 1.25rem;
        }
        
        .success-box h4 {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-tertiary);
            text-transform: uppercase;
            letter-spacing: 0.05em;
            margin-bottom: 0.75rem;
        }
        
        .success-list {
            list-style: none;
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .success-item {
            display: flex;
            flex-direction: column;
            gap: 0.25rem;
        }
        
        .success-statement {
            font-weight: 500;
            color: var(--text-primary);
        }
        
        .success-evidence {
            font-size: 0.875rem;
            color: var(--text-tertiary);
            padding-left: 1rem;
            border-left: 2px solid var(--border-medium);
        }
        
        /* Vocabulary Cards */
        .vocabulary-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }
        
        .vocab-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: 1rem;
            border-left: 3px solid var(--accent-primary);
        }
        
        .vocab-term {
            font-family: var(--font-display);
            font-size: 1.1rem;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }
        
        .vocab-pronunciation {
            font-family: var(--font-mono);
            font-size: 0.8rem;
            color: var(--text-tertiary);
            margin-bottom: 0.5rem;
        }
        
        .vocab-definition {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }
        
        /* Key Points */
        .key-points {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            margin-top: 1.5rem;
        }
        
        .key-point {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
        }
        
        .key-point-number {
            width: 24px;
            height: 24px;
            background: var(--accent-secondary);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            flex-shrink: 0;
        }
        
        /* Question Tabs */
        .question-tabs {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
            border-bottom: 1px solid var(--border-light);
            padding-bottom: 0.75rem;
        }
        
        .question-tab {
            padding: 0.5rem 1rem;
            border: none;
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border-radius: var(--radius-md);
            font-family: var(--font-body);
            font-size: 0.875rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .question-tab:hover {
            background: var(--bg-tertiary);
            color: var(--text-primary);
        }
        
        .question-tab.active {
            background: var(--accent-primary);
            color: white;
        }
        
        .question-content {
            display: none;
        }
        
        .question-content.active {
            display: block;
        }
        
        .question-card {
            background: var(--bg-secondary);
            border-radius: var(--radius-lg);
            padding: 1.25rem;
            margin-bottom: 1rem;
        }
        
        .question-stem {
            font-size: 1rem;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 1rem;
        }
        
        .options-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }
        
        .option-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem 1rem;
            background: var(--bg-card);
            border: 1px solid var(--border-light);
            border-radius: var(--radius-md);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .option-item:hover {
            border-color: var(--border-medium);
            background: var(--bg-card-hover);
        }
        
        .option-item.selected {
            border-color: var(--accent-primary);
            background: rgba(196, 93, 53, 0.05);
        }
        
        .option-id {
            width: 28px;
            height: 28px;
            background: var(--bg-tertiary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            font-size: 0.875rem;
            color: var(--text-secondary);
            flex-shrink: 0;
        }
        
        .option-item.selected .option-id {
            background: var(--accent-primary);
            color: white;
        }
        
        /* Self Rating */
        .self-rating-grid {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }
        
        .rating-row {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 0.75rem 1rem;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            flex-wrap: wrap;
        }
        
        .rating-statement {
            flex: 1;
            min-width: 200px;
            font-size: 0.95rem;
        }
        
        .rating-scale {
            display: flex;
            gap: 0.25rem;
        }
        
        .rating-btn {
            width: 36px;
            height: 36px;
            border: 1px solid var(--border-medium);
            background: var(--bg-card);
            border-radius: var(--radius-sm);
            font-size: 0.875rem;
            font-weight: 500;
            color: var(--text-secondary);
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .rating-btn:hover {
            border-color: var(--accent-primary);
            color: var(--accent-primary);
        }
        
        .rating-btn.selected {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }
        
        /* Progress Bar */
        .progress-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border-top: 1px solid var(--border-light);
            height: var(--progress-height);
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 0 1rem;
            gap: 0.5rem;
            box-shadow: var(--shadow-md);
            z-index: 50;
            transition: background var(--transition-normal);
        }
        
        .progress-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.8rem;
            color: var(--text-tertiary);
        }
        
        .progress-item.active {
            color: var(--accent-primary);
            font-weight: 500;
        }
        
        .progress-arrow {
            color: var(--text-muted);
        }
        
        @media (max-width: 640px) {
            .progress-bar {
                font-size: 0.75rem;
                padding: 0 0.5rem;
                gap: 0.25rem;
            }
            
            .progress-item span:not(.progress-label) {
                display: none;
            }
        }
        
        /* Settings Panel */
        .settings-panel {
            position: fixed;
            top: 0;
            right: 0;
            bottom: 0;
            width: min(400px, 100vw);
            background: var(--bg-card);
            box-shadow: var(--shadow-lg);
            z-index: 200;
            transform: translateX(100%);
            transition: transform var(--transition-normal);
            display: flex;
            flex-direction: column;
        }
        
        .settings-panel.open {
            transform: translateX(0);
        }
        
        .settings-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 199;
            opacity: 0;
            pointer-events: none;
            transition: opacity var(--transition-normal);
        }
        
        .settings-backdrop.open {
            opacity: 1;
            pointer-events: auto;
        }
        
        .settings-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border-light);
        }
        
        .settings-header h2 {
            font-size: 1.25rem;
        }
        
        .settings-body {
            flex: 1;
            overflow-y: auto;
            padding: 1.25rem;
        }
        
        .settings-group {
            margin-bottom: 1.5rem;
        }
        
        .settings-group h3 {
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: var(--text-tertiary);
            margin-bottom: 0.75rem;
        }
        
        .setting-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 0;
            border-bottom: 1px solid var(--border-light);
        }
        
        .setting-row:last-child {
            border-bottom: none;
        }
        
        .setting-label {
            font-weight: 500;
        }
        
        /* Toggle Switch */
        .toggle-switch {
            width: 48px;
            height: 28px;
            background: var(--bg-tertiary);
            border-radius: 14px;
            position: relative;
            cursor: pointer;
            transition: background var(--transition-fast);
        }
        
        .toggle-switch.active {
            background: var(--accent-primary);
        }
        
        .toggle-switch::after {
            content: '';
            position: absolute;
            top: 3px;
            left: 3px;
            width: 22px;
            height: 22px;
            background: white;
            border-radius: 50%;
            transition: transform var(--transition-fast);
            box-shadow: var(--shadow-sm);
        }
        
        .toggle-switch.active::after {
            transform: translateX(20px);
        }
        
        /* Toast Notifications */
        .toast-container {
            position: fixed;
            bottom: calc(var(--progress-height) + 1rem);
            right: 1rem;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
            z-index: 300;
        }
        
        .toast {
            background: var(--bg-card);
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-md);
            padding: 0.75rem 1rem;
            box-shadow: var(--shadow-lg);
            display: flex;
            align-items: center;
            gap: 0.75rem;
            animation: slideIn 0.3s ease;
            max-width: 320px;
        }
        
        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        .toast.success { border-left: 3px solid var(--success); }
        .toast.warning { border-left: 3px solid var(--warning); }
        .toast.error { border-left: 3px solid var(--error); }
        .toast.info { border-left: 3px solid var(--info); }
        
        /* Loading State */
        .loading-skeleton {
            background: linear-gradient(90deg, var(--bg-secondary) 25%, var(--bg-tertiary) 50%, var(--bg-secondary) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: var(--radius-md);
        }
        
        @keyframes shimmer {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }
        
        /* Placeholder State */
        .placeholder-state {
            text-align: center;
            padding: 3rem 2rem;
            color: var(--text-tertiary);
        }
        
        .placeholder-icon {
            width: 64px;
            height: 64px;
            margin: 0 auto 1rem;
            opacity: 0.5;
        }
        
        .placeholder-title {
            font-family: var(--font-display);
            font-size: 1.25rem;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }
        
        /* Utility for main content padding */
        .main-content {
            padding-bottom: calc(var(--progress-height) + 2rem);
        }
        
        /* Keyboard shortcut hints */
        kbd {
            display: inline-block;
            padding: 0.15em 0.4em;
            font-family: var(--font-mono);
            font-size: 0.75em;
            background: var(--bg-tertiary);
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-sm);
            box-shadow: 0 1px 0 var(--border-medium);
        }
        
        /* Focus states for accessibility */
        :focus-visible {
            outline: 2px solid var(--accent-primary);
            outline-offset: 2px;
        }
        
        /* Map Button */
        .map-btn {
            width: 32px;
            height: 32px;
            border: 1px solid var(--border-medium);
            background: var(--bg-secondary);
            color: var(--text-secondary);
            border-radius: var(--radius-sm);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all var(--transition-fast);
            flex-shrink: 0;
        }
        
        .map-btn:hover {
            background: var(--accent-primary);
            border-color: var(--accent-primary);
            color: white;
        }
        
        .map-btn svg {
            width: 16px;
            height: 16px;
        }
        
        /* Map Panel */
        .map-panel {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%) scale(0.95);
            width: min(90vw, 800px);
            max-height: 85vh;
            background: var(--bg-card);
            border: 1px solid var(--border-medium);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow-lg);
            z-index: 300;
            opacity: 0;
            pointer-events: none;
            transition: all var(--transition-normal);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .map-panel.open {
            opacity: 1;
            pointer-events: auto;
            transform: translate(-50%, -50%) scale(1);
        }
        
        .map-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 299;
            opacity: 0;
            pointer-events: none;
            transition: opacity var(--transition-normal);
        }
        
        .map-backdrop.open {
            opacity: 1;
            pointer-events: auto;
        }
        
        .map-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1rem 1.25rem;
            border-bottom: 1px solid var(--border-light);
            flex-shrink: 0;
        }
        
        .map-header h2 {
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .map-header h2 span {
            font-family: var(--font-mono);
            font-size: 0.8rem;
            color: var(--accent-primary);
            background: var(--bg-secondary);
            padding: 0.2rem 0.5rem;
            border-radius: var(--radius-sm);
        }
        
        .map-body {
            flex: 1;
            overflow-y: auto;
            padding: 1.25rem;
        }
        
        .map-stats {
            display: flex;
            gap: 1rem;
            margin-bottom: 1.25rem;
            flex-wrap: wrap;
        }
        
        .map-stat {
            background: var(--bg-secondary);
            padding: 0.5rem 0.75rem;
            border-radius: var(--radius-md);
            font-size: 0.8rem;
        }
        
        .map-stat strong {
            color: var(--accent-primary);
            font-weight: 600;
        }
        
        /* Wireframe Grid */
        .wireframe-container {
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
            padding: 1rem;
            overflow-x: auto;
        }
        
        .wireframe-label {
            font-family: var(--font-condensed);
            font-size: 0.7rem;
            font-weight: 500;
            text-transform: uppercase;
            letter-spacing: 0.03em;
            color: var(--text-tertiary);
            margin-bottom: 0.5rem;
        }
        
        .wireframe-grid {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        
        .wireframe-row {
            display: flex;
            align-items: center;
            gap: 4px;
        }
        
        .wireframe-row-label {
            width: 60px;
            font-family: var(--font-condensed);
            font-size: 0.65rem;
            color: var(--text-tertiary);
            text-align: right;
            padding-right: 6px;
            flex-shrink: 0;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .wireframe-cells {
            display: flex;
            gap: 1px;
            flex-wrap: wrap;
        }
        
        .wireframe-cell {
            width: 8px;
            height: 8px;
            background: var(--border-light);
            border-radius: 1px;
            transition: all var(--transition-fast);
        }
        
        .wireframe-cell.filled {
            background: var(--text-muted);
        }
        
        .wireframe-cell.current-area {
            background: var(--accent-secondary);
            opacity: 0.5;
        }
        
        .wireframe-cell.current-strand {
            background: var(--accent-secondary);
            opacity: 0.7;
        }
        
        .wireframe-cell.current {
            background: var(--accent-primary);
            box-shadow: 0 0 0 2px var(--accent-primary), 0 0 8px var(--accent-primary);
            transform: scale(1.5);
            z-index: 1;
            position: relative;
        }
        
        .wireframe-legend {
            display: flex;
            gap: 1rem;
            margin-top: 1rem;
            flex-wrap: wrap;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.35rem;
            font-size: 0.7rem;
            color: var(--text-tertiary);
        }
        
        .legend-dot {
            width: 10px;
            height: 10px;
            border-radius: 2px;
        }
        
        .legend-dot.available { background: var(--text-muted); }
        .legend-dot.current-area { background: var(--accent-secondary); opacity: 0.5; }
        .legend-dot.current-strand { background: var(--accent-secondary); opacity: 0.7; }
        .legend-dot.you-are-here { background: var(--accent-primary); box-shadow: 0 0 4px var(--accent-primary); }
        
        /* Breadcrumb path */
        .map-breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            flex-wrap: wrap;
            margin-bottom: 1rem;
            padding: 0.75rem 1rem;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            font-family: var(--font-condensed);
            font-size: 0.85rem;
        }
        
        .map-breadcrumb span {
            color: var(--text-tertiary);
        }
        
        .map-breadcrumb strong {
            color: var(--text-primary);
            font-weight: 500;
        }
        
        .map-breadcrumb .current {
            color: var(--accent-primary);
            font-weight: 600;
        }
        
        .breadcrumb-arrow {
            color: var(--text-muted);
            font-size: 0.7rem;
        }
        
        /* Loading Spinner */
        .content-sections.loading {
            position: relative;
            min-height: 200px;
            pointer-events: none;
            opacity: 0.5;
        }
        
        .content-sections.loading::after {
            content: '';
            position: absolute;
            top: 100px;
            left: 50%;
            transform: translateX(-50%);
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-light);
            border-top-color: var(--accent-primary);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }
        
        @keyframes spin {
            to { transform: translateX(-50%) rotate(360deg); }
        }
        
        /* Placeholder state */
        .placeholder-state {
            text-align: center;
            color: var(--text-tertiary);
            font-style: italic;
            padding: 2rem;
            background: var(--bg-secondary);
            border-radius: var(--radius-md);
        }
        
        /* Difficulty badge */
        .difficulty-badge {
            font-size: 0.75rem;
            padding: 0.2rem 0.5rem;
            background: var(--bg-tertiary);
            border-radius: var(--radius-sm);
            color: var(--text-tertiary);
            margin-bottom: 0.75rem;
            display: inline-block;
        }
        
        /* No topic selected state */
        .no-topic-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            text-align: center;
            padding: 4rem 2rem;
            color: var(--text-tertiary);
        }
        
        .no-topic-icon {
            width: 80px;
            height: 80px;
            margin-bottom: 1.5rem;
            opacity: 0.4;
        }
        
        .no-topic-icon svg {
            width: 100%;
            height: 100%;
        }
        
        .no-topic-state h3 {
            font-family: var(--font-display);
            font-size: 1.5rem;
            font-weight: 600;
            color: var(--text-secondary);
            margin-bottom: 0.5rem;
        }
        
        .no-topic-state p {
            font-size: 1rem;
            max-width: 400px;
        }
        
        .no-topic-hint {
            margin-top: 1rem;
            font-size: 0.85rem;
            font-style: italic;
            color: var(--text-muted);
        }
        
        /* Submission Modal */
        .submission-modal-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            padding: 1rem;
        }
        
        .submission-modal {
            background: var(--bg-card);
            border-radius: var(--radius-xl);
            box-shadow: var(--shadow-lg);
            max-width: 600px;
            width: 100%;
            max-height: 80vh;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .submission-modal-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 1.25rem 1.5rem;
            border-bottom: 1px solid var(--border-light);
        }
        
        .submission-modal-header h3 {
            font-family: var(--font-display);
            font-size: 1.25rem;
            margin: 0;
        }
        
        .close-submission-modal {
            background: none;
            border: none;
            font-size: 1.5rem;
            color: var(--text-tertiary);
            cursor: pointer;
            padding: 0.25rem;
            line-height: 1;
        }
        
        .close-submission-modal:hover {
            color: var(--text-primary);
        }
        
        .submission-modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            flex: 1;
        }
        
        .submission-modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-light);
        }
        
        .btn-primary, .btn-secondary {
            padding: 0.6rem 1.25rem;
            border-radius: var(--radius-md);
            font-family: var(--font-body);
            font-size: 0.9rem;
            font-weight: 500;
            cursor: pointer;
            transition: all var(--transition-fast);
        }
        
        .btn-primary {
            background: var(--accent-primary);
            color: white;
            border: none;
        }
        
        .btn-primary:hover {
            background: var(--accent-primary-hover);
        }
        
        .btn-secondary {
            background: transparent;
            color: var(--text-secondary);
            border: 1px solid var(--border-medium);
        }
        
        .btn-secondary:hover {
            background: var(--bg-secondary);
        }
        
        /* Submit Button - Floating Action */
        .submit-fab {
            position: fixed;
            bottom: 2rem;
            right: 2rem;
            background: linear-gradient(135deg, var(--accent-secondary) 0%, #3d7a6a 100%);
            color: white;
            border: none;
            border-radius: 50px;
            padding: 1rem 1.5rem;
            font-family: var(--font-body);
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(45, 90, 74, 0.4);
            display: flex;
            align-items: center;
            gap: 0.5rem;
            transition: all var(--transition-normal);
            z-index: 50;
        }
        
        .submit-fab:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(45, 90, 74, 0.5);
        }
        
        .submit-fab svg {
            width: 20px;
            height: 20px;
        }
        
        @media (max-width: 640px) {
            .submit-fab {
                bottom: 1rem;
                right: 1rem;
                padding: 0.875rem 1.25rem;
                font-size: 0.875rem;
            }
        }
        
        /* Skip link for accessibility */
        .skip-link {
            position: absolute;
            top: -100%;
            left: 1rem;
            background: var(--accent-primary);
            color: white;
            padding: 0.5rem 1rem;
            border-radius: var(--radius-md);
            z-index: 1000;
            transition: top var(--transition-fast);
        }
        
        .skip-link:focus {
            top: 1rem;
        }
    </style>
</head>
<body>
    <a href="#main-content" class="skip-link">Skip to main content</a>
    
    <div class="app-container">
        <!-- Header -->
        <header class="app-header">
            <div class="header-brand">
                <div class="brand-icon">T</div>
                <span class="brand-text">Trovu</span>
            </div>
            
            <div class="header-context">
                <button class="map-btn" id="mapBtn" title="See where you are (M)" aria-label="View curriculum map">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <rect x="3" y="3" width="7" height="7"></rect>
                        <rect x="14" y="3" width="7" height="7"></rect>
                        <rect x="14" y="14" width="7" height="7"></rect>
                        <rect x="3" y="14" width="7" height="7"></rect>
                    </svg>
                </button>
                <span class="curriculum-code" id="curriculumCode">SCI5-6SU1</span>
                <span class="topic-title" id="topicTitle">Understanding Science</span>
            </div>
            
            <div class="header-actions">
                <button class="icon-btn theme-toggle" id="themeToggle" title="Toggle theme (T)" aria-label="Toggle dark/light theme">
                    <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                    <svg class="icon-moon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                </button>
                <button class="icon-btn" id="settingsBtn" title="Settings (S)" aria-label="Open settings">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <circle cx="12" cy="12" r="3"></circle>
                        <path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"></path>
                    </svg>
                </button>
            </div>
        </header>
        
        <!-- Navigation Strip -->
        <nav class="nav-strip" aria-label="Content navigation">
            <div class="nav-selectors">
                <div class="nav-selector">
                    <label for="modeSelect">Level</label>
                    <select id="modeSelect"></select>
                </div>
                <span class="nav-divider"></span>
                <div class="nav-selector" id="selector1Wrapper">
                    <label for="selector1" id="selector1Label">Type</label>
                    <select id="selector1"></select>
                </div>
                <div class="nav-selector" id="selector2Wrapper">
                    <label for="selector2" id="selector2Label">Subject</label>
                    <select id="selector2"></select>
                </div>
                <div class="nav-selector hidden" id="selector3Wrapper">
                    <label for="selector3" id="selector3Label">Focus</label>
                    <select id="selector3"></select>
                </div>
                <span class="nav-divider"></span>
                <div class="nav-selector" id="yearWrapper">
                    <label for="yearSelect" id="yearLabel">Year</label>
                    <select id="yearSelect"></select>
                </div>
                <div class="nav-selector" id="topicWrapper">
                    <label for="topicSelect">Topic</label>
                    <select id="topicSelect"></select>
                </div>
                <div class="nav-selector" id="topicNumWrapper">
                    <label for="topicNumSelect">#</label>
                    <select id="topicNumSelect"></select>
                </div>
                <span class="nav-divider"></span>
                <div class="nav-selector reading-level">
                    <label for="readingLevelSelect">Reading</label>
                    <select id="readingLevelSelect"></select>
                </div>
            </div>
        </nav>
        
        <!-- Main Content -->
        <main class="main-content" id="main-content">
            <div class="content-sections" id="contentSections">
                <!-- Sections rendered by JavaScript -->
            </div>
        </main>
        
        <!-- Progress Bar -->
        <div class="progress-bar">
            <div class="progress-item" id="progressArea">
                <span class="progress-label" id="progressAreaLabel">Science</span>
            </div>
            <span class="progress-arrow">â†’</span>
            <div class="progress-item" id="progressStrand">
                <span class="progress-label" id="progressStrandLabel">Understanding</span>
            </div>
            <span class="progress-arrow">â†’</span>
            <div class="progress-item" id="progressLevel">
                <span class="progress-label" id="progressLevelLabel">5-6</span>
            </div>
            <span class="progress-arrow">â†’</span>
            <div class="progress-item active" id="progressTopic">
                <span>Topic </span><span id="progressTopicNum">1</span>/5
            </div>
            <span class="progress-arrow">â†’</span>
            <div class="progress-item" id="progressReading">
                <span>Level </span><span id="progressReadingLabel">C</span>
            </div>
        </div>
    </div>
    
    <!-- Settings Panel -->
    <div class="settings-backdrop" id="settingsBackdrop"></div>
    <aside class="settings-panel" id="settingsPanel" aria-hidden="true">
        <div class="settings-header">
            <h2>Settings</h2>
            <button class="icon-btn" id="closeSettings" aria-label="Close settings">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="settings-body">
            <div class="settings-group">
                <h3>Display</h3>
                <div class="setting-row">
                    <span class="setting-label">Dark Mode</span>
                    <div class="toggle-switch" id="darkModeToggle" role="switch" aria-checked="false" tabindex="0"></div>
                </div>
                <div class="setting-row">
                    <span class="setting-label">Read Aloud</span>
                    <div class="toggle-switch" id="ttsToggle" role="switch" aria-checked="false" tabindex="0"></div>
                </div>
                <div class="setting-row">
                    <span class="setting-label">Animations</span>
                    <div class="toggle-switch active" id="animationsToggle" role="switch" aria-checked="true" tabindex="0"></div>
                </div>
            </div>
            <div class="settings-group">
                <h3>My Preferences</h3>
                <div class="setting-row">
                    <span class="setting-label">Default Reading Level</span>
                    <select id="defaultReadingSelect" style="padding: 0.5rem; border-radius: var(--radius-md); border: 1px solid var(--border-medium); background: var(--bg-secondary);">
                        <option value="A">Easier</option>
                        <option value="B">Building</option>
                        <option value="C" selected>Standard</option>
                        <option value="D">Challenge</option>
                        <option value="E">Expert</option>
                    </select>
                </div>
            </div>
            <div class="settings-group">
                <h3>Keyboard Shortcuts</h3>
                <div class="setting-row">
                    <span class="setting-label">Switch Theme</span>
                    <kbd>T</kbd>
                </div>
                <div class="setting-row">
                    <span class="setting-label">Open Settings</span>
                    <kbd>S</kbd>
                </div>
                <div class="setting-row">
                    <span class="setting-label">Open Map</span>
                    <kbd>M</kbd>
                </div>
                <div class="setting-row">
                    <span class="setting-label">Close Panel</span>
                    <kbd>Esc</kbd>
                </div>
                <div class="setting-row">
                    <span class="setting-label">Next Topic</span>
                    <kbd>â†’</kbd>
                </div>
                <div class="setting-row">
                    <span class="setting-label">Previous Topic</span>
                    <kbd>â†</kbd>
                </div>
            </div>
        </div>
    </aside>
    
    <!-- Map Panel -->
    <div class="map-backdrop" id="mapBackdrop"></div>
    <div class="map-panel" id="mapPanel" aria-hidden="true">
        <div class="map-header">
            <h2>You Are Here <span id="mapCode"></span></h2>
            <button class="icon-btn" id="closeMap" aria-label="Close map">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                    <line x1="18" y1="6" x2="6" y2="18"></line>
                    <line x1="6" y1="6" x2="18" y2="18"></line>
                </svg>
            </button>
        </div>
        <div class="map-body">
            <div class="map-breadcrumb" id="mapBreadcrumb"></div>
            <div class="map-stats" id="mapStats"></div>
            <div class="wireframe-container">
                <div class="wireframe-label">Curriculum Map</div>
                <div class="wireframe-grid" id="wireframeGrid"></div>
                <div class="wireframe-legend">
                    <div class="legend-item"><div class="legend-dot available"></div> Available</div>
                    <div class="legend-item"><div class="legend-dot current-area"></div> Your Subject</div>
                    <div class="legend-item"><div class="legend-dot current-strand"></div> Your Topic Area</div>
                    <div class="legend-item"><div class="legend-dot you-are-here"></div> You are here</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Submit Button (Floating Action) -->
    <button class="submit-fab" id="submitBtn" title="Submit responses to teacher">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
            <line x1="22" y1="2" x2="11" y2="13"></line>
            <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
        </svg>
        <span>Submit to Teacher</span>
    </button>
    
    <!-- Toast Container -->
    <div class="toast-container" id="toastContainer"></div>

    <script>
    // ============================================
    // DYNAMIC SELECT WIDTH
    // ============================================
    const measureCanvas = document.createElement('canvas');
    const measureCtx = measureCanvas.getContext('2d');
    
    function resizeSelectToContent(selectEl) {
        const selectedOption = selectEl.options[selectEl.selectedIndex];
        if (!selectedOption) return;
        
        const text = selectedOption.textContent;
        // Match the CSS: font-weight 500, font-size 0.9rem (â‰ˆ14.4px)
        measureCtx.font = "500 14.4px 'Barlow Condensed', sans-serif";
        const textWidth = measureCtx.measureText(text).width;
        
        // Add padding: 0.5rem left (8px) + 1.4rem right for arrow (22px) + 4px buffer
        const totalWidth = textWidth + 34;
        selectEl.style.width = Math.max(Math.ceil(totalWidth), 40) + 'px';
    }
    
    function resizeAllSelects() {
        document.querySelectorAll('.nav-selector select').forEach(resizeSelectToContent);
    }
    
    // ============================================
    // CURRICULUM DATA STRUCTURE
    // ============================================
    const curriculumData = {
        // ========== F-10 MODE ==========
        f10: {
            categories: {
                "Subjects": [
                    "English",
                    "Mathematics", 
                    "Science",
                    "Humanities",
                    "Health and Physical Education",
                    "The Arts",
                    "Technologies"
                ],
                "Skills": [
                    "Critical and Creative Thinking",
                    "Ethical Capability",
                    "Intercultural Capability",
                    "Personal and Social Capability"
                ]
            },
            
            areas: {
                "English": {
                    disciplines: {
                        "English": ["Language", "Literacy", "Literature"],
                        "EAL": ["Listening & Speaking", "Reading & Viewing", "Writing"]
                    }
                },
                "Mathematics": {
                    strands: ["Number", "Algebra", "Measurement", "Space", "Statistics", "Probability"]
                },
                "Science": {
                    strands: ["Understanding", "Inquiry", "Human Endeavour"]
                },
                "Humanities": {
                    disciplines: {
                        "Civics and Citizenship": ["Knowledge", "Skills"],
                        "Economics and Business": ["Knowledge", "Skills"],
                        "Geography": ["Knowledge", "Skills"],
                        "History": ["Concepts & Skills", "Knowledge"]
                    }
                },
                "Health and Physical Education": {
                    strands: ["Health", "Movement"]
                },
                "The Arts": {
                    disciplines: {
                        "Dance": ["Exploring", "Developing", "Creating", "Presenting"],
                        "Drama": ["Exploring", "Developing", "Creating", "Presenting"],
                        "Media Arts": ["Exploring", "Developing", "Creating", "Presenting"],
                        "Music": ["Exploring", "Developing", "Creating", "Presenting"],
                        "Visual Arts": ["Exploring", "Developing", "Creating", "Presenting"],
                        "VCD": ["Exploring", "Developing", "Creating", "Presenting"]
                    }
                },
                "Technologies": {
                    disciplines: {
                        "Design and Technologies": ["Society", "Contexts", "Solutions"],
                        "Digital Technologies": ["Systems", "Data & Privacy", "Solutions"]
                    }
                },
                "Critical and Creative Thinking": {
                    strands: ["Questions", "Reasoning", "Metacognition"]
                },
                "Ethical Capability": {
                    strands: ["Concepts", "Actions"]
                },
                "Intercultural Capability": {
                    strands: ["Diversity", "Identity"]
                },
                "Personal and Social Capability": {
                    strands: ["Self", "Social"]
                }
            },
            
            levels: [
                { id: "foundation", label: "Prep" },
                { id: "1-2", label: "1-2" },
                { id: "3-4", label: "3-4" },
                { id: "5-6", label: "5-6" },
                { id: "7-8", label: "7-8" },
                { id: "9-10", label: "9-10" }
            ]
        },
        
        // ========== VCE MODE ==========
        vce: {
            domains: {
                "English": ["English", "English Language", "Literature", "EAL"],
                "Mathematics": ["Foundation Maths", "General Maths", "Maths Methods", "Specialist Maths"],
                "Sciences": ["Biology", "Chemistry", "Physics", "Psychology", "Environmental Science"],
                "Humanities": ["History", "Geography", "Politics", "Philosophy", "Sociology", "Legal Studies", "Economics", "Accounting", "Business"],
                "The Arts": ["Art Making", "Art Creative Practice", "Dance", "Drama", "Media", "Music", "Theatre Studies", "VCD"],
                "Technologies": ["Applied Computing", "Food Studies", "Product Design", "Systems Engineering"],
                "Health & PE": ["Health & Human Development", "Physical Education", "Outdoor & Environmental Studies"],
                "Languages": ["French", "German", "Italian", "Japanese", "Chinese", "Indonesian", "Greek", "Vietnamese", "Other LOTE"]
            },
            
            units: [
                { id: "1", label: "1" },
                { id: "2", label: "2" },
                { id: "3", label: "3" },
                { id: "4", label: "4" }
            ],
            
            // Areas of study vary by subject, so we'll use generic placeholders
            areasOfStudy: [
                { id: "aos1", label: "AOS 1" },
                { id: "aos2", label: "AOS 2" },
                { id: "aos3", label: "AOS 3" }
            ]
        },
        
        // ========== UNIVERSITY MODE ==========
        university: {
            faculties: {
                "Science": ["Biology", "Chemistry", "Physics", "Mathematics", "Computer Science", "Environmental Science", "Data Science"],
                "Arts": ["History", "Philosophy", "Literature", "Languages", "Media & Comms", "Sociology", "Politics"],
                "Business": ["Accounting", "Finance", "Management", "Marketing", "Economics", "Business Analytics"],
                "Engineering": ["Civil", "Mechanical", "Electrical", "Software", "Chemical", "Biomedical"],
                "Health": ["Nursing", "Medicine", "Public Health", "Psychology", "Physiotherapy"],
                "Education": ["Primary", "Secondary", "Early Childhood", "Special Education"],
                "Law": ["Constitutional", "Criminal", "Commercial", "International"],
                "Design": ["Architecture", "Industrial Design", "Graphic Design", "Urban Planning"]
            },
            
            semesters: [
                { id: "1", label: "1" },
                { id: "2", label: "2" }
            ],
            
            weeks: [
                { id: "1", label: "1" },
                { id: "2", label: "2" },
                { id: "3", label: "3" },
                { id: "4", label: "4" },
                { id: "5", label: "5" },
                { id: "6", label: "6" },
                { id: "7", label: "7" },
                { id: "8", label: "8" },
                { id: "9", label: "9" },
                { id: "10", label: "10" },
                { id: "11", label: "11" },
                { id: "12", label: "12" }
            ],
            
            levels: [
                { id: "intro", label: "Intro" },
                { id: "mid", label: "Intermediate" },
                { id: "adv", label: "Advanced" }
            ]
        },
        
        // ========== SHARED ==========
        modes: [
            { id: "f10", label: "F-10" },
            { id: "vce", label: "VCE" },
            { id: "university", label: "Uni" }
        ],
        
        readingLevels: [
            { id: "A", label: "Easier", description: "Simple words and short sentences" },
            { id: "B", label: "Building", description: "Building up vocabulary" },
            { id: "C", label: "Standard", description: "Right for your year level" },
            { id: "D", label: "Challenge", description: "More complex ideas" },
            { id: "E", label: "Expert", description: "Advanced vocabulary and concepts" }
        ]
    };
    
    // ============================================
    // SAMPLE PLACEHOLDER JSON - STUDENT FRIENDLY
    // ============================================
    function generatePlaceholderJSON(state) {
        let metadata = {};
        
        // Get topic title from available topics
        const currentTopic = availableTopics.find(t => t.id === state.topicId);
        const topicTitle = currentTopic?.title || state.topicId || 'Placeholder Topic';
        
        switch (state.mode) {
            case 'f10':
                metadata = {
                    mode: 'f10',
                    subject: state.area,
                    topicId: state.topicId,
                    focusArea: state.discipline || null,
                    yearLevel: state.level,
                    topicNumber: state.topicNum,
                    topicTitle: `${topicTitle} - Part ${state.topicNum}`,
                    curriculumCode: generateF10Code(state),
                    version: "1.0",
                    lastUpdated: new Date().toISOString().split('T')[0],
                    status: "placeholder"
                };
                break;
            case 'vce':
                metadata = {
                    mode: 'vce',
                    domain: state.vceDomain,
                    study: state.vceStudy,
                    unit: state.vceUnit,
                    topicId: state.topicId,
                    topicNumber: state.topicNum,
                    topicTitle: `${state.vceStudy} U${state.vceUnit}: ${topicTitle} - Part ${state.topicNum}`,
                    curriculumCode: generateVCECode(state),
                    version: "1.0",
                    lastUpdated: new Date().toISOString().split('T')[0],
                    status: "placeholder"
                };
                break;
            case 'university':
                metadata = {
                    mode: 'university',
                    faculty: state.uniFaculty,
                    course: state.uniCourse,
                    level: state.uniLevel,
                    semester: state.uniSemester,
                    week: state.uniWeek,
                    topicId: state.topicId,
                    topicNumber: state.topicNum,
                    topicTitle: `${state.uniCourse} S${state.uniSemester}W${state.uniWeek}: ${topicTitle} - Part ${state.topicNum}`,
                    curriculumCode: generateUniCode(state),
                    version: "1.0",
                    lastUpdated: new Date().toISOString().split('T')[0],
                    status: "placeholder"
                };
                break;
        }
        
        return {
            metadata: metadata,
            readingLevels: {
                A: generateReadingLevelContent("A", state),
                B: generateReadingLevelContent("B", state),
                C: generateReadingLevelContent("C", state),
                D: generateReadingLevelContent("D", state),
                E: generateReadingLevelContent("E", state)
            }
        };
    }
    
    function generateF10Code(state) {
        const areaCode = getAreaCode(state.area);
        const levelCode = state.level.toUpperCase().replace('-', '');
        const topicCode = state.topicId ? state.topicId.substring(0, 3).toUpperCase() : 'XXX';
        return `${areaCode}${levelCode}${topicCode}${state.topicNum}`;
    }
    
    function generateVCECode(state) {
        const studyCode = state.vceStudy.substring(0, 3).toUpperCase();
        const topicCode = state.topicId ? state.topicId.substring(0, 3).toUpperCase() : 'XXX';
        return `VCE${studyCode}U${state.vceUnit}${topicCode}T${state.topicNum}`;
    }
    
    function generateUniCode(state) {
        const courseCode = state.uniCourse.substring(0, 3).toUpperCase();
        const levelCode = state.uniLevel.substring(0, 1).toUpperCase();
        const topicCode = state.topicId ? state.topicId.substring(0, 3).toUpperCase() : 'XXX';
        return `UNI${courseCode}${levelCode}S${state.uniSemester}W${state.uniWeek}${topicCode}T${state.topicNum}`;
    }
    
    function generateReadingLevelContent(level, state) {
        const levelDescriptions = {
            A: { name: "Easier", style: "simple, everyday words" },
            B: { name: "Building", style: "building vocabulary" },
            C: { name: "Standard", style: "year-level appropriate" },
            D: { name: "Challenge", style: "more complex" },
            E: { name: "Expert", style: "advanced" }
        };
        
        const desc = levelDescriptions[level];
        
        // Get topic title from available topics
        const currentTopic = availableTopics.find(t => t.id === state.topicId);
        const topicTitle = currentTopic?.title || state.topicId || 'this topic';
        
        // Get context-appropriate labels based on mode
        let topicContext = '';
        let levelContext = '';
        
        switch (state.mode) {
            case 'f10':
                topicContext = topicTitle.toLowerCase();
                levelContext = `year level ${state.level}`;
                break;
            case 'vce':
                topicContext = `${state.vceStudy} Unit ${state.vceUnit}: ${topicTitle}`;
                levelContext = 'VCE level';
                break;
            case 'university':
                topicContext = `${state.uniCourse}: ${topicTitle}`;
                levelContext = `${state.uniLevel} university level`;
                break;
            default:
                topicContext = 'this topic';
                levelContext = 'this level';
        }
        
        return {
            myLearningGoals: {
                overview: `In this topic, you'll learn about ${topicContext}. The words used here are ${desc.style}.`,
                whatImLearning: [
                    `I am learning to identify key ideas in ${topicContext}`,
                    "I am learning how these ideas connect to the real world",
                    "I am learning to explain what I understand using the right words"
                ],
                howIllKnowIveGotIt: [
                    {
                        goal: "I can name and describe the main ideas",
                        whatThatLooksLike: "I can list at least three important terms and say what they mean"
                    },
                    {
                        goal: "I can explain ideas in my own words",
                        whatThatLooksLike: "I can describe the main ideas without just copying"
                    },
                    {
                        goal: "I can use what I've learned in new situations",
                        whatThatLooksLike: "I can give an example from everyday life that shows I understand"
                    }
                ]
            },
            learnAboutIt: {
                introduction: `Welcome to this topic about ${topicContext}! Here you'll discover important ideas that help you understand the world around you.`,
                bigIdeas: [
                    `Big idea 1: The basics of ${topicContext}`,
                    "Big idea 2: How this connects to what you already know",
                    "Big idea 3: Where you see this in real life",
                    "Big idea 4: Patterns and connections"
                ],
                importantWords: [
                    {
                        word: "Concept",
                        howToSayIt: "KON-sept",
                        whatItMeans: "An idea or understanding about something"
                    },
                    {
                        word: "Application",
                        howToSayIt: "ap-li-KAY-shun",
                        whatItMeans: "Using what you know in a real situation"
                    },
                    {
                        word: "Analysis",
                        howToSayIt: "a-NAL-i-sis",
                        whatItMeans: "Looking closely at something to understand it better"
                    }
                ],
                mainExplanation: `In this ${topicContext} topic, we explore how things work and why they matter. At ${levelContext}, you'll build on what you already know and develop deeper understanding. These ideas connect to everyday life and help explain the world around us.`
            },
            seeItInAction: {
                title: `${topicContext} in the Real World`,
                story: `Imagine you're exploring a real-world example of ${topicContext}. This helps you see how what you learn connects to life outside school.`,
                thingsToNotice: [
                    "What patterns can you spot?",
                    "How does this connect to what you're learning?",
                    "What questions do you have?"
                ],
                thinkAbout: [
                    "What ideas from your learning can you find in this example?",
                    "How would you explain what's happening to a friend?",
                    "What do you think might happen next?"
                ],
                whyItMatters: "Understanding these ideas helps people in many different careers solve problems and make good decisions."
            },
            checkYourUnderstanding: {
                quickRecall: [
                    {
                        id: "recall_mc_01",
                        type: "multipleChoice",
                        question: `Which of these is a main idea in ${topicContext}?`,
                        choices: [
                            { id: "A", text: "Correct answer placeholder", isCorrect: true, feedback: "That's right! This is one of the main ideas." },
                            { id: "B", text: "Not quite right", isCorrect: false, feedback: "Have another think about what makes this topic special." },
                            { id: "C", text: "This one's a trick", isCorrect: false, feedback: "This is actually about something different. Check your notes." },
                            { id: "D", text: "Close but not quite", isCorrect: false, feedback: "This is a common mix-up. Think about the main ideas again." }
                        ],
                        helpText: "This checks if you remember the main ideas from this topic."
                    }
                ],
                explainIt: [
                    {
                        id: "explain_sa_01",
                        type: "shortAnswer",
                        question: "In your own words, explain the main idea from this topic.",
                        greatAnswerLooksLike: "A great answer shows you understand the main idea and can give an example.",
                        thingsToInclude: ["Name the main idea", "Use the right words", "Give an example"]
                    }
                ],
                useIt: [
                    {
                        id: "use_sa_01",
                        type: "shortAnswer",
                        question: "How would you use this idea in a new situation?",
                        greatAnswerLooksLike: "Describe a situation and explain how this idea helps you understand it.",
                        thingsToInclude: ["Describe a situation", "Apply the idea correctly", "Explain the connection"]
                    }
                ]
            },
            showWhatYouKnow: {
                oneIdea: {
                    id: "show_one_01",
                    task: "Name one main idea from this topic.",
                    exampleAnswer: {
                        answer: "One main idea is [idea name].",
                        whatMakesItGood: ["Names a relevant idea", "Uses correct words"]
                    }
                },
                severalIdeas: {
                    id: "show_several_01",
                    task: "List several main ideas and explain what each one means.",
                    exampleAnswer: {
                        answer: "Main ideas include: [idea 1] which means..., [idea 2] which involves..., and [idea 3] which describes...",
                        whatMakesItGood: ["Lists multiple ideas", "Explains each one", "Uses the right vocabulary"]
                    }
                },
                connectedIdeas: {
                    id: "show_connected_01",
                    task: "Explain how the main ideas connect to each other and to real life.",
                    exampleAnswer: {
                        answer: "These ideas are connected because... This relates to real life by...",
                        whatMakesItGood: ["Shows how ideas connect", "Links to real-world examples", "Shows deep understanding"]
                    }
                }
            },
            thinkAboutYourLearning: {
                questions: [
                    "What was the most interesting thing you learned?",
                    "What questions do you still have?",
                    "How might you use this in your own life?"
                ],
                rateYourself: [
                    { statement: "I can identify the main ideas", linkedTo: "goal_01" },
                    { statement: "I can explain ideas in my own words", linkedTo: "goal_02" },
                    { statement: "I can use these ideas in new situations", linkedTo: "goal_03" }
                ],
                myNextSteps: [
                    "What would you like to learn more about?",
                    "What skill do you want to get better at?"
                ]
            }
        };
    }
    
    function getAreaCode(area) {
        const codes = {
            "English": "ENG",
            "Mathematics": "MAT",
            "Science": "SCI",
            "Humanities": "HUM",
            "Health and Physical Education": "HPE",
            "The Arts": "ART",
            "Technologies": "TEC",
            "Critical and Creative Thinking": "CCT",
            "Ethical Capability": "ETH",
            "Intercultural Capability": "INC",
            "Personal and Social Capability": "PSC"
        };
        return codes[area] || area.substring(0, 3).toUpperCase();
    }
    
    function getStrandCode(strand) {
        return strand.split(' ')
            .map(w => w[0])
            .join('')
            .substring(0, 2)
            .toUpperCase();
    }
    
    // ============================================
    // APPLICATION STATE
    // ============================================
    let state = {
        mode: "f10",  // f10, vce, university
        
        // F-10 specific
        category: "Subjects",
        area: "Health and Physical Education",
        discipline: null,
        strand: null,           // Now optional filter, not required
        level: "7-8",
        topicId: null,          // Selected topic ID from manifest
        topicNum: 1,            // Topic number within the selected topic
        
        // VCE specific
        vceDomain: "Sciences",
        vceStudy: "Biology",
        vceUnit: "1",
        vceAOS: "aos1",
        vceTopicId: null,
        vceTopicNum: 1,
        
        // University specific
        uniFaculty: "Science",
        uniCourse: "Biology",
        uniSemester: "1",
        uniWeek: "1",
        uniLevel: "intro",
        uniTopicId: null,
        uniTopicNum: 1,
        
        // Shared
        readingLevel: "C",
        expandedSections: ["whatYouWillLearn"],
        theme: "light"
    };
    
    let loadedContent = null;
    let loadedManifest = null;  // Current manifest
    let availableTopics = [];   // Filtered topics for current selection
    let undoStack = [];
    let redoStack = [];
    
    // ============================================
    // DOM ELEMENTS
    // ============================================
    const elements = {
        modeSelect: document.getElementById('modeSelect'),
        selector1Wrapper: document.getElementById('selector1Wrapper'),
        selector1Label: document.getElementById('selector1Label'),
        selector1: document.getElementById('selector1'),
        selector2Wrapper: document.getElementById('selector2Wrapper'),
        selector2Label: document.getElementById('selector2Label'),
        selector2: document.getElementById('selector2'),
        selector3Wrapper: document.getElementById('selector3Wrapper'),
        selector3Label: document.getElementById('selector3Label'),
        selector3: document.getElementById('selector3'),
        yearWrapper: document.getElementById('yearWrapper'),
        yearLabel: document.getElementById('yearLabel'),
        yearSelect: document.getElementById('yearSelect'),
        topicWrapper: document.getElementById('topicWrapper'),
        topicSelect: document.getElementById('topicSelect'),
        topicNumWrapper: document.getElementById('topicNumWrapper'),
        topicNumSelect: document.getElementById('topicNumSelect'),
        readingLevelSelect: document.getElementById('readingLevelSelect'),
        contentSections: document.getElementById('contentSections'),
        curriculumCode: document.getElementById('curriculumCode'),
        topicTitle: document.getElementById('topicTitle'),
        themeToggle: document.getElementById('themeToggle'),
        settingsBtn: document.getElementById('settingsBtn'),
        settingsPanel: document.getElementById('settingsPanel'),
        settingsBackdrop: document.getElementById('settingsBackdrop'),
        closeSettings: document.getElementById('closeSettings'),
        darkModeToggle: document.getElementById('darkModeToggle'),
        toastContainer: document.getElementById('toastContainer'),
        mapBtn: document.getElementById('mapBtn'),
        mapPanel: document.getElementById('mapPanel'),
        mapBackdrop: document.getElementById('mapBackdrop'),
        closeMap: document.getElementById('closeMap'),
        mapCode: document.getElementById('mapCode'),
        mapBreadcrumb: document.getElementById('mapBreadcrumb'),
        mapStats: document.getElementById('mapStats'),
        wireframeGrid: document.getElementById('wireframeGrid'),
        progressAreaLabel: document.getElementById('progressAreaLabel'),
        progressStrandLabel: document.getElementById('progressStrandLabel'),
        progressLevelLabel: document.getElementById('progressLevelLabel'),
        progressTopicNum: document.getElementById('progressTopicNum'),
        progressReadingLabel: document.getElementById('progressReadingLabel')
    };
    
    // ============================================
    // INITIALIZATION
    // ============================================
    function init() {
        loadState();
        populateSelectors();
        loadContent();
        setupEventListeners();
        applyTheme();
        
        // Wait for fonts to load before measuring
        if (document.fonts && document.fonts.ready) {
            document.fonts.ready.then(resizeAllSelects);
        } else {
            setTimeout(resizeAllSelects, 100);
        }
    }
    
    function loadState() {
        const saved = localStorage.getItem('trovuState_v1');
        if (saved) {
            try {
                const parsed = JSON.parse(saved);
                state = { ...state, ...parsed };
            } catch (e) {
                console.warn('Failed to load saved state:', e);
            }
        }
    }
    
    function saveState() {
        localStorage.setItem('trovuState_v1', JSON.stringify(state));
    }
    
    function pushUndoState() {
        undoStack.push(JSON.stringify(state));
        if (undoStack.length > 100) undoStack.shift();
        redoStack = [];
    }
    
    // ============================================
    // SELECTOR POPULATION
    // ============================================
    function populateSelectors() {
        populateModeSelect();
        populateReadingLevelSelect();
        configureForMode();
    }
    
    function populateModeSelect() {
        elements.modeSelect.innerHTML = '';
        curriculumData.modes.forEach(mode => {
            const option = document.createElement('option');
            option.value = mode.id;
            option.textContent = mode.label;
            option.selected = mode.id === state.mode;
            elements.modeSelect.appendChild(option);
        });
    }
    
    function configureForMode() {
        switch (state.mode) {
            case 'f10':
                configureF10Mode();
                break;
            case 'vce':
                configureVCEMode();
                break;
            case 'university':
                configureUniversityMode();
                break;
        }
    }
    
    // ========== F-10 MODE ==========
    async function configureF10Mode() {
        // Show F-10 selectors, hide others
        elements.selector1Wrapper.classList.remove('hidden');
        elements.selector2Wrapper.classList.remove('hidden');
        elements.yearWrapper.classList.remove('hidden');
        elements.topicWrapper.classList.remove('hidden');
        elements.topicNumWrapper.classList.remove('hidden');
        
        // Set labels
        elements.selector1Label.textContent = 'Type';
        elements.selector2Label.textContent = 'Subject';
        elements.selector3Label.textContent = 'Focus';
        elements.yearLabel.textContent = 'Year';
        
        // Populate static selectors
        populateF10Category();
        populateF10Area();
        populateF10Discipline();
        populateF10Level();
        
        // Fetch manifest and populate topics
        await fetchAndPopulateTopics();
    }
    
    function populateF10Category() {
        elements.selector1.innerHTML = '';
        Object.keys(curriculumData.f10.categories).forEach(cat => {
            const option = document.createElement('option');
            option.value = cat;
            option.textContent = cat;
            option.selected = cat === state.category;
            elements.selector1.appendChild(option);
        });
    }
    
    function populateF10Area() {
        elements.selector2.innerHTML = '';
        const areas = curriculumData.f10.categories[state.category] || [];
        areas.forEach(area => {
            const option = document.createElement('option');
            option.value = area;
            option.textContent = area;
            option.selected = area === state.area;
            elements.selector2.appendChild(option);
        });
        
        if (!areas.includes(state.area)) {
            state.area = areas[0];
            elements.selector2.value = state.area;
        }
    }
    
    function populateF10Discipline() {
        const areaData = curriculumData.f10.areas[state.area];
        
        if (areaData && areaData.disciplines) {
            elements.selector3Wrapper.classList.remove('hidden');
            elements.selector3.innerHTML = '';
            
            const disciplines = Object.keys(areaData.disciplines);
            disciplines.forEach(disc => {
                const option = document.createElement('option');
                option.value = disc;
                option.textContent = disc;
                option.selected = disc === state.discipline;
                elements.selector3.appendChild(option);
            });
            
            if (!disciplines.includes(state.discipline)) {
                state.discipline = disciplines[0];
                elements.selector3.value = state.discipline;
            }
        } else {
            elements.selector3Wrapper.classList.add('hidden');
            state.discipline = null;
        }
    }
    
    function populateF10Level() {
        elements.yearSelect.innerHTML = '';
        curriculumData.f10.levels.forEach(level => {
            const option = document.createElement('option');
            option.value = level.id;
            option.textContent = level.label;
            option.selected = level.id === state.level;
            elements.yearSelect.appendChild(option);
        });
    }
    
    // ========== VCE MODE ==========
    async function configureVCEMode() {
        // Show VCE selectors
        elements.selector1Wrapper.classList.remove('hidden');
        elements.selector2Wrapper.classList.remove('hidden');
        elements.selector3Wrapper.classList.add('hidden');
        elements.yearWrapper.classList.remove('hidden');
        elements.topicWrapper.classList.remove('hidden');
        elements.topicNumWrapper.classList.remove('hidden');
        
        // Set labels for VCE
        elements.selector1Label.textContent = 'Domain';
        elements.selector2Label.textContent = 'Study';
        elements.yearLabel.textContent = 'Unit';
        
        // Populate
        populateVCEDomain();
        populateVCEStudy();
        populateVCEUnit();
        
        // Fetch manifest and populate topics
        await fetchAndPopulateTopics();
    }
    
    function populateVCEDomain() {
        elements.selector1.innerHTML = '';
        Object.keys(curriculumData.vce.domains).forEach(domain => {
            const option = document.createElement('option');
            option.value = domain;
            option.textContent = domain;
            option.selected = domain === state.vceDomain;
            elements.selector1.appendChild(option);
        });
    }
    
    function populateVCEStudy() {
        elements.selector2.innerHTML = '';
        const studies = curriculumData.vce.domains[state.vceDomain] || [];
        studies.forEach(study => {
            const option = document.createElement('option');
            option.value = study;
            option.textContent = study;
            option.selected = study === state.vceStudy;
            elements.selector2.appendChild(option);
        });
        
        if (!studies.includes(state.vceStudy)) {
            state.vceStudy = studies[0];
            elements.selector2.value = state.vceStudy;
        }
    }
    
    function populateVCEUnit() {
        elements.yearSelect.innerHTML = '';
        curriculumData.vce.units.forEach(unit => {
            const option = document.createElement('option');
            option.value = unit.id;
            option.textContent = unit.label;
            option.selected = unit.id === state.vceUnit;
            elements.yearSelect.appendChild(option);
        });
    }
    
    // ========== UNIVERSITY MODE ==========
    async function configureUniversityMode() {
        // Show University selectors
        elements.selector1Wrapper.classList.remove('hidden');
        elements.selector2Wrapper.classList.remove('hidden');
        elements.selector3Wrapper.classList.remove('hidden');
        elements.yearWrapper.classList.remove('hidden');
        elements.topicWrapper.classList.remove('hidden');
        elements.topicNumWrapper.classList.remove('hidden');
        
        // Set labels for University
        elements.selector1Label.textContent = 'Faculty';
        elements.selector2Label.textContent = 'Course';
        elements.selector3Label.textContent = 'Level';
        elements.yearLabel.textContent = 'Sem/Wk';
        
        // Populate
        populateUniFaculty();
        populateUniCourse();
        populateUniLevel();
        populateUniSemesterWeek();
        
        // Fetch manifest and populate topics
        await fetchAndPopulateTopics();
    }
    
    function populateUniFaculty() {
        elements.selector1.innerHTML = '';
        Object.keys(curriculumData.university.faculties).forEach(faculty => {
            const option = document.createElement('option');
            option.value = faculty;
            option.textContent = faculty;
            option.selected = faculty === state.uniFaculty;
            elements.selector1.appendChild(option);
        });
    }
    
    function populateUniCourse() {
        elements.selector2.innerHTML = '';
        const courses = curriculumData.university.faculties[state.uniFaculty] || [];
        courses.forEach(course => {
            const option = document.createElement('option');
            option.value = course;
            option.textContent = course;
            option.selected = course === state.uniCourse;
            elements.selector2.appendChild(option);
        });
        
        if (!courses.includes(state.uniCourse)) {
            state.uniCourse = courses[0];
            elements.selector2.value = state.uniCourse;
        }
    }
    
    function populateUniLevel() {
        elements.selector3.innerHTML = '';
        curriculumData.university.levels.forEach(level => {
            const option = document.createElement('option');
            option.value = level.id;
            option.textContent = level.label;
            option.selected = level.id === state.uniLevel;
            elements.selector3.appendChild(option);
        });
    }
    
    function populateUniSemesterWeek() {
        elements.yearSelect.innerHTML = '';
        // Combine semester and week into single selector for simplicity
        curriculumData.university.semesters.forEach(sem => {
            curriculumData.university.weeks.forEach(week => {
                const option = document.createElement('option');
                option.value = `${sem.id}-${week.id}`;
                option.textContent = `S${sem.id}W${week.id}`;
                option.selected = sem.id === state.uniSemester && week.id === state.uniWeek;
                elements.yearSelect.appendChild(option);
            });
        });
    }
    
    // ========== MANIFEST-BASED TOPIC POPULATION ==========
    async function fetchAndPopulateTopics() {
        const manifestPath = buildManifestPath();
        console.log('Fetching manifest:', manifestPath);
        
        try {
            const response = await fetch(manifestPath);
            if (!response.ok) {
                throw new Error(`Manifest not found: ${manifestPath}`);
            }
            loadedManifest = await response.json();
            console.log('Loaded manifest:', loadedManifest.learningArea, '- Topics:', loadedManifest.topics?.length);
        } catch (error) {
            console.warn('Manifest not available, using empty topic list:', error.message);
            loadedManifest = null;
        }
        
        filterAndPopulateTopics();
        populateTopicNumbers();
    }
    
    function buildManifestPath() {
        switch (state.mode) {
            case 'f10':
                const area = state.area.toLowerCase()
                    .replace(/health and physical education/i, 'hpe')
                    .replace(/ and /g, '-')
                    .replace(/ /g, '-');
                return `./data/${area}/manifest.json`;
            case 'vce':
                const domain = state.vceDomain.toLowerCase().replace(/ and /g, '-').replace(/ /g, '-');
                return `./data/${domain}/manifest.json`;
            case 'university':
                const faculty = state.uniFaculty.toLowerCase().replace(/ and /g, '-').replace(/ /g, '-');
                return `./data/${faculty}/manifest.json`;
            default:
                return null;
        }
    }
    
    function filterAndPopulateTopics() {
        elements.topicSelect.innerHTML = '';
        availableTopics = [];
        
        if (!loadedManifest || !loadedManifest.topics) {
            // No manifest - show placeholder option
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'â€” No topics yet â€”';
            option.disabled = true;
            option.selected = true;
            elements.topicSelect.appendChild(option);
            state.topicId = null;
            return;
        }
        
        // Filter topics based on current selection
        let filtered = loadedManifest.topics;
        
        if (state.mode === 'f10') {
            // Filter by level
            filtered = filtered.filter(t => t.levels && t.levels.includes(state.level));
            // Optionally filter by strand if discipline selected
            if (state.strand) {
                const strandFiltered = filtered.filter(t => t.strand === state.strand);
                if (strandFiltered.length > 0) {
                    filtered = strandFiltered;
                }
            }
        } else if (state.mode === 'vce') {
            // Filter by unit
            filtered = filtered.filter(t => t.units && t.units.includes(state.vceUnit));
        } else if (state.mode === 'university') {
            // Filter by level and semester
            filtered = filtered.filter(t => 
                (!t.levels || t.levels.includes(state.uniLevel)) &&
                (!t.semesters || t.semesters.includes(state.uniSemester))
            );
        }
        
        availableTopics = filtered;
        
        if (filtered.length === 0) {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'â€” No topics for selection â€”';
            option.disabled = true;
            option.selected = true;
            elements.topicSelect.appendChild(option);
            state.topicId = null;
            return;
        }
        
        // Populate dropdown with filtered topics
        filtered.forEach(topic => {
            const option = document.createElement('option');
            option.value = topic.id;
            option.textContent = topic.title;
            option.selected = topic.id === state.topicId;
            elements.topicSelect.appendChild(option);
        });
        
        // If current selection not in filtered list, select first
        if (!filtered.find(t => t.id === state.topicId)) {
            state.topicId = filtered[0].id;
            elements.topicSelect.value = state.topicId;
        }
    }
    
    function populateTopicNumbers() {
        elements.topicNumSelect.innerHTML = '';
        
        // Find current topic in manifest to get topic count
        let topicCount = 5; // Default
        if (loadedManifest && state.topicId) {
            const currentTopic = loadedManifest.topics.find(t => t.id === state.topicId);
            if (currentTopic && currentTopic.topicCount) {
                topicCount = currentTopic.topicCount;
            }
        }
        
        for (let i = 1; i <= topicCount; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = i;
            option.selected = i === state.topicNum;
            elements.topicNumSelect.appendChild(option);
        }
        
        // Reset to 1 if current selection exceeds available
        if (state.topicNum > topicCount) {
            state.topicNum = 1;
            elements.topicNumSelect.value = 1;
        }
    }
    
    function clearTopicSelection() {
        state.topicId = null;
        state.topicNum = 1;
        availableTopics = [];
        elements.topicSelect.innerHTML = '<option value="" disabled selected>â€” Select â€”</option>';
        elements.topicNumSelect.innerHTML = '<option value="1" selected>1</option>';
    }
    
    // ========== SHARED ==========
    function populateReadingLevelSelect() {
        elements.readingLevelSelect.innerHTML = '';
        curriculumData.readingLevels.forEach(rl => {
            const option = document.createElement('option');
            option.value = rl.id;
            option.textContent = rl.label;
            option.selected = rl.id === state.readingLevel;
            elements.readingLevelSelect.appendChild(option);
        });
    }
    
    // ============================================
    // CONTENT LOADING & RENDERING
    // ============================================
    async function loadContent() {
        // Check if we have a valid topic selected
        if (!state.topicId) {
            console.log('No topic selected yet');
            loadedContent = null;
            renderNoTopicSelected();
            updateProgressBar();
            return;
        }
        
        showLoadingSpinner();
        
        try {
            const filePath = buildFilePath();
            console.log('Fetching:', filePath);
            
            if (!filePath) {
                throw new Error('Could not build file path');
            }
            
            const response = await fetch(filePath);
            if (!response.ok) {
                throw new Error(`File not found: ${filePath}`);
            }
            loadedContent = await response.json();
            console.log('Loaded live content:', loadedContent.metadata?.topicTitle);
        } catch (error) {
            console.warn('Falling back to placeholder:', error.message);
            loadedContent = generatePlaceholderJSON(state);
        }
        
        hideLoadingSpinner();
        renderContent();
        updateHeader();
        updateProgressBar();
        saveState();
        
        // Restore any saved responses for this topic
        setTimeout(restoreResponses, 100);
    }
    
    function renderNoTopicSelected() {
        elements.contentSections.innerHTML = `
            <div class="no-topic-state">
                <div class="no-topic-icon">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5">
                        <path d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25"/>
                    </svg>
                </div>
                <h3>Select a Topic to Begin</h3>
                <p>Choose a topic from the dropdown above to start learning.</p>
                ${!loadedManifest ? '<p class="no-topic-hint">No content available yet for this subject and year level.</p>' : ''}
            </div>
        `;
        
        elements.curriculumCode.textContent = 'â€”';
        elements.topicTitle.textContent = 'Select a topic';
    }
    
    function buildFilePath() {
        // Check if we have a valid topic selected
        if (!state.topicId) {
            console.warn('No topic selected, cannot build file path');
            return null;
        }
        
        switch (state.mode) {
            case 'f10':
                return buildF10FilePath();
            case 'vce':
                return buildVCEFilePath();
            case 'university':
                return buildUniversityFilePath();
            default:
                return null;
        }
    }
    
    function buildF10FilePath() {
        // Transform area name to directory-friendly format
        let area = state.area.toLowerCase()
            .replace(/health and physical education/i, 'hpe')
            .replace(/ and /g, '-')
            .replace(/ /g, '-');
        
        const level = state.level.toLowerCase();
        const filename = `${area}_${state.topicId}_${level}_topic-${state.topicNum}.json`;
        return `./data/${area}/${filename}`;
    }
    
    function buildVCEFilePath() {
        const domain = state.vceDomain.toLowerCase().replace(/ and /g, '-').replace(/ /g, '-');
        const study = state.vceStudy.toLowerCase().replace(/ and /g, '-').replace(/ /g, '-');
        const filename = `${study}_${state.topicId}_unit-${state.vceUnit}_topic-${state.topicNum}.json`;
        return `./data/${domain}/${filename}`;
    }
    
    function buildUniversityFilePath() {
        const faculty = state.uniFaculty.toLowerCase().replace(/ and /g, '-').replace(/ /g, '-');
        const course = state.uniCourse.toLowerCase().replace(/ and /g, '-').replace(/ /g, '-');
        const level = state.uniLevel.toLowerCase();
        const filename = `${course}_${state.topicId}_${level}_sem-${state.uniSemester}-week-${state.uniWeek}_topic-${state.topicNum}.json`;
        return `./data/${faculty}/${filename}`;
    }
    
    function showLoadingSpinner() {
        if (elements.contentSections) {
            elements.contentSections.classList.add('loading');
        }
    }
    
    function hideLoadingSpinner() {
        if (elements.contentSections) {
            elements.contentSections.classList.remove('loading');
        }
    }
    
    function updateHeader() {
        elements.curriculumCode.textContent = loadedContent.metadata.curriculumCode;
        elements.topicTitle.textContent = loadedContent.metadata.topicTitle;
    }
    
    function updateProgressBar() {
        let areaLabel, strandLabel, levelLabel, topicLabel;
        
        // Get current topic title
        const currentTopic = availableTopics.find(t => t.id === state.topicId);
        topicLabel = currentTopic ? currentTopic.title : 'â€”';
        
        switch (state.mode) {
            case 'f10':
                areaLabel = state.area;
                strandLabel = topicLabel.length > 15 ? topicLabel.substring(0, 14) + 'â€¦' : topicLabel;
                levelLabel = state.level;
                break;
            case 'vce':
                areaLabel = state.vceStudy;
                strandLabel = `U${state.vceUnit}`;
                levelLabel = topicLabel.length > 12 ? topicLabel.substring(0, 11) + 'â€¦' : topicLabel;
                break;
            case 'university':
                areaLabel = state.uniCourse;
                strandLabel = `S${state.uniSemester}W${state.uniWeek}`;
                levelLabel = state.uniLevel;
                break;
            default:
                areaLabel = '';
                strandLabel = '';
                levelLabel = '';
        }
        
        elements.progressAreaLabel.textContent = areaLabel;
        elements.progressStrandLabel.textContent = strandLabel;
        elements.progressLevelLabel.textContent = levelLabel;
        elements.progressTopicNum.textContent = state.topicNum || 'â€”';
        elements.progressReadingLabel.textContent = state.readingLevel;
    }
    
    function renderContent() {
        if (!loadedContent) return;
        
        // Support both new schema (literacyLevels) and placeholder (readingLevels)
        const levels = loadedContent.literacyLevels || loadedContent.readingLevels;
        const content = levels[state.readingLevel];
        if (!content) return;
        
        // Map section IDs - support both new and old schemas
        const sections = [
            { 
                id: 'whatYouWillLearn', 
                title: 'My Learning Goals', 
                icon: 'learning', 
                content: content.whatYouWillLearn || content.myLearningGoals 
            },
            { 
                id: 'explicatoryContent', 
                title: 'Learn About It', 
                icon: 'content', 
                content: content.explicatoryContent || content.learnAboutIt 
            },
            { 
                id: 'caseStudy', 
                title: 'See It In Action', 
                icon: 'case', 
                content: content.caseStudy || content.seeItInAction 
            },
            { 
                id: 'assessmentBlooms', 
                title: 'Check Your Understanding', 
                icon: 'check', 
                content: content.assessmentBlooms || content.checkYourUnderstanding 
            },
            { 
                id: 'assessmentSOLO', 
                title: 'Show What You Know', 
                icon: 'show', 
                content: content.assessmentSOLO || content.showWhatYouKnow 
            },
            { 
                id: 'studentReflection', 
                title: 'Think About Your Learning', 
                icon: 'reflect', 
                content: content.studentReflection || content.thinkAboutYourLearning 
            }
        ];
        
        elements.contentSections.innerHTML = sections.map(section => `
            <div class="content-section ${state.expandedSections.includes(section.id) ? 'expanded' : ''}" data-section="${section.id}">
                <button class="section-header" aria-expanded="${state.expandedSections.includes(section.id)}" aria-controls="${section.id}-body">
                    <div class="section-icon ${section.icon}">
                        ${getSectionIcon(section.icon)}
                    </div>
                    <span class="section-title">${section.title}</span>
                    <svg class="section-chevron" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <polyline points="6 9 12 15 18 9"></polyline>
                    </svg>
                </button>
                <div class="section-body" id="${section.id}-body">
                    <div class="section-body-inner">
                        <div class="section-content">
                            ${renderSectionContent(section.id, section.content)}
                        </div>
                    </div>
                </div>
            </div>
        `).join('');
        
        // Attach event handlers
        document.querySelectorAll('.section-header').forEach(header => {
            header.addEventListener('click', () => toggleSection(header.closest('.content-section').dataset.section));
        });
        
        document.querySelectorAll('.question-tab').forEach(tab => {
            tab.addEventListener('click', () => switchQuestionTab(tab));
        });
        
        document.querySelectorAll('.option-item').forEach(option => {
            option.addEventListener('click', () => selectOption(option));
        });
        
        document.querySelectorAll('.rating-btn').forEach(btn => {
            btn.addEventListener('click', () => selectRating(btn));
        });
    }
    
    function getSectionIcon(type) {
        const icons = {
            learning: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M2 3h6a4 4 0 0 1 4 4v14a3 3 0 0 0-3-3H2z"></path><path d="M22 3h-6a4 4 0 0 0-4 4v14a3 3 0 0 1 3-3h7z"></path></svg>',
            content: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"></path><polyline points="14 2 14 8 20 8"></polyline><line x1="16" y1="13" x2="8" y2="13"></line><line x1="16" y1="17" x2="8" y2="17"></line><polyline points="10 9 9 9 8 9"></polyline></svg>',
            case: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"></circle><line x1="12" y1="16" x2="12" y2="12"></line><line x1="12" y1="8" x2="12.01" y2="8"></line></svg>',
            check: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M22 11.08V12a10 10 0 1 1-5.93-9.14"></path><polyline points="22 4 12 14.01 9 11.01"></polyline></svg>',
            show: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="12 2 15.09 8.26 22 9.27 17 14.14 18.18 21.02 12 17.77 5.82 21.02 7 14.14 2 9.27 8.91 8.26 12 2"></polygon></svg>',
            reflect: '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>'
        };
        return icons[type] || '';
    }
    
    function renderSectionContent(sectionId, content) {
        switch (sectionId) {
            case 'whatYouWillLearn':
                return renderWhatYouWillLearn(content);
            case 'explicatoryContent':
                return renderExplicatoryContent(content);
            case 'caseStudy':
                return renderCaseStudy(content);
            case 'assessmentBlooms':
                return renderAssessmentBlooms(content);
            case 'assessmentSOLO':
                return renderAssessmentSOLO(content);
            case 'studentReflection':
                return renderStudentReflection(content);
            default:
                return '<p>Content coming soon...</p>';
        }
    }
    
    // Render Section 1: What You Will Learn (formerly My Learning Goals)
    function renderWhatYouWillLearn(content) {
        // Support both new schema and placeholder
        const overview = content.coreLearning || content.overview;
        const intentions = content.learningIntentions || content.whatImLearning || [];
        const criteria = content.successCriteria || content.howIllKnowIveGotIt || [];
        
        return `
            <div class="learning-goals">
                <p style="margin-bottom: 1.5rem; color: var(--text-secondary); font-size: 1.05rem;">${overview}</p>
                
                <h4>What I'm Learning</h4>
                <ul class="goal-list">
                    ${intentions.map(goal => `<li>${goal}</li>`).join('')}
                </ul>
            </div>
            
            <div class="success-box">
                <h4>How I'll Know I've Got It</h4>
                <ul class="success-list">
                    ${criteria.map(item => `
                        <li class="success-item">
                            <span class="success-statement">${item.criterion || item.goal}</span>
                            <span class="success-evidence">${item.evidence || item.whatThatLooksLike}</span>
                        </li>
                    `).join('')}
                </ul>
            </div>
        `;
    }
    
    // Render Section 2: Explicatory Content (formerly Learn About It)
    function renderExplicatoryContent(content) {
        // Support both new schema and placeholder
        const intro = content.introduction;
        const keyPoints = content.keyPoints || content.bigIdeas || [];
        const vocab = content.vocabulary || content.importantWords || [];
        const explanation = content.conceptExplanation || content.mainExplanation;
        const analogies = content.analogies || [];
        
        return `
            <p style="font-size: 1.05rem; line-height: 1.7; margin-bottom: 1.5rem;">${intro}</p>
            
            <h4 style="font-family: var(--font-display); margin-bottom: 0.75rem;">Key Ideas</h4>
            <div class="key-points">
                ${keyPoints.map((point, i) => `
                    <div class="key-point">
                        <span class="key-point-number">${i + 1}</span>
                        <span>${point}</span>
                    </div>
                `).join('')}
            </div>
            
            <h4 style="font-family: var(--font-display); margin: 1.5rem 0 0.75rem;">Important Words</h4>
            <div class="vocabulary-grid">
                ${vocab.map(w => `
                    <div class="vocab-card">
                        <div class="vocab-term">${w.term || w.word}</div>
                        ${(w.pronunciation || w.howToSayIt) ? `<div class="vocab-pronunciation">${w.pronunciation || w.howToSayIt}</div>` : ''}
                        <div class="vocab-definition">${w.definition || w.whatItMeans}</div>
                    </div>
                `).join('')}
            </div>
            
            ${analogies.length > 0 ? `
                <h4 style="font-family: var(--font-display); margin: 1.5rem 0 0.75rem;">Ways to Think About It</h4>
                <div class="analogies-list">
                    ${analogies.map(a => `
                        <div class="analogy-card" style="background: var(--bg-secondary); padding: 1rem; border-radius: var(--radius-md); margin-bottom: 0.75rem;">
                            <p style="font-style: italic; margin-bottom: 0.5rem;">"${a.analogy}"</p>
                            <p style="font-size: 0.9rem; color: var(--text-tertiary);">${a.explanation}</p>
                        </div>
                    `).join('')}
                </div>
            ` : ''}
            
            <h4 style="font-family: var(--font-display); margin: 1.5rem 0 0.75rem;">The Main Explanation</h4>
            <p style="line-height: 1.7;">${explanation}</p>
        `;
    }
    
    // Render Section 3: Case Study (formerly See It In Action)
    function renderCaseStudy(content) {
        // Support both new schema and placeholder
        const title = content.title;
        const scenario = content.scenario || content.story;
        const observations = content.observations || content.thingsToNotice || [];
        const questions = content.questions || content.thinkAbout || [];
        const connection = content.realWorldConnection || content.whyItMatters;
        const modelAnalysis = content.modelAnalysis;
        
        return `
            <h3 style="font-family: var(--font-display); margin-bottom: 1rem;">${title}</h3>
            <p style="line-height: 1.7; margin-bottom: 1.5rem;">${scenario}</p>
            
            <h4 style="font-size: 0.9rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-tertiary); margin-bottom: 0.75rem;">Things to Notice</h4>
            <ul class="goal-list" style="margin-bottom: 1.5rem;">
                ${observations.map(item => `<li>${item}</li>`).join('')}
            </ul>
            
            <h4 style="font-size: 0.9rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-tertiary); margin-bottom: 0.75rem;">Think About</h4>
            <div class="think-about-questions" style="margin-bottom: 1.5rem;">
                ${questions.map((q, i) => `
                    <div class="think-about-item" style="margin-bottom: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: var(--radius-md); border-left: 3px solid var(--accent-tertiary);">
                        <p style="margin-bottom: 0.75rem; font-weight: 500; color: var(--text-primary);">${q}</p>
                        <textarea 
                            class="response-field" 
                            data-section="caseStudy" 
                            data-question-index="${i}"
                            placeholder="Write your thoughts here..." 
                            style="width: 100%; min-height: 80px; padding: 0.75rem; border: 1px solid var(--border-medium); border-radius: var(--radius-md); font-family: var(--font-body); font-size: 0.95rem; resize: vertical; background: var(--bg-card);"
                        ></textarea>
                    </div>
                `).join('')}
            </div>
            
            ${modelAnalysis ? `
                <div style="background: var(--bg-tertiary); border-radius: var(--radius-lg); padding: 1rem; margin-bottom: 1.5rem;">
                    <h4 style="font-size: 0.85rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--accent-primary); margin-bottom: 0.75rem;">Model Analysis</h4>
                    ${modelAnalysis.strengths ? `<p style="margin-bottom: 0.5rem;"><strong>Strengths:</strong> ${modelAnalysis.strengths.join(', ')}</p>` : ''}
                    ${modelAnalysis.improvements ? `<p><strong>Areas for improvement:</strong> ${modelAnalysis.improvements.join(', ')}</p>` : ''}
                </div>
            ` : ''}
            
            <div style="background: var(--bg-secondary); border-radius: var(--radius-lg); padding: 1rem; border-left: 3px solid var(--accent-secondary);">
                <h4 style="font-size: 0.85rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--accent-secondary); margin-bottom: 0.5rem;">Why This Matters</h4>
                <p style="color: var(--text-secondary); font-size: 0.95rem;">${connection}</p>
            </div>
        `;
    }
    
    // Render Section 4: Assessment Blooms (formerly Check Your Understanding)
    function renderAssessmentBlooms(content) {
        // Support both new schema (6 Bloom's levels) and placeholder (3 tabs)
        const tabs = [
            { id: 'remember', label: 'Remember', fallback: 'quickRecall' },
            { id: 'understand', label: 'Understand', fallback: null },
            { id: 'apply', label: 'Apply', fallback: 'explainIt' },
            { id: 'analyse', label: 'Analyse', fallback: 'useIt' },
            { id: 'evaluate', label: 'Evaluate', fallback: null },
            { id: 'create', label: 'Create', fallback: null }
        ];
        
        // Get items for each tab, supporting both schemas
        const getItems = (tab) => {
            let items = content[tab.id] || [];
            // Fallback to placeholder schema
            if (items.length === 0 && tab.fallback) {
                items = content[tab.fallback] || [];
            }
            return items;
        };
        
        // Filter out empty tabs
        const availableTabs = tabs.filter(tab => getItems(tab).length > 0);
        
        if (availableTabs.length === 0) {
            return '<p class="placeholder-state">Assessment questions coming soon...</p>';
        }
        
        return `
            <div class="question-tabs">
                ${availableTabs.map((tab, i) => `
                    <button class="question-tab ${i === 0 ? 'active' : ''}" data-level="${tab.id}">${tab.label}</button>
                `).join('')}
            </div>
            
            ${availableTabs.map((tab, i) => `
                <div class="question-content ${i === 0 ? 'active' : ''}" data-level="${tab.id}">
                    ${getItems(tab).map((item, qIdx) => renderBloomsQuestionItem(item, tab.id, qIdx)).join('')}
                </div>
            `).join('')}
        `;
    }
    
    function renderBloomsQuestionItem(item, bloomLevel = 'unknown', questionIndex = 0) {
        // Support both new schema (stem, options) and placeholder (question, choices)
        const question = item.stem || item.question;
        const options = item.options || item.choices || [];
        
        if (item.type === 'multipleChoice') {
            return `
                <div class="question-card" data-question-id="${bloomLevel}-${questionIndex}">
                    <div class="question-stem">${question}</div>
                    ${item.difficulty ? `<span class="difficulty-badge" style="font-size: 0.75rem; padding: 0.2rem 0.5rem; background: var(--bg-tertiary); border-radius: var(--radius-sm); color: var(--text-tertiary); margin-bottom: 0.75rem; display: inline-block;">${item.difficulty}</span>` : ''}
                    <div class="options-list">
                        ${options.map(opt => `
                            <div class="option-item" data-id="${opt.id}" data-correct="${opt.isCorrect}" data-feedback="${opt.feedback}">
                                <span class="option-id">${opt.id}</span>
                                <span>${opt.text}</span>
                            </div>
                        `).join('')}
                    </div>
                    <div class="justification-section" style="margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-light);">
                        <label style="display: block; margin-bottom: 0.5rem; font-size: 0.85rem; font-weight: 500; color: var(--text-secondary);">Explain your choice:</label>
                        <textarea 
                            class="response-field" 
                            data-section="assessmentBlooms" 
                            data-bloom-level="${bloomLevel}"
                            data-question-index="${questionIndex}"
                            data-question-type="multipleChoice"
                            placeholder="Why did you choose this answer? Explain your reasoning..." 
                            style="width: 100%; min-height: 80px; padding: 0.75rem; border: 1px solid var(--border-medium); border-radius: var(--radius-md); font-family: var(--font-body); font-size: 0.95rem; resize: vertical; background: var(--bg-card);"
                        ></textarea>
                    </div>
                </div>
            `;
        } else if (item.type === 'shortAnswer') {
            const rubric = item.rubric || item.greatAnswerLooksLike;
            const criteria = item.successCriteria || item.thingsToInclude || [];
            
            return `
                <div class="question-card" data-question-id="${bloomLevel}-${questionIndex}">
                    <div class="question-stem">${question}</div>
                    ${item.difficulty ? `<span class="difficulty-badge" style="font-size: 0.75rem; padding: 0.2rem 0.5rem; background: var(--bg-tertiary); border-radius: var(--radius-sm); color: var(--text-tertiary); margin-bottom: 0.75rem; display: inline-block;">${item.difficulty}</span>` : ''}
                    <textarea 
                        class="response-field" 
                        data-section="assessmentBlooms" 
                        data-bloom-level="${bloomLevel}"
                        data-question-index="${questionIndex}"
                        data-question-type="shortAnswer"
                        placeholder="Write your answer here..." 
                        style="width: 100%; min-height: 100px; padding: 0.75rem; border: 1px solid var(--border-medium); border-radius: var(--radius-md); font-family: var(--font-body); font-size: 0.95rem; resize: vertical; background: var(--bg-card);"
                    ></textarea>
                    <details style="margin-top: 0.75rem;">
                        <summary style="cursor: pointer; color: var(--accent-primary); font-weight: 500;">What a Great Answer Looks Like</summary>
                        <div style="margin-top: 0.5rem; padding: 0.75rem; background: var(--bg-tertiary); border-radius: var(--radius-md);">
                            <p style="margin-bottom: 0.5rem;">${rubric}</p>
                            ${criteria.length > 0 ? `<p style="font-size: 0.85rem; color: var(--text-tertiary);"><strong>Things to include:</strong> ${criteria.join(', ')}</p>` : ''}
                        </div>
                    </details>
                </div>
            `;
        } else if (item.type === 'extendedResponse') {
            return `
                <div class="question-card" data-question-id="${bloomLevel}-${questionIndex}">
                    <div class="question-stem">${question}</div>
                    ${item.difficulty ? `<span class="difficulty-badge" style="font-size: 0.75rem; padding: 0.2rem 0.5rem; background: var(--bg-tertiary); border-radius: var(--radius-sm); color: var(--text-tertiary); margin-bottom: 0.75rem; display: inline-block;">${item.difficulty}</span>` : ''}
                    <textarea 
                        class="response-field" 
                        data-section="assessmentBlooms" 
                        data-bloom-level="${bloomLevel}"
                        data-question-index="${questionIndex}"
                        data-question-type="extendedResponse"
                        placeholder="Write your extended response here..." 
                        style="width: 100%; min-height: 150px; padding: 0.75rem; border: 1px solid var(--border-medium); border-radius: var(--radius-md); font-family: var(--font-body); font-size: 0.95rem; resize: vertical; background: var(--bg-card);"
                    ></textarea>
                    ${item.rubric ? `
                        <details style="margin-top: 0.75rem;">
                            <summary style="cursor: pointer; color: var(--accent-primary); font-weight: 500;">Marking Guide</summary>
                            <div style="margin-top: 0.5rem; padding: 0.75rem; background: var(--bg-tertiary); border-radius: var(--radius-md);">
                                <p>${item.rubric}</p>
                            </div>
                        </details>
                    ` : ''}
                </div>
            `;
        }
        return '';
    }
    
    // Render Section 5: Assessment SOLO (formerly Show What You Know)
    function renderAssessmentSOLO(content) {
        // Support both new schema (4 SOLO levels) and placeholder (3 tabs)
        const tabs = [
            { id: 'unistructural', label: 'One Idea', fallback: 'oneIdea' },
            { id: 'multistructural', label: 'Several Ideas', fallback: 'severalIdeas' },
            { id: 'relational', label: 'Connected', fallback: 'connectedIdeas' },
            { id: 'extendedAbstract', label: 'Extended', fallback: null }
        ];
        
        // Get items for each tab, supporting both schemas
        const getItem = (tab) => {
            // New schema uses arrays
            if (content[tab.id] && Array.isArray(content[tab.id]) && content[tab.id].length > 0) {
                return content[tab.id][0]; // Return first item for now
            }
            // Placeholder schema uses objects directly
            if (tab.fallback && content[tab.fallback]) {
                return content[tab.fallback];
            }
            return null;
        };
        
        // Filter out empty tabs
        const availableTabs = tabs.filter(tab => getItem(tab) !== null);
        
        if (availableTabs.length === 0) {
            return '<p class="placeholder-state">SOLO tasks coming soon...</p>';
        }
        
        return `
            <div class="question-tabs">
                ${availableTabs.map((tab, i) => `
                    <button class="question-tab ${i === 0 ? 'active' : ''}" data-level="${tab.id}">${tab.label}</button>
                `).join('')}
            </div>
            
            ${availableTabs.map((tab, i) => {
                const item = getItem(tab);
                return `
                    <div class="question-content ${i === 0 ? 'active' : ''}" data-level="${tab.id}">
                        ${renderSOLOItem(item, tab.id, i)}
                    </div>
                `;
            }).join('')}
        `;
    }
    
    function renderSOLOItem(item, soloLevel = 'unknown', questionIndex = 0) {
        // Support both new schema (stem, rubric) and placeholder (task, exampleAnswer)
        const task = item.stem || item.task;
        const example = item.exampleAnswer || item.modelResponse;
        
        let exampleHtml = '';
        if (example) {
            if (typeof example === 'string') {
                exampleHtml = `<p>${example}</p>`;
            } else if (example.answer) {
                exampleHtml = `
                    <p style="margin-bottom: 0.75rem;">${example.answer}</p>
                    ${example.whatMakesItGood ? `<p style="font-size: 0.85rem; color: var(--text-tertiary);"><strong>What makes it good:</strong> ${example.whatMakesItGood.join(', ')}</p>` : ''}
                `;
            }
        }
        
        return `
            <div class="question-card" data-question-id="${soloLevel}-${questionIndex}">
                <div class="question-stem">${task}</div>
                ${item.difficulty ? `<span class="difficulty-badge" style="font-size: 0.75rem; padding: 0.2rem 0.5rem; background: var(--bg-tertiary); border-radius: var(--radius-sm); color: var(--text-tertiary); margin-bottom: 0.75rem; display: inline-block;">${item.difficulty}</span>` : ''}
                <textarea 
                    class="response-field" 
                    data-section="assessmentSOLO" 
                    data-solo-level="${soloLevel}"
                    data-question-index="${questionIndex}"
                    placeholder="Write your response here..." 
                    style="width: 100%; min-height: 120px; padding: 0.75rem; border: 1px solid var(--border-medium); border-radius: var(--radius-md); font-family: var(--font-body); font-size: 0.95rem; resize: vertical; background: var(--bg-card);"
                ></textarea>
                ${exampleHtml ? `
                    <details style="margin-top: 0.75rem;">
                        <summary style="cursor: pointer; color: var(--accent-primary); font-weight: 500;">Example Answer</summary>
                        <div style="margin-top: 0.5rem; padding: 0.75rem; background: var(--bg-tertiary); border-radius: var(--radius-md);">
                            ${exampleHtml}
                        </div>
                    </details>
                ` : ''}
                ${item.rubric ? `
                    <details style="margin-top: 0.5rem;">
                        <summary style="cursor: pointer; color: var(--accent-secondary); font-weight: 500;">Marking Guide</summary>
                        <div style="margin-top: 0.5rem; padding: 0.75rem; background: var(--bg-tertiary); border-radius: var(--radius-md);">
                            <p>${item.rubric}</p>
                        </div>
                    </details>
                ` : ''}
            </div>
        `;
    }
    
    // Render Section 6: Student Reflection (formerly Think About Your Learning)
    function renderStudentReflection(content) {
        // Support both new schema and placeholder
        const reflectionQuestions = content.reflectionQuestions || content.questions || [];
        const selfAssessment = content.selfAssessment || content.rateYourself || [];
        const connectionToLife = content.connectionToLife || content.myNextSteps || [];
        
        // Handle both array of strings and array of objects for questions
        const questionList = reflectionQuestions.map(q => {
            if (typeof q === 'string') return q;
            if (q.question) return q.question;
            return q;
        });
        
        // Handle both string and array for connectionToLife
        const lifeSteps = Array.isArray(connectionToLife) ? connectionToLife : [connectionToLife];
        
        return `
            <h4 style="font-size: 0.9rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-tertiary); margin-bottom: 0.75rem;">Questions to Think About</h4>
            <div class="reflection-questions" style="margin-bottom: 1.5rem;">
                ${questionList.map((q, i) => `
                    <div class="reflection-item" style="margin-bottom: 1rem; padding: 1rem; background: var(--bg-secondary); border-radius: var(--radius-md); border-left: 3px solid var(--accent-secondary);">
                        <p style="margin-bottom: 0.75rem; font-weight: 500; color: var(--text-primary);">${q}</p>
                        <textarea 
                            class="response-field" 
                            data-section="studentReflection" 
                            data-question-index="${i}"
                            placeholder="Write your reflection here..." 
                            style="width: 100%; min-height: 80px; padding: 0.75rem; border: 1px solid var(--border-medium); border-radius: var(--radius-md); font-family: var(--font-body); font-size: 0.95rem; resize: vertical; background: var(--bg-card);"
                        ></textarea>
                    </div>
                `).join('')}
            </div>
            
            <h4 style="font-size: 0.9rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-tertiary); margin-bottom: 0.75rem;">Rate Yourself</h4>
            <p style="font-size: 0.875rem; color: var(--text-tertiary); margin-bottom: 0.75rem;">How confident do you feel? 1 = Not yet, 2 = Sometimes, 3 = Usually, 4 = Always</p>
            <div class="self-rating-grid">
                ${selfAssessment.map(item => {
                    const statement = item.statement || item.criterion || item;
                    return `
                        <div class="rating-row">
                            <span class="rating-statement">${statement}</span>
                            <div class="rating-scale">
                                <button class="rating-btn" data-rating="1">1</button>
                                <button class="rating-btn" data-rating="2">2</button>
                                <button class="rating-btn" data-rating="3">3</button>
                                <button class="rating-btn" data-rating="4">4</button>
                            </div>
                        </div>
                    `;
                }).join('')}
            </div>
            
            <h4 style="font-size: 0.9rem; font-weight: 600; text-transform: uppercase; letter-spacing: 0.05em; color: var(--text-tertiary); margin: 1.5rem 0 0.75rem;">Connecting to My Life</h4>
            ${lifeSteps.map((step, i) => `
                <div style="margin-bottom: 1rem;">
                    <label style="display: block; margin-bottom: 0.5rem; color: var(--text-secondary);">${step}</label>
                    <textarea 
                        class="response-field" 
                        data-section="connectionToLife" 
                        data-question-index="${i}"
                        placeholder="Type your response here..." 
                        style="width: 100%; min-height: 60px; padding: 0.75rem; border: 1px solid var(--border-medium); border-radius: var(--radius-md); font-family: var(--font-body); background: var(--bg-card); resize: vertical;"
                    ></textarea>
                </div>
            `).join('')}
        `;
    }
    
    // ============================================
    // EVENT HANDLERS
    // ============================================
    function setupEventListeners() {
        // Mode and selector changes
        elements.modeSelect.addEventListener('change', handleModeChange);
        elements.selector1.addEventListener('change', handleSelector1Change);
        elements.selector2.addEventListener('change', handleSelector2Change);
        elements.selector3.addEventListener('change', handleSelector3Change);
        elements.yearSelect.addEventListener('change', handleYearChange);
        elements.topicSelect.addEventListener('change', handleTopicChange);
        elements.topicNumSelect.addEventListener('change', handleTopicNumChange);
        elements.readingLevelSelect.addEventListener('change', handleReadingLevelChange);
        
        elements.themeToggle.addEventListener('click', toggleTheme);
        
        elements.settingsBtn.addEventListener('click', openSettings);
        elements.closeSettings.addEventListener('click', closeSettings);
        elements.settingsBackdrop.addEventListener('click', closeSettings);
        elements.darkModeToggle.addEventListener('click', toggleTheme);
        
        elements.mapBtn.addEventListener('click', openMap);
        elements.closeMap.addEventListener('click', closeMap);
        elements.mapBackdrop.addEventListener('click', closeMap);
        
        // Submit button
        const submitBtn = document.getElementById('submitBtn');
        if (submitBtn) {
            submitBtn.addEventListener('click', submitResponses);
        }
        
        document.addEventListener('keydown', handleKeyboard);
        
        window.addEventListener('beforeunload', saveState);
        document.addEventListener('visibilitychange', () => {
            if (document.hidden) saveState();
        });
    }
    
    async function handleModeChange() {
        pushUndoState();
        state.mode = elements.modeSelect.value;
        clearTopicSelection();
        await configureForMode();
        await loadContent();
        resizeAllSelects();
        
        const modeNames = { f10: 'Years F-10', vce: 'VCE', university: 'University' };
        showToast(`Switched to ${modeNames[state.mode]}`, 'info');
    }
    
    async function handleSelector1Change() {
        pushUndoState();
        
        switch (state.mode) {
            case 'f10':
                state.category = elements.selector1.value;
                populateF10Area();
                state.area = elements.selector2.value;
                populateF10Discipline();
                clearTopicSelection();
                await fetchAndPopulateTopics();
                break;
            case 'vce':
                state.vceDomain = elements.selector1.value;
                populateVCEStudy();
                state.vceStudy = elements.selector2.value;
                clearTopicSelection();
                await fetchAndPopulateTopics();
                break;
            case 'university':
                state.uniFaculty = elements.selector1.value;
                populateUniCourse();
                state.uniCourse = elements.selector2.value;
                clearTopicSelection();
                await fetchAndPopulateTopics();
                break;
        }
        
        await loadContent();
        resizeAllSelects();
        showToast('Selection changed', 'info');
    }
    
    async function handleSelector2Change() {
        pushUndoState();
        
        switch (state.mode) {
            case 'f10':
                state.area = elements.selector2.value;
                populateF10Discipline();
                clearTopicSelection();
                await fetchAndPopulateTopics();
                break;
            case 'vce':
                state.vceStudy = elements.selector2.value;
                clearTopicSelection();
                await fetchAndPopulateTopics();
                break;
            case 'university':
                state.uniCourse = elements.selector2.value;
                clearTopicSelection();
                await fetchAndPopulateTopics();
                break;
        }
        
        await loadContent();
        resizeAllSelects();
        showToast('Selection changed', 'info');
    }
    
    async function handleSelector3Change() {
        pushUndoState();
        
        switch (state.mode) {
            case 'f10':
                state.discipline = elements.selector3.value;
                // Don't clear topics, just refilter
                filterAndPopulateTopics();
                populateTopicNumbers();
                break;
            case 'university':
                state.uniLevel = elements.selector3.value;
                filterAndPopulateTopics();
                populateTopicNumbers();
                break;
        }
        
        await loadContent();
        resizeAllSelects();
        showToast('Selection changed', 'info');
    }
    
    async function handleYearChange() {
        pushUndoState();
        
        switch (state.mode) {
            case 'f10':
                state.level = elements.yearSelect.value;
                break;
            case 'vce':
                state.vceUnit = elements.yearSelect.value;
                break;
            case 'university':
                // Parse combined semester-week value
                const [sem, week] = elements.yearSelect.value.split('-');
                state.uniSemester = sem;
                state.uniWeek = week;
                break;
        }
        
        // Refilter topics for new year/unit selection
        filterAndPopulateTopics();
        populateTopicNumbers();
        
        await loadContent();
        resizeAllSelects();
        showToast('Selection changed', 'info');
    }
    
    async function handleTopicChange() {
        pushUndoState();
        state.topicId = elements.topicSelect.value;
        state.topicNum = 1;
        populateTopicNumbers();
        await loadContent();
        resizeAllSelects();
        
        const topic = availableTopics.find(t => t.id === state.topicId);
        showToast(`Topic: ${topic?.title || state.topicId}`, 'info');
    }
    
    async function handleTopicNumChange() {
        pushUndoState();
        state.topicNum = parseInt(elements.topicNumSelect.value);
        await loadContent();
        resizeAllSelects();
        showToast(`Part ${state.topicNum}`, 'info');
    }
    
    function handleReadingLevelChange() {
        pushUndoState();
        state.readingLevel = elements.readingLevelSelect.value;
        renderContent();
        updateProgressBar();
        saveState();
        resizeAllSelects();
        
        const levelNames = { A: 'Easier', B: 'Building', C: 'Standard', D: 'Challenge', E: 'Expert' };
        showToast(`Reading: ${levelNames[state.readingLevel]}`, 'success');
    }
    
    function toggleSection(sectionId) {
        const index = state.expandedSections.indexOf(sectionId);
        if (index > -1) {
            state.expandedSections.splice(index, 1);
        } else {
            state.expandedSections.push(sectionId);
        }
        
        const sectionEl = document.querySelector(`[data-section="${sectionId}"]`);
        if (sectionEl) {
            sectionEl.classList.toggle('expanded');
            const header = sectionEl.querySelector('.section-header');
            header.setAttribute('aria-expanded', sectionEl.classList.contains('expanded'));
        }
        
        saveState();
    }
    
    function switchQuestionTab(tab) {
        const container = tab.closest('.section-content');
        const level = tab.dataset.level;
        
        container.querySelectorAll('.question-tab').forEach(t => t.classList.remove('active'));
        container.querySelectorAll('.question-content').forEach(c => c.classList.remove('active'));
        
        tab.classList.add('active');
        container.querySelector(`.question-content[data-level="${level}"]`).classList.add('active');
    }
    
    function selectOption(option) {
        const container = option.closest('.options-list');
        container.querySelectorAll('.option-item').forEach(o => o.classList.remove('selected'));
        option.classList.add('selected');
        
        const isCorrect = option.dataset.correct === 'true';
        const feedback = option.dataset.feedback;
        
        showToast(feedback, isCorrect ? 'success' : 'warning');
    }
    
    function selectRating(btn) {
        const container = btn.closest('.rating-scale');
        container.querySelectorAll('.rating-btn').forEach(b => b.classList.remove('selected'));
        btn.classList.add('selected');
    }
    
    // ============================================
    // THEME MANAGEMENT
    // ============================================
    function toggleTheme() {
        state.theme = state.theme === 'light' ? 'dark' : 'light';
        applyTheme();
        saveState();
        
        if (state.theme === 'dark') {
            elements.darkModeToggle.classList.add('active');
            elements.darkModeToggle.setAttribute('aria-checked', 'true');
        } else {
            elements.darkModeToggle.classList.remove('active');
            elements.darkModeToggle.setAttribute('aria-checked', 'false');
        }
        
        showToast(`${state.theme === 'dark' ? 'Dark' : 'Light'} mode`, 'info');
    }
    
    function applyTheme() {
        document.documentElement.setAttribute('data-theme', state.theme);
        
        if (state.theme === 'dark') {
            elements.darkModeToggle.classList.add('active');
            elements.darkModeToggle.setAttribute('aria-checked', 'true');
        } else {
            elements.darkModeToggle.classList.remove('active');
            elements.darkModeToggle.setAttribute('aria-checked', 'false');
        }
    }
    
    // ============================================
    // SETTINGS PANEL
    // ============================================
    function openSettings() {
        elements.settingsPanel.classList.add('open');
        elements.settingsBackdrop.classList.add('open');
        elements.settingsPanel.setAttribute('aria-hidden', 'false');
    }
    
    function closeSettings() {
        elements.settingsPanel.classList.remove('open');
        elements.settingsBackdrop.classList.remove('open');
        elements.settingsPanel.setAttribute('aria-hidden', 'true');
    }
    
    // ============================================
    // CURRICULUM MAP
    // ============================================
    function openMap() {
        renderMap();
        elements.mapPanel.classList.add('open');
        elements.mapBackdrop.classList.add('open');
        elements.mapPanel.setAttribute('aria-hidden', 'false');
    }
    
    function closeMap() {
        elements.mapPanel.classList.remove('open');
        elements.mapBackdrop.classList.remove('open');
        elements.mapPanel.setAttribute('aria-hidden', 'true');
    }
    
    function renderMap() {
        // Update code display
        elements.mapCode.textContent = loadedContent?.metadata?.curriculumCode || '';
        
        // Generate based on mode
        switch (state.mode) {
            case 'f10':
                renderF10Map();
                break;
            case 'vce':
                renderVCEMap();
                break;
            case 'university':
                renderUniversityMap();
                break;
        }
    }
    
    function renderF10Map() {
        // Calculate position stats
        const categories = curriculumData.f10.categories;
        const areas = curriculumData.f10.areas;
        const levels = curriculumData.f10.levels;
        
        // Count total topics: ~7 subjects Ã— 3 strands avg Ã— 6 levels Ã— 5 topics = 630
        // Plus ~4 capabilities Ã— 3 strands Ã— 6 levels Ã— 5 topics = 360
        // Total ~990 for F-10, plus VCE ~600, plus Uni ~600 = ~2200
        
        let totalTopics = 0;
        let currentAreaStart = 0;
        let currentStrandStart = 0;
        let currentPosition = 0;
        
        const structure = [];
        
        // Build structure for all subjects/skills
        Object.keys(categories).forEach(cat => {
            categories[cat].forEach(areaName => {
                const areaData = areas[areaName];
                if (!areaData) return;
                
                let strands = [];
                if (areaData.disciplines) {
                    Object.keys(areaData.disciplines).forEach(disc => {
                        areaData.disciplines[disc].forEach(strand => {
                            strands.push({ discipline: disc, strand: strand });
                        });
                    });
                } else if (areaData.strands) {
                    strands = areaData.strands.map(s => ({ discipline: null, strand: s }));
                }
                
                const isCurrentArea = areaName === state.area;
                if (isCurrentArea) currentAreaStart = totalTopics;
                
                strands.forEach(s => {
                    const isCurrentStrand = isCurrentArea && 
                        (state.discipline === null || s.discipline === state.discipline) && 
                        s.strand === state.strand;
                    
                    if (isCurrentStrand) currentStrandStart = totalTopics;
                    
                    levels.forEach((level, levelIdx) => {
                        for (let topic = 1; topic <= 5; topic++) {
                            const isCurrentTopic = isCurrentStrand && 
                                level.id === state.level && 
                                topic === state.topic;
                            
                            if (isCurrentTopic) currentPosition = totalTopics;
                            
                            structure.push({
                                area: areaName,
                                discipline: s.discipline,
                                strand: s.strand,
                                level: level.id,
                                topic: topic,
                                isCurrentArea: isCurrentArea,
                                isCurrentStrand: isCurrentStrand,
                                isCurrent: isCurrentTopic
                            });
                            
                            totalTopics++;
                        }
                    });
                });
            });
        });
        
        // Render breadcrumb
        elements.mapBreadcrumb.innerHTML = `
            <span>F-10</span>
            <span class="breadcrumb-arrow">â€º</span>
            <strong>${state.category}</strong>
            <span class="breadcrumb-arrow">â€º</span>
            <strong>${state.area}</strong>
            ${state.discipline ? `<span class="breadcrumb-arrow">â€º</span><strong>${state.discipline}</strong>` : ''}
            <span class="breadcrumb-arrow">â€º</span>
            <strong>${state.strand}</strong>
            <span class="breadcrumb-arrow">â€º</span>
            <strong>Year ${state.level}</strong>
            <span class="breadcrumb-arrow">â€º</span>
            <span class="current">Topic ${state.topic}</span>
        `;
        
        // Render stats
        const areaTopics = structure.filter(s => s.isCurrentArea).length;
        const strandTopics = structure.filter(s => s.isCurrentStrand).length;
        
        elements.mapStats.innerHTML = `
            <div class="map-stat">Position: <strong>${currentPosition + 1}</strong> of <strong>${totalTopics}</strong> F-10 topics</div>
            <div class="map-stat">${state.area}: <strong>${areaTopics}</strong> topics</div>
            <div class="map-stat">${state.strand}: <strong>${strandTopics}</strong> topics</div>
        `;
        
        // Render wireframe grid - group by area
        renderWireframeGrid(structure, 'area');
    }
    
    function renderVCEMap() {
        const domains = curriculumData.vce.domains;
        const units = curriculumData.vce.units;
        const aos = curriculumData.vce.areasOfStudy;
        
        let totalTopics = 0;
        let currentPosition = 0;
        const structure = [];
        
        Object.keys(domains).forEach(domain => {
            const isCurrentDomain = domain === state.vceDomain;
            
            domains[domain].forEach(study => {
                const isCurrentStudy = isCurrentDomain && study === state.vceStudy;
                
                units.forEach(unit => {
                    aos.forEach(area => {
                        for (let topic = 1; topic <= 5; topic++) {
                            const isCurrent = isCurrentStudy && 
                                unit.id === state.vceUnit && 
                                area.id === state.vceAOS && 
                                topic === state.topic;
                            
                            if (isCurrent) currentPosition = totalTopics;
                            
                            structure.push({
                                area: study,
                                domain: domain,
                                unit: unit.id,
                                aos: area.id,
                                topic: topic,
                                isCurrentArea: isCurrentStudy,
                                isCurrentStrand: isCurrentStudy && unit.id === state.vceUnit,
                                isCurrent: isCurrent
                            });
                            
                            totalTopics++;
                        }
                    });
                });
            });
        });
        
        elements.mapBreadcrumb.innerHTML = `
            <span>VCE</span>
            <span class="breadcrumb-arrow">â€º</span>
            <strong>${state.vceDomain}</strong>
            <span class="breadcrumb-arrow">â€º</span>
            <strong>${state.vceStudy}</strong>
            <span class="breadcrumb-arrow">â€º</span>
            <strong>Unit ${state.vceUnit}</strong>
            <span class="breadcrumb-arrow">â€º</span>
            <strong>${state.vceAOS.toUpperCase()}</strong>
            <span class="breadcrumb-arrow">â€º</span>
            <span class="current">Topic ${state.topic}</span>
        `;
        
        const studyTopics = structure.filter(s => s.isCurrentArea).length;
        
        elements.mapStats.innerHTML = `
            <div class="map-stat">Position: <strong>${currentPosition + 1}</strong> of <strong>${totalTopics}</strong> VCE topics</div>
            <div class="map-stat">${state.vceStudy}: <strong>${studyTopics}</strong> topics</div>
        `;
        
        renderWireframeGrid(structure, 'area');
    }
    
    function renderUniversityMap() {
        const faculties = curriculumData.university.faculties;
        const semesters = curriculumData.university.semesters;
        const weeks = curriculumData.university.weeks;
        
        let totalTopics = 0;
        let currentPosition = 0;
        const structure = [];
        
        Object.keys(faculties).forEach(faculty => {
            const isCurrentFaculty = faculty === state.uniFaculty;
            
            faculties[faculty].forEach(course => {
                const isCurrentCourse = isCurrentFaculty && course === state.uniCourse;
                
                semesters.forEach(sem => {
                    weeks.forEach(week => {
                        for (let topic = 1; topic <= 5; topic++) {
                            const isCurrent = isCurrentCourse && 
                                sem.id === state.uniSemester && 
                                week.id === state.uniWeek && 
                                topic === state.topic;
                            
                            if (isCurrent) currentPosition = totalTopics;
                            
                            structure.push({
                                area: course,
                                faculty: faculty,
                                semester: sem.id,
                                week: week.id,
                                topic: topic,
                                isCurrentArea: isCurrentCourse,
                                isCurrentStrand: isCurrentCourse && sem.id === state.uniSemester,
                                isCurrent: isCurrent
                            });
                            
                            totalTopics++;
                        }
                    });
                });
            });
        });
        
        elements.mapBreadcrumb.innerHTML = `
            <span>University</span>
            <span class="breadcrumb-arrow">â€º</span>
            <strong>${state.uniFaculty}</strong>
            <span class="breadcrumb-arrow">â€º</span>
            <strong>${state.uniCourse}</strong>
            <span class="breadcrumb-arrow">â€º</span>
            <strong>Sem ${state.uniSemester}</strong>
            <span class="breadcrumb-arrow">â€º</span>
            <strong>Week ${state.uniWeek}</strong>
            <span class="breadcrumb-arrow">â€º</span>
            <span class="current">Topic ${state.topic}</span>
        `;
        
        const courseTopics = structure.filter(s => s.isCurrentArea).length;
        
        elements.mapStats.innerHTML = `
            <div class="map-stat">Position: <strong>${currentPosition + 1}</strong> of <strong>${totalTopics}</strong> Uni topics</div>
            <div class="map-stat">${state.uniCourse}: <strong>${courseTopics}</strong> topics</div>
        `;
        
        renderWireframeGrid(structure, 'area');
    }
    
    function renderWireframeGrid(structure, groupBy) {
        // Group structure by area for row-based display
        const groups = {};
        structure.forEach((item, idx) => {
            const key = item.area;
            if (!groups[key]) {
                groups[key] = [];
            }
            groups[key].push({ ...item, globalIndex: idx });
        });
        
        // Render rows
        let html = '';
        Object.keys(groups).forEach(areaName => {
            const items = groups[areaName];
            const shortName = areaName.length > 10 ? areaName.substring(0, 9) + 'â€¦' : areaName;
            
            html += `
                <div class="wireframe-row">
                    <div class="wireframe-row-label" title="${areaName}">${shortName}</div>
                    <div class="wireframe-cells">
                        ${items.map(item => {
                            let cellClass = 'wireframe-cell filled';
                            if (item.isCurrent) cellClass += ' current';
                            else if (item.isCurrentStrand) cellClass += ' current-strand';
                            else if (item.isCurrentArea) cellClass += ' current-area';
                            return `<div class="${cellClass}" title="Topic ${item.topic}"></div>`;
                        }).join('')}
                    </div>
                </div>
            `;
        });
        
        elements.wireframeGrid.innerHTML = html;
    }
    
    // ============================================
    // KEYBOARD NAVIGATION
    // ============================================
    function handleKeyboard(e) {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') {
            if (e.key === 'Escape') {
                e.target.blur();
            }
            return;
        }
        
        switch (e.key) {
            case 't':
            case 'T':
                toggleTheme();
                break;
            case 's':
            case 'S':
                openSettings();
                break;
            case 'm':
            case 'M':
                openMap();
                break;
            case 'Escape':
                closeSettings();
                closeMap();
                break;
            case 'ArrowRight':
                if (state.topic < 5) {
                    state.topic++;
                    elements.topicSelect.value = state.topic;
                    loadContent();
                    showToast(`Topic ${state.topic}`, 'info');
                }
                break;
            case 'ArrowLeft':
                if (state.topic > 1) {
                    state.topic--;
                    elements.topicSelect.value = state.topic;
                    loadContent();
                    showToast(`Topic ${state.topic}`, 'info');
                }
                break;
            case 'z':
            case 'Z':
                if (e.ctrlKey || e.metaKey) {
                    if (e.shiftKey) {
                        redo();
                    } else {
                        undo();
                    }
                    e.preventDefault();
                }
                break;
            case 'y':
            case 'Y':
                if (e.ctrlKey || e.metaKey) {
                    redo();
                    e.preventDefault();
                }
                break;
        }
    }
    
    function undo() {
        if (undoStack.length === 0) {
            showToast('Nothing to undo', 'warning');
            return;
        }
        redoStack.push(JSON.stringify(state));
        state = JSON.parse(undoStack.pop());
        populateSelectors();
        loadContent();
        applyTheme();
        showToast('Undone', 'info');
    }
    
    function redo() {
        if (redoStack.length === 0) {
            showToast('Nothing to redo', 'warning');
            return;
        }
        undoStack.push(JSON.stringify(state));
        state = JSON.parse(redoStack.pop());
        populateSelectors();
        loadContent();
        applyTheme();
        showToast('Redone', 'info');
    }
    
    // ============================================
    // TOAST NOTIFICATIONS
    // ============================================
    function showToast(message, type = 'info') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.innerHTML = `<span>${message}</span>`;
        elements.toastContainer.appendChild(toast);
        
        setTimeout(() => {
            toast.style.opacity = '0';
            toast.style.transform = 'translateX(100%)';
            setTimeout(() => toast.remove(), 300);
        }, 2500);
    }
    
    // ============================================
    // RESPONSE COLLECTION & SUBMISSION
    // ============================================
    
    // Store all student responses
    let studentResponses = {};
    
    // Load saved responses from localStorage
    function loadSavedResponses() {
        try {
            const saved = localStorage.getItem('trovu_student_responses');
            if (saved) {
                studentResponses = JSON.parse(saved);
            }
        } catch (e) {
            console.warn('Could not load saved responses:', e);
        }
    }
    
    // Save responses to localStorage
    function saveResponses() {
        try {
            localStorage.setItem('trovu_student_responses', JSON.stringify(studentResponses));
        } catch (e) {
            console.warn('Could not save responses:', e);
        }
    }
    
    // Generate a unique key for the current topic
    function getTopicKey() {
        return `${state.mode}-${state.topicId}-${state.topicNum}`;
    }
    
    // Collect all responses from the current page
    function collectResponses() {
        const topicKey = getTopicKey();
        if (!studentResponses[topicKey]) {
            studentResponses[topicKey] = {
                metadata: {
                    mode: state.mode,
                    topicId: state.topicId,
                    topicNum: state.topicNum,
                    topicTitle: loadedContent?.metadata?.topicTitle || 'Unknown',
                    collectedAt: new Date().toISOString()
                },
                responses: {}
            };
        }
        
        // Collect all textarea responses
        document.querySelectorAll('.response-field').forEach(textarea => {
            const section = textarea.dataset.section;
            const value = textarea.value.trim();
            
            if (value) {
                const key = buildResponseKey(textarea);
                studentResponses[topicKey].responses[key] = {
                    section: section,
                    value: value,
                    timestamp: new Date().toISOString(),
                    questionStem: getQuestionStem(textarea)
                };
            }
        });
        
        // Collect multiple choice selections
        document.querySelectorAll('.option-item.selected').forEach(option => {
            const card = option.closest('.question-card');
            if (card) {
                const questionId = card.dataset.questionId;
                const selectedId = option.dataset.id;
                const isCorrect = option.dataset.correct === 'true';
                
                studentResponses[topicKey].responses[`mc-${questionId}`] = {
                    section: 'assessmentBlooms',
                    type: 'multipleChoice',
                    selectedOption: selectedId,
                    isCorrect: isCorrect,
                    timestamp: new Date().toISOString(),
                    questionStem: card.querySelector('.question-stem')?.textContent || ''
                };
            }
        });
        
        // Collect rating selections
        document.querySelectorAll('.rating-btn.selected').forEach(btn => {
            const row = btn.closest('.rating-row');
            if (row) {
                const statement = row.querySelector('.rating-statement')?.textContent || '';
                const rating = btn.dataset.rating;
                const key = `rating-${statement.substring(0, 30).replace(/\s+/g, '-')}`;
                
                studentResponses[topicKey].responses[key] = {
                    section: 'selfAssessment',
                    statement: statement,
                    rating: parseInt(rating),
                    timestamp: new Date().toISOString()
                };
            }
        });
        
        studentResponses[topicKey].metadata.lastUpdated = new Date().toISOString();
        saveResponses();
        
        return studentResponses[topicKey];
    }
    
    function buildResponseKey(textarea) {
        const section = textarea.dataset.section || 'unknown';
        const bloomLevel = textarea.dataset.bloomLevel || '';
        const soloLevel = textarea.dataset.soloLevel || '';
        const questionIndex = textarea.dataset.questionIndex || '0';
        const questionType = textarea.dataset.questionType || '';
        
        let key = section;
        if (bloomLevel) key += `-${bloomLevel}`;
        if (soloLevel) key += `-${soloLevel}`;
        if (questionType) key += `-${questionType}`;
        key += `-q${questionIndex}`;
        
        return key;
    }
    
    function getQuestionStem(textarea) {
        // Try to find the question stem near this textarea
        const card = textarea.closest('.question-card');
        if (card) {
            const stem = card.querySelector('.question-stem');
            if (stem) return stem.textContent;
        }
        
        const item = textarea.closest('.think-about-item, .reflection-item');
        if (item) {
            const p = item.querySelector('p');
            if (p) return p.textContent;
        }
        
        const parent = textarea.closest('div');
        if (parent) {
            const label = parent.querySelector('label');
            if (label) return label.textContent;
        }
        
        return '';
    }
    
    // Prepare submission data for teaching staff
    function prepareSubmission() {
        collectResponses();
        
        const topicKey = getTopicKey();
        const topicData = studentResponses[topicKey];
        
        if (!topicData || Object.keys(topicData.responses).length === 0) {
            showToast('No responses to submit yet', 'warning');
            return null;
        }
        
        // Format for submission
        const submission = {
            student: {
                // In a real app, this would come from authentication
                id: 'student-' + Date.now(),
                submittedAt: new Date().toISOString()
            },
            topic: topicData.metadata,
            responses: Object.entries(topicData.responses).map(([key, data]) => ({
                id: key,
                ...data
            })),
            summary: {
                totalResponses: Object.keys(topicData.responses).length,
                sections: [...new Set(Object.values(topicData.responses).map(r => r.section))]
            }
        };
        
        return submission;
    }
    
    // Submit responses (placeholder - would connect to real backend)
    function submitResponses() {
        const submission = prepareSubmission();
        
        if (!submission) return;
        
        // For now, just log to console and show success
        console.log('ðŸ“¤ Submission prepared for teaching staff:', submission);
        console.log('ðŸ“‹ Formatted JSON:', JSON.stringify(submission, null, 2));
        
        // In a real implementation, this would POST to an API
        // fetch('/api/submit', { method: 'POST', body: JSON.stringify(submission) })
        
        showToast(`âœ“ ${submission.summary.totalResponses} responses ready for submission`, 'success');
        
        // Show a modal with the submission summary
        showSubmissionModal(submission);
    }
    
    function showSubmissionModal(submission) {
        // Create modal
        const modal = document.createElement('div');
        modal.className = 'submission-modal-overlay';
        modal.innerHTML = `
            <div class="submission-modal">
                <div class="submission-modal-header">
                    <h3>ðŸ“ Responses Ready for Submission</h3>
                    <button class="close-submission-modal">&times;</button>
                </div>
                <div class="submission-modal-body">
                    <p style="margin-bottom: 1rem;"><strong>Topic:</strong> ${submission.topic.topicTitle}</p>
                    <p style="margin-bottom: 1rem;"><strong>Total Responses:</strong> ${submission.summary.totalResponses}</p>
                    <p style="margin-bottom: 1rem;"><strong>Sections Covered:</strong> ${submission.summary.sections.join(', ')}</p>
                    
                    <details style="margin-top: 1rem;">
                        <summary style="cursor: pointer; color: var(--accent-primary); font-weight: 500;">View All Responses</summary>
                        <div style="margin-top: 0.75rem; max-height: 300px; overflow-y: auto; padding: 0.75rem; background: var(--bg-tertiary); border-radius: var(--radius-md); font-family: var(--font-mono); font-size: 0.8rem;">
                            <pre style="white-space: pre-wrap; word-break: break-word;">${JSON.stringify(submission.responses, null, 2)}</pre>
                        </div>
                    </details>
                </div>
                <div class="submission-modal-footer">
                    <button class="btn-secondary close-submission-modal">Close</button>
                    <button class="btn-primary" onclick="copySubmissionToClipboard()">Copy JSON</button>
                </div>
            </div>
        `;
        
        document.body.appendChild(modal);
        
        // Store for clipboard copy
        window._lastSubmission = submission;
        
        // Add event listeners
        modal.querySelectorAll('.close-submission-modal').forEach(btn => {
            btn.addEventListener('click', () => modal.remove());
        });
        
        modal.addEventListener('click', (e) => {
            if (e.target === modal) modal.remove();
        });
    }
    
    window.copySubmissionToClipboard = function() {
        if (window._lastSubmission) {
            navigator.clipboard.writeText(JSON.stringify(window._lastSubmission, null, 2))
                .then(() => showToast('Copied to clipboard!', 'success'))
                .catch(() => showToast('Could not copy', 'error'));
        }
    };
    
    // Auto-save responses as user types
    function setupAutoSave() {
        document.addEventListener('input', (e) => {
            if (e.target.classList.contains('response-field')) {
                // Debounce save
                clearTimeout(window._autoSaveTimeout);
                window._autoSaveTimeout = setTimeout(() => {
                    collectResponses();
                }, 1000);
            }
        });
    }
    
    // Load saved responses into fields when content loads
    function restoreResponses() {
        const topicKey = getTopicKey();
        const saved = studentResponses[topicKey];
        
        if (!saved || !saved.responses) return;
        
        // Restore textarea values
        document.querySelectorAll('.response-field').forEach(textarea => {
            const key = buildResponseKey(textarea);
            if (saved.responses[key]) {
                textarea.value = saved.responses[key].value;
            }
        });
        
        // Restore rating selections
        Object.entries(saved.responses).forEach(([key, data]) => {
            if (key.startsWith('rating-') && data.rating) {
                document.querySelectorAll('.rating-row').forEach(row => {
                    const statement = row.querySelector('.rating-statement')?.textContent || '';
                    if (key.includes(statement.substring(0, 30).replace(/\s+/g, '-'))) {
                        const btn = row.querySelector(`.rating-btn[data-rating="${data.rating}"]`);
                        if (btn) btn.classList.add('selected');
                    }
                });
            }
        });
    }
    
    // ============================================
    // INITIALIZE
    // ============================================
    loadSavedResponses();
    setupAutoSave();
    init();
    </script>
</body>
</html>