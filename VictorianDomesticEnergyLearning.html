<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Victorian Household Energy - learning materials</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #eff6ff 0%, #ffffff 100%);
            padding: 1rem;
            min-height: 100vh;
        }

        .container {
            max-width: 1024px;
            margin: 0 auto;
        }

        .header {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1.5rem;
            margin-bottom: 1.5rem;
            border-top: 4px solid #2563eb;
        }

        .header h1 {
            color: #1e3a8a;
            font-size: 2rem;
            text-align: center;
            margin-bottom: 0.5rem;
        }

        .header .student-name {
            text-align: center;
            color: #4b5563;
            margin-top: 0.5rem;
        }

        .tabs {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            margin-bottom: 1.5rem;
        }

        .tab-buttons {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .tab-button {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 0.5rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s;
            background: #f3f4f6;
            color: #374151;
        }

        .tab-button:hover:not(:disabled) {
            background: #e5e7eb;
        }

        .tab-button.active {
            background: #2563eb;
            color: white;
        }

        .tab-button:disabled {
            background: #e5e7eb;
            color: #9ca3af;
            cursor: not-allowed;
        }

        .content {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-bottom: 1.5rem;
            min-height: 400px;
        }

        .navigation {
            background: white;
            border-radius: 0.5rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .nav-button {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            background: #2563eb;
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .nav-button:hover:not(:disabled) {
            background: #1d4ed8;
        }

        .nav-button:disabled {
            background: #d1d5db;
            cursor: not-allowed;
        }

        .page-title {
            color: #4b5563;
            font-weight: 500;
        }

        h2 {
            color: #1e3a8a;
            font-size: 1.5rem;
            margin-bottom: 1rem;
        }

        h3 {
            color: #1e3a8a;
            font-size: 1.25rem;
            margin-bottom: 0.75rem;
        }

        .info-box {
            background: #eff6ff;
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
        }

        .info-box label {
            display: block;
            font-weight: 500;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        input[type="text"] {
            width: 100%;
            padding: 0.5rem 1rem;
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            font-size: 1rem;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #2563eb;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .statement-item {
            display: flex;
            align-items: start;
            gap: 0.75rem;
            padding: 1rem;
            background: white;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            margin-bottom: 0.75rem;
            transition: all 0.2s;
        }

        .statement-item:hover {
            border-color: #93c5fd;
        }

        @keyframes softPulse {
            0%, 100% { box-shadow: 0 0 8px rgba(234, 179, 8, 0.4); }
            50% { box-shadow: 0 0 20px rgba(234, 179, 8, 0.8); }
        }

        .statement-item.unchecked {
            animation: softPulse 3s ease-in-out infinite;
        }

        .statement-item.correct {
            border-color: #22c55e;
            background: #f0fdf4;
        }

        .statement-item input[type="checkbox"] {
            margin-top: 0.25rem;
            width: 1.25rem;
            height: 1.25rem;
            pointer-events: none;
        }

        .statement-text {
            flex: 1;
            color: #374151;
            line-height: 1.6;
        }

        .statement-text.checked {
            color: #15803d;
            font-weight: 600;
        }

        .statement-select {
            margin: 0 0.25rem;
            padding: 0.25rem 0.75rem;
            border: 2px solid #93c5fd;
            border-radius: 0.25rem;
            font-size: 1rem;
            background: white;
            cursor: pointer;
        }

        .statement-select:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .statement-select.correct {
            border-color: #22c55e;
            background: #f0fdf4;
            color: #15803d;
            font-weight: 600;
        }

        .external-link {
            padding: 0.25rem;
            color: #2563eb;
            cursor: pointer;
            border-radius: 0.25rem;
            transition: all 0.2s;
            flex-shrink: 0;
        }

        .external-link:hover {
            color: #1d4ed8;
            background: #eff6ff;
        }

        .cloze-text {
            background: white;
            padding: 1.5rem;
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            line-height: 1.8;
            color: #1f2937;
        }

        .cloze-select {
            margin: 0 0.25rem;
            padding: 0.25rem 0.75rem;
            border: 2px solid #93c5fd;
            border-radius: 0.25rem;
            font-size: 1rem;
        }

        .cloze-select:focus {
            outline: none;
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .cloze-select.correct {
            border-color: #22c55e;
            background: #f0fdf4;
        }

        .cloze-select.incorrect {
            border-color: #9ca3af;
            background: #f9fafb;
        }

        .button-primary {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 0.5rem;
            background: #2563eb;
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: background 0.2s;
        }

        .button-primary:hover {
            background: #1d4ed8;
        }

        .error-message {
            background: #fef2f2;
            border: 2px solid #ef4444;
            padding: 1rem;
            border-radius: 0.5rem;
            color: #991b1b;
            font-weight: 600;
            margin: 1rem 0;
        }

        .success-message {
            background: #f0fdf4;
            border: 2px solid #22c55e;
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
        }

        .warning-message {
            background: #fff7ed;
            border: 2px solid #f97316;
            padding: 1.5rem;
            border-radius: 0.5rem;
            margin: 1rem 0;
        }

        .completion-box {
            background: #eff6ff;
            border: 4px solid #93c5fd;
            padding: 2rem;
            border-radius: 0.5rem;
            text-align: center;
            margin: 2rem 0;
        }

        .completion-keyword {
            font-size: 3rem;
            font-weight: bold;
            color: #1e3a8a;
            margin: 1rem 0;
        }

        .icon {
            width: 1.25rem;
            height: 1.25rem;
            display: inline-block;
        }

        .icon-large {
            width: 6rem;
            height: 6rem;
            color: #22c55e;
        }

        .hidden {
            display: none;
        }

        ul {
            list-style: disc;
            margin-left: 1.5rem;
        }

        li {
            margin: 0.5rem 0;
            color: #374151;
        }

        @media (max-width: 768px) {
            body {
                padding: 0.5rem;
            }
            
            .header h1 {
                font-size: 1.5rem;
            }
            
            .content {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1>Energy Audit Learning Module</h1>
            <div id="student-name-display" class="student-name"></div>
        </div>

        <!-- Tab Navigation -->
        <div class="tabs">
            <div class="tab-buttons" id="tab-buttons"></div>
        </div>

        <!-- Main Content -->
        <div class="content" id="main-content"></div>

        <!-- Navigation -->
        <div class="navigation">
            <button class="nav-button" id="prev-button">
                <span>←</span>
                <span>Previous</span>
            </button>
            <span class="page-title" id="page-title"></span>
            <button class="nav-button" id="next-button">
                <span>Next</span>
                <span>→</span>
            </button>
        </div>
    </div>

    <script>
        // State management
        let state = {
            currentPage: 0,
            studentName: '',
            statementAnswers: {}, // Track answers for each statement
            clozeAttempts: [],
            currentClozeVersion: 0,
            clozeAnswers: {},
            clozeSubmitted: false,
            clozeScore: null,
            completionKeyword: '',
            isCompleted: false,
            keysPressed: { q: false, w: false, e: false },
            statementOrder: {}, // Store randomized order for each section
            optionOrder: {}, // Store randomized option order for each statement
            clozeOptionOrder: {}, // Store randomized option order for cloze blanks
            showingSummary: false // Track if showing summary page
        };

        const rhymingWords = [
            'array', 'bay', 'bouquet', 'café', 'day', 'display', 'essay', 'gateway',
            'halfway', 'hay', 'highway', 'hooray', 'may', 'okay', 'pay', 'play',
            'relay', 'replay', 'soufflé', 'stay', 'survey', 'sway', 'today', 'way',
            'holiday', 'birthday', 'buffet', 'gourmet', 'ballet', 'parquet'
        ];

        // Learning content with cloze-style statements
        const learningContent = [
            {
                title: "1. Energy Fundamentals",
                items: [
                    {
                        text: "Energy is the ability to do [BLANK] or cause change",
                        correct: "work",
                        distractors: ["tasks", "jobs"]
                    },
                    {
                        text: "Energy cannot be created or destroyed, only [BLANK] (Law of Conservation of Energy)",
                        correct: "transformed",
                        distractors: ["redistributed", "concentrated"]
                    },
                    {
                        text: "Different forms of energy: thermal (heat), electrical, [BLANK] (in fuels), kinetic (movement)",
                        correct: "chemical",
                        distractors: ["mechanical", "radiant"]
                    },
                    {
                        text: "[BLANK] is the standard unit for measuring household energy",
                        correct: "Kilowatt-hour",
                        distractors: ["Megajoule", "Calorie"]
                    },
                    {
                        text: "1 kWh = [BLANK] watts used for 1 hour",
                        correct: "1,000",
                        distractors: ["100", "10,000"]
                    },
                    {
                        text: "A typical Australian home uses [BLANK] kWh per day of electricity",
                        correct: "15-20",
                        distractors: ["5-10", "50-100"]
                    },
                    {
                        text: "Fuels contain different amounts of [BLANK] per unit",
                        correct: "energy",
                        distractors: ["volume", "atoms"]
                    },
                    {
                        text: "Energy conversion: fuels convert to [BLANK] or motion, electricity converts to heat/light/motion",
                        correct: "heat",
                        distractors: ["power", "force"]
                    },
                    {
                        text: "Efficiency matters: some conversions waste more energy than others (usually as [BLANK])",
                        correct: "heat",
                        distractors: ["light", "noise"]
                    }
                ]
            },
            {
                title: "2. Household Energy Sources",
                items: [
                    {
                        text: "Electricity is generated at [BLANK] (coal, gas, wind, solar, hydro)",
                        correct: "power stations",
                        distractors: ["substations", "transformers"]
                    },
                    {
                        text: "Victorian grid electricity comes primarily from [BLANK] (high emissions)",
                        correct: "brown coal",
                        distractors: ["natural gas", "diesel generators"]
                    },
                    {
                        text: "Electricity is delivered to homes through the electrical [BLANK]",
                        correct: "grid",
                        distractors: ["meter", "switchboard"]
                    },
                    {
                        text: "Electricity is used for: lighting, appliances, cooling, some [BLANK] and hot water",
                        correct: "heating",
                        distractors: ["ventilation", "entertainment"]
                    },
                    {
                        text: "Natural gas is a [BLANK] extracted from underground and piped to homes",
                        correct: "fossil fuel",
                        distractors: ["natural resource", "compound"]
                    },
                    {
                        text: "Natural gas is used for: [BLANK], hot water, and cooking",
                        correct: "heating",
                        distractors: ["electricity generation", "transport"]
                    },
                    {
                        text: "Natural gas contains approximately [BLANK] kWh of energy per cubic meter",
                        correct: "10",
                        distractors: ["50", "100"]
                    },
                    {
                        text: "Petrol and diesel are refined from [BLANK] and contain high energy density",
                        correct: "crude oil",
                        distractors: ["natural gas", "coal"]
                    },
                    {
                        text: "1 liter of petrol contains approximately [BLANK] kWh of energy",
                        correct: "8.9",
                        distractors: ["2.5", "25"]
                    },
                    {
                        text: "[BLANK] use electricity, hybrids use both electricity and petrol",
                        correct: "Electric vehicles",
                        distractors: ["Diesel vehicles", "Hydrogen vehicles"]
                    }
                ]
            },
            {
                title: "3. Major Energy Users in Homes",
                items: [
                    {
                        text: "The Big Three account for [BLANK]% of household energy consumption",
                        correct: "85-90",
                        distractors: ["50-60", "95-100"]
                    },
                    {
                        text: "Heating and cooling uses [BLANK]% of total household energy",
                        correct: "40-60",
                        distractors: ["10-20", "70-80"]
                    },
                    {
                        text: "Different heating systems have different [BLANK] levels",
                        correct: "efficiency",
                        distractors: ["noise", "installation"]
                    },
                    {
                        text: "[BLANK] (reverse cycle) are more efficient than resistive electric heaters",
                        correct: "Heat pumps",
                        distractors: ["Gas heaters", "Oil heaters"]
                    },
                    {
                        text: "Building [BLANK] dramatically affects heating/cooling needs",
                        correct: "insulation",
                        distractors: ["design", "materials"]
                    },
                    {
                        text: "Transport uses [BLANK]% of household energy",
                        correct: "30-40",
                        distractors: ["10-20", "60-70"]
                    },
                    {
                        text: "One tank of petrol (50L) contains about [BLANK] kWh of energy",
                        correct: "445",
                        distractors: ["45", "4,450"]
                    },
                    {
                        text: "Reducing one weekly [BLANK] saves more energy than eliminating standby power",
                        correct: "car trip",
                        distractors: ["appliance cycle", "light bulb"]
                    },
                    {
                        text: "Hot water uses [BLANK]% of household energy",
                        correct: "15-20",
                        distractors: ["5-10", "40-50"]
                    },
                    {
                        text: "A 10-minute shower uses more energy than leaving a [BLANK] on for 10 hours",
                        correct: "TV",
                        distractors: ["lamp", "computer"]
                    },
                    {
                        text: "Cooking uses only [BLANK]% of household energy",
                        correct: "3-5",
                        distractors: ["10-15", "20-25"]
                    },
                    {
                        text: "Lighting uses only [BLANK]% of household energy",
                        correct: "2-3",
                        distractors: ["10-15", "20-25"]
                    },
                    {
                        text: "Standby power uses approximately [BLANK]% of household energy",
                        correct: "3",
                        distractors: ["15", "25"]
                    },
                    {
                        text: "Small changes to [BLANK] energy users save more than big changes to small users",
                        correct: "big",
                        distractors: ["minor", "expensive"]
                    }
                ]
            },
            {
                title: "4. Carbon Dioxide Emissions",
                items: [
                    {
                        text: "CO₂ is a [BLANK] that traps heat in Earth's atmosphere",
                        correct: "greenhouse gas",
                        distractors: ["pollutant", "compound"]
                    },
                    {
                        text: "Burning fossil fuels releases CO₂ that was stored [BLANK]",
                        correct: "underground",
                        distractors: ["in the ocean", "in trees"]
                    },
                    {
                        text: "Different fuels produce different amounts of [BLANK] per unit of energy",
                        correct: "CO₂",
                        distractors: ["smoke", "noise"]
                    },
                    {
                        text: "Victorian grid electricity: [BLANK] kg CO₂ per kWh (high due to brown coal)",
                        correct: "0.86",
                        distractors: ["0.086", "8.6"]
                    },
                    {
                        text: "Natural gas: [BLANK] kg CO₂ per kWh",
                        correct: "0.186",
                        distractors: ["0.86", "1.86"]
                    },
                    {
                        text: "Petrol: [BLANK] kg CO₂ per kWh",
                        correct: "0.259",
                        distractors: ["0.086", "2.59"]
                    },
                    {
                        text: "Electricity in Victoria has [BLANK] emissions than other states due to brown coal",
                        correct: "higher",
                        distractors: ["older", "cheaper"]
                    },
                    {
                        text: "Total emissions = (energy used) × ([BLANK])",
                        correct: "emission factor",
                        distractors: ["carbon price", "electricity tariff"]
                    },
                    {
                        text: "Average Victorian household: approximately [BLANK] kg CO₂ per year",
                        correct: "7,500",
                        distractors: ["750", "75,000"]
                    }
                ]
            },
            {
                title: "5. Energy Efficiency Concepts",
                items: [
                    {
                        text: "Heat naturally flows from [BLANK] to cold",
                        correct: "hot",
                        distractors: ["outside", "inside"]
                    },
                    {
                        text: "Insulation slows [BLANK] between inside and outside",
                        correct: "heat transfer",
                        distractors: ["temperature change", "weather impact"]
                    },
                    {
                        text: "Types of insulation: [BLANK] (most important), walls, double glazing",
                        correct: "ceiling",
                        distractors: ["floor", "door"]
                    },
                    {
                        text: "[BLANK] measures insulation effectiveness (higher is better)",
                        correct: "R-value",
                        distractors: ["Thermal rating", "Efficiency score"]
                    },
                    {
                        text: "Draft sealing prevents [BLANK] that waste energy",
                        correct: "air leaks",
                        distractors: ["moisture problems", "heat loss"]
                    },
                    {
                        text: "[BLANK] indicate appliance efficiency",
                        correct: "Star ratings",
                        distractors: ["Energy labels", "Performance scores"]
                    },
                    {
                        text: "More efficient appliances do the same job with less [BLANK]",
                        correct: "energy",
                        distractors: ["maintenance", "space"]
                    },
                    {
                        text: "Heat pumps [BLANK] heat rather than generating it (more efficient)",
                        correct: "move",
                        distractors: ["amplify", "regulate"]
                    },
                    {
                        text: "[BLANK] are more efficient than gas or electric resistance cooking",
                        correct: "Induction cooktops",
                        distractors: ["Microwave ovens", "Slow cookers"]
                    }
                ]
            },
            {
                title: "6. Building Design and Efficiency",
                items: [
                    {
                        text: "Building [BLANK] affects efficiency: modern homes built to higher standards",
                        correct: "age",
                        distractors: ["orientation", "value"]
                    },
                    {
                        text: "Dwelling [BLANK] matters: larger spaces require more energy to heat/cool",
                        correct: "size",
                        distractors: ["age", "type"]
                    },
                    {
                        text: "Dwelling type affects energy: [BLANK] share walls (less heat loss)",
                        correct: "apartments",
                        distractors: ["townhouses", "units"]
                    },
                    {
                        text: "[BLANK] uses sun, shade, and ventilation to reduce energy needs",
                        correct: "Passive design",
                        distractors: ["Smart technology", "Green building"]
                    },
                    {
                        text: "[BLANK] is the most cost-effective energy improvement",
                        correct: "Ceiling insulation",
                        distractors: ["Wall insulation", "Window sealing"]
                    },
                    {
                        text: "Wall insulation provides additional [BLANK]",
                        correct: "energy savings",
                        distractors: ["structural support", "sound dampening"]
                    },
                    {
                        text: "[BLANK] reduce heat transfer significantly",
                        correct: "Double glazed windows",
                        distractors: ["Heavy curtains", "Window films"]
                    },
                    {
                        text: "Good draft sealing can reduce heating/cooling energy by [BLANK]%",
                        correct: "10-15",
                        distractors: ["1-2", "50-60"]
                    }
                ]
            },
            {
                title: "7. Renewable Energy",
                items: [
                    {
                        text: "Solar photovoltaic (PV) systems convert [BLANK] directly into electricity",
                        correct: "sunlight",
                        distractors: ["heat", "wind"]
                    },
                    {
                        text: "Solar systems are measured in [BLANK] of capacity",
                        correct: "kilowatts",
                        distractors: ["megawatts", "watts"]
                    },
                    {
                        text: "A typical 5kW system produces approximately [BLANK] kWh per year in Victoria",
                        correct: "5,500",
                        distractors: ["500", "55,000"]
                    },
                    {
                        text: "[BLANK] means using solar energy in your home",
                        correct: "Self-consumption",
                        distractors: ["Solar generation", "Grid independence"]
                    },
                    {
                        text: "Excess solar energy can be [BLANK] to the grid",
                        correct: "exported",
                        distractors: ["sold", "transferred"]
                    },
                    {
                        text: "[BLANK] stores excess solar energy for later use",
                        correct: "Battery storage",
                        distractors: ["The electrical grid", "Hot water tank"]
                    },
                    {
                        text: "Batteries increase [BLANK] of solar energy",
                        correct: "self-consumption",
                        distractors: ["total output", "panel lifespan"]
                    },
                    {
                        text: "Batteries are measured in [BLANK] of storage capacity",
                        correct: "kilowatt-hours",
                        distractors: ["kilowatts", "megawatt-hours"]
                    },
                    {
                        text: "[BLANK] is a voluntary program where electricity comes from renewable sources",
                        correct: "GreenPower",
                        distractors: ["CleanEnergy", "RenewableChoice"]
                    },
                    {
                        text: "GreenPower only affects [BLANK], not gas or transport fuels",
                        correct: "grid electricity",
                        distractors: ["all energy use", "heating systems"]
                    }
                ]
            },
            {
                title: "8. Energy Calculations and Analysis",
                items: [
                    {
                        text: "Energy = Power × [BLANK]",
                        correct: "Time",
                        distractors: ["Distance", "Mass"]
                    },
                    {
                        text: "Annual consumption = Daily use × [BLANK] days",
                        correct: "365",
                        distractors: ["360", "350"]
                    },
                    {
                        text: "[BLANK] = Total energy ÷ Number of people",
                        correct: "Per capita consumption",
                        distractors: ["Average consumption", "Total consumption"]
                    },
                    {
                        text: "[BLANK] shows how much above or below average you are",
                        correct: "Percentage difference",
                        distractors: ["Standard deviation", "Mean variance"]
                    },
                    {
                        text: "Multiple factors affect energy use: size, age, occupants, [BLANK]",
                        correct: "behavior",
                        distractors: ["location", "climate"]
                    },
                    {
                        text: "[BLANK]: each factor multiplies the base consumption",
                        correct: "Multiplier effects",
                        distractors: ["Compound increases", "Exponential growth"]
                    },
                    {
                        text: "Trade-offs exist: gas heating uses more total energy but may cost [BLANK]",
                        correct: "less",
                        distractors: ["nothing", "the same"]
                    },
                    {
                        text: "Victorian average household uses about [BLANK] kWh per year total",
                        correct: "21,096",
                        distractors: ["2,109", "210,960"]
                    },
                    {
                        text: "Victorian average household produces about [BLANK] kg CO₂ per year",
                        correct: "7,500",
                        distractors: ["750", "75,000"]
                    }
                ]
            },
            {
                title: "9. Sustainable Behaviors",
                items: [
                    {
                        text: "Thermostat management: [BLANK]°C change makes a significant difference to energy use",
                        correct: "2",
                        distractors: ["10", "0.5"]
                    },
                    {
                        text: "Reducing [BLANK] and vehicle kilometers has high energy impact",
                        correct: "car trips",
                        distractors: ["driving speed", "fuel costs"]
                    },
                    {
                        text: "Shorter [BLANK] reduce hot water energy (a major energy user)",
                        correct: "showers",
                        distractors: ["wash cycles", "rinse times"]
                    },
                    {
                        text: "Using [BLANK] for washing clothes saves hot water energy",
                        correct: "cold water",
                        distractors: ["quick cycles", "eco mode"]
                    },
                    {
                        text: "[BLANK] instead of using a dryer saves electricity",
                        correct: "Air-drying clothes",
                        distractors: ["Ironing clothes", "Folding clothes"]
                    },
                    {
                        text: "Closing curtains/blinds retains heat in [BLANK] and blocks sun in summer",
                        correct: "winter",
                        distractors: ["evening", "morning"]
                    },
                    {
                        text: "Turning off lights saves energy but has [BLANK] impact than the Big Three",
                        correct: "lower",
                        distractors: ["slower", "delayed"]
                    },
                    {
                        text: "Switching off standby power saves energy but has lower impact than the [BLANK]",
                        correct: "Big Three",
                        distractors: ["main switch", "solar system"]
                    },
                    {
                        text: "Focus on [BLANK] behaviors first for maximum energy savings",
                        correct: "high-impact",
                        distractors: ["easy", "free"]
                    }
                ]
            },
            {
                title: "10. Transport Energy and Systems Thinking",
                items: [
                    {
                        text: "Vehicle [BLANK] matters: larger vehicles use more fuel per kilometer",
                        correct: "size",
                        distractors: ["age", "weight"]
                    },
                    {
                        text: "[BLANK] are most common with moderate efficiency",
                        correct: "Petrol vehicles",
                        distractors: ["Diesel vehicles", "Sedan cars"]
                    },
                    {
                        text: "[BLANK] combine petrol and electric for better efficiency",
                        correct: "Hybrid vehicles",
                        distractors: ["Modern engines", "Fuel injectors"]
                    },
                    {
                        text: "Plug-in hybrids (PHEV) can use [BLANK] for part of travel",
                        correct: "grid electricity",
                        distractors: ["diesel fuel", "hydrogen"]
                    },
                    {
                        text: "Electric vehicles (EV) use only electricity with zero [BLANK] emissions",
                        correct: "direct",
                        distractors: ["measured", "visible"]
                    },
                    {
                        text: "[BLANK] reduces transport energy consumption",
                        correct: "Working from home",
                        distractors: ["Buying local goods", "Using cruise control"]
                    },
                    {
                        text: "[BLANK] uses far less energy per person than private vehicles",
                        correct: "Public transport",
                        distractors: ["Ride sharing", "Carpooling"]
                    },
                    {
                        text: "Home energy, transport energy, and emissions are all [BLANK]",
                        correct: "interconnected",
                        distractors: ["increasing", "measurable"]
                    },
                    {
                        text: "Changes in one area affect the total household [BLANK]",
                        correct: "energy footprint",
                        distractors: ["power consumption", "carbon output"]
                    },
                    {
                        text: "[BLANK]: consider energy over the entire lifetime of products",
                        correct: "Life cycle thinking",
                        distractors: ["Product warranties", "Maintenance schedules"]
                    },
                    {
                        text: "Solar panels save more energy over their [BLANK] than they cost to make",
                        correct: "lifetime",
                        distractors: ["installation", "warranty"]
                    },
                    {
                        text: "Perfect solutions don't exist, but [BLANK] matter for sustainability",
                        correct: "informed choices",
                        distractors: ["expensive upgrades", "government policies"]
                    }
                ]
            }
        ];

        const clozeActivities = [
            {
                text: "Energy is the ability to do work and cannot be created or destroyed, only BLANK from one form to another. In Victorian homes, understanding BLANK consumption patterns is essential for reducing environmental impact. The three biggest energy users account for 85-90% of total BLANK. Heating and cooling systems use 40-60% of household energy, making them the largest BLANK in most homes. Different heating systems have different BLANK levels, with heat pumps being more efficient than resistive electric heaters. Transport accounts for 30-40% of household energy, and reducing vehicle BLANK can have a significant impact. One tank of petrol contains approximately 445 kWh of BLANK, which is enormous compared to daily household electricity use. Hot water systems are responsible for 15-20% of household energy BLANK. The type of hot water system and shower BLANK significantly affect energy use. When we burn fossil fuels like coal, gas, or petrol, we release carbon BLANK into the atmosphere. Victorian grid electricity produces 0.86 kg of CO₂ per kWh because it comes primarily from brown BLANK. To reduce energy use, insulation materials like ceiling and wall BLANK slow heat transfer between inside and outside. The R-value measures insulation BLANK, with higher values indicating better performance. Building BLANK affects efficiency, with modern homes built to higher standards than older ones. Star BLANK help consumers identify more efficient appliances that do the same job with less energy. Solar photovoltaic systems convert BLANK directly into electricity for household use. A typical 5kW system BLANK approximately 5,500 kWh per year in Victoria. Battery storage increases self-BLANK of solar energy by storing excess generation. Making behavioral BLANK like reducing thermostat temperature by 2°C can significantly impact household energy consumption and reduce environmental impact.",
                answers: ['transformed', 'energy', 'consumption', 'consumer', 'efficiency', 'kilometers', 'energy', 'consumption', 'duration', 'dioxide', 'coal', 'insulation', 'effectiveness', 'age', 'ratings', 'sunlight', 'produces', 'consumption', 'changes', 'climate'],
                options: [
                    ['transformed', 'converted', 'changed', 'transferred'],
                    ['energy', 'power', 'electricity', 'consumption'],
                    ['consumption', 'usage', 'demand', 'requirements'],
                    ['consumer', 'user', 'appliance', 'system'],
                    ['efficiency', 'performance', 'capacity', 'effectiveness'],
                    ['kilometers', 'distance', 'travel', 'journeys'],
                    ['energy', 'power', 'fuel', 'resources'],
                    ['consumption', 'usage', 'demand', 'requirements'],
                    ['duration', 'length', 'time', 'period'],
                    ['dioxide', 'emissions', 'gases', 'pollutants'],
                    ['coal', 'fuel', 'resources', 'energy'],
                    ['insulation', 'materials', 'barriers', 'protection'],
                    ['effectiveness', 'performance', 'efficiency', 'quality'],
                    ['age', 'design', 'construction', 'condition'],
                    ['ratings', 'labels', 'standards', 'certifications'],
                    ['sunlight', 'radiation', 'light', 'energy'],
                    ['produces', 'generates', 'creates', 'provides'],
                    ['consumption', 'usage', 'utilization', 'adoption'],
                    ['changes', 'adjustments', 'modifications', 'improvements'],
                    ['climate', 'environment', 'atmosphere', 'planet']
                ]
            },
            {
                text: "The kilowatt-hour (kWh) is the standard BLANK for measuring household energy consumption. One kWh equals 1,000 BLANK used for one hour, making it easier to calculate energy costs. Different energy BLANK produce different amounts of emissions when burned or used. Natural gas contains approximately 10 kWh of energy per cubic BLANK and is commonly used for heating. Transport fuels like petrol contain even more energy BLANK, with one liter containing 8.9 kWh. However, this convenience comes at an environmental BLANK in terms of carbon emissions. The average Victorian household produces approximately 7,500 kg of CO₂ per BLANK. To calculate total emissions, we multiply energy used by the emission BLANK for each fuel type. Grid electricity in Victoria has higher BLANK than other states due to brown coal power generation. Building design significantly affects energy BLANK, with modern homes built to higher efficiency standards. Dwelling BLANK matters because larger spaces require more energy to heat and cool. Dwelling type also affects BLANK: apartments share walls which reduces heat loss. Passive BLANK uses sun, shade, and ventilation to reduce energy needs naturally. Star ratings on BLANK help consumers identify more efficient models that save energy. Heat pumps are more BLANK than electric resistance heaters because they move heat rather than generate it. Induction cooktops provide better BLANK transfer than gas or standard electric cooking surfaces. Working from home reduces transport energy by eliminating daily BLANK to work or school. Public BLANK uses far less energy per person than private vehicles for the same journey. Life cycle BLANK considers energy over the entire lifetime of products and systems. Understanding these BLANK helps us make informed decisions about reducing our household energy footprint.",
                answers: ['unit', 'watts', 'sources', 'meter', 'density', 'cost', 'year', 'factor', 'emissions', 'needs', 'size', 'efficiency', 'design', 'appliances', 'efficient', 'energy', 'commutes', 'transport', 'thinking', 'concepts'],
                options: [
                    ['unit', 'measure', 'standard', 'system'],
                    ['watts', 'units', 'volts', 'joules'],
                    ['sources', 'types', 'fuels', 'systems'],
                    ['meter', 'unit', 'volume', 'measure'],
                    ['density', 'content', 'concentration', 'capacity'],
                    ['cost', 'price', 'impact', 'consequence'],
                    ['year', 'month', 'period', 'season'],
                    ['factor', 'rate', 'coefficient', 'multiplier'],
                    ['emissions', 'pollution', 'output', 'impact'],
                    ['needs', 'requirements', 'demands', 'consumption'],
                    ['size', 'area', 'dimensions', 'scale'],
                    ['efficiency', 'performance', 'insulation', 'design'],
                    ['design', 'architecture', 'planning', 'construction'],
                    ['appliances', 'devices', 'equipment', 'products'],
                    ['efficient', 'effective', 'economical', 'productive'],
                    ['energy', 'heat', 'power', 'warmth'],
                    ['commutes', 'trips', 'journeys', 'travels'],
                    ['transport', 'transit', 'travel', 'transportation'],
                    ['thinking', 'analysis', 'consideration', 'assessment'],
                    ['concepts', 'principles', 'ideas', 'factors']
                ]
            },
            {
                text: "Victorian households can reduce their energy consumption through various BLANK and improvements. Installing ceiling insulation is often the most cost-effective BLANK, potentially reducing heating energy by 15%. Wall insulation and double glazed BLANK provide additional savings by reducing heat transfer. Heat naturally flows from hot to cold, and good draft BLANK prevents air leaks that waste energy unnecessarily. For hot water, which accounts for 15-20% of household BLANK, switching systems can provide major savings. Heat pump hot water systems can reduce consumption by approximately 65% compared to electric BLANK systems. Solar hot water systems use renewable BLANK from the sun to heat water with minimal emissions. In transport, electric vehicles (EVs) use only BLANK with zero direct emissions at the point of use. Hybrid vehicles combine petrol and electric for better fuel BLANK compared to conventional vehicles. Plug-in hybrids (PHEV) can use grid electricity for part of their daily BLANK. Working from home reduces transport energy by eliminating the need for daily vehicle BLANK. Public transport uses far less energy per BLANK than private vehicles covering the same distance. Solar photovoltaic systems offer another path to BLANK, converting sunlight into electricity for household use. Excess solar energy can be stored in BLANK for use during evening hours when generation stops. Battery capacity is measured in kilowatt-hours, with larger BLANK storing more energy for later use. GreenPower programs allow households to source renewable BLANK through their electricity retailer. Making high-impact behavioral changes, such as reducing vehicle kilometers or managing BLANK settings, provides greater savings. Closing curtains and blinds helps retain BLANK in winter and block solar gain in summer. Understanding the interconnection between home energy, transport, and BLANK helps identify the most effective improvement strategies for each household.",
                answers: ['strategies', 'improvement', 'windows', 'sealing', 'energy', 'storage', 'energy', 'electricity', 'economy', 'travel', 'trips', 'passenger', 'sustainability', 'batteries', 'batteries', 'electricity', 'thermostat', 'heat', 'emissions', 'footprint'],
                options: [
                    ['strategies', 'methods', 'approaches', 'techniques'],
                    ['improvement', 'upgrade', 'investment', 'modification'],
                    ['windows', 'glazing', 'panes', 'glass'],
                    ['sealing', 'proofing', 'blocking', 'stopping'],
                    ['energy', 'consumption', 'usage', 'demand'],
                    ['storage', 'tank', 'cylinder', 'container'],
                    ['energy', 'heat', 'radiation', 'warmth'],
                    ['electricity', 'power', 'energy', 'current'],
                    ['economy', 'efficiency', 'consumption', 'performance'],
                    ['travel', 'driving', 'journeys', 'commuting'],
                    ['trips', 'journeys', 'commutes', 'travels'],
                    ['passenger', 'person', 'traveler', 'commuter'],
                    ['sustainability', 'efficiency', 'conservation', 'independence'],
                    ['batteries', 'systems', 'units', 'devices'],
                    ['batteries', 'systems', 'capacities', 'units'],
                    ['electricity', 'power', 'energy', 'supply'],
                    ['thermostat', 'heating', 'temperature', 'climate'],
                    ['heat', 'warmth', 'temperature', 'energy'],
                    ['emissions', 'pollution', 'footprint', 'impact'],
                    ['footprint', 'impact', 'consumption', 'usage']
                ]
            }
        ];

        // Load state from localStorage
        function loadState() {
            const saved = localStorage.getItem('year8EnergyLearning');
            if (saved) {
                const data = JSON.parse(saved);
                state = { ...state, ...data };
            }
            
            // Initialize randomization on first load (if not already saved)
            if (!state.statementOrder || Object.keys(state.statementOrder).length === 0) {
                initializeRandomization();
            }
        }

        // Initialize randomized orders for statements and options
        function initializeRandomization() {
            // Randomize statement order for each section
            learningContent.forEach((section, sectionIndex) => {
                const indices = section.items.map((_, i) => i);
                state.statementOrder[sectionIndex] = shuffleArray([...indices]);
            });
            
            // Randomize option order for each statement
            learningContent.forEach((section, sectionIndex) => {
                section.items.forEach((item, itemIndex) => {
                    const key = `${sectionIndex}-${itemIndex}`;
                    const options = [item.correct, ...item.distractors];
                    state.optionOrder[key] = shuffleArray([...options]);
                });
            });
            
            // Randomize option order for each cloze activity blank
            clozeActivities.forEach((cloze, clozeIndex) => {
                cloze.options.forEach((optionSet, blankIndex) => {
                    const key = `${clozeIndex}-${blankIndex}`;
                    state.clozeOptionOrder[key] = shuffleArray([...optionSet]);
                });
            });
            
            saveState();
        }

        // Fisher-Yates shuffle algorithm
        function shuffleArray(array) {
            const shuffled = [...array];
            for (let i = shuffled.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
            }
            return shuffled;
        }

        // Save state to localStorage
        function saveState() {
            localStorage.setItem('year8EnergyLearning', JSON.stringify(state));
        }

        // Initialize
        loadState();
        renderTabs();
        renderPage();
        updateNavigation();

        // Debug mode: Q+W+E
        document.addEventListener('keydown', (e) => {
            const key = e.key.toLowerCase();
            if (key === 'q' || key === 'w' || key === 'e') {
                state.keysPressed[key] = true;
                if (state.keysPressed.q && state.keysPressed.w && state.keysPressed.e) {
                    activateDebugMode();
                }
            }
        });

        document.addEventListener('keyup', (e) => {
            const key = e.key.toLowerCase();
            if (key === 'q' || key === 'w' || key === 'e') {
                state.keysPressed[key] = false;
            }
        });

        function activateDebugMode() {
            // Fill all statement answers with correct values
            learningContent.forEach((section, sectionIndex) => {
                section.items.forEach((item, itemIndex) => {
                    const key = `${sectionIndex}-${itemIndex}`;
                    state.statementAnswers[key] = item.correct;
                });
            });

            // Fill cloze with correct answers
            if (state.currentPage === 11 && !state.clozeSubmitted) {
                const currentCloze = clozeActivities[state.currentClozeVersion];
                currentCloze.answers.forEach((answer, index) => {
                    state.clozeAnswers[index] = answer;
                });
            }

            saveState();
            renderPage();
            renderTabs();
        }

        function openChatGPT(statement) {
            const query = encodeURIComponent(`Give me more detailed information about: ${statement}`);
            window.open(`https://chatgpt.com/?q=${query}`, '_blank');
        }

        function renderTabs() {
            const container = document.getElementById('tab-buttons');
            container.innerHTML = '';
            
            const totalPages = 13;
            const labels = ['Start', '1', '2', '3', '4', '5', '6', '7', '8', '9', '10', 'Test', 'Utils'];
            
            for (let i = 0; i < totalPages; i++) {
                const button = document.createElement('button');
                button.className = 'tab-button';
                button.textContent = labels[i];
                
                if (i === state.currentPage) {
                    button.classList.add('active');
                }
                
                const isTestPage = i === 11;
                const canAccessTest = areAllStatementsCorrect();
                if (isTestPage && !canAccessTest) {
                    button.disabled = true;
                    button.title = 'Complete all learning sections first';
                }
                
                button.addEventListener('click', () => {
                    if (!button.disabled) {
                        state.currentPage = i;
                        saveState();
                        renderPage();
                        renderTabs();
                        updateNavigation();
                    }
                });
                
                container.appendChild(button);
            }
        }

        function renderPage() {
            const content = document.getElementById('main-content');
            const studentDisplay = document.getElementById('student-name-display');
            
            if (state.studentName) {
                studentDisplay.textContent = `Student: ${state.studentName}`;
            } else {
                studentDisplay.textContent = '';
            }
            
            if (state.currentPage === 0) {
                content.innerHTML = renderWelcomePage();
                attachWelcomeListeners();
            } else if (state.currentPage <= 10) {
                content.innerHTML = renderLearningPage(state.currentPage - 1);
                attachLearningPageListeners();
            } else if (state.currentPage === 11) {
                if (state.isCompleted && state.showingSummary) {
                    content.innerHTML = renderSummaryPage();
                    attachSummaryListeners();
                } else {
                    content.innerHTML = renderClozePage();
                    attachClozeListeners();
                }
            } else if (state.currentPage === 12) {
                content.innerHTML = renderUtilitiesPage();
                attachUtilitiesListeners();
            }
        }

        function renderWelcomePage() {
            return `
                <h2>Preparing for Your Energy Audit</h2>
                <p style="color: #374151; margin-bottom: 1.5rem;">
                    This interactive module will teach you about household energy use, carbon emissions, and sustainability.
                    Complete all 10 learning sections by selecting the correct answer for each statement, then pass the cloze activity to finish.
                </p>
                
                <div class="info-box">
                    <label>Your Name</label>
                    <input type="text" id="student-name-input" value="${state.studentName}" placeholder="Enter your name">
                </div>

                <div style="background: white; border: 2px solid #bfdbfe; padding: 1.5rem; border-radius: 0.5rem;">
                    <h3>Instructions:</h3>
                    <ul>
                        <li><strong>Learning Sections (1-10):</strong> Read each statement carefully and select the correct word from the dropdown menu. The checkbox will automatically check when you choose the correct answer.</li>
                        <li><strong>Navigation:</strong> Use arrow buttons or tab buttons to move between sections. You can navigate freely and return to any section at any time.</li>
                        <li><strong>External Links:</strong> Click the arrow icon (→) next to any statement to learn more about that topic via ChatGPT.</li>
                        <li><strong>Cloze Test:</strong> Once all learning sections are complete, take the cloze activity. You need 70% or higher to pass (3 attempts allowed).</li>
                        <li><strong>Review Answers:</strong> After submitting the test, you'll see which answers were correct or incorrect. Review them before continuing.</li>
                        <li><strong>Completion:</strong> When you pass, you'll receive a unique keyword to show your teacher and can view/print a complete learning summary.</li>
                        <li><strong>Progress Saved:</strong> Your progress is automatically saved on this browser and device. To continue on a different browser or device, use the Utilities tab to export your progress and import it on the other browser/device.</li>
                        <li><strong>Export/Import:</strong> Use the Utilities tab to export your progress to a file or import previously saved progress from another browser or device.</li>
                    </ul>
                </div>
            `;
        }

        function attachWelcomeListeners() {
            const nameInput = document.getElementById('student-name-input');
            if (nameInput) {
                nameInput.addEventListener('input', (e) => {
                    state.studentName = e.target.value;
                    saveState();
                    document.getElementById('student-name-display').textContent = 
                        state.studentName ? `Student: ${state.studentName}` : '';
                });
            }
        }

        function renderLearningPage(sectionIndex) {
            const section = learningContent[sectionIndex];
            let html = `<h2>${section.title}</h2><div style="margin-top: 1rem;">`;
            
            // Get the randomized order for this section
            const itemOrder = state.statementOrder[sectionIndex] || section.items.map((_, i) => i);
            
            // Render items in randomized order
            itemOrder.forEach((itemIndex) => {
                const item = section.items[itemIndex];
                const key = `${sectionIndex}-${itemIndex}`;
                const selectedAnswer = state.statementAnswers[key] || '';
                const isCorrect = selectedAnswer === item.correct;
                
                // Get the randomized options for this statement
                const options = state.optionOrder[key] || [item.correct, ...item.distractors];
                
                // Build the statement with dropdown
                const textParts = item.text.split('[BLANK]');
                let statementHTML = textParts[0];
                
                if (textParts.length > 1) {
                    const selectClass = isCorrect ? 'correct' : '';
                    statementHTML += `<select class="statement-select ${selectClass}" data-section="${sectionIndex}" data-item="${itemIndex}">
                        <option value="">Select...</option>`;
                    
                    options.forEach(option => {
                        statementHTML += `<option value="${option}" ${selectedAnswer === option ? 'selected' : ''}>${option}</option>`;
                    });
                    
                    statementHTML += `</select>`;
                    statementHTML += textParts[1];
                }
                
                const itemClass = isCorrect ? 'correct' : 'unchecked';
                
                html += `
                    <div class="statement-item ${itemClass}">
                        <input type="checkbox" ${isCorrect ? 'checked' : ''} disabled>
                        <span class="statement-text ${isCorrect ? 'checked' : ''}">
                            ${statementHTML}
                        </span>
                        <span class="external-link" data-text="${item.text.replace(/\[BLANK\]/g, item.correct).replace(/"/g, '&quot;')}">
                            <svg class="icon" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                            </svg>
                        </span>
                    </div>
                `;
            });
            
            html += '</div>';
            return html;
        }

        function attachLearningPageListeners() {
            // Statement select listeners
            const selects = document.querySelectorAll('.statement-select');
            selects.forEach(select => {
                select.addEventListener('change', (e) => {
                    const sectionIndex = parseInt(select.dataset.section);
                    const itemIndex = parseInt(select.dataset.item);
                    const key = `${sectionIndex}-${itemIndex}`;
                    
                    state.statementAnswers[key] = e.target.value;
                    saveState();
                    renderPage();
                    renderTabs();
                });
            });
            
            // External link listeners
            const links = document.querySelectorAll('.external-link');
            links.forEach(link => {
                link.addEventListener('click', (e) => {
                    e.preventDefault();
                    e.stopPropagation();
                    const text = link.dataset.text;
                    openChatGPT(text);
                });
            });
        }

        function renderClozePage() {
            if (state.isCompleted && !state.showingSummary) {
                return renderCompletionPage();
            }

            if (!areAllStatementsCorrect()) {
                return `
                    <h2>Cloze Activity Locked</h2>
                    <div class="warning-message">
                        <p style="font-size: 1.125rem; font-weight: 600; color: #c2410c; margin-bottom: 0.5rem;">
                            Complete All Learning Sections First
                        </p>
                        <p style="color: #374151;">
                            You must correctly answer all statements in sections 1-10 before you can access the cloze activity.
                            Return to the learning pages and complete all statements.
                        </p>
                    </div>
                    <div style="text-align: center; margin-top: 2rem;">
                        <button class="button-primary" onclick="goToPage(1)">Go to Section 1</button>
                    </div>
                `;
            }

            const currentCloze = clozeActivities[state.currentClozeVersion];
            const textParts = currentCloze.text.split('BLANK');
            
            let html = `
                <h2>Cloze Activity - Version ${state.currentClozeVersion + 1}</h2>
                
                <div class="info-box">
                    <p style="font-size: 0.875rem; color: #374151;">
                        <strong>Attempt:</strong> ${state.clozeAttempts.length + 1} of 3 | 
                        <strong style="margin-left: 1rem;">Required Score:</strong> 70% or higher
                    </p>
                </div>
            `;
            
            if (state.clozeSubmitted && state.clozeScore !== null) {
                const passed = state.clozeScore >= 70;
                html += `
                    <div class="${passed ? 'success-message' : 'warning-message'}">
                        <p style="font-size: 1.25rem; font-weight: bold; margin-bottom: 0.5rem;">
                            Score: ${state.clozeScore.toFixed(0)}%
                        </p>
                        <p style="color: #374151;">
                            ${passed
                                ? 'Excellent work! You have passed the activity. Review your answers below.'
                                : 'You need 70% to pass. Review the correct answers below before the next attempt.'
                            }
                        </p>
                    </div>
                `;
            }
            
            html += '<div id="submit-error"></div>';
            html += '<div class="cloze-text">';
            
            textParts.forEach((part, index) => {
                html += part;
                if (index < currentCloze.answers.length) {
                    const selectedValue = state.clozeAnswers[index] || '';
                    const correctAnswer = currentCloze.answers[index];
                    const isCorrect = selectedValue === correctAnswer;
                    
                    // Get randomized options for this blank
                    const clozeKey = `${state.currentClozeVersion}-${index}`;
                    const options = state.clozeOptionOrder[clozeKey] || currentCloze.options[index];
                    
                    // Show dropdown if not submitted, or show correct answer with visual feedback if submitted
                    if (!state.clozeSubmitted) {
                        html += `<select class="cloze-select" data-index="${index}">
                            <option value="">Select...</option>`;
                        
                        options.forEach(option => {
                            html += `<option value="${option}" ${selectedValue === option ? 'selected' : ''}>${option}</option>`;
                        });
                        
                        html += '</select>';
                    } else {
                        // Show the answer with color coding
                        const cssClass = isCorrect ? 'correct' : 'incorrect';
                        html += `<span class="cloze-select ${cssClass}" style="display: inline-block; padding: 0.25rem 0.75rem; border-radius: 0.25rem; font-weight: 600;">`;
                        
                        if (isCorrect) {
                            html += `${selectedValue} ✓`;
                        } else {
                            html += `<span style="text-decoration: line-through;">${selectedValue || '(empty)'}</span> → ${correctAnswer}`;
                        }
                        
                        html += '</span>';
                    }
                }
            });
            
            html += '</div>';
            
            if (!state.clozeSubmitted) {
                html += `
                    <div style="display: flex; justify-content: flex-end; margin-top: 1.5rem;">
                        <button class="button-primary" id="submit-cloze">Submit Answers</button>
                    </div>
                `;
            } else {
                // Show continue button after reviewing
                const passed = state.clozeScore >= 70;
                if (passed) {
                    html += `
                        <div style="display: flex; justify-content: center; margin-top: 2rem;">
                            <button class="button-primary" id="continue-after-pass" style="background: #16a34a; font-size: 1.125rem; padding: 1rem 2rem;">
                                Continue to Completion
                            </button>
                        </div>
                    `;
                } else {
                    html += `
                        <div style="display: flex; justify-content: center; margin-top: 2rem;">
                            <button class="button-primary" id="continue-to-next-attempt" style="background: #ea580c; font-size: 1.125rem; padding: 1rem 2rem;">
                                ${state.clozeAttempts.length < 3 ? 'Continue to Next Attempt' : 'View Results'}
                            </button>
                        </div>
                    `;
                }
            }
            
            return html;
        }

        function attachClozeListeners() {
            const selects = document.querySelectorAll('.cloze-select');
            selects.forEach(select => {
                select.addEventListener('change', (e) => {
                    const index = parseInt(select.dataset.index);
                    state.clozeAnswers[index] = e.target.value;
                    saveState();
                    
                    const errorDiv = document.getElementById('submit-error');
                    if (errorDiv) errorDiv.innerHTML = '';
                });
            });
            
            const submitBtn = document.getElementById('submit-cloze');
            if (submitBtn) {
                submitBtn.addEventListener('click', submitCloze);
            }
            
            const continuePassBtn = document.getElementById('continue-after-pass');
            if (continuePassBtn) {
                continuePassBtn.addEventListener('click', () => {
                    completeActivity();
                    state.showingSummary = false;
                    renderPage();
                });
            }
            
            const continueNextBtn = document.getElementById('continue-to-next-attempt');
            if (continueNextBtn) {
                continueNextBtn.addEventListener('click', () => {
                    if (state.clozeAttempts.length >= 3) {
                        // All attempts used, complete anyway
                        completeActivity();
                        state.showingSummary = false;
                        renderPage();
                    } else {
                        // Go to next attempt - reset cloze and stay on test page
                        resetCloze();
                        saveState();
                        renderPage();
                        attachClozeListeners();
                    }
                });
            }
            
            const viewSummaryBtn = document.getElementById('view-summary-btn');
            if (viewSummaryBtn) {
                viewSummaryBtn.addEventListener('click', () => {
                    state.showingSummary = true;
                    saveState();
                    renderPage();
                    updateNavigation();
                });
            }
        }

        function attachSummaryListeners() {
            const printBtn = document.getElementById('print-summary-btn');
            if (printBtn) {
                printBtn.addEventListener('click', () => {
                    window.print();
                });
            }
            
            const backBtn = document.getElementById('back-to-completion-btn');
            if (backBtn) {
                backBtn.addEventListener('click', () => {
                    state.showingSummary = false;
                    saveState();
                    renderPage();
                    updateNavigation();
                });
            }
        }

        function submitCloze() {
            const currentCloze = clozeActivities[state.currentClozeVersion];
            
            // Check all dropdowns filled
            let allFilled = true;
            for (let i = 0; i < currentCloze.answers.length; i++) {
                if (!state.clozeAnswers[i]) {
                    allFilled = false;
                    break;
                }
            }
            
            if (!allFilled) {
                const errorDiv = document.getElementById('submit-error');
                if (errorDiv) {
                    errorDiv.innerHTML = '<div class="error-message">Please complete all dropdown menus before submitting.</div>';
                }
                return;
            }
            
            let correct = 0;
            currentCloze.answers.forEach((answer, index) => {
                if (state.clozeAnswers[index] === answer) {
                    correct++;
                }
            });
            
            const percentage = (correct / currentCloze.answers.length) * 100;
            state.clozeScore = percentage;
            state.clozeSubmitted = true;
            state.clozeAttempts.push({ version: state.currentClozeVersion, score: percentage });
            
            saveState();
            renderPage();
            attachClozeListeners();
        }

        function completeActivity() {
            const keyword = rhymingWords[Math.floor(Math.random() * rhymingWords.length)];
            state.completionKeyword = keyword;
            state.isCompleted = true;
            saveState();
        }

        function resetCloze() {
            state.clozeAnswers = {};
            state.clozeSubmitted = false;
            state.clozeScore = null;
            state.currentClozeVersion = (state.currentClozeVersion + 1) % 3;
        }

        function renderCompletionPage() {
            return `
                <div style="text-align: center;">
                    <svg class="icon-large" style="margin: 0 auto; display: block;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                    </svg>
                    
                    <h2 style="margin-top: 1.5rem;">Congratulations!</h2>
                    
                    <p style="font-size: 1.25rem; color: #374151; margin: 1.5rem 0;">
                        ${state.studentName ? `${state.studentName}, you have` : 'You have'} completed the Energy Learning Module!
                    </p>

                    <div class="completion-box">
                        <p style="font-size: 0.875rem; color: #4b5563; margin-bottom: 0.5rem;">Show this keyword to your teacher:</p>
                        <p class="completion-keyword">${state.completionKeyword}</p>
                        <p style="font-size: 0.875rem; color: #6b7280; margin-top: 0.5rem;">Completion Keyword</p>
                    </div>

                    <div style="background: white; border: 2px solid #e5e7eb; padding: 1.5rem; border-radius: 0.5rem; margin-top: 2rem;">
                        <h3>Your Performance:</h3>
                        <div style="margin-top: 1rem; text-align: left;">
                            ${state.clozeAttempts.map((attempt, index) => 
                                `<p style="color: #374151; margin: 0.5rem 0;">Attempt ${index + 1} (Version ${attempt.version + 1}): ${attempt.score.toFixed(0)}%</p>`
                            ).join('')}
                        </div>
                    </div>

                    <div style="margin-top: 2rem;">
                        <button class="button-primary" id="view-summary-btn" style="font-size: 1.125rem; padding: 1rem 2rem;">
                            📄 View Learning Summary
                        </button>
                    </div>
                </div>
            `;
        }

        function renderSummaryPage() {
            let summaryHTML = `
                <div style="max-width: 800px; margin: 0 auto;">
                    <div style="text-align: center; margin-bottom: 2rem; padding-bottom: 1rem; border-bottom: 3px solid #2563eb;">
                        <h2 style="color: #1e3a8a; font-size: 2rem; margin-bottom: 0.5rem;">Energy Learning Summary</h2>
                        ${state.studentName ? `<p style="font-size: 1.125rem; color: #374151;"><strong>Student:</strong> ${state.studentName}</p>` : ''}
                        <p style="color: #6b7280; font-size: 0.875rem;">Completed: ${new Date().toLocaleDateString()}</p>
                        <p style="color: #16a34a; font-weight: 600; font-size: 1rem; margin-top: 0.5rem;">Completion Code: ${state.completionKeyword}</p>
                    </div>

                    <div style="margin-bottom: 2rem; text-align: center;">
                        <button class="button-primary" id="print-summary-btn" style="margin-right: 1rem;">
                            🖨️ Print Summary
                        </button>
                        <button class="button-primary" id="back-to-completion-btn" style="background: #6b7280;">
                            ← Back to Results
                        </button>
                    </div>

                    <div id="summary-content" style="background: white; padding: 2rem; border-radius: 0.5rem; border: 1px solid #e5e7eb;">
            `;

            // Add each section's content
            learningContent.forEach((section, sectionIndex) => {
                summaryHTML += `
                    <div style="margin-bottom: 2rem;">
                        <h3 style="color: #1e3a8a; font-size: 1.25rem; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid #93c5fd;">
                            ${section.title}
                        </h3>
                        <ul style="list-style: disc; margin-left: 1.5rem; line-height: 1.8;">
                `;

                section.items.forEach((item) => {
                    const statementText = item.text.replace('[BLANK]', `<strong>${item.correct}</strong>`);
                    summaryHTML += `<li style="margin-bottom: 0.5rem; color: #374151;">${statementText}</li>`;
                });

                summaryHTML += `
                        </ul>
                    </div>
                `;
            });

            summaryHTML += `
                    </div>

                    <div style="text-align: center; margin-top: 2rem; padding-top: 1rem; border-top: 2px solid #e5e7eb; color: #6b7280; font-size: 0.875rem;">
                        <p>Energy Learning Module - Victorian Household Energy Audit Tool</p>
                        <p>Preparing for Your Energy Audit</p>
                    </div>
                </div>
            `;

            return summaryHTML;
        }

        function renderUtilitiesPage() {
            return `
                <h2>Data Utilities</h2>

                <div style="background: white; border: 2px solid #bfdbfe; padding: 1.5rem; border-radius: 0.5rem; margin: 1rem 0;">
                    <h3>Student Name</h3>
                    <input type="text" id="util-student-name" value="${state.studentName}" placeholder="Enter your name">
                </div>

                <div style="background: white; border: 2px solid #bfdbfe; padding: 1.5rem; border-radius: 0.5rem; margin: 1rem 0;">
                    <h3>Export Data</h3>
                    <p style="color: #374151; margin-bottom: 1rem;">Download your progress as a file</p>
                    <button class="button-primary" id="export-btn">
                        Export Data
                    </button>
                </div>

                <div style="background: white; border: 2px solid #bfdbfe; padding: 1.5rem; border-radius: 0.5rem; margin: 1rem 0;">
                    <h3>Import Data</h3>
                    <p style="color: #374151; margin-bottom: 1rem;">Load previously saved progress</p>
                    <label class="button-primary" style="cursor: pointer; display: inline-block;">
                        Import Data
                        <input type="file" id="import-file" accept=".json" style="display: none;">
                    </label>
                    <div id="import-message" style="margin-top: 1rem;"></div>
                </div>

                <div style="background: white; border: 2px solid #fecaca; padding: 1.5rem; border-radius: 0.5rem; margin: 1rem 0;">
                    <h3 style="color: #b91c1c;">Reset All Data</h3>
                    <p style="color: #374151; margin-bottom: 1rem;">Clear all progress and start over (cannot be undone)</p>
                    <button class="button-primary" id="reset-btn" style="background: #dc2626;">
                        Reset Everything
                    </button>
                    <div id="reset-message" style="margin-top: 1rem;"></div>
                </div>
            `;
        }

        function attachUtilitiesListeners() {
            const nameInput = document.getElementById('util-student-name');
            if (nameInput) {
                nameInput.addEventListener('input', (e) => {
                    state.studentName = e.target.value;
                    saveState();
                    document.getElementById('student-name-display').textContent = 
                        state.studentName ? `Student: ${state.studentName}` : '';
                });
            }
            
            const exportBtn = document.getElementById('export-btn');
            if (exportBtn) {
                exportBtn.addEventListener('click', () => {
                    const data = {
                        studentName: state.studentName,
                        statementAnswers: state.statementAnswers,
                        clozeAttempts: state.clozeAttempts,
                        currentClozeVersion: state.currentClozeVersion,
                        isCompleted: state.isCompleted,
                        completionKeyword: state.completionKeyword,
                        exportDate: new Date().toISOString()
                    };
                    
                    const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `energy-learning-${state.studentName || 'student'}-${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    URL.revokeObjectURL(url);
                });
            }
            
            const importFile = document.getElementById('import-file');
            if (importFile) {
                importFile.addEventListener('change', (e) => {
                    const file = e.target.files[0];
                    if (!file) return;
                    
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        try {
                            const data = JSON.parse(event.target.result);
                            state.studentName = data.studentName || '';
                            state.statementAnswers = data.statementAnswers || {};
                            state.clozeAttempts = data.clozeAttempts || [];
                            state.currentClozeVersion = data.currentClozeVersion || 0;
                            state.isCompleted = data.isCompleted || false;
                            state.completionKeyword = data.completionKeyword || '';
                            saveState();
                            
                            document.getElementById('import-message').innerHTML = 
                                '<div style="background: #f0fdf4; color: #166534; padding: 0.75rem; border-radius: 0.5rem;">Data imported successfully!</div>';
                            setTimeout(() => {
                                document.getElementById('import-message').innerHTML = '';
                                renderPage();
                                renderTabs();
                            }, 3000);
                        } catch (error) {
                            document.getElementById('import-message').innerHTML = 
                                '<div style="background: #fef2f2; color: #991b1b; padding: 0.75rem; border-radius: 0.5rem;">Error importing data. Please check the file format.</div>';
                            setTimeout(() => {
                                document.getElementById('import-message').innerHTML = '';
                            }, 3000);
                        }
                    };
                    reader.readAsText(file);
                });
            }
            
            const resetBtn = document.getElementById('reset-btn');
            if (resetBtn) {
                let clickCount = 0;
                resetBtn.addEventListener('click', () => {
                    clickCount++;
                    if (clickCount === 1) {
                        resetBtn.textContent = 'Click Again to Confirm Reset';
                        resetBtn.style.background = '#ea580c';
                        setTimeout(() => {
                            clickCount = 0;
                            resetBtn.textContent = 'Reset Everything';
                            resetBtn.style.background = '#dc2626';
                        }, 5000);
                    } else {
                        localStorage.removeItem('year8EnergyLearning');
                        state = {
                            currentPage: 0,
                            studentName: '',
                            statementAnswers: {},
                            clozeAttempts: [],
                            currentClozeVersion: 0,
                            clozeAnswers: {},
                            clozeSubmitted: false,
                            clozeScore: null,
                            completionKeyword: '',
                            isCompleted: false,
                            keysPressed: { q: false, w: false, e: false },
                            statementOrder: {},
                            optionOrder: {},
                            clozeOptionOrder: {},
                            showingSummary: false
                        };
                        
                        // Re-initialize randomization after reset
                        initializeRandomization();
                        
                        document.getElementById('reset-message').innerHTML = 
                            '<div style="background: #f0fdf4; color: #166534; padding: 0.75rem; border-radius: 0.5rem;">All data has been reset!</div>';
                        setTimeout(() => {
                            document.getElementById('reset-message').innerHTML = '';
                            renderPage();
                            renderTabs();
                            updateNavigation();
                        }, 3000);
                    }
                });
            }
        }

        function areAllStatementsCorrect() {
            let totalStatements = 0;
            let correctCount = 0;
            
            learningContent.forEach((section, sectionIndex) => {
                section.items.forEach((item, itemIndex) => {
                    totalStatements++;
                    const key = `${sectionIndex}-${itemIndex}`;
                    if (state.statementAnswers[key] === item.correct) {
                        correctCount++;
                    }
                });
            });
            
            return correctCount === totalStatements;
        }

        function updateNavigation() {
            const prevBtn = document.getElementById('prev-button');
            const nextBtn = document.getElementById('next-button');
            const pageTitle = document.getElementById('page-title');
            
            prevBtn.disabled = state.currentPage === 0;
            nextBtn.disabled = state.currentPage === 12;
            
            const titles = [
                'Welcome',
                ...learningContent.map(s => s.title),
                state.showingSummary ? 'Learning Summary' : 'Cloze Activity',
                'Utilities'
            ];
            
            pageTitle.textContent = titles[state.currentPage];
        }

        function goToPage(page) {
            state.currentPage = page;
            saveState();
            renderPage();
            renderTabs();
            updateNavigation();
        }

        // Navigation button listeners
        document.getElementById('prev-button').addEventListener('click', () => {
            if (state.currentPage > 0) {
                state.currentPage--;
                saveState();
                renderPage();
                renderTabs();
                updateNavigation();
            }
        });

        document.getElementById('next-button').addEventListener('click', () => {
            const nextPage = state.currentPage + 1;
            if (nextPage === 11 && !areAllStatementsCorrect()) {
                return;
            }
            if (state.currentPage < 12) {
                state.currentPage++;
                saveState();
                renderPage();
                renderTabs();
                updateNavigation();
            }
        });
    </script>
</body>
</html>