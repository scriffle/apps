<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dynamic Kinematics Calculator</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            overflow-y: scroll;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            background-attachment: fixed;
            min-height: 100vh;
            padding: 8px;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.1);
            min-height: calc(100vh - 16px);
            display: flex;
            flex-direction: column;
        }

        .header {
            background: linear-gradient(135deg, #4CAF50, #45a049);
            color: white;
            padding: 10px;
            text-align: center;
        }

        .header h1 {
            font-size: 1.6em;
            margin-bottom: 3px;
            font-weight: 300;
        }

        .header p {
            font-size: 0.85em;
            opacity: 0.9;
        }

        .main-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
            padding: 12px;
            flex: 1;
            min-height: 0;
        }

        .left-column {
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 0;
        }

        .right-column {
            display: flex;
            flex-direction: column;
            gap: 12px;
            min-height: 0;
        }

        .input-section {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            flex-shrink: 0;
        }

        .input-section h2 {
            color: #495057;
            margin-bottom: 8px;
            font-size: 1.1em;
        }

        .input-group {
            display: flex;
            align-items: center;
            margin-bottom: 8px;
            gap: 10px;
        }

        .input-group label {
            flex: 1;
            font-weight: 600;
            color: #495057;
            font-size: 0.85em;
            min-width: 140px;
        }

        .input-group input[type="number"] {
            flex: 0 0 110px;
            padding: 6px 8px;
            border: 2px solid #dee2e6;
            border-radius: 6px;
            font-size: 0.85em;
            transition: all 0.3s ease;
            background: white;
        }
        
        .input-group .input-wrapper {
            display: flex;
            align-items: center;
            gap: 8px;
            flex: 0 0 110px;
        }
        
        .input-group .input-wrapper input[type="number"] {
            flex: 1;
        }

        .input-group input:focus {
            border-color: #4CAF50;
            outline: none;
            box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.1);
        }

        .input-group input.calculated {
            background: #e8f5e8;
            border-color: #4CAF50;
        }

        .input-group input.adjusted {
            background: #fff3cd;
            border-color: #ffc107;
        }

        .input-group input[type="checkbox"] {
            cursor: pointer;
            width: 16px;
            height: 16px;
            margin: 0;
            vertical-align: middle;
        }

        .input-group input[type="number"]:disabled {
            cursor: not-allowed;
            opacity: 0.8;
        }

        .equations-section {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            flex: 1;
            overflow-y: auto;
            max-height: 300px;
        }

        .equation {
            background: white;
            padding: 6px 10px;
            margin: 4px 0;
            border-radius: 6px;
            border-left: 4px solid #dee2e6;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            transition: all 0.3s ease;
        }

        .equation.active {
            border-left-color: #4CAF50;
            background: linear-gradient(90deg, #e8f5e8, white);
            transform: scale(1.02);
            box-shadow: 0 3px 10px rgba(76, 175, 80, 0.2);
        }

        .graph-container {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            flex-shrink: 0;
        }

        .graph-container h2 {
            color: #495057;
            margin-bottom: 8px;
            text-align: center;
            font-size: 1.1em;
        }

        .graphs {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .graph {
            background: white;
            border-radius: 6px;
            padding: 8px;
            text-align: center;
            border: 2px solid #e9ecef;
        }

        .graph h3 {
            margin-bottom: 6px;
            color: #495057;
            font-size: 0.85em;
        }

        .workings-section {
            background: #f8f9fa;
            padding: 12px;
            border-radius: 8px;
            border: 2px solid #e9ecef;
            flex: 1;
            overflow-y: auto;
            min-height: 200px;
            max-height: 400px;
        }

        .workings-section h2 {
            color: #495057;
            margin-bottom: 10px;
            font-size: 1.1em;
            position: sticky;
            top: 0;
            background: #f8f9fa;
            padding-bottom: 5px;
            border-bottom: 1px solid #e9ecef;
        }

        .workings-content {
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            line-height: 1.6;
        }

        .workings-step {
            margin-bottom: 12px;
            padding: 8px;
            background: white;
            border-radius: 4px;
            border: 1px solid #e9ecef;
        }

        .workings-step h4 {
            color: #495057;
            margin-bottom: 4px;
            font-size: 0.9em;
        }

        .workings-step .math {
            color: #000;
            margin: 2px 0;
            padding-left: 10px;
        }

        /* Math expression styling */
        .workings-step .op-add-sub {
            color: #00008b;
            font-weight: bold;
        }

        .workings-step .sign {
            color: #8b0000;
            font-weight: bold;
        }

        .status {
            background: #17a2b8;
            color: white;
            padding: 6px;
            border-radius: 6px;
            text-align: center;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 0.85em;
        }

        .status.success {
            background: #28a745;
        }

        .status.warning {
            background: #ffc107;
            color: #333;
        }

        .clear-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 6px 12px;
            border-radius: 5px;
            font-size: 0.8em;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 8px;
        }

        .clear-btn:hover {
            background: #c82333;
            transform: translateY(-1px);
        }

        .color-guide {
            background: #e9ecef;
            padding: 4px 8px;
            border-radius: 4px;
            margin-bottom: 6px;
            font-size: 0.75em;
        }

        .color-guide span {
            padding: 1px 4px;
            border-radius: 2px;
            margin: 0 2px;
        }

        /* Scrollbar styling */
        .equations-section::-webkit-scrollbar,
        .workings-section::-webkit-scrollbar {
            width: 8px;
        }

        .equations-section::-webkit-scrollbar-track,
        .workings-section::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 4px;
        }

        .equations-section::-webkit-scrollbar-thumb,
        .workings-section::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 4px;
        }

        .equations-section::-webkit-scrollbar-thumb:hover,
        .workings-section::-webkit-scrollbar-thumb:hover {
            background: #555;
        }

        @media (max-width: 768px) {
            .container {
                min-height: auto;
            }
            
            .main-content {
                grid-template-columns: 1fr;
            }
            
            .equations-section,
            .workings-section {
                max-height: none;
            }
            
            .graphs {
                flex-direction: row;
                overflow-x: auto;
            }

            .graph {
                min-width: 200px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Dynamic Kinematics Calculator</h1>
            <p>Enter any values and the system will adapt others to maintain valid physics</p>
        </div>

        <div class="main-content">
            <div class="left-column">
                <div id="status" class="status">Enter any 3 values to calculate the missing variables</div>
                
                <div class="input-section">
                    <h2>Variables</h2>
                    <div class="color-guide">
                        <strong>Color Guide:</strong> 
                        <span style="background: white;">Normal</span>
                        <span style="background: #e8f5e8;">Calculated</span>
                        <span style="background: #fff3cd;">Auto-adjusted</span>
                        <span style="background: #e3f2fd;">Gravity</span>
                    </div>
                    <div class="input-group">
                        <label for="u">Initial Velocity (u) - m/s</label>
                        <input type="number" id="u" step="any" placeholder="Enter u">
                    </div>
                    <div class="input-group">
                        <label for="v">Final Velocity (v) - m/s</label>
                        <input type="number" id="v" step="any" placeholder="Enter v">
                    </div>
                    <div class="input-group">
                        <label for="a">Acceleration (a) - m/s²</label>
                        <div class="input-wrapper">
                            <label style="flex: 0; margin: 0; font-weight: normal; font-size: 0.8em; display: flex; align-items: center; order: -1;">
                                <input type="checkbox" id="assumeG" style="margin-right: 4px; width: auto; flex: 0;">
                                <span style="white-space: nowrap;">g</span>
                            </label>
                            <input type="number" id="a" step="any" placeholder="Enter a">
                        </div>
                    </div>
                    <div class="input-group">
                        <label for="t">Time (t) - s</label>
                        <input type="number" id="t" step="any" placeholder="Enter t">
                    </div>
                    <div class="input-group">
                        <label for="s">Displacement (s) - m</label>
                        <input type="number" id="s" step="any" placeholder="Enter s">
                    </div>
                    <button class="clear-btn" onclick="clearAll()">Clear All</button>
                </div>

                <div class="equations-section">
                    <h2>Equations of Motion</h2>
                    <div class="equation" id="eq1">v = u + at</div>
                    <div class="equation" id="eq2">s = ut + ½at²</div>
                    <div class="equation" id="eq3">v² = u² + 2as</div>
                    <div class="equation" id="eq4">s = (u + v)t/2</div>
                    <div class="equation" id="eq5">s = vt - ½at²</div>
                    <div style="margin-top: 10px; padding: 8px; background: #e9ecef; border-radius: 4px; font-size: 0.8em; color: #6c757d;">
                        <strong>Note:</strong> The active equation used for calculation will be highlighted in green
                    </div>
                    <div style="margin-top: 10px; padding: 8px; background: #f0f8ff; border-radius: 4px; font-size: 0.8em; color: #495057;">
                        <strong>Additional Forms:</strong><br>
                        • Average velocity: v̄ = (u + v)/2<br>
                        • Average velocity: v̄ = s/t<br>
                        • Distance at nth second: sₙ = u + a(n - ½)
                    </div>
                </div>
            </div>

            <div class="right-column">
                <div class="graph-container">
                    <h2>Motion Graphs</h2>
                    <div class="graphs">
                        <div class="graph">
                            <h3>Displacement vs Time</h3>
                            <div style="position: relative; height: 100px;">
                                <canvas id="displacementGraph"></canvas>
                            </div>
                        </div>
                        <div class="graph">
                            <h3>Velocity vs Time</h3>
                            <div style="position: relative; height: 100px;">
                                <canvas id="velocityGraph"></canvas>
                            </div>
                        </div>
                        <div class="graph">
                            <h3>Acceleration vs Time</h3>
                            <div style="position: relative; height: 100px;">
                                <canvas id="accelerationGraph"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="workings-section">
                    <h2>Algebraic Workings</h2>
                    <div class="workings-content" id="workingsContent">
                        <div class="workings-step">
                            <h4>Enter at least 3 values to see step-by-step calculations</h4>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let values = { u: null, v: null, a: null, t: null, s: null };
        let calculated = new Set();
        let userEntered = new Set();
        let lastEntered = null;
        let updateTimeout = null;
        let lastEquationUsed = '';
        let calculationSteps = [];
        let gravityEnabled = false;
        const GRAVITY = -9.81;
        
        // Chart.js instances
        let displacementChart = null;
        let velocityChart = null;
        let accelerationChart = null;

        function updateStatus(message, type = 'info') {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
        }

        function clearAll() {
            values = { u: null, v: null, a: null, t: null, s: null };
            calculated.clear();
            userEntered.clear();
            lastEntered = null;
            gravityEnabled = false;
            
            if (updateTimeout) {
                clearTimeout(updateTimeout);
                updateTimeout = null;
            }
            
            ['u', 'v', 'a', 't', 's'].forEach(id => {
                const input = document.getElementById(id);
                input.value = '';
                input.classList.remove('calculated', 'adjusted');
                input.disabled = false;
                input.style.background = '';
            });
            
            document.getElementById('assumeG').checked = false;
            
            clearEquationHighlights();
            clearGraphs();
            clearWorkings();
            updateStatus('Enter any 3 values to calculate the missing variables');
        }

        function clearEquationHighlights() {
            document.querySelectorAll('.equation').forEach(eq => eq.classList.remove('active'));
        }

        function highlightEquation(eqId) {
            clearEquationHighlights();
            document.getElementById(eqId).classList.add('active');
        }

        function clearWorkings() {
            document.getElementById('workingsContent').innerHTML = `
                <div class="workings-step">
                    <h4>Enter at least 3 values to see step-by-step calculations</h4>
                </div>
            `;
        }

        function updateWorkings() {
            const content = document.getElementById('workingsContent');
            let html = '';

            calculationSteps.forEach(step => {
                html += `<div class="workings-step">${step}</div>`;
            });

            content.innerHTML = html || `
                <div class="workings-step">
                    <h4>Enter at least 3 values to see step-by-step calculations</h4>
                </div>
            `;
        }

        function formatNumber(num) {
            if (num === null || num === undefined) return 'unknown';
            return num.toFixed(3);
        }

        function formatMathExpression(expr) {
            // First, mark signs (+ or - that come after =, (, or at the start, or after ×, ÷)
            expr = expr.replace(/(^|[=(×÷])\s*([+-])/g, '$1<span class="sign">$2</span>');
            
            // Then mark operators (+ or - between values/variables)
            expr = expr.replace(/([^=(×÷])\s*([+-])\s*([^=])/g, '$1 <span class="op-add-sub">$2</span> $3');
            
            return expr;
        }

        function isValidNumber(value) {
            return value !== null && value !== '' && !isNaN(value) && isFinite(value);
        }

        function countValidInputs() {
            return Object.values(values).filter(isValidNumber).length;
        }

        function debouncedSolve() {
            if (updateTimeout) {
                clearTimeout(updateTimeout);
            }
            
            updateTimeout = setTimeout(() => {
                solve();
                updateTimeout = null;
            }, 1000);
        }

        function solve() {
            const { u, v, a, t, s } = values;
            calculated.clear();
            calculationSteps = [];

            ['u', 'v', 'a', 't', 's'].forEach(id => {
                document.getElementById(id).classList.remove('calculated', 'adjusted');
            });

            // If gravity is enabled, ensure a is always GRAVITY
            if (gravityEnabled) {
                values.a = GRAVITY;
            }

            const validCount = countValidInputs();

            if (validCount === 0) {
                updateStatus('Enter any 3 values to calculate the missing variables', 'info');
                clearEquationHighlights();
                clearWorkings();
                return;
            }

            if (validCount === 1 || validCount === 2) {
                updateStatus(`Enter ${3 - validCount} more value(s) to start calculations`, 'warning');
                clearEquationHighlights();
                clearWorkings();
                return;
            }

            if (validCount === 3) {
                solveStandard();
                return;
            }

            solveAdaptive();
        }

        function solveStandard() {
            const { u, v, a, t, s } = values;

            // Identify given and unknown variables
            const given = [];
            const unknown = [];
            
            ['u', 'v', 'a', 't', 's'].forEach(variable => {
                if (isValidNumber(values[variable])) {
                    if (variable === 'a' && gravityEnabled) {
                        given.push(`${variable} = g = ${formatNumber(values[variable])} m/s² (gravity)`);
                    } else {
                        given.push(`${variable} = ${formatNumber(values[variable])}`);
                    }
                } else {
                    unknown.push(variable);
                }
            });

            calculationSteps.push(`
                <h4>Step 1: Identify Variables</h4>
                <div class="math">Given: ${given.join(', ')}</div>
                <div class="math">Unknown: ${unknown.join(', ')}</div>
                <div style="margin-top: 8px; padding: 6px; background: #e8f5e8; border-radius: 4px; font-size: 0.85em;">
                    <strong>Note:</strong> Both unknowns will be calculated directly from the original given values to avoid error propagation.
                </div>
            `);

            // Solve based on which variables are known
            if (isValidNumber(u) && isValidNumber(v) && isValidNumber(t)) {
                if (!gravityEnabled || !isValidNumber(a)) {
                    calculationSteps.push(`
                        <h4>Step 2: Select Equation for Acceleration</h4>
                        <div class="math">${formatMathExpression('Using: v = u + at')}</div>
                        <div class="math">${formatMathExpression('Rearranging: a = (v - u) / t')}</div>
                    `);
                    
                    values.a = (v - u) / t;
                    
                    calculationSteps.push(`
                        <h4>Step 3: Calculate Acceleration</h4>
                        <div class="math">${formatMathExpression(`a = (${formatNumber(v)} - ${formatNumber(u)}) / ${formatNumber(t)}`)}</div>
                        <div class="math">${formatMathExpression(`a = ${formatNumber(v - u)} / ${formatNumber(t)}`)}</div>
                        <div class="math">${formatMathExpression(`a = ${formatNumber(values.a)}`)} m/s²</div>
                    `);
                    
                    if (!gravityEnabled) calculated.add('a');
                } else {
                    calculationSteps.push(`
                        <h4>Step 2: Acceleration is given (gravity)</h4>
                        <div class="math">${formatMathExpression(`a = g = ${formatNumber(values.a)}`)} m/s²</div>
                    `);
                }
                
                calculationSteps.push(`
                    <h4>Step ${gravityEnabled && isValidNumber(a) ? '3' : '4'}: Calculate Displacement</h4>
                    <div class="math">${formatMathExpression('Using the same original values with: s = ut + ½at²')}</div>
                    <div class="math">Where: ${formatMathExpression(`u = ${formatNumber(u)}, t = ${formatNumber(t)}, a = ${formatNumber(values.a)}`)}</div>
                    <div class="math">${formatMathExpression(`s = (${formatNumber(u)} × ${formatNumber(t)}) + (½ × ${formatNumber(values.a)} × ${formatNumber(t)}²)`)}</div>
                    <div class="math">${formatMathExpression(`s = ${formatNumber(u * t)} + ${formatNumber(0.5 * values.a * t * t)}`)}</div>
                `);
                
                values.s = u * t + 0.5 * values.a * t * t;
                
                calculationSteps.push(`
                    <div class="math">${formatMathExpression(`s = ${formatNumber(values.s)}`)} m</div>
                `);
                
                calculated.add('s');
                highlightEquation(gravityEnabled && isValidNumber(a) ? 'eq2' : 'eq1');
            }
            else if (isValidNumber(u) && isValidNumber(a) && isValidNumber(t)) {
                calculationSteps.push(`
                    <h4>Step 2: Select Equations</h4>
                    <div class="math">${formatMathExpression('For final velocity: v = u + at')}</div>
                    <div class="math">${formatMathExpression('For displacement: s = ut + ½at²')}</div>
                `);
                
                values.v = u + a * t;
                
                calculationSteps.push(`
                    <h4>Step 3: Calculate Final Velocity</h4>
                    <div class="math">Using original values: ${formatMathExpression(`u = ${formatNumber(u)}, a = ${formatNumber(a)}, t = ${formatNumber(t)}`)}</div>
                    <div class="math">${formatMathExpression(`v = ${formatNumber(u)} + (${formatNumber(a)} × ${formatNumber(t)})`)}</div>
                    <div class="math">${formatMathExpression(`v = ${formatNumber(u)} + ${formatNumber(a * t)}`)}</div>
                    <div class="math">${formatMathExpression(`v = ${formatNumber(values.v)}`)} m/s</div>
                `);
                
                values.s = u * t + 0.5 * a * t * t;
                
                calculationSteps.push(`
                    <h4>Step 4: Calculate Displacement</h4>
                    <div class="math">Using the same original values: ${formatMathExpression(`u = ${formatNumber(u)}, a = ${formatNumber(a)}, t = ${formatNumber(t)}`)}</div>
                    <div class="math">${formatMathExpression(`s = (${formatNumber(u)} × ${formatNumber(t)}) + (½ × ${formatNumber(a)} × ${formatNumber(t)}²)`)}</div>
                    <div class="math">${formatMathExpression(`s = ${formatNumber(u * t)} + ${formatNumber(0.5 * a * t * t)}`)}</div>
                    <div class="math">${formatMathExpression(`s = ${formatNumber(values.s)}`)} m</div>
                `);
                
                calculated.add('v').add('s');
                highlightEquation('eq2');
            }
            else if (isValidNumber(v) && isValidNumber(a) && isValidNumber(t)) {
                calculationSteps.push(`
                    <h4>Step 2: Select Equation</h4>
                    <div class="math">${formatMathExpression('Using: v = u + at')}</div>
                    <div class="math">${formatMathExpression('Rearranging: u = v - at')}</div>
                `);
                
                values.u = v - a * t;
                
                calculationSteps.push(`
                    <h4>Step 3: Calculate Initial Velocity</h4>
                    <div class="math">${formatMathExpression(`u = ${formatNumber(v)} - (${formatNumber(a)} × ${formatNumber(t)})`)}</div>
                    <div class="math">${formatMathExpression(`u = ${formatNumber(v)} - ${formatNumber(a * t)}`)}</div>
                    <div class="math">${formatMathExpression(`u = ${formatNumber(values.u)}`)} m/s</div>
                `);
                
                values.s = values.u * t + 0.5 * a * t * t;
                
                calculationSteps.push(`
                    <h4>Step 4: Calculate Displacement</h4>
                    <div class="math">${formatMathExpression('Using: s = ut + ½at²')}</div>
                    <div class="math">${formatMathExpression(`s = (${formatNumber(values.u)} × ${formatNumber(t)}) + (½ × ${formatNumber(a)} × ${formatNumber(t)}²)`)}</div>
                    <div class="math">${formatMathExpression(`s = ${formatNumber(values.u * t)} + ${formatNumber(0.5 * a * t * t)}`)}</div>
                    <div class="math">${formatMathExpression(`s = ${formatNumber(values.s)}`)} m</div>
                `);
                
                calculated.add('u').add('s');
                highlightEquation('eq1');
            }
            else if (isValidNumber(u) && isValidNumber(v) && isValidNumber(a)) {
                if (a !== 0) {
                    calculationSteps.push(`
                        <h4>Step 2: Select Equations</h4>
                        <div class="math">${formatMathExpression('For time: v = u + at → t = (v - u) / a')}</div>
                        <div class="math">${formatMathExpression('For displacement: v² = u² + 2as → s = (v² - u²) / (2a)')}</div>
                    `);
                    
                    values.t = (v - u) / a;
                    
                    calculationSteps.push(`
                        <h4>Step 3: Calculate Time</h4>
                        <div class="math">Using original values: ${formatMathExpression(`u = ${formatNumber(u)}, v = ${formatNumber(v)}, a = ${formatNumber(a)}`)}</div>
                        <div class="math">${formatMathExpression(`t = (${formatNumber(v)} - ${formatNumber(u)}) / ${formatNumber(a)}`)}</div>
                        <div class="math">${formatMathExpression(`t = ${formatNumber(v - u)} / ${formatNumber(a)}`)}</div>
                        <div class="math">${formatMathExpression(`t = ${formatNumber(values.t)}`)} s</div>
                    `);
                    
                    values.s = (v * v - u * u) / (2 * a);
                    
                    calculationSteps.push(`
                        <h4>Step 4: Calculate Displacement</h4>
                        <div class="math">Using the same original values: ${formatMathExpression(`u = ${formatNumber(u)}, v = ${formatNumber(v)}, a = ${formatNumber(a)}`)}</div>
                        <div class="math">${formatMathExpression('s = (v² - u²) / (2a)')}</div>
                        <div class="math">${formatMathExpression(`s = (${formatNumber(v)}² - ${formatNumber(u)}²) / (2 × ${formatNumber(a)})`)}</div>
                        <div class="math">${formatMathExpression(`s = (${formatNumber(v * v)} - ${formatNumber(u * u)}) / ${formatNumber(2 * a)}`)}</div>
                        <div class="math">${formatMathExpression(`s = ${formatNumber(values.s)}`)} m</div>
                    `);
                    
                    calculated.add('t').add('s');
                    highlightEquation('eq3');
                }
            }
            else if (isValidNumber(u) && isValidNumber(v) && isValidNumber(s)) {
                if (u + v !== 0) {
                    calculationSteps.push(`
                        <h4>Step 2: Select Equation</h4>
                        <div class="math">${formatMathExpression('Using: s = (u + v)t/2')}</div>
                        <div class="math">${formatMathExpression('Rearranging: t = 2s / (u + v)')}</div>
                    `);
                    
                    values.t = 2 * s / (u + v);
                    
                    calculationSteps.push(`
                        <h4>Step 3: Calculate Time</h4>
                        <div class="math">${formatMathExpression(`t = (2 × ${formatNumber(s)}) / (${formatNumber(u)} + ${formatNumber(v)})`)}</div>
                        <div class="math">${formatMathExpression(`t = ${formatNumber(2 * s)} / ${formatNumber(u + v)}`)}</div>
                        <div class="math">${formatMathExpression(`t = ${formatNumber(values.t)}`)} s</div>
                    `);
                    
                    if (!gravityEnabled || !isValidNumber(a)) {
                        values.a = (v - u) / values.t;
                        
                        calculationSteps.push(`
                            <h4>Step 4: Calculate Acceleration</h4>
                            <div class="math">Using original values: ${formatMathExpression(`u = ${formatNumber(u)}, v = ${formatNumber(v)}, t = ${formatNumber(values.t)}`)}</div>
                            <div class="math">${formatMathExpression('a = (v - u) / t')}</div>
                            <div class="math">${formatMathExpression(`a = (${formatNumber(v)} - ${formatNumber(u)}) / ${formatNumber(values.t)}`)}</div>
                            <div class="math">${formatMathExpression(`a = ${formatNumber(v - u)} / ${formatNumber(values.t)}`)}</div>
                            <div class="math">${formatMathExpression(`a = ${formatNumber(values.a)}`)} m/s²</div>
                        `);
                        
                        if (!gravityEnabled) calculated.add('a');
                    } else {
                        calculationSteps.push(`
                            <h4>Step 4: Verify with Given Acceleration</h4>
                            <div class="math">Given: ${formatMathExpression(`a = g = ${formatNumber(values.a)}`)} m/s²</div>
                            <div class="math">Check: ${formatMathExpression(`(v - u) / t = (${formatNumber(v)} - ${formatNumber(u)}) / ${formatNumber(values.t)} = ${formatNumber((v - u) / values.t)}`)} m/s²</div>
                        `);
                    }
                    
                    calculated.add('t');
                    highlightEquation('eq4');
                }
            }
            else if (isValidNumber(u) && isValidNumber(a) && isValidNumber(s)) {
                const discriminant = u * u + 2 * a * s;
                if (discriminant >= 0) {
                    calculationSteps.push(`
                        <h4>Step 2: Select Equations</h4>
                        <div class="math">${formatMathExpression('For final velocity: v² = u² + 2as → v = √(u² + 2as)')}</div>
                        <div class="math">${formatMathExpression('For time: Using s = ut + ½at² (quadratic equation)')}</div>
                    `);
                    
                    values.v = Math.sqrt(discriminant);
                    
                    calculationSteps.push(`
                        <h4>Step 3: Calculate Final Velocity</h4>
                        <div class="math">Using original values: ${formatMathExpression(`u = ${formatNumber(u)}, a = ${formatNumber(a)}, s = ${formatNumber(s)}`)}</div>
                        <div class="math">${formatMathExpression(`v = √(${formatNumber(u)}² + (2 × ${formatNumber(a)} × ${formatNumber(s)}))`)}</div>
                        <div class="math">${formatMathExpression(`v = √(${formatNumber(u * u)} + ${formatNumber(2 * a * s)})`)}</div>
                        <div class="math">${formatMathExpression(`v = √${formatNumber(discriminant)}`)}</div>
                        <div class="math">${formatMathExpression(`v = ${formatNumber(values.v)}`)} m/s</div>
                    `);
                    
                    if (a !== 0) {
                        // Solve quadratic equation: s = ut + 0.5at²
                        // 0.5at² + ut - s = 0
                        const quadA = 0.5 * a;
                        const quadB = u;
                        const quadC = -s;
                        const quadDiscriminant = quadB * quadB - 4 * quadA * quadC;
                        
                        if (quadDiscriminant >= 0) {
                            const t1 = (-quadB + Math.sqrt(quadDiscriminant)) / (2 * quadA);
                            const t2 = (-quadB - Math.sqrt(quadDiscriminant)) / (2 * quadA);
                            values.t = t1 > 0 ? t1 : t2;
                            
                            calculationSteps.push(`
                                <h4>Step 4: Calculate Time</h4>
                                <div class="math">Using the same original values in: ${formatMathExpression('s = ut + ½at²')}</div>
                                <div class="math">Rearranging: ${formatMathExpression('½at² + ut - s = 0')}</div>
                                <div class="math">${formatMathExpression(`(½ × ${formatNumber(a)})t² + (${formatNumber(u)})t - ${formatNumber(s)} = 0`)}</div>
                                <div class="math">Using quadratic formula: ${formatMathExpression('t = (-b ± √(b² - 4ac)) / (2a)')}</div>
                                <div class="math">${formatMathExpression(`t = ${formatNumber(values.t)}`)} s (positive solution)</div>
                            `);
                            
                            calculated.add('v').add('t');
                            highlightEquation('eq3');
                        }
                    }
                }
            }
            else if (isValidNumber(v) && isValidNumber(a) && isValidNumber(s)) {
                const discriminant = v * v - 2 * a * s;
                if (discriminant >= 0) {
                    calculationSteps.push(`
                        <h4>Step 2: Select Equations</h4>
                        <div class="math">${formatMathExpression('For initial velocity: v² = u² + 2as → u = √(v² - 2as)')}</div>
                        <div class="math">${formatMathExpression('For time: v = u + at → t = (v - u) / a')}</div>
                    `);
                    
                    values.u = Math.sqrt(discriminant);
                    
                    calculationSteps.push(`
                        <h4>Step 3: Calculate Initial Velocity</h4>
                        <div class="math">Using original values: ${formatMathExpression(`v = ${formatNumber(v)}, a = ${formatNumber(a)}, s = ${formatNumber(s)}`)}</div>
                        <div class="math">${formatMathExpression(`u = √(${formatNumber(v)}² - (2 × ${formatNumber(a)} × ${formatNumber(s)}))`)}</div>
                        <div class="math">${formatMathExpression(`u = √(${formatNumber(v * v)} - ${formatNumber(2 * a * s)})`)}</div>
                        <div class="math">${formatMathExpression(`u = √${formatNumber(discriminant)}`)}</div>
                        <div class="math">${formatMathExpression(`u = ${formatNumber(values.u)}`)} m/s</div>
                    `);
                    
                    if (a !== 0) {
                        values.t = (v - values.u) / a;
                        
                        calculationSteps.push(`
                            <h4>Step 4: Calculate Time</h4>
                            <div class="math">Using calculated u with original values: ${formatMathExpression(`v = ${formatNumber(v)}, a = ${formatNumber(a)}`)}</div>
                            <div class="math">${formatMathExpression('t = (v - u) / a')}</div>
                            <div class="math">${formatMathExpression(`t = (${formatNumber(v)} - ${formatNumber(values.u)}) / ${formatNumber(a)}`)}</div>
                            <div class="math">${formatMathExpression(`t = ${formatNumber(v - values.u)} / ${formatNumber(a)}`)}</div>
                            <div class="math">${formatMathExpression(`t = ${formatNumber(values.t)}`)} s</div>
                        `);
                        
                        calculated.add('u').add('t');
                        highlightEquation('eq3');
                    }
                }
            }
            else if (isValidNumber(a) && isValidNumber(t) && isValidNumber(s)) {
                calculationSteps.push(`
                    <h4>Step 2: Select Equation</h4>
                    <div class="math">${formatMathExpression('Using: s = ut + ½at²')}</div>
                    <div class="math">${formatMathExpression('Rearranging: u = (s - ½at²) / t')}</div>
                `);
                
                values.u = (s - 0.5 * a * t * t) / t;
                
                calculationSteps.push(`
                    <h4>Step 3: Calculate Initial Velocity</h4>
                    <div class="math">${formatMathExpression(`u = (${formatNumber(s)} - (½ × ${formatNumber(a)} × ${formatNumber(t)}²)) / ${formatNumber(t)}`)}</div>
                    <div class="math">${formatMathExpression(`u = (${formatNumber(s)} - ${formatNumber(0.5 * a * t * t)}) / ${formatNumber(t)}`)}</div>
                    <div class="math">${formatMathExpression(`u = ${formatNumber(s - 0.5 * a * t * t)} / ${formatNumber(t)}`)}</div>
                    <div class="math">${formatMathExpression(`u = ${formatNumber(values.u)}`)} m/s</div>
                `);
                
                values.v = values.u + a * t;
                
                calculationSteps.push(`
                    <h4>Step 4: Calculate Final Velocity</h4>
                    <div class="math">${formatMathExpression('Using: v = u + at')}</div>
                    <div class="math">${formatMathExpression(`v = ${formatNumber(values.u)} + (${formatNumber(a)} × ${formatNumber(t)})`)}</div>
                    <div class="math">${formatMathExpression(`v = ${formatNumber(values.u)} + ${formatNumber(a * t)}`)}</div>
                    <div class="math">${formatMathExpression(`v = ${formatNumber(values.v)}`)} m/s</div>
                `);
                
                calculated.add('u').add('v');
                highlightEquation('eq2');
            }
            else if (isValidNumber(u) && isValidNumber(t) && isValidNumber(s)) {
                calculationSteps.push(`
                    <h4>Step 2: Select Equation</h4>
                    <div class="math">Using: s = (u + v)t/2</div>
                    <div class="math">Rearranging: v = 2s/t - u</div>
                `);
                
                values.v = 2 * s / t - u;
                
                calculationSteps.push(`
                    <h4>Step 3: Calculate Final Velocity</h4>
                    <div class="math">v = 2 × ${formatNumber(s)} / ${formatNumber(t)} - ${formatNumber(u)}</div>
                    <div class="math">v = ${formatNumber(2 * s / t)} - ${formatNumber(u)}</div>
                    <div class="math">v = ${formatNumber(values.v)} m/s</div>
                `);
                
                if (!gravityEnabled || !isValidNumber(a)) {
                    values.a = (values.v - u) / t;
                    
                    calculationSteps.push(`
                        <h4>Step 4: Calculate Acceleration</h4>
                        <div class="math">Using: a = (v - u) / t</div>
                        <div class="math">a = (${formatNumber(values.v)} - ${formatNumber(u)}) / ${formatNumber(t)}</div>
                        <div class="math">a = ${formatNumber(values.v - u)} / ${formatNumber(t)}</div>
                        <div class="math">a = ${formatNumber(values.a)} m/s²</div>
                    `);
                    
                    if (!gravityEnabled) calculated.add('a');
                }
                
                calculated.add('v');
                highlightEquation('eq4');
            }
            else if (isValidNumber(v) && isValidNumber(t) && isValidNumber(s)) {
                calculationSteps.push(`
                    <h4>Step 2: Select Equation</h4>
                    <div class="math">Using: s = (u + v)t/2</div>
                    <div class="math">Rearranging: u = 2s/t - v</div>
                `);
                
                values.u = 2 * s / t - v;
                
                calculationSteps.push(`
                    <h4>Step 3: Calculate Initial Velocity</h4>
                    <div class="math">u = 2 × ${formatNumber(s)} / ${formatNumber(t)} - ${formatNumber(v)}</div>
                    <div class="math">u = ${formatNumber(2 * s / t)} - ${formatNumber(v)}</div>
                    <div class="math">u = ${formatNumber(values.u)} m/s</div>
                `);
                
                if (!gravityEnabled || !isValidNumber(a)) {
                    values.a = (v - values.u) / t;
                    
                    calculationSteps.push(`
                        <h4>Step 4: Calculate Acceleration</h4>
                        <div class="math">Using: a = (v - u) / t</div>
                        <div class="math">a = (${formatNumber(v)} - ${formatNumber(values.u)}) / ${formatNumber(t)}</div>
                        <div class="math">a = ${formatNumber(v - values.u)} / ${formatNumber(t)}</div>
                        <div class="math">a = ${formatNumber(values.a)} m/s²</div>
                    `);
                    
                    if (!gravityEnabled) calculated.add('a');
                }
                
                calculated.add('u');
                highlightEquation('eq4');
            }

            updateDisplay();
            updateWorkings();
        }

        function solveAdaptive() {
            const priority = ['t', 'a', 'u', 'v', 's'];
            const toKeep = new Set([lastEntered]);
            
            for (const variable of priority) {
                if (toKeep.size >= 3) break;
                if (isValidNumber(values[variable]) && !toKeep.has(variable)) {
                    toKeep.add(variable);
                }
            }

            const keptValues = {};
            const adjustedValues = new Set();
            
            for (const variable of toKeep) {
                keptValues[variable] = values[variable];
            }

            for (const variable in values) {
                if (!toKeep.has(variable)) {
                    values[variable] = null;
                    adjustedValues.add(variable);
                }
            }

            Object.assign(values, keptValues);

            calculationSteps.push(`
                <h4>Adaptive Mode: Too many values entered</h4>
                <div class="math">Keeping: ${Array.from(toKeep).join(', ')}</div>
                <div class="math">Adjusting: ${Array.from(adjustedValues).join(', ')}</div>
            `);

            solveStandard();

            for (const variable of adjustedValues) {
                if (calculated.has(variable)) {
                    const input = document.getElementById(variable);
                    input.classList.add('adjusted');
                }
            }

            const adjustedList = Array.from(adjustedValues).filter(v => calculated.has(v));
            if (adjustedList.length > 0) {
                updateStatus(`Kept ${lastEntered} and adjusted ${adjustedList.join(', ')} to maintain valid physics`, 'success');
            }
        }

        function updateDisplay() {
            ['u', 'v', 'a', 't', 's'].forEach(id => {
                if (calculated.has(id)) {
                    const input = document.getElementById(id);
                    input.value = values[id].toFixed(3);
                    if (!input.classList.contains('adjusted')) {
                        input.classList.add('calculated');
                    }
                }
            });

            // Special handling for acceleration when gravity is enabled
            if (gravityEnabled) {
                const aInput = document.getElementById('a');
                aInput.value = GRAVITY.toFixed(2);
                aInput.disabled = true;
                aInput.style.background = '#e3f2fd';
                aInput.classList.remove('calculated', 'adjusted');
            }

            if (calculated.size > 0 && !document.querySelector('.status.success')) {
                const actualCalculated = gravityEnabled && calculated.has('a') ? calculated.size - 1 : calculated.size;
                if (actualCalculated > 0) {
                    updateStatus(`Calculated ${actualCalculated} missing variable${actualCalculated > 1 ? 's' : ''} successfully`, 'success');
                }
                drawGraphs();
            }
            
            if (calculated.size > 0) {
                drawGraphs();
            }
        }

        function drawGraphs() {
            if (!isValidNumber(values.t) || values.t <= 0) return;

            const timePoints = [];
            const displacements = [];
            const velocities = [];
            const accelerations = [];

            const maxTime = values.t;
            const steps = 50;

            for (let i = 0; i <= steps; i++) {
                const t = (i / steps) * maxTime;
                timePoints.push(t);
                
                const disp = values.u * t + 0.5 * values.a * t * t;
                const vel = values.u + values.a * t;
                const acc = values.a;
                
                displacements.push(disp);
                velocities.push(vel);
                accelerations.push(acc);
            }

            // Common chart options
            const commonOptions = {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.parsed.y.toFixed(2)}`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'linear',
                        title: {
                            display: true,
                            text: 'Time (s)',
                            font: {
                                size: 10
                            }
                        },
                        ticks: {
                            font: {
                                size: 9
                            }
                        }
                    },
                    y: {
                        title: {
                            display: true,
                            text: '',
                            font: {
                                size: 10
                            }
                        },
                        ticks: {
                            font: {
                                size: 9
                            }
                        }
                    }
                },
                animation: {
                    duration: 500
                }
            };

            // Create or update displacement chart
            const dispCtx = document.getElementById('displacementGraph').getContext('2d');
            if (displacementChart) {
                displacementChart.data.labels = timePoints;
                displacementChart.data.datasets[0].data = timePoints.map((t, i) => ({ x: t, y: displacements[i] }));
                displacementChart.update();
            } else {
                displacementChart = new Chart(dispCtx, {
                    type: 'line',
                    data: {
                        labels: timePoints,
                        datasets: [{
                            data: timePoints.map((t, i) => ({ x: t, y: displacements[i] })),
                            borderColor: '#4CAF50',
                            backgroundColor: 'rgba(76, 175, 80, 0.1)',
                            borderWidth: 2,
                            pointRadius: 0,
                            tension: 0.1
                        }]
                    },
                    options: {
                        ...commonOptions,
                        scales: {
                            ...commonOptions.scales,
                            y: {
                                ...commonOptions.scales.y,
                                title: {
                                    ...commonOptions.scales.y.title,
                                    text: 'Displacement (m)'
                                }
                            }
                        }
                    }
                });
            }

            // Create or update velocity chart
            const velCtx = document.getElementById('velocityGraph').getContext('2d');
            if (velocityChart) {
                velocityChart.data.labels = timePoints;
                velocityChart.data.datasets[0].data = timePoints.map((t, i) => ({ x: t, y: velocities[i] }));
                velocityChart.update();
            } else {
                velocityChart = new Chart(velCtx, {
                    type: 'line',
                    data: {
                        labels: timePoints,
                        datasets: [{
                            data: timePoints.map((t, i) => ({ x: t, y: velocities[i] })),
                            borderColor: '#2196F3',
                            backgroundColor: 'rgba(33, 150, 243, 0.1)',
                            borderWidth: 2,
                            pointRadius: 0,
                            tension: 0
                        }]
                    },
                    options: {
                        ...commonOptions,
                        scales: {
                            ...commonOptions.scales,
                            y: {
                                ...commonOptions.scales.y,
                                title: {
                                    ...commonOptions.scales.y.title,
                                    text: 'Velocity (m/s)'
                                }
                            }
                        }
                    }
                });
            }

            // Create or update acceleration chart
            const accCtx = document.getElementById('accelerationGraph').getContext('2d');
            if (accelerationChart) {
                accelerationChart.data.labels = timePoints;
                accelerationChart.data.datasets[0].data = timePoints.map((t, i) => ({ x: t, y: accelerations[i] }));
                accelerationChart.update();
            } else {
                accelerationChart = new Chart(accCtx, {
                    type: 'line',
                    data: {
                        labels: timePoints,
                        datasets: [{
                            data: timePoints.map((t, i) => ({ x: t, y: accelerations[i] })),
                            borderColor: '#FF9800',
                            backgroundColor: 'rgba(255, 152, 0, 0.1)',
                            borderWidth: 2,
                            pointRadius: 0,
                            tension: 0
                        }]
                    },
                    options: {
                        ...commonOptions,
                        scales: {
                            ...commonOptions.scales,
                            y: {
                                ...commonOptions.scales.y,
                                title: {
                                    ...commonOptions.scales.y.title,
                                    text: 'Acceleration (m/s²)'
                                }
                            }
                        }
                    }
                });
            }
        }

        function drawGraph(canvasId, xData, yData, color) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (xData.length === 0 || yData.length === 0) return;

            const padding = 25;
            const width = canvas.width - 2 * padding;
            const height = canvas.height - 2 * padding;

            const xMin = Math.min(...xData);
            const xMax = Math.max(...xData);
            const yDataMin = Math.min(...yData);
            const yDataMax = Math.max(...yData);
            
            const yAbsMax = Math.max(Math.abs(yDataMin), Math.abs(yDataMax), 1);
            const yMin = -yAbsMax;
            const yMax = yAbsMax;

            // Draw axes
            ctx.strokeStyle = '#666';
            ctx.lineWidth = 1;
            ctx.beginPath();
            ctx.moveTo(padding, padding);
            ctx.lineTo(padding, canvas.height - padding);
            ctx.moveTo(padding, canvas.height - padding);
            ctx.lineTo(canvas.width - padding, canvas.height - padding);
            
            const zeroY = padding + ((0 - yMax) / (yMin - yMax || 1)) * height;
            ctx.moveTo(padding, zeroY);
            ctx.lineTo(canvas.width - padding, zeroY);
            ctx.stroke();

            // Draw grid
            ctx.strokeStyle = '#e0e0e0';
            ctx.lineWidth = 0.5;
            for (let i = 1; i < 10; i++) {
                const x = padding + (i / 10) * width;
                const y = padding + (i / 10) * height;
                
                ctx.beginPath();
                ctx.moveTo(x, padding);
                ctx.lineTo(x, canvas.height - padding);
                ctx.stroke();
                
                ctx.beginPath();
                ctx.moveTo(padding, y);
                ctx.lineTo(canvas.width - padding, y);
                ctx.stroke();
            }

            // Draw data
            ctx.strokeStyle = color;
            ctx.lineWidth = 2;
            ctx.beginPath();

            for (let i = 0; i < xData.length; i++) {
                const x = padding + ((xData[i] - xMin) / (xMax - xMin || 1)) * width;
                const y = canvas.height - padding - ((yData[i] - yMin) / (yMax - yMin || 1)) * height;
                
                if (i === 0) {
                    ctx.moveTo(x, y);
                } else {
                    ctx.lineTo(x, y);
                }
            }
            ctx.stroke();

            // Add labels
            ctx.fillStyle = '#333';
            ctx.font = '9px Arial';
            ctx.fillText(`0`, padding - 8, canvas.height - padding + 10);
            ctx.fillText(`${xMax.toFixed(1)}`, canvas.width - padding - 12, canvas.height - padding + 10);
            ctx.fillText(`${yMax.toFixed(1)}`, padding - 20, padding + 3);
            ctx.fillText(`${yMin.toFixed(1)}`, padding - 20, canvas.height - padding + 3);
        }

        function clearGraphs() {
            ['displacementGraph', 'velocityGraph', 'accelerationGraph'].forEach(id => {
                const canvas = document.getElementById(id);
                const ctx = canvas.getContext('2d');
                ctx.clearRect(0, 0, canvas.width, canvas.height);
            });
        }

        // Event listeners
        ['u', 'v', 'a', 't', 's'].forEach(id => {
            document.getElementById(id).addEventListener('input', function() {
                const value = parseFloat(this.value);
                const wasEmpty = values[id] === null;
                
                values[id] = isNaN(value) ? null : value;
                
                if (isValidNumber(values[id])) {
                    userEntered.add(id);
                    lastEntered = id;
                } else {
                    userEntered.delete(id);
                    if (lastEntered === id) {
                        lastEntered = Array.from(userEntered).pop() || null;
                    }
                }
                
                debouncedSolve();
            });
        });

        // Gravity checkbox listener
        document.getElementById('assumeG').addEventListener('change', function() {
            gravityEnabled = this.checked;
            const aInput = document.getElementById('a');
            
            if (gravityEnabled) {
                values.a = GRAVITY;
                aInput.value = GRAVITY.toFixed(2);
                aInput.disabled = true;
                aInput.style.background = '#e3f2fd';
                userEntered.add('a');
                lastEntered = 'a';
                calculated.delete('a'); // Remove from calculated since it's user-specified
                updateStatus('Gravity acceleration applied (g = -9.81 m/s²)', 'info');
            } else {
                aInput.disabled = false;
                aInput.style.background = '';
                // Only clear if it's still -9.81
                if (values.a === GRAVITY) {
                    values.a = null;
                    aInput.value = '';
                    userEntered.delete('a');
                    if (lastEntered === 'a') {
                        lastEntered = Array.from(userEntered).pop() || null;
                    }
                }
            }
            
            debouncedSolve();
        });

        // Initialize
        updateStatus('Enter any 3 values to calculate the missing variables');
    </script>
</body>
</html>