<!DOCTYPE html>
<html lang="en" data-theme="system">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="description" content="Interactive guide to the 5 stages of solar system development for Year 10 cosmology students">
  <meta name="theme-color" content="#0b0d17" media="(prefers-color-scheme: dark)">
  <meta name="theme-color" content="#f0f4ff" media="(prefers-color-scheme: light)">
  <meta property="og:title" content="The Development of the Solar System">
  <meta property="og:description" content="Explore the 5 stages of solar system formation with interactive animations">
  <meta property="og:type" content="website">
  <title>The Development of the Solar System</title>
  <style>
    /* ========== RESET & VARIABLES ========== */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      /* Spacing scale */
      --space-1: 0.25rem; --space-2: 0.5rem; --space-3: 0.75rem;
      --space-4: 1rem; --space-5: 1.5rem; --space-6: 2rem; --space-8: 3rem;
      /* Font scale */
      --font-xs: clamp(0.7rem, 1.5vw, 0.75rem);
      --font-sm: clamp(0.8rem, 1.8vw, 0.875rem);
      --font-base: clamp(0.9rem, 2vw, 1rem);
      --font-lg: clamp(1rem, 2.5vw, 1.25rem);
      --font-xl: clamp(1.2rem, 3vw, 1.5rem);
      --font-2xl: clamp(1.4rem, 3.5vw, 2rem);
      /* Timing */
      --transition-fast: 0.15s ease;
      --transition-base: 0.3s ease;
      --transition-slow: 0.5s ease;
      --spring: cubic-bezier(0.34, 1.56, 0.64, 1);
      /* Light theme (default) */
      --bg-primary: #f0f4ff;
      --bg-secondary: #e2e8f5;
      --bg-card: #ffffff;
      --text-primary: #1a1e2e;
      --text-secondary: #4a5068;
      --text-muted: #8890a8;
      --accent: #4a6cf7;
      --accent-hover: #3955d4;
      --accent-glow: rgba(74, 108, 247, 0.3);
      --border: #d0d7e8;
      --shadow: 0 2px 8px rgba(0,0,0,0.08);
      --shadow-lg: 0 4px 16px rgba(0,0,0,0.12);
      --canvas-bg: #0b0d17;
      --tab-active-bg: var(--accent);
      --tab-active-text: #ffffff;
      --tab-inactive-text: var(--text-secondary);
      --toast-bg: var(--bg-card);
      --toast-text: var(--text-primary);
      --overlay-bg: rgba(0,0,0,0.5);
      --focus-ring: 0 0 0 3px var(--accent-glow);
    }

    /* ========== DARK THEME ========== */
    [data-theme="dark"] {
      --bg-primary: #0b0d17;
      --bg-secondary: #151829;
      --bg-card: #1c2035;
      --text-primary: #e8ecf4;
      --text-secondary: #a0a8c4;
      --text-muted: #6b7394;
      --accent: #6b8aff;
      --accent-hover: #8ba3ff;
      --accent-glow: rgba(107, 138, 255, 0.3);
      --border: #2a3050;
      --shadow: 0 2px 8px rgba(0,0,0,0.3);
      --shadow-lg: 0 4px 16px rgba(0,0,0,0.4);
      --tab-active-bg: var(--accent);
      --tab-active-text: #0b0d17;
      --toast-bg: var(--bg-card);
      --toast-text: var(--text-primary);
      --overlay-bg: rgba(0,0,0,0.7);
    }

    @media (prefers-color-scheme: dark) {
      [data-theme="system"] {
        --bg-primary: #0b0d17;
        --bg-secondary: #151829;
        --bg-card: #1c2035;
        --text-primary: #e8ecf4;
        --text-secondary: #a0a8c4;
        --text-muted: #6b7394;
        --accent: #6b8aff;
        --accent-hover: #8ba3ff;
        --accent-glow: rgba(107, 138, 255, 0.3);
        --border: #2a3050;
        --shadow: 0 2px 8px rgba(0,0,0,0.3);
        --shadow-lg: 0 4px 16px rgba(0,0,0,0.4);
        --tab-active-bg: var(--accent);
        --tab-active-text: #0b0d17;
        --toast-bg: var(--bg-card);
        --toast-text: var(--text-primary);
        --overlay-bg: rgba(0,0,0,0.7);
      }
    }

    /* ========== THEME TRANSITIONS ========== */
    html { transition: background-color var(--transition-base), color var(--transition-base); }

    /* ========== BASE ========== */
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, sans-serif;
      font-size: var(--font-base);
      line-height: 1.6;
      color: var(--text-primary);
      background: var(--bg-primary);
      min-height: 100dvh;
      display: grid;
      grid-template-rows: auto auto 1fr auto;
      overflow-x: hidden;
    }

    /* ========== SKIP LINK ========== */
    .skip-link {
      position: absolute;
      top: -100%;
      left: var(--space-4);
      background: var(--accent);
      color: #fff;
      padding: var(--space-2) var(--space-4);
      border-radius: 0 0 8px 8px;
      z-index: 1000;
      font-weight: 600;
      text-decoration: none;
      transition: top var(--transition-fast);
    }
    .skip-link:focus { top: 0; }

    /* ========== HEADER ========== */
    header {
      padding: var(--space-4) var(--space-5);
      text-align: center;
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
    }
    header h1 {
      font-size: var(--font-2xl);
      font-weight: 700;
      letter-spacing: -0.02em;
      color: var(--text-primary);
    }
    header .subtitle {
      font-size: var(--font-sm);
      color: var(--text-muted);
      margin-top: var(--space-1);
    }

    /* ========== NAV / TABS ========== */
    nav {
      background: var(--bg-secondary);
      border-bottom: 1px solid var(--border);
      padding: 0 var(--space-4);
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: thin;
    }
    .tablist {
      display: flex;
      gap: var(--space-1);
      list-style: none;
      min-width: max-content;
      padding: var(--space-2) 0;
      justify-content: center;
    }
    .tab-btn {
      background: transparent;
      border: 2px solid transparent;
      border-radius: 8px;
      padding: var(--space-2) var(--space-4);
      font-size: var(--font-sm);
      font-weight: 500;
      color: var(--tab-inactive-text);
      cursor: pointer;
      white-space: nowrap;
      transition: all var(--transition-fast);
      min-height: 44px;
      display: flex;
      align-items: center;
      gap: var(--space-2);
      position: relative;
    }
    .tab-btn .tab-num {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 22px;
      height: 22px;
      border-radius: 50%;
      font-size: var(--font-xs);
      font-weight: 700;
      background: var(--border);
      color: var(--text-secondary);
      transition: all var(--transition-fast);
    }
    .tab-btn:hover {
      background: var(--accent-glow);
      color: var(--text-primary);
    }
    .tab-btn:focus-visible {
      outline: none;
      box-shadow: var(--focus-ring);
    }
    .tab-btn[aria-selected="true"] {
      background: var(--tab-active-bg);
      color: var(--tab-active-text);
      font-weight: 600;
    }
    .tab-btn[aria-selected="true"] .tab-num {
      background: rgba(255,255,255,0.25);
      color: var(--tab-active-text);
    }

    /* ========== MAIN ========== */
    main {
      position: relative;
      overflow: hidden;
      min-height: 0;
    }
    #scene-canvas {
      display: block;
      width: 100%;
      height: 100%;
      position: absolute;
      top: 0;
      left: 0;
    }

    /* ========== TAB PANELS ========== */
    .tabpanel {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(to top, rgba(0,0,0,0.85) 0%, rgba(0,0,0,0.6) 70%, transparent 100%);
      padding: var(--space-8) var(--space-5) var(--space-5);
      color: #e8ecf4;
      max-height: 45%;
      overflow-y: auto;
      opacity: 0;
      transform: translateY(20px);
      transition: opacity var(--transition-base), transform var(--transition-base);
      pointer-events: none;
      scrollbar-width: thin;
    }
    .tabpanel[aria-hidden="false"] {
      opacity: 1;
      transform: translateY(0);
      pointer-events: auto;
    }
    .tabpanel h2 {
      font-size: var(--font-xl);
      font-weight: 700;
      margin-bottom: var(--space-3);
      color: #ffffff;
    }
    .tabpanel p {
      font-size: var(--font-base);
      line-height: 1.7;
      color: #c8cee0;
      max-width: 65ch;
    }
    .tabpanel .stage-label {
      font-size: var(--font-xs);
      text-transform: uppercase;
      letter-spacing: 0.1em;
      color: var(--accent);
      font-weight: 600;
      margin-bottom: var(--space-2);
    }

    /* ========== FOOTER / STATUS BAR ========== */
    footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-2) var(--space-4);
      background: var(--bg-secondary);
      border-top: 1px solid var(--border);
      font-size: var(--font-xs);
      color: var(--text-muted);
      gap: var(--space-3);
      flex-wrap: wrap;
    }
    .status-text { flex: 1; min-width: 0; }
    .footer-controls {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }
    .theme-toggle, .help-btn {
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: var(--space-1) var(--space-3);
      color: var(--text-secondary);
      cursor: pointer;
      font-size: var(--font-xs);
      min-height: 32px;
      display: flex;
      align-items: center;
      gap: var(--space-1);
      transition: all var(--transition-fast);
    }
    .theme-toggle:hover, .help-btn:hover {
      background: var(--accent-glow);
      border-color: var(--accent);
      color: var(--text-primary);
    }
    .theme-toggle:focus-visible, .help-btn:focus-visible {
      outline: none;
      box-shadow: var(--focus-ring);
    }
    .offline-badge {
      display: none;
      color: #f59e0b;
      font-weight: 600;
    }
    .offline-badge.visible { display: inline; }

    /* ========== TOAST ========== */
    .toast-container {
      position: fixed;
      top: var(--space-4);
      right: var(--space-4);
      z-index: 900;
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
      pointer-events: none;
    }
    .toast {
      background: var(--toast-bg);
      color: var(--toast-text);
      padding: var(--space-3) var(--space-4);
      border-radius: 8px;
      box-shadow: var(--shadow-lg);
      border-left: 4px solid var(--accent);
      font-size: var(--font-sm);
      max-width: 320px;
      pointer-events: auto;
      animation: toastIn 0.3s var(--spring) forwards;
    }
    .toast.dismiss { animation: toastOut 0.2s ease forwards; }
    @keyframes toastIn { from { opacity: 0; transform: translateX(100%); } to { opacity: 1; transform: translateX(0); } }
    @keyframes toastOut { from { opacity: 1; transform: translateX(0); } to { opacity: 0; transform: translateX(100%); } }

    /* ========== HELP OVERLAY ========== */
    .help-overlay {
      position: fixed;
      inset: 0;
      background: var(--overlay-bg);
      z-index: 950;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--space-4);
      opacity: 0;
      visibility: hidden;
      transition: opacity var(--transition-base), visibility var(--transition-base);
    }
    .help-overlay.open { opacity: 1; visibility: visible; }
    .help-dialog {
      background: var(--bg-card);
      border-radius: 16px;
      padding: var(--space-6);
      max-width: 500px;
      width: 100%;
      box-shadow: var(--shadow-lg);
      max-height: 80dvh;
      overflow-y: auto;
    }
    .help-dialog h2 {
      font-size: var(--font-xl);
      margin-bottom: var(--space-4);
    }
    .help-dialog p, .help-dialog li {
      font-size: var(--font-sm);
      color: var(--text-secondary);
      line-height: 1.6;
      margin-bottom: var(--space-3);
    }
    .help-dialog ul { list-style: none; padding: 0; }
    .help-dialog li::before { content: "→ "; color: var(--accent); font-weight: 700; }
    .help-dialog .help-close-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: var(--space-5);
      gap: var(--space-3);
    }
    .help-close-btn {
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: var(--space-2) var(--space-5);
      font-size: var(--font-sm);
      font-weight: 600;
      cursor: pointer;
      min-height: 44px;
      transition: background var(--transition-fast);
    }
    .help-close-btn:hover { background: var(--accent-hover); }
    .help-close-btn:focus-visible { outline: none; box-shadow: var(--focus-ring); }
    .help-dismiss-check {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-size: var(--font-xs);
      color: var(--text-muted);
    }
    .help-dismiss-check input { width: 16px; height: 16px; accent-color: var(--accent); }

    /* ========== TEXT MODE (Standard / Technical) ========== */
    .desc-standard, .desc-technical { transition: opacity var(--transition-base), max-height var(--transition-base); }
    .desc-technical { display: none; }
    [data-textmode="technical"] .desc-standard { display: none; }
    [data-textmode="technical"] .desc-technical { display: block; }
    .textmode-toggle {
      background: transparent;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: var(--space-1) var(--space-3);
      color: var(--text-secondary);
      cursor: pointer;
      font-size: var(--font-xs);
      min-height: 32px;
      display: flex;
      align-items: center;
      gap: var(--space-1);
      transition: all var(--transition-fast);
    }
    .textmode-toggle:hover {
      background: var(--accent-glow);
      border-color: var(--accent);
      color: var(--text-primary);
    }
    .textmode-toggle:focus-visible {
      outline: none;
      box-shadow: var(--focus-ring);
    }

    /* ========== REDUCED MOTION ========== */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* ========== RESPONSIVE ========== */
    @media (max-width: 600px) {
      header { padding: var(--space-3) var(--space-3); }
      header .subtitle { display: none; }
      .tablist { justify-content: flex-start; }
      .tab-btn { padding: var(--space-2) var(--space-3); font-size: var(--font-xs); }
      .tab-btn .tab-label { display: none; }
      .tab-btn .tab-num { width: 28px; height: 28px; font-size: var(--font-sm); }
      .tabpanel { padding: var(--space-6) var(--space-3) var(--space-3); }
      footer { padding: var(--space-2) var(--space-3); }
    }
    @media (min-width: 1024px) {
      .tabpanel { max-height: 35%; padding: var(--space-8) var(--space-8) var(--space-6); }
      .tabpanel p { font-size: var(--font-lg); }
    }

    /* ========== PRINT ========== */
    @media print {
      nav, footer, .toast-container, .help-overlay, #scene-canvas { display: none !important; }
      body { display: block; background: #fff; color: #000; }
      header { background: transparent; border: none; padding: 1rem 0; }
      header h1 { color: #000; }
      main { position: static; overflow: visible; }
      .tabpanel {
        position: static !important;
        opacity: 1 !important;
        transform: none !important;
        pointer-events: auto !important;
        background: transparent !important;
        color: #000 !important;
        max-height: none !important;
        padding: 1rem 0;
        break-inside: avoid;
        border-bottom: 1px solid #ccc;
      }
      .tabpanel[aria-hidden="true"] { display: block !important; }
      .tabpanel h2 { color: #000 !important; }
      .tabpanel p { color: #333 !important; }
      .tabpanel .stage-label { color: #666 !important; }
    }

    /* ========== LOADING ========== */
    .loading-skeleton {
      position: absolute;
      inset: 0;
      background: var(--canvas-bg);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #6b7394;
      font-size: var(--font-lg);
      z-index: 5;
      transition: opacity 0.5s ease;
    }
    .loading-skeleton.hidden { opacity: 0; pointer-events: none; }
    .loading-dots::after {
      content: '';
      animation: dots 1.5s steps(4, end) infinite;
    }
    @keyframes dots {
      0% { content: ''; } 25% { content: '.'; } 50% { content: '..'; } 75% { content: '...'; }
    }
  </style>
</head>
<body>
  <a href="#main-content" class="skip-link">Skip to content</a>

  <header>
    <h1>The Development of the Solar System</h1>
    <p class="subtitle">A 5-stage journey through cosmic evolution &mdash; Year 10 Cosmology</p>
  </header>

  <nav aria-label="Solar system stages">
    <div class="tablist" role="tablist" aria-label="Stages of solar system development">
      <button class="tab-btn" role="tab" id="tab-0" aria-selected="true" aria-controls="panel-0" tabindex="0">
        <span class="tab-num">1</span><span class="tab-label">Nebula</span>
      </button>
      <button class="tab-btn" role="tab" id="tab-1" aria-selected="false" aria-controls="panel-1" tabindex="-1">
        <span class="tab-num">2</span><span class="tab-label">Protoplanetary Disk</span>
      </button>
      <button class="tab-btn" role="tab" id="tab-2" aria-selected="false" aria-controls="panel-2" tabindex="-1">
        <span class="tab-num">3</span><span class="tab-label">Nuclear Fusion</span>
      </button>
      <button class="tab-btn" role="tab" id="tab-3" aria-selected="false" aria-controls="panel-3" tabindex="-1">
        <span class="tab-num">4</span><span class="tab-label">Planetary Accretion</span>
      </button>
      <button class="tab-btn" role="tab" id="tab-4" aria-selected="false" aria-controls="panel-4" tabindex="-1">
        <span class="tab-num">5</span><span class="tab-label">Habitability</span>
      </button>
    </div>
  </nav>

  <main id="main-content">
    <div class="loading-skeleton" id="loading">
      <span>Initialising the cosmos<span class="loading-dots"></span></span>
    </div>
    <canvas id="scene-canvas" aria-hidden="true"></canvas>

    <section class="tabpanel" role="tabpanel" id="panel-0" aria-labelledby="tab-0" aria-hidden="false">
      <div class="stage-label">Stage 1 of 5</div>
      <h2>Nebula</h2>
      <p class="desc-standard">It all starts with a giant cloud of dust and gas floating in space, called a <strong>nebula</strong>. This cloud is made from leftover material thrown out when an older star exploded. Think of it like a huge recycling process &mdash; old stars die and their remains become the building blocks for new ones. These clouds are enormous, stretching across many light-years.</p>
      <p class="desc-technical">The first stage of solar system development involves the formation of a vast cloud of dust and gas known as a <strong>nebula</strong>. This nebula forms when a star reaches the end of its life and explodes in a supernova, sending out material that will eventually seed the creation of new stars and planets. These clouds can span light-years across and contain the raw ingredients for everything in our solar system.</p>
    </section>

    <section class="tabpanel" role="tabpanel" id="panel-1" aria-labelledby="tab-1" aria-hidden="true">
      <div class="stage-label">Stage 2 of 5</div>
      <h2>Protoplanetary Disk</h2>
      <p class="desc-standard">Gravity starts pulling the cloud inward, and as it shrinks it begins to spin &mdash; like a pizza chef spinning dough, it flattens out into a huge spinning disk. In the middle, material packs together tightly and gets very hot, forming what will become our Sun. The flat disk surrounding it is where the planets will eventually come from.</p>
      <p class="desc-technical">The second stage begins when the nebula starts to collapse under its own gravity. As it contracts, conservation of angular momentum causes it to spin faster and flatten into a rotating <strong>protoplanetary disk</strong>. At the centre, material compresses into a dense, hot core &mdash; the proto-sun. The surrounding disk of gas and dust is where planets will eventually form.</p>
    </section>

    <section class="tabpanel" role="tabpanel" id="panel-2" aria-labelledby="tab-2" aria-hidden="true">
      <div class="stage-label">Stage 3 of 5</div>
      <h2>Nuclear Fusion</h2>
      <p class="desc-standard">The centre of the disk gets so incredibly hot &mdash; about 15 million &deg;C &mdash; that something amazing happens: hydrogen atoms start smashing together and joining up to make helium. This process releases a huge burst of energy. It's the moment our Sun "switches on" and starts shining. All the light and warmth we feel from the Sun comes from this process, and it's been going for about 4.6 billion years.</p>
      <p class="desc-technical">In the third stage, the proto-sun's core reaches extreme temperatures (around 15 million &deg;C), triggering <strong>nuclear fusion</strong>. Hydrogen atoms fuse together to form helium, releasing enormous amounts of energy. This is the moment our Sun "ignites" and begins to shine, producing the light and heat that will drive conditions across the entire solar system for billions of years.</p>
    </section>

    <section class="tabpanel" role="tabpanel" id="panel-3" aria-labelledby="tab-3" aria-hidden="true">
      <div class="stage-label">Stage 4 of 5</div>
      <h2>Planetary Accretion</h2>
      <p class="desc-standard">With the Sun now burning brightly, the leftover dust and rock in the surrounding disk start bumping into each other and sticking together, like snowballs rolling downhill and getting bigger. Over millions of years, these clumps grow from tiny grains into massive planets, moons, and asteroids. The rocky planets (like Earth) form closer to the Sun, while the giant gas planets (like Jupiter) form further out where it's colder.</p>
      <p class="desc-technical">The fourth stage is <strong>planetary accretion</strong> &mdash; the process by which tiny grains of dust in the protoplanetary disk collide and stick together, gradually growing into larger and larger bodies. Over millions of years, these clumps become planetesimals and eventually full-sized planets, moons, asteroids, and comets. The inner rocky planets and outer gas giants take shape during this period.</p>
    </section>

    <section class="tabpanel" role="tabpanel" id="panel-4" aria-labelledby="tab-4" aria-hidden="true">
      <div class="stage-label">Stage 5 of 5</div>
      <h2>Habitability</h2>
      <p class="desc-standard">After billions of years of cooling down, something special happened on Earth. It sits at just the right distance from the Sun &mdash; not too hot, not too cold &mdash; sometimes called the "Goldilocks zone." Liquid water could exist on its surface, and a protective atmosphere formed around it. These conditions made it possible for life to begin and eventually thrive. As far as we know, Earth is the only planet where this has happened.</p>
      <p class="desc-technical">The current and final stage is <strong>habitability</strong>. After billions of years of cooling and chemical evolution, conditions on at least one planet &mdash; Earth &mdash; became suitable for life. Liquid water formed on the surface, a protective atmosphere developed, and the "Goldilocks zone" distance from the Sun created temperatures just right for complex chemistry to flourish into living organisms.</p>
    </section>
  </main>

  <footer>
    <span class="status-text" id="status-text" aria-live="polite">Stage 1 of 5 &mdash; Nebula</span>
    <span class="offline-badge" id="offline-badge" aria-live="assertive">Offline</span>
    <div class="footer-controls">
      <button class="textmode-toggle" id="textmode-toggle" aria-label="Switch between standard and technical descriptions">
        <span id="textmode-icon">&#9998;</span> <span id="textmode-label">Standard</span>
      </button>
      <button class="help-btn" id="help-btn" aria-label="Show help">? Help</button>
      <button class="theme-toggle" id="theme-toggle" aria-label="Toggle theme">
        <span id="theme-icon">&#9788;</span> <span id="theme-label">System</span>
      </button>
      <span data-version="1.0.0" title="Version 1.0.0">v1.0</span>
    </div>
  </footer>

  <div class="toast-container" id="toast-container" aria-live="polite"></div>

  <div class="help-overlay" id="help-overlay" role="dialog" aria-modal="true" aria-labelledby="help-title">
    <div class="help-dialog">
      <h2 id="help-title">Welcome to the Solar System Explorer</h2>
      <p>Discover the 5 stages of how our solar system formed, from a cloud of cosmic dust to a world teeming with life.</p>
      <ul>
        <li>Click the <strong>numbered tabs</strong> to explore each stage</li>
        <li>Use <strong>arrow keys</strong> or <strong>1&ndash;5</strong> to navigate with your keyboard</li>
        <li><strong>Swipe left/right</strong> on touch devices to move between stages</li>
        <li>Switch between <strong>Standard</strong> and <strong>Technical</strong> descriptions</li>
        <li>Toggle <strong>light/dark mode</strong> with the theme button</li>
        <li>Works <strong>offline</strong> once loaded &mdash; great for classrooms!</li>
      </ul>
      <div class="help-close-row">
        <label class="help-dismiss-check">
          <input type="checkbox" id="help-dismiss-checkbox">
          Don't show again
        </label>
        <button class="help-close-btn" id="help-close-btn">Start Exploring</button>
      </div>
    </div>
  </div>

  <script>
    (function() {
      'use strict';

      /* ============================
         A. EVENT BUS
         ============================ */
      const EventBus = {
        _listeners: {},
        on(event, fn) {
          (this._listeners[event] = this._listeners[event] || []).push(fn);
        },
        emit(event, data) {
          (this._listeners[event] || []).forEach(fn => fn(data));
        }
      };

      /* ============================
         B. STAGE DATA
         ============================ */
      const STAGES = [
        { name: 'Nebula', hash: 'nebula' },
        { name: 'Protoplanetary Disk', hash: 'disk' },
        { name: 'Nuclear Fusion', hash: 'fusion' },
        { name: 'Planetary Accretion', hash: 'accretion' },
        { name: 'Habitability', hash: 'habitability' }
      ];

      /* ============================
         C. THEME MANAGER
         ============================ */
      const ThemeManager = {
        modes: ['system', 'light', 'dark'],
        icons: { system: '\u2600', light: '\u2600', dark: '\u263E' },
        current: 'system',

        init() {
          const saved = localStorage.getItem('ss-theme');
          if (saved && this.modes.includes(saved)) this.current = saved;
          this.apply();
          window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
            if (this.current === 'system') this.apply();
          });
          document.getElementById('theme-toggle').addEventListener('click', () => this.cycle());
        },

        cycle() {
          const i = this.modes.indexOf(this.current);
          this.current = this.modes[(i + 1) % this.modes.length];
          this.apply();
          localStorage.setItem('ss-theme', this.current);
          ToastManager.show('Theme: ' + this.current.charAt(0).toUpperCase() + this.current.slice(1));
        },

        apply() {
          document.documentElement.setAttribute('data-theme', this.current);
          document.getElementById('theme-icon').textContent = this.icons[this.current];
          document.getElementById('theme-label').textContent =
            this.current.charAt(0).toUpperCase() + this.current.slice(1);
        }
      };

      /* ============================
         C2. TEXT MODE MANAGER
         ============================ */
      const TextModeManager = {
        modes: ['standard', 'technical'],
        current: 'standard',

        init() {
          const saved = localStorage.getItem('ss-textmode');
          if (saved && this.modes.includes(saved)) this.current = saved;
          this.apply();
          document.getElementById('textmode-toggle').addEventListener('click', () => this.cycle());
        },

        cycle() {
          this.current = this.current === 'standard' ? 'technical' : 'standard';
          this.apply();
          localStorage.setItem('ss-textmode', this.current);
          ToastManager.show('Descriptions: ' + this.current.charAt(0).toUpperCase() + this.current.slice(1));
        },

        apply() {
          document.documentElement.setAttribute('data-textmode', this.current);
          document.getElementById('textmode-label').textContent =
            this.current.charAt(0).toUpperCase() + this.current.slice(1);
          document.getElementById('textmode-icon').textContent =
            this.current === 'standard' ? '\u270E' : '\u2699';
        }
      };

      /* ============================
         D. TOAST MANAGER
         ============================ */
      const ToastManager = {
        container: null,
        maxVisible: 3,

        init() {
          this.container = document.getElementById('toast-container');
        },

        show(message, duration) {
          if (typeof duration === 'undefined') duration = 3500;
          const toast = document.createElement('div');
          toast.className = 'toast';
          toast.textContent = message;
          toast.setAttribute('role', 'status');
          this.container.appendChild(toast);

          // Limit visible toasts
          while (this.container.children.length > this.maxVisible) {
            this.container.removeChild(this.container.firstChild);
          }

          setTimeout(() => {
            toast.classList.add('dismiss');
            setTimeout(() => { if (toast.parentNode) toast.remove(); }, 250);
          }, duration);
        }
      };

      /* ============================
         E. HELP MANAGER
         ============================ */
      const HelpManager = {
        overlay: null,
        closeBtn: null,
        lastFocused: null,

        init() {
          this.overlay = document.getElementById('help-overlay');
          this.closeBtn = document.getElementById('help-close-btn');
          const helpBtn = document.getElementById('help-btn');
          const dismissBox = document.getElementById('help-dismiss-checkbox');

          helpBtn.addEventListener('click', () => this.open());
          this.closeBtn.addEventListener('click', () => {
            if (dismissBox.checked) localStorage.setItem('ss-help-dismissed', '1');
            this.close();
          });
          this.overlay.addEventListener('click', (e) => {
            if (e.target === this.overlay) this.close();
          });
          this.overlay.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') this.close();
            if (e.key === 'Tab') this.trapFocus(e);
          });

          // Show on first visit
          if (!localStorage.getItem('ss-help-dismissed')) {
            setTimeout(() => this.open(), 600);
          }
        },

        open() {
          this.lastFocused = document.activeElement;
          this.overlay.classList.add('open');
          this.closeBtn.focus();
        },

        close() {
          this.overlay.classList.remove('open');
          if (this.lastFocused) this.lastFocused.focus();
        },

        trapFocus(e) {
          const focusable = this.overlay.querySelectorAll('button, input, [tabindex]:not([tabindex="-1"])');
          const first = focusable[0];
          const last = focusable[focusable.length - 1];
          if (e.shiftKey && document.activeElement === first) {
            e.preventDefault(); last.focus();
          } else if (!e.shiftKey && document.activeElement === last) {
            e.preventDefault(); first.focus();
          }
        }
      };

      /* ============================
         F. ANIMATION ENGINE
         ============================ */
      const AnimationEngine = {
        canvas: null,
        ctx: null,
        width: 0,
        height: 0,
        particles: [],
        PARTICLE_COUNT: 300,
        currentStage: 0,
        targetStage: -1,
        morphProgress: 1,
        morphDuration: 2000,
        morphStart: 0,
        time: 0,
        reducedMotion: false,
        stars: [],

        // Solar system planet data for stage 4 (Habitability)
        // Relative orbital radii and speeds (not to scale, but recognisable)
        planets: [
          { name: 'Mercury', orbitFrac: 0.12, speed: 4.15, size: 3,  r: 180, g: 170, b: 160 },
          { name: 'Venus',   orbitFrac: 0.20, speed: 1.62, size: 5,  r: 230, g: 200, b: 140 },
          { name: 'Earth',   orbitFrac: 0.28, speed: 1.00, size: 5,  r: 70,  g: 130, b: 230 },
          { name: 'Mars',    orbitFrac: 0.36, speed: 0.53, size: 4,  r: 200, g: 100, b: 60  },
          { name: 'Jupiter', orbitFrac: 0.50, speed: 0.084,size: 12, r: 210, g: 180, b: 140 },
          { name: 'Saturn',  orbitFrac: 0.63, speed: 0.034,size: 10, r: 220, g: 200, b: 150 },
          { name: 'Uranus',  orbitFrac: 0.77, speed: 0.012,size: 7,  r: 170, g: 220, b: 230 },
          { name: 'Neptune', orbitFrac: 0.90, speed: 0.006,size: 7,  r: 60,  g: 100, b: 220 }
        ],
        planetAngles: [], // current angle for each planet

        // Nebula cloud blobs for wispy effect
        nebulaBlobs: [],

        init() {
          this.canvas = document.getElementById('scene-canvas');
          this.ctx = this.canvas.getContext('2d');
          this.reducedMotion = window.matchMedia('(prefers-reduced-motion: reduce)').matches;
          window.matchMedia('(prefers-reduced-motion: reduce)').addEventListener('change', (e) => {
            this.reducedMotion = e.matches;
          });

          this.resize();
          window.addEventListener('resize', () => this.resize());

          // Create particles
          for (let i = 0; i < this.PARTICLE_COUNT; i++) {
            this.particles.push({
              x: 0, y: 0, targetX: 0, targetY: 0,
              radius: 2, targetRadius: 2,
              r: 200, g: 200, b: 255,
              tr: 200, tg: 200, tb: 255,
              opacity: 0.8, targetOpacity: 0.8,
              angle: Math.random() * Math.PI * 2,
              speed: 0.2 + Math.random() * 0.5,
              orbitRadius: 0,
              life: Math.random(),
              // For accretion: which planet clump (or debris)
              clumpIdx: 0,
              clumpAngle: 0
            });
          }

          // Background stars
          for (let i = 0; i < 150; i++) {
            this.stars.push({
              x: Math.random(), y: Math.random(),
              r: 0.3 + Math.random() * 1.2,
              twinkle: Math.random() * Math.PI * 2
            });
          }

          // Nebula cloud blobs — overlapping wispy shapes
          var blobColors = [
            [140, 60, 220, 0.12], [80, 120, 240, 0.10], [220, 80, 160, 0.09],
            [240, 140, 60, 0.08], [100, 60, 200, 0.11], [60, 160, 240, 0.08],
            [200, 100, 240, 0.07], [180, 60, 120, 0.06], [100, 200, 255, 0.09],
            [255, 120, 80, 0.07], [160, 80, 255, 0.10], [80, 100, 200, 0.08]
          ];
          for (let i = 0; i < blobColors.length; i++) {
            this.nebulaBlobs.push({
              x: 0.25 + Math.random() * 0.5,
              y: 0.25 + Math.random() * 0.5,
              rx: 0.08 + Math.random() * 0.18,
              ry: 0.06 + Math.random() * 0.14,
              color: blobColors[i],
              driftX: (Math.random() - 0.5) * 0.00003,
              driftY: (Math.random() - 0.5) * 0.00003,
              phase: Math.random() * Math.PI * 2
            });
          }

          // Planet angles for stage 4
          this.planetAngles = this.planets.map(() => Math.random() * Math.PI * 2);

          this.setScene(0, true);

          requestAnimationFrame(() => {
            document.getElementById('loading').classList.add('hidden');
          });

          this.loop();
        },

        resize() {
          const rect = this.canvas.parentElement.getBoundingClientRect();
          const dpr = window.devicePixelRatio || 1;
          this.width = rect.width;
          this.height = rect.height;
          this.canvas.width = rect.width * dpr;
          this.canvas.height = rect.height * dpr;
          this.canvas.style.width = rect.width + 'px';
          this.canvas.style.height = rect.height + 'px';
          this.ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
          if (this.morphProgress >= 1) this.setScene(this.currentStage, true);
        },

        setScene(stage, instant) {
          const cx = this.width / 2;
          const cy = this.height / 2;
          const maxR = Math.min(this.width, this.height) * 0.42;
          const N = this.particles.length;

          for (let i = 0; i < N; i++) {
            const p = this.particles[i];
            const baseAngle = (i / N) * Math.PI * 2 + p.life * Math.PI;

            switch (stage) {
              /* ---- STAGE 0: NEBULA ---- */
              case 0: {
                // Scatter particles across a large cloud area with turbulent drift
                const dist = (0.15 + Math.pow(Math.random(), 0.7) * 0.85) * maxR;
                const a = Math.random() * Math.PI * 2;
                p.targetX = cx + Math.cos(a) * dist;
                p.targetY = cy + Math.sin(a) * dist;
                p.targetRadius = 1.5 + Math.random() * 3.5;
                const nebColors = [
                  [180, 100, 255], [100, 140, 255], [255, 120, 180],
                  [255, 160, 80], [140, 80, 255], [80, 180, 255],
                  [200, 80, 200], [120, 100, 240]
                ];
                const nc = nebColors[i % nebColors.length];
                p.tr = nc[0]; p.tg = nc[1]; p.tb = nc[2];
                p.targetOpacity = 0.25 + Math.random() * 0.5;
                p.orbitRadius = dist;
                p.speed = 0.08 + Math.random() * 0.15;
                break;
              }

              /* ---- STAGE 1: PROTOPLANETARY DISK ---- */
              case 1: {
                // All particles orbit in the disk (sun drawn as solid sphere in render)
                // Distribute evenly across orbits, each at its own starting angle
                const orbitR = maxR * 0.08 + (i / N) * maxR * 0.88;
                const diskThickness = maxR * 0.03 * (1 + (i / N) * 0.4);
                const diskY = (Math.random() - 0.5) * diskThickness;
                p.targetX = cx + Math.cos(baseAngle) * orbitR;
                p.targetY = cy + Math.sin(baseAngle) * orbitR * 0.28 + diskY;
                p.targetRadius = 0.8 + Math.random() * 2.2;
                const warmth = 1 - (i / N);
                p.tr = 180 + warmth * 75; p.tg = 140 + warmth * 60; p.tb = 80 + (1 - warmth) * 120;
                p.targetOpacity = 0.3 + Math.random() * 0.5;
                p.orbitRadius = orbitR;
                // Smooth single-direction orbit — inner orbits faster (Kepler-like)
                p.speed = 0.08 + Math.pow(1 - i / N, 1.5) * 0.35;
                break;
              }

              /* ---- STAGE 2: NUCLEAR FUSION — ALL PARTICLES IN A TIGHT CLUMP ---- */
              case 2: {
                // Every particle packs into a tight central ball
                const clumpR = maxR * 0.12;
                const r = Math.pow(Math.random(), 0.5) * clumpR; // sqrt for even density
                const a = Math.random() * Math.PI * 2;
                p.targetX = cx + Math.cos(a) * r;
                p.targetY = cy + Math.sin(a) * r;
                // Core particles larger and brighter
                const heat = 1 - (r / clumpR);
                p.targetRadius = 1.5 + heat * 3.5;
                p.tr = 255;
                p.tg = 180 + heat * 75; // whiter toward center
                p.tb = 40 + heat * 180;
                p.targetOpacity = 0.5 + heat * 0.5;
                p.orbitRadius = r;
                p.speed = 0.02 + Math.random() * 0.08;
                break;
              }

              /* ---- STAGE 3: PLANETARY ACCRETION — ZOOMED OUT ---- */
              case 3: {
                // Sun is drawn as a solid sphere in render() — no sun particles needed
                // Split particles: ~30% debris, ~70% in randomised clumps
                const debrisParticles = Math.floor(N * 0.30);
                const numClumps = 8; // more clumps, scattered randomly

                if (i < debrisParticles) {
                  // Debris scattered randomly across the disk area
                  const debOrbit = maxR * 0.10 + Math.random() * maxR * 0.85;
                  const debAngle = Math.random() * Math.PI * 2;
                  const debY = (Math.random() - 0.5) * maxR * 0.08;
                  p.targetX = cx + Math.cos(debAngle) * debOrbit;
                  p.targetY = cy + Math.sin(debAngle) * debOrbit * 0.35 + debY;
                  p.tr = 140 + Math.random() * 80;
                  p.tg = 120 + Math.random() * 60;
                  p.tb = 80 + Math.random() * 70;
                  p.targetRadius = 0.5 + Math.random() * 1.5;
                  p.targetOpacity = 0.12 + Math.random() * 0.25;
                  p.orbitRadius = debOrbit;
                  p.speed = 0.06 + (1 - debOrbit / maxR) * 0.2;
                  p.clumpIdx = -2; // debris marker
                  p.clumpAngle = debAngle;
                } else {
                  // Clump particles — scattered randomly at various radii and angles
                  const ci = (i - debrisParticles) % numClumps;
                  // Each clump has a random orbit and angle (seeded per clump index)
                  const clumpSeed = ci * 137.508; // golden angle spread
                  const clumpOrbit = maxR * 0.12 + ((Math.sin(clumpSeed) * 0.5 + 0.5)) * maxR * 0.78;
                  const clumpBaseAngle = clumpSeed % (Math.PI * 2);
                  // Large spread for scattered/clumpy appearance
                  const spread = maxR * 0.05 + Math.random() * maxR * 0.04;
                  const offsetA = (Math.random() - 0.5) * 0.8;
                  const offsetR = (Math.random() - 0.5) * spread * 2;
                  const finalR = clumpOrbit + offsetR;
                  const finalA = clumpBaseAngle + offsetA;
                  p.targetX = cx + Math.cos(finalA) * finalR;
                  p.targetY = cy + Math.sin(finalA) * finalR * 0.35 + (Math.random() - 0.5) * spread * 0.5;
                  const clumpColors = [
                    [200,120,80], [180,160,120], [140,100,80], [100,140,180],
                    [180,140,100], [160,180,140], [170,110,90], [120,130,160]
                  ];
                  const cc = clumpColors[ci];
                  p.tr = cc[0] + (Math.random() - 0.5) * 40;
                  p.tg = cc[1] + (Math.random() - 0.5) * 40;
                  p.tb = cc[2] + (Math.random() - 0.5) * 40;
                  p.targetRadius = 1 + Math.random() * 3;
                  p.targetOpacity = 0.4 + Math.random() * 0.5;
                  p.orbitRadius = clumpOrbit;
                  p.speed = 0.08 + (1 - clumpOrbit / maxR) * 0.2;
                  p.clumpIdx = ci;
                  p.clumpAngle = finalA;
                }
                break;
              }

              /* ---- STAGE 4: HABITABILITY — SOLAR SYSTEM MODEL ---- */
              case 4: {
                // Sun is drawn as a single solid yellow sphere in render()
                // All particles are faint orbit trail dust around planet paths
                const pi = i % 8;
                const planet = this.planets[pi];
                const trailAngle = Math.random() * Math.PI * 2;
                const trailR = planet.orbitFrac * maxR;
                p.targetX = cx + Math.cos(trailAngle) * trailR;
                p.targetY = cy + Math.sin(trailAngle) * trailR * 0.45;
                p.tr = planet.r; p.tg = planet.g; p.tb = planet.b;
                p.targetRadius = 0.3 + Math.random() * 0.7;
                p.targetOpacity = 0.04 + Math.random() * 0.08;
                p.orbitRadius = trailR;
                p.speed = planet.speed * 0.3;
                p.clumpIdx = pi;
                break;
              }
            }

            if (instant) {
              p.x = p.targetX; p.y = p.targetY;
              p.radius = p.targetRadius;
              p.r = p.tr; p.g = p.tg; p.b = p.tb;
              p.opacity = p.targetOpacity;
            }
          }
        },

        morphTo(stage) {
          if (stage === this.currentStage && this.morphProgress >= 1) return;
          this.targetStage = stage;
          this.setScene(stage, false);
          this.morphProgress = 0;
          this.morphStart = performance.now();

          if (this.reducedMotion) {
            this.morphProgress = 1;
            this.currentStage = stage;
            for (const p of this.particles) {
              p.x = p.targetX; p.y = p.targetY;
              p.radius = p.targetRadius;
              p.r = p.tr; p.g = p.tg; p.b = p.tb;
              p.opacity = p.targetOpacity;
            }
          }
        },

        loop() {
          this.time = performance.now();
          this.update();
          this.render();
          requestAnimationFrame(() => this.loop());
        },

        update() {
          const cx = this.width / 2;
          const cy = this.height / 2;
          const maxR = Math.min(this.width, this.height) * 0.42;

          // Morph interpolation
          if (this.morphProgress < 1 && this.targetStage >= 0) {
            this.morphProgress = Math.min(1, (this.time - this.morphStart) / this.morphDuration);
            const t = this.morphProgress < 0.5
              ? 2 * this.morphProgress * this.morphProgress
              : 1 - Math.pow(-2 * this.morphProgress + 2, 2) / 2;
            const lerp = t * 0.12;

            for (const p of this.particles) {
              p.x += (p.targetX - p.x) * lerp;
              p.y += (p.targetY - p.y) * lerp;
              p.radius += (p.targetRadius - p.radius) * lerp;
              p.r += (p.tr - p.r) * lerp;
              p.g += (p.tg - p.g) * lerp;
              p.b += (p.tb - p.b) * lerp;
              p.opacity += (p.targetOpacity - p.opacity) * lerp;
            }
            if (this.morphProgress >= 1) {
              this.currentStage = this.targetStage;
              this.targetStage = -1;
            }
          }

          const stage = this.morphProgress < 1 ? this.targetStage : this.currentStage;

          // Update planet angles for stage 4
          if (stage === 4 || this.targetStage === 4) {
            for (let pi = 0; pi < this.planets.length; pi++) {
              this.planetAngles[pi] += this.planets[pi].speed * 0.008;
            }
          }

          // Per-particle animation
          for (const p of this.particles) {
            p.angle += p.speed * 0.01;

            switch (stage) {
              case 0: // Nebula — slow turbulent drift
                p.x += Math.sin(this.time * 0.0004 + p.life * 12) * 0.35;
                p.y += Math.cos(this.time * 0.00035 + p.life * 9) * 0.35;
                // Gentle pull back toward target to prevent drift-off
                p.x += (p.targetX - p.x) * 0.001;
                p.y += (p.targetY - p.y) * 0.001;
                break;

              case 1: { // Disk — smooth single-direction orbit
                // Advance angle steadily (no back-and-forth)
                const ox = cx + Math.cos(p.angle) * p.orbitRadius;
                const oy = cy + Math.sin(p.angle) * p.orbitRadius * 0.28;
                // Gently steer toward orbital position for smooth continuous motion
                p.x += (ox - p.x) * 0.06;
                p.y += (oy - p.y) * 0.06;
                break;
              }

              case 2: { // Fusion — tight pulsating clump
                const pulse = 1 + Math.sin(this.time * 0.004) * 0.08;
                const fx = cx + (p.targetX - cx) * pulse;
                const fy = cy + (p.targetY - cy) * pulse;
                p.x += (fx - p.x) * 0.05;
                p.y += (fy - p.y) * 0.05;
                // Jitter for energy
                p.x += (Math.random() - 0.5) * 0.6;
                p.y += (Math.random() - 0.5) * 0.6;
                break;
              }

              case 3: { // Accretion — clumps orbit slowly, debris drifts
                if (p.clumpIdx === -2) {
                  // Debris — slow orbit
                  p.clumpAngle += p.speed * 0.004;
                  const dx = cx + Math.cos(p.clumpAngle) * p.orbitRadius;
                  const dy = cy + Math.sin(p.clumpAngle) * p.orbitRadius * 0.35;
                  p.x += (dx - p.x) * 0.015;
                  p.y += (dy - p.y) * 0.015;
                } else {
                  // Clump particles — orbit as a group and slowly collapse inward
                  p.clumpAngle += p.speed * 0.005;
                  const clumpCx = cx + Math.cos(p.clumpAngle) * p.orbitRadius;
                  const clumpCy = cy + Math.sin(p.clumpAngle) * p.orbitRadius * 0.35;
                  p.x += (clumpCx - p.x) * 0.012;
                  p.y += (clumpCy - p.y) * 0.012;
                }
                break;
              }

              case 4: { // Habitability — orbit dust follows planet paths
                const planet = this.planets[p.clumpIdx];
                const trailR = planet.orbitFrac * maxR;
                p.angle += planet.speed * 0.005;
                const ox = cx + Math.cos(p.angle) * trailR;
                const oy = cy + Math.sin(p.angle) * trailR * 0.45;
                p.x += (ox - p.x) * 0.02;
                p.y += (oy - p.y) * 0.02;
                break;
              }
            }
          }
        },

        render() {
          const ctx = this.ctx;
          const w = this.width;
          const h = this.height;
          const cx = w / 2;
          const cy = h / 2;
          const maxR = Math.min(w, h) * 0.42;
          const stage = this.morphProgress < 1 ? this.targetStage : this.currentStage;

          // Background
          ctx.fillStyle = '#050710';
          ctx.fillRect(0, 0, w, h);

          // Stars
          for (const s of this.stars) {
            const twinkle = 0.3 + 0.7 * Math.abs(Math.sin(this.time * 0.001 + s.twinkle));
            ctx.globalAlpha = twinkle * 0.6;
            ctx.fillStyle = '#c8d4ff';
            ctx.beginPath();
            ctx.arc(s.x * w, s.y * h, s.r, 0, Math.PI * 2);
            ctx.fill();
          }
          ctx.globalAlpha = 1;

          // ---- Scene-specific backgrounds ----
          switch (stage) {
            case 0: {
              // Nebula: multiple overlapping wispy radial gradient blobs
              for (const blob of this.nebulaBlobs) {
                const bx = blob.x * w + Math.sin(this.time * 0.0002 + blob.phase) * w * 0.02;
                const by = blob.y * h + Math.cos(this.time * 0.00015 + blob.phase) * h * 0.02;
                const rx = blob.rx * w;
                const ry = blob.ry * h;
                const c = blob.color;
                // Elliptical gradient approximation via scale transform
                ctx.save();
                ctx.translate(bx, by);
                ctx.scale(1, ry / rx);
                const g = ctx.createRadialGradient(0, 0, 0, 0, 0, rx);
                g.addColorStop(0, 'rgba(' + c[0] + ',' + c[1] + ',' + c[2] + ',' + (c[3] * 1.3) + ')');
                g.addColorStop(0.5, 'rgba(' + c[0] + ',' + c[1] + ',' + c[2] + ',' + (c[3] * 0.5) + ')');
                g.addColorStop(1, 'rgba(' + c[0] + ',' + c[1] + ',' + c[2] + ',0)');
                ctx.fillStyle = g;
                ctx.fillRect(-rx, -rx, rx * 2, rx * 2);
                ctx.restore();
              }
              break;
            }

            case 1: {
              // Disk: bright central proto-sun sphere + glow + faint orbit rings
              const dg = ctx.createRadialGradient(cx, cy, 0, cx, cy, maxR * 0.15);
              dg.addColorStop(0, 'rgba(255, 240, 200, 0.4)');
              dg.addColorStop(0.5, 'rgba(255, 200, 100, 0.15)');
              dg.addColorStop(1, 'rgba(0, 0, 0, 0)');
              ctx.fillStyle = dg;
              ctx.fillRect(0, 0, w, h);
              // Solid proto-sun sphere
              ctx.beginPath();
              ctx.arc(cx, cy, maxR * 0.04, 0, Math.PI * 2);
              ctx.fillStyle = '#fff0c0';
              ctx.fill();
              // Orbit guides
              ctx.strokeStyle = 'rgba(160, 140, 100, 0.06)';
              ctx.lineWidth = 1;
              for (let i = 1; i <= 6; i++) {
                const r = maxR * 0.1 + (i / 6) * maxR * 0.85;
                ctx.beginPath();
                ctx.ellipse(cx, cy, r, r * 0.28, 0, 0, Math.PI * 2);
                ctx.stroke();
              }
              break;
            }

            case 2: {
              // Fusion: intense pulsating central glow + energy rays
              const pulse = 1 + Math.sin(this.time * 0.004) * 0.2;
              // Outer warm glow
              const fg1 = ctx.createRadialGradient(cx, cy, 0, cx, cy, maxR * 0.45 * pulse);
              fg1.addColorStop(0, 'rgba(255, 255, 240, 0.4)');
              fg1.addColorStop(0.2, 'rgba(255, 220, 100, 0.2)');
              fg1.addColorStop(0.5, 'rgba(255, 150, 30, 0.06)');
              fg1.addColorStop(1, 'rgba(0, 0, 0, 0)');
              ctx.fillStyle = fg1;
              ctx.fillRect(0, 0, w, h);
              // White-hot core
              const fg2 = ctx.createRadialGradient(cx, cy, 0, cx, cy, maxR * 0.14 * pulse);
              fg2.addColorStop(0, 'rgba(255, 255, 255, 0.5)');
              fg2.addColorStop(0.5, 'rgba(255, 240, 180, 0.25)');
              fg2.addColorStop(1, 'rgba(255, 200, 80, 0)');
              ctx.fillStyle = fg2;
              ctx.fillRect(0, 0, w, h);
              // Energy rays radiating outward
              ctx.save();
              ctx.translate(cx, cy);
              ctx.globalAlpha = 0.06 + Math.sin(this.time * 0.003) * 0.03;
              const numRays = 12;
              for (let i = 0; i < numRays; i++) {
                const rayAngle = (i / numRays) * Math.PI * 2 + this.time * 0.0003;
                const rayLen = maxR * (0.3 + Math.sin(this.time * 0.002 + i) * 0.15) * pulse;
                ctx.beginPath();
                ctx.moveTo(0, 0);
                const spread = 0.06;
                ctx.lineTo(Math.cos(rayAngle - spread) * rayLen, Math.sin(rayAngle - spread) * rayLen);
                ctx.lineTo(Math.cos(rayAngle + spread) * rayLen, Math.sin(rayAngle + spread) * rayLen);
                ctx.closePath();
                ctx.fillStyle = 'rgba(255, 230, 140, 0.8)';
                ctx.fill();
              }
              ctx.restore();
              ctx.globalAlpha = 1;
              // Heat shimmer effect — slight distortion rendered as wavy transparent overlay
              ctx.save();
              ctx.globalAlpha = 0.02;
              for (let si = 0; si < 5; si++) {
                const shimY = cy + Math.sin(this.time * 0.003 + si * 1.2) * maxR * 0.3;
                const shimW = maxR * 0.6;
                ctx.fillStyle = 'rgba(255, 200, 100, 1)';
                ctx.fillRect(cx - shimW / 2, shimY - 1, shimW, 2);
              }
              ctx.restore();
              ctx.globalAlpha = 1;
              break;
            }

            case 3: {
              // Accretion: solid yellow sun sphere + glow + orbit guides
              // Sun glow
              const sg = ctx.createRadialGradient(cx, cy, 0, cx, cy, maxR * 0.12);
              sg.addColorStop(0, 'rgba(255, 240, 160, 0.4)');
              sg.addColorStop(0.4, 'rgba(255, 200, 80, 0.15)');
              sg.addColorStop(1, 'rgba(0, 0, 0, 0)');
              ctx.fillStyle = sg;
              ctx.fillRect(0, 0, w, h);
              // Solid sun sphere
              ctx.beginPath();
              ctx.arc(cx, cy, maxR * 0.035, 0, Math.PI * 2);
              ctx.fillStyle = '#ffe070';
              ctx.fill();
              // Faint orbit ellipses
              ctx.strokeStyle = 'rgba(120, 130, 160, 0.06)';
              ctx.lineWidth = 0.5;
              for (let i = 0; i < 6; i++) {
                const r = maxR * 0.15 + (i / 6) * maxR * 0.72;
                ctx.beginPath();
                ctx.ellipse(cx, cy, r, r * 0.35, 0, 0, Math.PI * 2);
                ctx.stroke();
              }
              break;
            }

            case 4: {
              // Habitability: Sun glow + orbit rings + planet bodies
              // Sun glow
              const sunG = ctx.createRadialGradient(cx, cy, 0, cx, cy, maxR * 0.1);
              sunG.addColorStop(0, 'rgba(255, 240, 160, 0.5)');
              sunG.addColorStop(0.4, 'rgba(255, 200, 80, 0.2)');
              sunG.addColorStop(1, 'rgba(0, 0, 0, 0)');
              ctx.fillStyle = sunG;
              ctx.fillRect(0, 0, w, h);
              // Orbit rings
              ctx.strokeStyle = 'rgba(100, 120, 180, 0.08)';
              ctx.lineWidth = 0.5;
              for (const planet of this.planets) {
                const r = planet.orbitFrac * maxR;
                ctx.beginPath();
                ctx.ellipse(cx, cy, r, r * 0.45, 0, 0, Math.PI * 2);
                ctx.stroke();
              }
              // Draw solid planet bodies
              for (let pi = 0; pi < this.planets.length; pi++) {
                const planet = this.planets[pi];
                const angle = this.planetAngles[pi];
                const r = planet.orbitFrac * maxR;
                const px = cx + Math.cos(angle) * r;
                const py = cy + Math.sin(angle) * r * 0.45;
                // Planet body
                ctx.beginPath();
                ctx.arc(px, py, planet.size, 0, Math.PI * 2);
                ctx.fillStyle = 'rgb(' + planet.r + ',' + planet.g + ',' + planet.b + ')';
                ctx.globalAlpha = 0.9;
                ctx.fill();
                // Small glow
                const pg = ctx.createRadialGradient(px, py, planet.size * 0.5, px, py, planet.size * 2.5);
                pg.addColorStop(0, 'rgba(' + planet.r + ',' + planet.g + ',' + planet.b + ',0.15)');
                pg.addColorStop(1, 'rgba(0,0,0,0)');
                ctx.fillStyle = pg;
                ctx.globalAlpha = 1;
                ctx.fillRect(px - planet.size * 3, py - planet.size * 3, planet.size * 6, planet.size * 6);
                // Saturn ring
                if (planet.name === 'Saturn') {
                  ctx.beginPath();
                  ctx.ellipse(px, py, planet.size * 1.8, planet.size * 0.4, -0.3, 0, Math.PI * 2);
                  ctx.strokeStyle = 'rgba(220, 200, 150, 0.5)';
                  ctx.lineWidth = 1.5;
                  ctx.stroke();
                }
              }
              ctx.globalAlpha = 1;
              // Sun body
              ctx.beginPath();
              ctx.arc(cx, cy, maxR * 0.04, 0, Math.PI * 2);
              ctx.fillStyle = '#ffe880';
              ctx.fill();
              break;
            }
          }

          // Draw particles
          for (const p of this.particles) {
            ctx.globalAlpha = Math.max(0, Math.min(1, p.opacity));
            ctx.fillStyle = 'rgb(' + Math.round(p.r) + ',' + Math.round(p.g) + ',' + Math.round(p.b) + ')';
            ctx.beginPath();
            ctx.arc(p.x, p.y, Math.max(0.3, p.radius), 0, Math.PI * 2);
            ctx.fill();
          }
          ctx.globalAlpha = 1;
        }
      };

      /* ============================
         G. TAB CONTROLLER
         ============================ */
      const TabController = {
        currentIndex: 0,
        tabs: [],
        panels: [],

        init() {
          this.tabs = Array.from(document.querySelectorAll('[role="tab"]'));
          this.panels = Array.from(document.querySelectorAll('[role="tabpanel"]'));

          // Click handlers
          this.tabs.forEach((tab, i) => {
            tab.addEventListener('click', () => this.activate(i));
          });

          // Keyboard navigation within tablist
          document.querySelector('[role="tablist"]').addEventListener('keydown', (e) => {
            let newIndex = this.currentIndex;
            switch (e.key) {
              case 'ArrowRight': case 'ArrowDown': newIndex = (this.currentIndex + 1) % 5; break;
              case 'ArrowLeft': case 'ArrowUp': newIndex = (this.currentIndex + 4) % 5; break;
              case 'Home': newIndex = 0; break;
              case 'End': newIndex = 4; break;
              default:
                if (e.key >= '1' && e.key <= '5') newIndex = parseInt(e.key) - 1;
                else return;
            }
            e.preventDefault();
            this.activate(newIndex);
            this.tabs[newIndex].focus();
          });

          // URL hash
          this.handleHash();
          window.addEventListener('hashchange', () => this.handleHash());
        },

        activate(index) {
          if (index === this.currentIndex) return;
          this.currentIndex = index;

          // Update ARIA
          this.tabs.forEach((tab, i) => {
            const active = i === index;
            tab.setAttribute('aria-selected', active);
            tab.setAttribute('tabindex', active ? '0' : '-1');
          });
          this.panels.forEach((panel, i) => {
            panel.setAttribute('aria-hidden', i !== index);
          });

          // Update URL hash (without scrolling)
          history.replaceState(null, '', '#' + STAGES[index].hash);

          // Animate
          AnimationEngine.morphTo(index);

          // Status
          document.getElementById('status-text').textContent =
            'Stage ' + (index + 1) + ' of 5 \u2014 ' + STAGES[index].name;

          // Save last stage
          localStorage.setItem('ss-last-stage', index);

          EventBus.emit('stageChange', index);
        },

        handleHash() {
          const hash = location.hash.replace('#', '');
          const idx = STAGES.findIndex(s => s.hash === hash);
          if (idx >= 0 && idx !== this.currentIndex) this.activate(idx);
        }
      };

      /* ============================
         H. SWIPE SUPPORT
         ============================ */
      const SwipeHandler = {
        startX: 0,
        startY: 0,
        init() {
          const main = document.querySelector('main');
          main.addEventListener('touchstart', (e) => {
            this.startX = e.touches[0].clientX;
            this.startY = e.touches[0].clientY;
          }, { passive: true });

          main.addEventListener('touchend', (e) => {
            const dx = e.changedTouches[0].clientX - this.startX;
            const dy = e.changedTouches[0].clientY - this.startY;
            if (Math.abs(dx) > 50 && Math.abs(dx) > Math.abs(dy) * 1.5) {
              if (dx < 0 && TabController.currentIndex < 4) {
                TabController.activate(TabController.currentIndex + 1);
              } else if (dx > 0 && TabController.currentIndex > 0) {
                TabController.activate(TabController.currentIndex - 1);
              }
            }
          }, { passive: true });
        }
      };

      /* ============================
         I. EASTER EGG — Konami Code
         ============================ */
      // EASTER EGG: Konami code triggers a shooting star shower
      const EasterEgg = {
        sequence: ['ArrowUp','ArrowUp','ArrowDown','ArrowDown','ArrowLeft','ArrowRight','ArrowLeft','ArrowRight','b','a'],
        buffer: [],

        init() {
          document.addEventListener('keydown', (e) => {
            this.buffer.push(e.key);
            if (this.buffer.length > this.sequence.length) {
              this.buffer.shift();
            }
            if (this.buffer.length === this.sequence.length &&
                this.buffer.every((k, i) => k === this.sequence[i])) {
              this.trigger();
              this.buffer = [];
            }
          });
        },

        trigger() {
          ToastManager.show('You found the secret! Shooting stars incoming...', 4000);
          // Make all particles shoot across screen
          const cx = AnimationEngine.width / 2;
          for (const p of AnimationEngine.particles) {
            p.targetX = AnimationEngine.width + Math.random() * 200;
            p.targetY = -100 + Math.random() * AnimationEngine.height * 0.5;
            p.tr = 255; p.tg = 255; p.tb = 200 + Math.random() * 55;
            p.targetRadius = 1 + Math.random() * 3;
            p.targetOpacity = 0.7 + Math.random() * 0.3;
            p.speed = 2 + Math.random() * 3;
          }
          // Reset after 3 seconds
          setTimeout(() => {
            AnimationEngine.setScene(AnimationEngine.currentStage, false);
          }, 3000);
        }
      };

      /* ============================
         J. OFFLINE DETECTION
         ============================ */
      const OfflineDetector = {
        init() {
          const badge = document.getElementById('offline-badge');
          const update = () => {
            badge.classList.toggle('visible', !navigator.onLine);
          };
          window.addEventListener('online', update);
          window.addEventListener('offline', update);
          update();
        }
      };

      /* ============================
         K. SERVICE WORKER
         ============================ */
      const ServiceWorkerManager = {
        init() {
          if ('serviceWorker' in navigator) {
            const swCode = `
              const CACHE_NAME = 'solar-system-v1';
              self.addEventListener('install', (e) => {
                e.waitUntil(
                  caches.open(CACHE_NAME).then((cache) => cache.addAll([self.location.origin + self.location.pathname.replace('sw.js', 'solar-system.html')]))
                );
                self.skipWaiting();
              });
              self.addEventListener('activate', (e) => {
                e.waitUntil(
                  caches.keys().then((keys) => Promise.all(keys.filter(k => k !== CACHE_NAME).map(k => caches.delete(k))))
                );
                self.clients.claim();
              });
              self.addEventListener('fetch', (e) => {
                e.respondWith(
                  fetch(e.request).catch(() => caches.match(e.request))
                );
              });
            `;
            const blob = new Blob([swCode], { type: 'application/javascript' });
            const swUrl = URL.createObjectURL(blob);
            navigator.serviceWorker.register(swUrl).catch(() => {
              // Service worker registration failed — app still works without it
            });
          }
        }
      };

      /* ============================
         L. APP INIT
         ============================ */
      function init() {
        ToastManager.init();
        ThemeManager.init();
        TextModeManager.init();
        AnimationEngine.init();
        TabController.init();
        SwipeHandler.init();
        HelpManager.init();
        EasterEgg.init();
        OfflineDetector.init();
        ServiceWorkerManager.init();

        // Restore last stage
        const lastStage = parseInt(localStorage.getItem('ss-last-stage'));
        if (lastStage >= 0 && lastStage <= 4 && lastStage !== 0) {
          TabController.activate(lastStage);
        }

        // Welcome toast (only if help overlay not shown)
        if (localStorage.getItem('ss-help-dismissed')) {
          setTimeout(() => ToastManager.show('Welcome back! Explore the 5 stages of solar system formation.'), 800);
        }
      }

      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }

    })();
  </script>
</body>
</html>
