<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>Emotional Horseshoes</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:ital,wght@0,400;0,500;0,600;1,400&family=Nunito+Sans:opsz,wght@6..12,300;6..12,400;6..12,500;6..12,600&display=swap" rel="stylesheet">
  <style>
    :root {
      /* Scandinavian palette - warm, natural, hygge */
      --bg-primary: #faf9f7;
      --bg-secondary: #f5f3f0;
      --bg-card: #ffffff;
      --bg-hover: #f0eeeb;
      --bg-active: #e8e5e1;
      
      --text-primary: #3d3a36;
      --text-secondary: #6b6660;
      --text-tertiary: #9a948d;
      --text-muted: #c4beb6;
      
      --border-light: #e8e5e1;
      --border-medium: #d9d4cd;
      
      --accent-sage: #7d9a7d;
      --accent-sage-light: #a8c4a8;
      --accent-warm: #c4a77d;
      --accent-rose: #c49a9a;
      
      --shadow-soft: 0 2px 8px rgba(61, 58, 54, 0.04);
      --shadow-medium: 0 4px 16px rgba(61, 58, 54, 0.06);
      --shadow-lift: 0 8px 24px rgba(61, 58, 54, 0.08);
      
      --radius-sm: 8px;
      --radius-md: 12px;
      --radius-lg: 16px;
      --radius-xl: 24px;
      
      --transition-fast: 0.15s ease;
      --transition-base: 0.25s ease;
      --transition-slow: 0.4s ease;
      
      --font-display: 'Cormorant Garamond', Georgia, serif;
      --font-body: 'Nunito Sans', -apple-system, sans-serif;
    }
    
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    html, body {
      height: 100%;
      overflow: hidden;
    }
    
    body {
      font-family: var(--font-body);
      background: var(--bg-primary);
      color: var(--text-primary);
      line-height: 1.6;
      font-size: 15px;
      font-weight: 400;
    }
    
    /* App container */
    .app {
      display: flex;
      flex-direction: column;
      height: 100vh;
      height: 100dvh;
    }
    
    /* Header */
    .header {
      padding: 1.25rem 1.5rem;
      background: var(--bg-card);
      border-bottom: 1px solid var(--border-light);
      flex-shrink: 0;
    }
    
    .header-content {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
    }
    
    .brand {
      display: flex;
      align-items: baseline;
      gap: 0.75rem;
    }
    
    .brand h1 {
      font-family: var(--font-display);
      font-size: 1.5rem;
      font-weight: 500;
      color: var(--text-primary);
      letter-spacing: -0.01em;
    }
    
    .brand-tagline {
      font-size: 0.8rem;
      color: var(--text-tertiary);
      font-style: italic;
    }
    
    .header-actions {
      display: flex;
      gap: 0.5rem;
    }
    
    .icon-btn {
      width: 40px;
      height: 40px;
      border: none;
      background: transparent;
      border-radius: var(--radius-sm);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-tertiary);
      transition: all var(--transition-fast);
    }
    
    .icon-btn:hover {
      background: var(--bg-hover);
      color: var(--text-secondary);
    }
    
    .icon-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
    }
    
    /* Navigation tabs */
    .nav {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border-light);
      flex-shrink: 0;
    }
    
    .nav-tabs {
      max-width: 1200px;
      margin: 0 auto;
      display: flex;
      padding: 0 1.5rem;
    }
    
    .nav-tab {
      padding: 1rem 1.5rem;
      border: none;
      background: transparent;
      font-family: var(--font-body);
      font-size: 0.875rem;
      font-weight: 500;
      color: var(--text-tertiary);
      cursor: pointer;
      position: relative;
      transition: color var(--transition-fast);
    }
    
    .nav-tab:hover {
      color: var(--text-secondary);
    }
    
    .nav-tab.active {
      color: var(--accent-sage);
    }
    
    .nav-tab.active::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 1rem;
      right: 1rem;
      height: 2px;
      background: var(--accent-sage);
      border-radius: 1px;
    }
    
    /* Main content */
    .main {
      flex: 1;
      overflow: hidden;
      position: relative;
    }
    
    .tab-panel {
      position: absolute;
      inset: 0;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 1.5rem;
      opacity: 0;
      visibility: hidden;
      transition: opacity var(--transition-base), visibility var(--transition-base);
    }
    
    .tab-panel.active {
      opacity: 1;
      visibility: visible;
    }
    
    .tab-content {
      max-width: 1200px;
      margin: 0 auto;
    }
    
    /* Explore tab */
    .explore-controls {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      margin-bottom: 1.5rem;
    }
    
    .order-btn {
      padding: 0.625rem 1rem;
      border: 1px solid var(--border-light);
      background: var(--bg-card);
      border-radius: var(--radius-md);
      font-family: var(--font-body);
      font-size: 0.8rem;
      color: var(--text-secondary);
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    
    .order-btn:hover {
      border-color: var(--border-medium);
      background: var(--bg-hover);
    }
    
    .order-btn.active {
      background: var(--accent-sage);
      border-color: var(--accent-sage);
      color: white;
    }
    
    .axis-description {
      text-align: center;
      font-size: 0.8rem;
      color: var(--text-tertiary);
      font-style: italic;
      margin-bottom: 1.5rem;
    }
    
    .horseshoe-grid {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .horseshoe-row {
      display: flex;
      align-items: center;
      gap: 1rem;
    }
    
    .z-label {
      width: 120px;
      font-size: 0.75rem;
      color: var(--text-tertiary);
      text-align: right;
      flex-shrink: 0;
    }
    
    .z-label-right {
      width: 120px;
      font-size: 0.75rem;
      color: var(--text-tertiary);
      text-align: left;
      flex-shrink: 0;
    }
    
    .horseshoe-card {
      flex: 1;
      max-width: 560px;
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 1.25rem;
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--border-light);
      cursor: pointer;
      transition: all var(--transition-base);
    }
    
    .horseshoe-card:hover {
      box-shadow: var(--shadow-medium);
      transform: translateY(-2px);
    }
    
    .horseshoe-card.expanded {
      box-shadow: var(--shadow-lift);
    }
    
    .horseshoe-svg {
      width: 100%;
      height: 120px;
    }
    
    .captured-by {
      text-align: center;
      font-size: 0.75rem;
      color: var(--text-muted);
      margin-top: 0.5rem;
    }
    
    .captured-by span {
      font-style: italic;
      color: var(--text-tertiary);
    }
    
    .horseshoe-detail {
      max-height: 0;
      overflow: hidden;
      transition: max-height var(--transition-slow);
    }
    
    .horseshoe-card.expanded .horseshoe-detail {
      max-height: 200px;
    }
    
    .horseshoe-detail-content {
      padding-top: 1rem;
      margin-top: 1rem;
      border-top: 1px solid var(--border-light);
      font-size: 0.85rem;
      color: var(--text-secondary);
      line-height: 1.6;
    }
    
    /* Reflect tab */
    .reflect-intro {
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .reflect-intro h2 {
      font-family: var(--font-display);
      font-size: 1.75rem;
      font-weight: 500;
      margin-bottom: 0.5rem;
    }
    
    .reflect-intro p {
      color: var(--text-secondary);
      max-width: 500px;
      margin: 0 auto;
    }
    
    .reflect-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
      gap: 1rem;
    }
    
    .reflect-card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 1.25rem;
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--border-light);
    }
    
    .reflect-card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .reflect-card-title {
      font-family: var(--font-display);
      font-size: 1.1rem;
      font-weight: 500;
    }
    
    .reflect-card-agency {
      font-size: 0.7rem;
      color: var(--accent-sage);
      padding: 0.25rem 0.5rem;
      background: rgba(125, 154, 125, 0.1);
      border-radius: var(--radius-sm);
    }
    
    .reflect-slider-container {
      padding: 0.5rem 0;
    }
    
    .reflect-slider-labels {
      display: flex;
      justify-content: space-between;
      font-size: 0.75rem;
      margin-bottom: 0.5rem;
    }
    
    .reflect-slider-left {
      color: var(--text-tertiary);
    }
    
    .reflect-slider-right {
      color: var(--text-tertiary);
    }
    
    .reflect-slider {
      width: 100%;
      height: 8px;
      -webkit-appearance: none;
      appearance: none;
      background: var(--bg-secondary);
      border-radius: 4px;
      outline: none;
      cursor: pointer;
    }
    
    .reflect-slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--accent-sage);
      cursor: pointer;
      box-shadow: var(--shadow-medium);
      transition: transform var(--transition-fast);
    }
    
    .reflect-slider::-webkit-slider-thumb:hover {
      transform: scale(1.1);
    }
    
    .reflect-slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      border-radius: 50%;
      background: var(--accent-sage);
      cursor: pointer;
      border: none;
      box-shadow: var(--shadow-medium);
    }
    
    .reflect-position {
      text-align: center;
      margin-top: 0.75rem;
      font-size: 0.8rem;
      color: var(--text-secondary);
      min-height: 1.5em;
    }
    
    .reflect-actions {
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-top: 2rem;
      padding-top: 1.5rem;
      border-top: 1px solid var(--border-light);
    }
    
    .btn {
      padding: 0.75rem 1.5rem;
      border: none;
      border-radius: var(--radius-md);
      font-family: var(--font-body);
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    
    .btn-primary {
      background: var(--accent-sage);
      color: white;
    }
    
    .btn-primary:hover {
      background: #6b876b;
    }
    
    .btn-secondary {
      background: var(--bg-secondary);
      color: var(--text-secondary);
    }
    
    .btn-secondary:hover {
      background: var(--bg-active);
    }
    
    /* Track tab */
    .track-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.5rem;
      flex-wrap: wrap;
      gap: 1rem;
    }
    
    .track-header h2 {
      font-family: var(--font-display);
      font-size: 1.5rem;
      font-weight: 500;
    }
    
    .track-stats {
      display: flex;
      gap: 1.5rem;
    }
    
    .track-stat {
      text-align: center;
    }
    
    .track-stat-value {
      font-family: var(--font-display);
      font-size: 1.5rem;
      font-weight: 500;
      color: var(--accent-sage);
    }
    
    .track-stat-label {
      font-size: 0.75rem;
      color: var(--text-tertiary);
    }
    
    .track-empty {
      text-align: center;
      padding: 4rem 2rem;
      color: var(--text-tertiary);
    }
    
    .track-empty-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }
    
    .track-entries {
      display: flex;
      flex-direction: column;
      gap: 1rem;
    }
    
    .track-entry {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 1.25rem;
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--border-light);
    }
    
    .track-entry-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    
    .track-entry-date {
      font-family: var(--font-display);
      font-size: 1rem;
      font-weight: 500;
    }
    
    .track-entry-time {
      font-size: 0.75rem;
      color: var(--text-tertiary);
    }
    
    .track-entry-emotions {
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
    }
    
    .track-emotion-tag {
      font-size: 0.75rem;
      padding: 0.25rem 0.625rem;
      border-radius: var(--radius-sm);
      background: var(--bg-secondary);
      color: var(--text-secondary);
    }
    
    .track-emotion-tag.positive {
      background: rgba(125, 154, 125, 0.15);
      color: var(--accent-sage);
    }
    
    .track-emotion-tag.negative {
      background: rgba(196, 154, 154, 0.15);
      color: var(--accent-rose);
    }
    
    .track-entry-note {
      margin-top: 1rem;
      padding-top: 1rem;
      border-top: 1px solid var(--border-light);
      font-size: 0.875rem;
      color: var(--text-secondary);
      font-style: italic;
    }
    
    .track-entry-actions {
      display: flex;
      gap: 0.5rem;
      margin-top: 1rem;
    }
    
    .track-entry-btn {
      font-size: 0.75rem;
      padding: 0.375rem 0.75rem;
      border: 1px solid var(--border-light);
      background: transparent;
      border-radius: var(--radius-sm);
      color: var(--text-tertiary);
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    
    .track-entry-btn:hover {
      border-color: var(--border-medium);
      color: var(--text-secondary);
    }
    
    .track-entry-btn.delete:hover {
      border-color: var(--accent-rose);
      color: var(--accent-rose);
    }
    
    .track-entry-btn.confirm-delete {
      background: var(--accent-rose);
      border-color: var(--accent-rose);
      color: white;
    }
    
    /* Note modal */
    .note-modal {
      position: fixed;
      inset: 0;
      background: rgba(61, 58, 54, 0.3);
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 1rem;
      opacity: 0;
      visibility: hidden;
      transition: all var(--transition-base);
      z-index: 100;
    }
    
    .note-modal.active {
      opacity: 1;
      visibility: visible;
    }
    
    .note-modal-content {
      background: var(--bg-card);
      border-radius: var(--radius-xl);
      padding: 1.5rem;
      width: 100%;
      max-width: 500px;
      box-shadow: var(--shadow-lift);
      transform: translateY(20px);
      transition: transform var(--transition-base);
    }
    
    .note-modal.active .note-modal-content {
      transform: translateY(0);
    }
    
    .note-modal h3 {
      font-family: var(--font-display);
      font-size: 1.25rem;
      font-weight: 500;
      margin-bottom: 1rem;
    }
    
    .note-textarea {
      width: 100%;
      min-height: 120px;
      padding: 1rem;
      border: 1px solid var(--border-light);
      border-radius: var(--radius-md);
      font-family: var(--font-body);
      font-size: 0.9rem;
      resize: vertical;
      outline: none;
      transition: border-color var(--transition-fast);
    }
    
    .note-textarea:focus {
      border-color: var(--accent-sage);
    }
    
    .note-modal-actions {
      display: flex;
      justify-content: flex-end;
      gap: 0.75rem;
      margin-top: 1rem;
    }
    
    /* Toast notifications */
    .toast-container {
      position: fixed;
      bottom: 1.5rem;
      left: 50%;
      transform: translateX(-50%);
      z-index: 200;
      display: flex;
      flex-direction: column;
      gap: 0.5rem;
      pointer-events: none;
    }
    
    .toast {
      background: var(--text-primary);
      color: white;
      padding: 0.75rem 1.25rem;
      border-radius: var(--radius-md);
      font-size: 0.875rem;
      box-shadow: var(--shadow-lift);
      opacity: 0;
      transform: translateY(10px);
      transition: all var(--transition-base);
      pointer-events: auto;
    }
    
    .toast.show {
      opacity: 1;
      transform: translateY(0);
    }
    
    /* Settings panel */
    .settings-overlay {
      position: fixed;
      inset: 0;
      background: rgba(61, 58, 54, 0.3);
      opacity: 0;
      visibility: hidden;
      transition: all var(--transition-base);
      z-index: 150;
    }
    
    .settings-overlay.active {
      opacity: 1;
      visibility: visible;
    }
    
    .settings-panel {
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      width: 100%;
      max-width: 400px;
      background: var(--bg-card);
      box-shadow: var(--shadow-lift);
      transform: translateX(100%);
      transition: transform var(--transition-base);
      z-index: 151;
      display: flex;
      flex-direction: column;
    }
    
    .settings-panel.active {
      transform: translateX(0);
    }
    
    .settings-header {
      padding: 1.25rem 1.5rem;
      border-bottom: 1px solid var(--border-light);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .settings-header h2 {
      font-family: var(--font-display);
      font-size: 1.25rem;
      font-weight: 500;
    }
    
    .settings-body {
      flex: 1;
      overflow-y: auto;
      padding: 1.5rem;
    }
    
    .settings-section {
      margin-bottom: 2rem;
    }
    
    .settings-section h3 {
      font-size: 0.75rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--text-tertiary);
      margin-bottom: 1rem;
    }
    
    .settings-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 0.75rem 0;
      border-bottom: 1px solid var(--border-light);
    }
    
    .settings-row:last-child {
      border-bottom: none;
    }
    
    .settings-label {
      font-size: 0.9rem;
      color: var(--text-secondary);
    }
    
    .settings-value {
      font-size: 0.875rem;
      color: var(--text-tertiary);
    }
    
    .settings-footer {
      padding: 1.25rem 1.5rem;
      border-top: 1px solid var(--border-light);
    }
    
    .btn-danger {
      background: var(--accent-rose);
      color: white;
      width: 100%;
    }
    
    .btn-danger:hover {
      background: #b08585;
    }
    
    /* Help panel */
    .help-content {
      font-size: 0.875rem;
      color: var(--text-secondary);
      line-height: 1.7;
    }
    
    .help-content h4 {
      font-family: var(--font-display);
      font-size: 1.1rem;
      font-weight: 500;
      color: var(--text-primary);
      margin: 1.5rem 0 0.75rem;
    }
    
    .help-content h4:first-child {
      margin-top: 0;
    }
    
    .help-content p {
      margin-bottom: 0.75rem;
    }
    
    .help-shortcut {
      display: inline-block;
      padding: 0.125rem 0.5rem;
      background: var(--bg-secondary);
      border-radius: var(--radius-sm);
      font-family: monospace;
      font-size: 0.8rem;
    }
    
    /* Explanation card */
    .explanation-card {
      background: var(--bg-card);
      border-radius: var(--radius-lg);
      padding: 1.5rem;
      box-shadow: var(--shadow-soft);
      border: 1px solid var(--border-light);
      margin-top: 2rem;
    }
    
    .explanation-card h3 {
      font-family: var(--font-display);
      font-size: 1.1rem;
      font-weight: 500;
      text-align: center;
      margin-bottom: 1rem;
    }
    
    .explanation-card p {
      font-size: 0.875rem;
      color: var(--text-secondary);
      margin-bottom: 0.75rem;
      line-height: 1.6;
    }
    
    .explanation-quote {
      margin-top: 1.25rem;
      padding-top: 1.25rem;
      border-top: 1px solid var(--border-light);
      text-align: center;
      font-size: 0.85rem;
      color: var(--text-tertiary);
      font-style: italic;
    }
    
    .explanation-quote cite {
      display: block;
      font-style: normal;
      margin-top: 0.25rem;
      font-size: 0.8rem;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .brand-tagline {
        display: none;
      }
      
      .z-label, .z-label-right {
        display: none;
      }
      
      .horseshoe-row {
        justify-content: center;
      }
      
      .horseshoe-card {
        max-width: 100%;
      }
      
      .track-stats {
        width: 100%;
        justify-content: space-around;
      }
      
      .reflect-grid {
        grid-template-columns: 1fr;
      }
    }
    
    @media (max-width: 480px) {
      .header {
        padding: 1rem;
      }
      
      .brand h1 {
        font-size: 1.25rem;
      }
      
      .nav-tab {
        padding: 0.875rem 1rem;
        font-size: 0.8rem;
      }
      
      .tab-panel {
        padding: 1rem;
      }
      
      .explore-controls {
        justify-content: center;
      }
      
      .order-btn {
        flex: 1;
        min-width: 140px;
        text-align: center;
      }
    }
    
    /* Animations */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    .animate-in {
      animation: fadeIn 0.4s ease forwards;
    }
    
    /* Hide scrollbar but keep functionality */
    .tab-panel::-webkit-scrollbar {
      width: 8px;
    }
    
    .tab-panel::-webkit-scrollbar-track {
      background: transparent;
    }
    
    .tab-panel::-webkit-scrollbar-thumb {
      background: var(--border-medium);
      border-radius: 4px;
    }
    
    .tab-panel::-webkit-scrollbar-thumb:hover {
      background: var(--text-muted);
    }
  </style>
</head>
<body>
  <div class="app">
    <!-- Header -->
    <header class="header">
      <div class="header-content">
        <div class="brand">
          <h1>Emotional Horseshoes</h1>
          <span class="brand-tagline">Agency rises. Capture descends.</span>
        </div>
        <div class="header-actions">
          <button class="icon-btn" id="undo-btn" title="Undo (Ctrl+Z)" disabled>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M3 7v6h6"/><path d="M21 17a9 9 0 0 0-9-9 9 9 0 0 0-6 2.3L3 13"/>
            </svg>
          </button>
          <button class="icon-btn" id="redo-btn" title="Redo (Ctrl+Y)" disabled>
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <path d="M21 7v6h-6"/><path d="M3 17a9 9 0 0 1 9-9 9 9 0 0 1 6 2.3l3 2.7"/>
            </svg>
          </button>
          <button class="icon-btn" id="help-btn" title="Help (?)">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="10"/><path d="M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3"/><line x1="12" y1="17" x2="12.01" y2="17"/>
            </svg>
          </button>
          <button class="icon-btn" id="settings-btn" title="Settings">
            <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
              <circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z"/>
            </svg>
          </button>
        </div>
      </div>
    </header>
    
    <!-- Navigation -->
    <nav class="nav">
      <div class="nav-tabs">
        <button class="nav-tab active" data-tab="explore">Explore</button>
        <button class="nav-tab" data-tab="reflect">Reflect</button>
        <button class="nav-tab" data-tab="track">Track</button>
      </div>
    </nav>
    
    <!-- Main content -->
    <main class="main">
      <!-- Explore tab -->
      <div class="tab-panel active" id="explore-panel">
        <div class="tab-content">
          <div class="explore-controls">
            <button class="order-btn active" data-order="action">Withdrawal → Confrontation</button>
            <button class="order-btn" data-order="locus">Self → Other</button>
            <button class="order-btn" data-order="temporal">Past → Future</button>
            <button class="order-btn" data-order="arousal">Low → High Activation</button>
          </div>
          
          <p class="axis-description" id="axis-description">z-axis: action tendency</p>
          
          <div class="horseshoe-grid" id="horseshoe-grid"></div>
          
          <div class="explanation-card">
            <h3>Reading the Shape</h3>
            <p><strong style="color: var(--accent-sage);">Top (curve):</strong> Low involvement. Not numbness—<em>not needing</em>. Attention is yours to direct.</p>
            <p><strong style="color: var(--text-tertiary);">Bottom (tips):</strong> High involvement. The object commands you. Even positive capture is still capture.</p>
            <p><strong style="color: var(--text-tertiary);">Z-axis:</strong> Use the buttons above to explore different orderings of the emotional pairs.</p>
            <div class="explanation-quote">
              "He who binds to himself a joy / Does the winged life destroy"
              <cite>— William Blake</cite>
            </div>
          </div>
        </div>
      </div>
      
      <!-- Reflect tab -->
      <div class="tab-panel" id="reflect-panel">
        <div class="tab-content">
          <div class="reflect-intro">
            <h2>Where Are You Now?</h2>
            <p>Place yourself on each spectrum. The middle represents equanimity—neither captured by the negative nor the positive pole.</p>
          </div>
          
          <div class="reflect-grid" id="reflect-grid"></div>
          
          <div class="reflect-actions">
            <button class="btn btn-secondary" id="reset-reflect-btn">Reset All</button>
            <button class="btn btn-primary" id="save-reflect-btn">Save This Moment</button>
          </div>
        </div>
      </div>
      
      <!-- Track tab -->
      <div class="tab-panel" id="track-panel">
        <div class="tab-content">
          <div class="track-header">
            <h2>Your Journey</h2>
            <div class="track-stats">
              <div class="track-stat">
                <div class="track-stat-value" id="total-entries">0</div>
                <div class="track-stat-label">entries</div>
              </div>
              <div class="track-stat">
                <div class="track-stat-value" id="current-streak">0</div>
                <div class="track-stat-label">day streak</div>
              </div>
            </div>
          </div>
          
          <div id="track-content">
            <div class="track-empty">
              <div class="track-empty-icon">◯</div>
              <p>No entries yet. Visit the Reflect tab to record your first moment.</p>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>
  
  <!-- Note modal -->
  <div class="note-modal" id="note-modal">
    <div class="note-modal-content">
      <h3>Add a Note</h3>
      <textarea class="note-textarea" id="note-textarea" placeholder="What's on your mind? (optional)"></textarea>
      <div class="note-modal-actions">
        <button class="btn btn-secondary" id="note-cancel-btn">Cancel</button>
        <button class="btn btn-primary" id="note-save-btn">Save Entry</button>
      </div>
    </div>
  </div>
  
  <!-- Settings panel -->
  <div class="settings-overlay" id="settings-overlay"></div>
  <div class="settings-panel" id="settings-panel">
    <div class="settings-header">
      <h2>Settings</h2>
      <button class="icon-btn" id="close-settings-btn">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <div class="settings-body" id="settings-body">
      <!-- Will be populated by JS -->
    </div>
    <div class="settings-footer">
      <button class="btn btn-danger" id="clear-data-btn">Clear All Data</button>
    </div>
  </div>
  
  <!-- Help panel (reuses settings panel structure) -->
  <div class="settings-panel" id="help-panel">
    <div class="settings-header">
      <h2>About & Help</h2>
      <button class="icon-btn" id="close-help-btn">
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
          <line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/>
        </svg>
      </button>
    </div>
    <div class="settings-body">
      <div class="help-content">
        <h4>The Horseshoe Model</h4>
        <p>Each emotional horseshoe represents a spectrum where the two tips (bottom) are states of <em>capture</em>—being seized by something outside your control. The top of the curve represents <em>agency</em>—a state of equanimity where you can engage without compulsion.</p>
        <p>Hate and love aren't opposites on a line. They're neighbors at the bottom of a curve, both states where the other's significance dominates your attention.</p>
        
        <h4>Using This Tool</h4>
        <p><strong>Explore:</strong> Browse the emotional pairs and their relationships. Click any card to learn more.</p>
        <p><strong>Reflect:</strong> Place yourself on each spectrum. Where are you right now?</p>
        <p><strong>Track:</strong> Save your reflections over time. Notice patterns.</p>
        
        <h4>Keyboard Shortcuts</h4>
        <p><span class="help-shortcut">1</span> <span class="help-shortcut">2</span> <span class="help-shortcut">3</span> Switch tabs</p>
        <p><span class="help-shortcut">Ctrl+Z</span> Undo</p>
        <p><span class="help-shortcut">Ctrl+Y</span> Redo</p>
        <p><span class="help-shortcut">Esc</span> Close panels</p>
        <p><span class="help-shortcut">?</span> Toggle help</p>
      </div>
    </div>
  </div>
  
  <!-- Toast container -->
  <div class="toast-container" id="toast-container"></div>

  <script>
    // ==================== DATA ====================
    const emotions = {
      hateLove: { 
        key: 'hateLove',
        left: "HATE", 
        right: "LOVE", 
        top: "EQUANIMITY", 
        leftColor: "#c9615a", 
        rightColor: "#c97d9a", 
        shared: "the other's significance",
        description: "Both poles make the other central to your world. Equanimity isn't indifference—it's being able to engage with others without their significance commanding you."
      },
      sadnessJoy: { 
        key: 'sadnessJoy',
        left: "SADNESS", 
        right: "JOY", 
        top: "CONTENTMENT", 
        leftColor: "#6b8cae", 
        rightColor: "#d4a95a", 
        shared: "outcomes",
        description: "Both arise from attachment to how things turned out. Contentment allows appreciation without dependence on specific results."
      },
      fearAnger: { 
        key: 'fearAnger',
        left: "FEAR", 
        right: "ANGER", 
        top: "SECURITY", 
        leftColor: "#8b7dae", 
        rightColor: "#d4855a", 
        shared: "threat",
        description: "Fear flees what anger confronts—but both are organized around threat. Security isn't the absence of danger but the absence of being controlled by it."
      },
      disgustTrust: { 
        key: 'disgustTrust',
        left: "DISGUST", 
        right: "TRUST", 
        top: "DISCERNMENT", 
        leftColor: "#8bae6b", 
        rightColor: "#5aa8a8", 
        shared: "needing to evaluate",
        description: "Both involve outsourcing judgment—rejecting or accepting without examination. Discernment allows assessment without compulsion."
      },
      despairHope: { 
        key: 'despairHope',
        left: "DESPAIR", 
        right: "HOPE", 
        top: "PRESENCE", 
        leftColor: "#7a8085", 
        rightColor: "#5aae7d", 
        shared: "the future",
        description: "Despair forecloses the future; hope requires it. Presence is acting without needing either guarantee or promise."
      },
      shamePride: { 
        key: 'shamePride',
        left: "SHAME", 
        right: "PRIDE", 
        top: "SELF-ACCEPTANCE", 
        leftColor: "#ae5a7d", 
        rightColor: "#9a7dae", 
        shared: "self-image",
        description: "Both make your worth contingent on measurement. Self-acceptance isn't self-satisfaction—it's not needing the verdict."
      },
      envyAdmiration: { 
        key: 'envyAdmiration',
        left: "ENVY", 
        right: "ADMIRATION", 
        top: "SELF-CONTAINMENT", 
        leftColor: "#3d6b5a", 
        rightColor: "#5a9ec4", 
        shared: "comparison",
        description: "Envy wants what they have; admiration elevates them. Both require measuring yourself against others. Self-containment allows appreciation without comparison."
      },
      resentmentGratitude: { 
        key: 'resentmentGratitude',
        left: "RESENTMENT", 
        right: "GRATITUDE", 
        top: "STABLE GROUND", 
        leftColor: "#8b4a4a", 
        rightColor: "#4a8b6b", 
        shared: "social debts",
        description: "Resentment tallies what's owed; gratitude tallies what's received. Both keep score. Stable ground is relating without ledgers."
      },
      anxietyExcitement: { 
        key: 'anxietyExcitement',
        left: "ANXIETY", 
        right: "EXCITEMENT", 
        top: "CALM READINESS", 
        leftColor: "#7a5aae", 
        rightColor: "#d49a3d", 
        shared: "anticipated outcomes",
        description: "Same arousal, different valence. Both are captured by what might happen. Calm readiness can meet the future without being seized by it."
      },
      guiltRighteousness: { 
        key: 'guiltRighteousness',
        left: "GUILT", 
        right: "RIGHTEOUSNESS", 
        top: "MORAL EASE", 
        leftColor: "#5a3d6b", 
        rightColor: "#3d8b7a", 
        shared: "self-judgment",
        description: "Guilt condemns the self; righteousness elevates it. Both are caught in moral scorekeeping. Moral ease is acting well without needing the verdict."
      },
      jealousyCompersion: { 
        key: 'jealousyCompersion',
        left: "JEALOUSY", 
        right: "COMPERSION", 
        top: "RELATIONAL SECURITY", 
        leftColor: "#ae4a4a", 
        rightColor: "#4aaec4", 
        shared: "partner's attention",
        description: "Jealousy guards against loss; compersion celebrates their joy. Both organize around the partner's other connections. Security doesn't require either vigilance or forced celebration."
      },
      contemptReverence: { 
        key: 'contemptReverence',
        left: "CONTEMPT", 
        right: "REVERENCE", 
        top: "REGARD", 
        leftColor: "#6b4a2d", 
        rightColor: "#5a5aae", 
        shared: "hierarchy",
        description: "Contempt places below; reverence places above. Both fix others on a vertical axis. Regard sees without ranking."
      },
      regretNostalgia: { 
        key: 'regretNostalgia',
        left: "REGRET", 
        right: "NOSTALGIA", 
        top: "ACCEPTANCE", 
        leftColor: "#5a6b7a", 
        rightColor: "#ae5aae", 
        shared: "the past",
        description: "Regret wishes it different; nostalgia wishes it back. Both are captured by what was. Acceptance lets the past inform without commanding."
      },
      lonelinessEnmeshment: { 
        key: 'lonelinessEnmeshment',
        left: "LONELINESS", 
        right: "ENMESHMENT", 
        top: "SECURE SOLITUDE", 
        leftColor: "#3d4a5a", 
        rightColor: "#c47a8b", 
        shared: "connection needs",
        description: "Loneliness starves for connection; enmeshment drowns in it. Both organize around needing others. Secure solitude can connect without requiring it."
      },
      cravingAversion: { 
        key: 'cravingAversion',
        left: "CRAVING", 
        right: "AVERSION", 
        top: "EQUANIMITY", 
        leftColor: "#ae6b3d", 
        rightColor: "#5a7a3d", 
        shared: "preference",
        description: "Craving grasps; aversion pushes away. Both are captured by preference. Equanimity can prefer without being commanded by preference."
      },
      boredomObsession: { 
        key: 'boredomObsession',
        left: "BOREDOM", 
        right: "OBSESSION", 
        top: "BALANCED ATTENTION", 
        leftColor: "#7a7a7a", 
        rightColor: "#c44a5a", 
        shared: "stimulation need",
        description: "Boredom finds nothing worth attention; obsession can't look away. Both are captured by what holds or fails to hold interest. Balanced attention chooses its focus."
      }
    };
    
    const orderings = {
      action: {
        label: "z-axis: action tendency (withdrawal → confrontation)",
        order: [
          "despairHope", "sadnessJoy", "boredomObsession", "lonelinessEnmeshment",
          "regretNostalgia", "anxietyExcitement", "fearAnger", "guiltRighteousness",
          "shamePride", "cravingAversion", "disgustTrust", "envyAdmiration",
          "jealousyCompersion", "contemptReverence", "resentmentGratitude", "hateLove"
        ],
        zLabels: {
          despairHope: { left: "collapse", right: "surrender" },
          sadnessJoy: { left: "withdraw", right: "receive" },
          boredomObsession: { left: "disengage", right: "immerse" },
          lonelinessEnmeshment: { left: "isolate", right: "merge" },
          regretNostalgia: { left: "ruminate", right: "cherish" },
          anxietyExcitement: { left: "freeze", right: "anticipate" },
          fearAnger: { left: "flee", right: "face" },
          guiltRighteousness: { left: "atone", right: "assert" },
          shamePride: { left: "hide", right: "show" },
          cravingAversion: { left: "grasp", right: "push away" },
          disgustTrust: { left: "reject", right: "approach" },
          envyAdmiration: { left: "covet", right: "appreciate" },
          jealousyCompersion: { left: "guard", right: "celebrate" },
          contemptReverence: { left: "dismiss", right: "honor" },
          resentmentGratitude: { left: "blame", right: "acknowledge" },
          hateLove: { left: "attack", right: "embrace" }
        }
      },
      locus: {
        label: "z-axis: locus of attention (self → other)",
        order: [
          "shamePride", "guiltRighteousness", "despairHope", "anxietyExcitement",
          "regretNostalgia", "sadnessJoy", "cravingAversion", "boredomObsession",
          "fearAnger", "lonelinessEnmeshment", "disgustTrust", "envyAdmiration",
          "jealousyCompersion", "contemptReverence", "resentmentGratitude", "hateLove"
        ],
        zLabels: {
          shamePride: { left: "I am flawed", right: "I am worthy" },
          guiltRighteousness: { left: "I did wrong", right: "I did right" },
          despairHope: { left: "I am helpless", right: "I can act" },
          anxietyExcitement: { left: "I'll fail", right: "I'll thrive" },
          regretNostalgia: { left: "I chose poorly", right: "I lived fully" },
          sadnessJoy: { left: "I have lost", right: "I have gained" },
          cravingAversion: { left: "I need this", right: "I reject this" },
          boredomObsession: { left: "nothing holds me", right: "this consumes me" },
          fearAnger: { left: "I am threatened", right: "I am powerful" },
          lonelinessEnmeshment: { left: "I am unseen", right: "we are one" },
          disgustTrust: { left: "they contaminate", right: "they nourish" },
          envyAdmiration: { left: "they have mine", right: "they inspire me" },
          jealousyCompersion: { left: "they take what's mine", right: "their joy is mine" },
          contemptReverence: { left: "they are beneath", right: "they are above" },
          resentmentGratitude: { left: "they owe me", right: "they gave me" },
          hateLove: { left: "they are wrong", right: "they are precious" }
        }
      },
      temporal: {
        label: "z-axis: temporal orientation (past → future)",
        order: [
          "resentmentGratitude", "regretNostalgia", "guiltRighteousness", "shamePride",
          "sadnessJoy", "contemptReverence", "disgustTrust", "hateLove",
          "lonelinessEnmeshment", "boredomObsession", "jealousyCompersion", "cravingAversion",
          "envyAdmiration", "fearAnger", "anxietyExcitement", "despairHope"
        ],
        zLabels: {
          resentmentGratitude: { left: "debts incurred", right: "gifts received" },
          regretNostalgia: { left: "paths not taken", right: "paths treasured" },
          guiltRighteousness: { left: "what I did wrong", right: "what I did right" },
          shamePride: { left: "who I was", right: "who I became" },
          sadnessJoy: { left: "what was lost", right: "what was gained" },
          contemptReverence: { left: "who failed", right: "who rose" },
          disgustTrust: { left: "what repelled", right: "what welcomed" },
          hateLove: { left: "who wronged", right: "who cherished" },
          lonelinessEnmeshment: { left: "connection lost", right: "connection present" },
          boredomObsession: { left: "what dulled", right: "what captivates" },
          jealousyCompersion: { left: "what was taken", right: "what is shared" },
          cravingAversion: { left: "what I want now", right: "what I avoid now" },
          envyAdmiration: { left: "what they'll have", right: "what they'll become" },
          fearAnger: { left: "what looms", right: "what to meet" },
          anxietyExcitement: { left: "what might go wrong", right: "what might go right" },
          despairHope: { left: "what won't come", right: "what may come" }
        }
      },
      arousal: {
        label: "z-axis: activation level (low → high)",
        order: [
          "despairHope", "sadnessJoy", "boredomObsession", "lonelinessEnmeshment",
          "regretNostalgia", "shamePride", "guiltRighteousness", "disgustTrust",
          "cravingAversion", "contemptReverence", "resentmentGratitude", "envyAdmiration",
          "jealousyCompersion", "fearAnger", "anxietyExcitement", "hateLove"
        ],
        zLabels: {
          despairHope: { left: "collapsed", right: "at rest" },
          sadnessJoy: { left: "subdued", right: "peaceful" },
          boredomObsession: { left: "flat", right: "absorbed" },
          lonelinessEnmeshment: { left: "empty", right: "full" },
          regretNostalgia: { left: "heavy", right: "bittersweet" },
          shamePride: { left: "shrinking", right: "composed" },
          guiltRighteousness: { left: "burdened", right: "assured" },
          disgustTrust: { left: "aversive", right: "receptive" },
          cravingAversion: { left: "hungry", right: "repelled" },
          contemptReverence: { left: "dismissive", right: "awed" },
          resentmentGratitude: { left: "simmering", right: "warm" },
          envyAdmiration: { left: "wanting", right: "inspired" },
          jealousyCompersion: { left: "guarding", right: "delighting" },
          fearAnger: { left: "alarmed", right: "fierce" },
          anxietyExcitement: { left: "agitated", right: "electric" },
          hateLove: { left: "inflamed", right: "ardent" }
        }
      }
    };
    
    // ==================== STATE ====================
    const STORAGE_KEY = 'emotional-horseshoes-v1';
    const MAX_HISTORY = 100;
    
    let state = {
      currentTab: 'explore',
      currentOrder: 'action',
      expandedCards: [],
      reflections: {},  // { emotionKey: value (-100 to 100) }
      entries: [],      // { id, timestamp, reflections: {}, note: '' }
      settings: {
        showZLabels: true
      }
    };
    
    let stateHistory = [];
    let historyIndex = -1;
    let pendingReflections = null;
    
    // ==================== PERSISTENCE ====================
    function loadState() {
      try {
        const saved = localStorage.getItem(STORAGE_KEY);
        if (saved) {
          const parsed = JSON.parse(saved);
          state = { ...state, ...parsed };
        }
      } catch (e) {
        console.error('Failed to load state:', e);
      }
    }
    
    function saveState() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        console.error('Failed to save state:', e);
      }
    }
    
    function pushHistory() {
      // Remove future states if we're not at the end
      if (historyIndex < stateHistory.length - 1) {
        stateHistory = stateHistory.slice(0, historyIndex + 1);
      }
      
      // Add current state
      stateHistory.push(JSON.parse(JSON.stringify(state)));
      
      // Limit history
      if (stateHistory.length > MAX_HISTORY) {
        stateHistory.shift();
      }
      
      historyIndex = stateHistory.length - 1;
      updateUndoRedoButtons();
    }
    
    function undo() {
      if (historyIndex > 0) {
        historyIndex--;
        state = JSON.parse(JSON.stringify(stateHistory[historyIndex]));
        saveState();
        renderAll();
        showToast('Undone');
      }
    }
    
    function redo() {
      if (historyIndex < stateHistory.length - 1) {
        historyIndex++;
        state = JSON.parse(JSON.stringify(stateHistory[historyIndex]));
        saveState();
        renderAll();
        showToast('Redone');
      }
    }
    
    function updateUndoRedoButtons() {
      document.getElementById('undo-btn').disabled = historyIndex <= 0;
      document.getElementById('redo-btn').disabled = historyIndex >= stateHistory.length - 1;
    }
    
    // ==================== RENDERING ====================
    function createHorseshoeSVG(emotion, compact = false) {
      const id = emotion.left.toLowerCase().replace(/\s/g, '');
      const height = compact ? 100 : 120;
      const viewBoxHeight = compact ? 110 : 130;
      
      const tipY = compact ? 70 : 82;
      const curveTopY = compact ? 15 : 18;
      const leftTipX = 40;
      const rightTipX = 200;
      const centerX = 120;
      const strokeWidth = compact ? 8 : 10;
      const labelY = tipY + strokeWidth + 14;
      
      return `
        <svg class="horseshoe-svg" viewBox="0 0 240 ${viewBoxHeight}" style="height: ${height}px;">
          <defs>
            <linearGradient id="grad-${id}" x1="0%" y1="0%" x2="100%" y2="0%">
              <stop offset="0%" stop-color="${emotion.leftColor}" />
              <stop offset="50%" stop-color="#a8c4a8" />
              <stop offset="100%" stop-color="${emotion.rightColor}" />
            </linearGradient>
          </defs>
          
          <!-- Subtle axes -->
          <line x1="${centerX}" y1="5" x2="${centerX}" y2="${viewBoxHeight - 5}" stroke="#f0eeeb" stroke-width="1" />
          <polygon points="${centerX},5 ${centerX-3},11 ${centerX+3},11" fill="#e8e5e1" />
          <text x="${centerX}" y="3" text-anchor="middle" font-size="7" fill="#d4d1cd" font-family="var(--font-body)">agency</text>
          <text x="${centerX}" y="${viewBoxHeight - 2}" text-anchor="middle" font-size="7" fill="#d4d1cd" font-family="var(--font-body)">capture</text>
          
          <!-- Horseshoe -->
          <path
            d="M ${leftTipX} ${tipY} Q ${leftTipX} ${curveTopY} ${centerX} ${curveTopY} Q ${rightTipX} ${curveTopY} ${rightTipX} ${tipY}"
            fill="none"
            stroke="url(#grad-${id})"
            stroke-width="${strokeWidth}"
            stroke-linecap="round"
          />
          
          <!-- Dots -->
          <circle cx="${leftTipX}" cy="${tipY}" r="5" fill="${emotion.leftColor}" />
          <circle cx="${rightTipX}" cy="${tipY}" r="5" fill="${emotion.rightColor}" />
          <circle cx="${centerX}" cy="${curveTopY}" r="5" fill="#7d9a7d" />
          
          <!-- Agency label at top -->
          <text x="${centerX}" y="${curveTopY + 16}" text-anchor="middle" font-size="9" font-weight="500" fill="#7d9a7d" font-family="var(--font-body)">${emotion.top}</text>
          
          <!-- Emotion labels below tips -->
          <text x="${leftTipX}" y="${labelY}" text-anchor="middle" font-size="10" font-weight="600" fill="${emotion.leftColor}" font-family="var(--font-body)">${emotion.left}</text>
          <text x="${rightTipX}" y="${labelY}" text-anchor="middle" font-size="10" font-weight="600" fill="${emotion.rightColor}" font-family="var(--font-body)">${emotion.right}</text>
        </svg>
      `;
    }
    
    function renderExploreTab() {
      const ordering = orderings[state.currentOrder];
      const grid = document.getElementById('horseshoe-grid');
      const axisDesc = document.getElementById('axis-description');
      
      axisDesc.textContent = ordering.label;
      
      // Update buttons
      document.querySelectorAll('.order-btn').forEach(btn => {
        btn.classList.toggle('active', btn.dataset.order === state.currentOrder);
      });
      
      grid.innerHTML = ordering.order.map((key, i) => {
        const emotion = emotions[key];
        const zLabel = ordering.zLabels[key];
        const isExpanded = state.expandedCards.includes(key);
        
        return `
          <div class="horseshoe-row animate-in" style="animation-delay: ${i * 0.03}s">
            <div class="z-label">${zLabel.left}</div>
            <div class="horseshoe-card ${isExpanded ? 'expanded' : ''}" data-emotion="${key}">
              ${createHorseshoeSVG(emotion)}
              <p class="captured-by">captured by: <span>${emotion.shared}</span></p>
              <div class="horseshoe-detail">
                <div class="horseshoe-detail-content">${emotion.description}</div>
              </div>
            </div>
            <div class="z-label-right">${zLabel.right}</div>
          </div>
        `;
      }).join('');
      
      // Add click handlers
      grid.querySelectorAll('.horseshoe-card').forEach(card => {
        card.addEventListener('click', () => {
          const key = card.dataset.emotion;
          if (state.expandedCards.includes(key)) {
            state.expandedCards = state.expandedCards.filter(k => k !== key);
          } else {
            state.expandedCards.push(key);
          }
          card.classList.toggle('expanded');
        });
      });
    }
    
    function renderReflectTab() {
      const grid = document.getElementById('reflect-grid');
      const emotionKeys = Object.keys(emotions);
      
      grid.innerHTML = emotionKeys.map((key, i) => {
        const emotion = emotions[key];
        const value = state.reflections[key] ?? 0;
        const positionText = getPositionText(emotion, value);
        
        return `
          <div class="reflect-card animate-in" style="animation-delay: ${i * 0.02}s">
            <div class="reflect-card-header">
              <div class="reflect-card-title">${emotion.left} ↔ ${emotion.right}</div>
              <div class="reflect-card-agency">${emotion.top}</div>
            </div>
            <div class="reflect-slider-container">
              <div class="reflect-slider-labels">
                <span class="reflect-slider-left">${emotion.left.toLowerCase()}</span>
                <span class="reflect-slider-right">${emotion.right.toLowerCase()}</span>
              </div>
              <input 
                type="range" 
                class="reflect-slider" 
                min="-100" 
                max="100" 
                value="${value}"
                data-emotion="${key}"
              />
              <div class="reflect-position" data-position="${key}">${positionText}</div>
            </div>
          </div>
        `;
      }).join('');
      
      // Add slider handlers
      grid.querySelectorAll('.reflect-slider').forEach(slider => {
        slider.addEventListener('input', (e) => {
          const key = e.target.dataset.emotion;
          const value = parseInt(e.target.value);
          state.reflections[key] = value;
          
          const positionEl = document.querySelector(`[data-position="${key}"]`);
          positionEl.textContent = getPositionText(emotions[key], value);
        });
        
        slider.addEventListener('change', () => {
          pushHistory();
          saveState();
        });
      });
    }
    
    function getPositionText(emotion, value) {
      const absValue = Math.abs(value);
      if (absValue < 15) {
        return `Near ${emotion.top.toLowerCase()}`;
      } else if (value < -50) {
        return `Strong ${emotion.left.toLowerCase()}`;
      } else if (value < 0) {
        return `Leaning ${emotion.left.toLowerCase()}`;
      } else if (value > 50) {
        return `Strong ${emotion.right.toLowerCase()}`;
      } else {
        return `Leaning ${emotion.right.toLowerCase()}`;
      }
    }
    
    function renderTrackTab() {
      const content = document.getElementById('track-content');
      const totalEl = document.getElementById('total-entries');
      const streakEl = document.getElementById('current-streak');
      
      totalEl.textContent = state.entries.length;
      streakEl.textContent = calculateStreak();
      
      if (state.entries.length === 0) {
        content.innerHTML = `
          <div class="track-empty">
            <div class="track-empty-icon">◯</div>
            <p>No entries yet. Visit the Reflect tab to record your first moment.</p>
          </div>
        `;
        return;
      }
      
      // Sort entries by timestamp, newest first
      const sortedEntries = [...state.entries].sort((a, b) => b.timestamp - a.timestamp);
      
      content.innerHTML = `
        <div class="track-entries">
          ${sortedEntries.map(entry => renderTrackEntry(entry)).join('')}
        </div>
      `;
      
      // Add handlers
      content.querySelectorAll('.track-entry-btn.delete').forEach(btn => {
        btn.addEventListener('click', (e) => {
          const id = e.target.dataset.id;
          if (btn.classList.contains('confirm-delete')) {
            deleteEntry(id);
          } else {
            btn.textContent = 'Confirm delete?';
            btn.classList.add('confirm-delete');
            setTimeout(() => {
              btn.textContent = 'Delete';
              btn.classList.remove('confirm-delete');
            }, 3000);
          }
        });
      });
    }
    
    function renderTrackEntry(entry) {
      const date = new Date(entry.timestamp);
      const dateStr = date.toLocaleDateString('en-US', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
      const timeStr = date.toLocaleTimeString('en-US', { 
        hour: 'numeric', 
        minute: '2-digit' 
      });
      
      // Get notable emotions (far from center)
      const notableEmotions = Object.entries(entry.reflections)
        .filter(([_, value]) => Math.abs(value) > 30)
        .map(([key, value]) => {
          const emotion = emotions[key];
          const isPositive = value > 0;
          const label = isPositive ? emotion.right.toLowerCase() : emotion.left.toLowerCase();
          return { label, isPositive, intensity: Math.abs(value) };
        })
        .sort((a, b) => b.intensity - a.intensity)
        .slice(0, 6);
      
      return `
        <div class="track-entry">
          <div class="track-entry-header">
            <div class="track-entry-date">${dateStr}</div>
            <div class="track-entry-time">${timeStr}</div>
          </div>
          <div class="track-entry-emotions">
            ${notableEmotions.map(e => `
              <span class="track-emotion-tag ${e.isPositive ? 'positive' : 'negative'}">${e.label}</span>
            `).join('')}
            ${notableEmotions.length === 0 ? '<span class="track-emotion-tag">near center</span>' : ''}
          </div>
          ${entry.note ? `<div class="track-entry-note">"${entry.note}"</div>` : ''}
          <div class="track-entry-actions">
            <button class="track-entry-btn delete" data-id="${entry.id}">Delete</button>
          </div>
        </div>
      `;
    }
    
    function calculateStreak() {
      if (state.entries.length === 0) return 0;
      
      const today = new Date();
      today.setHours(0, 0, 0, 0);
      
      const entryDates = state.entries
        .map(e => {
          const d = new Date(e.timestamp);
          d.setHours(0, 0, 0, 0);
          return d.getTime();
        })
        .sort((a, b) => b - a);
      
      // Check if there's an entry today or yesterday
      const latestEntry = new Date(entryDates[0]);
      const daysSinceLatest = Math.floor((today - latestEntry) / (1000 * 60 * 60 * 24));
      
      if (daysSinceLatest > 1) return 0;
      
      // Count consecutive days
      let streak = 1;
      let currentDate = entryDates[0];
      
      const uniqueDates = [...new Set(entryDates)];
      
      for (let i = 1; i < uniqueDates.length; i++) {
        const diff = (currentDate - uniqueDates[i]) / (1000 * 60 * 60 * 24);
        if (diff === 1) {
          streak++;
          currentDate = uniqueDates[i];
        } else {
          break;
        }
      }
      
      return streak;
    }
    
    function renderSettings() {
      const body = document.getElementById('settings-body');
      body.innerHTML = `
        <div class="settings-section">
          <h3>Data</h3>
          <div class="settings-row">
            <span class="settings-label">Total entries</span>
            <span class="settings-value">${state.entries.length}</span>
          </div>
          <div class="settings-row">
            <span class="settings-label">Current streak</span>
            <span class="settings-value">${calculateStreak()} days</span>
          </div>
        </div>
        <div class="settings-section">
          <h3>Export</h3>
          <div class="settings-row">
            <span class="settings-label">Download all data</span>
            <button class="btn btn-secondary" id="export-btn" style="padding: 0.5rem 1rem; font-size: 0.8rem;">Export JSON</button>
          </div>
        </div>
      `;
      
      document.getElementById('export-btn').addEventListener('click', exportData);
    }
    
    function renderAll() {
      renderExploreTab();
      renderReflectTab();
      renderTrackTab();
      renderSettings();
      updateUndoRedoButtons();
    }
    
    // ==================== ACTIONS ====================
    function switchTab(tabName) {
      state.currentTab = tabName;
      
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.classList.toggle('active', tab.dataset.tab === tabName);
      });
      
      document.querySelectorAll('.tab-panel').forEach(panel => {
        panel.classList.toggle('active', panel.id === `${tabName}-panel`);
      });
      
      saveState();
    }
    
    function switchOrder(orderKey) {
      state.currentOrder = orderKey;
      state.expandedCards = [];
      renderExploreTab();
      saveState();
    }
    
    function resetReflections() {
      state.reflections = {};
      renderReflectTab();
      pushHistory();
      saveState();
      showToast('Reflections reset');
    }
    
    function saveReflection() {
      // Check if any reflections were made
      const hasReflections = Object.values(state.reflections).some(v => v !== 0);
      if (!hasReflections) {
        showToast('Move at least one slider before saving');
        return;
      }
      
      pendingReflections = { ...state.reflections };
      document.getElementById('note-modal').classList.add('active');
      document.getElementById('note-textarea').focus();
    }
    
    function confirmSaveEntry(note = '') {
      const entry = {
        id: Date.now().toString(),
        timestamp: Date.now(),
        reflections: pendingReflections,
        note: note.trim()
      };
      
      state.entries.push(entry);
      state.reflections = {};
      pendingReflections = null;
      
      document.getElementById('note-modal').classList.remove('active');
      document.getElementById('note-textarea').value = '';
      
      pushHistory();
      saveState();
      renderReflectTab();
      renderTrackTab();
      showToast('Moment saved');
    }
    
    function deleteEntry(id) {
      state.entries = state.entries.filter(e => e.id !== id);
      pushHistory();
      saveState();
      renderTrackTab();
      showToast('Entry deleted');
    }
    
    function exportData() {
      const data = JSON.stringify(state, null, 2);
      const blob = new Blob([data], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `emotional-horseshoes-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
      showToast('Data exported');
    }
    
    function clearAllData() {
      if (confirm('This will delete all your entries and cannot be undone. Continue?')) {
        state.entries = [];
        state.reflections = {};
        stateHistory = [];
        historyIndex = -1;
        pushHistory();
        saveState();
        renderAll();
        closeSettings();
        showToast('All data cleared');
      }
    }
    
    // ==================== UI HELPERS ====================
    function showToast(message) {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;
      container.appendChild(toast);
      
      requestAnimationFrame(() => {
        toast.classList.add('show');
      });
      
      setTimeout(() => {
        toast.classList.remove('show');
        setTimeout(() => toast.remove(), 300);
      }, 2500);
    }
    
    function openSettings() {
      document.getElementById('settings-overlay').classList.add('active');
      document.getElementById('settings-panel').classList.add('active');
    }
    
    function closeSettings() {
      document.getElementById('settings-overlay').classList.remove('active');
      document.getElementById('settings-panel').classList.remove('active');
    }
    
    function openHelp() {
      document.getElementById('settings-overlay').classList.add('active');
      document.getElementById('help-panel').classList.add('active');
    }
    
    function closeHelp() {
      document.getElementById('settings-overlay').classList.remove('active');
      document.getElementById('help-panel').classList.remove('active');
    }
    
    function closeNoteModal() {
      document.getElementById('note-modal').classList.remove('active');
      document.getElementById('note-textarea').value = '';
      pendingReflections = null;
    }
    
    // ==================== EVENT HANDLERS ====================
    function initEventHandlers() {
      // Tab navigation
      document.querySelectorAll('.nav-tab').forEach(tab => {
        tab.addEventListener('click', () => switchTab(tab.dataset.tab));
      });
      
      // Order buttons
      document.querySelectorAll('.order-btn').forEach(btn => {
        btn.addEventListener('click', () => switchOrder(btn.dataset.order));
      });
      
      // Reflect actions
      document.getElementById('reset-reflect-btn').addEventListener('click', resetReflections);
      document.getElementById('save-reflect-btn').addEventListener('click', saveReflection);
      
      // Note modal
      document.getElementById('note-cancel-btn').addEventListener('click', closeNoteModal);
      document.getElementById('note-save-btn').addEventListener('click', () => {
        const note = document.getElementById('note-textarea').value;
        confirmSaveEntry(note);
      });
      document.getElementById('note-modal').addEventListener('click', (e) => {
        if (e.target.id === 'note-modal') closeNoteModal();
      });
      
      // Settings
      document.getElementById('settings-btn').addEventListener('click', openSettings);
      document.getElementById('close-settings-btn').addEventListener('click', closeSettings);
      document.getElementById('settings-overlay').addEventListener('click', () => {
        closeSettings();
        closeHelp();
      });
      document.getElementById('clear-data-btn').addEventListener('click', clearAllData);
      
      // Help
      document.getElementById('help-btn').addEventListener('click', openHelp);
      document.getElementById('close-help-btn').addEventListener('click', closeHelp);
      
      // Undo/Redo
      document.getElementById('undo-btn').addEventListener('click', undo);
      document.getElementById('redo-btn').addEventListener('click', redo);
      
      // Keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        // Don't trigger shortcuts when typing in inputs
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
          if (e.key === 'Escape') {
            e.target.blur();
            closeNoteModal();
          }
          return;
        }
        
        if (e.key === 'Escape') {
          closeSettings();
          closeHelp();
          closeNoteModal();
        }
        
        if (e.key === '?' || (e.shiftKey && e.key === '/')) {
          e.preventDefault();
          if (document.getElementById('help-panel').classList.contains('active')) {
            closeHelp();
          } else {
            openHelp();
          }
        }
        
        if (e.key === '1') switchTab('explore');
        if (e.key === '2') switchTab('reflect');
        if (e.key === '3') switchTab('track');
        
        if ((e.ctrlKey || e.metaKey) && e.key === 'z') {
          e.preventDefault();
          undo();
        }
        
        if ((e.ctrlKey || e.metaKey) && e.key === 'y') {
          e.preventDefault();
          redo();
        }
      });
      
      // Save on visibility change and beforeunload
      document.addEventListener('visibilitychange', saveState);
      window.addEventListener('beforeunload', saveState);
    }
    
    // ==================== EASTER EGG ====================
    // EASTER EGG: Konami code shows a special message
    let konamiIndex = 0;
    const konamiCode = ['ArrowUp', 'ArrowUp', 'ArrowDown', 'ArrowDown', 'ArrowLeft', 'ArrowRight', 'ArrowLeft', 'ArrowRight', 'b', 'a'];
    
    document.addEventListener('keydown', (e) => {
      if (e.key === konamiCode[konamiIndex]) {
        konamiIndex++;
        if (konamiIndex === konamiCode.length) {
          konamiIndex = 0;
          showToast('✨ The middle path is always there ✨');
        }
      } else {
        konamiIndex = 0;
      }
    });
    
    // ==================== INIT ====================
    function init() {
      loadState();
      pushHistory();
      initEventHandlers();
      renderAll();
      switchTab(state.currentTab);
    }
    
    init();
  </script>
</body>
</html>