<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VastVocab - Dynamic Curriculum Word Game</title>
    <style>
        /* VastVocab - Complete Styles */
        :root {
            --color-primary-dark: #1e3c72;
            --color-primary: #2a5298;
            --color-secondary: #00a86b;
            --color-secondary-light: #008855;
            --color-success: #4caf50;
            --color-error: #ff5252;
            --color-warning: #ffc107;
            --color-text-dark: #333333;
            --color-text-light: #ffffff;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, var(--color-primary-dark) 0%, var(--color-primary) 100%);
            min-height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            padding: 10px;
        }

        .game-container {
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            padding: 20px;
            max-width: 800px;
            width: 100%;
            position: relative;
        }

        /* Top Bar */
        .top-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
            color: white;
            border-radius: 12px;
            margin-bottom: 15px;
        }

        .current-curriculum {
            flex: 1;
            font-size: 0.95em;
            font-weight: 600;
        }

        .current-curriculum-label {
            font-size: 0.75em;
            opacity: 0.8;
            margin-bottom: 2px;
        }

        .current-curriculum-name {
            font-size: 1.05em;
        }

        .top-bar-controls {
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .top-bar-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .top-bar-btn:hover:not(:disabled) {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .top-bar-btn:disabled {
            opacity: 0.4;
            cursor: not-allowed;
        }

        /* Settings Panel */
        .settings-panel {
            position: absolute;
            top: 70px;
            left: 15px;
            right: 15px;
            background: white;
            border: 2px solid var(--color-primary);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 100;
            display: none;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
        }

        .settings-panel.active {
            display: block;
            animation: slideIn 0.3s ease;
        }

        .settings-header {
            color: var(--color-primary);
            margin-bottom: 20px;
            font-size: 1.5em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .close-settings-btn {
            background: none;
            border: none;
            font-size: 1.5em;
            color: #999;
            cursor: pointer;
            padding: 0;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-settings-btn:hover {
            background: #f0f0f0;
            color: #333;
        }

        .settings-section {
            margin-bottom: 25px;
        }

        .settings-section h4 {
            color: var(--color-secondary);
            margin-bottom: 12px;
            font-size: 1.1em;
        }

        .timer-options {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .timer-btn {
            flex: 1;
            min-width: 70px;
            padding: 10px 16px;
            border: 2px solid var(--color-primary);
            background: white;
            border-radius: 20px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .timer-btn:hover {
            background: var(--color-primary);
            color: white;
        }

        .timer-btn.active {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
            color: white;
        }

        .curriculum-selector {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .selector-row {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .selector-label {
            font-weight: 600;
            color: #666;
            font-size: 0.9em;
        }

        .selector-dropdown {
            padding: 10px 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 1em;
            background: white;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .selector-dropdown:hover {
            border-color: var(--color-primary);
        }

        .selector-dropdown:focus {
            outline: none;
            border-color: var(--color-primary);
            box-shadow: 0 0 0 3px rgba(42, 82, 152, 0.1);
        }

        .selector-dropdown:disabled {
            background: #f5f5f5;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .start-game-btn {
            background: linear-gradient(135deg, var(--color-secondary) 0%, var(--color-secondary-light) 100%);
            color: white;
            border: none;
            padding: 14px 32px;
            border-radius: 25px;
            font-size: 1.1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-top: 10px;
        }

        .start-game-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 168, 107, 0.3);
        }

        .start-game-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Recent Dropdown */
        .recent-dropdown {
            position: absolute;
            top: 70px;
            right: 15px;
            background: white;
            border: 2px solid var(--color-secondary);
            border-radius: 12px;
            padding: 15px;
            width: 380px;
            max-width: calc(100vw - 30px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 100;
            display: none;
            max-height: calc(100vh - 100px);
            overflow-y: auto;
        }

        .recent-dropdown.active {
            display: block;
            animation: slideIn 0.3s ease;
        }

        .recent-dropdown h4 {
            color: var(--color-secondary);
            margin-bottom: 15px;
            font-size: 1.2em;
        }

        .recent-item {
            padding: 12px;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .recent-item:hover {
            background: #f9f9f9;
            border-color: var(--color-secondary);
            transform: translateX(3px);
        }

        .recent-item-name {
            font-weight: 600;
            color: var(--color-primary);
            margin-bottom: 4px;
        }

        .recent-item-details {
            font-size: 0.85em;
            color: #666;
            display: flex;
            justify-content: space-between;
            margin-top: 4px;
        }

        .recent-item-progress {
            color: var(--color-secondary);
            font-weight: 600;
        }

        .no-recent {
            color: #999;
            text-align: center;
            padding: 20px;
            font-style: italic;
        }

        /* Help and Stats Buttons */
        .help-btn, .stats-btn {
            position: absolute;
            top: 15px;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            color: white;
            border: none;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 10;
            display: flex;
            align-items: center;
            justify-content: center;
            line-height: 1;
        }

        .help-btn {
            right: 15px;
            background: var(--color-primary);
            animation: initialPulse 2s ease-out;
        }

        .stats-btn {
            left: 15px;
            background: var(--color-secondary);
            font-size: 14px;
            animation: initialPulse 2s ease-out 0.5s;
        }

        @keyframes initialPulse {
            0%, 100% { transform: scale(1); }
            25% { transform: scale(1.15); }
            50% { transform: scale(1); }
            75% { transform: scale(1.15); }
        }

        .help-btn:hover {
            background: var(--color-primary-dark);
            transform: scale(1.1);
        }

        .stats-btn:hover {
            background: var(--color-secondary-light);
            transform: scale(1.1);
        }

        /* Help Panel */
        .help-panel {
            position: absolute;
            top: 50px;
            right: 15px;
            background: white;
            border: 2px solid var(--color-primary);
            border-radius: 12px;
            padding: 20px;
            width: 320px;
            max-width: calc(100% - 30px);
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 100;
            display: none;
        }

        .help-panel.active {
            display: block;
            animation: slideIn 0.3s ease;
        }

        .help-content h3 {
            color: var(--color-primary);
            margin-bottom: 12px;
            font-size: 1.3em;
        }

        .help-content h4 {
            color: var(--color-secondary);
            margin-bottom: 8px;
            margin-top: 12px;
            font-size: 1.1em;
        }

        .help-section {
            margin-bottom: 15px;
        }

        .help-content p {
            margin-bottom: 8px;
            font-size: 0.95em;
            line-height: 1.4;
        }

        .help-content ul {
            margin-left: 20px;
            font-size: 0.9em;
            line-height: 1.6;
        }

        .help-content li {
            margin-bottom: 4px;
        }

        .close-help-btn {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
            color: white;
            border: none;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            width: 100%;
            margin-top: 15px;
            transition: all 0.3s ease;
        }

        .close-help-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(42, 82, 152, 0.3);
        }

        .reset-progress-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: 15px;
            font-size: 0.85em;
            cursor: pointer;
            margin-top: 8px;
            transition: all 0.3s ease;
        }

        .reset-progress-btn:hover {
            background: var(--color-error);
            transform: translateY(-1px);
        }

        /* Stats Panel */
        .stats-panel {
            position: absolute;
            top: 50px;
            left: 15px;
            background: white;
            border: 2px solid var(--color-secondary);
            border-radius: 12px;
            padding: 20px;
            width: 380px;
            max-width: calc(100% - 30px);
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            z-index: 101;
            display: none;
        }

        .stats-panel.active {
            display: block;
            animation: slideIn 0.3s ease;
        }

        .stats-content h3 {
            color: var(--color-secondary);
            margin-bottom: 12px;
            font-size: 1.3em;
        }

        .stats-summary {
            background: #f5f5f5;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            font-size: 0.9em;
            line-height: 1.8;
        }

        .stats-summary-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 6px;
        }

        .stats-summary-item:last-child {
            margin-bottom: 0;
        }

        .stats-summary-label {
            color: #666;
        }

        .stats-summary-value {
            font-weight: bold;
            color: var(--color-primary);
        }

        .stats-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .stats-item {
            padding: 12px;
            border-left: 4px solid var(--color-secondary);
            background: #f9f9f9;
            border-radius: 4px;
            margin-bottom: 10px;
        }

        .stats-item.loss {
            border-left: 4px solid var(--color-error);
        }

        .stats-rank {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.9em;
            font-weight: bold;
            margin-right: 8px;
            min-width: 30px;
            text-align: center;
        }

        .stats-rank.gold,
        .stats-rank.silver,
        .stats-rank.bronze {
            background: none;
            padding: 2px 4px;
            font-size: 1.2em;
        }

        .stats-rank:not(.gold):not(.silver):not(.bronze) {
            background: var(--color-secondary);
            color: white;
            font-size: 0.8em;
        }

        .stats-score {
            font-size: 1.1em;
            font-weight: bold;
            color: var(--color-primary);
        }

        .stats-category {
            font-size: 0.95em;
            color: #666;
            margin: 4px 0;
        }

        .stats-details {
            font-size: 0.85em;
            color: #999;
        }

        .stats-actions {
            display: flex;
            gap: 10px;
        }

        .clear-stats-btn {
            background: #ff6b6b;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            flex: 1;
            transition: all 0.3s ease;
        }

        .clear-stats-btn:hover {
            background: var(--color-error);
            transform: translateY(-1px);
        }

        .close-stats-btn {
            background: linear-gradient(135deg, var(--color-secondary) 0%, var(--color-secondary-light) 100%);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: bold;
            cursor: pointer;
            flex: 1;
            transition: all 0.3s ease;
        }

        .close-stats-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0, 168, 107, 0.3);
        }

        /* Game Header */
        .header {
            text-align: center;
            margin-bottom: 15px;
        }

        h1 {
            color: var(--color-primary);
            margin-bottom: 4px;
            font-size: 2em;
        }

        .category-progress {
            font-size: 0.85em;
            color: #666;
            margin-bottom: 8px;
            font-style: italic;
        }

        .category {
            font-size: 1.1em;
            color: #666;
            margin-bottom: 15px;
            padding: 8px;
            background: rgba(42, 82, 152, 0.05);
            border-radius: 10px;
            min-height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .reveal-category-btn {
            background: linear-gradient(135deg, var(--color-secondary) 0%, var(--color-secondary-light) 100%);
            color: white;
            border: none;
            padding: 6px 16px;
            border-radius: 20px;
            font-size: 0.95em;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: bold;
        }

        .reveal-category-btn:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(0, 168, 107, 0.3);
        }

        .reveal-category-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            opacity: 0.6;
        }

        .category-text {
            font-weight: bold;
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        /* Game Stats */
        .stats {
            display: flex;
            justify-content: space-around;
            margin-bottom: 15px;
            flex-wrap: wrap;
            gap: 8px;
        }

        .stat {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
            color: white;
            padding: 10px 20px;
            border-radius: 10px;
            text-align: center;
            flex: 1;
            min-width: 120px;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: bold;
        }

        .stat-label {
            font-size: 0.85em;
            opacity: 0.9;
            margin-top: 2px;
        }

        .warning {
            background: linear-gradient(135deg, #ff6b6b 0%, var(--color-error) 100%) !important;
            animation: pulse 1s infinite;
        }

        .warning .stat-value,
        .warning .stat-label {
            color: white !important;
            text-shadow: 0 1px 2px rgba(0,0,0,0.2);
        }

        @keyframes pulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        /* Game Over Message */
        .game-over-message {
            background: linear-gradient(135deg, var(--color-secondary) 0%, var(--color-secondary-light) 100%);
            color: white;
            padding: 15px;
            border-radius: 12px;
            margin: 15px 0;
            text-align: center;
            display: none;
            animation: slideIn 0.5s ease;
        }

        .game-over-message.active {
            display: block;
        }

        .game-over-message h2 {
            margin-bottom: 8px;
            font-size: 1.5em;
        }

        .game-over-message p {
            font-size: 1.1em;
            margin-bottom: 8px;
        }

        .final-score {
            font-size: 1.6em;
            font-weight: bold;
            margin: 10px 0;
        }

        @keyframes slideIn {
            from {
                transform: translateY(-20px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }

        .limit-message {
            background: #fff3cd;
            border: 2px solid var(--color-warning);
            color: #856404;
            padding: 8px;
            border-radius: 8px;
            text-align: center;
            margin-bottom: 12px;
            display: none;
            animation: slideIn 0.5s ease;
            font-weight: bold;
            font-size: 0.95em;
        }

        .limit-message.active {
            display: block;
        }

        /* Words Display */
        .words-container {
            margin-bottom: 15px;
            padding-right: 5px;
        }

        .word-row {
            display: flex;
            align-items: center;
            margin-bottom: 10px;
            gap: 8px;
        }

        .word-number {
            font-weight: bold;
            color: var(--color-primary);
            width: 25px;
            font-size: 0.95em;
        }

        .word-display {
            display: flex;
            gap: 6px;
            flex: 1;
        }

        .word-answer {
            padding: 6px 10px;
            background: #d4edda;
            border: 2px solid var(--color-success);
            border-radius: 8px;
            color: #155724;
            font-weight: bold;
            font-size: 1em;
            text-transform: uppercase;
            display: none;
            animation: flipIn 0.5s;
            min-width: 100px;
            text-align: center;
            margin-left: 15px;
        }

        .word-answer.revealed {
            display: block;
        }

        .letter-box {
            width: 32px;
            height: 32px;
            border: 2px solid #ddd;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.1em;
            font-weight: bold;
            text-transform: uppercase;
            background: #f9f9f9;
            transition: all 0.3s ease;
        }

        .letter-box.revealed {
            background: rgba(42, 82, 152, 0.1);
            border-color: var(--color-primary);
            color: var(--color-primary-dark);
            animation: flipIn 0.5s;
        }

        .letter-box.guessed {
            background: linear-gradient(135deg, var(--color-secondary) 0%, var(--color-secondary-light) 100%);
            border-color: var(--color-secondary-light);
            color: white;
        }

        @keyframes flipIn {
            from {
                transform: rotateY(90deg);
                opacity: 0;
            }
            to {
                transform: rotateY(0);
                opacity: 1;
            }
        }

        /* Guess Input */
        .guess-container {
            margin: 15px 0;
            text-align: center;
        }

        .guess-input {
            padding: 8px 16px;
            border: 3px solid var(--color-primary);
            border-radius: 25px;
            font-size: 1.1em;
            width: 280px;
            max-width: 100%;
            transition: all 0.3s ease;
            text-align: center;
        }

        .guess-input:focus {
            outline: none;
            border-color: var(--color-secondary);
            box-shadow: 0 0 0 3px rgba(0, 168, 107, 0.1);
        }

        .guess-input::placeholder {
            color: #999;
            font-style: italic;
        }

        .guess-input.wrong-guess-indicator {
            border-color: var(--color-error);
            animation: shake 0.5s;
        }

        .guess-input.correct-guess-indicator {
            border-color: var(--color-success);
            animation: pulse 0.5s;
        }

        /* Alphabet Grid */
        .alphabet-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(40px, 1fr));
            gap: 6px;
            margin-bottom: 15px;
            padding: 12px;
            background: rgba(42, 82, 152, 0.05);
            border-radius: 12px;
        }

        .letter-btn {
            padding: 8px;
            border: 2px solid var(--color-primary);
            background: white;
            border-radius: 6px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            text-transform: uppercase;
        }

        .letter-btn.vowel {
            background: rgba(0, 168, 107, 0.05);
            border-color: var(--color-secondary);
        }

        .letter-btn:hover:not(:disabled) {
            background: linear-gradient(135deg, var(--color-primary) 0%, var(--color-primary-dark) 100%);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(42, 82, 152, 0.3);
        }

        .letter-btn.vowel:hover:not(:disabled) {
            background: linear-gradient(135deg, var(--color-secondary) 0%, var(--color-secondary-light) 100%);
            color: white;
        }

        .letter-btn:disabled {
            cursor: not-allowed;
            opacity: 0.3;
            background: #e0e0e0;
        }

        .letter-btn:disabled[title] {
            opacity: 0.2;
            background: #f5f5f5;
            border-color: #ccc;
        }

        .letter-btn.no-match {
            background: #ffebee;
            border-color: var(--color-error);
            color: var(--color-error);
        }

        .letter-btn.vowel.no-match {
            background: #ffebee;
            border-color: var(--color-error);
            color: var(--color-error);
        }

        /* Game Controls */
        .controls {
            text-align: center;
            margin-top: 15px;
        }

        .controls-hint {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
            font-style: italic;
        }

        .btn {
            padding: 8px 24px;
            border: none;
            border-radius: 20px;
            font-size: 1em;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--color-secondary) 0%, var(--color-secondary-light) 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 5px 15px rgba(0, 168, 107, 0.3);
        }

        .timer {
            font-size: 1.1em;
            font-weight: bold;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-10px); }
            75% { transform: translateX(10px); }
        }

        /* Responsive */
        @media (max-width: 480px) {
            .help-panel, .stats-panel, .recent-dropdown {
                width: calc(100% - 40px);
                left: 20px;
                right: 20px;
                top: 60px;
            }
            
            .settings-panel {
                left: 10px;
                right: 10px;
                top: 60px;
                padding: 20px;
            }
            
            .top-bar {
                flex-direction: column;
                gap: 10px;
                align-items: stretch;
            }
            
            .top-bar-controls {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Top Bar -->
        <div class="top-bar">
            <div class="current-curriculum">
                <div class="current-curriculum-label">Current Topic:</div>
                <div class="current-curriculum-name" id="currentCurriculumName">Select a curriculum to begin</div>
            </div>
            <div class="top-bar-controls">
                <button class="top-bar-btn" id="changeTopicBtn">‚öôÔ∏è Change Topic</button>
                <button class="top-bar-btn" id="recentBtn">Recent ‚ñº</button>
            </div>
        </div>

        <!-- Floating Buttons -->
        <button class="help-btn" id="helpBtn" title="How to play">?</button>
        <button class="stats-btn" id="statsBtn" title="Game history">üìä</button>

        <!-- Settings Panel -->
        <div class="settings-panel" id="settingsPanel">
            <div class="settings-header">
                <span>Select Curriculum</span>
                <button class="close-settings-btn" id="closeSettingsBtn">√ó</button>
            </div>

            <div class="settings-section">
                <h4>Timer Duration</h4>
                <div class="timer-options">
                    <button class="timer-btn" data-duration="120">2 min</button>
                    <button class="timer-btn active" data-duration="180">3 min</button>
                    <button class="timer-btn" data-duration="240">4 min</button>
                    <button class="timer-btn" data-duration="300">5 min</button>
                </div>
            </div>

            <div class="settings-section">
                <h4>Choose Topic</h4>
                <div class="curriculum-selector">
                    <div class="selector-row">
                        <label class="selector-label">Framework</label>
                        <select class="selector-dropdown" id="frameworkSelect">
                            <option value="">Loading...</option>
                        </select>
                    </div>
                    <div id="dynamicSelectors"></div>
                </div>
            </div>
        </div>

        <!-- Recent Dropdown -->
        <div class="recent-dropdown" id="recentDropdown">
            <h4>Recent Topics</h4>
            <div id="recentList"></div>
        </div>

        <!-- Help Panel -->
        <div class="help-panel" id="helpPanel">
            <div class="help-content">
                <h3>VastVocab</h3>
                <p><strong>Goal:</strong> Guess 5 words using the fewest letters possible.</p>
                
                <div class="help-section">
                    <h4>Gameplay</h4>
                    <ul>
                        <li>Each word shows its first letter</li>
                        <li>Click alphabet letters to reveal them</li>
                        <li>Type your guess and press Enter</li>
                        <li>Correct words appear in green</li>
                    </ul>
                </div>
                
                <div class="help-section">
                    <h4>Limits</h4>
                    <ul>
                        <li><strong>10 letters max</strong> - then only guessing</li>
                        <li><strong>3 wrong guesses</strong> - game over</li>
                        <li><strong>Timer</strong> - set your duration</li>
                        <li><strong>Category reveal</strong> - costs 2 letters</li>
                    </ul>
                </div>
                
                <div class="help-section">
                    <h4>Scoring</h4>
                    <p>Score = Letters + (3 √ó wrong guesses) + category cost</p>
                    <p><em>Lower is better.</em></p>
                </div>
                
                <div class="help-section">
                    <h4>Categories</h4>
                    <p>100 categories per curriculum. Each appears once before repeating.</p>
                    <button class="reset-progress-btn" id="resetProgressBtn">Reset Progress</button>
                </div>
                
                <button class="close-help-btn" id="closeHelpBtn">Got it</button>
            </div>
        </div>

        <!-- Stats Panel -->
        <div class="stats-panel" id="statsPanel">
            <div class="stats-content">
                <h3>Game History</h3>
                <div class="stats-summary" id="statsSummary"></div>
                <div class="stats-list" id="statsList"></div>
                <div class="stats-actions">
                    <button class="clear-stats-btn" id="clearStatsBtn">Clear History</button>
                    <button class="close-stats-btn" id="closeStatsBtn">Close</button>
                </div>
            </div>
        </div>

        <!-- Game Header -->
        <div class="header">
            <h1>VastVocab</h1>
            <div class="category-progress" id="categoryProgress">Select a curriculum to begin</div>
            <div class="category" id="category">
                <button class="reveal-category-btn" id="revealCategoryBtn">
                    Reveal Category (Costs 2 Letters)
                </button>
                <span class="category-text" id="categoryText" style="display: none;"></span>
            </div>
        </div>

        <!-- Stats -->
        <div class="stats">
            <div class="stat" id="timerStat">
                <div class="stat-value timer" id="timer">3:00</div>
                <div class="stat-label">Time Left</div>
            </div>
            <div class="stat" id="letterStat">
                <div class="stat-value" id="letterCount">0</div>
                <div class="stat-label">Letters Used</div>
            </div>
            <div class="stat" id="wrongStat">
                <div class="stat-value" id="wrongCount">0</div>
                <div class="stat-label">Wrong Guesses</div>
            </div>
            <div class="stat">
                <div class="stat-value" id="wordsGuessed">0/5</div>
                <div class="stat-label">Words Guessed</div>
            </div>
        </div>

        <!-- Game Over Message -->
        <div class="game-over-message" id="gameOverMessage">
            <h2 id="gameOverTitle">Game Over</h2>
            <p id="gameOverText"></p>
            <div class="final-score" id="finalScore"></div>
        </div>

        <!-- Limit Message -->
        <div class="limit-message" id="limitMessage">
            ‚ö†Ô∏è Letter limit reached. You can still guess the words.
        </div>

        <!-- Words Display -->
        <div class="words-container" id="wordsContainer"></div>

        <!-- Guess Input -->
        <div class="guess-container">
            <input type="text" 
                   class="guess-input" 
                   id="guessInput" 
                   placeholder="Type a word and press Enter" 
                   autocomplete="off"
                   disabled>
        </div>

        <!-- Alphabet -->
        <div class="alphabet-container" id="alphabet"></div>

        <!-- Controls -->
        <div class="controls">
            <button class="btn btn-primary" id="gameControlBtn">Select Topic</button>
            <div class="controls-hint" id="controlsHint">Choose a curriculum to begin</div>
        </div>
    </div>

    <script>
        // ===== STORAGE MANAGER =====
        const StorageManager = {
            KEYS: {
                SETTINGS: 'vastvocab_settings',
                RECENT: 'vastvocab_recent',
                PROGRESS: 'vastvocab_progress',
                HISTORY: 'vastvocab_history'
            },

            getSettings() {
                const data = localStorage.getItem(this.KEYS.SETTINGS);
                return data ? JSON.parse(data) : {
                    timerDuration: 180,
                    lastCurriculumId: null
                };
            },

            saveSettings(settings) {
                localStorage.setItem(this.KEYS.SETTINGS, JSON.stringify(settings));
            },

            getTimerDuration() {
                return this.getSettings().timerDuration;
            },

            saveTimerDuration(seconds) {
                const settings = this.getSettings();
                settings.timerDuration = seconds;
                this.saveSettings(settings);
            },

            getLastCurriculumId() {
                return this.getSettings().lastCurriculumId;
            },

            saveLastCurriculumId(curriculumId) {
                const settings = this.getSettings();
                settings.lastCurriculumId = curriculumId;
                this.saveSettings(settings);
            },

            getRecentCurricula() {
                const data = localStorage.getItem(this.KEYS.RECENT);
                return data ? JSON.parse(data) : [];
            },

            addToRecent(curriculum) {
                let recent = this.getRecentCurricula();
                recent = recent.filter(item => item.id !== curriculum.id);
                recent.unshift({
                    id: curriculum.id,
                    breadcrumb: curriculum.breadcrumb,
                    lastPlayed: new Date().toISOString()
                });
                recent = recent.slice(0, 10);
                localStorage.setItem(this.KEYS.RECENT, JSON.stringify(recent));
            },

            getProgress(curriculumId) {
                const allProgress = localStorage.getItem(this.KEYS.PROGRESS);
                const progressData = allProgress ? JSON.parse(allProgress) : {};
                return progressData[curriculumId] || {
                    usedCategories: [],
                    gamesPlayed: 0,
                    bestScore: null
                };
            },

            saveProgress(curriculumId, progress) {
                const allProgress = localStorage.getItem(this.KEYS.PROGRESS);
                const progressData = allProgress ? JSON.parse(allProgress) : {};
                progressData[curriculumId] = progress;
                localStorage.setItem(this.KEYS.PROGRESS, JSON.stringify(progressData));
            },

            markCategoryUsed(curriculumId, categoryIndex) {
                const progress = this.getProgress(curriculumId);
                if (!progress.usedCategories.includes(categoryIndex)) {
                    progress.usedCategories.push(categoryIndex);
                    this.saveProgress(curriculumId, progress);
                }
            },

            incrementGamesPlayed(curriculumId) {
                const progress = this.getProgress(curriculumId);
                progress.gamesPlayed++;
                this.saveProgress(curriculumId, progress);
            },

            updateBestScore(curriculumId, score) {
                const progress = this.getProgress(curriculumId);
                if (progress.bestScore === null || score < progress.bestScore) {
                    progress.bestScore = score;
                    this.saveProgress(curriculumId, progress);
                }
            },

            resetProgress(curriculumId) {
                const allProgress = localStorage.getItem(this.KEYS.PROGRESS);
                const progressData = allProgress ? JSON.parse(allProgress) : {};
                progressData[curriculumId] = {
                    usedCategories: [],
                    gamesPlayed: 0,
                    bestScore: null
                };
                localStorage.setItem(this.KEYS.PROGRESS, JSON.stringify(progressData));
            },

            getHistory() {
                const data = localStorage.getItem(this.KEYS.HISTORY);
                return data ? JSON.parse(data) : [];
            },

            addToHistory(gameData) {
                let history = this.getHistory();
                history.unshift({
                    date: new Date().toISOString(),
                    curriculumId: gameData.curriculumId,
                    curriculumName: gameData.curriculumName,
                    won: gameData.won,
                    score: gameData.score,
                    category: gameData.category,
                    wordsGuessed: gameData.wordsGuessed,
                    totalWords: gameData.totalWords
                });
                history = history.slice(0, 100);
                localStorage.setItem(this.KEYS.HISTORY, JSON.stringify(history));
            },

            clearHistory() {
                localStorage.setItem(this.KEYS.HISTORY, JSON.stringify([]));
            }
        };

        // ===== CURRICULUM LOADER =====
        const CurriculumLoader = {
            manifest: null,
            currentCurriculum: null,
            currentData: null,

            async loadManifest() {
                const response = await fetch('manifest.json');
                if (!response.ok) throw new Error(`Failed to load manifest: ${response.status}`);
                this.manifest = await response.json();
                return this.manifest;
            },

            getAllCurricula() {
                return this.manifest ? this.manifest.curricula : [];
            },

            getCurriculumById(id) {
                if (!this.manifest) return null;
                return this.manifest.curricula.find(c => c.id === id);
            },

            getFrameworks() {
                if (!this.manifest) return [];
                const frameworks = [...new Set(this.manifest.curricula.map(c => ({
                    id: c.framework,
                    name: c.frameworkName
                })))];
                return frameworks.filter((f, index, self) => 
                    index === self.findIndex(t => t.id === f.id)
                );
            },

            getSubjects(framework) {
                if (!this.manifest) return [];
                const curricula = this.manifest.curricula.filter(c => c.framework === framework);
                const subjects = [...new Set(curricula.map(c => c.subject))].filter(Boolean);
                return subjects.sort();
            },

            getYears(framework, subject) {
                if (!this.manifest) return [];
                const curricula = this.manifest.curricula.filter(c => 
                    c.framework === framework && c.subject === subject
                );
                let years = [];
                if (framework === 'vic-curriculum') {
                    years = [...new Set(curricula.map(c => c.yearBand))].filter(Boolean);
                } else {
                    years = [...new Set(curricula.map(c => c.year))].filter(Boolean);
                }
                return years.sort();
            },

            getUnitsOrModules(framework, subject, year) {
                if (!this.manifest) return [];
                const curricula = this.manifest.curricula.filter(c => 
                    c.framework === framework && 
                    c.subject === subject && 
                    (c.year === year || c.yearBand === year)
                );
                let items = [];
                if (framework === 'vce') {
                    items = [...new Set(curricula.map(c => c.unit))].filter(Boolean);
                } else if (framework === 'hsc') {
                    items = [...new Set(curricula.map(c => c.module))].filter(Boolean);
                }
                return items.sort();
            },

            getAreas(framework, subject, year, unit) {
                if (!this.manifest || framework !== 'vce') return [];
                const curricula = this.manifest.curricula.filter(c => 
                    c.framework === framework && 
                    c.subject === subject && 
                    c.year === year &&
                    c.unit === unit
                );
                const areas = [...new Set(curricula.map(c => c.area))].filter(Boolean);
                return areas.sort();
            },

            getTopics(filters) {
                if (!this.manifest) return [];
                
                let curricula = this.manifest.curricula.filter(c => {
                    // Always check framework
                    if (c.framework !== filters.framework) return false;
                    
                    // Check subject if provided
                    if (filters.subject && c.subject !== filters.subject) return false;
                    
                    // Check year/yearBand if provided (handles both formats)
                    if (filters.year) {
                        if (c.year !== filters.year && c.yearBand !== filters.year) return false;
                    }
                    
                    // Framework-specific checks - only apply if field exists in filters
                    if (filters.framework === 'vce') {
                        if (filters.unit && c.unit !== filters.unit) return false;
                        if (filters.area && c.area !== filters.area) return false;
                    } else if (filters.framework === 'hsc') {
                        if (filters.module && c.module !== filters.module) return false;
                    }
                    
                    return true;
                });
                
                return curricula;
            },

            async loadCurriculumData(curriculumId) {
                const curriculum = this.getCurriculumById(curriculumId);
                if (!curriculum) throw new Error(`Curriculum not found: ${curriculumId}`);

                const response = await fetch(curriculum.path);
                if (!response.ok) throw new Error(`Failed to load curriculum: ${response.status}`);
                
                const data = await response.json();
                this.currentCurriculum = curriculum;
                this.currentData = data;
                
                StorageManager.saveLastCurriculumId(curriculumId);
                StorageManager.addToRecent(curriculum);
                
                return { curriculum, data };
            },

            getCurrentCurriculum() {
                return this.currentCurriculum;
            },

            getCurrentData() {
                return this.currentData;
            },

            getCategories() {
                return this.currentData ? this.currentData.categories : [];
            },

            applyColorTheme(curriculum) {
                const colors = curriculum.colors;
                if (!colors || colors.length < 4) return;
                document.documentElement.style.setProperty('--color-primary-dark', colors[0]);
                document.documentElement.style.setProperty('--color-primary', colors[1]);
                document.documentElement.style.setProperty('--color-secondary', colors[2]);
                document.documentElement.style.setProperty('--color-secondary-light', colors[3]);
            }
        };

        // ===== GAME ENGINE =====
        const GameEngine = {
            MAX_WORDS: 10,
            WORDS_PER_GAME: 5,
            MAX_LETTERS: 10,
            MAX_WRONG_GUESSES: 3,
            WRONG_GUESS_PENALTY: 3,
            CATEGORY_REVEAL_COST: 2,
            
            currentSet: null,
            currentWords: [],
            guessedWords: new Set(),
            selectedLetters: new Set(),
            wrongGuesses: 0,
            timeLeft: 0,
            timerDuration: 180,
            timerInterval: null,
            gameActive: false,
            categoryRevealed: false,
            categoryRevealCount: 0,
            curriculumId: null,
            categories: [],

            init(curriculumId, categories, timerDuration) {
                this.curriculumId = curriculumId;
                this.categories = categories;
                this.timerDuration = timerDuration;
                this.timeLeft = timerDuration;
            },

            getUnusedCategories() {
                const progress = StorageManager.getProgress(this.curriculumId);
                const usedIndices = progress.usedCategories;
                return this.categories.filter((cat, index) => !usedIndices.includes(index));
            },

            selectNextCategory() {
                let unused = this.getUnusedCategories();
                if (unused.length === 0) {
                    StorageManager.resetProgress(this.curriculumId);
                    unused = this.categories;
                }
                const selectedCategory = unused[Math.floor(Math.random() * unused.length)];
                const categoryIndex = this.categories.findIndex(c => c.category === selectedCategory.category);
                StorageManager.markCategoryUsed(this.curriculumId, categoryIndex);
                return selectedCategory;
            },

            getCategoryProgress() {
                const progress = StorageManager.getProgress(this.curriculumId);
                const usedCount = progress.usedCategories.length;
                const total = this.categories.length;
                return { used: usedCount, total: total };
            },

            startGame() {
                const fullSet = this.selectNextCategory();
                this.currentSet = {
                    category: fullSet.category,
                    words: fullSet.words.slice(0, this.WORDS_PER_GAME)
                };
                this.currentWords = this.currentSet.words;
                this.guessedWords.clear();
                this.selectedLetters.clear();
                this.wrongGuesses = 0;
                this.timeLeft = this.timerDuration;
                this.gameActive = true;
                this.categoryRevealed = false;
                this.categoryRevealCount = 0;
                this.startTimer();
                return {
                    category: this.currentSet.category,
                    words: this.currentWords,
                    progress: this.getCategoryProgress()
                };
            },

            revealCategory() {
                if (!this.gameActive || this.categoryRevealed) return false;
                const totalLetters = this.selectedLetters.size + this.CATEGORY_REVEAL_COST;
                if (totalLetters > this.MAX_LETTERS) return false;
                this.categoryRevealed = true;
                this.categoryRevealCount = this.CATEGORY_REVEAL_COST;
                return true;
            },

            selectLetter(letter) {
                if (!this.gameActive || this.selectedLetters.has(letter)) return null;
                const totalLetters = this.selectedLetters.size + this.categoryRevealCount;
                if (totalLetters >= this.MAX_LETTERS) return null;
                
                this.selectedLetters.add(letter);
                let found = false;
                const letterPositions = [];
                
                this.currentWords.forEach((word, wordIndex) => {
                    if (this.guessedWords.has(wordIndex)) return;
                    for (let i = 1; i < word.length; i++) {
                        if (word[i].toUpperCase() === letter) {
                            letterPositions.push({ wordIndex, position: i });
                            found = true;
                        }
                    }
                });
                
                return {
                    letter,
                    found,
                    positions: letterPositions,
                    totalLetters: this.selectedLetters.size + this.categoryRevealCount,
                    limitReached: (this.selectedLetters.size + this.categoryRevealCount) >= this.MAX_LETTERS
                };
            },

            makeGuess(guess) {
                if (!this.gameActive || !guess) return null;
                const guessLower = guess.toLowerCase().trim();
                let found = false;
                let wordIndex = -1;
                
                this.currentWords.forEach((word, index) => {
                    if (!this.guessedWords.has(index) && guessLower === word) {
                        found = true;
                        wordIndex = index;
                        this.guessedWords.add(index);
                    }
                });
                
                if (!found) this.wrongGuesses++;
                const gameOver = this.checkGameOver();
                
                return {
                    correct: found,
                    wordIndex,
                    word: found ? this.currentWords[wordIndex] : null,
                    wrongGuesses: this.wrongGuesses,
                    wordsGuessed: this.guessedWords.size,
                    totalWords: this.currentWords.length,
                    gameOver: gameOver.isOver,
                    won: gameOver.won,
                    reason: gameOver.reason
                };
            },

            checkGameOver() {
                if (this.wrongGuesses >= this.MAX_WRONG_GUESSES) {
                    return { isOver: true, won: false, reason: "Too many wrong guesses." };
                }
                if (this.guessedWords.size === this.currentWords.length) {
                    return { isOver: true, won: true, reason: "" };
                }
                if (this.timeLeft <= 0) {
                    return { isOver: true, won: false, reason: "Time's up." };
                }
                return { isOver: false, won: false, reason: "" };
            },

            startTimer() {
                clearInterval(this.timerInterval);
                this.timerInterval = setInterval(() => {
                    if (!this.gameActive) {
                        clearInterval(this.timerInterval);
                        return;
                    }
                    this.timeLeft--;
                    if (this.onTimerTick) this.onTimerTick(this.timeLeft);
                    if (this.timeLeft <= 0) this.endGame(false, "Time's up.");
                }, 1000);
            },

            stopTimer() {
                clearInterval(this.timerInterval);
            },

            endGame(won, reason = "") {
                this.gameActive = false;
                this.stopTimer();
                
                const finalScore = this.selectedLetters.size + this.categoryRevealCount + 
                                  (this.wrongGuesses * this.WRONG_GUESS_PENALTY);
                
                StorageManager.incrementGamesPlayed(this.curriculumId);
                if (won) StorageManager.updateBestScore(this.curriculumId, finalScore);
                
                const curriculum = CurriculumLoader.getCurrentCurriculum();
                StorageManager.addToHistory({
                    curriculumId: this.curriculumId,
                    curriculumName: curriculum ? curriculum.breadcrumb : 'Unknown',
                    won: won,
                    score: finalScore,
                    category: this.currentSet.category,
                    wordsGuessed: this.guessedWords.size,
                    totalWords: this.currentWords.length
                });
                
                return {
                    won,
                    reason,
                    score: finalScore,
                    category: this.currentSet.category,
                    wordsGuessed: this.guessedWords.size,
                    totalWords: this.currentWords.length,
                    words: this.currentWords
                };
            },

            concede() {
                if (!this.gameActive) return null;
                return this.endGame(false, "You conceded.");
            },

            getStats() {
                return {
                    letters: this.selectedLetters.size + this.categoryRevealCount,
                    wrongGuesses: this.wrongGuesses,
                    wordsGuessed: this.guessedWords.size,
                    totalWords: this.currentWords.length,
                    timeLeft: this.timeLeft,
                    categoryRevealed: this.categoryRevealed
                };
            },

            canAffordCategoryReveal() {
                const totalLetters = this.selectedLetters.size + this.categoryRevealCount;
                return !this.categoryRevealed && (totalLetters + this.CATEGORY_REVEAL_COST <= this.MAX_LETTERS);
            },

            setTimerCallback(callback) {
                this.onTimerTick = callback;
            }
        };

        // ===== UI CONTROLLER =====
        const UIController = {
            selectedFramework: null,
            selectedSubject: null,
            selectedYear: null,
            selectedUnitOrModule: null,
            selectedArea: null,
            isGameInProgress: false,

            async init() {
                try {
                    await CurriculumLoader.loadManifest();
                    this.setupEventListeners();
                    this.loadSettings();
                    await this.autoLoadLastCurriculum();
                } catch (error) {
                    this.showError('Failed to load curriculum data. Please refresh the page.');
                    console.error(error);
                }
            },

            setupEventListeners() {
                document.getElementById('changeTopicBtn')?.addEventListener('click', () => this.toggleSettings());
                document.getElementById('recentBtn')?.addEventListener('click', () => this.toggleRecent());
                document.getElementById('closeSettingsBtn')?.addEventListener('click', () => this.toggleSettings());
                
                document.querySelectorAll('.timer-btn').forEach(btn => {
                    btn.addEventListener('click', (e) => this.selectTimer(e.target.dataset.duration));
                });
                
                document.getElementById('frameworkSelect')?.addEventListener('change', (e) => this.onFrameworkChange(e.target.value));
                document.getElementById('gameControlBtn')?.addEventListener('click', () => this.onGameControl());
                document.getElementById('revealCategoryBtn')?.addEventListener('click', () => this.onRevealCategory());
                document.getElementById('helpBtn')?.addEventListener('click', () => this.toggleHelp());
                document.getElementById('statsBtn')?.addEventListener('click', () => this.toggleStats());
                document.getElementById('closeHelpBtn')?.addEventListener('click', () => this.toggleHelp());
                document.getElementById('closeStatsBtn')?.addEventListener('click', () => this.toggleStats());
                document.getElementById('clearStatsBtn')?.addEventListener('click', () => this.clearStats());
                document.getElementById('resetProgressBtn')?.addEventListener('click', () => this.resetProgress());
                document.addEventListener('click', (e) => this.handleOutsideClick(e));
                document.getElementById('guessInput')?.addEventListener('keypress', (e) => this.onGuessSubmit(e));
            },

            loadSettings() {
                const timerDuration = StorageManager.getTimerDuration();
                document.querySelectorAll('.timer-btn').forEach(btn => {
                    btn.classList.toggle('active', parseInt(btn.dataset.duration) === timerDuration);
                });
            },

            async autoLoadLastCurriculum() {
                const lastId = StorageManager.getLastCurriculumId();
                if (lastId) {
                    try {
                        await this.loadCurriculum(lastId);
                    } catch (error) {
                        console.error('Failed to load last curriculum:', error);
                        this.showSettings();
                    }
                } else {
                    this.showSettings();
                }
            },

            async loadCurriculum(curriculumId) {
                try {
                    const { curriculum, data } = await CurriculumLoader.loadCurriculumData(curriculumId);
                    CurriculumLoader.applyColorTheme(curriculum);
                    this.updateCurrentCurriculumDisplay(curriculum);
                    const timerDuration = StorageManager.getTimerDuration();
                    GameEngine.init(curriculumId, data.categories, timerDuration);
                    GameEngine.setTimerCallback((timeLeft) => this.onTimerTick(timeLeft));
                    this.hideSettings();
                    this.startNewGame();
                } catch (error) {
                    this.showError('Failed to load curriculum: ' + error.message);
                    throw error;
                }
            },

            updateCurrentCurriculumDisplay(curriculum) {
                const nameEl = document.getElementById('currentCurriculumName');
                if (nameEl) nameEl.textContent = curriculum.breadcrumb;
            },

            toggleSettings() {
                if (this.isGameInProgress) return;
                const panel = document.getElementById('settingsPanel');
                const isActive = panel.classList.toggle('active');
                if (isActive) {
                    this.hideRecent();
                    this.populateFrameworkSelector();
                }
            },

            showSettings() {
                const panel = document.getElementById('settingsPanel');
                panel.classList.add('active');
                this.populateFrameworkSelector();
            },

            hideSettings() {
                const panel = document.getElementById('settingsPanel');
                panel.classList.remove('active');
            },

            populateFrameworkSelector() {
                const select = document.getElementById('frameworkSelect');
                if (!select) return;
                const frameworks = CurriculumLoader.getFrameworks();
                select.innerHTML = '<option value="">Select Framework...</option>';
                frameworks.forEach(fw => {
                    const option = document.createElement('option');
                    option.value = fw.id;
                    option.textContent = fw.name;
                    select.appendChild(option);
                });
            },

            onFrameworkChange(framework) {
                this.selectedFramework = framework;
                this.selectedSubject = null;
                this.selectedYear = null;
                this.selectedUnitOrModule = null;
                this.selectedArea = null;
                if (!framework) {
                    this.clearDynamicSelectors();
                    return;
                }
                this.buildSubjectSelector();
            },

            buildSubjectSelector() {
                const subjects = CurriculumLoader.getSubjects(this.selectedFramework);
                const container = document.getElementById('dynamicSelectors');
                container.innerHTML = `
                    <div class="selector-row">
                        <label class="selector-label">Framework</label>
                        <input type="text" class="selector-dropdown" value="${this.formatLabel(this.selectedFramework)}" readonly style="background: #f5f5f5; cursor: default;">
                    </div>
                    <div class="selector-row">
                        <label class="selector-label">Subject</label>
                        <select class="selector-dropdown" id="subjectSelect">
                            <option value="">Select Subject...</option>
                            ${subjects.map(s => `<option value="${s}">${this.formatLabel(s)}</option>`).join('')}
                        </select>
                    </div>
                `;
                document.getElementById('subjectSelect').addEventListener('change', (e) => this.onSubjectChange(e.target.value));
            },

            onSubjectChange(subject) {
                this.selectedSubject = subject;
                this.selectedYear = null;
                this.selectedUnitOrModule = null;
                this.selectedArea = null;
                if (!subject) return;
                this.buildYearSelector();
            },

            buildYearSelector() {
                const years = CurriculumLoader.getYears(this.selectedFramework, this.selectedSubject);
                const label = this.selectedFramework === 'vic-curriculum' ? 'Year Band' : 'Year Level';
                const container = document.getElementById('dynamicSelectors');
                container.innerHTML = `
                    <div class="selector-row">
                        <label class="selector-label">Framework</label>
                        <input type="text" class="selector-dropdown" value="${this.formatLabel(this.selectedFramework)}" readonly style="background: #f5f5f5; cursor: default;">
                    </div>
                    <div class="selector-row">
                        <label class="selector-label">Subject</label>
                        <input type="text" class="selector-dropdown" value="${this.formatLabel(this.selectedSubject)}" readonly style="background: #f5f5f5; cursor: default;">
                    </div>
                    <div class="selector-row">
                        <label class="selector-label">${label}</label>
                        <select class="selector-dropdown" id="yearSelect">
                            <option value="">Select ${label}...</option>
                            ${years.map(y => `<option value="${y}">${this.formatLabel(y)}</option>`).join('')}
                        </select>
                    </div>
                `;
                document.getElementById('yearSelect').addEventListener('change', (e) => this.onYearChange(e.target.value));
            },

            onYearChange(year) {
                this.selectedYear = year;
                this.selectedUnitOrModule = null;
                this.selectedArea = null;
                if (!year) return;
                if (this.selectedFramework === 'vce' || this.selectedFramework === 'hsc') {
                    this.buildUnitModuleSelector();
                } else {
                    this.buildTopicSelector();
                }
            },

            buildUnitModuleSelector() {
                const items = CurriculumLoader.getUnitsOrModules(this.selectedFramework, this.selectedSubject, this.selectedYear);
                const label = this.selectedFramework === 'vce' ? 'Unit' : 'Module';
                const yearLabel = this.selectedFramework === 'vic-curriculum' ? 'Year Band' : 'Year Level';
                const container = document.getElementById('dynamicSelectors');
                container.innerHTML = `
                    <div class="selector-row">
                        <label class="selector-label">Framework</label>
                        <input type="text" class="selector-dropdown" value="${this.formatLabel(this.selectedFramework)}" readonly style="background: #f5f5f5; cursor: default;">
                    </div>
                    <div class="selector-row">
                        <label class="selector-label">Subject</label>
                        <input type="text" class="selector-dropdown" value="${this.formatLabel(this.selectedSubject)}" readonly style="background: #f5f5f5; cursor: default;">
                    </div>
                    <div class="selector-row">
                        <label class="selector-label">${yearLabel}</label>
                        <input type="text" class="selector-dropdown" value="${this.formatLabel(this.selectedYear)}" readonly style="background: #f5f5f5; cursor: default;">
                    </div>
                    <div class="selector-row">
                        <label class="selector-label">${label}</label>
                        <select class="selector-dropdown" id="unitModuleSelect">
                            <option value="">Select ${label}...</option>
                            ${items.map(i => `<option value="${i}">${this.formatLabel(i)}</option>`).join('')}
                        </select>
                    </div>
                `;
                document.getElementById('unitModuleSelect').addEventListener('change', (e) => this.onUnitModuleChange(e.target.value));
            },

            onUnitModuleChange(item) {
                this.selectedUnitOrModule = item;
                this.selectedArea = null;
                if (!item) return;
                if (this.selectedFramework === 'vce') {
                    const areas = CurriculumLoader.getAreas(this.selectedFramework, this.selectedSubject, this.selectedYear, item);
                    if (areas.length > 0) {
                        this.buildAreaSelector(areas);
                        return;
                    }
                }
                this.buildTopicSelector();
            },

            buildAreaSelector(areas) {
                const container = document.getElementById('dynamicSelectors');
                container.innerHTML = `
                    <div class="selector-row">
                        <label class="selector-label">Framework</label>
                        <input type="text" class="selector-dropdown" value="${this.formatLabel(this.selectedFramework)}" readonly style="background: #f5f5f5; cursor: default;">
                    </div>
                    <div class="selector-row">
                        <label class="selector-label">Subject</label>
                        <input type="text" class="selector-dropdown" value="${this.formatLabel(this.selectedSubject)}" readonly style="background: #f5f5f5; cursor: default;">
                    </div>
                    <div class="selector-row">
                        <label class="selector-label">Year Level</label>
                        <input type="text" class="selector-dropdown" value="${this.formatLabel(this.selectedYear)}" readonly style="background: #f5f5f5; cursor: default;">
                    </div>
                    <div class="selector-row">
                        <label class="selector-label">Unit</label>
                        <input type="text" class="selector-dropdown" value="${this.formatLabel(this.selectedUnitOrModule)}" readonly style="background: #f5f5f5; cursor: default;">
                    </div>
                    <div class="selector-row">
                        <label class="selector-label">Area of Study</label>
                        <select class="selector-dropdown" id="areaSelect">
                            <option value="">Select Area...</option>
                            ${areas.map(a => `<option value="${a}">${this.formatLabel(a)}</option>`).join('')}
                        </select>
                    </div>
                `;
                document.getElementById('areaSelect').addEventListener('change', (e) => this.onAreaChange(e.target.value));
            },

            onAreaChange(area) {
                this.selectedArea = area;
                if (!area) return;
                this.buildTopicSelector();
            },

            buildTopicSelector() {
                // Framework-aware filtering - only set relevant fields
                const filters = {
                    framework: this.selectedFramework,
                    subject: this.selectedSubject,
                    year: this.selectedYear
                };
                
                // Add framework-specific fields
                if (this.selectedFramework === 'vce') {
                    if (this.selectedUnitOrModule) filters.unit = this.selectedUnitOrModule;
                    if (this.selectedArea) filters.area = this.selectedArea;
                } else if (this.selectedFramework === 'hsc') {
                    if (this.selectedUnitOrModule) filters.module = this.selectedUnitOrModule;
                }
                
                const topics = CurriculumLoader.getTopics(filters);
                const yearLabel = this.selectedFramework === 'vic-curriculum' ? 'Year Band' : 'Year Level';
                
                let html = `
                    <div class="selector-row">
                        <label class="selector-label">Framework</label>
                        <input type="text" class="selector-dropdown" value="${this.formatLabel(this.selectedFramework)}" readonly style="background: #f5f5f5; cursor: default;">
                    </div>
                    <div class="selector-row">
                        <label class="selector-label">Subject</label>
                        <input type="text" class="selector-dropdown" value="${this.formatLabel(this.selectedSubject)}" readonly style="background: #f5f5f5; cursor: default;">
                    </div>
                    <div class="selector-row">
                        <label class="selector-label">${yearLabel}</label>
                        <input type="text" class="selector-dropdown" value="${this.formatLabel(this.selectedYear)}" readonly style="background: #f5f5f5; cursor: default;">
                    </div>
                `;
                
                // Show unit/module if selected
                if (this.selectedUnitOrModule) {
                    const unitModuleLabel = this.selectedFramework === 'vce' ? 'Unit' : 'Module';
                    html += `
                        <div class="selector-row">
                            <label class="selector-label">${unitModuleLabel}</label>
                            <input type="text" class="selector-dropdown" value="${this.formatLabel(this.selectedUnitOrModule)}" readonly style="background: #f5f5f5; cursor: default;">
                        </div>
                    `;
                }
                
                // Show area if selected (VCE only)
                if (this.selectedArea) {
                    html += `
                        <div class="selector-row">
                            <label class="selector-label">Area of Study</label>
                            <input type="text" class="selector-dropdown" value="${this.formatLabel(this.selectedArea)}" readonly style="background: #f5f5f5; cursor: default;">
                        </div>
                    `;
                }
                
                html += `
                    <div class="selector-row">
                        <label class="selector-label">Topic</label>
                        <select class="selector-dropdown" id="topicSelect">
                            <option value="">Select Topic...</option>
                            ${topics.map(t => `<option value="${t.id}">${this.formatLabel(t.topic || t.topicName || t.breadcrumb)}</option>`).join('')}
                        </select>
                    </div>
                    <button class="start-game-btn" id="startGameBtn" disabled>Start Game</button>
                `;
                
                const container = document.getElementById('dynamicSelectors');
                container.innerHTML = html;
                
                const topicSelect = document.getElementById('topicSelect');
                const startBtn = document.getElementById('startGameBtn');
                topicSelect.addEventListener('change', (e) => {
                    startBtn.disabled = !e.target.value;
                });
                startBtn.addEventListener('click', () => {
                    const curriculumId = topicSelect.value;
                    if (curriculumId) this.loadCurriculum(curriculumId);
                });
            },

            clearDynamicSelectors() {
                const container = document.getElementById('dynamicSelectors');
                if (container) container.innerHTML = '';
            },

            formatLabel(str) {
                if (!str) return '';
                return str.split('-')
                    .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                    .join(' ')
                    .replace(/\b(\d+)\b/g, (match) => parseInt(match).toString());
            },

            selectTimer(duration) {
                const seconds = parseInt(duration);
                StorageManager.saveTimerDuration(seconds);
                document.querySelectorAll('.timer-btn').forEach(btn => {
                    btn.classList.toggle('active', parseInt(btn.dataset.duration) === seconds);
                });
            },

            toggleRecent() {
                if (this.isGameInProgress) return;
                const dropdown = document.getElementById('recentDropdown');
                const isActive = dropdown.classList.toggle('active');
                if (isActive) {
                    this.hideSettings();
                    this.populateRecentList();
                }
            },

            hideRecent() {
                const dropdown = document.getElementById('recentDropdown');
                dropdown.classList.remove('active');
            },

            populateRecentList() {
                const recent = StorageManager.getRecentCurricula();
                const container = document.getElementById('recentList');
                if (recent.length === 0) {
                    container.innerHTML = '<div class="no-recent">No recent curricula</div>';
                    return;
                }
                container.innerHTML = recent.map(item => {
                    const progress = StorageManager.getProgress(item.id);
                    const progressText = `${progress.usedCategories.length}/100`;
                    const timeAgo = this.formatTimeAgo(item.lastPlayed);
                    return `
                        <div class="recent-item" data-id="${item.id}">
                            <div class="recent-item-name">${item.breadcrumb}</div>
                            <div class="recent-item-details">
                                <span>${timeAgo}</span>
                                <span class="recent-item-progress">${progressText} categories</span>
                            </div>
                        </div>
                    `;
                }).join('');
                container.querySelectorAll('.recent-item').forEach(item => {
                    item.addEventListener('click', () => {
                        const id = item.dataset.id;
                        this.loadCurriculum(id);
                    });
                });
            },

            formatTimeAgo(isoString) {
                const date = new Date(isoString);
                const now = new Date();
                const seconds = Math.floor((now - date) / 1000);
                if (seconds < 60) return 'Just now';
                if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
                if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
                if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;
                return date.toLocaleDateString();
            },

            startNewGame() {
                const gameData = GameEngine.startGame();
                this.isGameInProgress = true;
                this.updateTopBarControls(true);
                this.updateCategoryProgress(gameData.progress);
                this.resetCategoryDisplay();
                this.resetMessages();
                this.resetStats();
                this.createWordDisplay(gameData.words);
                this.createAlphabet();
                this.resetGuessInput();
                this.updateGameControlButton(true);
                this.hideGameOverMessage();
            },

            updateTopBarControls(gameInProgress) {
                document.getElementById('changeTopicBtn').disabled = gameInProgress;
                document.getElementById('recentBtn').disabled = gameInProgress;
            },

            updateCategoryProgress(progress) {
                const el = document.getElementById('categoryProgress');
                if (!el) return;
                if (progress.used === 0 || progress.used === 1) {
                    el.textContent = `Category ${progress.used || 1} of ${progress.total}`;
                } else if (progress.used === progress.total) {
                    el.textContent = `All ${progress.total} categories completed. Starting over.`;
                } else {
                    el.textContent = `Category ${progress.used} of ${progress.total}`;
                }
            },

            resetCategoryDisplay() {
                const btn = document.getElementById('revealCategoryBtn');
                const text = document.getElementById('categoryText');
                btn.style.display = 'block';
                btn.disabled = false;
                btn.textContent = 'Reveal Category (Costs 2 Letters)';
                text.style.display = 'none';
                text.textContent = '';
            },

            resetMessages() {
                document.getElementById('limitMessage').classList.remove('active');
                document.getElementById('letterStat').classList.remove('warning');
                document.getElementById('wrongStat').classList.remove('warning');
                document.getElementById('timerStat').classList.remove('warning');
                document.querySelector('#letterStat .stat-label').textContent = 'Letters Used';
            },

            resetStats() {
                this.updateStatsDisplay();
            },

            createWordDisplay(words) {
                const container = document.getElementById('wordsContainer');
                container.innerHTML = '';
                words.forEach((word, index) => {
                    const row = document.createElement('div');
                    row.className = 'word-row';
                    const number = document.createElement('div');
                    number.className = 'word-number';
                    number.textContent = `${index + 1}.`;
                    const display = document.createElement('div');
                    display.className = 'word-display';
                    display.id = `word-${index}`;
                    if (word.length > 10) display.style.gap = '3px';
                    else if (word.length > 8) display.style.gap = '4px';
                    else if (word.length > 6) display.style.gap = '5px';
                    for (let i = 0; i < word.length; i++) {
                        const box = document.createElement('div');
                        box.className = 'letter-box';
                        box.id = `letter-${index}-${i}`;
                        if (word.length > 10) {
                            box.style.width = '26px';
                            box.style.height = '26px';
                            box.style.fontSize = '0.9em';
                        } else if (word.length > 8) {
                            box.style.width = '28px';
                            box.style.height = '28px';
                            box.style.fontSize = '1em';
                        } else if (word.length > 6) {
                            box.style.width = '30px';
                            box.style.height = '30px';
                            box.style.fontSize = '1.05em';
                        }
                        if (i === 0) {
                            box.textContent = word[0].toUpperCase();
                            box.classList.add('revealed');
                        }
                        display.appendChild(box);
                    }
                    const answer = document.createElement('div');
                    answer.className = 'word-answer';
                    answer.id = `answer-${index}`;
                    row.appendChild(number);
                    row.appendChild(display);
                    row.appendChild(answer);
                    container.appendChild(row);
                });
            },

            createAlphabet() {
                const container = document.getElementById('alphabet');
                container.innerHTML = '';
                const vowels = ['A', 'E', 'I', 'O', 'U'];
                for (let i = 65; i <= 90; i++) {
                    const letter = String.fromCharCode(i);
                    const btn = document.createElement('button');
                    btn.className = 'letter-btn';
                    if (vowels.includes(letter)) btn.className += ' vowel';
                    btn.textContent = letter;
                    btn.id = `btn-${letter}`;
                    btn.addEventListener('click', () => this.onLetterClick(letter));
                    container.appendChild(btn);
                }
            },

            resetGuessInput() {
                const input = document.getElementById('guessInput');
                input.value = '';
                input.disabled = false;
                input.classList.remove('wrong-guess-indicator', 'correct-guess-indicator');
                input.focus();
            },

            updateGameControlButton(gameActive) {
                const btn = document.getElementById('gameControlBtn');
                const hint = document.getElementById('controlsHint');
                if (gameActive) {
                    btn.textContent = 'Concede';
                    hint.textContent = 'Give up and start fresh';
                } else {
                    btn.textContent = 'New Game';
                    hint.textContent = 'Start a fresh game';
                }
            },

            hideGameOverMessage() {
                document.getElementById('gameOverMessage').classList.remove('active');
            },

            onLetterClick(letter) {
                const result = GameEngine.selectLetter(letter);
                if (!result) return;
                const btn = document.getElementById(`btn-${letter}`);
                btn.disabled = true;
                if (!result.found) btn.classList.add('no-match');
                result.positions.forEach(({wordIndex, position}) => {
                    const box = document.getElementById(`letter-${wordIndex}-${position}`);
                    box.textContent = letter;
                    box.classList.add('revealed');
                });
                this.updateStatsDisplay();
                if (result.limitReached) {
                    this.showLetterLimitMessage();
                    this.disableRemainingLetters();
                }
                if (!GameEngine.canAffordCategoryReveal()) {
                    const btn = document.getElementById('revealCategoryBtn');
                    btn.disabled = true;
                    btn.textContent = "Can't Afford (Would exceed 10 letters)";
                }
            },

            showLetterLimitMessage() {
                document.getElementById('limitMessage').classList.add('active');
            },

            disableRemainingLetters() {
                document.querySelectorAll('.letter-btn:not(:disabled)').forEach(btn => {
                    btn.disabled = true;
                    btn.title = "Letter limit reached - guess the words";
                });
            },

            onRevealCategory() {
                if (!GameEngine.revealCategory()) return;
                document.getElementById('revealCategoryBtn').style.display = 'none';
                document.getElementById('categoryText').style.display = 'block';
                document.getElementById('categoryText').textContent = `Category: ${GameEngine.currentSet.category}`;
                this.updateStatsDisplay();
                const stats = GameEngine.getStats();
                if (stats.letters >= GameEngine.MAX_LETTERS) {
                    this.showLetterLimitMessage();
                    this.disableRemainingLetters();
                }
            },

            onGuessSubmit(e) {
                if (e.key !== 'Enter') return;
                const input = e.target;
                const guess = input.value;
                if (!guess) return;
                const result = GameEngine.makeGuess(guess);
                if (!result) return;
                if (result.correct) {
                    const answer = document.getElementById(`answer-${result.wordIndex}`);
                    answer.textContent = result.word.toUpperCase();
                    answer.classList.add('revealed');
                    for (let i = 0; i < result.word.length; i++) {
                        const box = document.getElementById(`letter-${result.wordIndex}-${i}`);
                        box.textContent = result.word[i].toUpperCase();
                        box.classList.add('guessed');
                    }
                    input.classList.add('correct-guess-indicator');
                    setTimeout(() => input.classList.remove('correct-guess-indicator'), 500);
                } else {
                    input.classList.add('wrong-guess-indicator');
                    setTimeout(() => input.classList.remove('wrong-guess-indicator'), 500);
                }
                this.updateStatsDisplay();
                if (result.gameOver) this.endGame(result.won, result.reason);
                input.value = '';
                input.focus();
            },

            onTimerTick(timeLeft) {
                const minutes = Math.floor(timeLeft / 60);
                const seconds = timeLeft % 60;
                document.getElementById('timer').textContent = 
                    `${minutes}:${seconds.toString().padStart(2, '0')}`;
                if (timeLeft <= 30) {
                    document.getElementById('timerStat').classList.add('warning');
                }
            },

            updateStatsDisplay() {
                const stats = GameEngine.getStats();
                document.getElementById('letterCount').textContent = stats.letters;
                document.getElementById('wrongCount').textContent = stats.wrongGuesses;
                document.getElementById('wordsGuessed').textContent = `${stats.wordsGuessed}/${stats.totalWords}`;
                if (stats.letters >= GameEngine.MAX_LETTERS) {
                    document.getElementById('letterStat').classList.add('warning');
                    document.querySelector('#letterStat .stat-label').textContent = 'Letter Limit Reached';
                } else if (stats.letters >= GameEngine.MAX_LETTERS - 2) {
                    document.getElementById('letterStat').classList.add('warning');
                }
                if (stats.wrongGuesses >= GameEngine.MAX_WRONG_GUESSES - 1) {
                    document.getElementById('wrongStat').classList.add('warning');
                }
            },

            onGameControl() {
                if (GameEngine.gameActive) {
                    const result = GameEngine.concede();
                    this.endGame(result.won, result.reason);
                } else {
                    this.startNewGame();
                }
            },

            endGame(won, reason = "") {
                this.isGameInProgress = false;
                this.updateTopBarControls(false);
                const result = GameEngine.endGame(won, reason);
                document.getElementById('limitMessage').classList.remove('active');
                const messageDiv = document.getElementById('gameOverMessage');
                const title = document.getElementById('gameOverTitle');
                const text = document.getElementById('gameOverText');
                const score = document.getElementById('finalScore');
                if (won) {
                    const history = StorageManager.getHistory();
                    const curriculumHistory = history.filter(g => g.curriculumId === GameEngine.curriculumId && g.won);
                    const isNewBest = curriculumHistory.length === 0 || 
                                     result.score < Math.min(...curriculumHistory.map(g => g.score));
                    if (isNewBest) {
                        title.textContent = "üèÜ New Best Score";
                        text.textContent = `Amazing! You guessed all ${result.totalWords} words with a new record.`;
                    } else {
                        title.textContent = "üéâ Congratulations";
                        text.textContent = `You guessed all ${result.totalWords} words.`;
                    }
                    score.textContent = `Final Score: ${result.score} letters`;
                } else {
                    title.textContent = "Game Over";
                    text.textContent = reason || "Better luck next time.";
                    score.textContent = `Words Guessed: ${result.wordsGuessed}/${result.totalWords}`;
                    result.words.forEach((word, index) => {
                        if (!GameEngine.guessedWords.has(index)) {
                            const answer = document.getElementById(`answer-${index}`);
                            answer.textContent = word.toUpperCase();
                            answer.classList.add('revealed');
                            answer.style.background = '#ffebee';
                            answer.style.borderColor = '#ff5252';
                            answer.style.color = '#ff5252';
                            for (let i = 0; i < word.length; i++) {
                                const box = document.getElementById(`letter-${index}-${i}`);
                                box.textContent = word[i].toUpperCase();
                                box.style.background = '#ffebee';
                                box.style.borderColor = '#ff5252';
                                box.style.color = '#ff5252';
                            }
                        }
                    });
                }
                messageDiv.classList.add('active');
                document.getElementById('guessInput').disabled = true;
                document.querySelectorAll('.letter-btn').forEach(btn => btn.disabled = true);
                document.getElementById('revealCategoryBtn').disabled = true;
                this.updateGameControlButton(false);
                if (!GameEngine.categoryRevealed) {
                    document.getElementById('revealCategoryBtn').style.display = 'none';
                    document.getElementById('categoryText').style.display = 'block';
                    document.getElementById('categoryText').textContent = `Category was: ${result.category}`;
                }
            },

            toggleHelp() {
                document.getElementById('helpPanel').classList.toggle('active');
            },

            toggleStats() {
                const panel = document.getElementById('statsPanel');
                if (!panel.classList.contains('active')) this.displayStats();
                panel.classList.toggle('active');
            },

            displayStats() {
                const history = StorageManager.getHistory();
                const summaryDiv = document.getElementById('statsSummary');
                const listDiv = document.getElementById('statsList');
                if (history.length === 0) {
                    summaryDiv.innerHTML = '<div style="text-align: center; padding: 20px;"><div style="font-size: 2em; margin-bottom: 10px;">üìä</div><p>No games played yet.</p></div>';
                    listDiv.innerHTML = '';
                    document.querySelector('.clear-stats-btn').style.display = 'none';
                    return;
                }
                document.querySelector('.clear-stats-btn').style.display = 'block';
                const wins = history.filter(g => g.won).length;
                const winRate = Math.round((wins / history.length) * 100);
                const avgScore = wins > 0 ? (history.filter(g => g.won).reduce((sum, g) => sum + g.score, 0) / wins).toFixed(1) : 'N/A';
                const bestScore = wins > 0 ? Math.min(...history.filter(g => g.won).map(g => g.score)) : 'N/A';
                summaryDiv.innerHTML = `
                    <div class="stats-summary-item"><span class="stats-summary-label">Games Played:</span><span class="stats-summary-value">${history.length}</span></div>
                    <div class="stats-summary-item"><span class="stats-summary-label">Win Rate:</span><span class="stats-summary-value">${winRate}%</span></div>
                    <div class="stats-summary-item"><span class="stats-summary-label">Average Score:</span><span class="stats-summary-value">${avgScore}</span></div>
                    <div class="stats-summary-item"><span class="stats-summary-label">Best Score:</span><span class="stats-summary-value" style="color: var(--color-secondary);">${bestScore}</span></div>
                `;
                const sorted = [...history].sort((a, b) => {
                    if (a.won && !b.won) return -1;
                    if (!a.won && b.won) return 1;
                    if (a.won && b.won) return a.score - b.score;
                    return b.wordsGuessed - a.wordsGuessed;
                });
                listDiv.innerHTML = sorted.map((game, index) => {
                    const date = new Date(game.date);
                    const dateStr = `${date.getMonth()+1}/${date.getDate()} ${date.getHours()}:${date.getMinutes().toString().padStart(2, '0')}`;
                    let rankClass = '', rankSymbol = `#${index + 1}`;
                    if (index === 0) { rankClass = 'gold'; rankSymbol = 'ü•á'; }
                    else if (index === 1) { rankClass = 'silver'; rankSymbol = 'ü•à'; }
                    else if (index === 2) { rankClass = 'bronze'; rankSymbol = 'ü•â'; }
                    return `
                        <div class="stats-item ${game.won ? 'win' : 'loss'}">
                            <div><span class="stats-rank ${rankClass}">${rankSymbol}</span><span class="stats-score">${game.won ? `Score: ${game.score}` : `${game.wordsGuessed}/${game.totalWords} words`}</span></div>
                            <div class="stats-category">${game.category}</div>
                            <div class="stats-details">${dateStr} ¬∑ ${game.won ? 'Won' : 'Lost'}</div>
                        </div>
                    `;
                }).join('');
            },

            clearStats() {
                if (confirm('Clear all game history? This cannot be undone.')) {
                    StorageManager.clearHistory();
                    this.displayStats();
                }
            },

            resetProgress() {
                if (!GameEngine.curriculumId) return;
                if (confirm('Reset category progress? This will allow all categories to appear again for the current curriculum.')) {
                    StorageManager.resetProgress(GameEngine.curriculumId);
                    const progress = GameEngine.getCategoryProgress();
                    this.updateCategoryProgress(progress);
                    const el = document.getElementById('categoryProgress');
                    const originalText = el.textContent;
                    el.textContent = 'Category progress reset';
                    setTimeout(() => {
                        this.updateCategoryProgress(GameEngine.getCategoryProgress());
                    }, 2000);
                }
            },

            handleOutsideClick(e) {
                const helpPanel = document.getElementById('helpPanel');
                const helpBtn = document.querySelector('.help-btn');
                const statsPanel = document.getElementById('statsPanel');
                const statsBtn = document.querySelector('.stats-btn');
                const settingsPanel = document.getElementById('settingsPanel');
                const changeBtn = document.getElementById('changeTopicBtn');
                const recentDropdown = document.getElementById('recentDropdown');
                const recentBtn = document.getElementById('recentBtn');
                if (helpPanel.classList.contains('active') && !helpPanel.contains(e.target) && e.target !== helpBtn) {
                    helpPanel.classList.remove('active');
                }
                if (statsPanel.classList.contains('active') && !statsPanel.contains(e.target) && e.target !== statsBtn) {
                    statsPanel.classList.remove('active');
                }
                if (settingsPanel.classList.contains('active') && !settingsPanel.contains(e.target) && e.target !== changeBtn && !changeBtn.contains(e.target)) {
                    if (!settingsPanel.contains(e.target)) this.hideSettings();
                }
                if (recentDropdown.classList.contains('active') && !recentDropdown.contains(e.target) && e.target !== recentBtn && !recentBtn.contains(e.target)) {
                    this.hideRecent();
                }
            },

            showError(message) {
                alert(message);
            }
        };

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', () => {
            UIController.init();
        });
    </script>
</body>
</html>