<!DOCTYPE html>
<html lang="en" dir="ltr" data-theme="dark" data-mode="standard" data-version="1.0.0">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<meta name="description" content="Interactive educational tool exploring stellar brightness, absolute and apparent magnitude for Year 10 students.">
<meta name="theme-color" content="#0a0e1a">
<meta property="og:title" content="How Bright Are Stars, Really?">
<meta property="og:description" content="Learn about absolute and apparent magnitude with interactive simulations.">
<title>How Bright Are Stars, Really?</title>
<style>
/* ===== CSS RESET ===== */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

/* ===== CSS CUSTOM PROPERTIES ===== */
:root {
  /* Spacing scale */
  --space-1: 0.25rem;
  --space-2: 0.5rem;
  --space-3: 0.75rem;
  --space-4: 1rem;
  --space-5: 1.5rem;
  --space-6: 2rem;
  --space-7: 3rem;
  --space-8: 4rem;

  /* Typography */
  --font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
  --font-mono: 'SF Mono', 'Fira Code', 'Consolas', monospace;
  --font-size-xs: clamp(0.7rem, 0.65rem + 0.25vw, 0.8rem);
  --font-size-sm: clamp(0.8rem, 0.75rem + 0.25vw, 0.9rem);
  --font-size-base: clamp(0.9rem, 0.85rem + 0.3vw, 1.05rem);
  --font-size-md: clamp(1rem, 0.9rem + 0.5vw, 1.25rem);
  --font-size-lg: clamp(1.2rem, 1rem + 0.8vw, 1.6rem);
  --font-size-xl: clamp(1.5rem, 1.2rem + 1.2vw, 2.2rem);
  --font-size-xxl: clamp(1.8rem, 1.4rem + 1.5vw, 2.8rem);

  /* Transitions */
  --transition-fast: 0.15s ease;
  --transition-base: 0.25s ease;
  --transition-slow: 0.4s ease;

  /* Borders */
  --radius-sm: 4px;
  --radius-md: 8px;
  --radius-lg: 12px;
  --radius-xl: 16px;
  --radius-full: 9999px;

  /* Shadows */
  --shadow-sm: 0 1px 3px rgba(0,0,0,0.12);
  --shadow-md: 0 4px 12px rgba(0,0,0,0.15);
  --shadow-lg: 0 8px 30px rgba(0,0,0,0.2);
  --shadow-glow: 0 0 20px rgba(100,150,255,0.3);

  /* Z-index scale */
  --z-base: 1;
  --z-dropdown: 100;
  --z-sticky: 200;
  --z-overlay: 300;
  --z-modal: 400;
  --z-toast: 500;
}

/* ===== DARK THEME (default) ===== */
[data-theme="dark"] {
  --bg-primary: #0a0e1a;
  --bg-secondary: #111827;
  --bg-tertiary: #1a2235;
  --bg-surface: #1e293b;
  --bg-surface-hover: #263348;
  --bg-canvas: #050810;

  --text-primary: #e8ecf4;
  --text-secondary: #94a3b8;
  --text-tertiary: #64748b;
  --text-inverse: #0f172a;

  --accent-primary: #60a5fa;
  --accent-primary-hover: #7cb8ff;
  --accent-secondary: #a78bfa;
  --accent-warning: #fbbf24;
  --accent-success: #34d399;
  --accent-error: #f87171;

  --border-primary: #2a3548;
  --border-secondary: #1e293b;

  --star-glow: rgba(255, 240, 200, 0.8);
  --magnitude-bright: #fffbe6;
  --magnitude-dim: #4a4a6a;
}

/* ===== LIGHT THEME ===== */
[data-theme="light"] {
  --bg-primary: #f0f4ff;
  --bg-secondary: #e8edf5;
  --bg-tertiary: #dde3ef;
  --bg-surface: #ffffff;
  --bg-surface-hover: #f5f7fa;
  --bg-canvas: #c8d0e0;

  --text-primary: #1a1a2e;
  --text-secondary: #4a5568;
  --text-tertiary: #718096;
  --text-inverse: #f7fafc;

  --accent-primary: #2563eb;
  --accent-primary-hover: #1d4ed8;
  --accent-secondary: #7c3aed;
  --accent-warning: #d97706;
  --accent-success: #059669;
  --accent-error: #dc2626;

  --border-primary: #cbd5e1;
  --border-secondary: #e2e8f0;

  --star-glow: rgba(255, 200, 50, 0.9);
  --magnitude-bright: #fff3c4;
  --magnitude-dim: #a0a0b8;
}

/* ===== HIGH CONTRAST ===== */
@media (prefers-contrast: high) {
  [data-theme="dark"] {
    --text-primary: #ffffff;
    --text-secondary: #d0d0d0;
    --border-primary: #5a6a80;
    --accent-primary: #80bfff;
  }
  [data-theme="light"] {
    --text-primary: #000000;
    --text-secondary: #333333;
    --border-primary: #555555;
  }
}

/* ===== REDUCED MOTION ===== */
@media (prefers-reduced-motion: reduce) {
  *, *::before, *::after {
    animation-duration: 0.01ms !important;
    animation-iteration-count: 1 !important;
    transition-duration: 0.01ms !important;
  }
}

/* ===== BASE STYLES ===== */
html {
  font-size: 16px;
  scroll-behavior: smooth;
  -webkit-text-size-adjust: 100%;
}

body {
  font-family: var(--font-family);
  font-size: var(--font-size-base);
  color: var(--text-primary);
  background: var(--bg-primary);
  line-height: 1.6;
  min-height: 100dvh;
  display: flex;
  flex-direction: column;
  overflow-x: hidden;
  transition: background-color var(--transition-slow), color var(--transition-slow);
}

/* ===== SKIP LINK ===== */
.skip-link {
  position: absolute;
  top: -100%;
  left: var(--space-4);
  padding: var(--space-2) var(--space-4);
  background: var(--accent-primary);
  color: var(--text-inverse);
  border-radius: var(--radius-md);
  font-weight: 600;
  z-index: var(--z-modal);
  text-decoration: none;
}
.skip-link:focus {
  top: var(--space-2);
  outline: 3px solid var(--accent-primary);
  outline-offset: 2px;
}

/* ===== HEADER ===== */
.app-header {
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border-primary);
  padding: var(--space-2) var(--space-4);
  display: flex;
  align-items: center;
  justify-content: space-between;
  flex-wrap: wrap;
  gap: var(--space-2);
  position: sticky;
  top: 0;
  z-index: var(--z-sticky);
}

.app-title {
  font-size: var(--font-size-md);
  font-weight: 700;
  color: var(--text-primary);
  display: flex;
  align-items: center;
  gap: var(--space-2);
}

.app-title-icon {
  font-size: 1.2em;
  display: inline-block;
}

.header-controls {
  display: flex;
  align-items: center;
  gap: var(--space-2);
}

/* ===== BUTTONS ===== */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: var(--space-2);
  padding: var(--space-2) var(--space-3);
  border: 1px solid var(--border-primary);
  border-radius: var(--radius-md);
  background: var(--bg-surface);
  color: var(--text-primary);
  font-size: var(--font-size-sm);
  font-family: inherit;
  cursor: pointer;
  min-height: 44px;
  min-width: 44px;
  transition: background var(--transition-fast), border-color var(--transition-fast), transform var(--transition-fast);
  user-select: none;
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
}
.btn:hover { background: var(--bg-surface-hover); border-color: var(--accent-primary); }
.btn:active { transform: scale(0.97); }
.btn:focus-visible { outline: 3px solid var(--accent-primary); outline-offset: 2px; }

.btn-primary {
  background: var(--accent-primary);
  color: var(--text-inverse);
  border-color: var(--accent-primary);
}
.btn-primary:hover { background: var(--accent-primary-hover); }

.btn-icon {
  padding: var(--space-2);
  border: none;
  background: transparent;
  font-size: var(--font-size-md);
}
.btn-icon:hover { background: var(--bg-surface-hover); }

/* ===== TAB NAVIGATION ===== */
.tab-nav {
  display: flex;
  background: var(--bg-secondary);
  border-bottom: 1px solid var(--border-primary);
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
  scrollbar-width: none;
}
.tab-nav::-webkit-scrollbar { display: none; }

.tab-btn {
  flex: 0 0 auto;
  padding: var(--space-2) var(--space-3);
  border: none;
  border-bottom: 2px solid transparent;
  background: transparent;
  color: var(--text-secondary);
  font-size: var(--font-size-sm);
  font-family: inherit;
  font-weight: 500;
  cursor: pointer;
  white-space: nowrap;
  min-height: 36px;
  transition: color var(--transition-fast), border-color var(--transition-fast), background var(--transition-fast);
  touch-action: manipulation;
  -webkit-tap-highlight-color: transparent;
}
.tab-btn:hover {
  color: var(--text-primary);
  background: var(--bg-tertiary);
}
.tab-btn:focus-visible {
  outline: 3px solid var(--accent-primary);
  outline-offset: -3px;
}
.tab-btn[aria-selected="true"] {
  color: var(--accent-primary);
  border-bottom-color: var(--accent-primary);
  font-weight: 600;
}

/* ===== MAIN CONTENT ===== */
.app-main {
  flex: 1;
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.tab-panel {
  display: none;
  flex: 1;
  flex-direction: column;
  overflow-y: auto;
  overflow-x: hidden;
  padding: var(--space-3) var(--space-4) var(--space-3);
}
.tab-panel[aria-hidden="false"] {
  display: flex;
}

/* ===== SECTION CARDS ===== */
.card {
  background: var(--bg-surface);
  border: 1px solid var(--border-primary);
  border-radius: var(--radius-md);
  padding: var(--space-3) var(--space-4);
  margin-bottom: var(--space-2);
}

.card-title {
  font-size: var(--font-size-base);
  font-weight: 600;
  margin-bottom: var(--space-2);
  color: var(--text-primary);
}

.card-text {
  font-size: var(--font-size-sm);
  color: var(--text-secondary);
  line-height: 1.5;
  margin-bottom: var(--space-2);
}

/* ===== CANVAS CONTAINER ===== */
.canvas-container {
  position: relative;
  width: 100%;
  border-radius: var(--radius-md);
  overflow: hidden;
  background: var(--bg-canvas);
  border: 1px solid var(--border-primary);
}
.canvas-container canvas {
  display: block;
  width: 100%;
  height: auto;
}

/* ===== SLIDER CONTROLS ===== */
.slider-group {
  display: flex;
  flex-direction: column;
  gap: var(--space-1);
  margin: var(--space-2) 0;
}

.slider-label {
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: var(--font-size-sm);
  color: var(--text-secondary);
  font-weight: 500;
}

.slider-value {
  font-family: var(--font-mono);
  font-weight: 600;
  color: var(--accent-primary);
  font-size: var(--font-size-sm);
}

input[type="range"] {
  -webkit-appearance: none;
  appearance: none;
  width: 100%;
  height: 8px;
  border-radius: var(--radius-full);
  background: var(--bg-tertiary);
  outline: none;
  cursor: pointer;
  touch-action: manipulation;
}
input[type="range"]::-webkit-slider-thumb {
  -webkit-appearance: none;
  appearance: none;
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: var(--accent-primary);
  cursor: pointer;
  border: 2px solid var(--bg-primary);
  box-shadow: var(--shadow-sm);
  transition: transform var(--transition-fast);
}
input[type="range"]::-webkit-slider-thumb:hover {
  transform: scale(1.15);
}
input[type="range"]::-moz-range-thumb {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: var(--accent-primary);
  cursor: pointer;
  border: 2px solid var(--bg-primary);
}
input[type="range"]:focus-visible {
  outline: 3px solid var(--accent-primary);
  outline-offset: 4px;
}

/* ===== INFO BADGES / CALLOUTS ===== */
.callout {
  padding: var(--space-2) var(--space-3);
  border-radius: var(--radius-sm);
  border-left: 3px solid var(--accent-primary);
  background: var(--bg-surface);
  font-size: var(--font-size-sm);
  color: var(--text-secondary);
  line-height: 1.5;
  margin: var(--space-2) 0;
}
.callout strong { color: var(--text-primary); }
.callout.callout-warning { border-left-color: var(--accent-warning); }
.callout.callout-success { border-left-color: var(--accent-success); }

/* ===== MAGNITUDE SCALE (TAB 1) ===== */
.mag-scale-container {
  position: relative;
  padding: var(--space-4) var(--space-3) var(--space-4);
  overflow-x: auto;
  -webkit-overflow-scrolling: touch;
}

.mag-scale-line {
  position: relative;
  height: 4px;
  background: linear-gradient(to right, var(--accent-warning), var(--text-tertiary));
  border-radius: var(--radius-full);
  margin: 60px 0 60px;
  min-width: 600px;
}

.mag-scale-labels {
  display: flex;
  justify-content: space-between;
  font-size: var(--font-size-xs);
  color: var(--text-tertiary);
  margin-top: var(--space-2);
}

.mag-marker {
  position: absolute;
  transform: translateX(-50%);
  cursor: pointer;
  transition: transform var(--transition-fast);
  text-align: center;
  touch-action: manipulation;
  -webkit-tap-highlight-color: transparent;
}
.mag-marker:hover, .mag-marker:focus-visible {
  transform: translateX(-50%) scale(1.1);
}
.mag-marker:focus-visible {
  outline: 3px solid var(--accent-primary);
  outline-offset: 4px;
  border-radius: var(--radius-sm);
}

.mag-marker-dot {
  width: 16px;
  height: 16px;
  border-radius: 50%;
  margin: 0 auto var(--space-1);
  position: relative;
  top: -6px;
  transition: box-shadow var(--transition-fast), transform var(--transition-fast);
}

.mag-marker-name {
  font-size: var(--font-size-xs);
  font-weight: 600;
  color: var(--text-primary);
  white-space: nowrap;
}
.mag-marker-mag {
  font-size: var(--font-size-xs);
  font-family: var(--font-mono);
  color: var(--accent-primary);
}

.mag-info-panel {
  background: var(--bg-tertiary);
  border: 1px solid var(--border-primary);
  border-radius: var(--radius-md);
  padding: var(--space-3);
  margin-top: var(--space-2);
  min-height: 80px;
  transition: opacity var(--transition-base);
}

.mag-info-title {
  font-size: var(--font-size-base);
  font-weight: 700;
  margin-bottom: var(--space-1);
}

.mag-info-detail {
  font-size: var(--font-size-sm);
  color: var(--text-secondary);
  line-height: 1.5;
}

.mag-info-stats {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
  gap: var(--space-2);
  margin-top: var(--space-2);
}

.mag-stat {
  background: var(--bg-surface);
  border-radius: var(--radius-sm);
  padding: var(--space-2);
  text-align: center;
}

.mag-stat-value {
  font-size: var(--font-size-md);
  font-weight: 700;
  font-family: var(--font-mono);
  color: var(--accent-primary);
}

.mag-stat-label {
  font-size: var(--font-size-xs);
  color: var(--text-tertiary);
  margin-top: 0;
}

/* ===== STAR FIELD (TAB 2) ===== */
.starfield-controls {
  display: flex;
  flex-wrap: wrap;
  gap: var(--space-2);
  margin-bottom: var(--space-2);
}

.star-info-tooltip {
  position: fixed;
  background: var(--bg-surface);
  border: 1px solid var(--border-primary);
  border-radius: var(--radius-md);
  padding: var(--space-2) var(--space-3);
  font-size: var(--font-size-xs);
  pointer-events: none;
  z-index: var(--z-dropdown);
  white-space: nowrap;
  box-shadow: var(--shadow-md);
  transition: opacity var(--transition-fast);
}

/* ===== COMPARISON VIEW (TAB 3) ===== */
.comparison-panels {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: var(--space-2);
}
@media (max-width: 700px) {
  .comparison-panels {
    grid-template-columns: 1fr;
  }
}

.comparison-panel-header {
  text-align: center;
  font-size: var(--font-size-xs);
  font-weight: 600;
  padding: var(--space-1) var(--space-2);
  border-radius: var(--radius-sm) var(--radius-sm) 0 0;
  background: var(--bg-tertiary);
  color: var(--accent-primary);
}

/* ===== DISTANCE DEMO (TAB 4) ===== */
.distance-readout {
  display: flex;
  flex-wrap: wrap;
  gap: var(--space-2);
  justify-content: center;
  margin: var(--space-2) 0;
}

.readout-item {
  text-align: center;
  background: var(--bg-surface);
  border-radius: var(--radius-sm);
  padding: var(--space-2) var(--space-3);
  border: 1px solid var(--border-primary);
  min-width: 130px;
}

.readout-value {
  font-size: var(--font-size-lg);
  font-weight: 700;
  font-family: var(--font-mono);
  color: var(--accent-primary);
}

.readout-label {
  font-size: var(--font-size-xs);
  color: var(--text-tertiary);
  margin-top: 0;
}

/* ===== TOAST NOTIFICATIONS ===== */
.toast-container {
  position: fixed;
  bottom: var(--space-4);
  right: var(--space-4);
  z-index: var(--z-toast);
  display: flex;
  flex-direction: column-reverse;
  gap: var(--space-2);
  pointer-events: none;
}

.toast {
  background: var(--bg-surface);
  border: 1px solid var(--border-primary);
  border-radius: var(--radius-md);
  padding: var(--space-3) var(--space-4);
  box-shadow: var(--shadow-lg);
  font-size: var(--font-size-sm);
  pointer-events: auto;
  animation: toastIn var(--transition-base) ease forwards;
  max-width: 320px;
}
.toast.toast-exit {
  animation: toastOut var(--transition-base) ease forwards;
}

@keyframes toastIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}
@keyframes toastOut {
  from { opacity: 1; transform: translateY(0); }
  to { opacity: 0; transform: translateY(10px); }
}

/* ===== SETTINGS PANEL ===== */
.settings-overlay {
  display: none;
  position: fixed;
  inset: 0;
  z-index: var(--z-overlay);
  background: rgba(0,0,0,0.4);
}
.settings-overlay.open { display: block; }

.settings-panel {
  position: fixed;
  top: 0;
  right: 0;
  bottom: 0;
  width: min(360px, 90vw);
  background: var(--bg-secondary);
  border-left: 1px solid var(--border-primary);
  z-index: var(--z-modal);
  transform: translateX(100%);
  transition: transform var(--transition-base);
  overflow-y: auto;
  padding: var(--space-5);
}
.settings-panel.open { transform: translateX(0); }

.settings-title {
  font-size: var(--font-size-lg);
  font-weight: 700;
  margin-bottom: var(--space-5);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.settings-group {
  margin-bottom: var(--space-5);
}

.settings-group-title {
  font-size: var(--font-size-sm);
  font-weight: 600;
  color: var(--text-tertiary);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin-bottom: var(--space-3);
}

.settings-row {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: var(--space-3) 0;
  border-bottom: 1px solid var(--border-secondary);
}

.settings-row-label {
  font-size: var(--font-size-sm);
  color: var(--text-primary);
}

/* Toggle switch */
.toggle {
  position: relative;
  width: 48px;
  height: 28px;
  cursor: pointer;
}
.toggle input {
  opacity: 0;
  width: 0;
  height: 0;
  position: absolute;
}
.toggle-track {
  position: absolute;
  inset: 0;
  background: var(--bg-tertiary);
  border-radius: var(--radius-full);
  transition: background var(--transition-fast);
  border: 1px solid var(--border-primary);
}
.toggle input:checked + .toggle-track {
  background: var(--accent-primary);
  border-color: var(--accent-primary);
}
.toggle-knob {
  position: absolute;
  top: 3px;
  left: 3px;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: var(--text-primary);
  transition: transform var(--transition-fast);
}
.toggle input:checked ~ .toggle-knob {
  transform: translateX(20px);
}
.toggle input:focus-visible + .toggle-track {
  outline: 3px solid var(--accent-primary);
  outline-offset: 2px;
}

/* ===== HELP PANEL ===== */
.help-overlay {
  display: none;
  position: fixed;
  inset: 0;
  z-index: var(--z-overlay);
  background: rgba(0,0,0,0.4);
}
.help-overlay.open { display: block; }

.help-panel {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(0.95);
  width: min(600px, 92vw);
  max-height: 80dvh;
  background: var(--bg-secondary);
  border: 1px solid var(--border-primary);
  border-radius: var(--radius-xl);
  z-index: var(--z-modal);
  overflow-y: auto;
  padding: var(--space-5);
  opacity: 0;
  transition: opacity var(--transition-base), transform var(--transition-base);
  pointer-events: none;
}
.help-panel.open {
  opacity: 1;
  transform: translate(-50%, -50%) scale(1);
  pointer-events: auto;
}

.help-section {
  margin-bottom: var(--space-4);
}

.help-section h3 {
  font-size: var(--font-size-md);
  font-weight: 600;
  margin-bottom: var(--space-2);
  color: var(--accent-primary);
}

.help-section p, .help-section li {
  font-size: var(--font-size-sm);
  color: var(--text-secondary);
  line-height: 1.7;
}

.help-section ul {
  list-style: none;
  padding: 0;
}

.help-section li {
  padding: var(--space-1) 0;
  padding-left: var(--space-4);
  position: relative;
}

.help-section li::before {
  content: '\2022';
  color: var(--accent-primary);
  position: absolute;
  left: var(--space-2);
}

/* ===== WELCOME OVERLAY ===== */
.welcome-overlay {
  display: none;
  position: fixed;
  inset: 0;
  z-index: var(--z-modal);
  background: rgba(0,0,0,0.6);
  justify-content: center;
  align-items: center;
}
.welcome-overlay.open { display: flex; }

.welcome-card {
  background: var(--bg-secondary);
  border: 1px solid var(--border-primary);
  border-radius: var(--radius-xl);
  padding: var(--space-6);
  max-width: min(520px, 92vw);
  max-height: 85dvh;
  overflow-y: auto;
  text-align: center;
}

.welcome-title {
  font-size: var(--font-size-xxl);
  font-weight: 800;
  margin-bottom: var(--space-3);
  background: linear-gradient(135deg, var(--accent-warning), var(--accent-primary));
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.welcome-subtitle {
  font-size: var(--font-size-base);
  color: var(--text-secondary);
  margin-bottom: var(--space-5);
  line-height: 1.7;
}

.welcome-features {
  text-align: left;
  margin-bottom: var(--space-5);
}

.welcome-feature {
  display: flex;
  gap: var(--space-3);
  padding: var(--space-3) 0;
  align-items: flex-start;
}

.welcome-feature-icon {
  font-size: 1.4em;
  flex-shrink: 0;
  width: 32px;
  text-align: center;
}

.welcome-feature-text {
  font-size: var(--font-size-sm);
  color: var(--text-secondary);
  line-height: 1.5;
}

.welcome-feature-text strong {
  color: var(--text-primary);
}

/* ===== MODE TOGGLE (Standard / Technical) ===== */
.mode-toggle {
  display: inline-flex;
  border: 1px solid var(--border-primary);
  border-radius: var(--radius-md);
  overflow: hidden;
  font-size: var(--font-size-xs);
}
.mode-toggle-btn {
  padding: var(--space-1) var(--space-3);
  border: none;
  background: transparent;
  color: var(--text-tertiary);
  font-family: inherit;
  font-size: inherit;
  font-weight: 500;
  cursor: pointer;
  min-height: 32px;
  transition: background var(--transition-fast), color var(--transition-fast);
  -webkit-tap-highlight-color: transparent;
  touch-action: manipulation;
}
.mode-toggle-btn:hover { color: var(--text-primary); }
.mode-toggle-btn.active {
  background: var(--accent-primary);
  color: var(--text-inverse);
  font-weight: 600;
}
.mode-toggle-btn:focus-visible {
  outline: 2px solid var(--accent-primary);
  outline-offset: -2px;
}

/* Content switching: hide/show based on data-mode on <html> */
[data-mode="standard"] .tech-only { display: none !important; }
[data-mode="technical"] .std-only { display: none !important; }

/* ===== STATUS BAR ===== */
.status-bar {
  background: var(--bg-secondary);
  border-top: 1px solid var(--border-primary);
  padding: var(--space-1) var(--space-4);
  display: flex;
  justify-content: space-between;
  align-items: center;
  font-size: var(--font-size-xs);
  color: var(--text-tertiary);
  min-height: 28px;
}

/* ===== PRINT STYLES ===== */
@media print {
  .app-header, .tab-nav, .status-bar, .header-controls,
  .settings-panel, .settings-overlay, .help-panel, .help-overlay,
  .toast-container, .welcome-overlay, .skip-link { display: none !important; }
  .tab-panel { display: flex !important; }
  body { background: white; color: black; }
  .card { border: 1px solid #ccc; break-inside: avoid; }
}

/* ===== VISUALLY HIDDEN ===== */
.visually-hidden {
  position: absolute;
  width: 1px;
  height: 1px;
  padding: 0;
  margin: -1px;
  overflow: hidden;
  clip: rect(0,0,0,0);
  white-space: nowrap;
  border: 0;
}

/* ===== SAFE AREA (NOTCHED DEVICES) ===== */
@supports (padding: env(safe-area-inset-bottom)) {
  .status-bar { padding-bottom: max(var(--space-1), env(safe-area-inset-bottom)); }
  .app-header { padding-top: max(var(--space-3), env(safe-area-inset-top)); }
}
</style>
</head>

<body>

<!-- Skip to content link -->
<a class="skip-link" href="#main-content">Skip to main content</a>

<!-- ===== HEADER ===== -->
<header class="app-header" role="banner">
  <h1 class="app-title">
    <span class="app-title-icon" aria-hidden="true">&#9733;</span>
    How Bright Are Stars, Really?
  </h1>
  <div class="header-controls">
    <div class="mode-toggle" role="radiogroup" aria-label="Language mode">
      <button class="mode-toggle-btn active" id="mode-standard" role="radio" aria-checked="true">Standard</button>
      <button class="mode-toggle-btn" id="mode-technical" role="radio" aria-checked="false">Technical</button>
    </div>
    <button class="btn btn-icon" id="btn-help" aria-label="Help" title="Help (?)">?</button>
    <button class="btn btn-icon" id="btn-settings" aria-label="Settings" title="Settings">
      <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" aria-hidden="true">
        <circle cx="12" cy="12" r="3"/><path d="M12 1v2M12 21v2M4.22 4.22l1.42 1.42M18.36 18.36l1.42 1.42M1 12h2M21 12h2M4.22 19.78l1.42-1.42M18.36 5.64l1.42-1.42"/>
      </svg>
    </button>
  </div>
</header>

<!-- ===== TAB NAVIGATION ===== -->
<nav class="tab-nav" role="tablist" aria-label="Main navigation">
  <button class="tab-btn" role="tab" id="tab-scale" aria-controls="panel-scale" aria-selected="true" tabindex="0">
    <span class="std-only">Brightness Scale</span>
    <span class="tech-only">Magnitude Scale</span>
  </button>
  <button class="tab-btn" role="tab" id="tab-starfield" aria-controls="panel-starfield" aria-selected="false" tabindex="-1">
    Star Field
  </button>
  <button class="tab-btn" role="tab" id="tab-compare" aria-controls="panel-compare" aria-selected="false" tabindex="-1">
    <span class="std-only">Looks vs Reality</span>
    <span class="tech-only">Absolute vs Apparent</span>
  </button>
  <button class="tab-btn" role="tab" id="tab-distance" aria-controls="panel-distance" aria-selected="false" tabindex="-1">
    Distance &amp; Brightness
  </button>
</nav>

<!-- ===== MAIN CONTENT ===== -->
<main class="app-main" id="main-content">

  <!-- TAB 1: MAGNITUDE SCALE EXPLORER -->
  <section class="tab-panel" role="tabpanel" id="panel-scale" aria-labelledby="tab-scale" aria-hidden="false">
    <div class="card">
      <h2 class="card-title std-only">How Do We Measure Star Brightness?</h2>
      <h2 class="card-title tech-only">The Magnitude Scale</h2>

      <div class="std-only">
        <p class="card-text">
          Scientists give every star a <strong>brightness number</strong>. The surprising part?
          <strong>Smaller numbers mean brighter stars.</strong> The brightest stars actually have
          <em>negative</em> numbers, and the faintest ones you can see at night are about 6.
        </p>
        <div class="callout">
          <strong>Why is it backwards?</strong> Over 2,000 years ago, a Greek astronomer named
          <strong>Hipparchus</strong> grouped stars by brightness. He called the brightest ones
          &ldquo;first class&rdquo; and the faintest &ldquo;sixth class.&rdquo; We still use his
          numbering today &mdash; so brighter stars get <em>lower</em> numbers. When telescopes later
          found even brighter stars, the scale went into negative numbers.
        </div>
      </div>

      <div class="tech-only">
        <p class="card-text">
          Astronomers measure star brightness using a <strong>magnitude scale</strong>. Here's the key surprise:
          <strong>lower numbers mean brighter stars</strong>. The brightest stars have negative magnitudes, while
          the faintest stars you can see with your naked eye are around magnitude 6.
        </p>
        <div class="callout">
          <strong>Why is the scale &ldquo;backwards&rdquo;?</strong> Around 150 BC, the Greek astronomer
          <strong>Hipparchus</strong> catalogued about 850 stars and sorted them into six groups. He called the
          brightest stars &ldquo;first magnitude&rdquo; (the stars of the first rank) and the faintest stars
          he could see &ldquo;sixth magnitude.&rdquo; When modern astronomers made the system precise in the 1850s,
          they kept Hipparchus's numbering &mdash; so brighter still means a <em>lower</em> number.
          Once telescopes revealed stars brighter than the old &ldquo;first magnitude,&rdquo; the scale extended
          into negative numbers. Each step of 1 magnitude is about 2.5 times brighter or dimmer.
        </div>
      </div>
    </div>

    <div class="card">
      <h2 class="card-title">Explore Famous Objects</h2>
      <p class="card-text">Click or tap any object on the scale below to learn more about it.</p>
      <div class="mag-scale-container" id="mag-scale">
        <div class="mag-scale-line" id="mag-scale-line">
          <!-- Markers injected by JS -->
        </div>
        <div class="mag-scale-labels">
          <span>Brighter &larr;</span>
          <span>&rarr; Dimmer</span>
        </div>
      </div>
      <div class="mag-info-panel" id="mag-info-panel" aria-live="polite" aria-atomic="true">
        <p class="mag-info-detail" style="text-align:center; padding-top:var(--space-4); color:var(--text-tertiary);">
          Click a star or object above to see its details.
        </p>
      </div>
    </div>

    <div class="card">
      <h2 class="card-title std-only">Two Ways to Measure Brightness</h2>
      <h2 class="card-title tech-only">Two Kinds of Magnitude</h2>

      <div class="std-only">
        <p class="card-text">
          <strong>How bright it looks</strong> (apparent brightness) &mdash; This is how bright a star appears to
          us here on Earth. It depends on how bright the star actually is <em>and</em> how far away it is.
        </p>
        <p class="card-text">
          <strong>How bright it really is</strong> (true brightness) &mdash; To compare stars fairly, scientists
          imagine lining them all up at the same distance away. The brightness a star would have at that standard
          distance tells us how powerful it really is.
        </p>
        <div class="callout callout-warning">
          <strong>A good example:</strong> Our Sun looks incredibly bright because it's so close. But if you
          moved it far away, it would actually be a pretty average star. Many stars that look faint are
          actually far more powerful &mdash; they're just very far away.
        </div>
      </div>

      <div class="tech-only">
        <p class="card-text">
          <strong>Apparent magnitude</strong> is how bright a star looks from Earth. It depends on both the star's
          actual brightness <em>and</em> how far away it is.
        </p>
        <p class="card-text">
          <strong>Absolute magnitude</strong> is how bright a star <em>really</em> is. To compare stars fairly,
          astronomers imagine placing every star at the same distance &mdash; 10 parsecs (about 32.6 light-years).
          The brightness it would have at that standard distance is its absolute magnitude.
        </p>
        <div class="callout callout-warning">
          <strong>Why does this matter?</strong> Our Sun looks like the brightest thing in the sky (apparent magnitude -26.7),
          but it's actually a pretty average star. Many stars that look faint are actually far more luminous &mdash;
          they're just very far away.
        </div>
      </div>
    </div>
  </section>

  <!-- TAB 2: STAR FIELD -->
  <section class="tab-panel" role="tabpanel" id="panel-starfield" aria-labelledby="tab-starfield" aria-hidden="true">
    <div class="card">
      <h2 class="card-title">Night Sky Simulation</h2>

      <div class="std-only">
        <p class="card-text">
          This simulated night sky shows real stars. Brighter stars appear larger and more vivid.
          Hover over (or tap) a star to see its name and how bright it is.
        </p>
        <div class="callout">
          <strong>Try this:</strong> Drag the filter slider to hide the faint stars. Notice how city
          lights block out faint stars in the same way &mdash; only the brightest ones survive!
        </div>
      </div>

      <div class="tech-only">
        <p class="card-text">
          This simulated night sky shows real stars with their actual apparent magnitudes. Brighter stars appear
          larger and more vivid. Hover over (or tap) a star to see its name and magnitude.
        </p>
        <div class="callout">
          <strong>Try this:</strong> Use the brightness filter slider to hide dim stars and see only the brightest ones,
          just like light pollution does in a city.
        </div>
      </div>
    </div>

    <div class="card">
      <div class="starfield-controls">
        <div class="slider-group" style="flex:1; min-width:200px;">
          <label class="slider-label" for="starfield-mag-filter">
            <span class="std-only">Brightness filter:</span>
            <span class="tech-only">Show stars brighter than magnitude:</span>
            <span class="slider-value" id="starfield-mag-value">6.0</span>
          </label>
          <input type="range" id="starfield-mag-filter" min="-2.0" max="6.5" step="0.1" value="6.0"
            aria-describedby="starfield-mag-desc">
          <span id="starfield-mag-desc" class="visually-hidden">Filters stars by apparent magnitude. Lower values show only brighter stars.</span>
        </div>
        <div class="slider-group" style="flex:1; min-width:200px;">
          <label class="slider-label" for="starfield-label-toggle">
            <span>Show star labels</span>
          </label>
          <label class="toggle">
            <input type="checkbox" id="starfield-label-toggle" checked>
            <span class="toggle-track"></span>
            <span class="toggle-knob"></span>
          </label>
        </div>
      </div>
      <div class="canvas-container">
        <canvas id="starfield-canvas" aria-label="Interactive star field showing stars at their apparent magnitudes"></canvas>
      </div>
      <div id="star-tooltip" class="star-info-tooltip" style="opacity:0;" role="tooltip"></div>
      <!-- Screen reader accessible star data -->
      <div class="visually-hidden" id="starfield-sr-data" aria-label="Star data table">
        <p>Stars visible in the star field simulation, sorted by brightness:</p>
        <ul id="starfield-sr-list"></ul>
      </div>
    </div>
  </section>

  <!-- TAB 3: ABSOLUTE vs APPARENT -->
  <section class="tab-panel" role="tabpanel" id="panel-compare" aria-labelledby="tab-compare" aria-hidden="true">
    <div class="card">
      <h2 class="card-title std-only">How Bright They Look vs How Bright They Are</h2>
      <h2 class="card-title tech-only">Absolute vs Apparent Magnitude</h2>

      <div class="std-only">
        <p class="card-text">
          The left side shows stars ranked by how bright they <em>look from Earth</em>.
          The right side shows how they'd rank if we placed them all at the same distance.
          Watch how the order changes!
        </p>
        <div class="callout">
          <strong>Look for the surprise:</strong> Some stars that look faint are actually
          incredibly powerful &mdash; they're just very far away!
        </div>
      </div>

      <div class="tech-only">
        <p class="card-text">
          The left panel shows stars as they appear from Earth (apparent magnitude). The right panel shows how bright
          they would all look if placed at the same distance of 10 parsecs. Notice how the rankings change!
        </p>
        <div class="callout">
          <strong>Look for the surprise:</strong> Some stars that look dim from Earth are actually among the
          most luminous in the galaxy. Distance is deceiving!
        </div>
      </div>
    </div>

    <div class="card">
      <p class="card-text" style="margin-bottom:var(--space-2);">
        <strong>Click a star</strong> in the left panel to highlight it and compare. Click the background to deselect.
      </p>

      <div class="comparison-panels">
        <div>
          <div class="comparison-panel-header">
            <span class="std-only">How Bright They Look (from Earth)</span>
            <span class="tech-only">Apparent Magnitude (from Earth)</span>
          </div>
          <div class="canvas-container">
            <canvas id="compare-apparent-canvas" aria-label="Stars shown at their apparent magnitude as seen from Earth"></canvas>
          </div>
        </div>
        <div>
          <div class="comparison-panel-header">
            <span class="std-only">How Bright They Really Are (same distance)</span>
            <span class="tech-only">Absolute Magnitude (at 10 parsecs)</span>
          </div>
          <div class="canvas-container">
            <canvas id="compare-absolute-canvas" aria-label="Stars shown at their absolute magnitude, as if all at the same distance"></canvas>
          </div>
        </div>
      </div>

      <div id="compare-info" class="mag-info-panel" aria-live="polite" aria-atomic="true" style="margin-top:var(--space-2);">
        <p class="mag-info-detail" style="text-align:center; color:var(--text-tertiary);">
          Click a star in the left panel to compare.
        </p>
      </div>
    </div>
  </section>

  <!-- TAB 4: DISTANCE & BRIGHTNESS -->
  <section class="tab-panel" role="tabpanel" id="panel-distance" aria-labelledby="tab-distance" aria-hidden="true">
    <div class="card">
      <h2 class="card-title std-only">Does Distance Change How Bright a Star Looks?</h2>
      <h2 class="card-title tech-only">How Distance Affects Brightness</h2>

      <div class="std-only">
        <p class="card-text">
          Move a star closer or further away and watch it get brighter or dimmer.
          The star itself doesn't change &mdash; only how far away it is.
        </p>
        <div class="callout">
          <strong>Think about it:</strong> If you move twice as far from a light, it looks 4 times dimmer.
          Three times as far? 9 times dimmer. That's why even super-powerful stars can look faint
          if they're really far away.
        </div>
      </div>

      <div class="tech-only">
        <p class="card-text">
          A star's apparent brightness decreases with the square of the distance. Move a star closer or further away
          and watch how its apparent magnitude changes in real time, while its absolute magnitude stays constant.
        </p>
        <div class="callout">
          <strong>The inverse square law:</strong> If you double the distance to a star, it appears 4 times dimmer.
          Triple the distance, and it's 9 times dimmer. This is why even extremely luminous stars can look faint.
        </div>
      </div>
    </div>

    <div class="card">
      <div class="slider-group">
        <label class="slider-label" for="distance-star-picker">
          <span>Choose a star:</span>
        </label>
        <select id="distance-star-picker" class="btn" style="width:100%;max-width:300px;text-align:left;">
        </select>
      </div>

      <div class="distance-readout" id="distance-readout">
        <div class="readout-item">
          <div class="readout-value" id="dist-abs-mag">--</div>
          <div class="readout-label">
            <span class="std-only">True Brightness</span>
            <span class="tech-only">Absolute Magnitude</span>
          </div>
        </div>
        <div class="readout-item">
          <div class="readout-value" id="dist-app-mag">--</div>
          <div class="readout-label">
            <span class="std-only">How Bright It Looks</span>
            <span class="tech-only">Apparent Magnitude</span>
          </div>
        </div>
        <div class="readout-item">
          <div class="readout-value" id="dist-distance">--</div>
          <div class="readout-label">
            <span class="std-only">Distance</span>
            <span class="tech-only">Distance (parsecs)</span>
          </div>
        </div>
      </div>

      <div class="canvas-container">
        <canvas id="distance-canvas" aria-label="Interactive demonstration showing how a star dims as distance increases"></canvas>
      </div>

      <div class="slider-group" style="margin-top:var(--space-2);">
        <label class="slider-label" for="distance-slider">
          <span>Distance from Earth</span>
          <span class="slider-value" id="distance-slider-value">10 pc</span>
        </label>
        <input type="range" id="distance-slider" min="1" max="1000" step="1" value="10"
          aria-describedby="distance-slider-desc">
        <span id="distance-slider-desc" class="visually-hidden">Adjust the distance to the star in parsecs and see how apparent magnitude changes.</span>
        <div class="mag-scale-labels">
          <span class="std-only">Close</span>
          <span class="tech-only">1 parsec (close)</span>
          <span class="std-only">Far away</span>
          <span class="tech-only">1000 parsecs (far)</span>
        </div>
      </div>

      <div class="callout callout-success" id="distance-explanation" aria-live="polite">
        Choose a star and drag the distance slider to explore.
      </div>
    </div>
  </section>

</main>

<!-- ===== STATUS BAR ===== -->
<footer class="status-bar" role="contentinfo">
  <span id="status-message">Ready</span>
  <span>v1.0.0</span>
</footer>

<!-- ===== TOAST CONTAINER ===== -->
<div class="toast-container" id="toast-container" aria-live="polite" aria-relevant="additions"></div>

<!-- ===== SETTINGS PANEL ===== -->
<div class="settings-overlay" id="settings-overlay" aria-hidden="true"></div>
<aside class="settings-panel" id="settings-panel" role="dialog" aria-label="Settings" aria-hidden="true">
  <div class="settings-title">
    <span>Settings</span>
    <button class="btn btn-icon" id="btn-close-settings" aria-label="Close settings">&times;</button>
  </div>
  <div class="settings-group">
    <div class="settings-group-title">Appearance</div>
    <div class="settings-row">
      <span class="settings-row-label">Dark mode</span>
      <label class="toggle">
        <input type="checkbox" id="setting-dark-mode" checked>
        <span class="toggle-track"></span>
        <span class="toggle-knob"></span>
      </label>
    </div>
    <div class="settings-row">
      <span class="settings-row-label">Show star labels by default</span>
      <label class="toggle">
        <input type="checkbox" id="setting-labels" checked>
        <span class="toggle-track"></span>
        <span class="toggle-knob"></span>
      </label>
    </div>
  </div>
  <div class="settings-group">
    <div class="settings-group-title">Data</div>
    <div class="settings-row">
      <button class="btn" id="btn-reset-settings" style="width:100%;">Reset all settings to defaults</button>
    </div>
  </div>
</aside>

<!-- ===== HELP PANEL ===== -->
<div class="help-overlay" id="help-overlay" aria-hidden="true"></div>
<div class="help-panel" id="help-panel" role="dialog" aria-label="Help" aria-hidden="true">
  <div class="settings-title">
    <span>Help</span>
    <button class="btn btn-icon" id="btn-close-help" aria-label="Close help">&times;</button>
  </div>
  <div class="help-section">
    <h3>What is this?</h3>
    <p>An interactive tool to help you understand how astronomers measure the brightness of stars using the magnitude scale.</p>
  </div>
  <div class="help-section">
    <h3>Key Concepts</h3>
    <ul>
      <li><strong>Apparent magnitude:</strong> How bright a star looks from Earth.</li>
      <li><strong>Absolute magnitude:</strong> How bright a star really is (measured at a standard distance of 10 parsecs).</li>
      <li><strong>Lower magnitude = brighter.</strong> Negative magnitudes are very bright.</li>
      <li><strong>Each magnitude step</strong> is about 2.512 times brighter or dimmer.</li>
    </ul>
  </div>
  <div class="help-section">
    <h3>Tabs</h3>
    <ul>
      <li><strong>Magnitude Scale:</strong> Interactive number line with famous stars and objects.</li>
      <li><strong>Star Field:</strong> A simulated night sky showing stars at their apparent brightness.</li>
      <li><strong>Absolute vs Apparent:</strong> Side-by-side comparison of how stars rank differently.</li>
      <li><strong>Distance &amp; Brightness:</strong> Drag a star closer or further and see brightness change.</li>
    </ul>
  </div>
  <div class="help-section">
    <h3>Keyboard Shortcuts</h3>
    <ul>
      <li><strong>1&ndash;4:</strong> Switch tabs</li>
      <li><strong>?:</strong> Toggle this help panel</li>
      <li><strong>Esc:</strong> Close any open panel</li>
      <li><strong>Left/Right arrows:</strong> Navigate between tabs</li>
    </ul>
  </div>
</div>

<!-- ===== WELCOME OVERLAY ===== -->
<div class="welcome-overlay" id="welcome-overlay" aria-hidden="true">
  <div class="welcome-card" role="dialog" aria-label="Welcome">
    <div class="welcome-title">How Bright Are Stars, Really?</div>
    <p class="welcome-subtitle">
      Explore the difference between how bright stars <em>look</em> and how bright they <em>actually are</em>
      through interactive simulations.
    </p>
    <div class="welcome-features">
      <div class="welcome-feature">
        <span class="welcome-feature-icon" aria-hidden="true">&#x1F31F;</span>
        <span class="welcome-feature-text"><strong>Magnitude Scale</strong> &mdash; See where famous stars fall on the brightness scale</span>
      </div>
      <div class="welcome-feature">
        <span class="welcome-feature-icon" aria-hidden="true">&#x1F303;</span>
        <span class="welcome-feature-text"><strong>Star Field</strong> &mdash; A simulated night sky with real star data</span>
      </div>
      <div class="welcome-feature">
        <span class="welcome-feature-icon" aria-hidden="true">&#x2696;</span>
        <span class="welcome-feature-text"><strong>Compare</strong> &mdash; See how apparent and absolute magnitude differ</span>
      </div>
      <div class="welcome-feature">
        <span class="welcome-feature-icon" aria-hidden="true">&#x1F4CF;</span>
        <span class="welcome-feature-text"><strong>Distance Demo</strong> &mdash; Drag a star and watch brightness change</span>
      </div>
    </div>
    <button class="btn btn-primary" id="btn-welcome-start" style="font-size:var(--font-size-md); padding:var(--space-3) var(--space-6);">
      Let's Explore
    </button>
  </div>
</div>

<!-- visually-hidden is defined in main style block -->

<!-- ===== JAVASCRIPT ===== -->
<script>
'use strict';

// ============================================================
//  STAR DATA
// ============================================================
const STARS = [
  // name, apparent mag, absolute mag, distance (pc), color, spectral type, notes
  { name: 'Sun',        appMag: -26.74, absMag: 4.83,   dist: 0.000005, color: '#fff8e1', spectral: 'G2V',   notes: 'Our star. Appears incredibly bright because it is extremely close.' },
  { name: 'Sirius',     appMag: -1.46,  absMag: 1.42,   dist: 2.64,     color: '#cad8ff', spectral: 'A1V',   notes: 'The brightest star in the night sky. A hot, white star relatively close to us.' },
  { name: 'Canopus',    appMag: -0.74,  absMag: -5.71,  dist: 95,       color: '#fff4e8', spectral: 'F0Ib',  notes: 'Second brightest in the night sky. An extremely luminous supergiant far away.' },
  { name: 'Arcturus',   appMag: -0.05,  absMag: -0.31,  dist: 11.26,    color: '#ffcc6f', spectral: 'K1.5III', notes: 'A red giant star, the brightest in the northern celestial hemisphere.' },
  { name: 'Vega',       appMag: 0.03,   absMag: 0.58,   dist: 7.68,     color: '#d0e0ff', spectral: 'A0V',   notes: 'A brilliant blue-white star. Historically defined as magnitude zero.' },
  { name: 'Capella',    appMag: 0.08,   absMag: -0.48,  dist: 13.12,    color: '#fff2cc', spectral: 'G5IIIe', notes: 'Actually a system of four stars appearing as one bright point.' },
  { name: 'Rigel',      appMag: 0.13,   absMag: -7.84,  dist: 264.6,    color: '#b4cfff', spectral: 'B8Ia',  notes: 'A blue supergiant in Orion. One of the most luminous stars known, but very far away.' },
  { name: 'Betelgeuse', appMag: 0.42,   absMag: -6.02,  dist: 168.1,    color: '#ffad73', spectral: 'M1Iab', notes: 'A red supergiant in Orion. Enormous and luminous, it may go supernova within 100,000 years.' },
  { name: 'Altair',     appMag: 0.76,   absMag: 2.21,   dist: 5.13,     color: '#e0eaff', spectral: 'A7V',   notes: 'A fast-spinning white star, one of the closest bright stars to Earth.' },
  { name: 'Aldebaran',  appMag: 0.86,   absMag: -0.63,  dist: 20.43,    color: '#ff9944', spectral: 'K5III', notes: 'An orange giant that marks the eye of Taurus the Bull.' },
  { name: 'Spica',      appMag: 0.97,   absMag: -3.55,  dist: 77,       color: '#aac8ff', spectral: 'B1III', notes: 'A hot blue giant binary system in Virgo.' },
  { name: 'Antares',    appMag: 1.06,   absMag: -5.28,  dist: 170,      color: '#ff6644', spectral: 'M1Ib',  notes: 'A red supergiant, the heart of Scorpius. If placed at the Sun, it would engulf Mars.' },
  { name: 'Pollux',     appMag: 1.14,   absMag: 1.09,   dist: 10.34,    color: '#ffd699', spectral: 'K0III', notes: 'An orange giant and the brighter twin in Gemini. It has a confirmed exoplanet.' },
  { name: 'Deneb',      appMag: 1.25,   absMag: -8.38,  dist: 802,      color: '#d6e5ff', spectral: 'A2Ia',  notes: 'One of the most luminous stars you can see. It looks only moderately bright because it is about 2,600 light-years away.' },
  { name: 'Polaris',    appMag: 1.98,   absMag: -3.64,  dist: 133,      color: '#fff5cc', spectral: 'F7Ib',  notes: 'The current North Star. A supergiant and a Cepheid variable star, much more luminous than it appears.' },
  { name: 'Full Moon',  appMag: -12.74, absMag: null,   dist: null,     color: '#ffffee', spectral: null,    notes: 'Not a star, but included for scale. The full Moon is very bright but only reflects sunlight.' },
];

// Magnitude scale items for Tab 1
const SCALE_OBJECTS = [
  { name: 'Sun',        mag: -26.74, type: 'apparent', color: '#fff8e1', desc: 'Apparent magnitude of the Sun as seen from Earth.' },
  { name: 'Full Moon',  mag: -12.74, type: 'apparent', color: '#ffffdd', desc: 'The full Moon reflects sunlight and appears very bright.' },
  { name: 'Venus (max)',mag: -4.6,   type: 'apparent', color: '#fffce0', desc: 'Venus at its brightest, the brightest planet.' },
  { name: 'Sirius',     mag: -1.46,  type: 'apparent', color: '#cad8ff', desc: 'The brightest star in the night sky.' },
  { name: 'Vega',       mag: 0.03,   type: 'apparent', color: '#d0e0ff', desc: 'Historically defined as magnitude 0.' },
  { name: 'Polaris',    mag: 1.98,   type: 'apparent', color: '#fff5cc', desc: 'The North Star. Not actually very bright, but easy to find.' },
  { name: 'Naked eye limit', mag: 6.0, type: 'apparent', color: '#888899', desc: 'The faintest stars you can see without a telescope, from a dark location.' },
  { name: 'Binocular limit', mag: 10.0,type: 'apparent', color: '#555566', desc: 'Typical limit for 7x50 binoculars.' },
  { name: 'Hubble limit',mag: 31.0,   type: 'apparent', color: '#333340', desc: 'The faintest objects visible to the Hubble Space Telescope.' },
];


// ============================================================
//  APP STATE
// ============================================================
const AppState = {
  activeTab: 'scale',
  theme: 'dark',
  mode: 'standard', // 'standard' or 'technical'
  showLabels: true,
  welcomeSeen: false,

  load() {
    try {
      const saved = localStorage.getItem('stars-app-state-v2');
      if (saved) {
        const data = JSON.parse(saved);
        if (data.theme) this.theme = data.theme;
        if (data.mode) this.mode = data.mode;
        if (data.showLabels !== undefined) this.showLabels = data.showLabels;
        if (data.welcomeSeen !== undefined) this.welcomeSeen = data.welcomeSeen;
        if (data.activeTab) this.activeTab = data.activeTab;
      }
    } catch (e) { /* ignore */ }
  },

  save() {
    try {
      localStorage.setItem('stars-app-state-v2', JSON.stringify({
        theme: this.theme,
        mode: this.mode,
        showLabels: this.showLabels,
        welcomeSeen: this.welcomeSeen,
        activeTab: this.activeTab
      }));
    } catch (e) { /* ignore */ }
  }
};


// ============================================================
//  UTILITIES
// ============================================================
function $(sel, ctx) { return (ctx || document).querySelector(sel); }
function $$(sel, ctx) { return [...(ctx || document).querySelectorAll(sel)]; }

function clamp(val, min, max) { return Math.max(min, Math.min(max, val)); }

// Apparent magnitude from absolute magnitude and distance in parsecs
function apparentMag(absMag, distPc) {
  if (distPc <= 0) return -Infinity;
  return absMag + 5 * Math.log10(distPc) - 5;
}

// Visual radius for rendering a star given its magnitude
function starRadius(mag, minMag, maxMag, minR, maxR) {
  const t = 1 - (mag - minMag) / (maxMag - minMag);
  return minR + (maxR - minR) * clamp(t, 0, 1);
}

// Star alpha/opacity from magnitude
function starAlpha(mag, minMag, maxMag) {
  const t = 1 - (mag - minMag) / (maxMag - minMag);
  return clamp(0.15 + 0.85 * t, 0.15, 1);
}

let _debounceTimers = {};
function debounce(key, fn, ms) {
  clearTimeout(_debounceTimers[key]);
  _debounceTimers[key] = setTimeout(fn, ms);
}


// ============================================================
//  TOAST SYSTEM
// ============================================================
const Toasts = {
  container: null,
  init() { this.container = $('#toast-container'); },
  show(msg, duration = 3500) {
    if (!this.container) return;
    const el = document.createElement('div');
    el.className = 'toast';
    el.textContent = msg;
    this.container.appendChild(el);
    // Keep max 3
    const all = $$('.toast', this.container);
    if (all.length > 3) {
      all[0].classList.add('toast-exit');
      setTimeout(() => all[0].remove(), 300);
    }
    setTimeout(() => {
      el.classList.add('toast-exit');
      setTimeout(() => el.remove(), 300);
    }, duration);
  }
};


// ============================================================
//  THEME
// ============================================================
function setTheme(theme) {
  AppState.theme = theme;
  document.documentElement.setAttribute('data-theme', theme);
  $('#setting-dark-mode').checked = (theme === 'dark');
  document.querySelector('meta[name="theme-color"]').content = theme === 'dark' ? '#0a0e1a' : '#f0f4ff';
  AppState.save();
}


// ============================================================
//  MODE (Standard / Technical)
// ============================================================
function setMode(mode) {
  AppState.mode = mode;
  document.documentElement.setAttribute('data-mode', mode);
  $('#mode-standard').classList.toggle('active', mode === 'standard');
  $('#mode-technical').classList.toggle('active', mode === 'technical');
  $('#mode-standard').setAttribute('aria-checked', mode === 'standard' ? 'true' : 'false');
  $('#mode-technical').setAttribute('aria-checked', mode === 'technical' ? 'true' : 'false');
  AppState.save();
}


// ============================================================
//  TAB SYSTEM
// ============================================================
function switchTab(tabId) {
  const tabs = $$('[role="tab"]');
  const panels = $$('[role="tabpanel"]');

  tabs.forEach(t => {
    const isActive = t.id === 'tab-' + tabId;
    t.setAttribute('aria-selected', isActive ? 'true' : 'false');
    t.tabIndex = isActive ? 0 : -1;
  });

  panels.forEach(p => {
    const isActive = p.id === 'panel-' + tabId;
    p.setAttribute('aria-hidden', isActive ? 'false' : 'true');
  });

  AppState.activeTab = tabId;
  AppState.save();

  // Trigger rendering for canvases on tab switch
  requestAnimationFrame(() => {
    if (tabId === 'starfield') initStarField();
    if (tabId === 'compare') initCompare();
    if (tabId === 'distance') initDistance();
  });
}


// ============================================================
//  TAB 1: MAGNITUDE SCALE
// ============================================================
function initMagnitudeScale() {
  const line = $('#mag-scale-line');
  if (!line) return;
  line.innerHTML = '';

  // We map the range -28 to 34 onto the line (with padding so edge labels aren't clipped)
  const scaleMin = -28;
  const scaleMax = 34;

  SCALE_OBJECTS.forEach((obj, i) => {
    const pct = ((obj.mag - scaleMin) / (scaleMax - scaleMin)) * 100;
    const isAbove = (i % 2 === 0); // alternate above/below

    const marker = document.createElement('div');
    marker.className = 'mag-marker';
    marker.style.left = pct + '%';
    marker.setAttribute('role', 'button');
    marker.setAttribute('tabindex', '0');
    marker.setAttribute('aria-label', obj.name + ', magnitude ' + obj.mag);
    marker.dataset.index = i;

    // Position above or below the line
    if (isAbove) {
      marker.style.bottom = '4px';
      marker.style.flexDirection = 'column-reverse';
    } else {
      marker.style.top = '0px';
    }

    // Size dot based on brightness
    const dotSize = clamp(18 - (obj.mag + 27) * 0.25, 6, 22);
    const brightness = clamp(1 - (obj.mag - scaleMin) / (scaleMax - scaleMin), 0.2, 1);

    // Tick line connecting to the scale line
    const tick = document.createElement('div');
    tick.style.width = '1px';
    tick.style.height = '16px';
    tick.style.background = 'var(--text-tertiary)';
    tick.style.margin = '0 auto';
    tick.style.opacity = '0.5';

    const dot = document.createElement('div');
    dot.className = 'mag-marker-dot';
    dot.style.width = dotSize + 'px';
    dot.style.height = dotSize + 'px';
    dot.style.background = obj.color;
    dot.style.boxShadow = `0 0 ${dotSize}px ${obj.color}`;
    dot.style.opacity = brightness;
    dot.style.top = '0';
    dot.style.margin = '0 auto';

    const nameEl = document.createElement('div');
    nameEl.className = 'mag-marker-name';
    nameEl.textContent = obj.name;

    const magEl = document.createElement('div');
    magEl.className = 'mag-marker-mag';
    magEl.textContent = obj.mag.toFixed(1);

    if (isAbove) {
      // Above: name, mag, dot, tick (reading top to bottom, rendered bottom-up)
      marker.appendChild(tick);
      marker.appendChild(dot);
      marker.appendChild(magEl);
      marker.appendChild(nameEl);
    } else {
      // Below: tick, dot, name, mag
      marker.appendChild(tick);
      marker.appendChild(dot);
      marker.appendChild(nameEl);
      marker.appendChild(magEl);
    }
    line.appendChild(marker);

    const showInfo = () => showScaleInfo(obj, i);
    marker.addEventListener('click', showInfo);
    marker.addEventListener('keydown', e => { if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); showInfo(); } });
  });
}

function showScaleInfo(obj, index) {
  const panel = $('#mag-info-panel');
  const brightnessRelToVega = Math.pow(2.512, 0.03 - obj.mag);

  panel.innerHTML = `
    <div class="mag-info-title" style="color:${obj.color};">${obj.name}</div>
    <p class="mag-info-detail">${obj.desc}</p>
    <div class="mag-info-stats">
      <div class="mag-stat">
        <div class="mag-stat-value">${obj.mag.toFixed(1)}</div>
        <div class="mag-stat-label">${obj.type === 'apparent' ? 'Apparent' : 'Absolute'} Magnitude</div>
      </div>
      <div class="mag-stat">
        <div class="mag-stat-value">${brightnessRelToVega >= 1000 ? brightnessRelToVega.toExponential(1) : brightnessRelToVega.toFixed(brightnessRelToVega >= 10 ? 0 : 2)}x</div>
        <div class="mag-stat-label">Brightness vs Vega</div>
      </div>
    </div>
  `;
}


// ============================================================
//  TAB 2: STAR FIELD
// ============================================================
let starfieldReady = false;
let starfieldPositions = [];

function initStarField() {
  const canvas = $('#starfield-canvas');
  if (!canvas) return;
  const container = canvas.parentElement;
  const w = container.clientWidth;
  const h = Math.max(300, Math.min(450, window.innerHeight * 0.45));
  canvas.width = w * (window.devicePixelRatio || 1);
  canvas.height = h * (window.devicePixelRatio || 1);
  canvas.style.height = h + 'px';

  // Generate positions once
  if (!starfieldReady) {
    const rng = mulberry32(42); // seeded random for consistency
    const starsForField = STARS.filter(s => s.appMag < 7 && s.name !== 'Sun' && s.name !== 'Full Moon');
    starfieldPositions = starsForField.map(star => ({
      ...star,
      x: 0.05 + rng() * 0.9,
      y: 0.05 + rng() * 0.9,
      twinklePhase: rng() * Math.PI * 2,
      twinkleSpeed: 0.5 + rng() * 2,
    }));
    // Add some background dim stars
    for (let i = 0; i < 120; i++) {
      starfieldPositions.push({
        name: null,
        appMag: 3 + rng() * 3.5,
        color: ['#ffffff','#ffe8cc','#cce0ff','#ffeedd'][Math.floor(rng() * 4)],
        x: rng(),
        y: rng(),
        twinklePhase: rng() * Math.PI * 2,
        twinkleSpeed: 0.5 + rng() * 3,
      });
    }
    starfieldReady = true;
  }

  drawStarField();
}

function drawStarField() {
  const canvas = $('#starfield-canvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const w = canvas.width;
  const h = canvas.height;
  const dpr = window.devicePixelRatio || 1;

  const magFilter = parseFloat($('#starfield-mag-filter').value);
  const showLabels = $('#starfield-label-toggle').checked;

  ctx.clearRect(0, 0, w, h);

  // Background gradient
  const grad = ctx.createRadialGradient(w/2, h/2, 0, w/2, h/2, w * 0.7);
  grad.addColorStop(0, AppState.theme === 'dark' ? '#0c1020' : '#2a3050');
  grad.addColorStop(1, AppState.theme === 'dark' ? '#050810' : '#1a2040');
  ctx.fillStyle = grad;
  ctx.fillRect(0, 0, w, h);

  starfieldPositions.forEach(star => {
    if (star.appMag > magFilter) return;

    const px = star.x * w;
    const py = star.y * h;

    const r = starRadius(star.appMag, -2, 6.5, 2 * dpr, 8 * dpr);
    const alpha = starAlpha(star.appMag, -2, 6.5);

    // Glow
    const glowR = r * 3;
    const glow = ctx.createRadialGradient(px, py, 0, px, py, glowR);
    glow.addColorStop(0, star.color + Math.round(alpha * 80).toString(16).padStart(2, '0'));
    glow.addColorStop(1, 'transparent');
    ctx.fillStyle = glow;
    ctx.beginPath();
    ctx.arc(px, py, glowR, 0, Math.PI * 2);
    ctx.fill();

    // Core
    ctx.globalAlpha = alpha;
    ctx.fillStyle = star.color;
    ctx.beginPath();
    ctx.arc(px, py, r, 0, Math.PI * 2);
    ctx.fill();
    ctx.globalAlpha = 1;

    // Label
    if (showLabels && star.name) {
      ctx.font = `${11 * dpr}px ${getComputedStyle(document.body).fontFamily}`;
      ctx.fillStyle = AppState.theme === 'dark' ? 'rgba(255,255,255,0.7)' : 'rgba(0,0,0,0.7)';
      ctx.textAlign = 'left';
      ctx.fillText(star.name + ' (' + star.appMag.toFixed(1) + ')', px + r + 4 * dpr, py + 4 * dpr);
    }
  });

}

// Star field hover/tap tooltip
function initStarFieldInteraction() {
  const canvas = $('#starfield-canvas');
  const tooltip = $('#star-tooltip');
  if (!canvas || !tooltip) return;

  function findStar(cx, cy) {
    const rect = canvas.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    const x = (cx - rect.left) / rect.width;
    const y = (cy - rect.top) / rect.height;

    let closest = null;
    let closestDist = Infinity;
    const magFilter = parseFloat($('#starfield-mag-filter').value);

    starfieldPositions.forEach(star => {
      if (!star.name || star.appMag > magFilter) return;
      const dx = star.x - x;
      const dy = star.y - y;
      const d = Math.sqrt(dx * dx + dy * dy);
      if (d < closestDist && d < 0.04) {
        closestDist = d;
        closest = star;
      }
    });
    return closest;
  }

  canvas.addEventListener('pointermove', e => {
    const star = findStar(e.clientX, e.clientY);
    if (star) {
      tooltip.innerHTML = `<strong style="color:${star.color}">${star.name}</strong><br>Apparent mag: ${star.appMag.toFixed(2)}`;
      tooltip.style.opacity = '1';
      tooltip.style.left = (e.clientX + 15) + 'px';
      tooltip.style.top = (e.clientY - 10) + 'px';
    } else {
      tooltip.style.opacity = '0';
    }
  });

  canvas.addEventListener('pointerleave', () => {
    tooltip.style.opacity = '0';
  });
}


// ============================================================
//  TAB 3: ABSOLUTE vs APPARENT COMPARISON
// ============================================================
let compareReady = false;
let compareSelected = 'all'; // 'all' or a star name
let compareSortedApp = [];   // cached sorted arrays for hit testing

function initCompare() {
  const cApparent = $('#compare-apparent-canvas');
  const cAbsolute = $('#compare-absolute-canvas');
  if (!cApparent || !cAbsolute) return;

  const starsForCompare = STARS.filter(s => s.absMag !== null && s.name !== 'Full Moon');

  // Set up click interaction on apparent (left) canvas once
  if (!compareReady) {
    cApparent.style.cursor = 'pointer';
    cApparent.addEventListener('click', e => {
      const rect = cApparent.getBoundingClientRect();
      const dpr = window.devicePixelRatio || 1;
      const clickY = (e.clientY - rect.top) * dpr;
      const h = cApparent.height;
      const rowH = h / (compareSortedApp.length + 1);

      let hitStar = null;
      compareSortedApp.forEach((star, i) => {
        const y = rowH * (i + 0.7);
        if (Math.abs(clickY - y) < rowH * 0.45) {
          hitStar = star;
        }
      });

      if (hitStar) {
        compareSelected = (compareSelected === hitStar.name) ? 'all' : hitStar.name;
      } else {
        compareSelected = 'all';
      }
      drawCompare(starsForCompare);
    });
    compareReady = true;
  }

  drawCompare(starsForCompare);
}

function drawCompare(starsForCompare) {
  if (!starsForCompare) {
    starsForCompare = STARS.filter(s => s.absMag !== null && s.name !== 'Full Moon');
  }

  const cApparent = $('#compare-apparent-canvas');
  const cAbsolute = $('#compare-absolute-canvas');
  if (!cApparent || !cAbsolute) return;

  const selected = compareSelected;
  const dpr = window.devicePixelRatio || 1;

  [cApparent, cAbsolute].forEach(canvas => {
    const container = canvas.parentElement;
    const w = container.clientWidth;
    const h = Math.max(280, Math.min(400, window.innerHeight * 0.38));
    canvas.width = w * dpr;
    canvas.height = h * dpr;
    canvas.style.height = h + 'px';
  });

  // Sort by apparent mag for left panel
  const sortedApp = [...starsForCompare].sort((a, b) => a.appMag - b.appMag);
  compareSortedApp = sortedApp; // cache for hit testing
  // Sort by absolute mag for right panel
  const sortedAbs = [...starsForCompare].sort((a, b) => a.absMag - b.absMag);

  drawComparePanel(cApparent, sortedApp, 'appMag', selected, dpr);
  drawComparePanel(cAbsolute, sortedAbs, 'absMag', selected, dpr);

  // Info panel
  if (selected !== 'all') {
    const star = starsForCompare.find(s => s.name === selected);
    if (star) {
      const rankApp = sortedApp.findIndex(s => s.name === star.name) + 1;
      const rankAbs = sortedAbs.findIndex(s => s.name === star.name) + 1;
      $('#compare-info').innerHTML = `
        <div class="mag-info-title" style="color:${star.color};">${star.name}</div>
        <p class="mag-info-detail">${star.notes}</p>
        <div class="mag-info-stats">
          <div class="mag-stat">
            <div class="mag-stat-value">${star.appMag.toFixed(2)}</div>
            <div class="mag-stat-label">Apparent Mag (rank #${rankApp})</div>
          </div>
          <div class="mag-stat">
            <div class="mag-stat-value">${star.absMag.toFixed(2)}</div>
            <div class="mag-stat-label">Absolute Mag (rank #${rankAbs})</div>
          </div>
          <div class="mag-stat">
            <div class="mag-stat-value">${star.dist.toFixed(1)} pc</div>
            <div class="mag-stat-label">Distance</div>
          </div>
        </div>
      `;
    }
  } else {
    $('#compare-info').innerHTML = `
      <p class="mag-info-detail" style="text-align:center; color:var(--text-tertiary);">
        Click a star in the left panel to compare its apparent and absolute rankings.
      </p>
    `;
  }
}

function drawComparePanel(canvas, stars, magKey, selected, dpr) {
  const ctx = canvas.getContext('2d');
  const w = canvas.width;
  const h = canvas.height;

  ctx.clearRect(0, 0, w, h);

  // Background
  ctx.fillStyle = AppState.theme === 'dark' ? '#080c16' : '#1e2640';
  ctx.fillRect(0, 0, w, h);

  const rowH = h / (stars.length + 1);
  const maxR = rowH * 0.35;
  const minR = 2 * dpr;

  const mags = stars.map(s => s[magKey]);
  const minMag = Math.min(...mags);
  const maxMag = Math.max(...mags);

  stars.forEach((star, i) => {
    const y = rowH * (i + 0.7);
    const mag = star[magKey];

    const r = starRadius(mag, minMag, maxMag, minR, maxR);
    const alpha = starAlpha(mag, minMag, maxMag);

    const isHighlighted = (selected === star.name);
    const isAll = (selected === 'all');
    const dimmed = !isAll && !isHighlighted;

    const px = w * 0.3;

    // Highlight row background
    if (isHighlighted) {
      ctx.fillStyle = AppState.theme === 'dark' ? 'rgba(96,165,250,0.08)' : 'rgba(96,165,250,0.12)';
      ctx.fillRect(0, y - rowH * 0.45, w, rowH * 0.9);
    }

    // Glow
    if (!dimmed) {
      const glow = ctx.createRadialGradient(px, y, 0, px, y, r * 3);
      glow.addColorStop(0, star.color + '60');
      glow.addColorStop(1, 'transparent');
      ctx.fillStyle = glow;
      ctx.beginPath();
      ctx.arc(px, y, r * 3, 0, Math.PI * 2);
      ctx.fill();
    }

    // Star
    ctx.globalAlpha = dimmed ? 0.2 : alpha;
    ctx.fillStyle = star.color;
    ctx.beginPath();
    ctx.arc(px, y, r, 0, Math.PI * 2);
    ctx.fill();
    ctx.globalAlpha = 1;

    // Label
    ctx.fillStyle = dimmed
      ? (AppState.theme === 'dark' ? 'rgba(255,255,255,0.2)' : 'rgba(0,0,0,0.2)')
      : (AppState.theme === 'dark' ? 'rgba(255,255,255,0.85)' : 'rgba(220,230,255,0.9)');
    ctx.font = `${(isHighlighted ? 'bold ' : '') + (11 * dpr)}px ${getComputedStyle(document.body).fontFamily}`;
    ctx.textAlign = 'left';
    ctx.textBaseline = 'middle';
    ctx.fillText(`${star.name}  (${mag.toFixed(1)})`, px + r + 8 * dpr, y);
  });
}


// ============================================================
//  TAB 4: DISTANCE & BRIGHTNESS
// ============================================================
let distanceReady = false;

function initDistance() {
  const canvas = $('#distance-canvas');
  if (!canvas) return;

  const container = canvas.parentElement;
  const w = container.clientWidth;
  const h = Math.max(180, Math.min(280, window.innerHeight * 0.25));
  const dpr = window.devicePixelRatio || 1;
  canvas.width = w * dpr;
  canvas.height = h * dpr;
  canvas.style.height = h + 'px';

  if (!distanceReady) {
    const sel = $('#distance-star-picker');
    sel.innerHTML = '';
    const starsForDist = STARS.filter(s => s.absMag !== null && s.name !== 'Full Moon' && s.name !== 'Sun');
    starsForDist.forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.name;
      opt.textContent = `${s.name} (abs: ${s.absMag.toFixed(1)})`;
      sel.appendChild(opt);
    });
    distanceReady = true;
  }

  drawDistance();
}

function drawDistance() {
  const canvas = $('#distance-canvas');
  if (!canvas) return;
  const ctx = canvas.getContext('2d');
  const w = canvas.width;
  const h = canvas.height;
  const dpr = window.devicePixelRatio || 1;

  const starName = $('#distance-star-picker').value;
  const star = STARS.find(s => s.name === starName);
  if (!star) return;

  const distPc = parseFloat($('#distance-slider').value);
  const appMag = apparentMag(star.absMag, distPc);

  // Update readouts
  $('#dist-abs-mag').textContent = star.absMag.toFixed(2);
  $('#dist-app-mag').textContent = appMag.toFixed(2);
  $('#dist-distance').textContent = distPc.toFixed(0) + ' pc';
  $('#distance-slider-value').textContent = distPc + ' pc';

  // Update explanation
  const explanation = $('#distance-explanation');
  const realAppMag = star.appMag;
  const realDist = star.dist;
  let explainText = `${star.name} has an absolute magnitude of ${star.absMag.toFixed(1)}.`;
  explainText += ` At ${distPc} parsecs, its apparent magnitude would be ${appMag.toFixed(1)}.`;
  if (realDist > 0.001) {
    explainText += ` (Its real distance is ${realDist.toFixed(1)} pc, where it appears at magnitude ${realAppMag.toFixed(1)}.)`;
  }
  explanation.textContent = explainText;

  // Draw
  ctx.clearRect(0, 0, w, h);

  // Background
  const grad = ctx.createLinearGradient(0, 0, w, 0);
  grad.addColorStop(0, AppState.theme === 'dark' ? '#0e1428' : '#1a2540');
  grad.addColorStop(1, AppState.theme === 'dark' ? '#050810' : '#0e1428');
  ctx.fillStyle = grad;
  ctx.fillRect(0, 0, w, h);

  // Distance line
  const lineY = h * 0.7;
  ctx.strokeStyle = AppState.theme === 'dark' ? 'rgba(255,255,255,0.15)' : 'rgba(255,255,255,0.15)';
  ctx.lineWidth = 1 * dpr;
  ctx.setLineDash([4 * dpr, 4 * dpr]);
  ctx.beginPath();
  ctx.moveTo(40 * dpr, lineY);
  ctx.lineTo(w - 40 * dpr, lineY);
  ctx.stroke();
  ctx.setLineDash([]);

  // Earth indicator
  const earthX = 50 * dpr;
  ctx.fillStyle = '#4488cc';
  ctx.beginPath();
  ctx.arc(earthX, lineY, 8 * dpr, 0, Math.PI * 2);
  ctx.fill();
  ctx.fillStyle = AppState.theme === 'dark' ? '#ffffff' : '#ffffff';
  ctx.font = `${11 * dpr}px ${getComputedStyle(document.body).fontFamily}`;
  ctx.textAlign = 'center';
  ctx.fillText('Earth', earthX, lineY + 22 * dpr);

  // Star position (log scale for distance)
  const maxDist = 1000;
  const logPos = Math.log10(distPc) / Math.log10(maxDist);
  const starX = earthX + (w - 100 * dpr) * clamp(logPos, 0, 1);
  const starY = h * 0.35;

  // How bright it appears: map appMag to size/glow
  const visualR = clamp(40 - appMag * 2.5, 3, 60) * dpr;
  const visualAlpha = clamp(1 - appMag / 15, 0.1, 1);

  // Glow
  const glow = ctx.createRadialGradient(starX, starY, 0, starX, starY, visualR * 4);
  glow.addColorStop(0, star.color + Math.round(visualAlpha * 120).toString(16).padStart(2, '0'));
  glow.addColorStop(0.5, star.color + '20');
  glow.addColorStop(1, 'transparent');
  ctx.fillStyle = glow;
  ctx.beginPath();
  ctx.arc(starX, starY, visualR * 4, 0, Math.PI * 2);
  ctx.fill();

  // Star core
  ctx.globalAlpha = visualAlpha;
  ctx.fillStyle = star.color;
  ctx.beginPath();
  ctx.arc(starX, starY, visualR, 0, Math.PI * 2);
  ctx.fill();
  ctx.globalAlpha = 1;

  // Star name
  ctx.fillStyle = star.color;
  ctx.font = `bold ${13 * dpr}px ${getComputedStyle(document.body).fontFamily}`;
  ctx.textAlign = 'center';
  ctx.fillText(star.name, starX, starY - visualR - 10 * dpr);

  // Connecting line
  ctx.strokeStyle = 'rgba(100,150,255,0.3)';
  ctx.lineWidth = 1 * dpr;
  ctx.setLineDash([3 * dpr, 3 * dpr]);
  ctx.beginPath();
  ctx.moveTo(earthX, lineY);
  ctx.lineTo(starX, starY);
  ctx.stroke();
  ctx.setLineDash([]);

  // Distance label on line
  ctx.fillStyle = AppState.theme === 'dark' ? 'rgba(255,255,255,0.5)' : 'rgba(255,255,255,0.5)';
  ctx.font = `${10 * dpr}px ${getComputedStyle(document.body).fontFamily}`;
  const midX = (earthX + starX) / 2;
  const midY = (lineY + starY) / 2;
  ctx.textAlign = 'center';
  ctx.fillText(distPc + ' parsecs', midX, midY + 14 * dpr);
}


// ============================================================
//  SEEDED PRNG
// ============================================================
function mulberry32(a) {
  return function() {
    a |= 0; a = a + 0x6D2B79F5 | 0;
    var t = Math.imul(a ^ a >>> 15, 1 | a);
    t = t + Math.imul(t ^ t >>> 7, 61 | t) ^ t;
    return ((t ^ t >>> 14) >>> 0) / 4294967296;
  };
}


// ============================================================
//  EVENT WIRING
// ============================================================
function initEvents() {
  // Tab clicks
  $$('[role="tab"]').forEach(tab => {
    tab.addEventListener('click', () => {
      const id = tab.id.replace('tab-', '');
      switchTab(id);
    });
  });

  // Tab keyboard nav
  const tabList = $('[role="tablist"]');
  tabList.addEventListener('keydown', e => {
    const tabs = $$('[role="tab"]');
    const idx = tabs.indexOf(document.activeElement);
    if (idx < 0) return;

    let newIdx = idx;
    if (e.key === 'ArrowRight' || e.key === 'ArrowDown') { newIdx = (idx + 1) % tabs.length; e.preventDefault(); }
    if (e.key === 'ArrowLeft' || e.key === 'ArrowUp') { newIdx = (idx - 1 + tabs.length) % tabs.length; e.preventDefault(); }
    if (e.key === 'Home') { newIdx = 0; e.preventDefault(); }
    if (e.key === 'End') { newIdx = tabs.length - 1; e.preventDefault(); }

    if (newIdx !== idx) {
      tabs[newIdx].focus();
      switchTab(tabs[newIdx].id.replace('tab-', ''));
    }
  });

  // Number keys for tabs
  document.addEventListener('keydown', e => {
    if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT' || e.target.tagName === 'TEXTAREA') return;

    // Check if a dialog/panel is open
    const dialogOpen = $('#settings-panel').classList.contains('open')
      || $('#help-panel').classList.contains('open')
      || $('#welcome-overlay').classList.contains('open');

    if (e.key === 'Escape') {
      closeAllPanels();
      return;
    }
    if (e.key === '?' || (e.key === '/' && e.shiftKey)) {
      e.preventDefault();
      toggleHelp();
      return;
    }

    // Don't switch tabs while a dialog is open
    if (dialogOpen) return;

    const tabIds = ['scale', 'starfield', 'compare', 'distance'];
    if (e.key >= '1' && e.key <= '4') {
      e.preventDefault();
      switchTab(tabIds[parseInt(e.key) - 1]);
      return;
    }
  });

  // Mode toggle (Standard / Technical)
  $('#mode-standard').addEventListener('click', () => setMode('standard'));
  $('#mode-technical').addEventListener('click', () => setMode('technical'));

  // Settings
  $('#btn-settings').addEventListener('click', toggleSettings);
  $('#btn-close-settings').addEventListener('click', toggleSettings);
  $('#settings-overlay').addEventListener('click', toggleSettings);

  // Help
  $('#btn-help').addEventListener('click', toggleHelp);
  $('#btn-close-help').addEventListener('click', toggleHelp);
  $('#help-overlay').addEventListener('click', toggleHelp);

  // Theme toggle
  $('#setting-dark-mode').addEventListener('change', e => {
    setTheme(e.target.checked ? 'dark' : 'light');
    // Redraw active canvas
    requestAnimationFrame(() => {
      if (AppState.activeTab === 'starfield') drawStarField();
      if (AppState.activeTab === 'compare') drawCompare();
      if (AppState.activeTab === 'distance') drawDistance();
    });
  });

  // Labels toggle
  $('#setting-labels').addEventListener('change', e => {
    AppState.showLabels = e.target.checked;
    $('#starfield-label-toggle').checked = e.target.checked;
    AppState.save();
    if (AppState.activeTab === 'starfield') drawStarField();
  });
  $('#starfield-label-toggle').addEventListener('change', e => {
    AppState.showLabels = e.target.checked;
    $('#setting-labels').checked = e.target.checked;
    AppState.save();
    if (AppState.activeTab === 'starfield') drawStarField();
  });

  // Reset settings
  $('#btn-reset-settings').addEventListener('click', () => {
    setTheme('dark');
    setMode('standard');
    AppState.showLabels = true;
    $('#setting-labels').checked = true;
    $('#starfield-label-toggle').checked = true;
    AppState.save();
    Toasts.show('Settings reset to defaults');
  });

  // Star field slider
  $('#starfield-mag-filter').addEventListener('input', e => {
    $('#starfield-mag-value').textContent = parseFloat(e.target.value).toFixed(1);
    drawStarField();
  });

  // Distance controls
  $('#distance-star-picker').addEventListener('change', () => {
    // Reset slider to star's real distance
    const starName = $('#distance-star-picker').value;
    const star = STARS.find(s => s.name === starName);
    if (star && star.dist > 0.01) {
      $('#distance-slider').value = clamp(Math.round(star.dist), 1, 1000);
    }
    drawDistance();
  });
  $('#distance-slider').addEventListener('input', () => drawDistance());

  // Welcome
  $('#btn-welcome-start').addEventListener('click', () => {
    $('#welcome-overlay').classList.remove('open');
    $('#welcome-overlay').setAttribute('aria-hidden', 'true');
    AppState.welcomeSeen = true;
    AppState.save();
  });

  // Resize handler
  window.addEventListener('resize', () => {
    debounce('resize', () => {
      if (AppState.activeTab === 'starfield') initStarField();
      if (AppState.activeTab === 'compare') initCompare();
      if (AppState.activeTab === 'distance') initDistance();
    }, 200);
  });

  // Save on unload
  window.addEventListener('beforeunload', () => AppState.save());
  document.addEventListener('visibilitychange', () => { if (document.hidden) AppState.save(); });
}

// Focus trap utility
function trapFocus(container) {
  const handler = e => {
    if (e.key !== 'Tab') return;
    const focusable = container.querySelectorAll('button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])');
    if (focusable.length === 0) return;
    const first = focusable[0];
    const last = focusable[focusable.length - 1];
    if (e.shiftKey) {
      if (document.activeElement === first) { e.preventDefault(); last.focus(); }
    } else {
      if (document.activeElement === last) { e.preventDefault(); first.focus(); }
    }
  };
  container.addEventListener('keydown', handler);
  container._focusTrapHandler = handler;
}

function releaseFocusTrap(container) {
  if (container._focusTrapHandler) {
    container.removeEventListener('keydown', container._focusTrapHandler);
    delete container._focusTrapHandler;
  }
}

function toggleSettings() {
  const panel = $('#settings-panel');
  const overlay = $('#settings-overlay');
  const isOpen = panel.classList.contains('open');
  panel.classList.toggle('open');
  overlay.classList.toggle('open');
  panel.setAttribute('aria-hidden', isOpen ? 'true' : 'false');
  overlay.setAttribute('aria-hidden', isOpen ? 'true' : 'false');
  if (!isOpen) {
    trapFocus(panel);
    $('#btn-close-settings').focus();
  } else {
    releaseFocusTrap(panel);
    $('#btn-settings').focus();
  }
}

function toggleHelp() {
  const panel = $('#help-panel');
  const overlay = $('#help-overlay');
  const isOpen = panel.classList.contains('open');
  panel.classList.toggle('open');
  overlay.classList.toggle('open');
  panel.setAttribute('aria-hidden', isOpen ? 'true' : 'false');
  overlay.setAttribute('aria-hidden', isOpen ? 'true' : 'false');
  if (!isOpen) {
    trapFocus(panel);
    $('#btn-close-help').focus();
  } else {
    releaseFocusTrap(panel);
    $('#btn-help').focus();
  }
}

function closeAllPanels() {
  if ($('#settings-panel').classList.contains('open')) toggleSettings();
  if ($('#help-panel').classList.contains('open')) toggleHelp();
  if ($('#welcome-overlay').classList.contains('open')) {
    $('#welcome-overlay').classList.remove('open');
    $('#welcome-overlay').setAttribute('aria-hidden', 'true');
    AppState.welcomeSeen = true;
    AppState.save();
  }
}


// ============================================================
//  EASTER EGG: Konami Code reveals a fun fact
// ============================================================
// EASTER EGG: Konami code (up up down down left right left right b a)
const konamiSequence = ['ArrowUp','ArrowUp','ArrowDown','ArrowDown','ArrowLeft','ArrowRight','ArrowLeft','ArrowRight','b','a'];
let konamiIndex = 0;
document.addEventListener('keydown', e => {
  if (e.key === konamiSequence[konamiIndex]) {
    konamiIndex++;
    if (konamiIndex === konamiSequence.length) {
      konamiIndex = 0;
      Toasts.show('If you could travel at the speed of light, it would still take over 4 years to reach the nearest star beyond the Sun!', 7000);
    }
  } else {
    konamiIndex = 0;
  }
});


// ============================================================
//  INIT
// ============================================================
function init() {
  AppState.load();
  Toasts.init();

  // Apply saved state
  setTheme(AppState.theme);
  setMode(AppState.mode);
  $('#setting-labels').checked = AppState.showLabels;
  $('#starfield-label-toggle').checked = AppState.showLabels;

  // Detect system theme preference
  if (!localStorage.getItem('stars-app-state-v2')) {
    if (window.matchMedia('(prefers-color-scheme: light)').matches) {
      setTheme('light');
    }
  }

  // Wire events
  initEvents();
  initStarFieldInteraction();

  // Populate screen reader star data
  const srList = $('#starfield-sr-list');
  if (srList) {
    STARS.filter(s => s.appMag < 7 && s.name !== 'Sun' && s.name !== 'Full Moon')
      .sort((a, b) => a.appMag - b.appMag)
      .forEach(s => {
        const li = document.createElement('li');
        li.textContent = `${s.name}: apparent magnitude ${s.appMag}, absolute magnitude ${s.absMag}`;
        srList.appendChild(li);
      });
  }

  // Init first tab
  initMagnitudeScale();
  switchTab(AppState.activeTab);

  // Show welcome on first visit
  if (!AppState.welcomeSeen) {
    $('#welcome-overlay').classList.add('open');
    $('#welcome-overlay').setAttribute('aria-hidden', 'false');
    setTimeout(() => $('#btn-welcome-start').focus(), 300);
  }

  // Status
  $('#status-message').textContent = 'Ready  explore the tabs above!';
}

// Start when DOM is ready
if (document.readyState === 'loading') {
  document.addEventListener('DOMContentLoaded', init);
} else {
  init();
}
</script>
</body>
</html>
