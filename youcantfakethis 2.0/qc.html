<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YouCantFakeThis - Content QC Tool</title>
  <style>
    :root {
      --bg: #f8fafc;
      --bg-card: #ffffff;
      --text: #1e293b;
      --text-muted: #64748b;
      --border: #e2e8f0;
      --primary: #3b82f6;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --radius: 6px;
    }

    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      padding: 20px;
    }

    .header {
      background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
      color: white;
      padding: 16px 24px;
      border-radius: var(--radius);
      margin-bottom: 20px;
    }

    .header h1 {
      font-size: 1.4rem;
      font-weight: 600;
    }

    .header p {
      font-size: 0.85rem;
      opacity: 0.9;
      margin-top: 4px;
    }

    .nav-row {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-bottom: 20px;
      align-items: flex-end;
    }

    .nav-group {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .nav-group label {
      font-size: 0.75rem;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    select {
      padding: 8px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 0.9rem;
      min-width: 180px;
      background: var(--bg-card);
    }

    select:focus {
      outline: none;
      border-color: var(--primary);
    }

    .stats-bar {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px 16px;
      margin-bottom: 20px;
      display: flex;
      gap: 24px;
      flex-wrap: wrap;
      font-size: 0.85rem;
    }

    .stat {
      display: flex;
      gap: 6px;
    }

    .stat-label {
      color: var(--text-muted);
    }

    .stat-value {
      font-weight: 600;
    }

    .stat-value.success { color: var(--success); }
    .stat-value.warning { color: var(--warning); }
    .stat-value.error { color: var(--error); }

    .content-area {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
    }

    .metadata-section {
      background: #f1f5f9;
      border-radius: var(--radius);
      padding: 12px 16px;
      margin-bottom: 20px;
      font-size: 0.85rem;
    }

    .metadata-section h3 {
      font-size: 0.9rem;
      margin-bottom: 8px;
      color: var(--primary);
    }

    .metadata-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
      gap: 8px;
    }

    .metadata-item {
      display: flex;
      gap: 6px;
    }

    .metadata-item .label {
      color: var(--text-muted);
    }

    .dot-point {
      background: #fef3c7;
      border-left: 3px solid var(--warning);
      padding: 10px 12px;
      margin-bottom: 16px;
      font-size: 0.85rem;
      border-radius: 0 var(--radius) var(--radius) 0;
    }

    .dot-point-label {
      font-size: 0.75rem;
      color: var(--warning);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 4px;
    }

    .tab-section {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin-bottom: 16px;
      overflow: hidden;
    }

    .tab-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 10px 16px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .tab-header .tab-icon {
      background: rgba(255,255,255,0.2);
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.85rem;
    }

    .round-section {
      border-bottom: 1px solid var(--border);
    }

    .round-section:last-child {
      border-bottom: none;
    }

    .round-header {
      background: #f8fafc;
      padding: 8px 16px;
      font-weight: 600;
      font-size: 0.85rem;
      color: var(--text-muted);
      border-bottom: 1px solid var(--border);
    }

    .round-content {
      padding: 16px;
    }

    .round-title {
      font-weight: 600;
      margin-bottom: 4px;
    }

    .round-instructions {
      color: var(--text-muted);
      font-size: 0.85rem;
      margin-bottom: 12px;
      font-style: italic;
    }

    .sentence-block {
      background: #fafafa;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px;
      margin-bottom: 12px;
    }

    .sentence-text {
      margin-bottom: 12px;
      line-height: 1.7;
    }

    .cloze-marker {
      background: #dbeafe;
      border: 1px solid #93c5fd;
      padding: 2px 6px;
      border-radius: 4px;
      font-family: monospace;
      font-size: 0.85rem;
      color: var(--primary);
    }

    .questions-grid {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    .question-item {
      background: white;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 10px 12px;
      font-size: 0.85rem;
    }

    .question-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .question-id {
      font-family: monospace;
      background: var(--primary);
      color: white;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.75rem;
    }

    .question-concept {
      font-size: 0.75rem;
      color: var(--text-muted);
      background: #f1f5f9;
      padding: 2px 8px;
      border-radius: 4px;
    }

    .answer-row {
      display: flex;
      gap: 8px;
      align-items: flex-start;
      margin-bottom: 6px;
    }

    .answer-label {
      font-size: 0.75rem;
      color: var(--text-muted);
      min-width: 70px;
      padding-top: 2px;
    }

    .correct-answer {
      color: var(--success);
      font-weight: 600;
    }

    .distractor {
      color: var(--error);
    }

    .distractors-list {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .distractor-chip {
      background: #fef2f2;
      border: 1px solid #fecaca;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.8rem;
      color: var(--error);
    }

    .tooltip-text {
      color: var(--text-muted);
      font-style: italic;
      font-size: 0.8rem;
    }

    .concept-section {
      margin-top: 24px;
      border-top: 2px solid var(--border);
      padding-top: 20px;
    }

    .concept-section h3 {
      font-size: 1rem;
      margin-bottom: 16px;
      color: var(--primary);
    }

    .concept-item {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin-bottom: 12px;
      overflow: hidden;
    }

    .concept-header {
      background: #f1f5f9;
      padding: 10px 12px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
      align-items: center;
      cursor: pointer;
    }

    .concept-header:hover {
      background: #e2e8f0;
    }

    .concept-formula {
      font-family: monospace;
      background: white;
      padding: 2px 8px;
      border-radius: 4px;
      font-size: 0.85rem;
      font-weight: normal;
    }

    .concept-content {
      padding: 12px;
      font-size: 0.85rem;
      display: none;
    }

    .concept-item.open .concept-content {
      display: block;
    }

    .concept-correct {
      background: #ecfdf5;
      border-left: 3px solid var(--success);
      padding: 8px 12px;
      margin-bottom: 10px;
      border-radius: 0 var(--radius) var(--radius) 0;
    }

    .wrong-answer-item {
      background: #fef2f2;
      border-left: 3px solid var(--error);
      padding: 8px 12px;
      margin-bottom: 8px;
      border-radius: 0 var(--radius) var(--radius) 0;
    }

    .wrong-answer-item .wrong-key {
      font-weight: 600;
      color: var(--error);
      margin-bottom: 4px;
    }

    .wrong-answer-item .wrong-detail {
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    .wrong-answer-item .wrong-detail span {
      display: block;
      margin-top: 2px;
    }

    .persistent-section {
      background: #fffbeb;
      border-left: 3px solid var(--warning);
      padding: 8px 12px;
      margin-top: 10px;
      border-radius: 0 var(--radius) var(--radius) 0;
    }

    .persistent-section .persistent-label {
      font-weight: 600;
      color: var(--warning);
      font-size: 0.75rem;
      text-transform: uppercase;
      margin-bottom: 4px;
    }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
    }

    .error-msg {
      background: #fef2f2;
      border: 1px solid #fecaca;
      color: var(--error);
      padding: 12px 16px;
      border-radius: var(--radius);
      margin-bottom: 16px;
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }

    .empty-state h3 {
      margin-bottom: 8px;
      color: var(--text);
    }

    .toggle-icon {
      font-size: 0.8rem;
      transition: transform 0.2s;
    }

    .concept-item.open .toggle-icon {
      transform: rotate(90deg);
    }

    .validation-issues {
      background: #fef2f2;
      border: 1px solid #fecaca;
      border-radius: var(--radius);
      padding: 12px 16px;
      margin-bottom: 16px;
    }

    .validation-issues h4 {
      color: var(--error);
      margin-bottom: 8px;
      font-size: 0.9rem;
    }

    .validation-issues ul {
      margin-left: 20px;
      font-size: 0.85rem;
    }

    .validation-issues li {
      margin-bottom: 4px;
    }
  </style>
</head>
<body>
  <div class="header">
    <h1>üìã Content QC Tool</h1>
    <p>Review and validate topic JSON content</p>
  </div>

  <div class="nav-row">
    <div class="nav-group">
      <label>Curriculum</label>
      <select id="stateSelect" onchange="selectState(this.value)">
        <option value="">Select curriculum...</option>
      </select>
    </div>
    <div class="nav-group">
      <label>Subject</label>
      <select id="subjectSelect" onchange="selectSubject(this.value)" disabled>
        <option value="">Select subject...</option>
      </select>
    </div>
    <div class="nav-group">
      <label>Unit</label>
      <select id="unitSelect" onchange="selectUnit(this.value)" disabled>
        <option value="">Select unit...</option>
      </select>
    </div>
    <div class="nav-group">
      <label>Area of Study</label>
      <select id="aosSelect" onchange="selectAOS(this.value)" disabled>
        <option value="">Select AOS...</option>
      </select>
    </div>
    <div class="nav-group">
      <label>Topic</label>
      <select id="topicSelect" onchange="selectTopic(this.value)" disabled>
        <option value="">Select topic...</option>
      </select>
    </div>
  </div>

  <div id="statsBar" class="stats-bar" style="display:none;">
    <div class="stat">
      <span class="stat-label">Tabs:</span>
      <span class="stat-value" id="statTabs">-</span>
    </div>
    <div class="stat">
      <span class="stat-label">Questions:</span>
      <span class="stat-value" id="statQuestions">-</span>
    </div>
    <div class="stat">
      <span class="stat-label">Concepts:</span>
      <span class="stat-value" id="statConcepts">-</span>
    </div>
    <div class="stat">
      <span class="stat-label">Validation:</span>
      <span class="stat-value" id="statValidation">-</span>
    </div>
  </div>

  <div id="validationIssues"></div>

  <div class="content-area" id="contentArea">
    <div class="empty-state">
      <h3>Select a topic to review</h3>
      <p>Use the dropdowns above to navigate to a topic JSON file</p>
    </div>
  </div>

  <script>
    const APP = {
      basePath: './',
      states: null,
      studyManifest: null,
      topicManifest: null,
      topicData: null,
      currentState: null,
      currentSubject: null,
      currentUnit: null,
      currentAOS: null
    };

    async function fetchJSON(path) {
      try {
        const response = await fetch(APP.basePath + path);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return await response.json();
      } catch (e) {
        console.error('Fetch error:', path, e);
        return null;
      }
    }

    async function init() {
      APP.states = await fetchJSON('states.json');
      if (!APP.states) {
        document.getElementById('contentArea').innerHTML = `
          <div class="error-msg">Failed to load states.json. Make sure the file exists.</div>
        `;
        return;
      }

      const stateSelect = document.getElementById('stateSelect');
      APP.states.states.forEach(state => {
        const opt = document.createElement('option');
        opt.value = state.id;
        opt.textContent = `${state.icon} ${state.name} - ${state.region}`;
        stateSelect.appendChild(opt);
      });
    }

    async function selectState(stateId) {
      if (!stateId) return;
      APP.currentState = stateId;

      const state = APP.states.states.find(s => s.id === stateId);
      APP.studyManifest = await fetchJSON(state.path);

      const subjectSelect = document.getElementById('subjectSelect');
      subjectSelect.innerHTML = '<option value="">Select subject...</option>';
      
      if (APP.studyManifest) {
        APP.studyManifest.subjects.forEach(subject => {
          const opt = document.createElement('option');
          opt.value = subject.id;
          opt.textContent = `${subject.icon} ${subject.name}`;
          subjectSelect.appendChild(opt);
        });
        subjectSelect.disabled = false;
      }

      // Reset downstream
      document.getElementById('unitSelect').innerHTML = '<option value="">Select unit...</option>';
      document.getElementById('unitSelect').disabled = true;
      document.getElementById('aosSelect').innerHTML = '<option value="">Select AOS...</option>';
      document.getElementById('aosSelect').disabled = true;
      document.getElementById('topicSelect').innerHTML = '<option value="">Select topic...</option>';
      document.getElementById('topicSelect').disabled = true;
      document.getElementById('statsBar').style.display = 'none';
      document.getElementById('validationIssues').innerHTML = '';
      document.getElementById('contentArea').innerHTML = `
        <div class="empty-state">
          <h3>Select a topic to review</h3>
          <p>Use the dropdowns above to navigate to a topic JSON file</p>
        </div>
      `;
    }

    async function selectSubject(subjectId) {
      if (!subjectId) return;
      APP.currentSubject = subjectId;

      const subject = APP.studyManifest.subjects.find(s => s.id === subjectId);
      APP.topicManifest = await fetchJSON(`${APP.currentState}/${subject.path}`);

      const unitSelect = document.getElementById('unitSelect');
      unitSelect.innerHTML = '<option value="">Select unit...</option>';

      if (APP.topicManifest) {
        APP.topicManifest.units.forEach(unit => {
          const opt = document.createElement('option');
          opt.value = unit.id;
          opt.textContent = `${unit.code}: ${unit.name.substring(0, 50)}...`;
          unitSelect.appendChild(opt);
        });
        unitSelect.disabled = false;
      }

      // Reset downstream
      document.getElementById('aosSelect').innerHTML = '<option value="">Select AOS...</option>';
      document.getElementById('aosSelect').disabled = true;
      document.getElementById('topicSelect').innerHTML = '<option value="">Select topic...</option>';
      document.getElementById('topicSelect').disabled = true;
    }

    function selectUnit(unitId) {
      if (!unitId) return;
      APP.currentUnit = unitId;

      const unit = APP.topicManifest.units.find(u => u.id === unitId);
      const aosSelect = document.getElementById('aosSelect');
      aosSelect.innerHTML = '<option value="">Select AOS...</option>';

      unit.areasOfStudy.forEach(aos => {
        const opt = document.createElement('option');
        opt.value = aos.id;
        opt.textContent = `${aos.code}: ${aos.name.substring(0, 40)}...`;
        aosSelect.appendChild(opt);
      });
      aosSelect.disabled = false;

      // Reset downstream
      document.getElementById('topicSelect').innerHTML = '<option value="">Select topic...</option>';
      document.getElementById('topicSelect').disabled = true;
    }

    function selectAOS(aosId) {
      if (!aosId) return;
      APP.currentAOS = aosId;

      const unit = APP.topicManifest.units.find(u => u.id === APP.currentUnit);
      const aos = unit.areasOfStudy.find(a => a.id === aosId);
      const topicSelect = document.getElementById('topicSelect');
      topicSelect.innerHTML = '<option value="">Select topic...</option>';

      aos.topics.forEach(topic => {
        const opt = document.createElement('option');
        opt.value = topic.id;
        const status = topic.status === 'available' ? '‚úì' : '‚óã';
        opt.textContent = `${status} ${topic.code}: ${topic.name}`;
        topicSelect.appendChild(opt);
      });
      topicSelect.disabled = false;
    }

    async function selectTopic(topicId) {
      if (!topicId) return;

      const unit = APP.topicManifest.units.find(u => u.id === APP.currentUnit);
      const aos = unit.areasOfStudy.find(a => a.id === APP.currentAOS);
      const topic = aos.topics.find(t => t.id === topicId);

      document.getElementById('contentArea').innerHTML = `<div class="loading">Loading topic...</div>`;

      APP.topicData = await fetchJSON(`${APP.currentState}/${APP.currentSubject}/${topic.filename}`);

      if (!APP.topicData) {
        document.getElementById('contentArea').innerHTML = `
          <div class="error-msg">Failed to load topic file: ${topic.filename}</div>
        `;
        document.getElementById('statsBar').style.display = 'none';
        return;
      }

      renderTopicContent();
    }

    function validateTopic() {
      const issues = [];
      const data = APP.topicData;

      // Check metadata
      if (!data.metadata) issues.push('Missing metadata object');
      else {
        if (!data.metadata.id) issues.push('Missing metadata.id');
        if (!data.metadata.topicName) issues.push('Missing metadata.topicName');
        if (!data.metadata.dotPoint) issues.push('Missing metadata.dotPoint');
      }

      // Check tabs
      if (!data.tabs || !Array.isArray(data.tabs)) {
        issues.push('Missing or invalid tabs array');
      } else if (data.tabs.length === 0) {
        issues.push('Tabs array is empty');
      }

      // Check content
      if (!data.content) {
        issues.push('Missing content object');
      } else {
        ['round1', 'round2', 'round3'].forEach(round => {
          if (!data.content[round]) {
            issues.push(`Missing content.${round}`);
          } else if (data.tabs) {
            data.tabs.forEach(tab => {
              if (!data.content[round][tab.id]) {
                issues.push(`Missing content.${round}.${tab.id}`);
              }
            });
          }
        });
      }

      // Check concepts
      if (!data.concepts) {
        issues.push('Missing concepts object');
      }

      // Check question structure
      let questionCount = 0;
      const usedConcepts = new Set();

      if (data.content && data.tabs) {
        ['round1', 'round2', 'round3'].forEach(round => {
          if (data.content[round]) {
            data.tabs.forEach(tab => {
              const tabContent = data.content[round][tab.id];
              if (tabContent && tabContent.sentences) {
                tabContent.sentences.forEach((sentence, sIdx) => {
                  if (!sentence.text) {
                    issues.push(`${round}.${tab.id}.sentence[${sIdx}]: Missing text`);
                  }
                  if (!sentence.questions) {
                    issues.push(`${round}.${tab.id}.sentence[${sIdx}]: Missing questions`);
                  } else {
                    Object.entries(sentence.questions).forEach(([qId, q]) => {
                      questionCount++;
                      usedConcepts.add(q.concept);

                      if (!q.correct) {
                        issues.push(`${round}.${tab.id}.${qId}: Missing correct answer`);
                      }
                      if (!q.distractors || q.distractors.length !== 3) {
                        issues.push(`${round}.${tab.id}.${qId}: Should have exactly 3 distractors (has ${q.distractors?.length || 0})`);
                      }
                      if (!q.concept) {
                        issues.push(`${round}.${tab.id}.${qId}: Missing concept reference`);
                      }

                      // Check placeholder exists in text
                      const placeholder = `{{${qId}}}`;
                      if (sentence.text && !sentence.text.includes(placeholder)) {
                        issues.push(`${round}.${tab.id}.${qId}: Placeholder ${placeholder} not found in sentence text`);
                      }
                    });
                  }
                });
              }
            });
          }
        });
      }

      // Check concept definitions exist for used concepts
      usedConcepts.forEach(conceptId => {
        if (!data.concepts || !data.concepts[conceptId]) {
          issues.push(`Concept "${conceptId}" used in questions but not defined in concepts object`);
        }
      });

      return { issues, questionCount, conceptCount: Object.keys(data.concepts || {}).length };
    }

    function renderTopicContent() {
      const data = APP.topicData;
      const validation = validateTopic();

      // Update stats
      document.getElementById('statsBar').style.display = 'flex';
      document.getElementById('statTabs').textContent = data.tabs?.length || 0;
      document.getElementById('statQuestions').textContent = validation.questionCount;
      document.getElementById('statConcepts').textContent = validation.conceptCount;

      const validationEl = document.getElementById('statValidation');
      if (validation.issues.length === 0) {
        validationEl.textContent = '‚úì Pass';
        validationEl.className = 'stat-value success';
      } else {
        validationEl.textContent = `${validation.issues.length} issues`;
        validationEl.className = 'stat-value error';
      }

      // Show validation issues
      const issuesEl = document.getElementById('validationIssues');
      if (validation.issues.length > 0) {
        issuesEl.innerHTML = `
          <div class="validation-issues">
            <h4>‚ö†Ô∏è Validation Issues (${validation.issues.length})</h4>
            <ul>
              ${validation.issues.map(i => `<li>${i}</li>`).join('')}
            </ul>
          </div>
        `;
      } else {
        issuesEl.innerHTML = '';
      }

      let html = '';

      // Metadata section
      if (data.metadata) {
        html += `
          <div class="metadata-section">
            <h3>Metadata</h3>
            <div class="metadata-grid">
              <div class="metadata-item"><span class="label">ID:</span> ${data.metadata.id || '-'}</div>
              <div class="metadata-item"><span class="label">Topic:</span> ${data.metadata.topicName || '-'}</div>
              <div class="metadata-item"><span class="label">Subject:</span> ${data.metadata.subject || '-'}</div>
              <div class="metadata-item"><span class="label">Unit:</span> ${data.metadata.unit || '-'}</div>
              <div class="metadata-item"><span class="label">AOS:</span> ${data.metadata.aos || '-'}</div>
              <div class="metadata-item"><span class="label">Version:</span> ${data.metadata.version || '-'}</div>
            </div>
          </div>
        `;
      }

      // Dot point
      if (data.metadata?.dotPoint) {
        html += `
          <div class="dot-point">
            <div class="dot-point-label">Curriculum Dot Point</div>
            ${data.metadata.dotPoint}
          </div>
        `;
      }

      // Tabs and content
      if (data.tabs && data.content) {
        data.tabs.forEach(tab => {
          html += `
            <div class="tab-section">
              <div class="tab-header">
                <span>${tab.label}</span>
                <span class="tab-icon">${tab.icon}</span>
              </div>
          `;

          ['round1', 'round2', 'round3'].forEach((round, rIdx) => {
            const roundContent = data.content[round]?.[tab.id];
            if (roundContent) {
              html += `
                <div class="round-section">
                  <div class="round-header">Round ${rIdx + 1}</div>
                  <div class="round-content">
                    <div class="round-title">${roundContent.title || '-'}</div>
                    <div class="round-instructions">${roundContent.instructions || '-'}</div>
              `;

              if (roundContent.sentences) {
                roundContent.sentences.forEach((sentence, sIdx) => {
                  html += `<div class="sentence-block">`;

                  // Display sentence with highlighted placeholders
                  let displayText = sentence.text || '';
                  const questionIds = Object.keys(sentence.questions || {});
                  questionIds.forEach(qId => {
                    displayText = displayText.replace(
                      `{{${qId}}}`,
                      `<span class="cloze-marker">{{${qId}}}</span>`
                    );
                  });
                  html += `<div class="sentence-text">${displayText}</div>`;

                  // Questions
                  if (sentence.questions) {
                    html += `<div class="questions-grid">`;
                    Object.entries(sentence.questions).forEach(([qId, q]) => {
                      html += `
                        <div class="question-item">
                          <div class="question-header">
                            <span class="question-id">${qId}</span>
                            <span class="question-concept">${q.concept || 'no concept'}</span>
                          </div>
                          <div class="answer-row">
                            <span class="answer-label">Correct:</span>
                            <span class="correct-answer">${q.correct || '-'}</span>
                          </div>
                          <div class="answer-row">
                            <span class="answer-label">Distractors:</span>
                            <div class="distractors-list">
                              ${(q.distractors || []).map(d => `<span class="distractor-chip">${d}</span>`).join('')}
                            </div>
                          </div>
                          ${q.tooltip ? `
                            <div class="answer-row">
                              <span class="answer-label">Tooltip:</span>
                              <span class="tooltip-text">${q.tooltip}</span>
                            </div>
                          ` : ''}
                        </div>
                      `;
                    });
                    html += `</div>`;
                  }

                  html += `</div>`;
                });
              }

              html += `</div></div>`;
            }
          });

          html += `</div>`;
        });
      }

      // Concepts section
      if (data.concepts && Object.keys(data.concepts).length > 0) {
        html += `
          <div class="concept-section">
            <h3>Concept Definitions (${Object.keys(data.concepts).length})</h3>
        `;

        Object.entries(data.concepts).forEach(([conceptId, concept]) => {
          html += `
            <div class="concept-item" onclick="this.classList.toggle('open')">
              <div class="concept-header">
                <span>${concept.name || conceptId}</span>
                <div>
                  ${concept.formula ? `<span class="concept-formula">${concept.formula}</span>` : ''}
                  <span class="toggle-icon">‚ñ∂</span>
                </div>
              </div>
              <div class="concept-content">
                ${concept.correct ? `
                  <div class="concept-correct">
                    <strong>Correct understanding:</strong> ${concept.correct}
                  </div>
                ` : ''}
          `;

          // Wrong answers
          if (concept.wrong && Object.keys(concept.wrong).length > 0) {
            html += `<div style="margin-top:10px;"><strong>Wrong answer feedback:</strong></div>`;
            Object.entries(concept.wrong).forEach(([wrongKey, wrongData]) => {
              html += `
                <div class="wrong-answer-item">
                  <div class="wrong-key">"${wrongKey}"</div>
                  <div class="wrong-detail">
                    ${wrongData.error ? `<span><strong>Error:</strong> ${wrongData.error}</span>` : ''}
                    ${wrongData.fix ? `<span><strong>Fix:</strong> ${wrongData.fix}</span>` : ''}
                    ${wrongData.action ? `<span><strong>Action:</strong> ${wrongData.action}</span>` : ''}
                  </div>
                </div>
              `;
            });
          }

          // Persistent
          if (concept.persistent) {
            html += `
              <div class="persistent-section">
                <div class="persistent-label">Persistent Error (2+ mistakes)</div>
                ${concept.persistent.gap ? `<div><strong>Gap:</strong> ${concept.persistent.gap}</div>` : ''}
                ${concept.persistent.action ? `<div><strong>Action:</strong> ${concept.persistent.action}</div>` : ''}
              </div>
            `;
          }

          html += `</div></div>`;
        });

        html += `</div>`;
      }

      document.getElementById('contentArea').innerHTML = html;
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>