<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YouCantFakeThis - Content QC Tool</title>
  <style>
    :root {
      --bg: #f8fafc;
      --bg-card: #ffffff;
      --text: #1e293b;
      --text-muted: #64748b;
      --border: #e2e8f0;
      --primary: #3b82f6;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --radius: 4px;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.4;
      padding: 12px;
      font-size: 13px;
    }

    .header {
      background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%);
      color: white;
      padding: 10px 16px;
      border-radius: var(--radius);
      margin-bottom: 12px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header h1 { font-size: 1rem; font-weight: 600; }

    .nav-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
      margin-bottom: 12px;
      align-items: center;
    }

    select {
      padding: 5px 8px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      font-size: 12px;
      min-width: 140px;
      background: var(--bg-card);
    }

    .stats-bar {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 6px 12px;
      margin-bottom: 12px;
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      font-size: 12px;
    }

    .stat { display: flex; gap: 4px; }
    .stat-label { color: var(--text-muted); }
    .stat-value { font-weight: 600; }
    .stat-value.success { color: var(--success); }
    .stat-value.error { color: var(--error); }

    .content-area {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px;
    }

    .metadata-row {
      background: #f1f5f9;
      border-radius: var(--radius);
      padding: 6px 10px;
      margin-bottom: 8px;
      font-size: 11px;
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
    }

    .metadata-row span { color: var(--text-muted); }
    .metadata-row strong { color: var(--text); margin-left: 3px; }

    .dot-point {
      background: #fef3c7;
      border-left: 2px solid var(--warning);
      padding: 6px 10px;
      margin-bottom: 10px;
      font-size: 11px;
    }

    .tab-section {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin-bottom: 8px;
    }

    .tab-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 5px 10px;
      font-weight: 600;
      font-size: 12px;
      display: flex;
      justify-content: space-between;
      cursor: pointer;
    }

    .tab-content { display: none; }
    .tab-section.open .tab-content { display: block; }

    .round-row {
      border-bottom: 1px solid var(--border);
      padding: 8px 10px;
    }

    .round-row:last-child { border-bottom: none; }

    .round-label {
      font-weight: 600;
      font-size: 11px;
      color: var(--primary);
      margin-bottom: 4px;
    }

    .round-meta {
      font-size: 11px;
      color: var(--text-muted);
      margin-bottom: 6px;
    }

    .sentence-row {
      background: #fafafa;
      border: 1px solid #eee;
      border-radius: var(--radius);
      padding: 6px 8px;
      margin-bottom: 6px;
      font-size: 12px;
    }

    .sentence-text {
      margin-bottom: 4px;
      line-height: 1.5;
    }

    .cloze-marker {
      background: #dbeafe;
      border: 1px solid #93c5fd;
      padding: 0 4px;
      border-radius: 2px;
      font-family: monospace;
      font-size: 11px;
      color: var(--primary);
    }

    .q-row {
      display: flex;
      gap: 6px;
      align-items: flex-start;
      padding: 3px 0;
      border-top: 1px dashed #e5e5e5;
      font-size: 11px;
    }

    .q-row:first-child { border-top: none; }

    .q-id {
      font-family: monospace;
      background: var(--primary);
      color: white;
      padding: 0 4px;
      border-radius: 2px;
      font-size: 10px;
      flex-shrink: 0;
    }

    .q-correct {
      color: var(--success);
      font-weight: 600;
      flex-shrink: 0;
    }

    .q-distractors {
      color: var(--error);
      flex: 1;
    }

    .q-concept {
      color: var(--text-muted);
      font-size: 10px;
      flex-shrink: 0;
    }

    .q-tooltip {
      color: #888;
      font-style: italic;
      font-size: 10px;
    }

    .concepts-section {
      margin-top: 12px;
      border-top: 1px solid var(--border);
      padding-top: 10px;
    }

    .concepts-header {
      font-weight: 600;
      font-size: 12px;
      color: var(--primary);
      margin-bottom: 6px;
    }

    .concept-row {
      border: 1px solid var(--border);
      border-radius: var(--radius);
      margin-bottom: 4px;
      font-size: 11px;
    }

    .concept-title {
      background: #f1f5f9;
      padding: 4px 8px;
      cursor: pointer;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .concept-title:hover { background: #e2e8f0; }

    .concept-formula {
      font-family: monospace;
      background: white;
      padding: 0 6px;
      border-radius: 2px;
      font-size: 10px;
    }

    .concept-body {
      display: none;
      padding: 6px 8px;
      font-size: 11px;
    }

    .concept-row.open .concept-body { display: block; }

    .concept-correct {
      background: #ecfdf5;
      border-left: 2px solid var(--success);
      padding: 4px 8px;
      margin-bottom: 4px;
    }

    .wrong-item {
      background: #fef2f2;
      border-left: 2px solid var(--error);
      padding: 4px 8px;
      margin-bottom: 3px;
    }

    .wrong-key { font-weight: 600; color: var(--error); }
    .wrong-detail { color: var(--text-muted); font-size: 10px; }

    .persistent-item {
      background: #fffbeb;
      border-left: 2px solid var(--warning);
      padding: 4px 8px;
      margin-top: 4px;
    }

    .validation-issues {
      background: #fef2f2;
      border: 1px solid #fecaca;
      border-radius: var(--radius);
      padding: 8px 10px;
      margin-bottom: 10px;
      font-size: 11px;
    }

    .validation-issues summary {
      color: var(--error);
      font-weight: 600;
      cursor: pointer;
    }

    .validation-issues ul {
      margin: 6px 0 0 16px;
    }

    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-muted);
    }

    .toggle-icon { font-size: 10px; }
    .tab-section.open .toggle-icon, .concept-row.open .toggle-icon { transform: rotate(90deg); }
  </style>
</head>
<body>
  <div class="header">
    <h1>üìã Content QC Tool</h1>
  </div>

  <div class="nav-row">
    <select id="stateSelect" onchange="selectState(this.value)">
      <option value="">Curriculum...</option>
    </select>
    <select id="subjectSelect" onchange="selectSubject(this.value)" disabled>
      <option value="">Subject...</option>
    </select>
    <select id="unitSelect" onchange="selectUnit(this.value)" disabled>
      <option value="">Unit...</option>
    </select>
    <select id="aosSelect" onchange="selectAOS(this.value)" disabled>
      <option value="">AOS...</option>
    </select>
    <select id="topicSelect" onchange="selectTopic(this.value)" disabled>
      <option value="">Topic...</option>
    </select>
  </div>

  <div id="statsBar" class="stats-bar" style="display:none;">
    <div class="stat"><span class="stat-label">Tabs:</span><span class="stat-value" id="statTabs">-</span></div>
    <div class="stat"><span class="stat-label">Questions:</span><span class="stat-value" id="statQuestions">-</span></div>
    <div class="stat"><span class="stat-label">Concepts:</span><span class="stat-value" id="statConcepts">-</span></div>
    <div class="stat"><span class="stat-label">Validation:</span><span class="stat-value" id="statValidation">-</span></div>
  </div>

  <div id="validationIssues"></div>

  <div class="content-area" id="contentArea">
    <div class="empty-state">Select a topic to review</div>
  </div>

  <script>
    const APP = { basePath: './', states: null, studyManifest: null, topicManifest: null, topicData: null, currentState: null, currentSubject: null, currentUnit: null, currentAOS: null };

    async function fetchJSON(path) {
      try {
        const response = await fetch(APP.basePath + path);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return await response.json();
      } catch (e) { console.error('Fetch error:', path, e); return null; }
    }

    async function init() {
      APP.states = await fetchJSON('states.json');
      if (!APP.states) { document.getElementById('contentArea').innerHTML = `<div style="color:var(--error)">Failed to load states.json</div>`; return; }
      const sel = document.getElementById('stateSelect');
      APP.states.states.forEach(s => { const o = document.createElement('option'); o.value = s.id; o.textContent = `${s.icon} ${s.name}`; sel.appendChild(o); });
    }

    async function selectState(id) {
      if (!id) return;
      APP.currentState = id;
      const state = APP.states.states.find(s => s.id === id);
      APP.studyManifest = await fetchJSON(state.path);
      const sel = document.getElementById('subjectSelect');
      sel.innerHTML = '<option value="">Subject...</option>';
      if (APP.studyManifest) { APP.studyManifest.subjects.forEach(s => { const o = document.createElement('option'); o.value = s.id; o.textContent = `${s.icon} ${s.name}`; sel.appendChild(o); }); sel.disabled = false; }
      resetDownstream('subject');
    }

    async function selectSubject(id) {
      if (!id) return;
      APP.currentSubject = id;
      const subject = APP.studyManifest.subjects.find(s => s.id === id);
      APP.topicManifest = await fetchJSON(`${APP.currentState}/${subject.path}`);
      const sel = document.getElementById('unitSelect');
      sel.innerHTML = '<option value="">Unit...</option>';
      if (APP.topicManifest) { APP.topicManifest.units.forEach(u => { const o = document.createElement('option'); o.value = u.id; o.textContent = u.code; sel.appendChild(o); }); sel.disabled = false; }
      resetDownstream('unit');
    }

    function selectUnit(id) {
      if (!id) return;
      APP.currentUnit = id;
      const unit = APP.topicManifest.units.find(u => u.id === id);
      const sel = document.getElementById('aosSelect');
      sel.innerHTML = '<option value="">AOS...</option>';
      unit.areasOfStudy.forEach(a => { const o = document.createElement('option'); o.value = a.id; o.textContent = a.code; sel.appendChild(o); });
      sel.disabled = false;
      resetDownstream('aos');
    }

    function selectAOS(id) {
      if (!id) return;
      APP.currentAOS = id;
      const unit = APP.topicManifest.units.find(u => u.id === APP.currentUnit);
      const aos = unit.areasOfStudy.find(a => a.id === id);
      const sel = document.getElementById('topicSelect');
      sel.innerHTML = '<option value="">Topic...</option>';
      aos.topics.forEach(t => { const o = document.createElement('option'); o.value = t.id; o.textContent = `${t.status === 'available' ? '‚úì' : '‚óã'} ${t.code}: ${t.name}`; sel.appendChild(o); });
      sel.disabled = false;
    }

    async function selectTopic(id) {
      if (!id) return;
      const unit = APP.topicManifest.units.find(u => u.id === APP.currentUnit);
      const aos = unit.areasOfStudy.find(a => a.id === APP.currentAOS);
      const topic = aos.topics.find(t => t.id === id);
      document.getElementById('contentArea').innerHTML = `<div style="color:var(--text-muted)">Loading...</div>`;
      APP.topicData = await fetchJSON(`${APP.currentState}/${APP.currentSubject}/${topic.filename}`);
      if (!APP.topicData) { document.getElementById('contentArea').innerHTML = `<div style="color:var(--error)">Failed to load: ${topic.filename}</div>`; document.getElementById('statsBar').style.display = 'none'; return; }
      renderTopicContent();
    }

    function resetDownstream(level) {
      const levels = ['subject', 'unit', 'aos', 'topic'];
      const idx = levels.indexOf(level);
      if (idx < 1) { document.getElementById('unitSelect').innerHTML = '<option value="">Unit...</option>'; document.getElementById('unitSelect').disabled = true; }
      if (idx < 2) { document.getElementById('aosSelect').innerHTML = '<option value="">AOS...</option>'; document.getElementById('aosSelect').disabled = true; }
      if (idx < 3) { document.getElementById('topicSelect').innerHTML = '<option value="">Topic...</option>'; document.getElementById('topicSelect').disabled = true; }
      document.getElementById('statsBar').style.display = 'none';
      document.getElementById('validationIssues').innerHTML = '';
      document.getElementById('contentArea').innerHTML = '<div class="empty-state">Select a topic to review</div>';
    }

    function validateTopic() {
      const issues = [];
      const data = APP.topicData;
      if (!data.metadata) issues.push('Missing metadata');
      else { if (!data.metadata.id) issues.push('Missing metadata.id'); if (!data.metadata.topicName) issues.push('Missing metadata.topicName'); }
      if (!data.tabs || data.tabs.length === 0) issues.push('Missing/empty tabs');
      if (!data.content) issues.push('Missing content');
      if (!data.concepts) issues.push('Missing concepts');

      let qCount = 0;
      const usedConcepts = new Set();
      if (data.content && data.tabs) {
        ['round1', 'round2', 'round3'].forEach(r => {
          if (!data.content[r]) { issues.push(`Missing ${r}`); return; }
          data.tabs.forEach(tab => {
            const tc = data.content[r]?.[tab.id];
            if (!tc) { issues.push(`Missing ${r}.${tab.id}`); return; }
            (tc.sentences || []).forEach((s, i) => {
              if (!s.questions) return;
              Object.entries(s.questions).forEach(([qId, q]) => {
                qCount++;
                if (q.concept) usedConcepts.add(q.concept);
                if (!q.correct) issues.push(`${r}.${tab.id}.${qId}: no correct`);
                if (!q.distractors || q.distractors.length !== 3) issues.push(`${r}.${tab.id}.${qId}: need 3 distractors`);
                if (!s.text?.includes(`{{${qId}}}`)) issues.push(`${r}.${tab.id}.${qId}: placeholder missing`);
              });
            });
          });
        });
      }
      usedConcepts.forEach(c => { if (!data.concepts?.[c]) issues.push(`Concept "${c}" undefined`); });
      return { issues, qCount, cCount: Object.keys(data.concepts || {}).length };
    }

    function renderTopicContent() {
      const data = APP.topicData;
      const v = validateTopic();

      document.getElementById('statsBar').style.display = 'flex';
      document.getElementById('statTabs').textContent = data.tabs?.length || 0;
      document.getElementById('statQuestions').textContent = v.qCount;
      document.getElementById('statConcepts').textContent = v.cCount;
      const valEl = document.getElementById('statValidation');
      valEl.textContent = v.issues.length === 0 ? '‚úì Pass' : `${v.issues.length} issues`;
      valEl.className = 'stat-value ' + (v.issues.length === 0 ? 'success' : 'error');

      document.getElementById('validationIssues').innerHTML = v.issues.length > 0 ? `<details class="validation-issues"><summary>‚ö†Ô∏è ${v.issues.length} Validation Issues</summary><ul>${v.issues.map(i => `<li>${i}</li>`).join('')}</ul></details>` : '';

      let html = '';

      // Metadata
      if (data.metadata) {
        html += `<div class="metadata-row"><span>ID:</span><strong>${data.metadata.id || '-'}</strong><span>Topic:</span><strong>${data.metadata.topicName || '-'}</strong><span>Subject:</span><strong>${data.metadata.subject || '-'}</strong><span>Unit:</span><strong>${data.metadata.unit || '-'}</strong><span>AOS:</span><strong>${data.metadata.aos || '-'}</strong></div>`;
      }

      // Dot point
      if (data.metadata?.dotPoint) {
        html += `<div class="dot-point">${data.metadata.dotPoint}</div>`;
      }

      // Tabs
      if (data.tabs && data.content) {
        data.tabs.forEach((tab, tIdx) => {
          html += `<div class="tab-section${tIdx === 0 ? ' open' : ''}" onclick="if(event.target.closest('.tab-header'))this.classList.toggle('open')"><div class="tab-header"><span>${tab.icon} ${tab.label}</span><span class="toggle-icon">‚ñ∂</span></div><div class="tab-content">`;

          ['round1', 'round2', 'round3'].forEach((r, rIdx) => {
            const rc = data.content[r]?.[tab.id];
            if (!rc) return;
            html += `<div class="round-row"><div class="round-label">Round ${rIdx + 1}</div>`;
            if (rc.title || rc.instructions) html += `<div class="round-meta">${rc.title || ''}${rc.title && rc.instructions ? ' ‚Äî ' : ''}${rc.instructions || ''}</div>`;

            (rc.sentences || []).forEach(s => {
              let txt = s.text || '';
              Object.keys(s.questions || {}).forEach(qId => { txt = txt.replace(`{{${qId}}}`, `<span class="cloze-marker">${qId}</span>`); });
              html += `<div class="sentence-row"><div class="sentence-text">${txt}</div>`;
              Object.entries(s.questions || {}).forEach(([qId, q]) => {
                html += `<div class="q-row"><span class="q-id">${qId}</span><span class="q-correct">${q.correct || '-'}</span><span class="q-distractors">${(q.distractors || []).join(' | ')}</span><span class="q-concept">[${q.concept || '?'}]</span></div>`;
                if (q.tooltip) html += `<div class="q-tooltip" style="margin-left:30px;">üí° ${q.tooltip}</div>`;
              });
              html += `</div>`;
            });
            html += `</div>`;
          });
          html += `</div></div>`;
        });
      }

      // Concepts
      if (data.concepts && Object.keys(data.concepts).length > 0) {
        html += `<div class="concepts-section"><div class="concepts-header">Concepts (${Object.keys(data.concepts).length})</div>`;
        Object.entries(data.concepts).forEach(([cId, c]) => {
          html += `<div class="concept-row" onclick="this.classList.toggle('open')"><div class="concept-title"><span>${c.name || cId}</span><span>${c.formula ? `<span class="concept-formula">${c.formula}</span> ` : ''}<span class="toggle-icon">‚ñ∂</span></span></div><div class="concept-body">`;
          if (c.correct) html += `<div class="concept-correct">${c.correct}</div>`;
          if (c.wrong) Object.entries(c.wrong).forEach(([k, w]) => {
            html += `<div class="wrong-item"><span class="wrong-key">"${k}"</span><div class="wrong-detail">${w.error ? `<b>Error:</b> ${w.error} ` : ''}${w.fix ? `<b>Fix:</b> ${w.fix} ` : ''}${w.action ? `<b>Action:</b> ${w.action}` : ''}</div></div>`;
          });
          if (c.persistent) html += `<div class="persistent-item"><b>Persistent:</b> ${c.persistent.gap || ''} ${c.persistent.action ? `‚Üí ${c.persistent.action}` : ''}</div>`;
          html += `</div></div>`;
        });
        html += `</div>`;
      }

      document.getElementById('contentArea').innerHTML = html;
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>