<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>YouCantFakeThis</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Source+Sans+3:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --bg-primary: #0a0a0f;
            --bg-secondary: #12121a;
            --bg-tertiary: #1a1a24;
            --bg-card: #16161f;
            --text-primary: #e8e8ed;
            --text-secondary: #9898a8;
            --text-muted: #5a5a6e;
            --accent-primary: #667eea;
            --accent-secondary: #764ba2;
            --accent-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success: #34d399;
            --error: #f87171;
            --warning: #fbbf24;
            --border: #2a2a3a;
            --dropdown-unfilled: #3d3a28;
            --dropdown-filled: #1e3a5f;
            --dropdown-correct: #1a4d3a;
            --dropdown-incorrect: #4d1a1a;
            --radius-sm: 4px;
            --radius-md: 8px;
            --radius-lg: 12px;
            --shadow: 0 4px 20px rgba(0,0,0,0.4);
            --font-mono: 'JetBrains Mono', monospace;
            --font-sans: 'Source Sans 3', sans-serif;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: var(--font-sans);
            background: var(--bg-primary);
            color: var(--text-primary);
            min-height: 100vh;
            line-height: 1.6;
        }

        /* State Selection Screen */
        .state-selection {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            background: 
                radial-gradient(ellipse at 20% 20%, rgba(102, 126, 234, 0.1) 0%, transparent 50%),
                radial-gradient(ellipse at 80% 80%, rgba(118, 75, 162, 0.1) 0%, transparent 50%),
                var(--bg-primary);
        }

        .state-selection h1 {
            font-family: var(--font-mono);
            font-size: clamp(2rem, 5vw, 3.5rem);
            font-weight: 700;
            margin-bottom: 0.5rem;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .state-selection .tagline {
            color: var(--text-secondary);
            font-size: 1.1rem;
            margin-bottom: 3rem;
            font-family: var(--font-mono);
        }

        .state-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 1.5rem;
            max-width: 900px;
            width: 100%;
        }

        .state-card {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-lg);
            padding: 2rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .state-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--card-color, var(--accent-gradient));
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .state-card:hover {
            transform: translateY(-4px);
            border-color: var(--card-color, var(--accent-primary));
            box-shadow: var(--shadow);
        }

        .state-card:hover::before {
            opacity: 1;
        }

        .state-card.disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .state-card.disabled:hover {
            transform: none;
        }

        .state-card .icon {
            font-size: 2.5rem;
            margin-bottom: 1rem;
        }

        .state-card .name {
            font-family: var(--font-mono);
            font-size: 1.5rem;
            font-weight: 700;
            margin-bottom: 0.25rem;
        }

        .state-card .region {
            color: var(--text-secondary);
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
        }

        .state-card .description {
            color: var(--text-muted);
            font-size: 0.85rem;
        }

        .state-card .coming-soon {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: var(--bg-tertiary);
            color: var(--text-muted);
            font-size: 0.7rem;
            padding: 0.25rem 0.5rem;
            border-radius: var(--radius-sm);
            font-family: var(--font-mono);
            text-transform: uppercase;
        }

        /* Main Application */
        .app-container {
            display: none;
            min-height: 100vh;
            flex-direction: column;
        }

        .app-container.active {
            display: flex;
        }

        /* Header */
        .app-header {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .app-logo {
            font-family: var(--font-mono);
            font-weight: 700;
            font-size: 1.25rem;
            background: var(--accent-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            cursor: pointer;
        }

        .header-info {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            font-size: 0.9rem;
        }

        .header-info .round-badge {
            background: var(--accent-gradient);
            padding: 0.35rem 0.75rem;
            border-radius: var(--radius-sm);
            font-family: var(--font-mono);
            font-weight: 600;
        }

        .header-info .score {
            color: var(--text-secondary);
            font-family: var(--font-mono);
        }

        .change-state-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-family: var(--font-mono);
            font-size: 0.8rem;
            transition: all 0.2s ease;
        }

        .change-state-btn:hover {
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        /* Selection Panel */
        .selection-panel {
            background: var(--bg-secondary);
            padding: 1.5rem 2rem;
            border-bottom: 1px solid var(--border);
        }

        .selection-row {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
            align-items: flex-end;
        }

        .select-group {
            display: flex;
            flex-direction: column;
            gap: 0.35rem;
            min-width: 180px;
            flex: 1;
        }

        .select-group label {
            font-size: 0.75rem;
            color: var(--text-muted);
            font-family: var(--font-mono);
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }

        .select-group select {
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            color: var(--text-primary);
            padding: 0.6rem 0.8rem;
            border-radius: var(--radius-sm);
            font-family: var(--font-sans);
            font-size: 0.95rem;
            cursor: pointer;
            transition: border-color 0.2s ease;
        }

        .select-group select:hover {
            border-color: var(--accent-primary);
        }

        .select-group select:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .load-topic-btn {
            background: var(--accent-gradient);
            border: none;
            color: white;
            padding: 0.6rem 1.5rem;
            border-radius: var(--radius-sm);
            font-family: var(--font-mono);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            white-space: nowrap;
        }

        .load-topic-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .load-topic-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Main Content Area */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            padding: 0;
        }

        /* Tab Navigation */
        .tab-navigation {
            display: flex;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border);
            padding: 0 2rem;
            gap: 0.5rem;
            overflow-x: auto;
        }

        .tab-btn {
            background: transparent;
            border: none;
            color: var(--text-secondary);
            padding: 1rem 1.25rem;
            font-family: var(--font-sans);
            font-size: 0.95rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            white-space: nowrap;
        }

        .tab-btn:hover {
            color: var(--text-primary);
        }

        .tab-btn.active {
            color: var(--text-primary);
            border-bottom-color: var(--accent-primary);
        }

        .tab-btn .tab-icon {
            font-family: var(--font-mono);
            font-size: 0.85rem;
            opacity: 0.7;
        }

        .tab-btn .round-indicators {
            display: flex;
            gap: 0.2rem;
            margin-left: 0.5rem;
        }

        .tab-btn .round-dot {
            width: 6px;
            height: 6px;
            border-radius: 50%;
            background: var(--text-muted);
        }

        .tab-btn .round-dot.complete {
            background: var(--success);
        }

        /* Content Area */
        .content-area {
            flex: 1;
            padding: 2rem;
            max-width: 900px;
            margin: 0 auto;
            width: 100%;
        }

        .content-header {
            margin-bottom: 2rem;
        }

        .content-header h2 {
            font-family: var(--font-mono);
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .content-header .instructions {
            color: var(--text-secondary);
        }

        /* Cloze Sentences */
        .cloze-container {
            display: flex;
            flex-direction: column;
            gap: 1.5rem;
        }

        .cloze-sentence {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 1.5rem;
            line-height: 2;
            font-size: 1.05rem;
        }

        .cloze-dropdown {
            display: inline-block;
            position: relative;
        }

        .cloze-dropdown select {
            appearance: none;
            background: var(--dropdown-unfilled);
            border: 2px solid var(--border);
            color: var(--text-primary);
            padding: 0.3rem 2rem 0.3rem 0.6rem;
            border-radius: var(--radius-sm);
            font-family: var(--font-mono);
            font-size: 0.9rem;
            cursor: pointer;
            min-width: 120px;
            transition: all 0.2s ease;
        }

        .cloze-dropdown select:hover {
            border-color: var(--accent-primary);
        }

        .cloze-dropdown select.filled {
            background: var(--dropdown-filled);
        }

        .cloze-dropdown select.correct {
            background: var(--dropdown-correct);
            border-color: var(--success);
        }

        .cloze-dropdown select.incorrect {
            background: var(--dropdown-incorrect);
            border-color: var(--error);
        }

        .cloze-dropdown::after {
            content: 'â–¼';
            position: absolute;
            right: 0.6rem;
            top: 50%;
            transform: translateY(-50%);
            font-size: 0.6rem;
            color: var(--text-muted);
            pointer-events: none;
        }

        /* Control Panel */
        .control-panel {
            background: var(--bg-secondary);
            border-top: 1px solid var(--border);
            padding: 1rem 2rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 1rem;
            flex-wrap: wrap;
        }

        .control-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .reset-btn {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-secondary);
            padding: 0.5rem 1rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            font-family: var(--font-mono);
            font-size: 0.85rem;
            transition: all 0.2s ease;
        }

        .reset-btn:hover {
            border-color: var(--error);
            color: var(--error);
        }

        .control-center {
            display: flex;
            align-items: center;
            gap: 1.5rem;
            font-family: var(--font-mono);
            font-size: 0.9rem;
        }

        .score-display {
            color: var(--text-secondary);
        }

        .score-display .score-value {
            color: var(--text-primary);
            font-weight: 600;
        }

        .attempt-display {
            color: var(--text-muted);
        }

        .control-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .submit-btn {
            background: var(--accent-gradient);
            border: none;
            color: white;
            padding: 0.6rem 1.5rem;
            border-radius: var(--radius-sm);
            font-family: var(--font-mono);
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .submit-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }

        .submit-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Feedback Toast */
        .feedback-toast {
            position: fixed;
            bottom: 100px;
            left: 50%;
            transform: translateX(-50%) translateY(20px);
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius-md);
            padding: 1rem 1.5rem;
            box-shadow: var(--shadow);
            opacity: 0;
            pointer-events: none;
            transition: all 0.3s ease;
            font-family: var(--font-mono);
            z-index: 100;
        }

        .feedback-toast.visible {
            opacity: 1;
            transform: translateX(-50%) translateY(0);
            pointer-events: auto;
        }

        .feedback-toast.success {
            border-color: var(--success);
        }

        .feedback-toast.error {
            border-color: var(--error);
        }

        /* Tooltip */
        .tooltip {
            position: fixed;
            background: var(--bg-tertiary);
            border: 1px solid var(--border);
            border-radius: var(--radius-sm);
            padding: 0.5rem 0.75rem;
            font-size: 0.85rem;
            color: var(--text-secondary);
            max-width: 250px;
            box-shadow: var(--shadow);
            z-index: 1000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }

        .tooltip.visible {
            opacity: 1;
        }

        /* Placeholder/Loading States */
        .placeholder-message {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 400px;
            color: var(--text-muted);
            text-align: center;
        }

        .placeholder-message .icon {
            font-size: 3rem;
            margin-bottom: 1rem;
            opacity: 0.5;
        }

        .placeholder-message h3 {
            font-family: var(--font-mono);
            font-size: 1.25rem;
            margin-bottom: 0.5rem;
            color: var(--text-secondary);
        }

        /* Utility Tabs (placeholder) */
        .utility-tabs {
            display: flex;
            gap: 0.5rem;
            padding: 0.5rem 2rem;
            background: var(--bg-tertiary);
            border-bottom: 1px solid var(--border);
        }

        .utility-tab {
            background: transparent;
            border: 1px solid var(--border);
            color: var(--text-muted);
            padding: 0.4rem 0.8rem;
            border-radius: var(--radius-sm);
            font-family: var(--font-mono);
            font-size: 0.75rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .utility-tab:hover {
            border-color: var(--text-muted);
            color: var(--text-secondary);
        }

        .utility-tab.active {
            background: var(--bg-card);
            border-color: var(--accent-primary);
            color: var(--text-primary);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .app-header {
                padding: 1rem;
            }

            .selection-panel {
                padding: 1rem;
            }

            .select-group {
                min-width: 100%;
            }

            .tab-navigation {
                padding: 0 1rem;
            }

            .content-area {
                padding: 1rem;
            }

            .control-panel {
                padding: 1rem;
                flex-direction: column;
                align-items: stretch;
            }

            .control-center {
                justify-content: center;
            }

            .control-right {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- State Selection Screen -->
    <div class="state-selection" id="stateSelection">
        <h1>YouCantFakeThis</h1>
        <p class="tagline">Master concepts through spaced repetition</p>
        <div class="state-grid" id="stateGrid">
            <!-- Populated by JS -->
        </div>
    </div>

    <!-- Main Application -->
    <div class="app-container" id="appContainer">
        <!-- Header -->
        <header class="app-header">
            <div class="app-logo" onclick="showStateSelection()">YouCantFakeThis</div>
            <div class="header-info" id="headerInfo">
                <span class="round-badge" id="roundBadge">Round 1 of 3</span>
                <span class="score" id="totalScore">Total: 0/0</span>
            </div>
            <button class="change-state-btn" onclick="showStateSelection()">Change Curriculum</button>
        </header>

        <!-- Selection Panel -->
        <div class="selection-panel">
            <div class="selection-row">
                <div class="select-group">
                    <label>Subject</label>
                    <select id="subjectSelect" onchange="onSubjectChange()">
                        <option value="">Select subject...</option>
                    </select>
                </div>
                <div class="select-group">
                    <label>Unit</label>
                    <select id="unitSelect" onchange="onUnitChange()" disabled>
                        <option value="">Select unit...</option>
                    </select>
                </div>
                <div class="select-group">
                    <label>Area of Study</label>
                    <select id="aosSelect" onchange="onAOSChange()" disabled>
                        <option value="">Select AOS...</option>
                    </select>
                </div>
                <div class="select-group">
                    <label>Topic</label>
                    <select id="topicSelect" onchange="onTopicChange()" disabled>
                        <option value="">Select topic...</option>
                    </select>
                </div>
                <button class="load-topic-btn" id="loadTopicBtn" onclick="loadTopic()" disabled>
                    Load Topic
                </button>
            </div>
        </div>

        <!-- Utility Tabs (placeholder) -->
        <div class="utility-tabs">
            <button class="utility-tab active">Content</button>
            <button class="utility-tab">Review</button>
            <button class="utility-tab">Progress</button>
            <button class="utility-tab">Settings</button>
        </div>

        <!-- Tab Navigation -->
        <nav class="tab-navigation" id="tabNavigation">
            <!-- Populated by JS -->
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <div class="content-area" id="contentArea">
                <div class="placeholder-message">
                    <div class="icon">ðŸ“š</div>
                    <h3>Select a Topic</h3>
                    <p>Choose a subject, unit, area of study, and topic to begin</p>
                </div>
            </div>
        </main>

        <!-- Control Panel -->
        <div class="control-panel" id="controlPanel" style="display: none;">
            <div class="control-left">
                <button class="reset-btn" onclick="resetSection()">Reset Section</button>
            </div>
            <div class="control-center">
                <span class="score-display">Score: <span class="score-value" id="tabScore">0/0</span></span>
                <span class="attempt-display" id="attemptDisplay">Attempt 1</span>
            </div>
            <div class="control-right">
                <button class="submit-btn" id="submitBtn" onclick="submitAnswers()">Submit</button>
            </div>
        </div>
    </div>

    <!-- Feedback Toast -->
    <div class="feedback-toast" id="feedbackToast"></div>

    <!-- Tooltip -->
    <div class="tooltip" id="tooltip"></div>

    <script>
        // ============================================
        // STATE MANAGEMENT
        // ============================================
        const STORAGE_PREFIX = 'ycft_';
        
        let appState = {
            currentCurriculum: null,
            currentSubject: null,
            currentUnit: null,
            currentAOS: null,
            currentTopic: null,
            currentRound: 1,
            currentTab: null,
            topicData: null,
            manifestData: {},
            tabStates: {},
            submitted: false
        };

        // ============================================
        // LOCAL STORAGE HELPERS
        // ============================================
        function saveToStorage(key, value) {
            localStorage.setItem(STORAGE_PREFIX + key, JSON.stringify(value));
        }

        function loadFromStorage(key, defaultValue = null) {
            const stored = localStorage.getItem(STORAGE_PREFIX + key);
            return stored ? JSON.parse(stored) : defaultValue;
        }

        // ============================================
        // DATA LOADING
        // ============================================
        async function loadJSON(path) {
            try {
                const response = await fetch(path);
                if (!response.ok) throw new Error(`Failed to load ${path}`);
                return await response.json();
            } catch (error) {
                console.error('Load error:', error);
                showToast(`Error loading data: ${error.message}`, 'error');
                return null;
            }
        }

        // ============================================
        // STATE SELECTION
        // ============================================
        async function initApp() {
            const savedCurriculum = loadFromStorage('curriculum');
            
            if (savedCurriculum) {
                appState.currentCurriculum = savedCurriculum;
                await loadCurriculumData(savedCurriculum);
                showApp();
            } else {
                await loadStateSelection();
            }
        }

        async function loadStateSelection() {
            const statesData = await loadJSON('states.json');
            if (!statesData) return;

            const grid = document.getElementById('stateGrid');
            grid.innerHTML = '';

            statesData.states.forEach(state => {
                const card = document.createElement('div');
                card.className = `state-card ${!state.active ? 'disabled' : ''}`;
                card.style.setProperty('--card-color', state.color);
                card.innerHTML = `
                    <div class="icon">${state.icon}</div>
                    <div class="name">${state.name}</div>
                    <div class="region">${state.region}</div>
                    <div class="description">${state.description}</div>
                    ${!state.active ? '<span class="coming-soon">Coming Soon</span>' : ''}
                `;
                
                if (state.active) {
                    card.onclick = () => selectState(state);
                }
                
                grid.appendChild(card);
            });

            document.getElementById('stateSelection').style.display = 'flex';
            document.getElementById('appContainer').classList.remove('active');
        }

        async function selectState(state) {
            appState.currentCurriculum = state;
            saveToStorage('curriculum', state);
            await loadCurriculumData(state);
            showApp();
        }

        function showStateSelection() {
            document.getElementById('stateSelection').style.display = 'flex';
            document.getElementById('appContainer').classList.remove('active');
        }

        function showApp() {
            document.getElementById('stateSelection').style.display = 'none';
            document.getElementById('appContainer').classList.add('active');
        }

        // ============================================
        // CURRICULUM DATA LOADING
        // ============================================
        async function loadCurriculumData(curriculum) {
            const studyManifest = await loadJSON(curriculum.path);
            if (!studyManifest) return;
            
            appState.manifestData.study = studyManifest;
            populateSubjects(studyManifest.subjects);
        }

        function populateSubjects(subjects) {
            const select = document.getElementById('subjectSelect');
            select.innerHTML = '<option value="">Select subject...</option>';
            
            subjects.forEach(subject => {
                const option = document.createElement('option');
                option.value = subject.id;
                option.textContent = `${subject.icon} ${subject.name}`;
                option.disabled = subject.status !== 'available';
                if (subject.status !== 'available') {
                    option.textContent += ' (Coming Soon)';
                }
                select.appendChild(option);
            });
        }

        async function onSubjectChange() {
            const subjectId = document.getElementById('subjectSelect').value;
            resetSelections('subject');
            
            if (!subjectId) return;
            
            const subject = appState.manifestData.study.subjects.find(s => s.id === subjectId);
            appState.currentSubject = subject;
            
            // Load topic manifest for this subject
            const basePath = appState.currentCurriculum.path.replace('study-manifest.json', '');
            const topicManifest = await loadJSON(basePath + subject.path);
            if (!topicManifest) return;
            
            appState.manifestData.topics = topicManifest;
            populateUnits(topicManifest.units);
            document.getElementById('unitSelect').disabled = false;
        }

        function populateUnits(units) {
            const select = document.getElementById('unitSelect');
            select.innerHTML = '<option value="">Select unit...</option>';
            
            units.forEach(unit => {
                const option = document.createElement('option');
                option.value = unit.id;
                option.textContent = `${unit.code}: ${unit.name}`;
                select.appendChild(option);
            });
        }

        function onUnitChange() {
            const unitId = document.getElementById('unitSelect').value;
            resetSelections('unit');
            
            if (!unitId) return;
            
            const unit = appState.manifestData.topics.units.find(u => u.id === unitId);
            appState.currentUnit = unit;
            
            populateAOS(unit.areasOfStudy);
            document.getElementById('aosSelect').disabled = false;
        }

        function populateAOS(areasOfStudy) {
            const select = document.getElementById('aosSelect');
            select.innerHTML = '<option value="">Select AOS...</option>';
            
            areasOfStudy.forEach(aos => {
                const option = document.createElement('option');
                option.value = aos.id;
                option.textContent = `${aos.code}: ${aos.name}`;
                select.appendChild(option);
            });
        }

        function onAOSChange() {
            const aosId = document.getElementById('aosSelect').value;
            resetSelections('aos');
            
            if (!aosId) return;
            
            const aos = appState.currentUnit.areasOfStudy.find(a => a.id === aosId);
            appState.currentAOS = aos;
            
            populateTopics(aos.topics);
            document.getElementById('topicSelect').disabled = false;
        }

        function populateTopics(topics) {
            const select = document.getElementById('topicSelect');
            select.innerHTML = '<option value="">Select topic...</option>';
            
            topics.forEach(topic => {
                const option = document.createElement('option');
                option.value = topic.id;
                option.textContent = `${topic.code}. ${topic.name}`;
                option.disabled = topic.status !== 'available';
                if (topic.status !== 'available') {
                    option.textContent += ' (Coming Soon)';
                }
                select.appendChild(option);
            });
        }

        function onTopicChange() {
            const topicId = document.getElementById('topicSelect').value;
            document.getElementById('loadTopicBtn').disabled = !topicId;
            
            if (topicId) {
                appState.currentTopic = appState.currentAOS.topics.find(t => t.id === topicId);
            } else {
                appState.currentTopic = null;
            }
        }

        function resetSelections(fromLevel) {
            const levels = ['subject', 'unit', 'aos', 'topic'];
            const startIndex = levels.indexOf(fromLevel) + 1;
            
            for (let i = startIndex; i < levels.length; i++) {
                const selectId = levels[i] === 'aos' ? 'aosSelect' : `${levels[i]}Select`;
                const select = document.getElementById(selectId);
                select.innerHTML = `<option value="">Select ${levels[i]}...</option>`;
                select.disabled = true;
            }
            
            document.getElementById('loadTopicBtn').disabled = true;
        }

        // ============================================
        // TOPIC LOADING & RENDERING
        // ============================================
        async function loadTopic() {
            if (!appState.currentTopic) return;
            
            const basePath = appState.currentCurriculum.path.replace('study-manifest.json', '');
            const subjectPath = appState.currentSubject.path.replace('topic-manifest.json', '');
            const topicPath = basePath + subjectPath + appState.currentTopic.filename;
            
            const topicData = await loadJSON(topicPath);
            if (!topicData) return;
            
            appState.topicData = topicData;
            appState.currentRound = 1;
            appState.tabStates = {};
            appState.submitted = false;
            
            // Initialize tab states
            topicData.tabs.forEach(tab => {
                appState.tabStates[tab.id] = {
                    selections: {},
                    results: {},
                    attempts: 0,
                    submitted: false,
                    complete: false
                };
            });
            
            renderTabs();
            selectTab(topicData.tabs[0].id);
            document.getElementById('controlPanel').style.display = 'flex';
            updateHeaderInfo();
        }

        function renderTabs() {
            const nav = document.getElementById('tabNavigation');
            nav.innerHTML = '';
            
            appState.topicData.tabs.forEach(tab => {
                const btn = document.createElement('button');
                btn.className = 'tab-btn';
                btn.dataset.tabId = tab.id;
                btn.onclick = () => selectTab(tab.id);
                
                btn.innerHTML = `
                    <span class="tab-icon">${tab.icon}</span>
                    <span>${tab.label}</span>
                    <span class="round-indicators">
                        <span class="round-dot" data-round="1"></span>
                        <span class="round-dot" data-round="2"></span>
                        <span class="round-dot" data-round="3"></span>
                    </span>
                `;
                
                nav.appendChild(btn);
            });
        }

        function selectTab(tabId) {
            appState.currentTab = tabId;
            
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tabId === tabId);
            });
            
            renderTabContent();
            updateControlPanel();
        }

        function renderTabContent() {
            const roundKey = `round${appState.currentRound}`;
            const tabContent = appState.topicData.content[roundKey][appState.currentTab];
            const tabState = appState.tabStates[appState.currentTab];
            
            const contentArea = document.getElementById('contentArea');
            
            let html = `
                <div class="content-header">
                    <h2>${tabContent.title}</h2>
                    <p class="instructions">${tabContent.instructions}</p>
                </div>
                <div class="cloze-container">
            `;
            
            tabContent.sentences.forEach((sentence, sIndex) => {
                html += `<div class="cloze-sentence">${renderSentence(sentence, sIndex, tabState)}</div>`;
            });
            
            html += '</div>';
            contentArea.innerHTML = html;
            
            // Attach event listeners
            attachDropdownListeners();
        }

        function renderSentence(sentence, sIndex, tabState) {
            let text = sentence.text;
            
            // Replace {{placeholder}} with dropdowns
            Object.keys(sentence.questions).forEach(qId => {
                const question = sentence.questions[qId];
                const fullId = `${sIndex}-${qId}`;
                const currentValue = tabState.selections[fullId] || '';
                const result = tabState.results[fullId];
                
                let stateClass = '';
                if (tabState.submitted) {
                    stateClass = result === true ? 'correct' : result === false ? 'incorrect' : '';
                } else if (currentValue) {
                    stateClass = 'filled';
                }
                
                // Build options
                const options = [question.correct, ...question.distractors];
                const shuffled = shuffleArray([...options], fullId);
                
                let optionsHtml = '<option value="">Select...</option>';
                shuffled.forEach(opt => {
                    const selected = currentValue === opt ? 'selected' : '';
                    optionsHtml += `<option value="${escapeHtml(opt)}" ${selected}>${escapeHtml(opt)}</option>`;
                });
                
                const dropdown = `
                    <span class="cloze-dropdown">
                        <select class="${stateClass}" 
                                data-question-id="${fullId}" 
                                data-concept="${question.concept}"
                                data-correct="${escapeHtml(question.correct)}"
                                data-tooltip="${escapeHtml(question.tooltip)}">
                            ${optionsHtml}
                        </select>
                    </span>
                `;
                
                text = text.replace(`{{${qId}}}`, dropdown);
            });
            
            return text;
        }

        function attachDropdownListeners() {
            document.querySelectorAll('.cloze-dropdown select').forEach(select => {
                select.addEventListener('change', onDropdownChange);
                select.addEventListener('mouseenter', onDropdownHover);
                select.addEventListener('mouseleave', hideTooltip);
            });
        }

        function onDropdownChange(e) {
            const select = e.target;
            const qId = select.dataset.questionId;
            const value = select.value;
            
            appState.tabStates[appState.currentTab].selections[qId] = value;
            
            // Update visual state
            if (!appState.tabStates[appState.currentTab].submitted) {
                select.className = value ? 'filled' : '';
            }
            
            updateControlPanel();
        }

        let tooltipTimeout = null;
        
        function onDropdownHover(e) {
            const select = e.target;
            const tabState = appState.tabStates[appState.currentTab];
            
            // Only show tooltip for incorrect answers
            if (!tabState.submitted) return;
            const qId = select.dataset.questionId;
            if (tabState.results[qId] !== false) return;
            
            tooltipTimeout = setTimeout(() => {
                showTooltip(select, select.dataset.tooltip);
            }, 1200);
        }

        function showTooltip(element, text) {
            const tooltip = document.getElementById('tooltip');
            const rect = element.getBoundingClientRect();
            
            tooltip.textContent = text;
            tooltip.style.left = `${rect.left}px`;
            tooltip.style.top = `${rect.top - 40}px`;
            tooltip.classList.add('visible');
        }

        function hideTooltip() {
            clearTimeout(tooltipTimeout);
            document.getElementById('tooltip').classList.remove('visible');
        }

        // ============================================
        // SUBMISSION & GRADING
        // ============================================
        function submitAnswers() {
            const tabState = appState.tabStates[appState.currentTab];
            const roundKey = `round${appState.currentRound}`;
            const tabContent = appState.topicData.content[roundKey][appState.currentTab];
            
            let correct = 0;
            let total = 0;
            
            tabContent.sentences.forEach((sentence, sIndex) => {
                Object.keys(sentence.questions).forEach(qId => {
                    const fullId = `${sIndex}-${qId}`;
                    const question = sentence.questions[qId];
                    const userAnswer = tabState.selections[fullId];
                    
                    total++;
                    const isCorrect = userAnswer === question.correct;
                    tabState.results[fullId] = isCorrect;
                    
                    if (isCorrect) correct++;
                });
            });
            
            tabState.submitted = true;
            tabState.attempts++;
            
            // Update visuals
            document.querySelectorAll('.cloze-dropdown select').forEach(select => {
                const qId = select.dataset.questionId;
                const result = tabState.results[qId];
                select.className = result === true ? 'correct' : result === false ? 'incorrect' : '';
            });
            
            // Check if complete
            if (correct === total) {
                tabState.complete = true;
                showToast(`Perfect! ${correct}/${total} correct`, 'success');
            } else {
                showToast(`${correct}/${total} correct - hover incorrect for hints`, 'error');
            }
            
            updateControlPanel();
            document.getElementById('submitBtn').textContent = 'Resubmit';
        }

        function resetSection() {
            const tabState = appState.tabStates[appState.currentTab];
            tabState.selections = {};
            tabState.results = {};
            tabState.submitted = false;
            
            renderTabContent();
            updateControlPanel();
            document.getElementById('submitBtn').textContent = 'Submit';
        }

        // ============================================
        // UI UPDATES
        // ============================================
        function updateHeaderInfo() {
            document.getElementById('roundBadge').textContent = `Round ${appState.currentRound} of 3`;
        }

        function updateControlPanel() {
            const tabState = appState.tabStates[appState.currentTab];
            const roundKey = `round${appState.currentRound}`;
            const tabContent = appState.topicData.content[roundKey][appState.currentTab];
            
            // Count questions and correct answers
            let total = 0;
            let correct = 0;
            let filled = 0;
            
            tabContent.sentences.forEach((sentence, sIndex) => {
                Object.keys(sentence.questions).forEach(qId => {
                    const fullId = `${sIndex}-${qId}`;
                    total++;
                    if (tabState.selections[fullId]) filled++;
                    if (tabState.results[fullId] === true) correct++;
                });
            });
            
            document.getElementById('tabScore').textContent = tabState.submitted ? `${correct}/${total}` : `0/${total}`;
            document.getElementById('attemptDisplay').textContent = `Attempt ${tabState.attempts + (tabState.submitted ? 0 : 1)}`;
            document.getElementById('submitBtn').disabled = filled < total;
        }

        function showToast(message, type = 'info') {
            const toast = document.getElementById('feedbackToast');
            toast.textContent = message;
            toast.className = `feedback-toast visible ${type}`;
            
            setTimeout(() => {
                toast.classList.remove('visible');
            }, 3000);
        }

        // ============================================
        // UTILITIES
        // ============================================
        function shuffleArray(array, seed) {
            // Seeded shuffle for consistent randomization per question
            const seedNum = seed.split('').reduce((a, b) => a + b.charCodeAt(0), 0);
            let m = array.length, t, i;
            let random = seedNum;
            
            while (m) {
                random = (random * 9301 + 49297) % 233280;
                i = Math.floor((random / 233280) * m--);
                t = array[m];
                array[m] = array[i];
                array[i] = t;
            }
            
            return array;
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ============================================
        // DEBUG MODE (q+w+e)
        // ============================================
        let debugKeys = { q: false, w: false, e: false };
        
        document.addEventListener('keydown', (e) => {
            if (e.key in debugKeys) {
                debugKeys[e.key] = true;
                if (debugKeys.q && debugKeys.w && debugKeys.e) {
                    activateDebugMode();
                }
            }
        });
        
        document.addEventListener('keyup', (e) => {
            if (e.key in debugKeys) {
                debugKeys[e.key] = false;
            }
        });
        
        function activateDebugMode() {
            console.log('Debug mode activated');
            document.querySelectorAll('.cloze-dropdown select').forEach(select => {
                select.value = select.dataset.correct;
                select.dispatchEvent(new Event('change'));
            });
            showToast('Debug: All answers filled', 'success');
        }

        // ============================================
        // INIT
        // ============================================
        initApp();
    </script>
</body>
</html>