<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>YouCantFakeThis - Educational Review Platform</title>
  <style>
    :root {
      --primary: #667eea;
      --secondary: #764ba2;
      --gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      --success: #10b981;
      --error: #ef4444;
      --warning: #f59e0b;
      --bg: #f8fafc;
      --bg-card: #ffffff;
      --text: #1e293b;
      --text-muted: #64748b;
      --border: #e2e8f0;
      --unfilled: #fffacd;
      --filled: #add8e6;
      --correct: #90ee90;
      --incorrect: #ffcccb;
      --radius: 8px;
      --shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    /* Header */
    .header {
      background: var(--gradient);
      color: white;
      padding: 8px 16px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 8px;
      min-height: 48px;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .logo {
      font-weight: 700;
      font-size: 1.1rem;
      white-space: nowrap;
    }

    .header-info {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 0.85rem;
      opacity: 0.95;
    }

    .header-info span {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn {
      padding: 6px 12px;
      border: none;
      border-radius: var(--radius);
      cursor: pointer;
      font-size: 0.85rem;
      font-weight: 500;
      transition: all 0.2s;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .btn-primary {
      background: white;
      color: var(--primary);
    }

    .btn-primary:hover {
      background: #f1f5f9;
    }

    .btn-secondary {
      background: rgba(255,255,255,0.2);
      color: white;
    }

    .btn-secondary:hover {
      background: rgba(255,255,255,0.3);
    }

    .btn-success {
      background: var(--success);
      color: white;
    }

    .btn-success:hover {
      background: #059669;
    }

    .btn-danger {
      background: var(--error);
      color: white;
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    /* Main Layout */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* Navigation Breadcrumb */
    .nav-bar {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      padding: 8px 16px;
    }

    .breadcrumb {
      display: flex;
      align-items: center;
      gap: 4px;
      flex-wrap: wrap;
      font-size: 0.9rem;
    }

    .breadcrumb-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .breadcrumb-item select {
      padding: 4px 8px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: white;
      font-size: 0.85rem;
      cursor: pointer;
      max-width: 180px;
    }

    .breadcrumb-item select:disabled {
      background: #f1f5f9;
      cursor: not-allowed;
    }

    .breadcrumb-sep {
      color: var(--text-muted);
      font-size: 0.8rem;
    }

    .load-btn {
      margin-left: 8px;
    }

    /* Tabs */
    .tabs-container {
      background: var(--bg-card);
      border-bottom: 1px solid var(--border);
      padding: 0 16px;
      display: none;
    }

    .tabs-container.active {
      display: block;
    }

    .tabs {
      display: flex;
      gap: 4px;
      overflow-x: auto;
    }

    .tab {
      padding: 10px 16px;
      border: none;
      background: none;
      cursor: pointer;
      font-size: 0.85rem;
      color: var(--text-muted);
      border-bottom: 2px solid transparent;
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
      transition: all 0.2s;
    }

    .tab:hover {
      color: var(--text);
    }

    .tab.active {
      color: var(--primary);
      border-bottom-color: var(--primary);
    }

    .tab-icon {
      font-weight: 600;
    }

    .tab-progress {
      display: flex;
      gap: 3px;
      margin-left: 4px;
    }

    .progress-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--border);
    }

    .progress-dot.complete {
      background: var(--success);
    }

    .progress-dot.current {
      background: var(--primary);
    }

    /* Content Area */
    .content {
      flex: 1;
      overflow-y: auto;
      padding: 16px;
    }

    .welcome-screen, .state-select-screen, .topic-content, .review-screen {
      max-width: 900px;
      margin: 0 auto;
    }

    /* State Selection */
    .state-select-screen {
      text-align: center;
      padding: 40px 20px;
    }

    .state-select-screen h1 {
      font-size: 1.8rem;
      margin-bottom: 8px;
    }

    .state-select-screen p {
      color: var(--text-muted);
      margin-bottom: 24px;
    }

    .state-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      max-width: 600px;
      margin: 0 auto;
    }

    .state-card {
      background: var(--bg-card);
      border: 2px solid var(--border);
      border-radius: var(--radius);
      padding: 20px;
      cursor: pointer;
      transition: all 0.2s;
    }

    .state-card:hover {
      border-color: var(--primary);
      box-shadow: var(--shadow);
    }

    .state-card.disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }

    .state-card .icon {
      font-size: 2rem;
      margin-bottom: 8px;
    }

    .state-card .name {
      font-weight: 600;
      font-size: 1.1rem;
    }

    .state-card .region {
      font-size: 0.85rem;
      color: var(--text-muted);
    }

    /* Welcome Screen */
    .welcome-screen {
      text-align: center;
      padding: 40px 20px;
    }

    .welcome-screen h2 {
      font-size: 1.5rem;
      margin-bottom: 8px;
    }

    .welcome-screen p {
      color: var(--text-muted);
    }

    /* Topic Content */
    .topic-content {
      display: none;
    }

    .topic-content.active {
      display: block;
    }

    .section-title {
      font-size: 1.1rem;
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--primary);
    }

    .section-instructions {
      color: var(--text-muted);
      font-size: 0.9rem;
      margin-bottom: 16px;
    }

    .sentence {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 12px 16px;
      margin-bottom: 12px;
      line-height: 1.8;
      font-size: 0.95rem;
    }

    .cloze-dropdown {
      padding: 4px 8px;
      border: 1px solid var(--border);
      border-radius: 4px;
      font-size: 0.9rem;
      cursor: pointer;
      background: var(--unfilled);
      transition: all 0.2s;
      min-width: 120px;
      max-width: 200px;
    }

    .cloze-dropdown.filled {
      background: var(--filled);
    }

    .cloze-dropdown.correct {
      background: var(--correct);
      border-color: var(--success);
    }

    .cloze-dropdown.incorrect {
      background: var(--incorrect);
      border-color: var(--error);
    }

    .feedback-inline {
      display: none;
      background: #fef2f2;
      border: 1px solid #fecaca;
      border-radius: 4px;
      padding: 8px 12px;
      margin-top: 8px;
      font-size: 0.85rem;
    }

    .feedback-inline.show {
      display: block;
    }

    .feedback-inline .error-label {
      color: var(--error);
      font-weight: 600;
    }

    .feedback-inline .fix {
      color: var(--text);
      margin-top: 4px;
    }

    .feedback-inline .action {
      color: var(--text-muted);
      font-style: italic;
      margin-top: 4px;
    }

    /* Control Panel */
    .control-panel {
      background: var(--bg-card);
      border-top: 1px solid var(--border);
      padding: 12px 16px;
      display: none;
    }

    .control-panel.active {
      display: block;
    }

    .control-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
      max-width: 900px;
      margin: 0 auto;
    }

    .control-left {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .control-center {
      display: flex;
      align-items: center;
      gap: 16px;
      font-size: 0.9rem;
    }

    .score-display {
      font-weight: 600;
    }

    .attempt-display {
      color: var(--text-muted);
    }

    .control-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .feedback-summary {
      font-size: 0.85rem;
      color: var(--text-muted);
      margin-top: 8px;
      text-align: center;
    }

    .feedback-summary.success {
      color: var(--success);
    }

    .feedback-summary.error {
      color: var(--error);
    }

    /* Review Screen */
    .review-screen {
      display: none;
      padding: 20px;
    }

    .review-screen.active {
      display: block;
    }

    .review-header {
      text-align: center;
      margin-bottom: 24px;
    }

    .review-header h2 {
      font-size: 1.5rem;
      margin-bottom: 8px;
    }

    .review-score {
      font-size: 2rem;
      font-weight: 700;
      color: var(--primary);
    }

    .review-tabs {
      display: flex;
      gap: 8px;
      justify-content: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
    }

    .review-tab {
      padding: 6px 12px;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: white;
      cursor: pointer;
      font-size: 0.85rem;
    }

    .review-tab.active {
      background: var(--primary);
      color: white;
      border-color: var(--primary);
    }

    .review-section {
      background: var(--bg-card);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      padding: 16px;
      margin-bottom: 12px;
    }

    .review-section h3 {
      font-size: 1rem;
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .review-section.success h3 {
      color: var(--success);
    }

    .review-section.error h3 {
      color: var(--error);
    }

    .error-count {
      background: var(--error);
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.75rem;
    }

    .review-detail {
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    .review-actions {
      display: flex;
      gap: 12px;
      justify-content: center;
      margin-top: 24px;
    }

    /* Utilities Panel */
    .utilities-panel {
      position: fixed;
      top: 0;
      right: -320px;
      width: 320px;
      height: 100%;
      background: var(--bg-card);
      box-shadow: -4px 0 20px rgba(0,0,0,0.1);
      transition: right 0.3s;
      z-index: 1000;
      display: flex;
      flex-direction: column;
    }

    .utilities-panel.open {
      right: 0;
    }

    .utilities-header {
      padding: 16px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .utilities-header h3 {
      font-size: 1.1rem;
    }

    .close-btn {
      background: none;
      border: none;
      font-size: 1.5rem;
      cursor: pointer;
      color: var(--text-muted);
    }

    .utilities-content {
      padding: 16px;
      flex: 1;
      overflow-y: auto;
    }

    .utility-section {
      margin-bottom: 20px;
    }

    .utility-section h4 {
      font-size: 0.9rem;
      color: var(--text-muted);
      margin-bottom: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .utility-btn {
      width: 100%;
      padding: 10px 12px;
      margin-bottom: 8px;
      text-align: left;
    }

    .utility-btn.confirm {
      background: var(--warning);
      color: white;
    }

    .overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.3);
      z-index: 999;
      display: none;
    }

    .overlay.show {
      display: block;
    }

    /* Toast */
    .toast {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%) translateY(100px);
      background: var(--text);
      color: white;
      padding: 12px 24px;
      border-radius: var(--radius);
      font-size: 0.9rem;
      z-index: 2000;
      opacity: 0;
      transition: all 0.3s;
    }

    .toast.show {
      transform: translateX(-50%) translateY(0);
      opacity: 1;
    }

    /* Tooltip */
    .tooltip {
      position: fixed;
      background: var(--text);
      color: white;
      padding: 8px 12px;
      border-radius: var(--radius);
      font-size: 0.8rem;
      max-width: 250px;
      z-index: 3000;
      pointer-events: none;
      opacity: 0;
      transition: opacity 0.2s;
    }

    .tooltip.show {
      opacity: 1;
    }

    .tooltip::before {
      content: '';
      position: absolute;
      bottom: -6px;
      left: 50%;
      transform: translateX(-50%);
      border-left: 6px solid transparent;
      border-right: 6px solid transparent;
      border-top: 6px solid var(--text);
    }

    /* Loading */
    .loading {
      text-align: center;
      padding: 40px;
      color: var(--text-muted);
    }

    .spinner {
      width: 40px;
      height: 40px;
      border: 3px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 16px;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 600px) {
      .header {
        padding: 8px 12px;
      }
      
      .header-info {
        display: none;
      }

      .breadcrumb-item select {
        max-width: 120px;
      }

      .tabs {
        gap: 0;
      }

      .tab {
        padding: 8px 12px;
        font-size: 0.8rem;
      }

      .tab-label {
        display: none;
      }

      .control-row {
        flex-direction: column;
        align-items: stretch;
      }

      .control-center {
        justify-content: center;
      }

      .control-right {
        justify-content: center;
      }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header class="header">
    <div class="header-left">
      <div class="logo">üìö YouCantFakeThis</div>
      <div class="header-info" id="headerInfo">
        <span id="roundDisplay"></span>
        <span id="totalScoreDisplay"></span>
      </div>
    </div>
    <div class="header-right">
      <button class="btn btn-secondary" id="reviewBtn" style="display:none;">Review</button>
      <button class="btn btn-secondary" id="utilitiesBtn">‚öôÔ∏è</button>
    </div>
  </header>

  <!-- Navigation -->
  <nav class="nav-bar" id="navBar" style="display:none;">
    <div class="breadcrumb" id="breadcrumb"></div>
  </nav>

  <!-- Tabs -->
  <div class="tabs-container" id="tabsContainer">
    <div class="tabs" id="tabs"></div>
  </div>

  <!-- Main Content -->
  <main class="main">
    <div class="content" id="content">
      <!-- State Selection Screen -->
      <div class="state-select-screen" id="stateSelectScreen">
        <h1>Welcome to YouCantFakeThis</h1>
        <p>Select your curriculum to get started</p>
        <div class="state-grid" id="stateGrid"></div>
      </div>

      <!-- Welcome Screen (after state selected) -->
      <div class="welcome-screen" id="welcomeScreen" style="display:none;">
        <h2>Select a Topic</h2>
        <p>Use the navigation above to choose a subject, unit, area of study, and topic.</p>
      </div>

      <!-- Topic Content -->
      <div class="topic-content" id="topicContent"></div>

      <!-- Review Screen -->
      <div class="review-screen" id="reviewScreen"></div>

      <!-- Loading -->
      <div class="loading" id="loadingScreen" style="display:none;">
        <div class="spinner"></div>
        <p>Loading...</p>
      </div>
    </div>
  </main>

  <!-- Control Panel -->
  <div class="control-panel" id="controlPanel">
    <div class="control-row">
      <div class="control-left">
        <button class="btn btn-secondary" id="resetSectionBtn">Reset Section</button>
      </div>
      <div class="control-center">
        <span class="score-display" id="scoreDisplay">Score: 0/0</span>
        <span class="attempt-display" id="attemptDisplay">Attempt 1</span>
      </div>
      <div class="control-right">
        <button class="btn btn-success" id="submitBtn">Submit</button>
      </div>
    </div>
    <div class="feedback-summary" id="feedbackSummary"></div>
  </div>

  <!-- Utilities Panel -->
  <div class="overlay" id="overlay"></div>
  <div class="utilities-panel" id="utilitiesPanel">
    <div class="utilities-header">
      <h3>Utilities</h3>
      <button class="close-btn" id="closeUtilities">&times;</button>
    </div>
    <div class="utilities-content">
      <div class="utility-section">
        <h4>Current Topic</h4>
        <button class="btn utility-btn" id="resetTopicBtn">Reset Topic Progress</button>
      </div>
      <div class="utility-section">
        <h4>Curriculum</h4>
        <button class="btn utility-btn" id="changeCurriculumBtn">Change Curriculum</button>
        <p style="font-size:0.8rem;color:var(--text-muted);margin-top:4px;">‚ö†Ô∏è Changing curriculum will clear all progress</p>
      </div>
      <div class="utility-section">
        <h4>Data</h4>
        <button class="btn utility-btn" id="exportBtn">Export Progress</button>
        <button class="btn utility-btn" id="clearAllBtn">Clear All Data</button>
      </div>
    </div>
  </div>

  <!-- Toast -->
  <div class="toast" id="toast"></div>

  <!-- Tooltip -->
  <div class="tooltip" id="tooltip"></div>

  <script>
    // ==================== APP STATE ====================
    const APP = {
      // Data
      states: null,
      studyManifest: null,
      topicManifest: null,
      topicData: null,
      
      // Current selections
      currentState: null,
      currentSubject: null,
      currentUnit: null,
      currentAOS: null,
      currentTopic: null,
      
      // Topic state
      currentRound: 1,
      currentTab: null,
      tabStates: {},
      errorTracking: {},
      
      // UI state
      submitted: false,
      tooltipTimeout: null,
      
      // Base path for JSON files (adjust as needed)
      basePath: './'
    };

    // ==================== LOCAL STORAGE ====================
    const Storage = {
      prefix: 'ycft_',
      
      get(key) {
        try {
          const item = localStorage.getItem(this.prefix + key);
          return item ? JSON.parse(item) : null;
        } catch { return null; }
      },
      
      set(key, value) {
        try {
          localStorage.setItem(this.prefix + key, JSON.stringify(value));
        } catch (e) {
          console.error('Storage error:', e);
        }
      },
      
      remove(key) {
        localStorage.removeItem(this.prefix + key);
      },
      
      getTopicKey(topicId) {
        return `${APP.currentState}_${APP.currentSubject}_${topicId}`;
      },
      
      saveTopicProgress(topicId, data) {
        this.set(`topic_${this.getTopicKey(topicId)}`, data);
      },
      
      loadTopicProgress(topicId) {
        return this.get(`topic_${this.getTopicKey(topicId)}`);
      },
      
      clearTopicProgress(topicId) {
        this.remove(`topic_${this.getTopicKey(topicId)}`);
      },
      
      clearAll() {
        const keys = [];
        for (let i = 0; i < localStorage.length; i++) {
          const key = localStorage.key(i);
          if (key.startsWith(this.prefix)) {
            keys.push(key);
          }
        }
        keys.forEach(k => localStorage.removeItem(k));
      }
    };

    // ==================== UTILITIES ====================
    function showToast(message, duration = 3000) {
      const toast = document.getElementById('toast');
      toast.textContent = message;
      toast.classList.add('show');
      setTimeout(() => toast.classList.remove('show'), duration);
    }

    function showLoading(show) {
      document.getElementById('loadingScreen').style.display = show ? 'block' : 'none';
    }

    async function fetchJSON(path) {
      try {
        const response = await fetch(APP.basePath + path);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);
        return await response.json();
      } catch (e) {
        console.error('Fetch error:', path, e);
        return null;
      }
    }

    function shuffleArray(arr) {
      const shuffled = [...arr];
      for (let i = shuffled.length - 1; i > 0; i--) {
        const j = Math.floor(Math.random() * (i + 1));
        [shuffled[i], shuffled[j]] = [shuffled[j], shuffled[i]];
      }
      return shuffled;
    }

    // ==================== INITIALIZATION ====================
    async function init() {
      // Load states
      APP.states = await fetchJSON('states.json');
      if (!APP.states) {
        document.getElementById('stateGrid').innerHTML = '<p style="color:var(--error)">Failed to load curriculum data. Please check that states.json exists.</p>';
        return;
      }
      
      // Check for saved state
      const savedState = Storage.get('currentState');
      if (savedState) {
        await selectState(savedState, true);
      } else {
        renderStateSelection();
      }
      
      // Setup event listeners
      setupEventListeners();
      
      // EASTER EGG: Debug mode with q+w+e
      const debugKeys = new Set();
      document.addEventListener('keydown', e => {
        debugKeys.add(e.key.toLowerCase());
        if (debugKeys.has('q') && debugKeys.has('w') && debugKeys.has('e')) {
          activateDebugMode();
        }
      });
      document.addEventListener('keyup', e => debugKeys.delete(e.key.toLowerCase()));
    }

    function setupEventListeners() {
      // Utilities panel
      document.getElementById('utilitiesBtn').onclick = () => toggleUtilities(true);
      document.getElementById('closeUtilities').onclick = () => toggleUtilities(false);
      document.getElementById('overlay').onclick = () => toggleUtilities(false);
      
      // Utility buttons
      document.getElementById('resetSectionBtn').onclick = resetSection;
      document.getElementById('resetTopicBtn').onclick = resetTopic;
      document.getElementById('changeCurriculumBtn').onclick = changeCurriculum;
      document.getElementById('exportBtn').onclick = exportProgress;
      document.getElementById('clearAllBtn').onclick = clearAllData;
      
      // Submit button
      document.getElementById('submitBtn').onclick = submitAnswers;
      
      // Review button
      document.getElementById('reviewBtn').onclick = () => showReview();
      
      // Keyboard shortcuts
      document.addEventListener('keydown', e => {
        if (e.key === 'Escape') toggleUtilities(false);
        if (e.key === 'Enter' && e.ctrlKey) submitAnswers();
      });
      
      // Tooltip handling
      document.addEventListener('mousemove', () => {
        clearTimeout(APP.tooltipTimeout);
        document.getElementById('tooltip').classList.remove('show');
      });
    }

    function toggleUtilities(open) {
      document.getElementById('utilitiesPanel').classList.toggle('open', open);
      document.getElementById('overlay').classList.toggle('show', open);
    }

    // ==================== STATE SELECTION ====================
    function renderStateSelection() {
      const grid = document.getElementById('stateGrid');
      grid.innerHTML = APP.states.states.map(state => `
        <div class="state-card ${state.active ? '' : 'disabled'}" 
             data-state-id="${state.id}" 
             onclick="${state.active ? `selectState('${state.id}')` : ''}">
          <div class="icon">${state.icon}</div>
          <div class="name">${state.name}</div>
          <div class="region">${state.region}</div>
          ${!state.active ? '<div style="font-size:0.8rem;color:var(--warning);margin-top:4px;">Coming Soon</div>' : ''}
        </div>
      `).join('');
    }

    async function selectState(stateId, isReload = false) {
      const state = APP.states.states.find(s => s.id === stateId);
      if (!state || !state.active) return;
      
      APP.currentState = stateId;
      Storage.set('currentState', stateId);
      
      // Load study manifest
      showLoading(true);
      APP.studyManifest = await fetchJSON(state.path);
      showLoading(false);
      
      if (!APP.studyManifest) {
        showToast('Failed to load curriculum data');
        return;
      }
      
      // Hide state selection, show navigation
      document.getElementById('stateSelectScreen').style.display = 'none';
      document.getElementById('navBar').style.display = 'block';
      document.getElementById('welcomeScreen').style.display = 'block';
      
      // Render breadcrumb
      renderBreadcrumb();
      
      // Restore previous selections if reloading
      if (isReload) {
        const savedSubject = Storage.get('currentSubject');
        if (savedSubject) {
          await selectSubject(savedSubject);
        }
      }
    }

    // ==================== NAVIGATION ====================
    function renderBreadcrumb() {
      const bc = document.getElementById('breadcrumb');
      
      // State display
      const state = APP.states.states.find(s => s.id === APP.currentState);
      
      let html = `
        <div class="breadcrumb-item">
          <span>${state.icon} ${state.name}</span>
        </div>
        <span class="breadcrumb-sep">‚Ä∫</span>
        <div class="breadcrumb-item">
          <select id="subjectSelect" onchange="selectSubject(this.value)">
            <option value="">Select Subject</option>
            ${APP.studyManifest.subjects.map(s => 
              `<option value="${s.id}" ${s.status !== 'available' ? 'disabled' : ''} ${APP.currentSubject === s.id ? 'selected' : ''}>
                ${s.icon} ${s.name}${s.status !== 'available' ? ' (Coming Soon)' : ''}
              </option>`
            ).join('')}
          </select>
        </div>
      `;
      
      // Unit select
      if (APP.currentSubject && APP.topicManifest) {
        html += `
          <span class="breadcrumb-sep">‚Ä∫</span>
          <div class="breadcrumb-item">
            <select id="unitSelect" onchange="selectUnit(this.value)">
              <option value="">Select Unit</option>
              ${APP.topicManifest.units.map(u => 
                `<option value="${u.id}" ${APP.currentUnit === u.id ? 'selected' : ''}>${u.code}</option>`
              ).join('')}
            </select>
          </div>
        `;
      }
      
      // AOS select
      if (APP.currentUnit) {
        const unit = APP.topicManifest.units.find(u => u.id === APP.currentUnit);
        if (unit) {
          html += `
            <span class="breadcrumb-sep">‚Ä∫</span>
            <div class="breadcrumb-item">
              <select id="aosSelect" onchange="selectAOS(this.value)">
                <option value="">Select AOS</option>
                ${unit.areasOfStudy.map(a => 
                  `<option value="${a.id}" ${APP.currentAOS === a.id ? 'selected' : ''}>${a.code}</option>`
                ).join('')}
              </select>
            </div>
          `;
        }
      }
      
      // Topic select
      if (APP.currentAOS) {
        const unit = APP.topicManifest.units.find(u => u.id === APP.currentUnit);
        const aos = unit?.areasOfStudy.find(a => a.id === APP.currentAOS);
        if (aos) {
          html += `
            <span class="breadcrumb-sep">‚Ä∫</span>
            <div class="breadcrumb-item">
              <select id="topicSelect" onchange="selectTopicFromMenu(this.value)">
                <option value="">Select Topic</option>
                ${aos.topics.map(t => 
                  `<option value="${t.id}" ${t.status !== 'available' ? 'disabled' : ''} ${APP.currentTopic === t.id ? 'selected' : ''}>
                    ${t.code}. ${t.name}${t.status !== 'available' ? ' (Coming Soon)' : ''}
                  </option>`
                ).join('')}
              </select>
            </div>
            <button class="btn btn-primary load-btn" id="loadTopicBtn" onclick="loadSelectedTopic()" 
                    ${!APP.currentTopic ? 'disabled' : ''}>Load Topic</button>
          `;
        }
      }
      
      bc.innerHTML = html;
    }

    async function selectSubject(subjectId) {
      if (!subjectId) return;
      
      APP.currentSubject = subjectId;
      APP.currentUnit = null;
      APP.currentAOS = null;
      APP.currentTopic = null;
      
      Storage.set('currentSubject', subjectId);
      
      // Load topic manifest
      const subject = APP.studyManifest.subjects.find(s => s.id === subjectId);
      if (!subject) return;
      
      showLoading(true);
      APP.topicManifest = await fetchJSON(`${APP.currentState}/${subject.path}`);
      showLoading(false);
      
      if (!APP.topicManifest) {
        showToast('Failed to load subject data');
        return;
      }
      
      // Update theme colors
      if (APP.topicManifest.colorTheme) {
        document.documentElement.style.setProperty('--primary', APP.topicManifest.colorTheme.primary);
        document.documentElement.style.setProperty('--secondary', APP.topicManifest.colorTheme.secondary);
        document.documentElement.style.setProperty('--gradient', APP.topicManifest.colorTheme.gradient);
        document.querySelector('.header').style.background = APP.topicManifest.colorTheme.gradient;
      }
      
      renderBreadcrumb();
    }

    function selectUnit(unitId) {
      APP.currentUnit = unitId || null;
      APP.currentAOS = null;
      APP.currentTopic = null;
      renderBreadcrumb();
    }

    function selectAOS(aosId) {
      APP.currentAOS = aosId || null;
      APP.currentTopic = null;
      renderBreadcrumb();
    }

    function selectTopicFromMenu(topicId) {
      APP.currentTopic = topicId || null;
      const btn = document.getElementById('loadTopicBtn');
      if (btn) btn.disabled = !topicId;
    }

    async function loadSelectedTopic() {
      if (!APP.currentTopic) return;
      
      const unit = APP.topicManifest.units.find(u => u.id === APP.currentUnit);
      const aos = unit?.areasOfStudy.find(a => a.id === APP.currentAOS);
      const topic = aos?.topics.find(t => t.id === APP.currentTopic);
      
      if (!topic || topic.status !== 'available') {
        showToast('Topic not available');
        return;
      }
      
      // Load topic data
      showLoading(true);
      const subject = APP.studyManifest.subjects.find(s => s.id === APP.currentSubject);
      APP.topicData = await fetchJSON(`${APP.currentState}/${APP.currentSubject}/${topic.filename}`);
      showLoading(false);
      
      if (!APP.topicData) {
        showToast('Failed to load topic');
        return;
      }
      
      // Load saved progress
      const savedProgress = Storage.loadTopicProgress(APP.topicData.metadata.id);
      if (savedProgress) {
        APP.currentRound = savedProgress.currentRound || 1;
        APP.tabStates = savedProgress.tabStates || {};
        APP.errorTracking = savedProgress.errorTracking || {};
      } else {
        APP.currentRound = 1;
        APP.tabStates = {};
        APP.errorTracking = {};
      }
      
      // Initialize tab states for current round
      APP.topicData.tabs.forEach(tab => {
        const key = `round${APP.currentRound}_${tab.id}`;
        if (!APP.tabStates[key]) {
          APP.tabStates[key] = {
            selections: {},
            results: {},
            submitted: false,
            attempts: 0,
            bestScore: 0,
            complete: false
          };
        }
      });
      
      // Set first tab
      APP.currentTab = APP.topicData.tabs[0].id;
      
      // Render
      document.getElementById('welcomeScreen').style.display = 'none';
      document.getElementById('reviewScreen').classList.remove('active');
      document.getElementById('reviewScreen').style.display = ''; // Clear any inline style
      document.getElementById('tabsContainer').classList.add('active');
      document.getElementById('controlPanel').classList.add('active');
      document.getElementById('reviewBtn').style.display = 'inline-flex';
      
      renderTabs();
      renderContent();
      updateHeader();
    }

    // ==================== TABS ====================
    function renderTabs() {
      const tabsEl = document.getElementById('tabs');
      
      tabsEl.innerHTML = APP.topicData.tabs.map(tab => {
        const isActive = tab.id === APP.currentTab;
        
        // Calculate progress dots
        const dots = [1, 2, 3].map(round => {
          const key = `round${round}_${tab.id}`;
          const state = APP.tabStates[key];
          if (state?.complete) return 'complete';
          if (round === APP.currentRound && tab.id === APP.currentTab) return 'current';
          return '';
        });
        
        return `
          <button class="tab ${isActive ? 'active' : ''}" onclick="switchTab('${tab.id}')">
            <span class="tab-icon">${tab.icon}</span>
            <span class="tab-label">${tab.label}</span>
            <div class="tab-progress">
              ${dots.map(d => `<div class="progress-dot ${d}"></div>`).join('')}
            </div>
          </button>
        `;
      }).join('');
    }

    function switchTab(tabId) {
      APP.currentTab = tabId;
      APP.submitted = false;
      renderTabs();
      renderContent();
      updateControlPanel();
    }

    // ==================== CONTENT RENDERING ====================
    function renderContent() {
      const container = document.getElementById('topicContent');
      container.classList.add('active');
      
      const roundKey = `round${APP.currentRound}`;
      const tabContent = APP.topicData.content[roundKey]?.[APP.currentTab];
      
      if (!tabContent) {
        container.innerHTML = '<p>Content not available for this section.</p>';
        return;
      }
      
      const tabState = getTabState();
      
      let html = `
        <div class="section-title">${tabContent.title}</div>
        <div class="section-instructions">${tabContent.instructions}</div>
      `;
      
      tabContent.sentences.forEach((sentence, sIdx) => {
        html += `<div class="sentence" data-sentence="${sIdx}">`;
        
        // Parse sentence and insert dropdowns
        let text = sentence.text;
        const questionIds = Object.keys(sentence.questions);
        
        questionIds.forEach(qId => {
          const q = sentence.questions[qId];
          const placeholder = `{{${qId}}}`;
          
          // Build options
          const options = shuffleOptionsWithCorrect(q.correct, q.distractors, `${sIdx}_${qId}`);
          const selected = tabState.selections[qId] || '';
          const result = tabState.results[qId];
          
          let selectClass = 'cloze-dropdown';
          if (selected) selectClass += ' filled';
          if (result === true) selectClass += ' correct';
          if (result === false) selectClass += ' incorrect';
          
          const optionsHtml = options.map(opt => 
            `<option value="${opt}" ${selected === opt ? 'selected' : ''}>${opt}</option>`
          ).join('');
          
          const dropdown = `
            <select class="${selectClass}" 
                    data-question="${qId}" 
                    data-concept="${q.concept}"
                    data-correct="${q.correct}"
                    data-tooltip="${q.tooltip}"
                    onchange="handleSelection(this)">
              <option value="">Select...</option>
              ${optionsHtml}
            </select>
          `;
          
          text = text.replace(placeholder, dropdown);
        });
        
        html += text;
        
        // Add inline feedback for incorrect answers
        questionIds.forEach(qId => {
          const q = sentence.questions[qId];
          const result = tabState.results[qId];
          const selected = tabState.selections[qId];
          
          if (result === false && selected) {
            const concept = APP.topicData.concepts[q.concept];
            const wrongFeedback = concept?.wrong?.[selected];
            
            html += `
              <div class="feedback-inline show" data-feedback="${qId}">
                <div class="error-label">‚úó ${concept?.name || q.concept}</div>
                <div class="fix">${wrongFeedback?.fix || concept?.correct || 'Review this concept.'}</div>
                <div class="action">‚Üí ${wrongFeedback?.action || ''}</div>
              </div>
            `;
          }
        });
        
        html += '</div>';
      });
      
      container.innerHTML = html;
      
      // Setup tooltip listeners
      container.querySelectorAll('.cloze-dropdown.incorrect').forEach(el => {
        el.addEventListener('mouseenter', showDropdownTooltip);
      });
      
      updateControlPanel();
    }

    function shuffleOptionsWithCorrect(correct, distractors, seed) {
      // Use seed for consistent shuffling within session
      const all = [correct, ...distractors];
      return shuffleArray(all);
    }

    function handleSelection(select) {
      const qId = select.dataset.question;
      const tabState = getTabState();
      
      tabState.selections[qId] = select.value;
      
      // Update visual state
      if (select.value) {
        select.classList.add('filled');
      } else {
        select.classList.remove('filled');
      }
      
      // Clear previous result if reselecting
      if (tabState.submitted) {
        select.classList.remove('correct', 'incorrect');
        delete tabState.results[qId];
        
        // Hide feedback
        const feedback = document.querySelector(`[data-feedback="${qId}"]`);
        if (feedback) feedback.remove();
      }
      
      saveProgress();
      updateControlPanel();
    }

    function showDropdownTooltip(e) {
      const tooltip = document.getElementById('tooltip');
      const text = e.target.dataset.tooltip;
      
      if (!text) return;
      
      APP.tooltipTimeout = setTimeout(() => {
        tooltip.textContent = text;
        
        const rect = e.target.getBoundingClientRect();
        tooltip.style.left = rect.left + rect.width / 2 + 'px';
        tooltip.style.top = rect.top - 10 + 'px';
        tooltip.style.transform = 'translate(-50%, -100%)';
        
        tooltip.classList.add('show');
      }, 1200);
    }

    // ==================== SUBMISSION ====================
    function submitAnswers() {
      const tabState = getTabState();
      const roundKey = `round${APP.currentRound}`;
      const tabContent = APP.topicData.content[roundKey]?.[APP.currentTab];
      
      if (!tabContent) return;
      
      tabState.attempts++;
      tabState.submitted = true;
      
      let correct = 0;
      let total = 0;
      
      // Grade all questions
      tabContent.sentences.forEach(sentence => {
        Object.entries(sentence.questions).forEach(([qId, q]) => {
          total++;
          const selected = tabState.selections[qId];
          const isCorrect = selected === q.correct;
          
          tabState.results[qId] = isCorrect;
          
          if (isCorrect) {
            correct++;
          } else {
            // Track error
            trackError(q.concept, selected);
          }
        });
      });
      
      // Update score
      const score = correct;
      if (score > tabState.bestScore) {
        tabState.bestScore = score;
      }
      
      // Check if complete
      if (correct === total) {
        tabState.complete = true;
        checkRoundComplete();
      }
      
      saveProgress();
      renderContent();
      updateControlPanel();
      
      // Show feedback summary
      const summary = document.getElementById('feedbackSummary');
      if (correct === total) {
        summary.textContent = 'All correct.';
        summary.className = 'feedback-summary success';
      } else {
        summary.textContent = `${correct}/${total} correct. Hover over incorrect answers for hints.`;
        summary.className = 'feedback-summary error';
      }
    }

    function trackError(conceptId, wrongAnswer) {
      if (!APP.errorTracking[conceptId]) {
        APP.errorTracking[conceptId] = {
          count: 0,
          rounds: [],
          wrongAnswers: []
        };
      }
      
      APP.errorTracking[conceptId].count++;
      if (!APP.errorTracking[conceptId].rounds.includes(APP.currentRound)) {
        APP.errorTracking[conceptId].rounds.push(APP.currentRound);
      }
      APP.errorTracking[conceptId].wrongAnswers.push(wrongAnswer);
    }

    function checkRoundComplete() {
      // Check if all tabs in current round are complete
      const allComplete = APP.topicData.tabs.every(tab => {
        const key = `round${APP.currentRound}_${tab.id}`;
        return APP.tabStates[key]?.complete;
      });
      
      if (allComplete) {
        if (APP.currentRound < 3) {
          showToast(`Round ${APP.currentRound} complete. Moving to Round ${APP.currentRound + 1}`);
          APP.currentRound++;
          
          // Initialize new round tab states
          APP.topicData.tabs.forEach(tab => {
            const key = `round${APP.currentRound}_${tab.id}`;
            if (!APP.tabStates[key]) {
              APP.tabStates[key] = {
                selections: {},
                results: {},
                submitted: false,
                attempts: 0,
                bestScore: 0,
                complete: false
              };
            }
          });
          
          saveProgress();
          renderTabs();
          renderContent();
          updateHeader();
        } else {
          showToast('Topic complete. View your review.');
          showReview();
        }
      }
    }

    // ==================== CONTROL PANEL ====================
    function updateControlPanel() {
      const tabState = getTabState();
      const roundKey = `round${APP.currentRound}`;
      const tabContent = APP.topicData.content[roundKey]?.[APP.currentTab];
      
      if (!tabContent) return;
      
      // Count questions
      let total = 0;
      tabContent.sentences.forEach(s => {
        total += Object.keys(s.questions).length;
      });
      
      // Count correct
      let correct = 0;
      Object.values(tabState.results).forEach(r => {
        if (r === true) correct++;
      });
      
      document.getElementById('scoreDisplay').textContent = `Score: ${correct}/${total}`;
      document.getElementById('attemptDisplay').textContent = `Attempt ${tabState.attempts || 1}`;
      
      // Update submit button
      const submitBtn = document.getElementById('submitBtn');
      if (tabState.complete) {
        submitBtn.textContent = '‚úì Complete';
        submitBtn.disabled = true;
      } else if (tabState.submitted) {
        submitBtn.textContent = 'Resubmit';
        submitBtn.disabled = false;
      } else {
        submitBtn.textContent = 'Submit';
        submitBtn.disabled = false;
      }
    }

    function updateHeader() {
      document.getElementById('roundDisplay').textContent = `Round ${APP.currentRound}/3`;
      
      // Calculate total score
      let totalCorrect = 0;
      let totalQuestions = 0;
      
      Object.entries(APP.tabStates).forEach(([key, state]) => {
        if (key.startsWith('round')) {
          totalCorrect += state.bestScore || 0;
          // Count questions for that tab
          const [, round, tab] = key.match(/round(\d)_(.+)/) || [];
          if (round && tab) {
            const content = APP.topicData.content[`round${round}`]?.[tab];
            if (content) {
              content.sentences.forEach(s => {
                totalQuestions += Object.keys(s.questions).length;
              });
            }
          }
        }
      });
      
      if (totalQuestions > 0) {
        const pct = Math.round(totalCorrect / totalQuestions * 100);
        document.getElementById('totalScoreDisplay').textContent = `Total: ${totalCorrect}/${totalQuestions} (${pct}%)`;
      }
    }

    // ==================== RESET FUNCTIONS ====================
    function resetSection() {
      const btn = document.getElementById('resetSectionBtn');
      
      if (btn.classList.contains('confirm')) {
        // Actually reset
        const tabState = getTabState();
        tabState.selections = {};
        tabState.results = {};
        tabState.submitted = false;
        tabState.complete = false;
        // Keep attempts count
        
        saveProgress();
        renderContent();
        updateControlPanel();
        
        btn.textContent = 'Reset Section';
        btn.classList.remove('confirm');
        
        document.getElementById('feedbackSummary').textContent = '';
        showToast('Section reset');
      } else {
        // Ask for confirmation
        btn.textContent = 'Confirm Reset?';
        btn.classList.add('confirm');
        
        setTimeout(() => {
          btn.textContent = 'Reset Section';
          btn.classList.remove('confirm');
        }, 3000);
      }
    }

    function resetTopic() {
      const btn = document.getElementById('resetTopicBtn');
      
      if (btn.classList.contains('confirm')) {
        if (APP.topicData) {
          Storage.clearTopicProgress(APP.topicData.metadata.id);
          APP.currentRound = 1;
          APP.tabStates = {};
          APP.errorTracking = {};
          
          // Reinitialize
          APP.topicData.tabs.forEach(tab => {
            const key = `round1_${tab.id}`;
            APP.tabStates[key] = {
              selections: {},
              results: {},
              submitted: false,
              attempts: 0,
              bestScore: 0,
              complete: false
            };
          });
          
          APP.currentTab = APP.topicData.tabs[0].id;
          
          renderTabs();
          renderContent();
          updateHeader();
          updateControlPanel();
          
          document.getElementById('feedbackSummary').textContent = '';
        }
        
        btn.textContent = 'Reset Topic Progress';
        btn.classList.remove('confirm');
        toggleUtilities(false);
        showToast('Topic progress reset');
      } else {
        btn.textContent = 'Confirm Reset?';
        btn.classList.add('confirm');
        
        setTimeout(() => {
          btn.textContent = 'Reset Topic Progress';
          btn.classList.remove('confirm');
        }, 3000);
      }
    }

    function changeCurriculum() {
      const btn = document.getElementById('changeCurriculumBtn');
      
      if (btn.classList.contains('confirm')) {
        Storage.clearAll();
        location.reload();
      } else {
        btn.textContent = 'Confirm? All progress will be cleared';
        btn.classList.add('confirm');
        
        setTimeout(() => {
          btn.textContent = 'Change Curriculum';
          btn.classList.remove('confirm');
        }, 3000);
      }
    }

    function clearAllData() {
      const btn = document.getElementById('clearAllBtn');
      
      if (btn.classList.contains('confirm')) {
        Storage.clearAll();
        location.reload();
      } else {
        btn.textContent = 'Confirm? All data will be cleared';
        btn.classList.add('confirm');
        
        setTimeout(() => {
          btn.textContent = 'Clear All Data';
          btn.classList.remove('confirm');
        }, 3000);
      }
    }

    function exportProgress() {
      const data = {
        exported: new Date().toISOString(),
        currentState: APP.currentState,
        currentSubject: APP.currentSubject,
        topicProgress: {}
      };
      
      // Gather all topic progress
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key.startsWith('ycft_topic_')) {
          data.topicProgress[key] = JSON.parse(localStorage.getItem(key));
        }
      }
      
      const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = `youcantfakethis-progress-${new Date().toISOString().split('T')[0]}.json`;
      a.click();
      URL.revokeObjectURL(url);
      
      showToast('Progress exported');
    }

    // ==================== REVIEW SCREEN ====================
    function showReview(filter = 'current') {
      // Guard: need topic data loaded
      if (!APP.topicData) {
        showToast('Load a topic first');
        return;
      }
      
      document.getElementById('topicContent').classList.remove('active');
      const reviewScreen = document.getElementById('reviewScreen');
      reviewScreen.style.display = ''; // Clear any inline style override
      reviewScreen.classList.add('active');
      
      // Determine which rounds to include
      const roundsToShow = [];
      if (filter === 'current') {
        roundsToShow.push(APP.currentRound);
      } else if (filter === 'total') {
        roundsToShow.push(1, 2, 3);
      } else {
        roundsToShow.push(parseInt(filter));
      }
      
      // Calculate detailed scores for each tab across selected rounds
      let totalQuestions = 0;
      let totalAttempts = 0;
      let totalErrors = 0;
      let completedSections = 0;
      let totalSections = 0;
      const tabScores = {};
      
      APP.topicData.tabs.forEach(tab => {
        if (!tabScores[tab.id]) {
          tabScores[tab.id] = { 
            total: 0, 
            attempts: 0, 
            errors: 0, // Total wrong answers across all attempts
            firstTryCorrect: 0, // Questions correct on first try
            hasData: false,
            complete: false,
            roundData: {} 
          };
        }
        
        roundsToShow.forEach(round => {
          const content = APP.topicData.content[`round${round}`]?.[tab.id];
          if (content) {
            let tabTotal = 0;
            content.sentences.forEach(s => {
              tabTotal += Object.keys(s.questions).length;
            });
            
            tabScores[tab.id].total += tabTotal;
            totalQuestions += tabTotal;
            totalSections++;
            
            // Get state if exists
            const key = `round${round}_${tab.id}`;
            const state = APP.tabStates[key];
            if (state && state.attempts > 0) {
              tabScores[tab.id].attempts += state.attempts;
              tabScores[tab.id].hasData = true;
              totalAttempts += state.attempts;
              
              // Calculate errors: (attempts - 1) * questions that weren't perfect first try
              // Simpler: errors = total attempts needed beyond first try across all questions
              const errorsThisSection = (state.attempts - 1) * tabTotal + (tabTotal - state.bestScore);
              // Actually, let's use: extra attempts = attempts - 1 (since 1 attempt = perfect)
              const extraAttempts = Math.max(0, state.attempts - 1);
              tabScores[tab.id].errors += extraAttempts;
              totalErrors += extraAttempts;
              
              // First try correct = bestScore if attempts === 1, else estimate
              if (state.attempts === 1) {
                tabScores[tab.id].firstTryCorrect += state.bestScore;
              }
              
              if (state.complete) {
                tabScores[tab.id].complete = true;
                completedSections++;
              }
              
              tabScores[tab.id].roundData[round] = {
                attempts: state.attempts,
                complete: state.complete
              };
            }
          }
        });
      });
      
      // Calculate efficiency score: 100% = all correct first try, decreases with retries
      // Formula: Questions / (Questions + Extra Attempts) * 100
      const efficiencyScore = totalQuestions > 0 
        ? Math.round((totalQuestions / (totalQuestions + totalErrors)) * 100) 
        : 0;
      
      // Check if topic is complete (all 3 rounds, all tabs)
      let allRoundsComplete = true;
      for (let r = 1; r <= 3; r++) {
        APP.topicData.tabs.forEach(tab => {
          const key = `round${r}_${tab.id}`;
          const state = APP.tabStates[key];
          if (!state || !state.complete) {
            allRoundsComplete = false;
          }
        });
      }
      
      // Build HTML
      let html = `
        <div class="review-header">
          <h2>Performance Review</h2>
          <div class="review-score">${efficiencyScore}% Efficiency</div>
          <div style="font-size:0.9rem;color:var(--text-muted);margin-top:4px;">
            ${completedSections}/${totalSections} sections complete | ${totalAttempts} total attempts | ${totalErrors} retries needed
          </div>
        </div>
        
        <div class="review-tabs">
          <button class="review-tab ${filter === 'current' ? 'active' : ''}" onclick="showReview('current')">Round ${APP.currentRound}</button>
          <button class="review-tab ${filter === '1' ? 'active' : ''}" onclick="showReview('1')">Round 1</button>
          <button class="review-tab ${filter === '2' ? 'active' : ''}" onclick="showReview('2')">Round 2</button>
          <button class="review-tab ${filter === '3' ? 'active' : ''}" onclick="showReview('3')">Round 3</button>
          <button class="review-tab ${filter === 'total' ? 'active' : ''}" onclick="showReview('total')">All Rounds</button>
        </div>
        
        <h3 style="margin-bottom:12px;">Section Breakdown</h3>
      `;
      
      // Tab breakdown with attempt details
      APP.topicData.tabs.forEach(tab => {
        const score = tabScores[tab.id];
        const notStarted = !score.hasData;
        
        let statusClass = '';
        let statusIcon = '‚Äî';
        let statusText = 'Not attempted yet';
        
        if (score.hasData) {
          if (score.complete || (score.attempts > 0 && score.errors === 0)) {
            statusClass = 'success';
            statusIcon = '‚úì';
            if (score.attempts === roundsToShow.length) {
              statusText = `Complete on first try (${score.attempts} attempt${score.attempts > 1 ? 's' : ''})`;
            } else {
              statusText = `Complete | ${score.attempts} attempt${score.attempts > 1 ? 's' : ''} | ${score.errors} retr${score.errors === 1 ? 'y' : 'ies'}`;
            }
          } else {
            statusClass = 'error';
            statusIcon = '‚óã';
            statusText = `In progress | ${score.attempts} attempt${score.attempts > 1 ? 's' : ''} | ${score.errors} retr${score.errors === 1 ? 'y' : 'ies'}`;
          }
        }
        
        html += `
          <div class="review-section ${statusClass}">
            <h3>${statusIcon} ${tab.icon} ${tab.label}</h3>
            <div class="review-detail">${statusText}</div>
          </div>
        `;
      });
      
      // Concept errors section
      const sortedErrors = Object.entries(APP.errorTracking)
        .sort((a, b) => b[1].count - a[1].count)
        .slice(0, 5);
      
      if (sortedErrors.length > 0) {
        html += '<h3 style="margin:20px 0 12px;">Concepts That Needed Work</h3>';
        
        sortedErrors.forEach(([conceptId, data]) => {
          const concept = APP.topicData.concepts?.[conceptId];
          const conceptName = concept?.name || conceptId.replace(/_/g, ' ');
          const correctInfo = concept?.correct || '';
          
          html += `
            <div class="review-section error">
              <h3>‚ö† ${conceptName} <span class="error-count">${data.count} mistake${data.count > 1 ? 's' : ''}</span></h3>
              ${correctInfo ? `<div class="review-detail">${correctInfo}</div>` : ''}
              <div class="review-detail" style="color:var(--error)">
                Incorrect answers tried: ${[...new Set(data.wrongAnswers.filter(a => a))].join(', ') || 'None'}
              </div>
              ${concept?.persistent ? `<div class="review-detail" style="font-style:italic;">‚Üí ${concept.persistent.action}</div>` : ''}
            </div>
          `;
        });
      } else if (totalAttempts > 0) {
        html += `
          <div style="text-align:center; color:var(--success); padding:20px; background:var(--bg-card); border-radius:var(--radius); margin-top:16px;">
            No errors recorded. Well done.
          </div>
        `;
      } else {
        html += `
          <div style="text-align:center; color:var(--text-muted); padding:20px;">
            Submit some answers to see your performance breakdown.
          </div>
        `;
      }
      
      // Actions section
      html += `<div class="review-actions">`;
      
      if (allRoundsComplete) {
        html += `
          <div style="width:100%; text-align:center; margin-bottom:16px;">
            <div style="font-size:1.2rem; font-weight:600; color:var(--success);">Topic Complete</div>
            <div style="color:var(--text-muted); font-size:0.9rem;">Final Efficiency: ${efficiencyScore}% | Total Retries: ${totalErrors}</div>
          </div>
          <button class="btn btn-primary" onclick="selectNextTopic()">Next Topic</button>
          <button class="btn btn-success" onclick="showEmailResults()">Email Results</button>
          <button class="btn btn-secondary" onclick="closeReview()">Review Again</button>
        `;
      } else {
        html += `
          <button class="btn btn-primary" onclick="closeReview()">Continue Learning</button>
          <button class="btn btn-secondary" onclick="showEmailResults()">Email Progress</button>
        `;
      }
      
      html += `</div>`;
      
      reviewScreen.innerHTML = html;
    }

    function closeReview() {
      document.getElementById('reviewScreen').classList.remove('active');
      document.getElementById('topicContent').classList.add('active');
    }
    
    // ==================== TOPIC COMPLETE FUNCTIONS ====================
    function selectNextTopic() {
      // Close review and reset to topic selection
      document.getElementById('reviewScreen').classList.remove('active');
      document.getElementById('topicContent').classList.remove('active');
      document.getElementById('tabsContainer').classList.remove('active');
      document.getElementById('controlPanel').classList.remove('active');
      document.getElementById('reviewBtn').style.display = 'none';
      document.getElementById('welcomeScreen').style.display = 'block';
      
      // Clear current topic state
      APP.topicData = null;
      APP.currentTab = null;
      APP.tabStates = {};
      APP.errorTracking = {};
      
      // Reset topic dropdown
      const topicSelect = document.getElementById('topicSelect');
      if (topicSelect) {
        topicSelect.value = '';
      }
      APP.currentTopic = null;
      
      showToast('Select your next topic above');
    }
    
    function showEmailResults() {
      const reviewScreen = document.getElementById('reviewScreen');
      const savedEmail = Storage.get('teacherEmail') || '';
      
      // Calculate summary stats
      let totalQuestions = 0;
      let totalAttempts = 0;
      let totalErrors = 0;
      let completedSections = 0;
      
      for (let r = 1; r <= 3; r++) {
        APP.topicData.tabs.forEach(tab => {
          const content = APP.topicData.content[`round${r}`]?.[tab.id];
          if (content) {
            let tabTotal = 0;
            content.sentences.forEach(s => {
              tabTotal += Object.keys(s.questions).length;
            });
            totalQuestions += tabTotal;
            
            const key = `round${r}_${tab.id}`;
            const state = APP.tabStates[key];
            if (state && state.attempts > 0) {
              totalAttempts += state.attempts;
              totalErrors += Math.max(0, state.attempts - 1);
              if (state.complete) completedSections++;
            }
          }
        });
      }
      
      const efficiencyScore = totalQuestions > 0 
        ? Math.round((totalQuestions / (totalQuestions + totalErrors)) * 100) 
        : 0;
      
      const totalSections = APP.topicData.tabs.length * 3;
      const isComplete = completedSections === totalSections;
      
      // Build email panel HTML
      const emailPanelHtml = `
        <div class="email-panel" id="emailPanel">
          <h3>${isComplete ? 'Send Results' : 'Send Progress'} to Teacher</h3>
          
          <div style="margin:16px 0;">
            <label style="display:block; font-size:0.85rem; color:var(--text-muted); margin-bottom:4px;">
              Teacher's Email Address
            </label>
            <input type="email" id="teacherEmailInput" value="${savedEmail}" 
                   placeholder="teacher@school.edu"
                   style="width:100%; padding:8px 12px; border:1px solid var(--border); border-radius:var(--radius); font-size:0.95rem;">
          </div>
          
          <div style="margin:16px 0;">
            <label style="display:block; font-size:0.85rem; color:var(--text-muted); margin-bottom:4px;">
              Your Name
            </label>
            <input type="text" id="studentNameInput" value="${Storage.get('studentName') || ''}" 
                   placeholder="Your name"
                   style="width:100%; padding:8px 12px; border:1px solid var(--border); border-radius:var(--radius); font-size:0.95rem;">
          </div>
          
          <div style="background:var(--bg); padding:12px; border-radius:var(--radius); margin:16px 0; font-size:0.85rem;">
            <strong>Summary to send:</strong><br>
            Topic: ${APP.topicData.metadata.topicName}<br>
            Status: ${isComplete ? 'Complete ‚úì' : 'In Progress'}<br>
            Sections: ${completedSections}/${totalSections}<br>
            Efficiency: ${efficiencyScore}%<br>
            Total Attempts: ${totalAttempts}<br>
            Retries Needed: ${totalErrors}
            ${Object.keys(APP.errorTracking).length > 0 ? `<br>Concepts needing review: ${Object.keys(APP.errorTracking).length}` : ''}
          </div>
          
          <div style="display:flex; gap:8px; justify-content:flex-end;">
            <button class="btn btn-secondary" onclick="closeEmailPanel()">Cancel</button>
            <button class="btn btn-success" onclick="sendEmail()">Send Email</button>
          </div>
        </div>
      `;
      
      // Add email panel styles if not already present
      if (!document.getElementById('emailPanelStyles')) {
        const styles = document.createElement('style');
        styles.id = 'emailPanelStyles';
        styles.textContent = `
          .email-panel {
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 20px;
            margin: 20px 0;
            box-shadow: var(--shadow);
          }
          .email-panel h3 {
            margin-bottom: 12px;
            color: var(--primary);
          }
        `;
        document.head.appendChild(styles);
      }
      
      // Insert email panel before review actions
      const actionsDiv = reviewScreen.querySelector('.review-actions');
      if (actionsDiv) {
        // Remove existing email panel if any
        const existingPanel = document.getElementById('emailPanel');
        if (existingPanel) existingPanel.remove();
        
        actionsDiv.insertAdjacentHTML('beforebegin', emailPanelHtml);
        document.getElementById('teacherEmailInput').focus();
      }
    }
    
    function closeEmailPanel() {
      const panel = document.getElementById('emailPanel');
      if (panel) panel.remove();
    }
    
    function sendEmail() {
      const emailInput = document.getElementById('teacherEmailInput');
      const nameInput = document.getElementById('studentNameInput');
      const email = emailInput.value.trim();
      const studentName = nameInput.value.trim();
      
      if (!email) {
        showToast('Please enter teacher\'s email address');
        emailInput.focus();
        return;
      }
      
      if (!email.includes('@')) {
        showToast('Please enter a valid email address');
        emailInput.focus();
        return;
      }
      
      if (!studentName) {
        showToast('Please enter your name');
        nameInput.focus();
        return;
      }
      
      // Save for future use
      Storage.set('teacherEmail', email);
      Storage.set('studentName', studentName);
      
      // Calculate stats for email
      let totalQuestions = 0;
      let totalAttempts = 0;
      let totalErrors = 0;
      let completedSections = 0;
      const totalSections = APP.topicData.tabs.length * 3;
      
      for (let r = 1; r <= 3; r++) {
        APP.topicData.tabs.forEach(tab => {
          const content = APP.topicData.content[`round${r}`]?.[tab.id];
          if (content) {
            content.sentences.forEach(s => {
              totalQuestions += Object.keys(s.questions).length;
            });
            
            const key = `round${r}_${tab.id}`;
            const state = APP.tabStates[key];
            if (state && state.attempts > 0) {
              totalAttempts += state.attempts;
              totalErrors += Math.max(0, state.attempts - 1);
              if (state.complete) completedSections++;
            }
          }
        });
      }
      
      const efficiencyScore = totalQuestions > 0 
        ? Math.round((totalQuestions / (totalQuestions + totalErrors)) * 100) 
        : 0;
      
      const isComplete = completedSections === totalSections;
      
      // Build concepts needing review list
      const conceptsList = Object.entries(APP.errorTracking)
        .sort((a, b) => b[1].count - a[1].count)
        .slice(0, 5)
        .map(([conceptId, data]) => {
          const concept = APP.topicData.concepts?.[conceptId];
          return `- ${concept?.name || conceptId.replace(/_/g, ' ')}: ${data.count} mistake(s)`;
        })
        .join('\n');
      
      // Create email body
      const subject = `YouCantFakeThis: ${studentName} - ${APP.topicData.metadata.topicName} ${isComplete ? '(Complete)' : '(In Progress)'}`;
      const body = `Student: ${studentName}
Topic: ${APP.topicData.metadata.topicName}
Subject: ${APP.topicData.metadata.subject}
Curriculum: ${APP.topicData.metadata.curriculum}

STATUS: ${isComplete ? 'COMPLETE' : 'In Progress'}

PERFORMANCE SUMMARY
-------------------
Sections Completed: ${completedSections}/${totalSections}
Efficiency Score: ${efficiencyScore}%
Total Attempts: ${totalAttempts}
Retries Needed: ${totalErrors}

${conceptsList ? `CONCEPTS NEEDING REVIEW\n-------------------\n${conceptsList}` : 'No errors recorded.'}

---
Sent from YouCantFakeThis Educational Platform
${new Date().toLocaleString()}`;
      
      // Open email client
      const mailtoLink = `mailto:${encodeURIComponent(email)}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      window.open(mailtoLink, '_blank');
      
      closeEmailPanel();
      showToast('Opening email client...');
    }

    // ==================== HELPERS ====================
    function getTabState() {
      const key = `round${APP.currentRound}_${APP.currentTab}`;
      if (!APP.tabStates[key]) {
        APP.tabStates[key] = {
          selections: {},
          results: {},
          submitted: false,
          attempts: 0,
          bestScore: 0,
          complete: false
        };
      }
      return APP.tabStates[key];
    }

    function saveProgress() {
      if (APP.topicData) {
        Storage.saveTopicProgress(APP.topicData.metadata.id, {
          currentRound: APP.currentRound,
          tabStates: APP.tabStates,
          errorTracking: APP.errorTracking
        });
      }
    }

    // EASTER EGG: Debug mode
    function activateDebugMode() {
      console.log('Debug mode activated');
      showToast('Debug mode: Auto-filling correct answers');
      
      // Fill all dropdowns with correct answers
      document.querySelectorAll('.cloze-dropdown').forEach(select => {
        const correct = select.dataset.correct;
        if (correct) {
          select.value = correct;
          select.classList.add('filled');
          
          const tabState = getTabState();
          tabState.selections[select.dataset.question] = correct;
        }
      });
      
      saveProgress();
      updateControlPanel();
    }

    // ==================== INIT ====================
    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>