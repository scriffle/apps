<!DOCTYPE html>
<html lang="en" data-version="1.0.0">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>a nonna mouse — Teacher Dashboard</title>
  <meta name="description" content="Teacher moderation and control panel for a nonna mouse anonymous classroom backchannel.">
  <style>
    /* ─── Reset ──────────────────────────────────────────── */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    /* ─── CSS Custom Properties ──────────────────────────── */
    :root {
      /* Color palette — light mode */
      --color-bg: #f5f7fa;
      --color-surface: #ffffff;
      --color-surface-raised: #ffffff;
      --color-surface-dim: #eef1f5;
      --color-border: #dde2e8;
      --color-border-light: #e8ecf0;
      --color-text: #1a2332;
      --color-text-secondary: #5a6578;
      --color-text-muted: #8a94a6;
      --color-primary: #3b82f6;
      --color-primary-hover: #2563eb;
      --color-primary-light: #dbeafe;
      --color-success: #22c55e;
      --color-success-light: #dcfce7;
      --color-success-dark: #16a34a;
      --color-warning: #f59e0b;
      --color-warning-light: #fef3c7;
      --color-danger: #ef4444;
      --color-danger-light: #fee2e2;
      --color-danger-dark: #dc2626;
      --color-info: #06b6d4;
      --color-info-light: #cffafe;
      --color-pinned: #a855f7;
      --color-pinned-light: #f3e8ff;

      /* Shadows */
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.07), 0 2px 4px -2px rgba(0,0,0,0.05);
      --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.08), 0 4px 6px -4px rgba(0,0,0,0.04);

      /* Spacing scale */
      --space-1: 0.25rem;
      --space-2: 0.5rem;
      --space-3: 0.75rem;
      --space-4: 1rem;
      --space-5: 1.25rem;
      --space-6: 1.5rem;
      --space-8: 2rem;
      --space-10: 2.5rem;
      --space-12: 3rem;

      /* Typography */
      --font-sans: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      --font-mono: 'SF Mono', 'Fira Code', 'Fira Mono', 'Roboto Mono', monospace;
      --font-size-xs: 0.75rem;
      --font-size-sm: 0.8125rem;
      --font-size-base: 0.9375rem;
      --font-size-lg: 1.0625rem;
      --font-size-xl: 1.25rem;
      --font-size-2xl: 1.5rem;
      --font-size-3xl: 1.875rem;

      /* Radii */
      --radius-sm: 6px;
      --radius-md: 8px;
      --radius-lg: 12px;
      --radius-xl: 16px;
      --radius-full: 9999px;

      /* Transitions */
      --transition-fast: 150ms ease;
      --transition-base: 200ms ease;
      --transition-slow: 300ms ease;

      /* Layout */
      --header-height: 60px;
      --settings-width: 380px;
    }

    /* ─── Dark mode ──────────────────────────────────────── */
    @media (prefers-color-scheme: dark) {
      :root {
        --color-bg: #0f1419;
        --color-surface: #1a2332;
        --color-surface-raised: #222f3e;
        --color-surface-dim: #151d28;
        --color-border: #2a3a4e;
        --color-border-light: #233044;
        --color-text: #e8ecf0;
        --color-text-secondary: #9aa8b8;
        --color-text-muted: #637389;
        --color-primary-light: #1e3a5f;
        --color-success-light: #0d331a;
        --color-warning-light: #3d2a07;
        --color-danger-light: #3d1111;
        --color-info-light: #0a2d33;
        --color-pinned-light: #2a1547;
        --shadow-sm: 0 1px 2px rgba(0,0,0,0.2);
        --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.3), 0 2px 4px -2px rgba(0,0,0,0.2);
        --shadow-lg: 0 10px 15px -3px rgba(0,0,0,0.35), 0 4px 6px -4px rgba(0,0,0,0.2);
      }
    }

    /* ─── Reduced motion ─────────────────────────────────── */
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after {
        animation-duration: 0.01ms !important;
        animation-iteration-count: 1 !important;
        transition-duration: 0.01ms !important;
      }
    }

    /* ─── Base styles ────────────────────────────────────── */
    html {
      font-size: 16px;
      -webkit-text-size-adjust: 100%;
    }

    body {
      font-family: var(--font-sans);
      font-size: var(--font-size-base);
      line-height: 1.5;
      color: var(--color-text);
      background-color: var(--color-bg);
      min-height: 100vh;
      min-height: 100dvh;
      overflow-x: hidden;
    }

    /* ─── Skip to content ────────────────────────────────── */
    .skip-link {
      position: absolute;
      top: -100%;
      left: var(--space-4);
      padding: var(--space-2) var(--space-4);
      background: var(--color-primary);
      color: #fff;
      border-radius: var(--radius-md);
      z-index: 10000;
      font-weight: 600;
      text-decoration: none;
    }
    .skip-link:focus {
      top: var(--space-2);
    }

    /* ─── Auth overlay ───────────────────────────────────── */
    .auth-overlay {
      position: fixed;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--color-bg);
      z-index: 9999;
      transition: opacity var(--transition-slow), visibility var(--transition-slow);
    }
    .auth-overlay[hidden] {
      opacity: 0;
      visibility: hidden;
      pointer-events: none;
    }
    .auth-card {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-xl);
      padding: var(--space-10);
      max-width: 420px;
      width: 90%;
      text-align: center;
      box-shadow: var(--shadow-lg);
    }
    .auth-card h1 {
      font-size: var(--font-size-2xl);
      margin-block-end: var(--space-2);
      letter-spacing: -0.02em;
    }
    .auth-card .auth-subtitle {
      color: var(--color-text-secondary);
      margin-block-end: var(--space-8);
      font-size: var(--font-size-sm);
    }
    .auth-card .auth-icon {
      font-size: 3rem;
      margin-block-end: var(--space-4);
      display: block;
    }
    .auth-field {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }
    .auth-field label {
      font-weight: 600;
      font-size: var(--font-size-sm);
      text-align: start;
      color: var(--color-text-secondary);
    }
    .auth-field input {
      padding: var(--space-3) var(--space-4);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-md);
      font-size: var(--font-size-base);
      background: var(--color-surface);
      color: var(--color-text);
      transition: border-color var(--transition-fast);
      font-family: var(--font-sans);
    }
    .auth-field input:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px var(--color-primary-light);
    }
    .auth-field .auth-error {
      color: var(--color-danger);
      font-size: var(--font-size-sm);
      min-height: 1.25rem;
    }
    .auth-btn {
      width: 100%;
      margin-block-start: var(--space-4);
      padding: var(--space-3) var(--space-6);
      background: var(--color-primary);
      color: #fff;
      border: none;
      border-radius: var(--radius-md);
      font-size: var(--font-size-base);
      font-weight: 600;
      cursor: pointer;
      transition: background-color var(--transition-fast), transform var(--transition-fast);
      font-family: var(--font-sans);
    }
    .auth-btn:hover { background: var(--color-primary-hover); }
    .auth-btn:active { transform: scale(0.98); }
    .auth-btn:focus-visible {
      outline: 2px solid var(--color-primary);
      outline-offset: 2px;
    }

    /* ─── App layout ─────────────────────────────────────── */
    .app-layout {
      display: none;
      flex-direction: column;
      min-height: 100vh;
      min-height: 100dvh;
    }
    .app-layout.is-active { display: flex; }

    /* ─── Header / status bar ────────────────────────────── */
    .status-bar {
      position: sticky;
      top: 0;
      z-index: 100;
      display: flex;
      align-items: center;
      gap: var(--space-4);
      padding: var(--space-3) var(--space-6);
      background: var(--color-surface);
      border-block-end: 1px solid var(--color-border);
      box-shadow: var(--shadow-sm);
      height: var(--header-height);
      flex-shrink: 0;
    }
    .status-bar__brand {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      font-weight: 700;
      font-size: var(--font-size-lg);
      letter-spacing: -0.01em;
      white-space: nowrap;
    }
    .status-bar__brand-icon {
      font-size: 1.4rem;
    }
    .status-bar__session {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      margin-inline-start: var(--space-4);
    }
    .session-dot {
      width: 10px;
      height: 10px;
      border-radius: var(--radius-full);
      flex-shrink: 0;
      transition: background-color var(--transition-base);
    }
    .session-dot.is-active { background-color: var(--color-success); box-shadow: 0 0 6px var(--color-success); }
    .session-dot.is-inactive { background-color: var(--color-danger); }
    .session-label {
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
      font-weight: 500;
    }
    .pending-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      padding: var(--space-1) var(--space-3);
      background: var(--color-warning-light);
      color: var(--color-warning);
      border-radius: var(--radius-full);
      font-size: var(--font-size-xs);
      font-weight: 700;
      white-space: nowrap;
    }
    .pending-badge[data-count="0"] {
      background: var(--color-success-light);
      color: var(--color-success-dark);
    }
    .status-bar__spacer { flex: 1; }
    .connection-indicator {
      display: flex;
      align-items: center;
      gap: var(--space-1);
      font-size: var(--font-size-xs);
      color: var(--color-text-muted);
    }
    .connection-dot {
      width: 7px;
      height: 7px;
      border-radius: var(--radius-full);
      background: var(--color-success);
      transition: background-color var(--transition-base);
    }
    .connection-dot.is-error { background: var(--color-danger); }
    .connection-dot.is-loading {
      background: var(--color-warning);
      animation: pulse-dot 1.2s ease-in-out infinite;
    }
    @keyframes pulse-dot {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.4; }
    }
    .btn-session-toggle {
      padding: var(--space-2) var(--space-5);
      border: 2px solid;
      border-radius: var(--radius-full);
      font-size: var(--font-size-sm);
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-fast);
      white-space: nowrap;
      background: transparent;
      font-family: var(--font-sans);
    }
    .btn-session-toggle.is-start {
      border-color: var(--color-success);
      color: var(--color-success);
    }
    .btn-session-toggle.is-start:hover {
      background: var(--color-success);
      color: #fff;
    }
    .btn-session-toggle.is-stop {
      border-color: var(--color-danger);
      color: var(--color-danger);
    }
    .btn-session-toggle.is-stop:hover {
      background: var(--color-danger);
      color: #fff;
    }
    .btn-session-toggle:focus-visible {
      outline: 2px solid var(--color-primary);
      outline-offset: 2px;
    }
    .btn-settings-toggle {
      width: 40px;
      height: 40px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      background: var(--color-surface);
      color: var(--color-text-secondary);
      cursor: pointer;
      transition: all var(--transition-fast);
      font-size: 1.2rem;
      flex-shrink: 0;
    }
    .btn-settings-toggle:hover {
      background: var(--color-surface-dim);
      color: var(--color-text);
    }
    .btn-settings-toggle:focus-visible {
      outline: 2px solid var(--color-primary);
      outline-offset: 2px;
    }

    /* ─── Main content area ──────────────────────────────── */
    .main-content {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: var(--space-6);
      padding: var(--space-6);
      max-width: 960px;
      margin-inline: auto;
      width: 100%;
    }

    /* ─── Section headings ───────────────────────────────── */
    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-4);
      margin-block-end: var(--space-4);
    }
    .section-title {
      font-size: var(--font-size-xl);
      font-weight: 700;
      letter-spacing: -0.01em;
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }
    .section-count {
      font-size: var(--font-size-sm);
      color: var(--color-text-muted);
      font-weight: 400;
    }

    /* ─── Queue ───────────────────────────────────────────── */
    .queue-actions {
      display: flex;
      gap: var(--space-2);
    }
    .btn {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-4);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      font-size: var(--font-size-sm);
      font-weight: 600;
      cursor: pointer;
      background: var(--color-surface);
      color: var(--color-text);
      transition: all var(--transition-fast);
      white-space: nowrap;
      font-family: var(--font-sans);
    }
    .btn:hover { background: var(--color-surface-dim); }
    .btn:active { transform: scale(0.97); }
    .btn:focus-visible {
      outline: 2px solid var(--color-primary);
      outline-offset: 2px;
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn.btn--success {
      background: var(--color-success);
      color: #fff;
      border-color: var(--color-success);
    }
    .btn.btn--success:hover { background: var(--color-success-dark); }
    .btn.btn--danger {
      background: var(--color-danger);
      color: #fff;
      border-color: var(--color-danger);
    }
    .btn.btn--danger:hover { background: var(--color-danger-dark); }

    .queue-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }

    .queue-empty {
      text-align: center;
      padding: var(--space-12) var(--space-6);
      color: var(--color-text-muted);
      font-size: var(--font-size-lg);
    }
    .queue-empty-icon {
      font-size: 3rem;
      display: block;
      margin-block-end: var(--space-4);
    }

    /* ─── Queue item card ────────────────────────────────── */
    .queue-card {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      padding: var(--space-4) var(--space-5);
      box-shadow: var(--shadow-sm);
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
      transition: all var(--transition-base);
      position: relative;
      outline: none;
    }
    .queue-card:focus-visible {
      box-shadow: 0 0 0 3px var(--color-primary-light);
      border-color: var(--color-primary);
    }
    .queue-card.is-focused {
      border-color: var(--color-primary);
    }
    .queue-card.is-exiting {
      opacity: 0;
      transform: translateX(40px);
    }
    .queue-card__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-3);
    }
    .queue-card__meta {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      flex-wrap: wrap;
    }
    .queue-card__time {
      font-size: var(--font-size-xs);
      color: var(--color-text-muted);
      white-space: nowrap;
    }
    .queue-card__text {
      font-size: var(--font-size-base);
      line-height: 1.6;
      word-break: break-word;
    }
    .queue-card__footer {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-3);
    }

    /* Moderation score bar */
    .score-bar {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      flex-shrink: 0;
    }
    .score-bar__track {
      width: 60px;
      height: 6px;
      background: var(--color-surface-dim);
      border-radius: var(--radius-full);
      overflow: hidden;
    }
    .score-bar__fill {
      height: 100%;
      border-radius: var(--radius-full);
      transition: width var(--transition-base);
    }
    .score-bar__fill.is-low { background: var(--color-success); }
    .score-bar__fill.is-medium { background: var(--color-warning); }
    .score-bar__fill.is-high { background: var(--color-danger); }
    .score-bar__label {
      font-size: var(--font-size-xs);
      font-weight: 600;
      font-family: var(--font-mono);
      min-width: 2.5em;
    }
    .score-bar__label.is-low { color: var(--color-success); }
    .score-bar__label.is-medium { color: var(--color-warning); }
    .score-bar__label.is-high { color: var(--color-danger); }

    /* Flag chips */
    .flag-chips {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-1);
    }
    .flag-chip {
      padding: 2px var(--space-2);
      border-radius: var(--radius-full);
      font-size: var(--font-size-xs);
      font-weight: 600;
      background: var(--color-danger-light);
      color: var(--color-danger);
      white-space: nowrap;
    }

    /* Card actions */
    .queue-card__actions {
      display: flex;
      gap: var(--space-2);
    }
    .btn-action {
      min-width: 44px;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      background: var(--color-surface);
      cursor: pointer;
      transition: all var(--transition-fast);
      font-size: 1rem;
      flex-shrink: 0;
    }
    .btn-action:focus-visible {
      outline: 2px solid var(--color-primary);
      outline-offset: 2px;
    }
    .btn-action.btn-approve {
      color: var(--color-success);
      border-color: var(--color-success-light);
    }
    .btn-action.btn-approve:hover {
      background: var(--color-success);
      color: #fff;
      border-color: var(--color-success);
    }
    .btn-action.btn-reject {
      color: var(--color-danger);
      border-color: var(--color-danger-light);
    }
    .btn-action.btn-reject:hover {
      background: var(--color-danger);
      color: #fff;
      border-color: var(--color-danger);
    }

    /* ─── Approved history ───────────────────────────────── */
    .approved-section {
      border-block-start: 1px solid var(--color-border);
      padding-block-start: var(--space-6);
    }
    .approved-list {
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
      max-height: 400px;
      overflow-y: auto;
      overscroll-behavior: contain;
    }
    .approved-card {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: var(--space-3) var(--space-4);
      display: flex;
      align-items: center;
      gap: var(--space-3);
      transition: all var(--transition-base);
    }
    .approved-card.is-pinned {
      border-color: var(--color-pinned);
      background: var(--color-pinned-light);
    }
    .approved-card__text {
      flex: 1;
      font-size: var(--font-size-sm);
      word-break: break-word;
      line-height: 1.5;
    }
    .approved-card__time {
      font-size: var(--font-size-xs);
      color: var(--color-text-muted);
      white-space: nowrap;
      flex-shrink: 0;
    }
    .btn-pin {
      min-width: 44px;
      min-height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      background: var(--color-surface);
      cursor: pointer;
      transition: all var(--transition-fast);
      font-size: 0.9rem;
      flex-shrink: 0;
    }
    .btn-pin:hover {
      background: var(--color-pinned-light);
      border-color: var(--color-pinned);
    }
    .btn-pin:focus-visible {
      outline: 2px solid var(--color-primary);
      outline-offset: 2px;
    }
    .btn-pin.is-pinned {
      background: var(--color-pinned);
      color: #fff;
      border-color: var(--color-pinned);
    }
    .approved-empty {
      text-align: center;
      padding: var(--space-8) var(--space-4);
      color: var(--color-text-muted);
      font-size: var(--font-size-sm);
    }

    /* ─── Bulk action toolbar ──────────────────────────────── */
    .bulk-bar {
      display: flex;
      align-items: center;
      gap: var(--space-2);
      padding: var(--space-2) 0;
      flex-wrap: wrap;
    }
    .bulk-bar__select {
      display: flex;
      align-items: center;
      gap: var(--space-1);
      font-size: var(--font-size-xs);
      color: var(--color-text-muted);
    }
    .bulk-bar__link {
      background: none;
      border: none;
      color: var(--color-primary);
      cursor: pointer;
      font-size: var(--font-size-xs);
      padding: 2px 4px;
      border-radius: var(--radius-sm);
      text-decoration: underline;
    }
    .bulk-bar__link:hover { opacity: 0.8; }
    .bulk-bar__link:focus-visible {
      outline: 2px solid var(--color-primary);
      outline-offset: 2px;
    }
    .bulk-bar__count {
      font-size: var(--font-size-xs);
      color: var(--color-text-muted);
      margin-left: auto;
    }
    .bulk-bar__actions {
      display: flex;
      gap: var(--space-1);
    }
    .btn-bulk {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 6px 12px;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      background: var(--color-surface);
      font-size: var(--font-size-xs);
      cursor: pointer;
      transition: all var(--transition-fast);
    }
    .btn-bulk:hover { background: var(--color-surface-hover, #f5f5f5); }
    .btn-bulk:focus-visible {
      outline: 2px solid var(--color-primary);
      outline-offset: 2px;
    }
    .btn-bulk--danger {
      color: var(--color-reject);
      border-color: var(--color-reject);
    }
    .btn-bulk--danger:hover {
      background: var(--color-reject);
      color: #fff;
    }

    /* ─── Approved card checkbox ───────────────────────────── */
    .approved-card__check {
      flex-shrink: 0;
      width: 20px;
      height: 20px;
      accent-color: var(--color-primary);
      cursor: pointer;
    }

    /* ─── Settings panel ─────────────────────────────────── */
    .settings-backdrop {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.3);
      z-index: 200;
      opacity: 0;
      visibility: hidden;
      transition: opacity var(--transition-slow), visibility var(--transition-slow);
    }
    .settings-backdrop.is-open {
      opacity: 1;
      visibility: visible;
    }
    .settings-panel {
      position: fixed;
      top: 0;
      right: 0;
      bottom: 0;
      width: var(--settings-width);
      max-width: 95vw;
      background: var(--color-surface);
      border-inline-start: 1px solid var(--color-border);
      box-shadow: var(--shadow-lg);
      z-index: 201;
      transform: translateX(100%);
      transition: transform var(--transition-slow);
      overflow-y: auto;
      overscroll-behavior: contain;
      display: flex;
      flex-direction: column;
    }
    .settings-panel.is-open {
      transform: translateX(0);
    }
    .settings-panel__header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: var(--space-4) var(--space-6);
      border-block-end: 1px solid var(--color-border);
      position: sticky;
      top: 0;
      background: var(--color-surface);
      z-index: 1;
    }
    .settings-panel__title {
      font-size: var(--font-size-lg);
      font-weight: 700;
    }
    .btn-close-settings {
      width: 36px;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: none;
      border-radius: var(--radius-md);
      background: transparent;
      color: var(--color-text-secondary);
      cursor: pointer;
      font-size: 1.2rem;
      transition: all var(--transition-fast);
    }
    .btn-close-settings:hover {
      background: var(--color-surface-dim);
      color: var(--color-text);
    }
    .btn-close-settings:focus-visible {
      outline: 2px solid var(--color-primary);
      outline-offset: 2px;
    }
    .settings-panel__body {
      padding: var(--space-6);
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: var(--space-6);
    }
    .settings-group {
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
    }
    .settings-group__title {
      font-size: var(--font-size-sm);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--color-text-muted);
    }
    .setting-row {
      display: flex;
      flex-direction: column;
      gap: var(--space-1);
    }
    .setting-row label {
      font-size: var(--font-size-sm);
      font-weight: 600;
      color: var(--color-text-secondary);
    }
    .setting-row input[type="number"],
    .setting-row input[type="text"],
    .setting-row input[type="password"],
    .setting-row select {
      padding: var(--space-2) var(--space-3);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      font-size: var(--font-size-sm);
      background: var(--color-surface);
      color: var(--color-text);
      font-family: var(--font-sans);
      transition: border-color var(--transition-fast);
    }
    .setting-row input:focus,
    .setting-row select:focus {
      outline: none;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 3px var(--color-primary-light);
    }

    /* Toggle switch */
    .toggle-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: var(--space-3);
    }
    .toggle-switch {
      position: relative;
      width: 44px;
      height: 24px;
      flex-shrink: 0;
    }
    .toggle-switch input {
      opacity: 0;
      width: 0;
      height: 0;
      position: absolute;
    }
    .toggle-slider {
      position: absolute;
      inset: 0;
      background: var(--color-border);
      border-radius: var(--radius-full);
      cursor: pointer;
      transition: background-color var(--transition-fast);
    }
    .toggle-slider::before {
      content: '';
      position: absolute;
      top: 2px;
      left: 2px;
      width: 20px;
      height: 20px;
      background: #fff;
      border-radius: var(--radius-full);
      transition: transform var(--transition-fast);
      box-shadow: var(--shadow-sm);
    }
    .toggle-switch input:checked + .toggle-slider {
      background: var(--color-primary);
    }
    .toggle-switch input:checked + .toggle-slider::before {
      transform: translateX(20px);
    }
    .toggle-switch input:focus-visible + .toggle-slider {
      box-shadow: 0 0 0 3px var(--color-primary-light);
    }

    /* Slider */
    .slider-row {
      display: flex;
      flex-direction: column;
      gap: var(--space-2);
    }
    .slider-row__control {
      display: flex;
      align-items: center;
      gap: var(--space-3);
    }
    .slider-row input[type="range"] {
      flex: 1;
      accent-color: var(--color-primary);
      cursor: pointer;
    }
    .slider-row__value {
      font-size: var(--font-size-sm);
      font-weight: 700;
      font-family: var(--font-mono);
      min-width: 3em;
      text-align: end;
      color: var(--color-primary);
    }

    /* Save button */
    .settings-panel__footer {
      padding: var(--space-4) var(--space-6);
      border-block-start: 1px solid var(--color-border);
      position: sticky;
      bottom: 0;
      background: var(--color-surface);
    }
    .btn-save {
      width: 100%;
      padding: var(--space-3) var(--space-6);
      background: var(--color-primary);
      color: #fff;
      border: none;
      border-radius: var(--radius-md);
      font-size: var(--font-size-base);
      font-weight: 600;
      cursor: pointer;
      transition: background-color var(--transition-fast), transform var(--transition-fast);
      font-family: var(--font-sans);
    }
    .btn-save:hover { background: var(--color-primary-hover); }
    .btn-save:active { transform: scale(0.98); }
    .btn-save:focus-visible {
      outline: 2px solid var(--color-primary);
      outline-offset: 2px;
    }

    /* ─── Toast notifications ────────────────────────────── */
    .toast-container {
      position: fixed;
      bottom: var(--space-6);
      right: var(--space-6);
      display: flex;
      flex-direction: column-reverse;
      gap: var(--space-2);
      z-index: 500;
      pointer-events: none;
    }
    .toast {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3) var(--space-5);
      background: var(--color-surface-raised);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-lg);
      font-size: var(--font-size-sm);
      font-weight: 500;
      pointer-events: auto;
      animation: toast-in 300ms ease forwards;
      max-width: 340px;
    }
    .toast.is-exiting {
      animation: toast-out 200ms ease forwards;
    }
    .toast-icon {
      font-size: 1.1rem;
      flex-shrink: 0;
    }
    .toast.toast--success { border-inline-start: 3px solid var(--color-success); }
    .toast.toast--error { border-inline-start: 3px solid var(--color-danger); }
    .toast.toast--info { border-inline-start: 3px solid var(--color-info); }

    @keyframes toast-in {
      from { opacity: 0; transform: translateY(12px) scale(0.96); }
      to { opacity: 1; transform: translateY(0) scale(1); }
    }
    @keyframes toast-out {
      from { opacity: 1; transform: translateY(0) scale(1); }
      to { opacity: 0; transform: translateY(12px) scale(0.96); }
    }

    /* ─── ARIA live region (screen reader) ───────────────── */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0,0,0,0);
      white-space: nowrap;
      border: 0;
    }

    /* ─── Tab bar ─────────────────────────────────────────── */
    .tab-bar {
      display: flex;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-6);
      background: var(--color-surface);
      border-block-end: 1px solid var(--color-border);
      flex-shrink: 0;
    }
    .tab-btn {
      padding: var(--space-2) var(--space-5);
      border: none;
      border-radius: var(--radius-full);
      font-size: var(--font-size-sm);
      font-weight: 600;
      cursor: pointer;
      background: transparent;
      color: var(--color-text-secondary);
      transition: all var(--transition-fast);
      font-family: var(--font-sans);
      min-height: 44px;
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }
    .tab-btn:hover {
      background: var(--color-surface-dim);
      color: var(--color-text);
    }
    .tab-btn:focus-visible {
      outline: 2px solid var(--color-primary);
      outline-offset: 2px;
    }
    .tab-btn.is-active {
      background: var(--color-primary);
      color: #fff;
    }
    .tab-btn__icon { font-size: 1rem; }
    .tab-panel {
      display: none;
      flex-direction: column;
      gap: var(--space-6);
    }
    .tab-panel.is-active {
      display: flex;
    }

    /* ─── Display control panel ──────────────────────────── */
    .dc-group {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-lg);
      padding: var(--space-5);
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
      box-shadow: var(--shadow-sm);
    }
    .dc-group__title {
      font-size: var(--font-size-sm);
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: var(--color-text-muted);
    }
    .mode-switcher {
      display: flex;
      gap: 0;
      border: 2px solid var(--color-border);
      border-radius: var(--radius-md);
      overflow: hidden;
    }
    .mode-switcher__btn {
      flex: 1;
      padding: var(--space-3) var(--space-4);
      border: none;
      background: var(--color-surface);
      color: var(--color-text-secondary);
      font-size: var(--font-size-sm);
      font-weight: 600;
      cursor: pointer;
      transition: all var(--transition-fast);
      font-family: var(--font-sans);
      text-align: center;
      min-height: 48px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-2);
    }
    .mode-switcher__btn + .mode-switcher__btn {
      border-inline-start: 1px solid var(--color-border);
    }
    .mode-switcher__btn:hover {
      background: var(--color-surface-dim);
    }
    .mode-switcher__btn:focus-visible {
      outline: 2px solid var(--color-primary);
      outline-offset: -2px;
    }
    .mode-switcher__btn.is-active {
      background: var(--color-primary);
      color: #fff;
    }
    .btn-panic {
      width: 100%;
      padding: var(--space-4);
      border: 2px solid var(--color-danger);
      border-radius: var(--radius-md);
      background: var(--color-danger-light);
      color: var(--color-danger);
      font-size: var(--font-size-lg);
      font-weight: 700;
      cursor: pointer;
      transition: all var(--transition-fast);
      font-family: var(--font-sans);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      min-height: 56px;
    }
    .btn-panic:hover {
      background: var(--color-danger);
      color: #fff;
    }
    .btn-panic:focus-visible {
      outline: 2px solid var(--color-danger);
      outline-offset: 2px;
    }
    .btn-panic.is-blanked {
      background: var(--color-danger);
      color: #fff;
      animation: pulse-panic 2s ease-in-out infinite;
    }
    @keyframes pulse-panic {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.85; }
    }
    .pinned-info {
      display: flex;
      align-items: center;
      gap: var(--space-3);
      padding: var(--space-3) var(--space-4);
      background: var(--color-surface-dim);
      border-radius: var(--radius-md);
      min-height: 48px;
    }
    .pinned-info__icon {
      font-size: 1.1rem;
      flex-shrink: 0;
    }
    .pinned-info__text {
      flex: 1;
      font-size: var(--font-size-sm);
      word-break: break-word;
      line-height: 1.5;
    }
    .pinned-info__empty {
      color: var(--color-text-muted);
      font-style: italic;
    }
    .pinned-info .btn-pin {
      min-width: 36px;
      min-height: 36px;
    }
    .dc-save-row {
      display: flex;
      gap: var(--space-3);
    }
    .dc-save-row .btn-save { flex: 1; }

    /* ─── Responsive ─────────────────────────────────────── */
    @media (max-width: 640px) {
      .main-content { padding: var(--space-4); }
      .status-bar { padding-inline: var(--space-3); gap: var(--space-2); }
      .status-bar__brand-icon { display: none; }
      .queue-card { padding: var(--space-3) var(--space-4); }
    }
  </style>
</head>
<body>
  <!-- Skip to content -->
  <a class="skip-link" href="#main-content">Skip to main content</a>

  <!-- Screen reader live region -->
  <div id="sr-announcer" class="sr-only" aria-live="polite" aria-atomic="true"></div>

  <!-- ─── Auth overlay ──────────────────────────────────── -->
  <div class="auth-overlay" id="authOverlay" role="dialog" aria-labelledby="authTitle" aria-modal="true">
    <div class="auth-card">
      <span class="auth-icon" aria-hidden="true">&#x1F42D;</span>
      <h1 id="authTitle">a nonna mouse</h1>
      <p class="auth-subtitle">Teacher Dashboard &mdash; enter your admin passphrase to continue.</p>
      <form class="auth-field" id="authForm" autocomplete="off">
        <label for="authInput">Admin Passphrase</label>
        <input
          type="password"
          id="authInput"
          placeholder="Enter passphrase..."
          autocomplete="current-password"
          spellcheck="false"
          required
        >
        <div class="auth-error" id="authError" role="alert" aria-live="assertive"></div>
        <button type="submit" class="auth-btn" id="authBtn">Sign In</button>
      </form>
    </div>
  </div>

  <!-- ─── App layout ────────────────────────────────────── -->
  <div class="app-layout" id="appLayout">

    <!-- Status bar -->
    <header class="status-bar" role="banner">
      <div class="status-bar__brand">
        <span class="status-bar__brand-icon" aria-hidden="true">&#x1F42D;</span>
        <span>a nonna mouse</span>
      </div>
      <div class="status-bar__session" role="status" aria-label="Session status">
        <span class="session-dot is-inactive" id="sessionDot"></span>
        <span class="session-label" id="sessionLabel">Inactive</span>
      </div>
      <span class="pending-badge" id="pendingBadge" data-count="0" aria-label="Pending submissions">
        <span id="pendingCount">0</span> pending
      </span>
      <span class="status-bar__spacer"></span>
      <div class="connection-indicator" role="status" aria-label="Connection status">
        <span class="connection-dot" id="connectionDot"></span>
        <span id="connectionLabel">Connected</span>
      </div>
      <button
        class="btn-session-toggle is-start"
        id="sessionToggleBtn"
        type="button"
        aria-label="Start session"
      >Start Session</button>
      <button
        class="btn-settings-toggle"
        id="settingsToggleBtn"
        type="button"
        aria-label="Open settings panel"
        aria-expanded="false"
        aria-controls="settingsPanel"
      >&#x2699;</button>
    </header>

    <!-- Tab bar -->
    <nav class="tab-bar" role="tablist" aria-label="Dashboard sections">
      <button class="tab-btn is-active" id="tabModeration" data-tab="moderation" role="tab" aria-selected="true" aria-controls="panelModeration" type="button">
        <span class="tab-btn__icon" aria-hidden="true">&#x1F4CB;</span> Moderation
      </button>
      <button class="tab-btn" id="tabDisplay" data-tab="display" role="tab" aria-selected="false" aria-controls="panelDisplay" type="button">
        <span class="tab-btn__icon" aria-hidden="true">&#x1F4FA;</span> Display Control
      </button>
    </nav>

    <!-- Main content -->
    <main class="main-content" id="main-content">

      <!-- ═══ Moderation tab panel ═══ -->
      <div class="tab-panel is-active" id="panelModeration" role="tabpanel" aria-labelledby="tabModeration">

      <!-- Moderation queue -->
      <section aria-labelledby="queueTitle">
        <div class="section-header">
          <h2 class="section-title" id="queueTitle">
            Moderation Queue
            <span class="section-count" id="queueCount"></span>
          </h2>
          <div class="queue-actions">
            <button class="btn btn--success" id="approveAllBtn" type="button" disabled>
              &#x2713; Approve All
            </button>
          </div>
        </div>
        <div class="queue-list" id="queueList" role="list" aria-label="Pending submissions">
          <div class="queue-empty" id="queueEmpty">
            <span class="queue-empty-icon" aria-hidden="true">&#x1F44D;</span>
            No pending comments
          </div>
        </div>
      </section>

      <!-- Approved history -->
      <section class="approved-section" aria-labelledby="approvedTitle">
        <div class="section-header">
          <h2 class="section-title" id="approvedTitle">
            Approved History
            <span class="section-count" id="approvedCount"></span>
          </h2>
        </div>
        <div class="bulk-bar" id="bulkBar">
          <div class="bulk-bar__select">
            <button class="bulk-bar__link" id="bulkSelectAll" type="button">Select all</button>
            <button class="bulk-bar__link" id="bulkSelectNone" type="button">None</button>
          </div>
          <span class="bulk-bar__count" id="bulkCount"></span>
          <div class="bulk-bar__actions">
            <button class="btn-bulk" id="bulkExport" type="button" disabled>Export</button>
            <button class="btn-bulk btn-bulk--danger" id="bulkDelete" type="button" disabled>Delete</button>
          </div>
        </div>
        <div class="approved-list" id="approvedList" role="list" aria-label="Approved comments">
          <div class="approved-empty" id="approvedEmpty">
            No approved comments yet.
          </div>
        </div>
      </section>

      </div><!-- /panelModeration -->

      <!-- ═══ Display Control tab panel ═══ -->
      <div class="tab-panel" id="panelDisplay" role="tabpanel" aria-labelledby="tabDisplay">

        <!-- Display Mode -->
        <div class="dc-group">
          <h3 class="dc-group__title">Display Mode</h3>
          <div class="mode-switcher" id="dcModeSwitcher" role="radiogroup" aria-label="Display mode">
            <button class="mode-switcher__btn is-active" data-mode="cards" role="radio" aria-checked="true" type="button">&#x1F0CF; Cards</button>
            <button class="mode-switcher__btn" data-mode="ticker" role="radio" aria-checked="false" type="button">&#x1F4DC; Ticker</button>
            <button class="mode-switcher__btn" data-mode="postits" role="radio" aria-checked="false" type="button">&#x1F4DD; Post-its</button>
          </div>
        </div>

        <!-- Cycling -->
        <div class="dc-group">
          <h3 class="dc-group__title">Cycling</h3>
          <div class="setting-row toggle-row">
            <span>Auto-cycle comments</span>
            <label class="toggle-switch" for="dcAutoCycle">
              <input type="checkbox" id="dcAutoCycle">
              <span class="toggle-slider" aria-hidden="true"></span>
            </label>
          </div>
          <div class="setting-row slider-row">
            <label for="dcCycleSpeed">Cycle speed (seconds)</label>
            <div class="slider-row__control">
              <input type="range" id="dcCycleSpeed" min="3" max="30" step="1" value="8">
              <span class="slider-row__value" id="dcCycleSpeedValue">8s</span>
            </div>
          </div>
        </div>

        <!-- Appearance -->
        <div class="dc-group">
          <h3 class="dc-group__title">Appearance</h3>
          <div class="setting-row">
            <label for="dcHistoryDepth">History depth (max visible)</label>
            <input type="number" id="dcHistoryDepth" min="1" max="50" step="1" value="12">
          </div>
          <div class="setting-row">
            <label for="dcFontSize">Font size</label>
            <select id="dcFontSize">
              <option value="normal">Normal</option>
              <option value="large">Large</option>
              <option value="xlarge">Extra Large</option>
            </select>
          </div>
          <div class="setting-row">
            <label for="dcTheme">Theme</label>
            <select id="dcTheme">
              <option value="auto">Auto (follow system)</option>
              <option value="light">Light</option>
              <option value="dark">Dark</option>
            </select>
          </div>
        </div>

        <!-- Pinned Comment -->
        <div class="dc-group">
          <h3 class="dc-group__title">Pinned Comment</h3>
          <div class="pinned-info" id="dcPinnedInfo">
            <span class="pinned-info__icon" aria-hidden="true">&#x1F4CC;</span>
            <span class="pinned-info__text pinned-info__empty" id="dcPinnedText">No comment currently pinned</span>
          </div>
        </div>

        <!-- Blank Display -->
        <button class="btn-panic" id="dcBlankBtn" type="button">
          &#x26A0;&#xFE0F; Blank Display
        </button>

        <!-- Save -->
        <div class="dc-save-row">
          <button class="btn-save" id="dcSaveBtn" type="button">Save Display Settings</button>
        </div>

      </div><!-- /panelDisplay -->

    </main>
  </div>

  <!-- ─── Settings panel ─────────────────────────────────── -->
  <div class="settings-backdrop" id="settingsBackdrop" aria-hidden="true"></div>
  <aside
    class="settings-panel"
    id="settingsPanel"
    role="dialog"
    aria-labelledby="settingsTitle"
    aria-modal="true"
  >
    <div class="settings-panel__header">
      <h2 class="settings-panel__title" id="settingsTitle">Settings</h2>
      <button class="btn-close-settings" id="settingsCloseBtn" type="button" aria-label="Close settings">
        &#x2715;
      </button>
    </div>
    <div class="settings-panel__body">

      <!-- Submission settings -->
      <div class="settings-group">
        <h3 class="settings-group__title">Submissions</h3>
        <div class="setting-row">
          <label for="settCooldown">Cooldown (minutes)</label>
          <input type="number" id="settCooldown" min="0" max="60" step="0.5" value="1">
        </div>
        <div class="setting-row">
          <label for="settMaxLength">Max comment length</label>
          <input type="number" id="settMaxLength" min="10" max="2000" step="10" value="280">
        </div>
      </div>

      <!-- Moderation settings -->
      <div class="settings-group">
        <h3 class="settings-group__title">Auto-Moderation</h3>
        <div class="setting-row toggle-row">
          <span>Auto-approve</span>
          <label class="toggle-switch" for="settAutoApprove">
            <input type="checkbox" id="settAutoApprove" checked>
            <span class="toggle-slider" aria-hidden="true"></span>
          </label>
        </div>
        <div class="setting-row slider-row">
          <label for="settThreshold">Auto-approve threshold</label>
          <div class="slider-row__control">
            <input type="range" id="settThreshold" min="0" max="1" step="0.05" value="0.5">
            <span class="slider-row__value" id="settThresholdValue">50%</span>
          </div>
        </div>
      </div>

      <!-- Admin settings -->
      <div class="settings-group">
        <h3 class="settings-group__title">Admin</h3>
        <div class="setting-row">
          <label for="settPassphrase">Admin passphrase</label>
          <input type="password" id="settPassphrase" placeholder="Enter new passphrase..." autocomplete="off">
        </div>
      </div>

    </div>
    <div class="settings-panel__footer">
      <button class="btn-save" id="saveSettingsBtn" type="button">Save Settings</button>
    </div>
  </aside>

  <!-- ─── Toast container ────────────────────────────────── -->
  <div class="toast-container" id="toastContainer" aria-live="polite"></div>

  <!-- ─── Application JavaScript ─────────────────────────── -->
  <script>
  (function() {
    'use strict';

    // ═══════════════════════════════════════════════════════
    //  Configuration
    // ═══════════════════════════════════════════════════════

    /** @type {string} Replace with your Google Apps Script deployment URL */
    var API_URL = 'https://script.google.com/macros/s/AKfycbxsXnN9DcrTQZeeB90xvTF70h0VA59LjNAz1vj3FJeE_H999VYuJi18jxBiSPDiP_Tzwg/exec';

    // ═══════════════════════════════════════════════════════
    //  State
    // ═══════════════════════════════════════════════════════

    var state = {
      passphrase: sessionStorage.getItem('anm_passphrase') || '',
      authenticated: false,
      sessionActive: false,
      pendingCount: 0,
      config: {},
      pendingItems: [],
      approvedItems: [],
      focusedCardIndex: -1,
      settingsOpen: false,
      /** @type {string|null} */
      pinnedCommentId: null
    };

    // Polling intervals
    var POLL_PENDING_MS = 5000;
    var POLL_STATE_MS = 10000;
    var POLL_APPROVED_MS = 10000;
    var POLL_HIDDEN_MULTIPLIER = 3; // slow down when tab hidden

    var pendingTimer = null;
    var stateTimer = null;
    var approvedTimer = null;

    // Toast management
    var MAX_TOASTS = 3;

    // ═══════════════════════════════════════════════════════
    //  DOM references
    // ═══════════════════════════════════════════════════════

    var els = {
      authOverlay: document.getElementById('authOverlay'),
      authForm: document.getElementById('authForm'),
      authInput: document.getElementById('authInput'),
      authError: document.getElementById('authError'),
      authBtn: document.getElementById('authBtn'),
      appLayout: document.getElementById('appLayout'),
      sessionDot: document.getElementById('sessionDot'),
      sessionLabel: document.getElementById('sessionLabel'),
      pendingBadge: document.getElementById('pendingBadge'),
      pendingCount: document.getElementById('pendingCount'),
      connectionDot: document.getElementById('connectionDot'),
      connectionLabel: document.getElementById('connectionLabel'),
      sessionToggleBtn: document.getElementById('sessionToggleBtn'),
      settingsToggleBtn: document.getElementById('settingsToggleBtn'),
      // Tab navigation
      tabModeration: document.getElementById('tabModeration'),
      tabDisplay: document.getElementById('tabDisplay'),
      panelModeration: document.getElementById('panelModeration'),
      panelDisplay: document.getElementById('panelDisplay'),
      // Display control
      dcModeSwitcher: document.getElementById('dcModeSwitcher'),
      dcAutoCycle: document.getElementById('dcAutoCycle'),
      dcCycleSpeed: document.getElementById('dcCycleSpeed'),
      dcCycleSpeedValue: document.getElementById('dcCycleSpeedValue'),
      dcHistoryDepth: document.getElementById('dcHistoryDepth'),
      dcFontSize: document.getElementById('dcFontSize'),
      dcTheme: document.getElementById('dcTheme'),
      dcPinnedInfo: document.getElementById('dcPinnedInfo'),
      dcPinnedText: document.getElementById('dcPinnedText'),
      dcBlankBtn: document.getElementById('dcBlankBtn'),
      dcSaveBtn: document.getElementById('dcSaveBtn'),
      queueList: document.getElementById('queueList'),
      queueCount: document.getElementById('queueCount'),
      queueEmpty: document.getElementById('queueEmpty'),
      approveAllBtn: document.getElementById('approveAllBtn'),
      approvedList: document.getElementById('approvedList'),
      approvedCount: document.getElementById('approvedCount'),
      approvedEmpty: document.getElementById('approvedEmpty'),
      bulkBar: document.getElementById('bulkBar'),
      bulkSelectAll: document.getElementById('bulkSelectAll'),
      bulkSelectNone: document.getElementById('bulkSelectNone'),
      bulkCount: document.getElementById('bulkCount'),
      bulkExport: document.getElementById('bulkExport'),
      bulkDelete: document.getElementById('bulkDelete'),
      settingsBackdrop: document.getElementById('settingsBackdrop'),
      settingsPanel: document.getElementById('settingsPanel'),
      settingsCloseBtn: document.getElementById('settingsCloseBtn'),
      settCooldown: document.getElementById('settCooldown'),
      settMaxLength: document.getElementById('settMaxLength'),
      settAutoApprove: document.getElementById('settAutoApprove'),
      settThreshold: document.getElementById('settThreshold'),
      settThresholdValue: document.getElementById('settThresholdValue'),
      settPassphrase: document.getElementById('settPassphrase'),
      saveSettingsBtn: document.getElementById('saveSettingsBtn'),
      toastContainer: document.getElementById('toastContainer'),
      srAnnouncer: document.getElementById('sr-announcer')
    };

    // ═══════════════════════════════════════════════════════
    //  Utility helpers
    // ═══════════════════════════════════════════════════════

    /**
     * Escape HTML to prevent XSS.
     * @param {string} str
     * @returns {string}
     */
    function escapeHtml(str) {
      var div = document.createElement('div');
      div.textContent = String(str);
      return div.innerHTML;
    }

    /**
     * Format a timestamp as relative time (e.g. "2m ago").
     * @param {string} isoString
     * @returns {string}
     */
    function relativeTime(isoString) {
      if (!isoString) return '';
      var now = Date.now();
      var then = new Date(isoString).getTime();
      if (isNaN(then)) return '';
      var diffSec = Math.floor((now - then) / 1000);
      if (diffSec < 5) return 'just now';
      if (diffSec < 60) return diffSec + 's ago';
      var diffMin = Math.floor(diffSec / 60);
      if (diffMin < 60) return diffMin + 'm ago';
      var diffHr = Math.floor(diffMin / 60);
      if (diffHr < 24) return diffHr + 'h ago';
      var diffDays = Math.floor(diffHr / 24);
      return diffDays + 'd ago';
    }

    /**
     * Announce a message to screen readers.
     * @param {string} msg
     */
    function announce(msg) {
      els.srAnnouncer.textContent = msg;
    }

    // ═══════════════════════════════════════════════════════
    //  API layer
    // ═══════════════════════════════════════════════════════

    /**
     * Call the Google Apps Script backend.
     * @param {string} route
     * @param {Object} [payload={}]
     * @returns {Promise<Object>}
     */
    function apiCall(route, payload) {
      payload = payload || {};
      var url = API_URL +
        '?route=' + encodeURIComponent(route) +
        '&payload=' + encodeURIComponent(JSON.stringify(payload));

      return fetch(url, { method: 'GET', redirect: 'follow' })
        .then(function(res) {
          if (!res.ok) throw new Error('HTTP ' + res.status);
          return res.json();
        })
        .then(function(json) {
          setConnectionStatus('ok');
          if (!json.ok) throw new Error(json.error || 'Unknown server error');
          return json.data;
        })
        .catch(function(err) {
          setConnectionStatus('error');
          throw err;
        });
    }

    /**
     * Update the connection status indicator.
     * @param {'ok'|'error'|'loading'} status
     */
    function setConnectionStatus(status) {
      els.connectionDot.className = 'connection-dot';
      if (status === 'error') {
        els.connectionDot.classList.add('is-error');
        els.connectionLabel.textContent = 'Disconnected';
      } else if (status === 'loading') {
        els.connectionDot.classList.add('is-loading');
        els.connectionLabel.textContent = 'Loading...';
      } else {
        els.connectionLabel.textContent = 'Connected';
      }
    }

    // ═══════════════════════════════════════════════════════
    //  Toast notifications
    // ═══════════════════════════════════════════════════════

    /**
     * Show a toast notification.
     * @param {string} message
     * @param {'success'|'error'|'info'} [type='info']
     */
    function showToast(message, type) {
      type = type || 'info';

      // Enforce max visible toasts
      var existing = els.toastContainer.querySelectorAll('.toast:not(.is-exiting)');
      while (existing.length >= MAX_TOASTS) {
        dismissToast(existing[0]);
        existing = els.toastContainer.querySelectorAll('.toast:not(.is-exiting)');
      }

      var icons = { success: '\u2713', error: '\u2717', info: '\u2139' };
      var toast = document.createElement('div');
      toast.className = 'toast toast--' + type;
      toast.setAttribute('role', 'status');

      var iconSpan = document.createElement('span');
      iconSpan.className = 'toast-icon';
      iconSpan.setAttribute('aria-hidden', 'true');
      iconSpan.textContent = icons[type] || icons.info;
      toast.appendChild(iconSpan);

      var msgSpan = document.createElement('span');
      msgSpan.textContent = message;
      toast.appendChild(msgSpan);

      els.toastContainer.appendChild(toast);

      // Auto-dismiss after 3 seconds
      setTimeout(function() { dismissToast(toast); }, 3000);
    }

    /**
     * Dismiss a toast element with animation.
     * @param {HTMLElement} toast
     */
    function dismissToast(toast) {
      if (!toast || toast.classList.contains('is-exiting')) return;
      toast.classList.add('is-exiting');
      setTimeout(function() {
        if (toast.parentNode) toast.parentNode.removeChild(toast);
      }, 250);
    }

    // ═══════════════════════════════════════════════════════
    //  Authentication
    // ═══════════════════════════════════════════════════════

    /**
     * Handle auth form submission — verify passphrase by calling getState,
     * then check if the passphrase works via a test updateConfig call.
     */
    function handleAuth(e) {
      e.preventDefault();
      var passphrase = els.authInput.value.trim();
      if (!passphrase) {
        els.authError.textContent = 'Please enter a passphrase.';
        return;
      }

      els.authBtn.disabled = true;
      els.authBtn.textContent = 'Verifying...';
      els.authError.textContent = '';

      // Verify by attempting a no-op updateConfig with the passphrase
      apiCall('updateConfig', { passphrase: passphrase, settings: {} })
        .then(function() {
          state.passphrase = passphrase;
          state.authenticated = true;
          sessionStorage.setItem('anm_passphrase', passphrase);
          els.authOverlay.setAttribute('hidden', '');
          els.appLayout.classList.add('is-active');
          startPolling();
          // Initial data fetch
          fetchState();
          fetchPending();
          fetchApproved();
          announce('Signed in successfully. Dashboard loaded.');
        })
        .catch(function(err) {
          var msg = (err.message || '').toLowerCase();
          if (msg.indexOf('passphrase') !== -1 || msg.indexOf('invalid') !== -1) {
            els.authError.textContent = 'Invalid passphrase. Please try again.';
          } else {
            els.authError.textContent = 'Connection error. Check your API URL and try again.';
          }
          els.authInput.focus();
          els.authInput.select();
        })
        .finally(function() {
          els.authBtn.disabled = false;
          els.authBtn.textContent = 'Sign In';
        });
    }

    /**
     * Try to auto-authenticate with a stored passphrase.
     */
    function tryAutoAuth() {
      if (!state.passphrase) return;
      setConnectionStatus('loading');
      apiCall('updateConfig', { passphrase: state.passphrase, settings: {} })
        .then(function() {
          state.authenticated = true;
          els.authOverlay.setAttribute('hidden', '');
          els.appLayout.classList.add('is-active');
          startPolling();
          fetchState();
          fetchPending();
          fetchApproved();
        })
        .catch(function() {
          // Stored passphrase is invalid — show auth form
          state.passphrase = '';
          sessionStorage.removeItem('anm_passphrase');
          els.authInput.focus();
        });
    }

    // ═══════════════════════════════════════════════════════
    //  Polling
    // ═══════════════════════════════════════════════════════

    function getInterval(baseMs) {
      return document.hidden ? baseMs * POLL_HIDDEN_MULTIPLIER : baseMs;
    }

    function startPolling() {
      stopPolling();
      schedulePendingPoll();
      scheduleStatePoll();
      scheduleApprovedPoll();
    }

    function stopPolling() {
      if (pendingTimer) clearTimeout(pendingTimer);
      if (stateTimer) clearTimeout(stateTimer);
      if (approvedTimer) clearTimeout(approvedTimer);
    }

    function schedulePendingPoll() {
      pendingTimer = setTimeout(function() {
        fetchPending().finally(schedulePendingPoll);
      }, getInterval(POLL_PENDING_MS));
    }

    function scheduleStatePoll() {
      stateTimer = setTimeout(function() {
        fetchState().finally(scheduleStatePoll);
      }, getInterval(POLL_STATE_MS));
    }

    function scheduleApprovedPoll() {
      approvedTimer = setTimeout(function() {
        fetchApproved().finally(scheduleApprovedPoll);
      }, getInterval(POLL_APPROVED_MS));
    }

    // Adjust polling when visibility changes
    document.addEventListener('visibilitychange', function() {
      if (!state.authenticated) return;
      stopPolling();
      startPolling();
      // Immediate fetch on return
      if (!document.hidden) {
        fetchState();
        fetchPending();
        fetchApproved();
      }
    });

    // ═══════════════════════════════════════════════════════
    //  Data fetching
    // ═══════════════════════════════════════════════════════

    function fetchState() {
      return apiCall('getState')
        .then(function(data) {
          state.config = data.config || {};
          state.pendingCount = data.pendingCount || 0;

          // Session status
          var active = String(state.config.sessionActive).toLowerCase() === 'true';
          state.sessionActive = active;
          updateSessionUI();
          updatePendingBadge();
          updateSettingsForm();
          // Also update display controls if that tab is active
          if (els.panelDisplay.classList.contains('is-active')) {
            updateDisplayControls();
          }
        })
        .catch(function() { /* handled by connection indicator */ });
    }

    function fetchPending() {
      return apiCall('getPending', { passphrase: state.passphrase })
        .then(function(data) {
          state.pendingItems = (data || []).sort(function(a, b) {
            // Sort by moderation score descending (highest risk first)
            return (Number(b.moderationScore) || 0) - (Number(a.moderationScore) || 0);
          });
          state.pendingCount = state.pendingItems.length;
          updatePendingBadge();
          renderQueue();
        })
        .catch(function() { /* handled by connection indicator */ });
    }

    function fetchApproved() {
      return apiCall('getApproved')
        .then(function(data) {
          state.approvedItems = data || [];
          // Track pinned id
          state.pinnedCommentId = null;
          for (var i = 0; i < state.approvedItems.length; i++) {
            if (state.approvedItems[i].pinned) {
              state.pinnedCommentId = state.approvedItems[i].id;
              break;
            }
          }
          renderApproved();
        })
        .catch(function() { /* handled by connection indicator */ });
    }

    // ═══════════════════════════════════════════════════════
    //  UI updates
    // ═══════════════════════════════════════════════════════

    function updateSessionUI() {
      var active = state.sessionActive;
      els.sessionDot.className = 'session-dot ' + (active ? 'is-active' : 'is-inactive');
      els.sessionLabel.textContent = active ? 'Active' : 'Inactive';
      els.sessionToggleBtn.className = 'btn-session-toggle ' + (active ? 'is-stop' : 'is-start');
      els.sessionToggleBtn.textContent = active ? 'End Session' : 'Start Session';
      els.sessionToggleBtn.setAttribute('aria-label', active ? 'End session' : 'Start session');
    }

    function updatePendingBadge() {
      var count = state.pendingCount;
      els.pendingCount.textContent = count;
      els.pendingBadge.setAttribute('data-count', count);
      els.pendingBadge.setAttribute('aria-label', count + ' pending submission' + (count !== 1 ? 's' : ''));
    }

    // ═══════════════════════════════════════════════════════
    //  Queue rendering
    // ═══════════════════════════════════════════════════════

    function renderQueue() {
      var items = state.pendingItems;
      var count = items.length;

      els.queueCount.textContent = count > 0 ? '(' + count + ')' : '';
      els.approveAllBtn.disabled = count === 0;

      // Build new content
      if (count === 0) {
        els.queueList.innerHTML = '';
        var emptyDiv = document.createElement('div');
        emptyDiv.className = 'queue-empty';
        emptyDiv.id = 'queueEmpty';
        var emptyIcon = document.createElement('span');
        emptyIcon.className = 'queue-empty-icon';
        emptyIcon.setAttribute('aria-hidden', 'true');
        emptyIcon.textContent = '\uD83D\uDC4D';
        emptyDiv.appendChild(emptyIcon);
        emptyDiv.appendChild(document.createTextNode(' No pending comments'));
        els.queueList.appendChild(emptyDiv);
        return;
      }

      // Build cards via DocumentFragment
      var frag = document.createDocumentFragment();
      for (var i = 0; i < items.length; i++) {
        frag.appendChild(createQueueCard(items[i], i));
      }

      els.queueList.innerHTML = '';
      els.queueList.appendChild(frag);

      // Reset keyboard focus index to prevent acting on wrong card after re-render
      state.focusedCardIndex = -1;
    }

    /**
     * Create a queue card DOM element.
     * @param {Object} item
     * @param {number} index
     * @returns {HTMLElement}
     */
    function createQueueCard(item, index) {
      var score = Number(item.moderationScore) || 0;
      var scoreClass = score < 0.3 ? 'is-low' : score < 0.6 ? 'is-medium' : 'is-high';
      var categories = parseFlagCategories(item.flagCategories);

      // Card
      var card = document.createElement('div');
      card.className = 'queue-card';
      card.setAttribute('role', 'listitem');
      card.setAttribute('tabindex', '0');
      card.setAttribute('data-id', item.id);
      card.setAttribute('data-index', index);
      card.setAttribute('aria-label', 'Pending comment: ' + truncateText(item.text, 40));

      // Header row
      var header = document.createElement('div');
      header.className = 'queue-card__header';

      // Meta: score + flags
      var meta = document.createElement('div');
      meta.className = 'queue-card__meta';

      // Score bar
      var scoreBar = document.createElement('div');
      scoreBar.className = 'score-bar';
      var track = document.createElement('div');
      track.className = 'score-bar__track';
      var fill = document.createElement('div');
      fill.className = 'score-bar__fill ' + scoreClass;
      fill.style.width = Math.round(score * 100) + '%';
      track.appendChild(fill);
      scoreBar.appendChild(track);
      var scoreLabel = document.createElement('span');
      scoreLabel.className = 'score-bar__label ' + scoreClass;
      scoreLabel.textContent = (score * 100).toFixed(0) + '%';
      scoreBar.appendChild(scoreLabel);
      meta.appendChild(scoreBar);

      // Flag chips
      if (categories.length > 0) {
        var chipsDiv = document.createElement('div');
        chipsDiv.className = 'flag-chips';
        for (var c = 0; c < categories.length; c++) {
          var chip = document.createElement('span');
          chip.className = 'flag-chip';
          chip.textContent = categories[c];
          chipsDiv.appendChild(chip);
        }
        meta.appendChild(chipsDiv);
      }

      header.appendChild(meta);

      // Timestamp
      var timeSpan = document.createElement('span');
      timeSpan.className = 'queue-card__time';
      timeSpan.textContent = relativeTime(item.timestamp);
      timeSpan.setAttribute('title', item.timestamp || '');
      header.appendChild(timeSpan);

      card.appendChild(header);

      // Text
      var textDiv = document.createElement('div');
      textDiv.className = 'queue-card__text';
      textDiv.textContent = item.text; // XSS-safe: textContent
      card.appendChild(textDiv);

      // Footer with actions
      var footer = document.createElement('div');
      footer.className = 'queue-card__footer';
      footer.appendChild(document.createElement('span')); // spacer

      var actions = document.createElement('div');
      actions.className = 'queue-card__actions';

      // Approve button
      var approveBtn = document.createElement('button');
      approveBtn.className = 'btn-action btn-approve';
      approveBtn.setAttribute('type', 'button');
      approveBtn.setAttribute('aria-label', 'Approve this comment');
      approveBtn.setAttribute('title', 'Approve');
      approveBtn.textContent = '\u2713';
      approveBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        approveItem(item.id, card);
      });
      actions.appendChild(approveBtn);

      // Reject button
      var rejectBtn = document.createElement('button');
      rejectBtn.className = 'btn-action btn-reject';
      rejectBtn.setAttribute('type', 'button');
      rejectBtn.setAttribute('aria-label', 'Reject this comment');
      rejectBtn.setAttribute('title', 'Reject');
      rejectBtn.textContent = '\u2717';
      rejectBtn.addEventListener('click', function(e) {
        e.stopPropagation();
        rejectItem(item.id, card);
      });
      actions.appendChild(rejectBtn);

      footer.appendChild(actions);
      card.appendChild(footer);

      return card;
    }

    /**
     * Parse flagCategories from server data (could be JSON string, comma-separated, or array).
     * @param {*} raw
     * @returns {string[]}
     */
    function parseFlagCategories(raw) {
      if (!raw) return [];
      if (Array.isArray(raw)) return raw;
      var str = String(raw).trim();
      if (!str) return [];
      // Try JSON parse
      try {
        var parsed = JSON.parse(str);
        if (Array.isArray(parsed)) return parsed;
      } catch (e) { /* not JSON */ }
      // Comma separated
      return str.split(',').map(function(s) { return s.trim(); }).filter(Boolean);
    }

    /**
     * Truncate text to a max length.
     * @param {string} text
     * @param {number} max
     * @returns {string}
     */
    function truncateText(text, max) {
      if (!text) return '';
      if (text.length <= max) return text;
      return text.substring(0, max) + '...';
    }

    // ═══════════════════════════════════════════════════════
    //  Approved rendering
    // ═══════════════════════════════════════════════════════

    function renderApproved() {
      var items = state.approvedItems;
      var count = items.length;

      els.approvedCount.textContent = count > 0 ? '(' + count + ')' : '';

      if (count === 0) {
        els.approvedList.innerHTML = '';
        var emptyDiv = document.createElement('div');
        emptyDiv.className = 'approved-empty';
        emptyDiv.id = 'approvedEmpty';
        emptyDiv.textContent = 'No approved comments yet.';
        els.approvedList.appendChild(emptyDiv);
        return;
      }

      var frag = document.createDocumentFragment();

      // Show most recent first
      for (var i = items.length - 1; i >= 0; i--) {
        frag.appendChild(createApprovedCard(items[i]));
      }

      els.approvedList.innerHTML = '';
      els.approvedList.appendChild(frag);
      updateBulkBar();
    }

    /**
     * Create an approved card DOM element.
     * @param {Object} item
     * @returns {HTMLElement}
     */
    function createApprovedCard(item) {
      var isPinned = !!item.pinned;

      var card = document.createElement('div');
      card.className = 'approved-card' + (isPinned ? ' is-pinned' : '');
      card.setAttribute('role', 'listitem');
      card.setAttribute('data-id', item.id);

      // Checkbox
      var cb = document.createElement('input');
      cb.type = 'checkbox';
      cb.className = 'approved-card__check';
      cb.setAttribute('aria-label', 'Select comment');
      cb.setAttribute('data-id', item.id);
      cb.addEventListener('change', updateBulkBar);
      card.appendChild(cb);

      // Text
      var textDiv = document.createElement('div');
      textDiv.className = 'approved-card__text';
      textDiv.textContent = item.text;
      card.appendChild(textDiv);

      // Time
      var timeSpan = document.createElement('span');
      timeSpan.className = 'approved-card__time';
      timeSpan.textContent = relativeTime(item.approvedAt);
      timeSpan.setAttribute('title', item.approvedAt || '');
      card.appendChild(timeSpan);

      // Pin/unpin button
      var pinBtn = document.createElement('button');
      pinBtn.className = 'btn-pin' + (isPinned ? ' is-pinned' : '');
      pinBtn.setAttribute('type', 'button');
      pinBtn.setAttribute('aria-label', isPinned ? 'Unpin this comment' : 'Pin this comment');
      pinBtn.setAttribute('title', isPinned ? 'Unpin' : 'Pin');
      pinBtn.textContent = '\uD83D\uDCCC'; // pin emoji
      pinBtn.addEventListener('click', function() {
        if (isPinned) {
          unpinComment(item.id);
        } else {
          pinComment(item.id);
        }
      });
      card.appendChild(pinBtn);

      return card;
    }

    // ═══════════════════════════════════════════════════════
    //  Actions: approve / reject
    // ═══════════════════════════════════════════════════════

    /**
     * Approve a pending item.
     * @param {string} id
     * @param {HTMLElement} cardEl
     */
    function approveItem(id, cardEl) {
      // Optimistic UI: animate removal
      if (cardEl) {
        cardEl.classList.add('is-exiting');
      }

      // Remove from local state immediately
      state.pendingItems = state.pendingItems.filter(function(it) { return it.id !== id; });
      state.pendingCount = state.pendingItems.length;
      updatePendingBadge();

      // Remove card after animation
      setTimeout(function() {
        if (cardEl && cardEl.parentNode) cardEl.parentNode.removeChild(cardEl);
        // Update empty state
        if (state.pendingItems.length === 0) renderQueue();
        // Update count display
        els.queueCount.textContent = state.pendingItems.length > 0
          ? '(' + state.pendingItems.length + ')' : '';
        els.approveAllBtn.disabled = state.pendingItems.length === 0;
      }, 250);

      apiCall('approve', { id: id, passphrase: state.passphrase })
        .then(function() {
          showToast('Comment approved', 'success');
          announce('Comment approved.');
          // Refresh approved list to show the new one
          fetchApproved();
        })
        .catch(function(err) {
          showToast('Failed to approve: ' + err.message, 'error');
          // Re-fetch to resync
          fetchPending();
        });
    }

    /**
     * Reject a pending item.
     * @param {string} id
     * @param {HTMLElement} cardEl
     */
    function rejectItem(id, cardEl) {
      // Optimistic UI
      if (cardEl) {
        cardEl.classList.add('is-exiting');
      }

      state.pendingItems = state.pendingItems.filter(function(it) { return it.id !== id; });
      state.pendingCount = state.pendingItems.length;
      updatePendingBadge();

      setTimeout(function() {
        if (cardEl && cardEl.parentNode) cardEl.parentNode.removeChild(cardEl);
        if (state.pendingItems.length === 0) renderQueue();
        els.queueCount.textContent = state.pendingItems.length > 0
          ? '(' + state.pendingItems.length + ')' : '';
        els.approveAllBtn.disabled = state.pendingItems.length === 0;
      }, 250);

      apiCall('reject', { id: id, passphrase: state.passphrase })
        .then(function() {
          showToast('Comment rejected', 'error');
          announce('Comment rejected.');
        })
        .catch(function(err) {
          showToast('Failed to reject: ' + err.message, 'error');
          fetchPending();
        });
    }

    /**
     * Approve all pending items.
     */
    function approveAll() {
      var count = state.pendingItems.length;
      if (count === 0) return;

      // Optimistic: clear queue
      state.pendingItems = [];
      state.pendingCount = 0;
      updatePendingBadge();
      renderQueue();

      apiCall('batchApprove', { passphrase: state.passphrase })
        .then(function(data) {
          var n = data.approvedCount || count;
          showToast(n + ' comment' + (n !== 1 ? 's' : '') + ' approved', 'success');
          announce(n + ' comments approved.');
          fetchApproved();
        })
        .catch(function(err) {
          showToast('Batch approve failed: ' + err.message, 'error');
          fetchPending();
        });
    }

    // ═══════════════════════════════════════════════════════
    //  Actions: pin / unpin
    // ═══════════════════════════════════════════════════════

    function pinComment(id) {
      apiCall('pinComment', { id: id, passphrase: state.passphrase })
        .then(function() {
          state.pinnedCommentId = id;
          showToast('Comment pinned', 'success');
          announce('Comment pinned.');
          fetchApproved();
        })
        .catch(function(err) {
          showToast('Failed to pin: ' + err.message, 'error');
        });
    }

    function unpinComment(id) {
      apiCall('unpinComment', { passphrase: state.passphrase })
        .then(function() {
          state.pinnedCommentId = null;
          showToast('Comment unpinned', 'info');
          announce('Comment unpinned.');
          fetchApproved();
        })
        .catch(function(err) {
          showToast('Failed to unpin: ' + err.message, 'error');
        });
    }

    // ═══════════════════════════════════════════════════════
    //  Bulk selection & actions (approved list)
    // ═══════════════════════════════════════════════════════

    /** Get all selected comment IDs from checkboxes. */
    function getSelectedIds() {
      var checks = els.approvedList.querySelectorAll('.approved-card__check:checked');
      var ids = [];
      for (var i = 0; i < checks.length; i++) {
        ids.push(checks[i].getAttribute('data-id'));
      }
      return ids;
    }

    /** Update the bulk toolbar count and button states. */
    function updateBulkBar() {
      var selected = getSelectedIds();
      var total = state.approvedItems.length;
      if (selected.length > 0) {
        els.bulkCount.textContent = selected.length + ' of ' + total + ' selected';
      } else {
        els.bulkCount.textContent = '';
      }
      els.bulkDelete.disabled = selected.length === 0;
      els.bulkExport.disabled = selected.length === 0;
    }

    /** Select all checkboxes in approved list. */
    function bulkSelectAll() {
      var checks = els.approvedList.querySelectorAll('.approved-card__check');
      for (var i = 0; i < checks.length; i++) { checks[i].checked = true; }
      updateBulkBar();
    }

    /** Deselect all checkboxes in approved list. */
    function bulkSelectNone() {
      var checks = els.approvedList.querySelectorAll('.approved-card__check');
      for (var i = 0; i < checks.length; i++) { checks[i].checked = false; }
      updateBulkBar();
    }

    /** Delete selected approved comments. */
    function bulkDeleteSelected() {
      var ids = getSelectedIds();
      if (ids.length === 0) return;
      if (!confirm('Delete ' + ids.length + ' comment' + (ids.length !== 1 ? 's' : '') + '? This cannot be undone.')) return;

      els.bulkDelete.disabled = true;
      els.bulkDelete.textContent = 'Deleting...';

      apiCall('deleteApproved', { ids: ids, passphrase: state.passphrase })
        .then(function(data) {
          var n = data.deletedCount || ids.length;
          showToast(n + ' comment' + (n !== 1 ? 's' : '') + ' deleted', 'success');
          announce(n + ' comments deleted.');
          // Remove from local state
          state.approvedItems = state.approvedItems.filter(function(item) {
            return ids.indexOf(item.id) === -1;
          });
          renderApproved();
          updateBulkBar();
        })
        .catch(function(err) {
          showToast('Delete failed: ' + err.message, 'error');
        })
        .finally(function() {
          els.bulkDelete.disabled = false;
          els.bulkDelete.textContent = 'Delete';
        });
    }

    /** Export selected approved comments as a text file download. */
    function bulkExportSelected() {
      var ids = getSelectedIds();
      if (ids.length === 0) return;

      // Build a lookup of selected IDs
      var idSet = {};
      for (var i = 0; i < ids.length; i++) { idSet[ids[i]] = true; }

      // Gather the matching items in display order
      var lines = [];
      for (var j = 0; j < state.approvedItems.length; j++) {
        var item = state.approvedItems[j];
        if (idSet[item.id]) {
          var time = item.approvedAt || '';
          lines.push('[' + time + '] ' + item.text);
        }
      }

      var blob = new Blob([lines.join('\n')], { type: 'text/plain' });
      var url = URL.createObjectURL(blob);
      var a = document.createElement('a');
      a.href = url;
      a.download = 'approved-comments-' + new Date().toISOString().slice(0, 10) + '.txt';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      URL.revokeObjectURL(url);

      showToast(ids.length + ' comment' + (ids.length !== 1 ? 's' : '') + ' exported', 'success');
    }

    // ═══════════════════════════════════════════════════════
    //  Session toggle
    // ═══════════════════════════════════════════════════════

    function toggleSession() {
      var newActive = !state.sessionActive;
      els.sessionToggleBtn.disabled = true;

      apiCall('updateConfig', {
        passphrase: state.passphrase,
        settings: { sessionActive: newActive }
      })
        .then(function() {
          state.sessionActive = newActive;
          updateSessionUI();
          showToast(
            newActive ? 'Session started' : 'Session ended',
            newActive ? 'success' : 'info'
          );
          announce(newActive ? 'Session started.' : 'Session ended.');
        })
        .catch(function(err) {
          showToast('Failed to toggle session: ' + err.message, 'error');
        })
        .finally(function() {
          els.sessionToggleBtn.disabled = false;
        });
    }

    // ═══════════════════════════════════════════════════════
    //  Tab navigation
    // ═══════════════════════════════════════════════════════

    /**
     * Switch between Moderation and Display tabs.
     * @param {string} tabName - 'moderation' or 'display'
     */
    function switchTab(tabName) {
      // Update tab buttons
      var tabs = [els.tabModeration, els.tabDisplay];
      tabs.forEach(function(btn) {
        var isActive = btn.getAttribute('data-tab') === tabName;
        btn.classList.toggle('is-active', isActive);
        btn.setAttribute('aria-selected', isActive ? 'true' : 'false');
      });
      // Update panels
      els.panelModeration.classList.toggle('is-active', tabName === 'moderation');
      els.panelDisplay.classList.toggle('is-active', tabName === 'display');

      // When switching to display tab, refresh controls from current config
      if (tabName === 'display') {
        updateDisplayControls();
      }
    }

    // ═══════════════════════════════════════════════════════
    //  Display control panel
    // ═══════════════════════════════════════════════════════

    /**
     * Update display control UI from current config state.
     */
    function updateDisplayControls() {
      var c = state.config;

      // Mode switcher
      var activeMode = String(c.displayMode || 'cards').toLowerCase();
      els.dcModeSwitcher.querySelectorAll('.mode-switcher__btn').forEach(function(btn) {
        var isActive = btn.getAttribute('data-mode') === activeMode;
        btn.classList.toggle('is-active', isActive);
        btn.setAttribute('aria-checked', isActive ? 'true' : 'false');
      });

      // Auto-cycle
      els.dcAutoCycle.checked = String(c.autoCycle).toLowerCase() === 'true';

      // Cycle speed
      var speed = Number(c.cycleSpeed) || 8;
      els.dcCycleSpeed.value = speed;
      els.dcCycleSpeedValue.textContent = speed + 's';

      // History depth
      els.dcHistoryDepth.value = Number(c.historyDepth) || 12;

      // Font size
      if (c.fontSize) els.dcFontSize.value = c.fontSize;

      // Theme
      if (c.displayTheme) els.dcTheme.value = c.displayTheme;

      // Blank button
      var blanked = String(c.displayBlanked).toLowerCase() === 'true';
      els.dcBlankBtn.classList.toggle('is-blanked', blanked);
      els.dcBlankBtn.innerHTML = blanked
        ? '&#x2705; Display Blanked &mdash; Click to Restore'
        : '&#x26A0;&#xFE0F; Blank Display';

      // Pinned info
      updatePinnedInfo();
    }

    /**
     * Update the pinned comment info box in the Display tab.
     */
    function updatePinnedInfo() {
      var pinned = null;
      if (state.pinnedCommentId) {
        for (var i = 0; i < state.approvedItems.length; i++) {
          if (state.approvedItems[i].id === state.pinnedCommentId) {
            pinned = state.approvedItems[i];
            break;
          }
        }
      }

      if (pinned) {
        els.dcPinnedInfo.innerHTML = '';
        var icon = document.createElement('span');
        icon.className = 'pinned-info__icon';
        icon.setAttribute('aria-hidden', 'true');
        icon.textContent = '\uD83D\uDCCC';
        els.dcPinnedInfo.appendChild(icon);

        var text = document.createElement('span');
        text.className = 'pinned-info__text';
        text.textContent = pinned.text;
        els.dcPinnedInfo.appendChild(text);

        var unpinBtn = document.createElement('button');
        unpinBtn.className = 'btn-pin is-pinned';
        unpinBtn.setAttribute('type', 'button');
        unpinBtn.setAttribute('aria-label', 'Unpin this comment');
        unpinBtn.setAttribute('title', 'Unpin');
        unpinBtn.textContent = '\uD83D\uDCCC';
        unpinBtn.addEventListener('click', function() {
          unpinComment(pinned.id);
        });
        els.dcPinnedInfo.appendChild(unpinBtn);
      } else {
        els.dcPinnedInfo.innerHTML = '';
        var emptyIcon = document.createElement('span');
        emptyIcon.className = 'pinned-info__icon';
        emptyIcon.setAttribute('aria-hidden', 'true');
        emptyIcon.textContent = '\uD83D\uDCCC';
        els.dcPinnedInfo.appendChild(emptyIcon);

        var emptyText = document.createElement('span');
        emptyText.className = 'pinned-info__text pinned-info__empty';
        emptyText.textContent = 'No comment currently pinned';
        els.dcPinnedInfo.appendChild(emptyText);
      }
    }

    /**
     * Save display settings from the Display Control tab.
     */
    function saveDisplaySettings() {
      var activeMode = 'cards';
      els.dcModeSwitcher.querySelectorAll('.mode-switcher__btn').forEach(function(btn) {
        if (btn.classList.contains('is-active')) activeMode = btn.getAttribute('data-mode');
      });

      var settings = {
        displayMode: activeMode,
        autoCycle: els.dcAutoCycle.checked,
        cycleSpeed: Number(els.dcCycleSpeed.value) || 8,
        historyDepth: Number(els.dcHistoryDepth.value) || 12,
        fontSize: els.dcFontSize.value,
        displayTheme: els.dcTheme.value
      };

      els.dcSaveBtn.disabled = true;
      els.dcSaveBtn.textContent = 'Saving...';

      apiCall('updateConfig', { passphrase: state.passphrase, settings: settings })
        .then(function() {
          showToast('Display settings saved', 'success');
          announce('Display settings saved.');
          for (var key in settings) {
            if (settings.hasOwnProperty(key)) state.config[key] = settings[key];
          }
        })
        .catch(function(err) {
          showToast('Failed to save: ' + err.message, 'error');
        })
        .finally(function() {
          els.dcSaveBtn.disabled = false;
          els.dcSaveBtn.textContent = 'Save Display Settings';
        });
    }

    /**
     * Toggle the blank display state (instant save — no save button needed).
     */
    function toggleBlankDisplay() {
      var currentlyBlanked = String(state.config.displayBlanked).toLowerCase() === 'true';
      var newBlanked = !currentlyBlanked;

      // Optimistic UI
      state.config.displayBlanked = newBlanked;
      updateDisplayControls();

      apiCall('updateConfig', { passphrase: state.passphrase, settings: { displayBlanked: newBlanked } })
        .then(function() {
          showToast(newBlanked ? 'Display blanked' : 'Display restored', newBlanked ? 'info' : 'success');
          announce(newBlanked ? 'Display blanked.' : 'Display restored.');
        })
        .catch(function(err) {
          // Revert
          state.config.displayBlanked = currentlyBlanked;
          updateDisplayControls();
          showToast('Failed: ' + err.message, 'error');
        });
    }

    // ═══════════════════════════════════════════════════════
    //  Settings panel
    // ═══════════════════════════════════════════════════════

    function openSettings() {
      state.settingsOpen = true;
      els.settingsBackdrop.classList.add('is-open');
      els.settingsBackdrop.setAttribute('aria-hidden', 'false');
      els.settingsPanel.classList.add('is-open');
      els.settingsToggleBtn.setAttribute('aria-expanded', 'true');
      // Focus close button
      els.settingsCloseBtn.focus();
      // Trap focus within panel
      document.addEventListener('keydown', settingsFocusTrap);
    }

    function closeSettings() {
      state.settingsOpen = false;
      els.settingsBackdrop.classList.remove('is-open');
      els.settingsBackdrop.setAttribute('aria-hidden', 'true');
      els.settingsPanel.classList.remove('is-open');
      els.settingsToggleBtn.setAttribute('aria-expanded', 'false');
      els.settingsToggleBtn.focus();
      document.removeEventListener('keydown', settingsFocusTrap);
    }

    /**
     * Basic focus trap for settings panel.
     * @param {KeyboardEvent} e
     */
    function settingsFocusTrap(e) {
      if (e.key !== 'Tab') return;
      var focusable = els.settingsPanel.querySelectorAll(
        'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
      );
      if (focusable.length === 0) return;
      var first = focusable[0];
      var last = focusable[focusable.length - 1];
      if (e.shiftKey) {
        if (document.activeElement === first) {
          e.preventDefault();
          last.focus();
        }
      } else {
        if (document.activeElement === last) {
          e.preventDefault();
          first.focus();
        }
      }
    }

    /**
     * Populate settings form from current config.
     */
    function updateSettingsForm() {
      var c = state.config;
      if (c.cooldownMinutes !== undefined) els.settCooldown.value = c.cooldownMinutes;
      if (c.maxLength !== undefined) els.settMaxLength.value = c.maxLength;
      els.settAutoApprove.checked = String(c.autoApproveOn).toLowerCase() === 'true';
      if (c.autoApproveThreshold !== undefined) {
        els.settThreshold.value = c.autoApproveThreshold;
        els.settThresholdValue.textContent = Math.round(Number(c.autoApproveThreshold) * 100) + '%';
      }
      // Don't prefill passphrase for security reasons — leave blank
      els.settPassphrase.value = '';
    }

    /**
     * Save settings to server.
     */
    function saveSettings() {
      var settings = {
        cooldownMinutes: Number(els.settCooldown.value) || 0,
        maxLength: Number(els.settMaxLength.value) || 280,
        autoApproveOn: els.settAutoApprove.checked,
        autoApproveThreshold: Number(els.settThreshold.value) || 0.5
      };

      // Only include passphrase change if a new one was entered
      var newPass = els.settPassphrase.value.trim();
      if (newPass) {
        settings.adminPassphrase = newPass;
      }

      els.saveSettingsBtn.disabled = true;
      els.saveSettingsBtn.textContent = 'Saving...';

      apiCall('updateConfig', {
        passphrase: state.passphrase,
        settings: settings
      })
        .then(function() {
          showToast('Settings saved', 'success');
          announce('Settings saved successfully.');

          // If passphrase was changed, update stored value
          if (newPass) {
            state.passphrase = newPass;
            sessionStorage.setItem('anm_passphrase', newPass);
            showToast('Passphrase updated', 'info');
          }

          // Update local config
          for (var key in settings) {
            if (settings.hasOwnProperty(key)) {
              state.config[key] = settings[key];
            }
          }

          // Refresh state
          fetchState();
          closeSettings();
        })
        .catch(function(err) {
          showToast('Failed to save: ' + err.message, 'error');
        })
        .finally(function() {
          els.saveSettingsBtn.disabled = false;
          els.saveSettingsBtn.textContent = 'Save Settings';
        });
    }

    // ═══════════════════════════════════════════════════════
    //  Keyboard navigation
    // ═══════════════════════════════════════════════════════

    /**
     * Handle global keyboard shortcuts.
     * @param {KeyboardEvent} e
     */
    function handleKeydown(e) {
      // Escape closes settings
      if (e.key === 'Escape' && state.settingsOpen) {
        closeSettings();
        e.preventDefault();
        return;
      }

      // Don't intercept when typing in inputs
      var tag = (e.target.tagName || '').toLowerCase();
      if (tag === 'input' || tag === 'textarea' || tag === 'select') return;

      var cards = els.queueList.querySelectorAll('.queue-card');
      if (cards.length === 0) return;

      // Arrow key navigation of queue cards
      if (e.key === 'ArrowDown' || e.key === 'ArrowUp') {
        e.preventDefault();
        if (e.key === 'ArrowDown') {
          state.focusedCardIndex = Math.min(state.focusedCardIndex + 1, cards.length - 1);
        } else {
          state.focusedCardIndex = Math.max(state.focusedCardIndex - 1, 0);
        }
        cards[state.focusedCardIndex].focus();
        return;
      }

      // Enter to approve focused card
      if (e.key === 'Enter' && state.focusedCardIndex >= 0 && state.focusedCardIndex < cards.length) {
        var focusedCard = cards[state.focusedCardIndex];
        var id = focusedCard.getAttribute('data-id');
        if (id) {
          approveItem(id, focusedCard);
          // Move focus index if needed
          if (state.focusedCardIndex >= state.pendingItems.length) {
            state.focusedCardIndex = state.pendingItems.length - 1;
          }
        }
        e.preventDefault();
        return;
      }

      // Delete or Backspace to reject focused card
      if ((e.key === 'Delete' || e.key === 'Backspace') && state.focusedCardIndex >= 0 && state.focusedCardIndex < cards.length) {
        var focused = cards[state.focusedCardIndex];
        var rid = focused.getAttribute('data-id');
        if (rid) {
          rejectItem(rid, focused);
          if (state.focusedCardIndex >= state.pendingItems.length) {
            state.focusedCardIndex = state.pendingItems.length - 1;
          }
        }
        e.preventDefault();
        return;
      }
    }

    // ═══════════════════════════════════════════════════════
    //  Event bindings
    // ═══════════════════════════════════════════════════════

    function bindEvents() {
      // Auth
      els.authForm.addEventListener('submit', handleAuth);

      // Tab navigation
      els.tabModeration.addEventListener('click', function() { switchTab('moderation'); });
      els.tabDisplay.addEventListener('click', function() { switchTab('display'); });

      // Session toggle
      els.sessionToggleBtn.addEventListener('click', toggleSession);

      // Bulk actions on approved list
      els.bulkSelectAll.addEventListener('click', bulkSelectAll);
      els.bulkSelectNone.addEventListener('click', bulkSelectNone);
      els.bulkDelete.addEventListener('click', bulkDeleteSelected);
      els.bulkExport.addEventListener('click', bulkExportSelected);

      // Display control: mode switcher (instant save)
      els.dcModeSwitcher.querySelectorAll('.mode-switcher__btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
          var newMode = btn.getAttribute('data-mode');
          // Update UI
          els.dcModeSwitcher.querySelectorAll('.mode-switcher__btn').forEach(function(b) {
            var isActive = b.getAttribute('data-mode') === newMode;
            b.classList.toggle('is-active', isActive);
            b.setAttribute('aria-checked', isActive ? 'true' : 'false');
          });
          // Instant save
          apiCall('updateConfig', { passphrase: state.passphrase, settings: { displayMode: newMode } })
            .then(function() {
              state.config.displayMode = newMode;
              showToast('Display mode: ' + newMode, 'success');
            })
            .catch(function(err) {
              showToast('Failed: ' + err.message, 'error');
              updateDisplayControls(); // revert UI
            });
        });
      });

      // Display control: cycle speed slider live value
      els.dcCycleSpeed.addEventListener('input', function() {
        els.dcCycleSpeedValue.textContent = this.value + 's';
      });

      // Display control: blank button (instant save)
      els.dcBlankBtn.addEventListener('click', toggleBlankDisplay);

      // Display control: save button
      els.dcSaveBtn.addEventListener('click', saveDisplaySettings);

      // Settings open/close
      els.settingsToggleBtn.addEventListener('click', openSettings);
      els.settingsCloseBtn.addEventListener('click', closeSettings);
      els.settingsBackdrop.addEventListener('click', closeSettings);

      // Settings: threshold slider live value
      els.settThreshold.addEventListener('input', function() {
        els.settThresholdValue.textContent = Math.round(Number(this.value) * 100) + '%';
      });

      // Save settings
      els.saveSettingsBtn.addEventListener('click', saveSettings);

      // Approve all
      els.approveAllBtn.addEventListener('click', approveAll);

      // Global keyboard
      document.addEventListener('keydown', handleKeydown);
    }

    // ═══════════════════════════════════════════════════════
    //  Initialization
    // ═══════════════════════════════════════════════════════

    function init() {
      bindEvents();

      // Auto-auth if we have a stored passphrase
      if (state.passphrase) {
        tryAutoAuth();
      } else {
        // Focus the auth input
        els.authInput.focus();
      }
    }

    // Start the app
    init();

  })();
  </script>
</body>
</html>
