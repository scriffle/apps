<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Physics Assessment Timer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f0f0f0 0%, #ffffff 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: #000;
        }

        /* Tab Navigation */
        .tab-nav {
            display: flex;
            background: #000;
            padding: 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .tab-button {
            flex: 1;
            padding: clamp(15px, 2vh, 25px) clamp(20px, 3vw, 40px);
            background: #000;
            color: white;
            border: none;
            border-right: 1px solid #444;
            cursor: pointer;
            font-size: clamp(1.2rem, 2vw, 1.8rem);
            font-weight: 700;
            text-transform: uppercase;
            transition: all 0.3s;
        }

        .tab-button:last-child {
            border-right: none;
        }

        .tab-button.active {
            background: white;
            color: #000;
            box-shadow: inset 0 -3px 0 #000;
        }

        .tab-button:hover:not(.active) {
            background: #333;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            flex: 1;
            padding: clamp(20px, 3vw, 40px);
        }

        .tab-content.active {
            display: flex;
        }

        /* Timing Tab Styles */
        .timing-container {
            display: flex;
            gap: clamp(20px, 4vw, 60px);
            background: white;
            padding: clamp(20px, 4vw, 60px);
            border-radius: clamp(15px, 2vw, 30px);
            border: 3px solid #000;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            width: 100%;
            height: 100%;
            margin: auto;
        }

        .clock-section, .timer-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: clamp(15px, 3vh, 40px);
            flex: 1;
            justify-content: center;
        }

        h2 {
            color: #000;
            font-size: clamp(1.8rem, 3.5vw, 3rem);
            margin-bottom: clamp(10px, 2vh, 25px);
            font-weight: 900;
        }

        .mobile-title {
            display: none;
        }

        .analog-clock {
            width: clamp(200px, 30vw, 450px);
            height: clamp(200px, 30vw, 450px);
            border: clamp(8px, 1vw, 15px) solid #000;
            border-radius: 50%;
            position: relative;
            background: white;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .clock-center {
            position: absolute;
            width: clamp(10px, 1.5vw, 20px);
            height: clamp(10px, 1.5vw, 20px);
            background: #000;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 11;
        }

        .hand {
            position: absolute;
            background: #000;
            transform-origin: bottom center;
            bottom: 50%;
            left: 50%;
            border-radius: 2px;
            z-index: 5;
        }

        .hand.finish {
            opacity: 0.4;
            background: #4caf50;
            z-index: 4;
            display: none;
        }

        .hand.finish.visible {
            display: block;
        }

        .hour-hand {
            width: clamp(6px, 0.8vw, 10px);
            height: clamp(50px, 6vw, 100px);
            margin-left: calc(clamp(6px, 0.8vw, 10px) / -2);
        }

        .minute-hand {
            width: clamp(4px, 0.6vw, 8px);
            height: clamp(70px, 8.5vw, 140px);
            margin-left: calc(clamp(4px, 0.6vw, 8px) / -2);
        }

        .second-hand {
            width: clamp(2px, 0.3vw, 4px);
            height: clamp(80px, 10vw, 160px);
            margin-left: calc(clamp(2px, 0.3vw, 4px) / -2);
            background: #ff0000;
        }

        .clock-marks {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        .hour-mark {
            position: absolute;
            width: clamp(3px, 0.4vw, 6px);
            height: clamp(12px, 1.5vw, 20px);
            background: #000;
            left: 50%;
            top: 50%;
            margin-left: calc(clamp(3px, 0.4vw, 6px) / -2);
            margin-top: calc(clamp(12px, 1.5vw, 20px) / -2);
            border-radius: 1px;
        }

        .minute-mark {
            position: absolute;
            width: clamp(1.5px, 0.2vw, 3px);
            height: clamp(6px, 0.8vw, 10px);
            background: #666;
            opacity: 0.8;
            left: 50%;
            top: 50%;
            margin-left: calc(clamp(1.5px, 0.2vw, 3px) / -2);
            margin-top: calc(clamp(6px, 0.8vw, 10px) / -2);
            border-radius: 0.5px;
        }

        .clock-numbers {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 3;
        }

        .clock-number {
            position: absolute;
            font-size: clamp(18px, 2.5vw, 32px);
            font-weight: 900;
            color: #000;
            width: auto;
            height: auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .digital-clock {
            font-size: clamp(2.5rem, 7vw, 6rem);
            font-weight: 900;
            color: #000;
            font-family: 'Courier New', monospace;
            letter-spacing: clamp(3px, 0.4vw, 8px);
            cursor: pointer;
            user-select: none;
            transition: transform 0.2s;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
        }

        .digital-clock:hover {
            transform: scale(1.05);
        }

        .digital-clock:active {
            transform: scale(0.98);
        }

        .finish-time {
            font-size: clamp(1.2rem, 2.5vw, 2rem);
            color: #4caf50;
            font-family: 'Courier New', monospace;
            font-weight: 900;
            background: #f0fff0;
            padding: 5px 15px;
            border-radius: 8px;
            border: 2px solid #4caf50;
            display: none;
        }

        .finish-time.visible {
            display: block;
        }
        
        /* Override for mobile */
        @media (max-width: 768px) {
            #finishTimeLeft.visible {
                display: none !important;
            }
        }

        .countdown-display {
            font-size: clamp(3rem, 8vw, 7rem);
            font-weight: 900;
            color: #000;
            font-family: 'Courier New', monospace;
            letter-spacing: clamp(3px, 0.5vw, 10px);
            min-width: clamp(250px, 35vw, 500px);
            text-align: center;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.1);
        }

        .control-buttons {
            display: flex;
            gap: clamp(12px, 2vw, 25px);
        }

        button {
            padding: clamp(12px, 2vw, 20px) clamp(20px, 3vw, 45px);
            font-size: clamp(1.2rem, 2.2vw, 1.8rem);
            font-weight: 900;
            background: #000;
            color: white;
            border: none;
            border-radius: clamp(8px, 1vw, 15px);
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        button:hover {
            background: #333;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        button.confirm {
            background: #f44336;
            animation: pulse 0.5s infinite alternate;
            transform: scale(1.05);
        }

        button.confirm:hover {
            background: #d32f2f;
            transform: scale(1.08);
        }

        @keyframes pulse {
            from { 
                opacity: 0.8; 
                box-shadow: 0 8px 20px rgba(244, 67, 54, 0.2);
            }
            to { 
                opacity: 1; 
                box-shadow: 0 8px 30px rgba(244, 67, 54, 0.4);
            }
        }

        /* Setup Timer Tab Styles */
        .setup-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: clamp(30px, 4vw, 60px);
            border-radius: 20px;
            border: 3px solid #000;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .mode-selector {
            display: flex;
            gap: 30px;
            margin-bottom: 40px;
            padding: 20px;
            background: #f5f5f5;
            border-radius: 10px;
        }

        .mode-option {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: clamp(1.2rem, 2vw, 1.6rem);
            font-weight: 600;
        }

        .mode-option input[type="radio"] {
            width: 25px;
            height: 25px;
            cursor: pointer;
        }

        .mode-content {
            display: none;
            animation: fadeIn 0.3s;
        }

        .mode-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .input-group {
            margin-bottom: 30px;
        }

        .input-group label {
            display: block;
            font-size: clamp(1.2rem, 2vw, 1.6rem);
            font-weight: 700;
            margin-bottom: 10px;
        }

        .timer-input-large {
            width: 100%;
            padding: clamp(15px, 2vw, 25px);
            font-size: clamp(1.5rem, 2.5vw, 2.5rem);
            border: 3px solid #000;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-weight: 700;
            text-align: center;
        }

        .preset-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .preset-btn {
            padding: clamp(10px, 1.5vw, 15px);
            font-size: clamp(1rem, 1.8vw, 1.4rem);
            background: #f0f0f0;
            color: #000;
            border: 2px solid #000;
        }

        .preset-btn:hover {
            background: #000;
            color: white;
        }

        .time-inputs {
            display: flex;
            gap: 20px;
            align-items: center;
        }

        .time-input-group {
            flex: 1;
        }

        .duration-display {
            padding: 20px;
            background: #e8f5e9;
            border: 2px solid #4caf50;
            border-radius: 10px;
            margin-top: 20px;
            font-size: clamp(1.2rem, 2vw, 1.6rem);
            text-align: center;
            font-weight: 600;
        }

        .error-message {
            color: #f44336;
            font-size: clamp(1rem, 1.5vw, 1.3rem);
            margin-top: 10px;
            font-weight: 600;
        }

        /* Settings Tab Styles */
        .settings-container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            padding: clamp(30px, 4vw, 60px);
            border-radius: 20px;
            border: 3px solid #000;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
        }

        .settings-group {
            margin-bottom: 40px;
            padding: 25px;
            background: #f9f9f9;
            border-radius: 10px;
            border: 2px solid #ddd;
        }

        .settings-group h3 {
            font-size: clamp(1.4rem, 2.5vw, 2rem);
            margin-bottom: 20px;
            color: #000;
            border-bottom: 2px solid #000;
            padding-bottom: 10px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            font-size: clamp(1.1rem, 2vw, 1.5rem);
        }

        .setting-label {
            font-weight: 600;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 80px;
            height: 40px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 40px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 32px;
            width: 32px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #4caf50;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(40px);
        }

        .volume-slider {
            width: 200px;
            height: 8px;
            border-radius: 5px;
            background: #ddd;
            outline: none;
        }

        .teacher-message {
            width: 100%;
            text-align: center;
            font-size: clamp(1.8rem, 3.5vw, 3rem);
            font-weight: 700;
            color: #000;
            margin-top: clamp(20px, 3vh, 40px);
            padding: 15px;
            background: transparent;
            border: none;
            outline: none;
            cursor: text;
            transition: all 0.3s;
            min-height: 60px;
            caret-color: rgba(0, 0, 0, 0);
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            line-height: 1.4;
            -webkit-text-fill-color: #000;
        }
        
        /* Completely hide cursor in all states */
        .teacher-message,
        .teacher-message:focus,
        .teacher-message:active {
            caret-color: rgba(0, 0, 0, 0) !important;
            cursor: text;
        }
        
        .teacher-message:focus {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }
        
        .teacher-message:empty:not(:focus):before {
            content: "Click here to add a message";
            color: #e0e0e0;
            font-weight: 400;
            font-style: italic;
            opacity: 0.6;
        }

        .teacher-message:hover:empty:before {
            opacity: 0.8;
            color: #ccc;
        }

        .teacher-message:hover {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .teacher-message::selection {
            background: rgba(0, 0, 0, 0.05);
        }

        .teacher-message::-moz-selection {
            background: rgba(0, 0, 0, 0.05);
        }

        .floating-emoji {
            position: fixed;
            font-size: clamp(60px, 10vw, 150px);
            animation: float 8s linear;
            pointer-events: none;
            z-index: 1000;
        }

        @keyframes float {
            from {
                left: -100px;
                transform: rotate(0deg);
            }
            to {
                left: 100vw;
                transform: rotate(360deg);
            }
        }

        /* Mobile and small screens */
        @media (max-width: 768px) {
            .timing-container {
                flex-direction: column;
                padding: clamp(15px, 3vw, 30px);
            }

            /* Timer section at top in mobile */
            .timer-section {
                order: 1;
                margin-bottom: 30px;
                width: 100%;
            }

            /* Clock section at bottom in mobile */
            .clock-section {
                order: 2;
                width: 100%;
            }

            /* Hide desktop title, show mobile title */
            .desktop-title {
                display: none;
            }

            .mobile-title {
                display: block;
                font-size: clamp(1.8rem, 5vw, 2.8rem);
                text-align: center;
                margin-bottom: 20px;
            }

            /* Hide the title and finish time in clock section on mobile */
            .clock-section .desktop-title {
                display: none;
            }

            /* Digital clock styling when moved to timer section */
            .timer-section .digital-clock {
                margin: 20px 0 15px 0;
                font-size: clamp(2rem, 6vw, 4rem);
            }

            .teacher-message {
                margin-top: 25px;
                font-size: clamp(1.4rem, 4.5vw, 2.2rem);
                padding: 10px 5px;
            }

            .analog-clock {
                width: clamp(220px, 55vw, 340px);
                height: clamp(220px, 55vw, 340px);
                margin: 20px auto;
            }

            .preset-buttons {
                grid-template-columns: repeat(2, 1fr);
            }

            .time-inputs {
                flex-direction: column;
            }

            .countdown-display {
                font-size: clamp(2.5rem, 7vw, 5rem);
                margin: 10px 0;
            }

            .control-buttons {
                margin: 15px 0;
            }

            .finish-time {
                margin: 10px 0;
            }
        }

        /* Large screens and projectors */
        @media (min-width: 1920px) {
            .timing-container {
                max-width: 90vw;
            }
        }
    </style>
</head>
<body>
    <!-- Tab Navigation -->
    <div class="tab-nav">
        <button class="tab-button active" onclick="switchTab('timing')">Timing</button>
        <button class="tab-button" onclick="switchTab('setup')">Setup Timer</button>
        <button class="tab-button" onclick="switchTab('settings')">Settings</button>
    </div>

    <!-- Timing Tab -->
    <div id="timing" class="tab-content active">
        <div class="timing-container">
            <div class="clock-section">
                <h2 class="desktop-title">Current Time</h2>
                
                <div class="analog-clock">
                    <div class="clock-marks" id="clockMarks"></div>
                    <div class="clock-numbers" id="clockNumbers"></div>
                    <div class="hand hour-hand finish" id="finishHourHand"></div>
                    <div class="hand minute-hand finish" id="finishMinuteHand"></div>
                    <div class="hand hour-hand" id="hourHand"></div>
                    <div class="hand minute-hand" id="minuteHand"></div>
                    <div class="hand second-hand" id="secondHand"></div>
                    <div class="clock-center"></div>
                </div>
                
                <div class="digital-clock" id="digitalClock" title="Click to toggle 12/24 hour format">00:00:00 AM</div>
                <div class="finish-time" id="finishTimeLeft">Finish: --:--:-- --</div>
            </div>

            <div class="timer-section">
                <h2 class="desktop-title">Countdown Timer</h2>
                <h2 class="mobile-title">Timer & Clock</h2>
                
                <div class="countdown-display" id="countdown">00:00:00</div>
                
                <div class="control-buttons">
                    <button id="startBtn">Start</button>
                    <button id="pauseBtn" disabled>Pause</button>
                    <button id="resetBtn">Reset</button>
                </div>
                
                <div class="finish-time" id="finishTimeRight">Finish: --:--:-- --</div>
                
                <div class="teacher-message" id="teacherMessage" contenteditable="true" spellcheck="false">Click here to add a message</div>
            </div>
        </div>
    </div>

    <!-- Setup Timer Tab -->
    <div id="setup" class="tab-content">
        <div class="setup-container">
            <h2 class="desktop-title">Setup Timer</h2>
            
            <div class="mode-selector">
                <div class="mode-option">
                    <input type="radio" id="durationMode" name="timerMode" value="duration" checked>
                    <label for="durationMode">Set Duration</label>
                </div>
                <div class="mode-option">
                    <input type="radio" id="finishTimeMode" name="timerMode" value="finishTime">
                    <label for="finishTimeMode">Set Finish Time</label>
                </div>
            </div>

            <!-- Duration Entry Mode -->
            <div id="durationModeContent" class="mode-content active">
                <div class="input-group">
                    <label>Enter Duration (minutes or HH:MM)</label>
                    <input type="text" class="timer-input-large" id="durationInput" placeholder="45 or 1:30" value="">
                </div>
                
                <div class="preset-buttons">
                    <button class="preset-btn" onclick="setPresetDuration(15)">15 min</button>
                    <button class="preset-btn" onclick="setPresetDuration(30)">30 min</button>
                    <button class="preset-btn" onclick="setPresetDuration(45)">45 min</button>
                    <button class="preset-btn" onclick="setPresetDuration(60)">1 hour</button>
                    <button class="preset-btn" onclick="setPresetDuration(90)">1.5 hours</button>
                    <button class="preset-btn" onclick="setPresetDuration(120)">2 hours</button>
                </div>
            </div>

            <!-- Finish Time Entry Mode -->
            <div id="finishTimeModeContent" class="mode-content">
                <div class="input-group">
                    <label>Set Finish Time</label>
                    <div class="time-inputs">
                        <div class="time-input-group">
                            <input type="time" class="timer-input-large" id="finishTimeInput">
                        </div>
                        <div class="time-input-group">
                            <select class="timer-input-large" id="finishDateSelect">
                                <option value="today">Today</option>
                                <option value="tomorrow">Tomorrow</option>
                            </select>
                        </div>
                    </div>
                    <div id="currentTimeDisplay" style="margin-top: 15px; font-size: clamp(1rem, 1.8vw, 1.4rem); text-align: center;">
                        Current Time: <span id="currentTimeText">--:--:-- --</span>
                    </div>
                    <div class="duration-display" id="calculatedDuration">
                        Timer will run for: -- hours, -- minutes
                    </div>
                    <div class="error-message" id="timeError" style="display: none;">
                        Selected time is in the past. Please choose a future time.
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 20px; margin-top: 40px;">
                <button style="flex: 1;" onclick="applyTimerSettings()">Set Timer</button>
                <button style="flex: 1; background: #666;" onclick="clearTimerSettings()">Clear</button>
            </div>
        </div>
    </div>

    <!-- Settings Tab -->
    <div id="settings" class="tab-content">
        <div class="settings-container">
            <h2 class="desktop-title">Settings</h2>
            
            <div class="settings-group">
                <h3>Clock Format</h3>
                <div class="setting-item">
                    <span class="setting-label">Time Format</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="clockFormatToggle">
                        <span class="toggle-slider"></span>
                    </label>
                    <span id="formatLabel" style="width: 80px; text-align: right;">12 Hour</span>
                </div>
            </div>

            <div class="settings-group">
                <h3>Display Options</h3>
                <div class="setting-item">
                    <span class="setting-label">Show Seconds</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="showSecondsToggle" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <span class="setting-label">Show Finish Time</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="showFinishToggle" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <span class="setting-label">Physics Emojis</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="emojiToggle" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <div class="settings-group">
                <h3>Sound Options</h3>
                <div class="setting-item">
                    <span class="setting-label">Completion Alert</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="soundToggle" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <span class="setting-label">Volume</span>
                    <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="70">
                </div>
            </div>

            <div style="display: flex; gap: 20px; margin-top: 40px;">
                <button style="flex: 1;" onclick="saveSettings()">Save Settings</button>
                <button style="flex: 1; background: #666;" onclick="resetSettings()">Reset to Defaults</button>
            </div>
        </div>
    </div>

    <script>
        // Global State
        let countdownInterval = null;
        let mainUpdateInterval = null;
        let remainingSeconds = 0;
        let initialTimerSeconds = 0; // Store the initial timer value
        let isPaused = true;
        let hasStarted = false; // Track if timer has been started
        let resetClickCount = 0; // Track reset button clicks
        let resetTimeout = null; // Timeout for reset confirmation
        let lastEmojiTime = Date.now();
        let finishTime = null;
        
        // Settings
        let settings = {
            is24Hour: false, // Default to 12-hour
            showSeconds: true,
            showFinishTime: true,
            enableEmojis: true,
            enableSound: true,
            volume: 70
        };

        const physicsEmojis = ['⚛️', '🔬', '🧲', '⚡', '🌌', '🔭', '🪐', '☄️', '🌠', '⚙️', '📡', '🛰️'];

        // Tab Switching
        function switchTab(tabName) {
            // Update buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');

            // Update content
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
            });
            document.getElementById(tabName).classList.add('active');

            // Reset the reset button confirmation state
            if (resetTimeout) {
                clearTimeout(resetTimeout);
            }
            resetClickCount = 0;
            const resetBtn = document.getElementById('resetBtn');
            resetBtn.textContent = 'Reset';
            resetBtn.classList.remove('confirm');

            // Update current time display in setup tab
            if (tabName === 'setup') {
                updateCurrentTimeInSetup();
            }
            
            // Update button text when switching to timing tab
            if (tabName === 'timing') {
                updateStartButtonText();
            }
        }

        // Setup Timer Mode Switching
        document.getElementById('durationMode').addEventListener('change', function() {
            if (this.checked) {
                document.getElementById('durationModeContent').classList.add('active');
                document.getElementById('finishTimeModeContent').classList.remove('active');
            }
        });

        document.getElementById('finishTimeMode').addEventListener('change', function() {
            if (this.checked) {
                document.getElementById('finishTimeModeContent').classList.add('active');
                document.getElementById('durationModeContent').classList.remove('active');
            }
        });

        // Preset Duration Buttons
        function setPresetDuration(minutes) {
            const hours = Math.floor(minutes / 60);
            const mins = minutes % 60;
            let value = '';
            
            if (hours > 0) {
                value = `${hours}:${mins.toString().padStart(2, '0')}`;
            } else {
                value = minutes.toString();
            }
            
            document.getElementById('durationInput').value = value;
            
            // Also store as initial value for immediate use
            initialTimerSeconds = minutes * 60;
        }

        // Finish Time Calculation
        document.getElementById('finishTimeInput').addEventListener('input', calculateDurationFromFinishTime);
        document.getElementById('finishDateSelect').addEventListener('change', calculateDurationFromFinishTime);

        function calculateDurationFromFinishTime() {
            const timeInput = document.getElementById('finishTimeInput').value;
            const dateSelect = document.getElementById('finishDateSelect').value;
            
            if (!timeInput) {
                document.getElementById('calculatedDuration').textContent = 'Timer will run for: -- hours, -- minutes';
                return;
            }

            const now = new Date();
            const [hours, minutes] = timeInput.split(':').map(Number);
            let targetDate = new Date();
            
            targetDate.setHours(hours, minutes, 0, 0);
            
            if (dateSelect === 'tomorrow') {
                targetDate.setDate(targetDate.getDate() + 1);
            }

            const diffMs = targetDate - now;
            
            if (diffMs <= 0) {
                document.getElementById('timeError').style.display = 'block';
                document.getElementById('calculatedDuration').style.display = 'none';
            } else {
                document.getElementById('timeError').style.display = 'none';
                document.getElementById('calculatedDuration').style.display = 'block';
                
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                
                document.getElementById('calculatedDuration').textContent = 
                    `Timer will run for: ${diffHours} hours, ${diffMinutes} minutes`;
            }
        }

        function updateCurrentTimeInSetup() {
            const now = new Date();
            // Format without seconds for cleaner display
            if (settings.is24Hour) {
                document.getElementById('currentTimeText').textContent = now.toLocaleTimeString('en-US', { 
                    hour12: false, 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            } else {
                document.getElementById('currentTimeText').textContent = now.toLocaleTimeString('en-US', { 
                    hour12: true, 
                    hour: 'numeric', 
                    minute: '2-digit' 
                });
            }
        }

        // Apply Timer Settings
        function applyTimerSettings() {
            let seconds = 0;
            
            // Clear any reset confirmation state
            if (resetTimeout) {
                clearTimeout(resetTimeout);
            }
            resetClickCount = 0;
            const resetBtn = document.getElementById('resetBtn');
            resetBtn.textContent = 'Reset';
            resetBtn.classList.remove('confirm');
            
            if (document.getElementById('durationMode').checked) {
                // Duration mode
                const input = document.getElementById('durationInput').value;
                seconds = parseTimeInput(input);
            } else {
                // Finish time mode
                const timeInput = document.getElementById('finishTimeInput').value;
                const dateSelect = document.getElementById('finishDateSelect').value;
                
                if (!timeInput) {
                    alert('Please enter a finish time');
                    return;
                }

                const now = new Date();
                const [hours, minutes] = timeInput.split(':').map(Number);
                let targetDate = new Date();
                
                targetDate.setHours(hours, minutes, 0, 0);
                
                if (dateSelect === 'tomorrow') {
                    targetDate.setDate(targetDate.getDate() + 1);
                }

                const diffMs = targetDate - now;
                
                if (diffMs <= 0) {
                    alert('Please select a future time');
                    return;
                }
                
                seconds = Math.floor(diffMs / 1000);
            }

            if (seconds > 0) {
                // Stop any existing timer
                isPaused = true;
                hasStarted = false;
                document.getElementById('startBtn').disabled = false;
                document.getElementById('pauseBtn').disabled = true;
                
                // Set the new duration
                initialTimerSeconds = seconds; // Store initial value
                remainingSeconds = seconds;
                updateCountdown();
                updateStartButtonText();
                
                // Switch to timing tab
                document.querySelectorAll('.tab-button')[0].click();
                
                // Automatically start the timer after a brief delay
                setTimeout(() => {
                    document.getElementById('startBtn').click();
                }, 100);
            }
        }

        function clearTimerSettings() {
            document.getElementById('durationInput').value = '';
            document.getElementById('finishTimeInput').value = '';
            remainingSeconds = 0;
            initialTimerSeconds = 0;
            hasStarted = false;
            isPaused = true;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            finishTime = null;
            updateCountdown();
            updateFinishTime();
            updateStartButtonText();
        }

        // Settings Functions
        function saveSettings() {
            settings.is24Hour = document.getElementById('clockFormatToggle').checked;
            settings.showSeconds = document.getElementById('showSecondsToggle').checked;
            settings.showFinishTime = document.getElementById('showFinishToggle').checked;
            settings.enableEmojis = document.getElementById('emojiToggle').checked;
            settings.enableSound = document.getElementById('soundToggle').checked;
            settings.volume = document.getElementById('volumeSlider').value;
            
            applySettings();
            alert('Settings saved!');
        }

        function resetSettings() {
            settings = {
                is24Hour: false,
                showSeconds: true,
                showFinishTime: true,
                enableEmojis: true,
                enableSound: true,
                volume: 70
            };
            
            loadSettingsToUI();
            applySettings();
            alert('Settings reset to defaults!');
        }

        function loadSettingsToUI() {
            document.getElementById('clockFormatToggle').checked = settings.is24Hour;
            document.getElementById('showSecondsToggle').checked = settings.showSeconds;
            document.getElementById('showFinishToggle').checked = settings.showFinishTime;
            document.getElementById('emojiToggle').checked = settings.enableEmojis;
            document.getElementById('soundToggle').checked = settings.enableSound;
            document.getElementById('volumeSlider').value = settings.volume;
            
            document.getElementById('formatLabel').textContent = settings.is24Hour ? '24 Hour' : '12 Hour';
        }

        function applySettings() {
            updateClock();
            updateFinishTime();
        }

        // Clock format toggle listener
        document.getElementById('clockFormatToggle').addEventListener('change', function() {
            settings.is24Hour = this.checked;
            document.getElementById('formatLabel').textContent = settings.is24Hour ? '24 Hour' : '12 Hour';
            applySettings();
        });

        // Create clock numbers dynamically with responsive positioning
        function createClockNumbers() {
            const numbersContainer = document.getElementById('clockNumbers');
            const clockElement = numbersContainer.parentElement;
            const clockRadius = clockElement.offsetWidth / 2;
            const numberRadius = clockRadius * 0.72; // Slightly adjusted for better alignment

            const numbers = [
                {num: 12, angle: -90},
                {num: 1, angle: -60},
                {num: 2, angle: -30},
                {num: 3, angle: 0},
                {num: 4, angle: 30},
                {num: 5, angle: 60},
                {num: 6, angle: 90},
                {num: 7, angle: 120},
                {num: 8, angle: 150},
                {num: 9, angle: 180},
                {num: 10, angle: 210},
                {num: 11, angle: 240}
            ];

            numbersContainer.innerHTML = '';
            numbers.forEach(({num, angle}) => {
                const numberEl = document.createElement('div');
                numberEl.className = 'clock-number';
                numberEl.textContent = num;
                
                const rad = (angle * Math.PI) / 180;
                const x = Math.cos(rad) * numberRadius;
                const y = Math.sin(rad) * numberRadius;
                
                // Position from center (50%, 50%) and then offset
                numberEl.style.left = `calc(50% + ${x}px)`;
                numberEl.style.top = `calc(50% + ${y}px)`;
                numberEl.style.transform = 'translate(-50%, -50%)';
                
                numbersContainer.appendChild(numberEl);
            });
        }

        // Create clock marks with dynamic sizing
        function createClockMarks() {
            const marksContainer = document.getElementById('clockMarks');
            const clockElement = marksContainer.parentElement;
            const clockRadius = clockElement.offsetWidth / 2;
            marksContainer.innerHTML = '';
            
            // Create minute marks (60 total)
            for (let i = 0; i < 60; i++) {
                const mark = document.createElement('div');
                const angle = (i * 6); // 360 / 60 = 6 degrees per minute
                
                // Make hour marks bigger
                if (i % 5 === 0) {
                    mark.className = 'hour-mark';
                    const distance = clockRadius - (clockRadius * 0.12);
                    mark.style.transform = `rotate(${angle}deg) translateY(-${distance}px)`;
                    mark.style.transformOrigin = 'center center';
                } else {
                    mark.className = 'minute-mark';
                    const distance = clockRadius - (clockRadius * 0.08);
                    mark.style.transform = `rotate(${angle}deg) translateY(-${distance}px)`;
                    mark.style.transformOrigin = 'center center';
                }
                
                marksContainer.appendChild(mark);
            }
        }

        // Format time based on current mode
        function formatTime(date) {
            if (!settings.showSeconds) {
                if (settings.is24Hour) {
                    return date.toLocaleTimeString('en-US', { hour12: false, hour: '2-digit', minute: '2-digit' });
                } else {
                    return date.toLocaleTimeString('en-US', { hour12: true, hour: 'numeric', minute: '2-digit' });
                }
            } else {
                if (settings.is24Hour) {
                    return date.toLocaleTimeString('en-US', { hour12: false });
                } else {
                    return date.toLocaleTimeString('en-US', { hour12: true });
                }
            }
        }

        // Clock update
        function updateClock() {
            const now = new Date();
            const hours = now.getHours() % 12;
            const minutes = now.getMinutes();
            const seconds = now.getSeconds();

            const hourDeg = (hours * 30) + (minutes * 0.5);
            const minuteDeg = minutes * 6;
            const secondDeg = seconds * 6;

            document.getElementById('hourHand').style.transform = `rotate(${hourDeg}deg)`;
            document.getElementById('minuteHand').style.transform = `rotate(${minuteDeg}deg)`;
            
            if (settings.showSeconds) {
                document.getElementById('secondHand').style.display = 'block';
                document.getElementById('secondHand').style.transform = `rotate(${secondDeg}deg)`;
            } else {
                document.getElementById('secondHand').style.display = 'none';
            }

            const digitalTime = formatTime(now);
            document.getElementById('digitalClock').textContent = digitalTime;
        }

        // Toggle between 12/24 hour format by clicking digital clock
        document.getElementById('digitalClock').addEventListener('click', () => {
            settings.is24Hour = !settings.is24Hour;
            document.getElementById('clockFormatToggle').checked = settings.is24Hour;
            document.getElementById('formatLabel').textContent = settings.is24Hour ? '24 Hour' : '12 Hour';
            updateClock();
            updateFinishTime();
        });

        // Format time for finish display (no seconds)
        function formatFinishTime(date) {
            if (settings.is24Hour) {
                return date.toLocaleTimeString('en-US', { 
                    hour12: false, 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
            } else {
                return date.toLocaleTimeString('en-US', { 
                    hour12: true, 
                    hour: 'numeric', 
                    minute: '2-digit' 
                });
            }
        }

        // Update finish time hands
        function updateFinishTime() {
            const shouldShow = settings.showFinishTime && finishTime && !isPaused;
            
            if (shouldShow) {
                const hours = finishTime.getHours() % 12;
                const minutes = finishTime.getMinutes();
                
                const hourDeg = (hours * 30) + (minutes * 0.5);
                const minuteDeg = minutes * 6;
                
                document.getElementById('finishHourHand').style.transform = `rotate(${hourDeg}deg)`;
                document.getElementById('finishMinuteHand').style.transform = `rotate(${minuteDeg}deg)`;
                document.getElementById('finishHourHand').classList.add('visible');
                document.getElementById('finishMinuteHand').classList.add('visible');
                
                // Use special formatting for finish time (no seconds)
                const finishTimeStr = formatFinishTime(finishTime);
                
                // Update finish times
                document.getElementById('finishTimeLeft').textContent = `Finish: ${finishTimeStr}`;
                document.getElementById('finishTimeRight').textContent = `Finish: ${finishTimeStr}`;
                
                // Add visible class
                document.getElementById('finishTimeLeft').classList.add('visible');
                document.getElementById('finishTimeRight').classList.add('visible');
            } else {
                document.getElementById('finishHourHand').classList.remove('visible');
                document.getElementById('finishMinuteHand').classList.remove('visible');
                document.getElementById('finishTimeLeft').classList.remove('visible');
                document.getElementById('finishTimeRight').classList.remove('visible');
            }
        }

        // Update Start button text based on timer state
        function updateStartButtonText() {
            const startBtn = document.getElementById('startBtn');
            if (remainingSeconds === 0 && initialTimerSeconds === 0) {
                startBtn.textContent = 'Setup';
            } else if (isPaused && hasStarted && remainingSeconds > 0) {
                startBtn.textContent = 'Continue';
            } else {
                startBtn.textContent = 'Start';
            }
        }

        // Update countdown display
        function updateCountdown() {
            const hours = Math.floor(remainingSeconds / 3600);
            const minutes = Math.floor((remainingSeconds % 3600) / 60);
            const seconds = remainingSeconds % 60;
            
            const display = `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
            document.getElementById('countdown').textContent = display;
            
            // Update Start button text
            updateStartButtonText();
        }

        // Parse time input
        function parseTimeInput(input) {
            const trimmedInput = input.trim();
            
            // Check if input contains a colon
            if (trimmedInput.includes(':')) {
                // Parse as hours:minutes
                const parts = trimmedInput.split(':');
                if (parts.length === 2) {
                    const hours = parseInt(parts[0]) || 0;
                    const minutes = parseInt(parts[1]) || 0;
                    return hours * 3600 + minutes * 60;
                }
            } else {
                // Parse as minutes only
                const minutes = parseInt(trimmedInput) || 0;
                return minutes * 60;
            }
            return 0;
        }

        // Calculate finish time
        function calculateFinishTime() {
            if (!isPaused && remainingSeconds > 0) {
                const rawFinishTime = new Date(Date.now() + remainingSeconds * 1000);
                
                // Round to nearest minute
                const seconds = rawFinishTime.getSeconds();
                finishTime = new Date(rawFinishTime);
                
                if (seconds >= 30) {
                    // Round up to next minute
                    finishTime.setMinutes(finishTime.getMinutes() + 1);
                }
                // Set seconds and milliseconds to 0 for clean minute display
                finishTime.setSeconds(0, 0);
            } else {
                finishTime = null;
            }
            updateFinishTime();
        }

        // Main update function - synchronized updates for clock and timer
        function mainUpdate() {
            // Update clock
            updateClock();
            
            // Update current time in setup if that tab is active
            if (document.getElementById('setup').classList.contains('active')) {
                updateCurrentTimeInSetup();
            }
            
            // Update countdown if timer is running
            if (!isPaused && remainingSeconds > 0) {
                remainingSeconds--;
                updateCountdown();
                
                // Update finish time display
                if (remainingSeconds === 0) {
                    finishTime = null;
                    updateFinishTime();
                }
                
                // Check for emoji easter egg
                if (settings.enableEmojis && Date.now() - lastEmojiTime > 600000) { // 10 minutes
                    if (Math.random() < 0.1) { // Random chance every second after 10 minutes
                        showFloatingEmoji();
                        lastEmojiTime = Date.now();
                    }
                }
                
                // Check if timer finished
                if (remainingSeconds === 0) {
                    isPaused = true;
                    hasStarted = false;
                    document.getElementById('startBtn').disabled = false;
                    document.getElementById('pauseBtn').disabled = true;
                    updateStartButtonText();
                    
                    if (settings.enableSound) {
                        alert('Time\'s up! ⏰');
                    }
                }
            }
        }

        // Start timer
        document.getElementById('startBtn').addEventListener('click', () => {
            // Reset the reset button confirmation state
            if (resetTimeout) {
                clearTimeout(resetTimeout);
            }
            resetClickCount = 0;
            const resetBtn = document.getElementById('resetBtn');
            resetBtn.textContent = 'Reset';
            resetBtn.classList.remove('confirm');
            
            // If no timer is set, go to Setup Timer tab
            if (remainingSeconds === 0 && initialTimerSeconds === 0) {
                document.querySelectorAll('.tab-button')[1].click(); // Click Setup Timer tab
                return;
            }
            
            // If remainingSeconds is 0 but we have an initial value, reset to it
            if (remainingSeconds === 0 && initialTimerSeconds > 0) {
                remainingSeconds = initialTimerSeconds;
                updateCountdown();
                hasStarted = false;
                updateStartButtonText();
            }
            
            if (isPaused) {
                isPaused = false;
                hasStarted = true;
                document.getElementById('startBtn').disabled = true;
                document.getElementById('pauseBtn').disabled = false;
                
                calculateFinishTime();
            }
        });

        // Pause timer
        document.getElementById('pauseBtn').addEventListener('click', () => {
            isPaused = true;
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            
            // Update button text based on state
            updateStartButtonText();
            
            finishTime = null;
            updateFinishTime();
        });

        // Reset timer
        document.getElementById('resetBtn').addEventListener('click', () => {
            resetTimer();
        });

        function resetTimer() {
            isPaused = true;
            hasStarted = false;
            
            // Reset to the initially set duration
            if (initialTimerSeconds > 0) {
                remainingSeconds = initialTimerSeconds;
            } else if (document.getElementById('durationInput').value) {
                remainingSeconds = parseTimeInput(document.getElementById('durationInput').value);
            }
            
            updateCountdown();
            document.getElementById('startBtn').disabled = false;
            document.getElementById('pauseBtn').disabled = true;
            updateStartButtonText();
            finishTime = null;
            updateFinishTime();
        }

        // Show floating emoji
        function showFloatingEmoji() {
            if (!settings.enableEmojis) return;
            
            const emoji = physicsEmojis[Math.floor(Math.random() * physicsEmojis.length)];
            const emojiElement = document.createElement('div');
            emojiElement.className = 'floating-emoji';
            emojiElement.textContent = emoji;
            emojiElement.style.top = Math.random() * 80 + 10 + '%';
            document.body.appendChild(emojiElement);
            
            setTimeout(() => {
                emojiElement.remove();
            }, 8000);
        }

        // Handle resize
        function handleResize() {
            createClockNumbers();
            createClockMarks();
            
            // Move digital clock and finish time for mobile layout
            const digitalClock = document.getElementById('digitalClock');
            const finishTimeLeft = document.getElementById('finishTimeLeft');
            const clockSection = document.querySelector('.clock-section');
            const timerSection = document.querySelector('.timer-section');
            const countdown = document.getElementById('countdown');
            
            if (window.innerWidth <= 768) {
                // Mobile layout - move digital clock and hide left finish time to timer section
                if (digitalClock && timerSection && !timerSection.contains(digitalClock)) {
                    // Insert digital clock before countdown
                    timerSection.insertBefore(digitalClock, countdown);
                }
                // Hide the left finish time in mobile
                if (finishTimeLeft) {
                    finishTimeLeft.style.display = 'none';
                }
            } else {
                // Desktop layout - move digital clock back to clock section
                if (digitalClock && clockSection && !clockSection.contains(digitalClock)) {
                    const analogClock = clockSection.querySelector('.analog-clock');
                    if (analogClock) {
                        // Insert after analog clock
                        analogClock.insertAdjacentElement('afterend', digitalClock);
                    }
                }
                // Show the left finish time in desktop if it should be visible
                if (finishTimeLeft) {
                    finishTimeLeft.style.display = '';
                }
            }
            
            // Update finish time display to handle mobile visibility
            updateFinishTime();
        }

        // Initialize
        loadSettingsToUI();
        
        // Initial resize handling
        window.addEventListener('resize', handleResize);
        
        // Call handleResize initially to set up the layout
        setTimeout(() => {
            handleResize();
        }, 10);
        
        // Teacher message handling
        const teacherMessage = document.getElementById('teacherMessage');
        
        // Clear placeholder text on first focus
        let firstFocus = true;
        teacherMessage.addEventListener('focus', function() {
            if (firstFocus && this.textContent === 'Click here to add a message') {
                this.textContent = '';
                firstFocus = false;
            }
        });
        
        // Prevent enter key from creating new lines
        teacherMessage.addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                e.preventDefault();
                this.blur();
            }
        });
        
        // Wait for next whole second to start synchronized updates
        const now = new Date();
        const msToNextSecond = 1000 - now.getMilliseconds();
        
        setTimeout(() => {
            // Start synchronized updates - clock and timer tick together
            mainUpdateInterval = setInterval(mainUpdate, 1000);
            
            // Initial updates
            updateClock();
            updateCountdown();
            updateFinishTime();
            updateCurrentTimeInSetup();
            updateStartButtonText();
        }, msToNextSecond);
        
        // Do immediate initial updates
        updateClock();
        updateCountdown();
        updateFinishTime();
        updateCurrentTimeInSetup();
        updateStartButtonText();
    </script>
</body>
</html>