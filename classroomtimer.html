<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Assessment Timer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #f0f0f0 0%, #ffffff 100%);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            color: #000;
        }

        /* Tab Navigation - Fixed at bottom */
        .tab-nav {
            display: flex;
            background: #000;
            padding: 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.3);
            order: 2;
            margin-top: auto;
        }

        .tab-button {
            flex: 1;
            padding: clamp(15px, 2vh, 25px) clamp(20px, 3vw, 40px);
            background: #000;
            color: white;
            border: none;
            border-right: 1px solid #444;
            cursor: pointer;
            font-size: clamp(1.2rem, 2vw, 1.8rem);
            font-weight: 700;
            text-transform: uppercase;
            transition: all 0.3s;
        }

        .tab-button:last-child {
            border-right: none;
        }

        .tab-button.active {
            background: white;
            color: #000;
            box-shadow: inset 0 3px 0 #000;
        }

        .tab-button:hover:not(.active) {
            background: #333;
        }

        /* Tab Content */
        .tab-content {
            display: none;
            flex: 1;
            padding: clamp(20px, 3vw, 40px);
            order: 1;
        }

        .tab-content.active {
            display: flex;
        }

        /* Timing Tab Styles */
        .timing-container {
            display: flex;
            gap: clamp(20px, 4vw, 60px);
            background: white;
            padding: clamp(20px, 4vw, 60px);
            border-radius: clamp(15px, 2vw, 30px);
            border: 3px solid #000;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            width: 100%;
            height: 100%;
            margin: auto;
        }

        .clock-section, .timer-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: clamp(15px, 3vh, 40px);
            flex: 1;
            justify-content: center;
        }

        h2 {
            color: #000;
            font-size: clamp(1.8rem, 3.5vw, 3rem);
            margin-bottom: clamp(10px, 2vh, 25px);
            font-weight: 900;
        }

        .mobile-title {
            display: none;
        }

        .analog-clock {
            width: clamp(200px, 30vw, 450px);
            height: clamp(200px, 30vw, 450px);
            border: clamp(8px, 1vw, 15px) solid #000;
            border-radius: 50%;
            position: relative;
            background: white;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .clock-center {
            position: absolute;
            width: clamp(10px, 1.5vw, 20px);
            height: clamp(10px, 1.5vw, 20px);
            background: #000;
            border-radius: 50%;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 11;
        }

        .hand {
            position: absolute;
            background: #000;
            transform-origin: bottom center;
            bottom: 50%;
            left: 50%;
            border-radius: 2px;
            z-index: 5;
        }

        .hand.finish {
            opacity: 0.4;
            background: #4caf50;
            z-index: 4;
            display: none;
        }

        .hand.finish.visible {
            display: block;
        }

        .hour-hand {
            width: clamp(6px, 0.8vw, 10px);
            height: clamp(50px, 6vw, 100px);
            margin-left: calc(clamp(6px, 0.8vw, 10px) / -2);
        }

        .minute-hand {
            width: clamp(4px, 0.6vw, 8px);
            height: clamp(70px, 8.5vw, 140px);
            margin-left: calc(clamp(4px, 0.6vw, 8px) / -2);
        }

        .second-hand {
            width: clamp(2px, 0.3vw, 4px);
            height: clamp(80px, 10vw, 160px);
            margin-left: calc(clamp(2px, 0.3vw, 4px) / -2);
            background: #ff0000;
        }

        .clock-marks {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 0;
        }

        .hour-mark {
            position: absolute;
            width: clamp(3px, 0.4vw, 6px);
            height: clamp(12px, 1.5vw, 20px);
            background: #000;
            left: 50%;
            top: 50%;
            margin-left: calc(clamp(3px, 0.4vw, 6px) / -2);
            margin-top: calc(clamp(12px, 1.5vw, 20px) / -2);
            border-radius: 1px;
        }

        .minute-mark {
            position: absolute;
            width: clamp(1.5px, 0.2vw, 3px);
            height: clamp(6px, 0.8vw, 10px);
            background: #666;
            opacity: 0.8;
            left: 50%;
            top: 50%;
            margin-left: calc(clamp(1.5px, 0.2vw, 3px) / -2);
            margin-top: calc(clamp(6px, 0.8vw, 10px) / -2);
            border-radius: 0.5px;
        }

        .clock-numbers {
            position: absolute;
            width: 100%;
            height: 100%;
            z-index: 3;
        }

        .clock-number {
            position: absolute;
            font-size: clamp(18px, 2.5vw, 32px);
            font-weight: 900;
            color: #000;
            width: auto;
            height: auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .digital-clock {
            font-size: clamp(2.5rem, 7vw, 6rem);
            font-weight: 900;
            color: #000;
            font-family: 'Courier New', monospace;
            letter-spacing: clamp(3px, 0.4vw, 8px);
            cursor: pointer;
            user-select: none;
            transition: transform 0.2s;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
            white-space: nowrap;
            max-width: 100%;
        }

        .digital-clock:hover {
            transform: scale(1.05);
        }

        .digital-clock:active {
            transform: scale(0.98);
        }

        .finish-time {
            font-size: clamp(1.2rem, 2.5vw, 2rem);
            color: #4caf50;
            font-family: 'Courier New', monospace;
            font-weight: 900;
            background: #f0fff0;
            padding: 5px 15px;
            border-radius: 8px;
            border: 2px solid #4caf50;
            display: none;
        }

        .finish-time.visible {
            display: block;
        }
        
        /* Override for mobile */
        @media (max-width: 768px) {
            #finishTimeLeft.visible {
                display: none !important;
            }
        }

        .countdown-display {
            font-size: clamp(3rem, 8vw, 7rem);
            font-weight: 900;
            color: #000;
            font-family: 'Courier New', monospace;
            letter-spacing: clamp(3px, 0.5vw, 10px);
            min-width: clamp(250px, 35vw, 500px);
            text-align: center;
            text-shadow: 3px 3px 6px rgba(0,0,0,0.1);
            transition: color 0.3s, transform 0.3s;
        }

        .countdown-display.finished {
            color: #f44336;
            animation: finishedPulse 1s ease-in-out infinite;
        }

        @keyframes finishedPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.05); }
        }

        .control-buttons {
            display: flex;
            gap: clamp(8px, 1.5vw, 25px);
            flex-wrap: wrap;
            justify-content: center;
            max-width: 100%;
        }

        .control-buttons button {
            flex-shrink: 1;
            min-width: 0;
            padding: clamp(10px, 1.8vw, 20px) clamp(15px, 2.5vw, 45px);
        }

        button {
            padding: clamp(12px, 2vw, 20px) clamp(20px, 3vw, 45px);
            font-size: clamp(1.2rem, 2.2vw, 1.8rem);
            font-weight: 900;
            background: #000;
            color: white;
            border: none;
            border-radius: clamp(8px, 1vw, 15px);
            cursor: pointer;
            transition: all 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        button:hover {
            background: #333;
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.4);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        button.confirm {
            background: #f44336;
            animation: pulse 0.5s infinite alternate;
            transform: scale(1.05);
        }

        button.confirm:hover {
            background: #d32f2f;
            transform: scale(1.08);
        }

        @keyframes pulse {
            from { 
                opacity: 0.8; 
                box-shadow: 0 8px 20px rgba(244, 67, 54, 0.2);
            }
            to { 
                opacity: 1; 
                box-shadow: 0 8px 30px rgba(244, 67, 54, 0.4);
            }
        }

        /* New Timer button */
        button.new-timer {
            background: #4caf50;
        }

        button.new-timer:hover {
            background: #45a049;
        }

        /* Setup Timer Tab Styles */
        .setup-container {
            max-width: 700px;
            margin: 0 auto;
            background: white;
            padding: clamp(20px, 3vw, 40px);
            border-radius: 20px;
            border: 3px solid #000;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            max-height: calc(100vh - 120px);
            overflow-y: auto;
            box-sizing: border-box;
        }

        .mode-selector {
            display: flex;
            gap: 20px;
            margin-bottom: 25px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 10px;
        }

        .mode-option {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: clamp(1rem, 1.8vw, 1.3rem);
            font-weight: 600;
        }

        .mode-option input[type="radio"] {
            width: 20px;
            height: 20px;
            cursor: pointer;
        }

        .mode-content {
            display: none;
            animation: fadeIn 0.3s;
        }

        .mode-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            font-size: clamp(1rem, 1.8vw, 1.3rem);
            font-weight: 700;
            margin-bottom: 8px;
        }

        .timer-input-large {
            width: 100%;
            padding: clamp(12px, 1.8vw, 20px);
            font-size: clamp(1.3rem, 2.2vw, 2rem);
            border: 3px solid #000;
            border-radius: 10px;
            font-family: 'Courier New', monospace;
            font-weight: 700;
            text-align: center;
        }

        .preset-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }

        .preset-btn {
            padding: clamp(8px, 1.2vw, 12px);
            font-size: clamp(0.9rem, 1.5vw, 1.2rem);
            background: #f0f0f0;
            color: #000;
            border: 2px solid #000;
        }

        .preset-btn:hover {
            background: #000;
            color: white;
        }

        .time-inputs {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .time-input-group {
            flex: 1;
        }

        .duration-display {
            padding: 15px;
            background: #e8f5e9;
            border: 2px solid #4caf50;
            border-radius: 10px;
            margin-top: 15px;
            font-size: clamp(1rem, 1.8vw, 1.3rem);
            text-align: center;
            font-weight: 600;
        }

        .error-message {
            color: #f44336;
            font-size: clamp(0.9rem, 1.4vw, 1.1rem);
            margin-top: 8px;
            font-weight: 600;
        }

        /* Settings Tab Styles */
        .settings-container {
            max-width: 700px;
            margin: 0 auto;
            background: white;
            padding: clamp(20px, 3vw, 40px);
            border-radius: 20px;
            border: 3px solid #000;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
            max-height: calc(100vh - 120px);
            overflow-y: auto;
            box-sizing: border-box;
        }

        .settings-group {
            margin-bottom: 25px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 10px;
            border: 2px solid #ddd;
        }

        .settings-group h3 {
            font-size: clamp(1.2rem, 2.2vw, 1.6rem);
            margin-bottom: 15px;
            color: #000;
            border-bottom: 2px solid #000;
            padding-bottom: 8px;
        }

        .setting-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            font-size: clamp(1rem, 1.8vw, 1.3rem);
        }

        .setting-label {
            font-weight: 600;
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            width: 60px;
            height: 30px;
            flex-shrink: 0;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 30px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 24px;
            width: 24px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background-color: #4caf50;
        }

        input:checked + .toggle-slider:before {
            transform: translateX(30px);
        }

        .volume-slider {
            width: 150px;
            height: 8px;
            border-radius: 5px;
            background: #ddd;
            outline: none;
        }

        .teacher-message {
            width: 100%;
            text-align: center;
            font-size: clamp(1.8rem, 3.5vw, 3rem);
            font-weight: 700;
            color: #000;
            margin-top: clamp(20px, 3vh, 40px);
            padding: 15px;
            background: transparent;
            border: none;
            outline: none;
            cursor: text;
            transition: all 0.3s;
            min-height: 60px;
            caret-color: rgba(0, 0, 0, 0);
            user-select: text;
            -webkit-user-select: text;
            -moz-user-select: text;
            -ms-user-select: text;
            line-height: 1.4;
            -webkit-text-fill-color: #000;
        }
        
        /* Completely hide cursor in all states */
        .teacher-message,
        .teacher-message:focus,
        .teacher-message:active {
            caret-color: rgba(0, 0, 0, 0) !important;
            cursor: text;
        }
        
        .teacher-message:focus {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
        }
        
        .teacher-message:empty:not(:focus):before {
            content: "Click here to add a message";
            color: #e8e8e8;
            font-weight: 400;
            font-style: italic;
            opacity: 0.6;
        }

        .teacher-message:hover:empty:before {
            opacity: 0.8;
            color: #ddd;
        }

        .teacher-message:hover {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
        }

        .teacher-message::selection {
            background: rgba(0, 0, 0, 0.05);
        }

        .teacher-message::-moz-selection {
            background: rgba(0, 0, 0, 0.05);
        }

        .floating-emoji {
            position: fixed;
            font-size: clamp(60px, 10vw, 150px);
            animation: float 8s linear;
            pointer-events: none;
            z-index: 1000;
        }

        @keyframes float {
            from {
                left: -100px;
                transform: rotate(0deg);
            }
            to {
                left: 100vw;
                transform: rotate(360deg);
            }
        }

        /* Completion notification banner */
        .completion-banner {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: #f44336;
            color: white;
            padding: 20px;
            text-align: center;
            font-size: clamp(1.5rem, 3vw, 2.5rem);
            font-weight: 900;
            z-index: 1000;
            transform: translateY(-100%);
            transition: transform 0.5s ease-out;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }

        .completion-banner.visible {
            transform: translateY(0);
        }

        .completion-banner .dismiss-hint {
            font-size: clamp(0.9rem, 1.5vw, 1.2rem);
            font-weight: 400;
            margin-top: 5px;
            opacity: 0.9;
        }

        /* Welcome dialog overlay */
        .welcome-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s, visibility 0.3s;
            padding: 15px;
            box-sizing: border-box;
        }

        .welcome-overlay.visible {
            opacity: 1;
            visibility: visible;
        }

        .welcome-dialog {
            background: white;
            border-radius: 20px;
            padding: clamp(20px, 3vw, 40px);
            max-width: 550px;
            width: 100%;
            max-height: calc(100vh - 30px);
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
            border: 3px solid #000;
            box-sizing: border-box;
        }

        .welcome-dialog h1 {
            font-size: clamp(1.5rem, 3.5vw, 2rem);
            margin-bottom: 15px;
            text-align: center;
        }

        .welcome-dialog .welcome-emoji {
            font-size: clamp(2.5rem, 6vw, 4rem);
            text-align: center;
            margin-bottom: 15px;
        }

        .welcome-dialog p {
            font-size: clamp(0.95rem, 1.8vw, 1.1rem);
            line-height: 1.5;
            margin-bottom: 12px;
            color: #333;
        }

        .welcome-dialog ul {
            margin: 15px 0;
            padding-left: 20px;
        }

        .welcome-dialog li {
            font-size: clamp(0.9rem, 1.7vw, 1.05rem);
            line-height: 1.5;
            margin-bottom: 8px;
            color: #333;
        }

        .welcome-dialog .feature-icon {
            font-size: 1.2em;
            margin-right: 6px;
        }

        .welcome-dialog .tip-text {
            text-align: center;
            color: #888;
            font-style: italic;
            font-size: clamp(0.85rem, 1.5vw, 0.95rem);
        }

        .welcome-dialog .dismiss-hint {
            text-align: center;
            color: #aaa;
            font-size: clamp(0.8rem, 1.3vw, 0.9rem);
            margin-top: 10px;
        }

        .welcome-dialog button {
            width: 100%;
            margin-top: 15px;
            background: #4caf50;
            font-size: clamp(1.1rem, 2.2vw, 1.4rem);
            padding: clamp(12px, 2vw, 18px) clamp(20px, 3vw, 40px);
        }

        .welcome-dialog button:hover {
            background: #45a049;
        }

        /* Mobile and small screens */
        @media (max-width: 768px) {
            .timing-container {
                flex-direction: column;
                padding: clamp(15px, 3vw, 30px);
            }

            /* Timer section at top in mobile */
            .timer-section {
                order: 1;
                margin-bottom: 30px;
                width: 100%;
            }

            /* Clock section at bottom in mobile */
            .clock-section {
                order: 2;
                width: 100%;
            }

            /* Hide desktop title, show mobile title */
            .desktop-title {
                display: none;
            }

            .mobile-title {
                display: block;
                font-size: clamp(1.8rem, 5vw, 2.8rem);
                text-align: center;
                margin-bottom: 20px;
            }

            /* Hide the title and finish time in clock section on mobile */
            .clock-section .desktop-title {
                display: none;
            }

            /* Digital clock styling when moved to timer section */
            .timer-section .digital-clock {
                margin: 20px 0 15px 0;
                font-size: clamp(2rem, 6vw, 4rem);
            }

            .teacher-message {
                margin-top: 25px;
                font-size: clamp(1.4rem, 4.5vw, 2.2rem);
                padding: 10px 5px;
            }

            .analog-clock {
                width: clamp(220px, 55vw, 340px);
                height: clamp(220px, 55vw, 340px);
                margin: 20px auto;
            }

            .preset-buttons {
                grid-template-columns: repeat(2, 1fr);
            }

            .time-inputs {
                flex-direction: column;
            }

            .countdown-display {
                font-size: clamp(2.5rem, 7vw, 5rem);
                margin: 10px 0;
            }

            .control-buttons {
                margin: 15px 0;
                flex-wrap: wrap;
                justify-content: center;
                gap: clamp(8px, 2vw, 15px);
            }

            .control-buttons button {
                padding: clamp(10px, 2vw, 15px) clamp(18px, 4vw, 30px);
                font-size: clamp(1rem, 3.5vw, 1.4rem);
            }

            .finish-time {
                margin: 10px 0;
            }
        }

        /* Large screens and projectors */
        @media (min-width: 1920px) {
            .timing-container {
                max-width: 90vw;
            }
        }
    </style>
</head>
<body>
    <!-- Welcome Dialog -->
    <div class="welcome-overlay" id="welcomeOverlay">
        <div class="welcome-dialog">
            <div class="welcome-emoji">‚è±Ô∏èüìö</div>
            <h1>Welcome to Assessment Timer!</h1>
            <p>A simple, distraction-free timer designed for classroom assessments and timed activities.</p>
            <ul>
                <li><span class="feature-icon">‚è∞</span><strong>Timing Tab:</strong> View the countdown, current time, and control your timer</li>
                <li><span class="feature-icon">‚öôÔ∏è</span><strong>Setup Timer:</strong> Set duration (e.g., 45 minutes) or a specific finish time (e.g., 2:30 PM)</li>
                <li><span class="feature-icon">üé®</span><strong>Settings:</strong> Customize clock format, display options, and sounds</li>
                <li><span class="feature-icon">üí¨</span><strong>Teacher Message:</strong> Click the text area below the timer to add instructions</li>
                <li><span class="feature-icon">üåü</span><strong>Encouraging Emojis:</strong> Occasional floating emojis to brighten the room!</li>
            </ul>
            <p class="tip-text">Tip: Click the digital clock to toggle 12/24 hour format</p>
            <button id="welcomeStartBtn">Let's Get Started!</button>
            <p class="dismiss-hint">Press ESC to dismiss</p>
        </div>
    </div>

    <!-- Completion Banner -->
    <div class="completion-banner" id="completionBanner">
        ‚è∞ Time's Up! ‚è∞
        <div class="dismiss-hint">Click anywhere to dismiss</div>
    </div>

    <!-- Tab Navigation -->
    <div class="tab-nav">
        <button class="tab-button active" data-tab="timing">Timing</button>
        <button class="tab-button" data-tab="setup">Setup Timer</button>
        <button class="tab-button" data-tab="settings">Settings</button>
    </div>

    <!-- Timing Tab -->
    <div id="timing" class="tab-content active">
        <div class="timing-container">
            <div class="clock-section">
                <h2 class="desktop-title">Current Time</h2>
                
                <div class="analog-clock">
                    <div class="clock-marks" id="clockMarks"></div>
                    <div class="clock-numbers" id="clockNumbers"></div>
                    <div class="hand hour-hand finish" id="finishHourHand"></div>
                    <div class="hand minute-hand finish" id="finishMinuteHand"></div>
                    <div class="hand hour-hand" id="hourHand"></div>
                    <div class="hand minute-hand" id="minuteHand"></div>
                    <div class="hand second-hand" id="secondHand"></div>
                    <div class="clock-center"></div>
                </div>
                
                <div class="digital-clock" id="digitalClock" title="Click to toggle 12/24 hour format">00:00:00 AM</div>
                <div class="finish-time" id="finishTimeLeft">Finish: --:--:-- --</div>
            </div>

            <div class="timer-section">
                <h2 class="desktop-title">Countdown Timer</h2>
                <h2 class="mobile-title">Timer & Clock</h2>
                
                <div class="countdown-display" id="countdown">00:00:00</div>
                
                <div class="control-buttons" id="controlButtons">
                    <button id="startBtn">Setup</button>
                    <button id="pauseBtn" style="display: none;">Pause</button>
                    <button id="resetBtn" style="display: none;">Reset</button>
                </div>
                
                <div class="finish-time" id="finishTimeRight">Finish: --:--:-- --</div>
                
                <div class="teacher-message" id="teacherMessage" contenteditable="true" spellcheck="false"></div>
            </div>
        </div>
    </div>

    <!-- Setup Timer Tab -->
    <div id="setup" class="tab-content">
        <div class="setup-container">
            <h2 class="desktop-title">Setup Timer</h2>
            
            <div class="mode-selector">
                <div class="mode-option">
                    <input type="radio" id="durationMode" name="timerMode" value="duration" checked>
                    <label for="durationMode">Set Duration</label>
                </div>
                <div class="mode-option">
                    <input type="radio" id="finishTimeMode" name="timerMode" value="finishTime">
                    <label for="finishTimeMode">Set Finish Time</label>
                </div>
            </div>

            <!-- Duration Entry Mode -->
            <div id="durationModeContent" class="mode-content active">
                <div class="input-group">
                    <label>Enter Duration (minutes or HH:MM)</label>
                    <input type="text" class="timer-input-large" id="durationInput" placeholder="45 or 1:30" value="">
                </div>
                
                <div class="preset-buttons">
                    <button class="preset-btn" data-minutes="15">15 min</button>
                    <button class="preset-btn" data-minutes="30">30 min</button>
                    <button class="preset-btn" data-minutes="45">45 min</button>
                    <button class="preset-btn" data-minutes="60">1 hour</button>
                    <button class="preset-btn" data-minutes="90">1.5 hours</button>
                    <button class="preset-btn" data-minutes="120">2 hours</button>
                </div>
            </div>

            <!-- Finish Time Entry Mode -->
            <div id="finishTimeModeContent" class="mode-content">
                <div class="input-group">
                    <label>Set Finish Time</label>
                    <div class="time-inputs">
                        <div class="time-input-group">
                            <input type="time" class="timer-input-large" id="finishTimeInput">
                        </div>
                        <div class="time-input-group">
                            <select class="timer-input-large" id="finishDateSelect">
                                <option value="today">Today</option>
                                <option value="tomorrow">Tomorrow</option>
                            </select>
                        </div>
                    </div>
                    <div id="currentTimeDisplay" style="margin-top: 10px; font-size: clamp(0.9rem, 1.5vw, 1.1rem); text-align: center;">
                        Current Time: <span id="currentTimeText">--:--:-- --</span>
                    </div>
                    <div class="duration-display" id="calculatedDuration">
                        Timer will run for: -- hours, -- minutes
                    </div>
                    <div class="error-message" id="timeError" style="display: none;">
                        Selected time is in the past. Please choose a future time.
                    </div>
                </div>
            </div>

            <div style="display: flex; gap: 15px; margin-top: 25px;">
                <button style="flex: 1;" id="setTimerBtn">Set Timer</button>
                <button style="flex: 1; background: #666;" id="clearTimerBtn">Clear</button>
            </div>
        </div>
    </div>

    <!-- Settings Tab -->
    <div id="settings" class="tab-content">
        <div class="settings-container">
            <h2 class="desktop-title">Settings</h2>
            
            <div class="settings-group">
                <h3>Clock Format</h3>
                <div class="setting-item">
                    <span class="setting-label">Time Format</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="clockFormatToggle">
                        <span class="toggle-slider"></span>
                    </label>
                    <span id="formatLabel" style="width: 80px; text-align: right;">12 Hour</span>
                </div>
            </div>

            <div class="settings-group">
                <h3>Display Options</h3>
                <div class="setting-item">
                    <span class="setting-label">Show Seconds</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="showSecondsToggle" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <span class="setting-label">Show Finish Time</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="showFinishToggle" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <span class="setting-label">Encouraging Emojis</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="emojiToggle" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
            </div>

            <div class="settings-group">
                <h3>Sound Options</h3>
                <div class="setting-item">
                    <span class="setting-label">Completion Alert</span>
                    <label class="toggle-switch">
                        <input type="checkbox" id="soundToggle" checked>
                        <span class="toggle-slider"></span>
                    </label>
                </div>
                <div class="setting-item">
                    <span class="setting-label">Volume</span>
                    <input type="range" class="volume-slider" id="volumeSlider" min="0" max="100" value="70">
                </div>
            </div>

            <div style="display: flex; gap: 15px; margin-top: 25px;">
                <button style="flex: 1;" id="saveSettingsBtn">Save Settings</button>
                <button style="flex: 1; background: #666;" id="resetSettingsBtn">Reset to Defaults</button>
            </div>
        </div>
    </div>

    <script>
        // ===========================================
        // TIMER STATE MACHINE
        // ===========================================
        const TimerState = {
            IDLE: 'idle',           // No timer configured
            READY: 'ready',         // Timer configured, not started
            RUNNING: 'running',     // Actively counting down
            PAUSED: 'paused',       // Paused mid-countdown
            FINISHED: 'finished'    // Timer completed
        };

        // ===========================================
        // GLOBAL STATE
        // ===========================================
        let state = {
            timerState: TimerState.IDLE,
            // Timing data
            endTime: null,              // Absolute timestamp when timer ends
            durationMs: 0,              // Original duration in ms (for duration mode resets)
            remainingMsWhenPaused: 0,   // Remaining time when paused (for duration mode)
            isFinishTimeMode: false,    // True if using absolute finish time mode
            // Reset confirmation
            resetPending: false,
            resetTimeout: null,
            // Set timer confirmation
            setTimerPending: false,
            setTimerTimeout: null,
            // First run
            hasSeenWelcome: false,
            // Emoji timing
            lastEmojiTime: Date.now(),
            // Audio
            audioContext: null,
            // Completion banner
            completionDismissed: false
        };

        let settings = {
            is24Hour: false,
            showSeconds: true,
            showFinishTime: true,
            enableEmojis: true,
            enableSound: true,
            volume: 70
        };

        const encouragingEmojis = ['‚≠ê', 'üåü', '‚ú®', 'üéØ', 'üèÜ', 'ü•á', 'üëè', 'üí™', 'üôå', 'üëç', 'üéâ', 'üéä', 'üíØ', 'üåà', 'üöÄ', 'üìö', '‚úÖ', 'üî•', 'üí°', 'üéì'];

        // ===========================================
        // DOM ELEMENTS
        // ===========================================
        const elements = {
            // Welcome dialog
            welcomeOverlay: document.getElementById('welcomeOverlay'),
            welcomeStartBtn: document.getElementById('welcomeStartBtn'),
            // Timing tab
            countdown: document.getElementById('countdown'),
            startBtn: document.getElementById('startBtn'),
            pauseBtn: document.getElementById('pauseBtn'),
            resetBtn: document.getElementById('resetBtn'),
            finishTimeLeft: document.getElementById('finishTimeLeft'),
            finishTimeRight: document.getElementById('finishTimeRight'),
            finishHourHand: document.getElementById('finishHourHand'),
            finishMinuteHand: document.getElementById('finishMinuteHand'),
            digitalClock: document.getElementById('digitalClock'),
            hourHand: document.getElementById('hourHand'),
            minuteHand: document.getElementById('minuteHand'),
            secondHand: document.getElementById('secondHand'),
            teacherMessage: document.getElementById('teacherMessage'),
            completionBanner: document.getElementById('completionBanner'),
            controlButtons: document.getElementById('controlButtons'),
            // Setup tab
            durationInput: document.getElementById('durationInput'),
            finishTimeInput: document.getElementById('finishTimeInput'),
            finishDateSelect: document.getElementById('finishDateSelect'),
            calculatedDuration: document.getElementById('calculatedDuration'),
            timeError: document.getElementById('timeError'),
            currentTimeText: document.getElementById('currentTimeText'),
            // Settings
            clockFormatToggle: document.getElementById('clockFormatToggle'),
            showSecondsToggle: document.getElementById('showSecondsToggle'),
            showFinishToggle: document.getElementById('showFinishToggle'),
            emojiToggle: document.getElementById('emojiToggle'),
            soundToggle: document.getElementById('soundToggle'),
            volumeSlider: document.getElementById('volumeSlider'),
            formatLabel: document.getElementById('formatLabel')
        };

        // ===========================================
        // UTILITY FUNCTIONS
        // ===========================================
        function parseTimeInput(input) {
            const trimmed = input.trim();
            if (!trimmed) return 0;
            
            if (trimmed.includes(':')) {
                const parts = trimmed.split(':');
                if (parts.length === 2) {
                    const hours = parseInt(parts[0]) || 0;
                    const minutes = parseInt(parts[1]) || 0;
                    return (hours * 3600 + minutes * 60) * 1000;
                }
            } else {
                const minutes = parseInt(trimmed) || 0;
                return minutes * 60 * 1000;
            }
            return 0;
        }

        function formatDuration(ms) {
            if (ms < 0) ms = 0;
            const totalSeconds = Math.ceil(ms / 1000);
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;
            return `${String(hours).padStart(2, '0')}:${String(minutes).padStart(2, '0')}:${String(seconds).padStart(2, '0')}`;
        }

        function formatTime(date, includeSeconds = true, includeAmPm = true) {
            if (settings.is24Hour) {
                const options = {
                    hour12: false,
                    hour: '2-digit',
                    minute: '2-digit'
                };
                if (includeSeconds) {
                    options.second = '2-digit';
                }
                return date.toLocaleTimeString('en-US', options);
            } else {
                const options = {
                    hour12: true,
                    hour: 'numeric',
                    minute: '2-digit'
                };
                if (includeSeconds) {
                    options.second = '2-digit';
                }
                let timeStr = date.toLocaleTimeString('en-US', options);
                if (!includeAmPm) {
                    // Remove AM/PM
                    timeStr = timeStr.replace(/\s?(AM|PM)$/i, '');
                }
                return timeStr;
            }
        }

        // Determine the best format for digital clock based on available width
        function getResponsiveClockFormat() {
            const container = elements.digitalClock.parentElement;
            const availableWidth = container.clientWidth - 40; // Some padding
            
            // Create a temporary span to measure text width
            const measureSpan = document.createElement('span');
            measureSpan.style.cssText = `
                position: absolute;
                visibility: hidden;
                white-space: nowrap;
                font-family: 'Courier New', monospace;
                font-weight: 900;
                font-size: ${window.getComputedStyle(elements.digitalClock).fontSize};
                letter-spacing: ${window.getComputedStyle(elements.digitalClock).letterSpacing};
            `;
            document.body.appendChild(measureSpan);
            
            const now = new Date();
            
            // Try full format first: "12:34:56 PM"
            measureSpan.textContent = formatTime(now, true, true);
            if (measureSpan.offsetWidth <= availableWidth) {
                document.body.removeChild(measureSpan);
                return { includeSeconds: true, includeAmPm: true };
            }
            
            // Try without seconds: "12:34 PM"
            measureSpan.textContent = formatTime(now, false, true);
            if (measureSpan.offsetWidth <= availableWidth) {
                document.body.removeChild(measureSpan);
                return { includeSeconds: false, includeAmPm: true };
            }
            
            // Fall back to minimal: "12:34"
            document.body.removeChild(measureSpan);
            return { includeSeconds: false, includeAmPm: false };
        }

        function getRemainingMs() {
            if (state.timerState === TimerState.PAUSED) {
                return state.remainingMsWhenPaused;
            }
            if (state.endTime) {
                return Math.max(0, state.endTime - Date.now());
            }
            return 0;
        }

        // ===========================================
        // TIMER LOGIC
        // ===========================================
        function setTimerFromDuration(durationMs) {
            state.durationMs = durationMs;
            state.isFinishTimeMode = false;
            state.endTime = null;
            state.remainingMsWhenPaused = durationMs;
            state.timerState = TimerState.READY;
            state.completionDismissed = false;
            updateUI();
        }

        function setTimerFromFinishTime(finishTimestamp) {
            const now = Date.now();
            if (finishTimestamp <= now) {
                return false;
            }
            state.endTime = finishTimestamp;
            state.durationMs = finishTimestamp - now;
            state.isFinishTimeMode = true;
            state.remainingMsWhenPaused = 0;
            state.timerState = TimerState.READY;
            state.completionDismissed = false;
            updateUI();
            return true;
        }

        function startTimer() {
            if (state.timerState === TimerState.IDLE) {
                // Go to setup tab
                switchToTab('setup');
                return;
            }
            
            if (state.timerState === TimerState.FINISHED) {
                // Start new timer with same settings
                if (state.isFinishTimeMode) {
                    // Can't restart finish time mode - go to setup
                    switchToTab('setup');
                    return;
                } else {
                    // Reset to original duration
                    state.remainingMsWhenPaused = state.durationMs;
                    state.timerState = TimerState.READY;
                }
            }

            if (state.timerState === TimerState.READY) {
                // Starting fresh
                if (state.isFinishTimeMode) {
                    // endTime already set
                } else {
                    state.endTime = Date.now() + state.durationMs;
                }
            } else if (state.timerState === TimerState.PAUSED) {
                // Resuming
                if (state.isFinishTimeMode) {
                    // Finish time mode: endTime stays the same (absolute)
                    // Check if we've passed the end time while paused
                    if (Date.now() >= state.endTime) {
                        completeTimer();
                        return;
                    }
                } else {
                    // Duration mode: calculate new end time from remaining
                    state.endTime = Date.now() + state.remainingMsWhenPaused;
                }
            }

            state.timerState = TimerState.RUNNING;
            clearResetConfirmation();
            updateUI();
        }

        function pauseTimer() {
            if (state.timerState !== TimerState.RUNNING) return;
            
            // Store remaining time for duration mode resume
            state.remainingMsWhenPaused = getRemainingMs();
            state.timerState = TimerState.PAUSED;
            updateUI();
        }

        function resetTimer(force = false) {
            // If timer is running and not forced, require confirmation
            if (state.timerState === TimerState.RUNNING && !force) {
                if (!state.resetPending) {
                    // First click - ask for confirmation
                    state.resetPending = true;
                    elements.resetBtn.textContent = 'Confirm?';
                    elements.resetBtn.classList.add('confirm');
                    
                    // Auto-cancel after 3 seconds
                    state.resetTimeout = setTimeout(() => {
                        clearResetConfirmation();
                    }, 3000);
                    return;
                } else {
                    // Second click - confirmed, proceed with reset
                    clearResetConfirmation();
                }
            }

            // Perform reset
            if (state.durationMs > 0 && !state.isFinishTimeMode) {
                // Duration mode: reset to original duration
                state.remainingMsWhenPaused = state.durationMs;
                state.endTime = null;
                state.timerState = TimerState.READY;
            } else if (state.isFinishTimeMode && state.endTime > Date.now()) {
                // Finish time mode: if finish time hasn't passed, go to ready
                state.timerState = TimerState.READY;
            } else {
                // Clear everything
                clearTimer();
            }
            
            hideCompletionBanner();
            state.completionDismissed = false;
            updateUI();
        }

        function clearTimer() {
            state.timerState = TimerState.IDLE;
            state.endTime = null;
            state.durationMs = 0;
            state.remainingMsWhenPaused = 0;
            state.isFinishTimeMode = false;
            state.completionDismissed = false;
            clearResetConfirmation();
            hideCompletionBanner();
            updateUI();
        }

        function clearResetConfirmation() {
            state.resetPending = false;
            if (state.resetTimeout) {
                clearTimeout(state.resetTimeout);
                state.resetTimeout = null;
            }
            elements.resetBtn.textContent = 'Reset';
            elements.resetBtn.classList.remove('confirm');
        }

        function clearSetTimerConfirmation() {
            state.setTimerPending = false;
            if (state.setTimerTimeout) {
                clearTimeout(state.setTimerTimeout);
                state.setTimerTimeout = null;
            }
            const setTimerBtn = document.getElementById('setTimerBtn');
            setTimerBtn.textContent = 'Set Timer';
            setTimerBtn.classList.remove('confirm');
        }

        function completeTimer() {
            state.timerState = TimerState.FINISHED;
            state.endTime = null;
            
            if (!state.completionDismissed) {
                showCompletionBanner();
                playCompletionSound();
            }
            
            updateUI();
        }

        function newTimer() {
            clearTimer();
            switchToTab('setup');
        }

        // ===========================================
        // UI UPDATE
        // ===========================================
        function updateUI() {
            updateCountdownDisplay();
            updateButtonStates();
            updateFinishTimeDisplay();
        }

        function updateCountdownDisplay() {
            const remaining = getRemainingMs();
            elements.countdown.textContent = formatDuration(remaining);
            
            // Visual state for finished
            if (state.timerState === TimerState.FINISHED) {
                elements.countdown.classList.add('finished');
            } else {
                elements.countdown.classList.remove('finished');
            }
        }

        function updateButtonStates() {
            const startBtn = elements.startBtn;
            const pauseBtn = elements.pauseBtn;
            const resetBtn = elements.resetBtn;
            
            // Clear any existing new-timer button
            const existingNewBtn = document.getElementById('newTimerBtn');
            if (existingNewBtn) {
                existingNewBtn.remove();
            }

            switch (state.timerState) {
                case TimerState.IDLE:
                    startBtn.textContent = 'Setup';
                    startBtn.disabled = false;
                    pauseBtn.style.display = 'none';
                    resetBtn.style.display = 'none';
                    break;
                    
                case TimerState.READY:
                    startBtn.textContent = 'Start';
                    startBtn.disabled = false;
                    pauseBtn.style.display = 'none';
                    resetBtn.style.display = 'inline-block';
                    resetBtn.disabled = false;
                    break;
                    
                case TimerState.RUNNING:
                    startBtn.textContent = 'Start';
                    startBtn.disabled = true;
                    pauseBtn.style.display = 'inline-block';
                    pauseBtn.disabled = false;
                    resetBtn.style.display = 'inline-block';
                    resetBtn.disabled = false;
                    break;
                    
                case TimerState.PAUSED:
                    startBtn.textContent = 'Continue';
                    startBtn.disabled = false;
                    pauseBtn.style.display = 'inline-block';
                    pauseBtn.disabled = true;
                    resetBtn.style.display = 'inline-block';
                    resetBtn.disabled = false;
                    break;
                    
                case TimerState.FINISHED:
                    startBtn.textContent = state.isFinishTimeMode ? 'Setup' : 'Restart';
                    startBtn.disabled = false;
                    pauseBtn.style.display = 'none';
                    resetBtn.style.display = 'inline-block';
                    resetBtn.disabled = false;
                    // Add "New Timer" button
                    const newBtn = document.createElement('button');
                    newBtn.id = 'newTimerBtn';
                    newBtn.className = 'new-timer';
                    newBtn.textContent = 'New';
                    newBtn.onclick = newTimer;
                    elements.controlButtons.appendChild(newBtn);
                    break;
            }
        }

        function updateFinishTimeDisplay() {
            const showFinish = settings.showFinishTime && 
                              (state.timerState === TimerState.RUNNING || state.timerState === TimerState.READY) &&
                              state.endTime;

            if (showFinish) {
                const finishDate = new Date(state.endTime);
                const finishStr = formatTime(finishDate, false);
                
                // Update hands
                const hours = finishDate.getHours() % 12;
                const minutes = finishDate.getMinutes();
                const hourDeg = (hours * 30) + (minutes * 0.5);
                const minuteDeg = minutes * 6;
                
                elements.finishHourHand.style.transform = `rotate(${hourDeg}deg)`;
                elements.finishMinuteHand.style.transform = `rotate(${minuteDeg}deg)`;
                elements.finishHourHand.classList.add('visible');
                elements.finishMinuteHand.classList.add('visible');
                
                elements.finishTimeLeft.textContent = `Finish: ${finishStr}`;
                elements.finishTimeRight.textContent = `Finish: ${finishStr}`;
                elements.finishTimeLeft.classList.add('visible');
                elements.finishTimeRight.classList.add('visible');
            } else {
                elements.finishHourHand.classList.remove('visible');
                elements.finishMinuteHand.classList.remove('visible');
                elements.finishTimeLeft.classList.remove('visible');
                elements.finishTimeRight.classList.remove('visible');
            }
        }

        // ===========================================
        // CLOCK
        // ===========================================
        function updateClock() {
            const now = new Date();
            const hours = now.getHours() % 12;
            const minutes = now.getMinutes();
            const seconds = now.getSeconds();

            const hourDeg = (hours * 30) + (minutes * 0.5);
            const minuteDeg = minutes * 6;
            const secondDeg = seconds * 6;

            elements.hourHand.style.transform = `rotate(${hourDeg}deg)`;
            elements.minuteHand.style.transform = `rotate(${minuteDeg}deg)`;
            
            if (settings.showSeconds) {
                elements.secondHand.style.display = 'block';
                elements.secondHand.style.transform = `rotate(${secondDeg}deg)`;
            } else {
                elements.secondHand.style.display = 'none';
            }

            // Get responsive format based on available space
            const format = getResponsiveClockFormat();
            // Respect user's showSeconds setting as maximum (can reduce but not add)
            const showSecs = settings.showSeconds && format.includeSeconds;
            elements.digitalClock.textContent = formatTime(now, showSecs, format.includeAmPm);
        }

        function createClockNumbers() {
            const numbersContainer = document.getElementById('clockNumbers');
            const clockElement = numbersContainer.parentElement;
            const clockRadius = clockElement.offsetWidth / 2;
            const numberRadius = clockRadius * 0.72;

            const numbers = [
                {num: 12, angle: -90}, {num: 1, angle: -60}, {num: 2, angle: -30},
                {num: 3, angle: 0}, {num: 4, angle: 30}, {num: 5, angle: 60},
                {num: 6, angle: 90}, {num: 7, angle: 120}, {num: 8, angle: 150},
                {num: 9, angle: 180}, {num: 10, angle: 210}, {num: 11, angle: 240}
            ];

            numbersContainer.innerHTML = '';
            numbers.forEach(({num, angle}) => {
                const numberEl = document.createElement('div');
                numberEl.className = 'clock-number';
                numberEl.textContent = num;
                
                const rad = (angle * Math.PI) / 180;
                const x = Math.cos(rad) * numberRadius;
                const y = Math.sin(rad) * numberRadius;
                
                numberEl.style.left = `calc(50% + ${x}px)`;
                numberEl.style.top = `calc(50% + ${y}px)`;
                numberEl.style.transform = 'translate(-50%, -50%)';
                
                numbersContainer.appendChild(numberEl);
            });
        }

        function createClockMarks() {
            const marksContainer = document.getElementById('clockMarks');
            const clockElement = marksContainer.parentElement;
            const clockRadius = clockElement.offsetWidth / 2;
            marksContainer.innerHTML = '';
            
            for (let i = 0; i < 60; i++) {
                const mark = document.createElement('div');
                const angle = (i * 6);
                
                if (i % 5 === 0) {
                    mark.className = 'hour-mark';
                    const distance = clockRadius - (clockRadius * 0.12);
                    mark.style.transform = `rotate(${angle}deg) translateY(-${distance}px)`;
                } else {
                    mark.className = 'minute-mark';
                    const distance = clockRadius - (clockRadius * 0.08);
                    mark.style.transform = `rotate(${angle}deg) translateY(-${distance}px)`;
                }
                mark.style.transformOrigin = 'center center';
                marksContainer.appendChild(mark);
            }
        }

        // ===========================================
        // COMPLETION NOTIFICATION
        // ===========================================
        function showCompletionBanner() {
            elements.completionBanner.classList.add('visible');
        }

        function hideCompletionBanner() {
            elements.completionBanner.classList.remove('visible');
        }

        // ===========================================
        // WELCOME DIALOG
        // ===========================================
        function showWelcomeDialog() {
            elements.welcomeOverlay.classList.add('visible');
        }

        function dismissWelcomeDialog() {
            elements.welcomeOverlay.classList.remove('visible');
            state.hasSeenWelcome = true;
            // Store in sessionStorage so it only shows once per session
            // (will show again if user refreshes, which is fine for a classroom tool)
            try {
                sessionStorage.setItem('assessmentTimerWelcomeSeen', 'true');
            } catch (e) {
                // Ignore if sessionStorage not available
            }
        }

        function checkFirstRun() {
            try {
                const seen = sessionStorage.getItem('assessmentTimerWelcomeSeen');
                if (!seen) {
                    showWelcomeDialog();
                } else {
                    state.hasSeenWelcome = true;
                }
            } catch (e) {
                // If sessionStorage not available, show welcome
                showWelcomeDialog();
            }
        }

        function playCompletionSound() {
            if (!settings.enableSound) return;
            
            try {
                // Create audio context on demand
                if (!state.audioContext) {
                    state.audioContext = new (window.AudioContext || window.webkitAudioContext)();
                }
                
                const ctx = state.audioContext;
                const volume = settings.volume / 100;
                
                // Play a pleasant chime sequence
                const frequencies = [523.25, 659.25, 783.99, 1046.50]; // C5, E5, G5, C6
                
                frequencies.forEach((freq, i) => {
                    const oscillator = ctx.createOscillator();
                    const gainNode = ctx.createGain();
                    
                    oscillator.connect(gainNode);
                    gainNode.connect(ctx.destination);
                    
                    oscillator.frequency.value = freq;
                    oscillator.type = 'sine';
                    
                    const startTime = ctx.currentTime + (i * 0.15);
                    const duration = 0.4;
                    
                    gainNode.gain.setValueAtTime(0, startTime);
                    gainNode.gain.linearRampToValueAtTime(volume * 0.3, startTime + 0.02);
                    gainNode.gain.exponentialRampToValueAtTime(0.001, startTime + duration);
                    
                    oscillator.start(startTime);
                    oscillator.stop(startTime + duration);
                });
            } catch (e) {
                console.warn('Could not play sound:', e);
            }
        }

        // ===========================================
        // EMOJI EASTER EGG
        // ===========================================
        function maybeShowEmoji() {
            if (!settings.enableEmojis) return;
            if (state.timerState !== TimerState.RUNNING) return;
            
            const timeSinceLastEmoji = Date.now() - state.lastEmojiTime;
            if (timeSinceLastEmoji > 600000 && Math.random() < 0.05) {
                showFloatingEmoji();
                state.lastEmojiTime = Date.now();
            }
        }

        function showFloatingEmoji() {
            const emoji = encouragingEmojis[Math.floor(Math.random() * encouragingEmojis.length)];
            const emojiElement = document.createElement('div');
            emojiElement.className = 'floating-emoji';
            emojiElement.textContent = emoji;
            emojiElement.style.top = Math.random() * 80 + 10 + '%';
            document.body.appendChild(emojiElement);
            
            setTimeout(() => emojiElement.remove(), 8000);
        }

        // ===========================================
        // SETUP TAB
        // ===========================================
        function updateSetupTab() {
            elements.currentTimeText.textContent = formatTime(new Date(), false);
            calculateDurationFromFinishTime();
        }

        function calculateDurationFromFinishTime() {
            const timeInput = elements.finishTimeInput.value;
            const dateSelect = elements.finishDateSelect.value;
            
            if (!timeInput) {
                elements.calculatedDuration.textContent = 'Timer will run for: -- hours, -- minutes';
                elements.timeError.style.display = 'none';
                return;
            }

            const now = new Date();
            const [hours, minutes] = timeInput.split(':').map(Number);
            const targetDate = new Date();
            
            targetDate.setHours(hours, minutes, 0, 0);
            
            if (dateSelect === 'tomorrow') {
                targetDate.setDate(targetDate.getDate() + 1);
            }

            const diffMs = targetDate - now;
            
            if (diffMs <= 0) {
                elements.timeError.style.display = 'block';
                elements.calculatedDuration.style.display = 'none';
            } else {
                elements.timeError.style.display = 'none';
                elements.calculatedDuration.style.display = 'block';
                
                const diffHours = Math.floor(diffMs / (1000 * 60 * 60));
                const diffMinutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
                
                elements.calculatedDuration.textContent = 
                    `Timer will run for: ${diffHours} hours, ${diffMinutes} minutes`;
            }
        }

        function applyTimerSettings() {
            const setTimerBtn = document.getElementById('setTimerBtn');
            
            // If timer is running or paused, require confirmation
            if (state.timerState === TimerState.RUNNING || state.timerState === TimerState.PAUSED) {
                if (!state.setTimerPending) {
                    // First click - ask for confirmation
                    state.setTimerPending = true;
                    setTimerBtn.textContent = 'Cancel Current?';
                    setTimerBtn.classList.add('confirm');
                    
                    // Auto-cancel after 3 seconds
                    state.setTimerTimeout = setTimeout(() => {
                        clearSetTimerConfirmation();
                    }, 3000);
                    return;
                } else {
                    // Second click - confirmed, proceed
                    clearSetTimerConfirmation();
                }
            }
            
            const isDurationMode = document.getElementById('durationMode').checked;
            
            if (isDurationMode) {
                const input = elements.durationInput.value;
                const durationMs = parseTimeInput(input);
                
                if (durationMs <= 0) {
                    // Visual feedback - shake the input
                    elements.durationInput.style.borderColor = '#f44336';
                    setTimeout(() => {
                        elements.durationInput.style.borderColor = '#000';
                    }, 1000);
                    return;
                }
                
                setTimerFromDuration(durationMs);
            } else {
                const timeInput = elements.finishTimeInput.value;
                const dateSelect = elements.finishDateSelect.value;
                
                if (!timeInput) {
                    elements.finishTimeInput.style.borderColor = '#f44336';
                    setTimeout(() => {
                        elements.finishTimeInput.style.borderColor = '#000';
                    }, 1000);
                    return;
                }

                const [hours, minutes] = timeInput.split(':').map(Number);
                const targetDate = new Date();
                targetDate.setHours(hours, minutes, 0, 0);
                
                if (dateSelect === 'tomorrow') {
                    targetDate.setDate(targetDate.getDate() + 1);
                }

                if (!setTimerFromFinishTime(targetDate.getTime())) {
                    // Time is in the past
                    return;
                }
            }

            // Switch to timing tab and auto-start
            switchToTab('timing');
            setTimeout(() => startTimer(), 50);
        }

        function clearTimerSettings() {
            elements.durationInput.value = '';
            elements.finishTimeInput.value = '';
            clearSetTimerConfirmation();
            clearTimer();
        }

        // ===========================================
        // TAB SWITCHING
        // ===========================================
        function switchToTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tabName);
            });
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.id === tabName);
            });
            
            clearResetConfirmation();
            clearSetTimerConfirmation();
            
            if (tabName === 'setup') {
                updateSetupTab();
            }
        }

        // ===========================================
        // SETTINGS
        // ===========================================
        function loadSettingsToUI() {
            elements.clockFormatToggle.checked = settings.is24Hour;
            elements.showSecondsToggle.checked = settings.showSeconds;
            elements.showFinishToggle.checked = settings.showFinishTime;
            elements.emojiToggle.checked = settings.enableEmojis;
            elements.soundToggle.checked = settings.enableSound;
            elements.volumeSlider.value = settings.volume;
            elements.formatLabel.textContent = settings.is24Hour ? '24 Hour' : '12 Hour';
        }

        function saveSettings() {
            // Settings are applied immediately via change listeners
            // This button just provides confirmation feedback
            const btn = document.getElementById('saveSettingsBtn');
            const originalText = btn.textContent;
            btn.textContent = '‚úì Applied';
            btn.style.background = '#4caf50';
            setTimeout(() => {
                btn.textContent = originalText;
                btn.style.background = '';
            }, 1500);
        }

        function resetSettingsToDefaults() {
            settings = {
                is24Hour: false,
                showSeconds: true,
                showFinishTime: true,
                enableEmojis: true,
                enableSound: true,
                volume: 70
            };
            loadSettingsToUI();
            updateClock();
            updateFinishTimeDisplay();
        }

        // ===========================================
        // MAIN UPDATE LOOP
        // ===========================================
        function mainLoop() {
            updateClock();
            
            if (state.timerState === TimerState.RUNNING) {
                const remaining = getRemainingMs();
                
                if (remaining <= 0) {
                    completeTimer();
                } else {
                    updateCountdownDisplay();
                    maybeShowEmoji();
                }
            }
            
            // Update setup tab current time if visible
            if (document.getElementById('setup').classList.contains('active')) {
                updateSetupTab();
            }
        }

        // ===========================================
        // RESPONSIVE LAYOUT
        // ===========================================
        function handleResize() {
            createClockNumbers();
            createClockMarks();
            
            const digitalClock = elements.digitalClock;
            const clockSection = document.querySelector('.clock-section');
            const timerSection = document.querySelector('.timer-section');
            const countdown = elements.countdown;
            
            if (window.innerWidth <= 768) {
                // Mobile: move digital clock to timer section
                if (!timerSection.contains(digitalClock)) {
                    timerSection.insertBefore(digitalClock, countdown);
                }
            } else {
                // Desktop: move digital clock back to clock section
                if (!clockSection.contains(digitalClock)) {
                    const analogClock = clockSection.querySelector('.analog-clock');
                    if (analogClock) {
                        analogClock.insertAdjacentElement('afterend', digitalClock);
                    }
                }
            }
            
            updateFinishTimeDisplay();
            // Update clock to recalculate responsive format
            updateClock();
        }

        // ===========================================
        // EVENT LISTENERS
        // ===========================================
        function initEventListeners() {
            // Welcome dialog
            elements.welcomeStartBtn.addEventListener('click', dismissWelcomeDialog);
            
            // ESC key to dismiss welcome dialog or return to timing tab
            document.addEventListener('keydown', (e) => {
                if (e.key === 'Escape') {
                    if (elements.welcomeOverlay.classList.contains('visible')) {
                        dismissWelcomeDialog();
                    } else if (!document.getElementById('timing').classList.contains('active')) {
                        // Return to timing tab from setup/settings
                        switchToTab('timing');
                    }
                }
            });
            
            // Click outside dialog to dismiss
            elements.welcomeOverlay.addEventListener('click', (e) => {
                if (e.target === elements.welcomeOverlay) {
                    dismissWelcomeDialog();
                }
            });
            
            // Tab buttons
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.addEventListener('click', () => switchToTab(btn.dataset.tab));
            });

            // Timer controls
            elements.startBtn.addEventListener('click', startTimer);
            elements.pauseBtn.addEventListener('click', pauseTimer);
            elements.resetBtn.addEventListener('click', () => resetTimer());

            // Digital clock toggle
            elements.digitalClock.addEventListener('click', () => {
                settings.is24Hour = !settings.is24Hour;
                elements.clockFormatToggle.checked = settings.is24Hour;
                elements.formatLabel.textContent = settings.is24Hour ? '24 Hour' : '12 Hour';
                updateClock();
                updateFinishTimeDisplay();
            });

            // Completion banner dismiss
            elements.completionBanner.addEventListener('click', () => {
                hideCompletionBanner();
                state.completionDismissed = true;
            });

            // Also dismiss on any click when banner is visible
            document.addEventListener('click', (e) => {
                if (elements.completionBanner.classList.contains('visible') && 
                    !elements.completionBanner.contains(e.target)) {
                    hideCompletionBanner();
                    state.completionDismissed = true;
                }
            });

            // Setup tab - mode switching
            document.getElementById('durationMode').addEventListener('change', function() {
                if (this.checked) {
                    document.getElementById('durationModeContent').classList.add('active');
                    document.getElementById('finishTimeModeContent').classList.remove('active');
                }
            });

            document.getElementById('finishTimeMode').addEventListener('change', function() {
                if (this.checked) {
                    document.getElementById('finishTimeModeContent').classList.add('active');
                    document.getElementById('durationModeContent').classList.remove('active');
                }
            });

            // Setup tab - finish time inputs
            elements.finishTimeInput.addEventListener('input', calculateDurationFromFinishTime);
            elements.finishDateSelect.addEventListener('change', calculateDurationFromFinishTime);

            // Setup tab - preset buttons
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const minutes = parseInt(btn.dataset.minutes);
                    const hours = Math.floor(minutes / 60);
                    const mins = minutes % 60;
                    elements.durationInput.value = hours > 0 
                        ? `${hours}:${mins.toString().padStart(2, '0')}`
                        : minutes.toString();
                });
            });

            // Setup tab buttons
            document.getElementById('setTimerBtn').addEventListener('click', applyTimerSettings);
            document.getElementById('clearTimerBtn').addEventListener('click', clearTimerSettings);

            // Settings
            document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);
            document.getElementById('resetSettingsBtn').addEventListener('click', resetSettingsToDefaults);

            // All settings apply immediately on change
            elements.clockFormatToggle.addEventListener('change', function() {
                settings.is24Hour = this.checked;
                elements.formatLabel.textContent = settings.is24Hour ? '24 Hour' : '12 Hour';
                updateClock();
                updateFinishTimeDisplay();
            });

            elements.showSecondsToggle.addEventListener('change', function() {
                settings.showSeconds = this.checked;
                updateClock();
            });

            elements.showFinishToggle.addEventListener('change', function() {
                settings.showFinishTime = this.checked;
                updateFinishTimeDisplay();
            });

            elements.emojiToggle.addEventListener('change', function() {
                settings.enableEmojis = this.checked;
            });

            elements.soundToggle.addEventListener('change', function() {
                settings.enableSound = this.checked;
            });

            elements.volumeSlider.addEventListener('input', function() {
                settings.volume = parseInt(this.value);
            });

            // Teacher message
            elements.teacherMessage.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    this.blur();
                }
            });

            // Resize handler
            window.addEventListener('resize', handleResize);

            // Cleanup on page unload
            window.addEventListener('beforeunload', () => {
                if (state.audioContext) {
                    state.audioContext.close();
                }
            });

            // Handle visibility change for accurate timing
            document.addEventListener('visibilitychange', () => {
                if (!document.hidden && state.timerState === TimerState.RUNNING) {
                    // Tab became visible - immediately update display
                    const remaining = getRemainingMs();
                    if (remaining <= 0) {
                        completeTimer();
                    } else {
                        updateCountdownDisplay();
                    }
                }
            });
        }

        // ===========================================
        // INITIALIZATION
        // ===========================================
        function init() {
            loadSettingsToUI();
            initEventListeners();
            
            // Initial layout setup
            setTimeout(handleResize, 10);
            
            // Sync to whole second for smooth updates
            const now = new Date();
            const msToNextSecond = 1000 - now.getMilliseconds();
            
            setTimeout(() => {
                // Start main loop at whole second boundary
                setInterval(mainLoop, 1000);
                mainLoop();
            }, msToNextSecond);
            
            // Immediate initial update
            mainLoop();
            updateUI();
            
            // Check if first run and show welcome dialog
            checkFirstRun();
        }

        // Start the app
        init();
    </script>
</body>
</html>