<!DOCTYPE html>
<html lang="en" data-version="1.0.0">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="description" content="Sololow — Pick the lowest number that nobody else picks. A real-time classroom game.">
  <title>Sololow</title>
  <style>
    /* ─── Reset ─────────────────────────────────────────────────────── */
    *, *::before, *::after {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }

    /* ─── CSS Custom Properties ─────────────────────────────────────── */
    :root {
      /* Colors */
      --color-bg: #f4f6f9;
      --color-surface: #ffffff;
      --color-text: #1a1a2e;
      --color-text-secondary: #555770;
      --color-accent: #2563eb;
      --color-accent-hover: #1d4ed8;
      --color-on-accent: #ffffff;
      --color-success: #16a34a;
      --color-success-bg: #dcfce7;
      --color-danger: #dc2626;
      --color-danger-bg: #fee2e2;
      --color-warning: #d97706;
      --color-warning-bg: #fef3c7;
      --color-border: #e2e8f0;
      --color-muted: #94a3b8;
      --color-gold: #f59e0b;
      --color-silver: #9ca3af;
      --color-bronze: #b45309;
      --color-confirm: #27ae60;
      --color-sending: #f39c12;
      --color-badge-guessing-bg: #dbeafe;
      --color-badge-guessing-text: #1e40af;
      --color-badge-reveal-bg: #fef3c7;
      --color-badge-reveal-text: #92400e;
      --color-highlight-row: #eff6ff;
      --color-winner-bg-start: #fef3c7;
      --color-winner-bg-end: #fde68a;
      --color-winner-text: #92400e;

      /* Spacing */
      --space-1: 4px;
      --space-2: 8px;
      --space-3: 12px;
      --space-4: 16px;
      --space-5: 24px;
      --space-6: 32px;
      --space-7: 48px;
      --space-8: 64px;

      /* Typography */
      --font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      --font-size-xs: clamp(0.7rem, 1.5vw, 0.75rem);
      --font-size-sm: clamp(0.8rem, 2vw, 0.875rem);
      --font-size-base: clamp(0.9rem, 2.2vw, 1rem);
      --font-size-lg: clamp(1.1rem, 2.5vw, 1.25rem);
      --font-size-xl: clamp(1.3rem, 3vw, 1.5rem);
      --font-size-2xl: clamp(1.6rem, 4vw, 2rem);
      --font-size-3xl: clamp(2rem, 5vw, 2.5rem);
      --font-size-timer: clamp(2.5rem, 6vw, 5rem);

      /* Borders */
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 16px;

      /* Shadows */
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.08);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.1);

      /* Transitions */
      --transition-fast: 0.15s ease;
      --transition-base: 0.25s ease;
    }

    /* ─── Dark Mode ───────────────────────────────────────────────── */
    html[data-theme="dark"] {
      --color-bg: #121220;
      --color-surface: #1e1e32;
      --color-text: #e4e4f0;
      --color-text-secondary: #a0a0b8;
      --color-accent: #3b82f6;
      --color-accent-hover: #2563eb;
      --color-on-accent: #ffffff;
      --color-success: #22c55e;
      --color-success-bg: #14532d;
      --color-danger: #ef4444;
      --color-danger-bg: #450a0a;
      --color-warning: #f59e0b;
      --color-warning-bg: #451a03;
      --color-border: #2e2e48;
      --color-muted: #6b6b88;
      --color-gold: #facc15;
      --color-silver: #c0c8d4;
      --color-bronze: #d4923a;
      --color-confirm: #2ecc71;
      --color-sending: #f5b041;
      --color-badge-guessing-bg: #1e3a5f;
      --color-badge-guessing-text: #93c5fd;
      --color-badge-reveal-bg: #451a03;
      --color-badge-reveal-text: #fde68a;
      --color-highlight-row: #252540;
      --color-winner-bg-start: #2a2340;
      --color-winner-bg-end: #352e48;
      --color-winner-text: #fde68a;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.3);
      --shadow-md: 0 4px 12px rgba(0,0,0,0.4);
    }

    /* ─── Header Icon Buttons ─────────────────────────────────────── */
    .header-icon-btn {
      background: none;
      border: 1px solid var(--color-border);
      border-radius: var(--radius-sm);
      color: var(--color-text-secondary);
      width: 32px;
      height: 32px;
      font-size: 1rem;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      touch-action: manipulation;
      transition: background var(--transition-fast), color var(--transition-fast);
    }
    .header-icon-btn:hover {
      background: var(--color-border);
      color: var(--color-text);
    }
    .header-actions {
      display: flex;
      gap: var(--space-2);
      align-items: center;
    }

    /* ─── Base ──────────────────────────────────────────────────────── */
    html {
      font-family: var(--font-family);
      font-size: var(--font-size-base);
      color: var(--color-text);
      background: var(--color-bg);
      -webkit-text-size-adjust: 100%;
    }

    body {
      min-height: 100dvh;
      display: flex;
      flex-direction: column;
      overflow-x: hidden;
    }

    a:focus-visible,
    button:focus-visible,
    input:focus-visible,
    [tabindex]:focus-visible {
      outline: 2px solid var(--color-accent);
      outline-offset: 2px;
    }

    /* ─── Skip Link ────────────────────────────────────────────────── */
    .skip-link {
      position: absolute;
      top: -100%;
      left: var(--space-4);
      background: var(--color-accent);
      color: var(--color-on-accent);
      padding: var(--space-2) var(--space-4);
      border-radius: var(--radius-sm);
      z-index: 1000;
      font-size: var(--font-size-sm);
      text-decoration: none;
    }
    .skip-link:focus {
      top: var(--space-2);
    }

    /* ─── Header ───────────────────────────────────────────────────── */
    .app-header {
      background: var(--color-surface);
      border-bottom: 1px solid var(--color-border);
      padding: var(--space-3) var(--space-4);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: var(--space-2);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .app-title {
      font-size: var(--font-size-lg);
      font-weight: 700;
      white-space: nowrap;
    }

    .header-info {
      display: flex;
      align-items: center;
      gap: var(--space-4);
      flex-wrap: wrap;
    }

    .phase-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--space-1);
      padding: var(--space-1) var(--space-3);
      border-radius: 100px;
      font-size: var(--font-size-sm);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .phase-badge--idle {
      background: var(--color-border);
      color: var(--color-text-secondary);
    }
    .phase-badge--guessing {
      background: var(--color-badge-guessing-bg);
      color: var(--color-badge-guessing-text);
    }
    .phase-badge--reveal {
      background: var(--color-badge-reveal-bg);
      color: var(--color-badge-reveal-text);
    }

    .round-info {
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
    }

    .timer-display {
      font-size: var(--font-size-2xl);
      font-weight: 700;
      font-variant-numeric: tabular-nums;
      min-width: 4ch;
      text-align: center;
    }

    .timer-bar-wrap {
      width: 100%;
      height: 8px;
      background: var(--color-border);
      border-radius: 4px;
      overflow: hidden;
      margin-top: var(--space-1);
    }
    .timer-bar {
      height: 100%;
      border-radius: 4px;
      transition: width 1s linear;
      background: var(--color-accent);
    }
    .timer-bar.low {
      background: var(--color-warning);
    }
    .timer-bar.critical {
      background: var(--color-danger);
      animation: pulse-bar 0.5s ease-in-out infinite alternate;
    }
    @keyframes pulse-bar {
      from { opacity: 1; }
      to { opacity: 0.6; }
    }

    .connection-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      margin-right: var(--space-1);
    }
    .connection-dot--online { background: var(--color-success); }
    .connection-dot--offline { background: var(--color-danger); }
    .connection-dot--local { background: var(--color-muted); }

    /* ─── Tab Navigation ───────────────────────────────────────────── */
    .tab-nav {
      background: var(--color-surface);
      border-bottom: 1px solid var(--color-border);
      display: flex;
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      scrollbar-width: none;
    }
    .tab-nav::-webkit-scrollbar { display: none; }

    .tab-btn {
      flex: 1;
      min-width: 0;
      padding: var(--space-3) var(--space-2);
      border: none;
      background: none;
      color: var(--color-text-secondary);
      font-size: var(--font-size-sm);
      font-weight: 500;
      cursor: pointer;
      white-space: nowrap;
      border-bottom: 3px solid transparent;
      transition: color var(--transition-fast), border-color var(--transition-fast);
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
    }
    .tab-btn:hover {
      color: var(--color-text);
    }
    .tab-btn[aria-selected="true"] {
      color: var(--color-accent);
      border-bottom-color: var(--color-accent);
      font-weight: 600;
    }

    /* ─── Tab Panels ───────────────────────────────────────────────── */
    .tab-panels {
      flex: 1;
      position: relative;
    }

    .tab-panel {
      display: none;
      padding: var(--space-4);
      max-width: 900px;
      margin: 0 auto;
      width: 100%;
    }
    .tab-panel[aria-hidden="false"] {
      display: block;
    }

    /* ─── Pick Tab ─────────────────────────────────────────────────── */
    .player-name-section {
      margin-bottom: var(--space-5);
    }

    .name-label {
      display: block;
      font-size: var(--font-size-sm);
      font-weight: 600;
      margin-bottom: var(--space-2);
      color: var(--color-text-secondary);
    }

    .name-input-row {
      display: flex;
      gap: var(--space-2);
    }

    .name-input {
      flex: 1;
      padding: var(--space-3);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-sm);
      font-size: var(--font-size-base);
      font-family: inherit;
      background: var(--color-surface);
      color: var(--color-text);
      transition: border-color var(--transition-fast);
      max-width: 300px;
    }
    .name-input:focus {
      border-color: var(--color-accent);
      outline: none;
    }
    .name-input::placeholder {
      color: var(--color-muted);
    }

    .your-pick-display {
      text-align: center;
      padding: var(--space-4);
      margin-bottom: var(--space-4);
      background: var(--color-surface);
      border-radius: var(--radius-md);
      box-shadow: var(--shadow-sm);
    }
    .your-pick-label {
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
      margin-bottom: var(--space-1);
    }
    .your-pick-number {
      font-size: var(--font-size-3xl);
      font-weight: 700;
      color: var(--color-accent);
    }
    .your-pick-none {
      font-size: var(--font-size-lg);
      color: var(--color-muted);
    }

    .number-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(48px, 1fr));
      gap: var(--space-2);
      margin-bottom: var(--space-4);
    }

    .number-btn {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid var(--color-border);
      border-radius: var(--radius-sm);
      background: var(--color-surface);
      color: var(--color-text);
      font-size: var(--font-size-lg);
      font-weight: 600;
      cursor: pointer;
      transition: background var(--transition-fast), border-color var(--transition-fast), transform var(--transition-fast);
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      min-height: 48px;
      min-width: 48px;
    }
    .number-btn:hover:not(:disabled):not([aria-pressed="true"]) {
      border-color: var(--color-accent);
      background: var(--color-bg);
    }
    .number-btn:active:not(:disabled) {
      transform: scale(0.95);
    }
    .number-btn[aria-pressed="true"] {
      background: var(--color-accent);
      color: var(--color-on-accent);
      border-color: var(--color-accent);
    }
    .number-btn:disabled {
      opacity: 0.4;
      cursor: not-allowed;
      background: var(--color-bg);
    }

    .pick-status-msg {
      text-align: center;
      padding: var(--space-4);
      font-size: var(--font-size-base);
      color: var(--color-text-secondary);
      background: var(--color-surface);
      border-radius: var(--radius-md);
      border: 1px dashed var(--color-border);
    }
    .pick-confirm-status {
      text-align: center;
      padding: 4px 0;
      font-size: 0.85rem;
      font-weight: 600;
      transition: opacity 0.2s;
    }
    .pick-confirm-status.confirmed {
      color: var(--color-confirm);
    }
    .pick-confirm-status.sending {
      color: var(--color-sending);
    }
    .pick-confirm-status.reverted {
      color: var(--color-danger);
    }

    /* ─── Shuffle Mini-Game Widget ────────────────────────────────── */
    .shuffle-widget {
      margin-bottom: var(--space-4);
      border-radius: var(--radius-md);
      background: var(--color-surface);
      box-shadow: var(--shadow-sm);
      overflow: hidden;
      transition: opacity var(--transition-base), filter var(--transition-base);
    }
    .shuffle-widget--disabled {
      opacity: 0.35;
      filter: grayscale(1);
      pointer-events: none;
    }
    .shuffle-widget-toggle {
      display: flex;
      align-items: center;
      justify-content: space-between;
      width: 100%;
      padding: var(--space-3) var(--space-4);
      background: none;
      border: none;
      cursor: pointer;
      font-family: inherit;
      font-size: var(--font-size-sm);
      font-weight: 600;
      color: var(--color-text);
      touch-action: manipulation;
      transition: background var(--transition-fast);
    }
    .shuffle-widget-toggle:hover {
      background: var(--color-bg);
    }
    .shuffle-toggle-left {
      display: flex;
      align-items: center;
      gap: var(--space-2);
    }
    .shuffle-toggle-chevron {
      font-size: 10px;
      color: var(--color-muted);
      transition: transform var(--transition-fast);
    }
    .shuffle-widget--expanded .shuffle-toggle-chevron {
      transform: rotate(90deg);
    }
    .shuffle-score-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      min-width: 28px;
      padding: 2px var(--space-2);
      background: var(--color-accent);
      color: var(--color-on-accent);
      font-size: var(--font-size-xs);
      font-weight: 700;
      border-radius: 99px;
      font-variant-numeric: tabular-nums;
    }
    .shuffle-body {
      padding: 0 var(--space-4) var(--space-4);
    }
    .shuffle-stats-row {
      display: flex;
      justify-content: center;
      gap: var(--space-4);
      font-size: var(--font-size-xs);
      color: var(--color-text-secondary);
      margin-bottom: var(--space-3);
    }
    .shuffle-stats-row strong {
      color: var(--color-text);
    }
    .shuffle-combo {
      color: var(--color-gold);
      font-weight: 700;
      animation: shufflePulse 0.7s infinite;
    }
    @keyframes shufflePulse {
      0%, 100% { opacity: 0.6; }
      50% { opacity: 1; }
    }
    .shuffle-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 4px;
      max-width: 200px;
      margin: 0 auto var(--space-3);
    }
    .shuffle-tile {
      aspect-ratio: 1;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 2px solid var(--color-border);
      border-radius: var(--radius-sm);
      background: var(--color-surface);
      color: var(--color-text);
      font-size: var(--font-size-lg);
      font-weight: 800;
      font-family: 'Courier New', monospace;
      cursor: pointer;
      transition: all 0.12s ease;
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      min-height: 44px;
      min-width: 44px;
      outline: none;
    }
    .shuffle-tile:hover:not(.shuffle-tile--highlight) {
      border-color: var(--color-accent);
      background: var(--color-bg);
    }
    .shuffle-tile--selected {
      border-color: var(--color-gold);
      background: rgba(245, 158, 11, 0.1);
      color: var(--color-gold);
      animation: shuffleBounce 0.6s ease-in-out infinite;
    }
    .shuffle-tile--adjacent {
      border-color: rgba(245, 158, 11, 0.25);
    }
    .shuffle-tile--highlight {
      background: linear-gradient(135deg, var(--color-gold), #FFA500);
      color: #0a0a1a;
      border-color: var(--color-gold);
      animation: shuffleTileGlow 0.5s ease-in-out 3;
    }
    @keyframes shuffleBounce {
      0%, 100% { transform: scale(1.04); }
      50% { transform: scale(1.1); }
    }
    @keyframes shuffleTileGlow {
      0% { box-shadow: 0 0 3px rgba(245, 158, 11, 0.3); }
      50% { box-shadow: 0 0 18px rgba(245, 158, 11, 0.8), 0 0 36px rgba(245, 158, 11, 0.2); }
      100% { box-shadow: 0 0 3px rgba(245, 158, 11, 0.3); }
    }
    .shuffle-word-flash {
      text-align: center;
      min-height: 28px;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .shuffle-word-flash-text {
      font-size: var(--font-size-base);
      font-weight: 800;
      color: var(--color-gold);
      letter-spacing: 3px;
      text-transform: uppercase;
      animation: shuffleWordPop 1.3s ease-out forwards;
    }
    @keyframes shuffleWordPop {
      0% { transform: scale(0.7); opacity: 0; }
      15% { transform: scale(1.2); opacity: 1; }
      55% { transform: scale(1); opacity: 1; }
      100% { transform: scale(1.05); opacity: 0; }
    }
    .shuffle-word-flash-hint {
      font-size: var(--font-size-xs);
      color: var(--color-muted);
      letter-spacing: 1px;
    }
    .shuffle-found-words {
      display: flex;
      gap: 4px;
      flex-wrap: wrap;
      justify-content: center;
      max-width: 220px;
      margin: 0 auto var(--space-3);
      min-height: 20px;
    }
    .shuffle-found-tag {
      font-size: 10px;
      color: var(--color-text-secondary);
      padding: 1px 6px;
      background: var(--color-bg);
      border-radius: 4px;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      border: 1px solid var(--color-border);
    }
    .shuffle-new-btn {
      display: block;
      margin: 0 auto;
      padding: var(--space-2) var(--space-5);
      font-size: var(--font-size-xs);
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--color-text-secondary);
      background: var(--color-bg);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-sm);
      cursor: pointer;
      font-family: inherit;
      transition: all var(--transition-fast);
      touch-action: manipulation;
    }
    .shuffle-new-btn:hover {
      color: var(--color-gold);
      border-color: var(--color-gold);
      background: rgba(245, 158, 11, 0.05);
    }
    .shuffle-points-float {
      position: absolute;
      font-size: var(--font-size-sm);
      font-weight: 800;
      color: var(--color-gold);
      animation: shuffleFloatUp 1.2s ease-out forwards;
      pointer-events: none;
    }
    @keyframes shuffleFloatUp {
      0% { transform: translateY(0); opacity: 1; }
      100% { transform: translateY(-40px); opacity: 0; }
    }

    /* ─── Results Tab ──────────────────────────────────────────────── */
    .results-container {}

    .results-guessing-msg {
      text-align: center;
      padding: var(--space-6);
      color: var(--color-text-secondary);
    }
    .results-guessing-msg .guess-count-big {
      font-size: var(--font-size-3xl);
      font-weight: 700;
      color: var(--color-accent);
      display: block;
      margin-bottom: var(--space-2);
    }

    .winner-banner {
      text-align: center;
      padding: var(--space-5);
      margin-bottom: var(--space-5);
      background: linear-gradient(135deg, var(--color-winner-bg-start) 0%, var(--color-winner-bg-end) 100%);
      border-radius: var(--radius-lg);
      border: 2px solid var(--color-gold);
    }
    .winner-banner--no-winner {
      background: var(--color-bg);
      border-color: var(--color-border);
    }
    .winner-label {
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: var(--space-1);
    }
    .winner-name {
      font-size: var(--font-size-2xl);
      font-weight: 700;
      color: var(--color-text);
    }
    .winner-number {
      font-size: var(--font-size-timer);
      font-weight: 800;
      color: var(--color-gold);
      line-height: 1.1;
    }
    .winner-points {
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
      margin-top: var(--space-2);
    }

    .number-slots {
      display: flex;
      flex-wrap: wrap;
      gap: var(--space-2);
      margin-bottom: var(--space-5);
      justify-content: center;
    }

    .number-slot {
      display: flex;
      flex-direction: column;
      align-items: center;
      min-width: 44px;
      flex: 0 0 auto;
    }
    .slot-number {
      width: 44px;
      height: 44px;
      display: flex;
      align-items: center;
      justify-content: center;
      border-radius: var(--radius-sm);
      font-weight: 700;
      font-size: var(--font-size-base);
      border: 2px solid var(--color-border);
      background: var(--color-surface);
      color: var(--color-muted);
      position: relative;
    }
    .slot-number--unpicked {
      opacity: 0.4;
    }
    .slot-number--unique {
      background: var(--color-success-bg);
      border-color: var(--color-success);
      color: var(--color-success);
    }
    .slot-number--duplicate {
      background: var(--color-danger-bg);
      border-color: var(--color-danger);
      color: var(--color-danger);
    }
    .slot-number--winner {
      background: var(--color-winner-bg-start);
      border-color: var(--color-gold);
      color: var(--color-winner-text);
      box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.3);
    }
    .slot-icon {
      position: absolute;
      top: -6px;
      right: -6px;
      width: 16px;
      height: 16px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 10px;
      line-height: 1;
      color: var(--color-on-accent);
    }
    .slot-icon--check {
      background: var(--color-success);
    }
    .slot-icon--x {
      background: var(--color-danger);
    }
    .slot-icon--star {
      background: var(--color-gold);
    }
    .slot-names {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-top: var(--space-1);
      gap: 1px;
      max-height: 80px;
      overflow-y: auto;
    }
    .slot-player-name {
      font-size: var(--font-size-xs);
      color: var(--color-text-secondary);
      white-space: nowrap;
      max-width: 60px;
      overflow: hidden;
      text-overflow: ellipsis;
    }
    .slot-player-name--struck {
      text-decoration: line-through;
      color: var(--color-danger);
    }
    .slot-player-name--winner {
      font-weight: 700;
      color: var(--color-gold);
    }

    .results-stats {
      display: flex;
      gap: var(--space-4);
      justify-content: center;
      flex-wrap: wrap;
    }
    .stat-card {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: var(--space-3) var(--space-4);
      text-align: center;
      min-width: 100px;
    }
    .stat-value {
      font-size: var(--font-size-xl);
      font-weight: 700;
      color: var(--color-text);
    }
    .stat-label {
      font-size: var(--font-size-xs);
      color: var(--color-text-secondary);
      margin-top: var(--space-1);
    }

    /* ─── Leaderboard Tab ──────────────────────────────────────────── */
    .leaderboard-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: var(--space-4);
      flex-wrap: wrap;
      gap: var(--space-3);
    }
    .leaderboard-title {
      font-size: var(--font-size-lg);
      font-weight: 700;
    }
    .score-toggle {
      display: flex;
      background: var(--color-bg);
      border-radius: var(--radius-sm);
      overflow: hidden;
      border: 1px solid var(--color-border);
    }
    .score-toggle-btn {
      padding: var(--space-2) var(--space-3);
      border: none;
      background: none;
      font-size: var(--font-size-sm);
      font-weight: 500;
      color: var(--color-text-secondary);
      cursor: pointer;
      transition: background var(--transition-fast), color var(--transition-fast);
      touch-action: manipulation;
    }
    .score-toggle-btn[aria-pressed="true"] {
      background: var(--color-accent);
      color: var(--color-on-accent);
    }
    .score-toggle-btn:hover:not([aria-pressed="true"]) {
      background: var(--color-border);
    }

    .leaderboard-table-wrap {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border-radius: var(--radius-md);
      border: 1px solid var(--color-border);
      background: var(--color-surface);
    }
    .leaderboard-table {
      width: 100%;
      border-collapse: collapse;
      font-size: var(--font-size-sm);
    }
    .leaderboard-table th {
      background: var(--color-bg);
      font-weight: 600;
      text-align: left;
      padding: var(--space-3) var(--space-3);
      border-bottom: 2px solid var(--color-border);
      white-space: nowrap;
      color: var(--color-text-secondary);
    }
    .leaderboard-table td {
      padding: var(--space-3);
      border-bottom: 1px solid var(--color-border);
      vertical-align: middle;
    }
    .leaderboard-table tr:last-child td {
      border-bottom: none;
    }
    .leaderboard-table tr[data-highlight="true"] {
      background: var(--color-highlight-row);
      color: var(--color-text);
      font-weight: 600;
    }
    .rank-cell {
      font-weight: 700;
      text-align: center;
      width: 48px;
    }
    .rank-1 { color: var(--color-gold); }
    .rank-2 { color: var(--color-silver); }
    .rank-3 { color: var(--color-bronze); }
    .rank-medal {
      display: inline-block;
      width: 24px;
      height: 24px;
      border-radius: 50%;
      line-height: 24px;
      text-align: center;
      font-size: 12px;
      font-weight: 700;
      color: var(--color-on-accent);
    }
    .rank-medal--1 { background: var(--color-gold); }
    .rank-medal--2 { background: var(--color-silver); }
    .rank-medal--3 { background: var(--color-bronze); }
    .player-name-cell {
      font-weight: 500;
      max-width: 150px;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }
    .score-cell {
      font-weight: 700;
      font-variant-numeric: tabular-nums;
    }
    .leaderboard-empty {
      text-align: center;
      padding: var(--space-6);
      color: var(--color-muted);
    }

    /* ─── History/Analytics Tab ─────────────────────────────────────── */
    .history-section {
      margin-bottom: var(--space-6);
    }
    .history-section-title {
      font-size: var(--font-size-lg);
      font-weight: 700;
      margin-bottom: var(--space-4);
    }

    .freq-chart-container {
      background: var(--color-surface);
      border: 1px solid var(--color-border);
      border-radius: var(--radius-md);
      padding: var(--space-4);
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }
    .freq-chart {
      display: flex;
      align-items: flex-end;
      gap: 2px;
      height: 160px;
      padding-bottom: var(--space-5);
      position: relative;
    }
    .freq-bar-col {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: flex-end;
      flex: 1;
      min-width: 20px;
      max-width: 36px;
      height: 100%;
    }
    .freq-bar {
      width: 100%;
      min-height: 2px;
      background: var(--color-accent);
      border-radius: 3px 3px 0 0;
      transition: height var(--transition-base);
    }
    .freq-bar-count {
      font-size: 9px;
      color: var(--color-text-secondary);
      margin-bottom: 2px;
      font-variant-numeric: tabular-nums;
    }
    .freq-bar-label {
      font-size: 9px;
      color: var(--color-text-secondary);
      margin-top: var(--space-1);
      font-variant-numeric: tabular-nums;
    }

    .history-stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
      gap: var(--space-3);
      margin-bottom: var(--space-5);
    }

    .rounds-table-wrap {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border-radius: var(--radius-md);
      border: 1px solid var(--color-border);
      background: var(--color-surface);
    }
    .rounds-table {
      width: 100%;
      border-collapse: collapse;
      font-size: var(--font-size-sm);
    }
    .rounds-table th {
      background: var(--color-bg);
      font-weight: 600;
      text-align: left;
      padding: var(--space-2) var(--space-3);
      border-bottom: 2px solid var(--color-border);
      white-space: nowrap;
      color: var(--color-text-secondary);
    }
    .rounds-table td {
      padding: var(--space-2) var(--space-3);
      border-bottom: 1px solid var(--color-border);
    }
    .rounds-table tr:last-child td {
      border-bottom: none;
    }

    /* ─── Admin Tab ────────────────────────────────────────────────── */
    .admin-section {
      margin-bottom: var(--space-6);
    }
    .admin-section-title {
      font-size: var(--font-size-lg);
      font-weight: 700;
      margin-bottom: var(--space-4);
    }

    .passphrase-gate {
      max-width: 360px;
      margin: 0 auto;
      text-align: center;
    }
    .passphrase-gate p {
      color: var(--color-text-secondary);
      margin-bottom: var(--space-4);
    }
    .passphrase-row {
      display: flex;
      gap: var(--space-2);
    }
    .passphrase-input {
      flex: 1;
      padding: var(--space-3);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-sm);
      font-size: var(--font-size-base);
      font-family: inherit;
      background: var(--color-surface);
      color: var(--color-text);
      transition: border-color var(--transition-fast);
    }
    .passphrase-input:focus {
      border-color: var(--color-accent);
      outline: none;
    }
    .passphrase-error {
      color: var(--color-danger);
      font-size: var(--font-size-sm);
      margin-top: var(--space-2);
      min-height: 1.4em;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: var(--space-2);
      padding: var(--space-2) var(--space-4);
      border: 2px solid transparent;
      border-radius: var(--radius-sm);
      font-size: var(--font-size-sm);
      font-weight: 600;
      font-family: inherit;
      cursor: pointer;
      transition: background var(--transition-fast), border-color var(--transition-fast), opacity var(--transition-fast);
      touch-action: manipulation;
      -webkit-tap-highlight-color: transparent;
      min-height: 44px;
    }
    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .btn--primary {
      background: var(--color-accent);
      color: var(--color-on-accent);
      border-color: var(--color-accent);
    }
    .btn--primary:hover:not(:disabled) {
      background: var(--color-accent-hover);
    }
    .btn--success {
      background: var(--color-success);
      color: var(--color-on-accent);
      border-color: var(--color-success);
    }
    .btn--warning {
      background: var(--color-warning);
      color: var(--color-on-accent);
      border-color: var(--color-warning);
    }
    .btn--danger {
      background: var(--color-danger);
      color: var(--color-on-accent);
      border-color: var(--color-danger);
    }
    .btn--sm {
      padding: var(--space-1) var(--space-3);
      font-size: var(--font-size-sm);
    }
    .btn--outline {
      background: transparent;
      color: var(--color-text);
      border-color: var(--color-border);
    }
    .btn--outline:hover:not(:disabled) {
      border-color: var(--color-accent);
      color: var(--color-accent);
    }

    .config-form {
      display: flex;
      flex-direction: column;
      gap: var(--space-4);
    }
    .config-field {
      display: flex;
      flex-direction: column;
      gap: var(--space-1);
    }
    .config-field label {
      font-size: var(--font-size-sm);
      font-weight: 600;
      color: var(--color-text-secondary);
    }
    .config-field input {
      padding: var(--space-2) var(--space-3);
      border: 2px solid var(--color-border);
      border-radius: var(--radius-sm);
      font-size: var(--font-size-base);
      font-family: inherit;
      background: var(--color-surface);
      color: var(--color-text);
      max-width: 200px;
      transition: border-color var(--transition-fast);
    }
    .config-field input:focus {
      border-color: var(--color-accent);
      outline: none;
    }
    .config-field-error {
      color: var(--color-danger);
      font-size: var(--font-size-xs);
      min-height: 1.2em;
    }

    .game-controls {
      display: flex;
      gap: var(--space-3);
      flex-wrap: wrap;
    }

    .danger-zone {
      border: 2px solid var(--color-danger);
      border-radius: var(--radius-md);
      padding: var(--space-4);
    }
    .danger-zone-title {
      color: var(--color-danger);
      font-weight: 700;
      margin-bottom: var(--space-3);
    }
    .danger-zone .btn {
      margin-right: var(--space-2);
      margin-bottom: var(--space-2);
    }

    .admin-status {
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
      padding: var(--space-3);
      background: var(--color-bg);
      border-radius: var(--radius-sm);
    }

    /* ─── Placeholder Tab Panels ───────────────────────────────────── */
    .placeholder-panel {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      min-height: 200px;
      color: var(--color-muted);
      gap: var(--space-3);
    }
    .placeholder-panel-icon {
      font-size: var(--font-size-3xl);
    }

    /* ─── Status Bar ───────────────────────────────────────────────── */
    .status-bar {
      background: var(--color-surface);
      border-top: 1px solid var(--color-border);
      padding: var(--space-2) var(--space-4);
      font-size: var(--font-size-xs);
      color: var(--color-text-secondary);
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-shrink: 0;
    }

    /* ─── Utilities ────────────────────────────────────────────────── */
    .sr-only {
      position: absolute;
      width: 1px;
      height: 1px;
      padding: 0;
      margin: -1px;
      overflow: hidden;
      clip: rect(0, 0, 0, 0);
      white-space: nowrap;
      border-width: 0;
    }

    /* ─── Onboarding ──────────────────────────────────────────────── */
    .onboarding-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.6);
      z-index: 1000;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: var(--space-4);
      animation: fade-in 0.3s ease;
    }
    @keyframes fade-in { from { opacity: 0; } to { opacity: 1; } }
    .onboarding-card {
      background: var(--color-surface);
      border-radius: var(--radius-lg);
      padding: var(--space-6);
      max-width: 380px;
      width: 100%;
      text-align: center;
      box-shadow: var(--shadow-md);
      animation: slide-up 0.3s ease;
    }
    @keyframes slide-up {
      from { transform: translateY(20px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }
    .onboarding-emoji { font-size: 3rem; margin-bottom: var(--space-3); }
    .onboarding-title {
      font-size: var(--font-size-xl);
      font-weight: 700;
      margin-bottom: var(--space-3);
    }
    .onboarding-steps {
      text-align: left;
      margin: var(--space-4) 0;
      padding: 0;
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: var(--space-3);
    }
    .onboarding-steps li {
      display: flex;
      align-items: flex-start;
      gap: var(--space-2);
      font-size: var(--font-size-base);
      line-height: 1.4;
    }
    .onboarding-steps .step-icon {
      flex-shrink: 0;
      font-size: 1.3rem;
      width: 28px;
      text-align: center;
    }
    .onboarding-tip {
      font-size: var(--font-size-sm);
      color: var(--color-text-secondary);
      font-style: italic;
      margin: var(--space-3) 0 var(--space-4);
    }
    .onboarding-btn {
      display: inline-block;
      padding: var(--space-3) var(--space-6);
      background: var(--color-accent);
      color: var(--color-on-accent);
      border: none;
      border-radius: var(--radius-md);
      font-size: var(--font-size-lg);
      font-weight: 600;
      cursor: pointer;
      touch-action: manipulation;
    }
    .onboarding-btn:active { transform: scale(0.97); }

    /* ─── Responsive ───────────────────────────────────────────────── */
    @media (min-width: 768px) {
      .number-grid {
        grid-template-columns: repeat(10, 1fr);
        max-width: 600px;
        margin-left: auto;
        margin-right: auto;
      }
    }

    @media (min-width: 1024px) {
      .tab-panel {
        padding: var(--space-6);
      }
    }
  </style>
</head>
<body>
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <!-- Onboarding / Help overlay -->
  <div class="onboarding-overlay" id="onboardingOverlay" style="display:none;">
    <div class="onboarding-card">
      <div class="onboarding-emoji">&#x1f914;</div>
      <div class="onboarding-title">Welcome to Sololow!</div>
      <ul class="onboarding-steps" id="onboardingRules">
        <li><span class="step-icon">&#x1f4dd;</span><span>Enter your name</span></li>
        <li><span class="step-icon">&#x1f522;</span><span>Pick a number &mdash; go low!</span></li>
        <li><span class="step-icon">&#x2b50;</span><span>Win by picking the <strong>lowest number that nobody else picked</strong></span></li>
      </ul>
      <div style="background:var(--color-bg); border-radius:var(--radius-sm); padding:var(--space-3); margin:var(--space-3) 0; text-align:left;">
        <div style="font-weight:600; margin-bottom:var(--space-1);">Scoring</div>
        <div style="font-size:var(--font-size-sm); color:var(--color-text-secondary); line-height:1.5;">
          Win with <strong>1</strong> = 10 pts &nbsp;&#x2022;&nbsp;
          <strong>2</strong> = 7 pts &nbsp;&#x2022;&nbsp;
          <strong>3</strong> = 6 pts &nbsp;&#x2022;&nbsp;
          <strong>5</strong> = 4 pts &nbsp;&#x2022;&nbsp;
          <strong>10+</strong> = 1 pt<br>
          <em>Lower is bolder &mdash; and worth more!</em>
        </div>
      </div>
      <div id="onboardingHints" style="display:none;">
        <div style="font-weight:600; margin-bottom:var(--space-2);">Strategies to try:</div>
        <ul class="onboarding-steps">
          <li><span class="step-icon">&#x1f525;</span><span><strong>Yolo 1</strong> &mdash; Go for 1. Huge points if it works. It usually doesn't.</span></li>
          <li><span class="step-icon">&#x1f3af;</span><span><strong>Sweet spot</strong> &mdash; Pick 3&ndash;5. Dodge the crowd, still score big.</span></li>
          <li><span class="step-icon">&#x1f50d;</span><span><strong>Read the room</strong> &mdash; Check History. If everyone goes low, go higher.</span></li>
          <li><span class="step-icon">&#x1f500;</span><span><strong>Chaos mode</strong> &mdash; Pick randomly. Can't be predicted, can't be countered.</span></li>
          <li><span class="step-icon">&#x1f47b;</span><span><strong>Shadow</strong> &mdash; Watch the leader. Figure out their pattern. Dodge it.</span></li>
        </ul>
      </div>
      <div class="onboarding-tip" id="onboardingTip">Think everyone will pick 1? Maybe try 2&hellip;</div>
      <div style="display:flex; gap:var(--space-3); justify-content:center; flex-wrap:wrap;">
        <button type="button" class="onboarding-btn" id="onboardingDismiss">Got it!</button>
        <button type="button" class="onboarding-btn" id="onboardingHintsBtn" style="background:var(--color-text-secondary);">Hints</button>
      </div>
    </div>
  </div>

  <header class="app-header">
    <h1 class="app-title">Sololow</h1>
    <div class="header-info">
      <span class="round-info" id="roundInfo">Round —</span>
      <span class="phase-badge phase-badge--idle" id="phaseBadge">Idle</span>
      <span class="timer-display" id="timerDisplay" aria-live="polite" aria-label="Time remaining">—</span>
    </div>
    <div class="header-actions">
      <button type="button" class="header-icon-btn" id="btnHelp" aria-label="How to play" title="How to play">?</button>
      <button type="button" class="header-icon-btn" id="btnTheme" aria-label="Toggle dark mode" title="Toggle dark mode">&#x1f319;</button>
    </div>
    <div class="timer-bar-wrap" id="timerBarWrap" style="display:none;">
      <div class="timer-bar" id="timerBar" style="width:100%"></div>
    </div>
  </header>

  <nav class="tab-nav" role="tablist" aria-label="Game sections">
    <button class="tab-btn" role="tab" id="tab-pick" aria-controls="panel-pick" aria-selected="true" tabindex="0">Pick</button>
    <button class="tab-btn" role="tab" id="tab-results" aria-controls="panel-results" aria-selected="false" tabindex="-1">Results</button>
    <button class="tab-btn" role="tab" id="tab-leaderboard" aria-controls="panel-leaderboard" aria-selected="false" tabindex="-1">Board</button>
    <button class="tab-btn" role="tab" id="tab-history" aria-controls="panel-history" aria-selected="false" tabindex="-1">History</button>
    <button class="tab-btn" role="tab" id="tab-admin" aria-controls="panel-admin" aria-selected="false" tabindex="-1">Admin</button>
  </nav>

  <main class="tab-panels" id="main-content">
    <!-- Pick Tab -->
    <section class="tab-panel" id="panel-pick" role="tabpanel" aria-labelledby="tab-pick" aria-hidden="false">
      <div class="player-name-section">
        <label for="playerNameInput" class="name-label">Your Name</label>
        <div class="name-input-row">
          <input type="text" id="playerNameInput" class="name-input" placeholder="Enter your name" maxlength="30" autocomplete="off">
        </div>
      </div>

      <div class="shuffle-widget shuffle-widget--disabled" id="shuffleWidget">
        <button type="button" class="shuffle-widget-toggle" id="shuffleToggle" aria-expanded="false">
          <span class="shuffle-toggle-left"><span class="shuffle-toggle-chevron" aria-hidden="true">&#x25B6;</span><span>&#x1f524; Shuffle</span></span>
          <span class="shuffle-score-badge" id="shuffleScoreBadge">0</span>
        </button>
        <div class="shuffle-body" id="shuffleBody" style="display:none;">
          <div class="shuffle-stats-row">
            <span>Words: <strong id="shuffleTotalWords">0</strong></span>
            <span id="shuffleComboWrap" style="display:none;" class="shuffle-combo">&#x2726; <span id="shuffleComboCount">0</span>x</span>
          </div>
          <div style="position:relative;">
            <div class="shuffle-grid" id="shuffleGrid"></div>
            <div id="shufflePointsFloat"></div>
          </div>
          <div class="shuffle-word-flash" id="shuffleWordFlash">
            <span class="shuffle-word-flash-hint">tap tiles to swap &middot; make words</span>
          </div>
          <div class="shuffle-found-words" id="shuffleFoundWords"></div>
          <button type="button" class="shuffle-new-btn" id="shuffleNewTiles">&#x21BB; new tiles</button>
        </div>
      </div>

      <div class="your-pick-display" id="yourPickDisplay">
        <div class="your-pick-label">Your Pick</div>
        <div class="your-pick-none" id="yourPickNumber">Tap a number</div>
        <div class="pick-confirm-status" id="pickConfirmStatus" aria-live="polite"></div>
      </div>

      <div id="pickStatusMsg" class="pick-status-msg" style="display:none;" aria-live="polite"></div>

      <div class="number-grid" id="numberGrid" role="group" aria-label="Number selection grid">
        <!-- Number buttons rendered by JS -->
      </div>
    </section>

    <!-- Results Tab -->
    <section class="tab-panel" id="panel-results" role="tabpanel" aria-labelledby="tab-results" aria-hidden="true">
      <div class="results-container" id="resultsContainer">
        <div id="resultsContent">
          <div class="placeholder-panel" id="resultsPlaceholder">
            <div class="placeholder-panel-icon" aria-hidden="true">&#x1f3af;</div>
            <p>Results will appear here after a round completes.</p>
          </div>
        </div>
      </div>
    </section>

    <!-- Leaderboard Tab -->
    <section class="tab-panel" id="panel-leaderboard" role="tabpanel" aria-labelledby="tab-leaderboard" aria-hidden="true">
      <div class="leaderboard-header">
        <h2 class="leaderboard-title" id="leaderboardTitle">Leaderboard</h2>
        <p style="font-size:var(--font-size-sm); color:var(--color-text-secondary); margin-top:2px;">Lower winning numbers score more points</p>
      </div>
      <div id="leaderboardBody">
        <div class="leaderboard-empty" id="leaderboardEmpty">
          <p>No scores yet. Play a round to see the leaderboard.</p>
        </div>
      </div>
    </section>

    <!-- History Tab -->
    <section class="tab-panel" id="panel-history" role="tabpanel" aria-labelledby="tab-history" aria-hidden="true">
      <div id="historyContent">
        <div class="placeholder-panel" id="historyPlaceholder">
          <div class="placeholder-panel-icon" aria-hidden="true">&#x1f4ca;</div>
          <p>History and analytics will appear here as rounds are played.</p>
        </div>
      </div>
    </section>

    <!-- Admin Tab -->
    <section class="tab-panel" id="panel-admin" role="tabpanel" aria-labelledby="tab-admin" aria-hidden="true">
      <div id="adminContent">
        <!-- Passphrase gate shown by default -->
        <div class="passphrase-gate" id="passphraseGate">
          <h2 class="admin-section-title">Admin Access</h2>
          <p>Enter the admin passphrase to access game controls.</p>
          <div class="passphrase-row">
            <label for="passphraseInput" class="sr-only">Passphrase</label>
            <input type="password" id="passphraseInput" class="passphrase-input" placeholder="Enter passphrase" autocomplete="off">
            <button type="button" class="btn btn--primary" id="passphraseSubmit">Enter</button>
          </div>
          <div class="passphrase-error" id="passphraseError" role="alert"></div>
        </div>

        <!-- Admin panel shown after auth -->
        <div id="adminPanel" style="display:none;">
          <!-- Game Controls -->
          <div class="admin-section">
            <h2 class="admin-section-title">Game Controls</h2>
            <div class="game-controls">
              <button type="button" class="btn btn--success" id="btnStartGame">Start Game</button>
              <button type="button" class="btn btn--warning" id="btnPauseGame">Pause</button>
              <button type="button" class="btn btn--outline" id="btnForceNext">Force Next Phase</button>
            </div>
          </div>

          <!-- Configuration -->
          <div class="admin-section">
            <h2 class="admin-section-title">Configuration</h2>
            <div class="config-form" id="configForm">
              <div class="config-field">
                <label for="cfgMaxNumber">Max Number (range 1-N)</label>
                <input type="number" id="cfgMaxNumber" min="5" max="200" value="50">
                <div class="config-field-error" id="cfgMaxNumberError"></div>
              </div>
              <div class="config-field">
                <label for="cfgGuessingDuration">Guessing Duration (seconds)</label>
                <input type="number" id="cfgGuessingDuration" min="10" max="600" value="120">
                <div class="config-field-error" id="cfgGuessingDurationError"></div>
              </div>
              <div class="config-field">
                <label for="cfgRevealDuration">Reveal Duration (seconds)</label>
                <input type="number" id="cfgRevealDuration" min="5" max="120" value="30">
                <div class="config-field-error" id="cfgRevealDurationError"></div>
              </div>
              <div class="config-field">
                <label for="cfgMinPlayers">Min Players for Valid Round</label>
                <input type="number" id="cfgMinPlayers" min="2" max="100" value="5">
                <div class="config-field-error" id="cfgMinPlayersError"></div>
              </div>
              <button type="button" class="btn btn--primary" id="btnSaveConfig">Save Config</button>
            </div>
          </div>

          <!-- Danger Zone -->
          <div class="admin-section">
            <div class="danger-zone">
              <div class="danger-zone-title">Danger Zone</div>
              <div style="display:flex; flex-direction:column; gap:var(--space-3);">
                <div style="display:flex; align-items:center; gap:var(--space-2); flex-wrap:wrap;">
                  <button type="button" class="btn btn--warning" id="btnClearScores">Clear All Scores</button>
                  <span id="clearScoresConfirm" style="display:none;">
                    <span style="font-size:0.85rem; color:var(--color-danger);">Zeros all scores &amp; round history. Are you sure?</span>
                    <button type="button" class="btn btn--danger btn--sm" id="btnClearScoresYes" style="margin-left:4px;">Yes, Clear</button>
                    <button type="button" class="btn btn--outline btn--sm" id="btnClearScoresNo" style="margin-left:4px;">Cancel</button>
                  </span>
                </div>
                <button type="button" class="btn btn--danger" id="btnResetGame">Reset Game</button>
              </div>
            </div>
          </div>

          <!-- Status -->
          <div class="admin-section">
            <div class="admin-status" id="adminStatus">
              Connection: checking...
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Live announcements for screen readers -->
    <div id="liveAnnounce" class="sr-only" aria-live="assertive" aria-atomic="true"></div>
  </main>

  <footer class="status-bar">
    <span id="connectionStatus">
      <span class="connection-dot connection-dot--local"></span>
      Connecting...
    </span>
    <span id="statusMessage"></span>
  </footer>

  <script>
    'use strict';
    (function() {

      // ─── Configuration ──────────────────────────────────────────────
      var API_URL = 'https://script.google.com/macros/s/AKfycbxMFLLRC-1rSr2u9my9t-zOyRtAiaiUi4cNqaZGWRaN0WMYGot37C07CJtO-sOJGf-6/exec';
      var POLL_INTERVAL_DEFAULT = 5000;
      var POLL_INTERVAL_IDLE = 15000;
      var POLL_INTERVAL_BACKGROUND = 20000;
      var GUESS_DEBOUNCE_MS = 1000;
      var MAX_NAME_LENGTH = 30;
      var SANITIZE_MAX_LENGTH = 200;
      var CONSECUTIVE_ERROR_THRESHOLD = 3;
      var TIMER_UPDATE_MS = 1000;
      var MAX_DISPLAY_NUMBERS = 50;
      var TOP_RANK_COUNT = 3;
      var API_HISTORY_LIMIT = 50;
      var FREQ_CHART_HEIGHT_PX = 120;
      var FREQ_CHART_MIN_BAR_PX = 4;
      var RECENT_ROUNDS_COUNT = 10;
      var COOKIE_EXPIRY_DAYS = 30;

      // ─── State Shape ────────────────────────────────────────────────
      /**
       * @typedef {Object} AppState
       * @property {string} currentPhase - 'idle' | 'guessing' | 'reveal'
       * @property {string} phaseStartTime - ISO timestamp of phase start
       * @property {number} currentRoundId - current round number
       * @property {number} guessCount - number of guesses submitted this round
       * @property {Object} config - game configuration
       * @property {number} config.maxNumber
       * @property {number} config.guessingDuration
       * @property {number} config.revealDuration
       * @property {number} config.minPlayers
       * @property {number} config.replayDurationRatio
       * @property {Object} player - local player info
       * @property {string} player.id
       * @property {string} player.name
       * @property {number|null} player.currentPick - number picked this round
       * @property {string} activeTab - current tab id
       * @property {string} connectionStatus - 'online' | 'offline' | 'local'
       * @property {Object|null} lastRoundResult - result of last completed round
       * @property {number} consecutiveErrors - count of consecutive API failures
       */
      var state = {
        currentPhase: 'idle',
        phaseStartTime: '',
        currentRoundId: 0,
        guessCount: 0,
        config: {
          maxNumber: 50,
          guessingDuration: 45,
          revealDuration: 30,
          gatheringDuration: 10,
          minPlayers: 5,
          replayDurationRatio: 0.67
        },
        player: {
          id: '',
          name: '',
          currentPick: null,
          confirmedPick: null,
          pickStatus: 'none' // 'none' | 'sending' | 'confirmed' | 'reverted'
        },
        activeTab: 'pick',
        connectionStatus: 'local',
        lastRoundResult: null,
        leaderboardScoreType: 'strategy',
        leaderboardData: null,
        leaderboardLastFetch: 0,
        historyData: null,
        historyLastFetch: 0,
        adminAuthenticated: false,
        adminPassphrase: '',
        resetConfirmPending: false,
        consecutiveErrors: 0
      };

      // ─── DOM References (cached) ────────────────────────────────────
      var els = {};

      function cacheElements() {
        els.roundInfo = document.getElementById('roundInfo');
        els.phaseBadge = document.getElementById('phaseBadge');
        els.timerDisplay = document.getElementById('timerDisplay');
        els.timerBarWrap = document.getElementById('timerBarWrap');
        els.timerBar = document.getElementById('timerBar');
        els.numberGrid = document.getElementById('numberGrid');
        els.playerNameInput = document.getElementById('playerNameInput');
        els.yourPickNumber = document.getElementById('yourPickNumber');
        els.yourPickDisplay = document.getElementById('yourPickDisplay');
        els.pickStatusMsg = document.getElementById('pickStatusMsg');
        els.pickConfirmStatus = document.getElementById('pickConfirmStatus');
        els.connectionStatus = document.getElementById('connectionStatus');
        els.statusMessage = document.getElementById('statusMessage');
        els.liveAnnounce = document.getElementById('liveAnnounce');
        els.resultsContent = document.getElementById('resultsContent');
        els.resultsPlaceholder = document.getElementById('resultsPlaceholder');
        els.leaderboardBody = document.getElementById('leaderboardBody');
        els.leaderboardEmpty = document.getElementById('leaderboardEmpty');
        els.historyContent = document.getElementById('historyContent');
        els.passphraseGate = document.getElementById('passphraseGate');
        els.passphraseInput = document.getElementById('passphraseInput');
        els.passphraseSubmit = document.getElementById('passphraseSubmit');
        els.passphraseError = document.getElementById('passphraseError');
        els.adminPanel = document.getElementById('adminPanel');
        els.adminStatus = document.getElementById('adminStatus');
        els.btnStartGame = document.getElementById('btnStartGame');
        els.btnPauseGame = document.getElementById('btnPauseGame');
        els.btnForceNext = document.getElementById('btnForceNext');
        els.btnSaveConfig = document.getElementById('btnSaveConfig');
        els.btnResetGame = document.getElementById('btnResetGame');
        els.btnClearScores = document.getElementById('btnClearScores');
        els.clearScoresConfirm = document.getElementById('clearScoresConfirm');
        els.btnClearScoresYes = document.getElementById('btnClearScoresYes');
        els.btnClearScoresNo = document.getElementById('btnClearScoresNo');
        els.cfgMaxNumber = document.getElementById('cfgMaxNumber');
        els.cfgGuessingDuration = document.getElementById('cfgGuessingDuration');
        els.cfgRevealDuration = document.getElementById('cfgRevealDuration');
        els.cfgMinPlayers = document.getElementById('cfgMinPlayers');
        els.tabBtns = Array.prototype.slice.call(document.querySelectorAll('[role="tab"]'));
        els.tabPanels = Array.prototype.slice.call(document.querySelectorAll('[role="tabpanel"]'));
        // Shuffle mini-game elements
        els.shuffleWidget = document.getElementById('shuffleWidget');
        els.shuffleToggle = document.getElementById('shuffleToggle');
        els.shuffleBody = document.getElementById('shuffleBody');
        els.shuffleGrid = document.getElementById('shuffleGrid');
        els.shuffleScoreBadge = document.getElementById('shuffleScoreBadge');
        els.shuffleTotalWords = document.getElementById('shuffleTotalWords');
        els.shuffleComboWrap = document.getElementById('shuffleComboWrap');
        els.shuffleComboCount = document.getElementById('shuffleComboCount');
        els.shuffleWordFlash = document.getElementById('shuffleWordFlash');
        els.shuffleFoundWords = document.getElementById('shuffleFoundWords');
        els.shuffleNewTiles = document.getElementById('shuffleNewTiles');
        els.shufflePointsFloat = document.getElementById('shufflePointsFloat');
      }

      // ─── Utility Functions ──────────────────────────────────────────

      function generateId() {
        if (typeof crypto !== 'undefined' && crypto.randomUUID) {
          return crypto.randomUUID();
        }
        return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
          var r = Math.random() * 16 | 0;
          var v = c === 'x' ? r : (r & 0x3 | 0x8);
          return v.toString(16);
        });
      }

      function sanitizeString(str) {
        if (typeof str !== 'string') return '';
        return str.replace(/[<>&"']/g, function(c) {
          var map = { '<': '&lt;', '>': '&gt;', '&': '&amp;', '"': '&quot;', "'": '&#x27;' };
          return map[c] || c;
        }).substring(0, SANITIZE_MAX_LENGTH);
      }

      /**
       * Lightweight device fingerprint to detect duplicate entries from the
       * same device under different player names (e.g. incognito windows).
       */
      function getDeviceFingerprint() {
        var components = [
          screen.width + 'x' + screen.height,
          screen.colorDepth,
          new Date().getTimezoneOffset(),
          navigator.language,
          navigator.hardwareConcurrency || 0,
          navigator.maxTouchPoints || 0,
          navigator.platform || ''
        ];
        var raw = components.join('|');
        var hash = 5381;
        for (var i = 0; i < raw.length; i++) {
          hash = ((hash << 5) + hash + raw.charCodeAt(i)) & 0xFFFFFFFF;
        }
        return hash.toString(36);
      }

      function clampInt(val, min, max) {
        var n = parseInt(val, 10);
        if (isNaN(n) || !isFinite(n)) return min;
        return Math.max(min, Math.min(max, n));
      }

      function formatTime(seconds) {
        if (seconds <= 0) return '0:00';
        var m = Math.floor(seconds / 60);
        var s = Math.floor(seconds % 60);
        return m + ':' + (s < 10 ? '0' : '') + s;
      }

      function announce(message) {
        if (els.liveAnnounce) {
          els.liveAnnounce.textContent = message;
        }
      }

      // ─── localStorage Helpers ───────────────────────────────────────

      var storage = {
        get: function(key) {
          try {
            return localStorage.getItem(key);
          } catch (e) {
            return null;
          }
        },
        set: function(key, value) {
          try {
            localStorage.setItem(key, value);
          } catch (e) {
            // Quota exceeded or storage disabled — silently fail
          }
        },
        getJSON: function(key) {
          try {
            var raw = localStorage.getItem(key);
            return raw ? JSON.parse(raw) : null;
          } catch (e) {
            return null;
          }
        },
        setJSON: function(key, value) {
          try {
            localStorage.setItem(key, JSON.stringify(value));
          } catch (e) {
            // Silently fail
          }
        }
      };

      // ─── Player Identity ────────────────────────────────────────────
      // Player ID is stored redundantly across localStorage, sessionStorage,
      // and a cookie. If a student clears one, the others restore it — preventing
      // them from re-entering the game under a different name.

      function setCookie(name, value, days) {
        var expires = '';
        if (days) {
          var d = new Date();
          d.setTime(d.getTime() + days * 24 * 60 * 60 * 1000);
          expires = '; expires=' + d.toUTCString();
        }
        try {
          document.cookie = name + '=' + encodeURIComponent(value) + expires + '; path=/; SameSite=Strict';
        } catch (e) {}
      }

      function getCookie(name) {
        try {
          var match = document.cookie.match(new RegExp('(?:^|; )' + name + '=([^;]*)'));
          return match ? decodeURIComponent(match[1]) : null;
        } catch (e) {
          return null;
        }
      }

      function loadPlayer() {
        var saved = storage.getJSON('lun_player');
        var cookieId = getCookie('lun_pid');
        var sessionId = null;
        try { sessionId = sessionStorage.getItem('lun_pid'); } catch (e) {}

        if (saved && typeof saved === 'object' && saved.id && saved.name) {
          state.player.id = String(saved.id);
          state.player.name = String(saved.name).substring(0, MAX_NAME_LENGTH);
        } else if (cookieId) {
          // localStorage was cleared but cookie survived — restore the same ID
          state.player.id = cookieId;
        } else if (sessionId) {
          // localStorage and cookie cleared but session survived
          state.player.id = sessionId;
        }

        if (!state.player.id) {
          state.player.id = generateId();
        }
        savePlayer();
      }

      function savePlayer() {
        storage.setJSON('lun_player', {
          id: state.player.id,
          name: state.player.name
        });
        // Redundant storage — survives clearing localStorage alone
        setCookie('lun_pid', state.player.id, COOKIE_EXPIRY_DAYS);
        try { sessionStorage.setItem('lun_pid', state.player.id); } catch (e) {}
      }

      // ─── API Layer ──────────────────────────────────────────────────

      function apiGet(action, params) {
        var url = API_URL + '?action=' + encodeURIComponent(action);
        if (params) {
          for (var k in params) {
            if (params.hasOwnProperty(k)) {
              url += '&' + encodeURIComponent(k) + '=' + encodeURIComponent(params[k]);
            }
          }
        }
        return fetch(url, { method: 'GET' })
          .then(function(resp) {
            if (!resp.ok) throw new Error('HTTP ' + resp.status);
            return resp.json();
          });
      }

      function apiPost(action, body) {
        // Send write actions as GET with JSON payload in URL parameter
        // to avoid Google Apps Script 302 redirect CORS issues with POST
        body = body || {};
        var payload = encodeURIComponent(JSON.stringify(body));
        var url = API_URL + '?action=' + encodeURIComponent(action) + '&payload=' + payload;
        return fetch(url, { method: 'GET' })
          .then(function(resp) {
            if (!resp.ok) throw new Error('HTTP ' + resp.status);
            return resp.json();
          });
      }

      // ─── Polling ────────────────────────────────────────────────────

      var pollTimer = null;

      function getPollingInterval() {
        if (document.hidden) return POLL_INTERVAL_BACKGROUND;
        if (state.currentPhase === 'idle') return POLL_INTERVAL_IDLE;
        return POLL_INTERVAL_DEFAULT;
      }

      function startPolling() {
        stopPolling();
        pollGameState();
        schedulePoll();
      }

      function schedulePoll() {
        if (pollTimer) clearTimeout(pollTimer);
        pollTimer = setTimeout(function() {
          pollGameState();
          schedulePoll();
        }, getPollingInterval());
      }

      function stopPolling() {
        if (pollTimer) {
          clearTimeout(pollTimer);
          pollTimer = null;
        }
      }

      function pollGameState() {
        apiGet('getGameState')
          .then(function(data) {
            if (!data || !data.success) {
              handlePollError(new Error(data && data.error ? data.error : 'Unknown error'));
              return;
            }
            state.consecutiveErrors = 0;
            updateConnectionStatus('online');
            reconcileServerState(data);
          })
          .catch(function(err) {
            handlePollError(err);
          });
      }

      function handlePollError(err) {
        state.consecutiveErrors++;
        if (state.consecutiveErrors >= CONSECUTIVE_ERROR_THRESHOLD) {
          updateConnectionStatus('offline');
        }
      }

      function reconcileServerState(serverData) {
        var prevPhase = state.currentPhase;
        var prevRound = state.currentRoundId;

        state.currentPhase = serverData.currentPhase || 'idle';
        state.phaseStartTime = serverData.phaseStartTime || '';
        state.currentRoundId = parseInt(serverData.currentRoundId, 10) || 0;
        state.guessCount = parseInt(serverData.guessCount, 10) || 0;

        if (serverData.config) {
          state.config.maxNumber = parseInt(serverData.config.maxNumber, 10) || 50;
          state.config.guessingDuration = parseInt(serverData.config.guessingDuration, 10) || 45;
          state.config.revealDuration = parseInt(serverData.config.revealDuration, 10) || 30;
          state.config.gatheringDuration = parseInt(serverData.config.gatheringDuration, 10) || state.config.gatheringDuration;
          state.config.minPlayers = parseInt(serverData.config.minPlayers, 10) || 5;
          state.config.replayDurationRatio = parseFloat(serverData.config.replayDurationRatio) || 0.67;
        }

        // Update last round result if available
        if (serverData.lastRoundResult) {
          state.lastRoundResult = serverData.lastRoundResult;
        }

        // Detect phase transitions
        if (prevPhase !== state.currentPhase || prevRound !== state.currentRoundId) {
          onPhaseChange(prevPhase, state.currentPhase, prevRound, state.currentRoundId);
        }

        renderHeader();
        renderPickTabState();

        // Update results tab if visible or on phase change
        if (state.activeTab === 'results') {
          renderResultsTab();
        }
      }

      function onPhaseChange(prevPhase, newPhase, prevRound, newRound) {
        if (newPhase === 'guessing' && newRound !== prevRound) {
          // New round started — reset pick state
          state.player.currentPick = null;
          state.player.confirmedPick = null;
          state.player.pickStatus = 'none';
          renderPickConfirmStatus();
          announce('Round ' + newRound + ' \u2014 guessing phase started. Pick a number!');
          renderNumberGrid();
          // Force switch to Pick tab so players are ready to guess
          switchTab('pick');
          // Pre-fetch leaderboard & history so tabs have content ready
          state.leaderboardLastFetch = 0;
          state.historyLastFetch = 0;
          fetchAndRenderLeaderboard();
          fetchAndRenderHistory();
        } else if (newPhase === 'gathering') {
          // Lock in: show what was confirmed
          if (state.player.confirmedPick) {
            announce('Time\u2019s up! Your pick of ' + state.player.confirmedPick + ' is locked in.');
          } else {
            announce('Time\u2019s up! You did not submit a guess in time.');
          }
        } else if (newPhase === 'reveal') {
          announce('Revealing results...');
          // Invalidate leaderboard cache so it refreshes after results
          state.leaderboardLastFetch = 0;
          // Force switch to results tab so everyone sees the reveal
          switchTab('results');
        } else if (newPhase === 'idle') {
          announce('Game paused.');
        }

        // Rebuild the grid if maxNumber may have changed
        if (newPhase === 'guessing') {
          renderNumberGrid();
        }

        // Update results tab on every phase change
        renderResultsTab();

        // Reschedule polling with potentially new interval
        schedulePoll();
      }

      // ─── Connection Status ──────────────────────────────────────────

      function updateConnectionStatus(status) {
        if (state.connectionStatus === status) return;
        state.connectionStatus = status;
        renderConnectionStatus();
      }

      function renderConnectionStatus() {
        var dot = els.connectionStatus.querySelector('.connection-dot');
        var label;
        dot.className = 'connection-dot';

        switch (state.connectionStatus) {
          case 'online':
            dot.classList.add('connection-dot--online');
            label = 'Connected';
            break;
          case 'offline':
            dot.classList.add('connection-dot--offline');
            label = 'Offline';
            break;
          default:
            dot.classList.add('connection-dot--local');
            label = 'Connecting...';
        }
        els.connectionStatus.lastChild.textContent = label;
      }

      // ─── Timer ──────────────────────────────────────────────────────

      var timerInterval = null;

      function startTimer() {
        stopTimer();
        renderTimer();
        timerInterval = setInterval(renderTimer, TIMER_UPDATE_MS);
      }

      function stopTimer() {
        if (timerInterval) {
          clearInterval(timerInterval);
          timerInterval = null;
        }
      }

      var TIMER_GRACE_SEC = 5; // bar finishes this many seconds AFTER the real deadline

      function getPhaseDuration() {
        if (state.currentPhase === 'guessing') return state.config.guessingDuration;
        if (state.currentPhase === 'gathering') return state.config.gatheringDuration;
        if (state.currentPhase === 'reveal') return state.config.revealDuration;
        return 0;
      }

      function getTimeRemaining() {
        if (!state.phaseStartTime || state.currentPhase === 'idle') return -1;

        var startMs = new Date(state.phaseStartTime).getTime();
        var nowMs = Date.now();
        var durationSec = getPhaseDuration();

        return durationSec - (nowMs - startMs) / 1000;
      }

      var phaseAdvanceRequested = false;

      function renderTimer() {
        var remaining = getTimeRemaining();
        if (state.currentPhase === 'idle' || !state.phaseStartTime) {
          els.timerDisplay.textContent = '\u2014';
          els.timerBarWrap.style.display = 'none';
          return;
        }
        // Text shows 0:00 floor, but remaining can go negative for the bar
        els.timerDisplay.textContent = formatTime(Math.max(0, remaining));

        // Progress bar drains slower than real time — bar still has juice
        // when the real deadline hits (under-promise, over-deliver).
        // remaining goes negative after deadline, bar keeps draining through grace period.
        var totalDuration = getPhaseDuration();
        els.timerBarWrap.style.display = '';
        if (totalDuration > 0) {
          var visibleDuration = totalDuration + TIMER_GRACE_SEC;
          var pct = Math.max(0, Math.min(100, (remaining + TIMER_GRACE_SEC) / visibleDuration * 100));
          els.timerBar.style.width = pct + '%';

          // Color coding based on real remaining time
          els.timerBar.className = 'timer-bar';
          if (remaining <= 0) {
            els.timerBar.classList.add('critical');
          } else if (remaining / totalDuration < 0.2) {
            els.timerBar.classList.add('low');
          }
        }

        // Auto-advance: when real timer hits 0, ask server to check and advance phase
        if (remaining <= 0 && !phaseAdvanceRequested && state.currentPhase !== 'idle') {
          phaseAdvanceRequested = true;
          apiGet('checkPhaseExpiry')
            .then(function(data) {
              phaseAdvanceRequested = false;
              if (data && data.success) {
                reconcileServerState(data);
              }
            })
            .catch(function() {
              phaseAdvanceRequested = false;
            });
        }

        // Reset the flag when a new phase starts (remaining > 0 again)
        if (remaining > 0) {
          phaseAdvanceRequested = false;
        }
      }

      // ─── Render: Header ─────────────────────────────────────────────

      function renderHeader() {
        // Round info
        if (state.currentRoundId > 0) {
          els.roundInfo.textContent = 'Round ' + state.currentRoundId;
        } else {
          els.roundInfo.textContent = 'Round \u2014';
        }

        // Phase badge
        els.phaseBadge.className = 'phase-badge';
        switch (state.currentPhase) {
          case 'guessing':
            els.phaseBadge.classList.add('phase-badge--guessing');
            els.phaseBadge.textContent = 'Guessing';
            break;
          case 'gathering':
            els.phaseBadge.classList.add('phase-badge--reveal');
            els.phaseBadge.textContent = 'Gathering...';
            break;
          case 'reveal':
            els.phaseBadge.classList.add('phase-badge--reveal');
            els.phaseBadge.textContent = 'Reveal';
            break;
          default:
            els.phaseBadge.classList.add('phase-badge--idle');
            els.phaseBadge.textContent = 'Idle';
        }

        // Timer
        renderTimer();
      }

      // ─── Render: Pick Tab ───────────────────────────────────────────

      function renderNumberGrid() {
        var grid = els.numberGrid;
        grid.innerHTML = '';
        var max = state.config.maxNumber;
        var frag = document.createDocumentFragment();

        for (var i = 1; i <= max; i++) {
          var btn = document.createElement('button');
          btn.className = 'number-btn';
          btn.textContent = i;
          btn.setAttribute('data-number', i);
          btn.setAttribute('type', 'button');
          btn.setAttribute('aria-pressed', state.player.currentPick === i ? 'true' : 'false');

          if (state.currentPhase !== 'guessing') {
            btn.disabled = true;
          }

          frag.appendChild(btn);
        }

        grid.appendChild(frag);
      }

      function renderPickTabState() {
        // Update pick display
        if (state.player.currentPick !== null) {
          els.yourPickNumber.textContent = state.player.currentPick;
          els.yourPickNumber.className = 'your-pick-number';
        } else {
          els.yourPickNumber.textContent = 'Tap a number';
          els.yourPickNumber.className = 'your-pick-none';
        }

        // During gathering, show the locked-in pick (or missed message)
        if (state.currentPhase === 'gathering') {
          if (state.player.confirmedPick) {
            els.yourPickNumber.textContent = state.player.confirmedPick;
            els.yourPickNumber.className = 'your-pick-number';
          } else {
            els.yourPickNumber.textContent = 'No guess';
            els.yourPickNumber.className = 'your-pick-none';
          }
        }

        // Update status message
        var msg = els.pickStatusMsg;
        msg.style.color = ''; // reset from any previous error styling
        if (state.currentPhase === 'idle') {
          msg.style.display = 'block';
          msg.textContent = 'Waiting for the game to start...';
        } else if (state.currentPhase === 'gathering') {
          msg.style.display = 'block';
          if (state.player.confirmedPick) {
            msg.textContent = 'Locked in! Your pick of ' + state.player.confirmedPick + ' has been submitted.';
          } else {
            msg.textContent = 'You did not submit a guess in time.';
            msg.style.color = 'var(--color-danger)';
          }
        } else if (state.currentPhase === 'reveal') {
          msg.style.display = 'block';
          msg.textContent = 'Reveal in progress \u2014 wait for next round';
        } else if (state.currentPhase === 'guessing') {
          if (state.guessCount > 0) {
            msg.style.display = 'block';
            msg.textContent = state.guessCount + ' player' + (state.guessCount !== 1 ? 's' : '') + (state.guessCount !== 1 ? ' have' : ' has') + ' guessed';
          } else {
            msg.style.display = 'none';
          }
        } else {
          msg.style.display = 'none';
        }

        // Enable/disable grid buttons
        var buttons = els.numberGrid.querySelectorAll('.number-btn');
        var isGuessing = state.currentPhase === 'guessing';
        for (var i = 0; i < buttons.length; i++) {
          buttons[i].disabled = !isGuessing;
          var num = parseInt(buttons[i].getAttribute('data-number'), 10);
          buttons[i].setAttribute('aria-pressed', state.player.currentPick === num ? 'true' : 'false');
        }

        // Update shuffle mini-game availability
        updateShuffleAvailability();
      }

      // ─── Render: Results Tab ────────────────────────────────────────

      function renderResultsTab() {
        if (!els.resultsContent) return;

        // During guessing phase, show guess count
        if (state.currentPhase === 'guessing') {
          els.resultsContent.innerHTML =
            '<div class="results-guessing-msg">' +
              '<span class="guess-count-big">' + state.guessCount + '</span>' +
              'player' + (state.guessCount !== 1 ? 's' : '') + ' guessed so far' +
            '</div>';
          return;
        }

        // During gathering phase, show "gathering" message
        if (state.currentPhase === 'gathering') {
          els.resultsContent.innerHTML =
            '<div class="results-guessing-msg">' +
              '<span class="guess-count-big">' + state.guessCount + '</span>' +
              'guesses collected. Gathering results\u2026' +
            '</div>';
          return;
        }

        // If no result available, show placeholder
        if (!state.lastRoundResult) {
          els.resultsContent.innerHTML =
            '<div class="placeholder-panel">' +
              '<div class="placeholder-panel-icon" aria-hidden="true">&#x1f3af;</div>' +
              '<p>Results will appear here after a round completes.</p>' +
            '</div>';
          return;
        }

        var result = state.lastRoundResult;
        var guesses = [];
        try {
          guesses = typeof result.guesses === 'string' ? JSON.parse(result.guesses) : (result.guesses || []);
        } catch (e) {
          guesses = [];
        }

        // Build the results display
        var html = '';

        // Winner banner
        if (result.winningNumber !== null && result.winningNumber !== '' && result.winnerName) {
          html += '<div class="winner-banner">' +
            '<div class="winner-label">Winner</div>' +
            '<div class="winner-number">' + sanitizeString(String(result.winningNumber)) + '</div>' +
            '<div class="winner-name">' + sanitizeString(result.winnerName) + '</div>' +
            '<div class="winner-points">+' + result.simplePoints + ' simple / +' + result.strategyPoints + ' strategy</div>' +
          '</div>';
        } else {
          html += '<div class="winner-banner winner-banner--no-winner">' +
            '<div class="winner-label">Round ' + (result.roundId || '') + '</div>' +
            '<div class="winner-name" style="color:var(--color-muted)">No winner this round</div>' +
            '<div class="winner-points">Every picked number had duplicates</div>' +
          '</div>';
        }

        // Number slots
        html += buildNumberSlotsHTML(guesses, result.winningNumber, state.config.maxNumber);

        // Stats
        html += '<div class="results-stats">' +
          '<div class="stat-card"><div class="stat-value">' + (result.totalGuesses || 0) + '</div><div class="stat-label">Guesses</div></div>' +
          '<div class="stat-card"><div class="stat-value">' + (result.uniqueCount || 0) + '</div><div class="stat-label">Unique</div></div>' +
          '<div class="stat-card"><div class="stat-value">' + (result.winningNumber !== null && result.winningNumber !== '' ? result.winningNumber : '\u2014') + '</div><div class="stat-label">Winning #</div></div>' +
          '<div class="stat-card"><div class="stat-value">R' + (result.roundId || '') + '</div><div class="stat-label">Round</div></div>' +
        '</div>';

        els.resultsContent.innerHTML = html;
      }

      function buildNumberSlotsHTML(guesses, winningNumber, maxNumber) {
        // Tally picks per number
        var pickMap = {};  // number -> [{playerName, playerId}]
        for (var i = 0; i < guesses.length; i++) {
          var num = guesses[i].number;
          if (!pickMap[num]) pickMap[num] = [];
          pickMap[num].push({
            playerName: guesses[i].playerName || 'Unknown',
            playerId: guesses[i].playerId || ''
          });
        }

        // Show numbers 1 to min(maxNumber, 20) in primary row, rest in secondary
        var displayMax = Math.min(maxNumber, MAX_DISPLAY_NUMBERS);
        var html = '<div class="number-slots" aria-label="Number picks">';

        for (var n = 1; n <= displayMax; n++) {
          var picks = pickMap[n] || [];
          var count = picks.length;
          var isWinner = (n === winningNumber);
          var isUnique = (count === 1);
          var isDuplicate = (count > 1);
          var isUnpicked = (count === 0);

          var slotClass = 'slot-number';
          var iconHTML = '';

          if (isWinner) {
            slotClass += ' slot-number--winner';
            iconHTML = '<span class="slot-icon slot-icon--star" aria-label="Winner">&#x2605;</span>';
          } else if (isUnique) {
            slotClass += ' slot-number--unique';
            iconHTML = '<span class="slot-icon slot-icon--check" aria-label="Unique">&#x2713;</span>';
          } else if (isDuplicate) {
            slotClass += ' slot-number--duplicate';
            iconHTML = '<span class="slot-icon slot-icon--x" aria-label="Duplicate">&#x2717;</span>';
          } else {
            slotClass += ' slot-number--unpicked';
          }

          html += '<div class="number-slot">';
          html += '<div class="' + slotClass + '">' + n + iconHTML + '</div>';

          if (picks.length > 0) {
            html += '<div class="slot-names">';
            for (var p = 0; p < picks.length; p++) {
              var nameClass = 'slot-player-name';
              if (isWinner) {
                nameClass += ' slot-player-name--winner';
              } else if (isDuplicate) {
                nameClass += ' slot-player-name--struck';
              }
              html += '<span class="' + nameClass + '">' + sanitizeString(picks[p].playerName) + '</span>';
            }
            html += '</div>';
          }

          html += '</div>';
        }

        html += '</div>';
        return html;
      }

      // ─── Render: Leaderboard Tab ──────────────────────────────────

      var LEADERBOARD_CACHE_MS = 10000;

      function fetchAndRenderLeaderboard() {
        var now = Date.now();
        // Use cached data if recent enough
        if (state.leaderboardData && (now - state.leaderboardLastFetch) < LEADERBOARD_CACHE_MS) {
          renderLeaderboardTable(state.leaderboardData, state.leaderboardScoreType);
          return;
        }

        apiGet('getLeaderboard', { scoreType: state.leaderboardScoreType })
          .then(function(data) {
            if (data && data.success && Array.isArray(data.players)) {
              state.leaderboardData = data.players;
              state.leaderboardLastFetch = Date.now();
              renderLeaderboardTable(data.players, state.leaderboardScoreType);
            }
          })
          .catch(function() {
            // Use cached data if available
            if (state.leaderboardData) {
              renderLeaderboardTable(state.leaderboardData, state.leaderboardScoreType);
            }
          });
      }

      function renderLeaderboardTable(players, scoreType) {
        if (!players || players.length === 0) {
          els.leaderboardBody.innerHTML =
            '<div class="leaderboard-empty"><p>No scores yet. Play a round to see the leaderboard.</p></div>';
          return;
        }

        // Always sort by strategy score (lower winning number = more points)
        var sortKey = 'strategyScore';
        var sorted = players.slice().sort(function(a, b) { return (b[sortKey] || 0) - (a[sortKey] || 0); });

        var frag = document.createDocumentFragment();
        var wrap = document.createElement('div');
        wrap.className = 'leaderboard-table-wrap';

        var table = document.createElement('table');
        table.className = 'leaderboard-table';
        table.setAttribute('role', 'table');

        // Header
        var thead = document.createElement('thead');
        var headerRow = document.createElement('tr');
        var headers = ['#', 'Player', 'Pts', 'Wins', 'Played'];
        headers.forEach(function(h) {
          var th = document.createElement('th');
          th.setAttribute('scope', 'col');
          th.textContent = h;
          headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        table.appendChild(thead);

        // Body
        var tbody = document.createElement('tbody');
        for (var i = 0; i < sorted.length; i++) {
          var p = sorted[i];
          var rank = i + 1;
          var tr = document.createElement('tr');

          // Highlight current player
          if (p.playerId === state.player.id) {
            tr.setAttribute('data-highlight', 'true');
            tr.setAttribute('aria-current', 'true');
          }

          // Rank cell
          var rankTd = document.createElement('td');
          rankTd.className = 'rank-cell';
          if (rank <= TOP_RANK_COUNT) {
            var medal = document.createElement('span');
            medal.className = 'rank-medal rank-medal--' + rank;
            medal.textContent = rank;
            medal.setAttribute('aria-label', rank === 1 ? '1st place' : rank === 2 ? '2nd place' : '3rd place');
            rankTd.appendChild(medal);
          } else {
            rankTd.textContent = rank;
          }
          tr.appendChild(rankTd);

          // Name cell
          var nameTd = document.createElement('td');
          nameTd.className = 'player-name-cell';
          nameTd.textContent = p.playerName || 'Unknown';
          tr.appendChild(nameTd);

          // Score cell
          var scoreTd = document.createElement('td');
          scoreTd.className = 'score-cell';
          scoreTd.textContent = p[sortKey] || 0;
          tr.appendChild(scoreTd);

          // Wins cell
          var winsTd = document.createElement('td');
          winsTd.textContent = p.totalWins || 0;
          tr.appendChild(winsTd);

          // Rounds played cell
          var playedTd = document.createElement('td');
          playedTd.textContent = p.roundsPlayed || 0;
          tr.appendChild(playedTd);

          tbody.appendChild(tr);
        }
        table.appendChild(tbody);
        wrap.appendChild(table);

        els.leaderboardBody.innerHTML = '';
        els.leaderboardBody.appendChild(wrap);
      }

      // Score type is always 'strategy' (lower winning number = more points)

      // ─── Render: History/Analytics Tab ─────────────────────────────

      var HISTORY_CACHE_MS = 30000;

      function fetchAndRenderHistory() {
        var now = Date.now();
        if (state.historyData && (now - state.historyLastFetch) < HISTORY_CACHE_MS) {
          renderHistoryContent(state.historyData);
          return;
        }

        apiGet('getRoundHistory', { limit: API_HISTORY_LIMIT })
          .then(function(data) {
            if (data && data.success && Array.isArray(data.rounds)) {
              state.historyData = data.rounds;
              state.historyLastFetch = Date.now();
              renderHistoryContent(data.rounds);
            }
          })
          .catch(function() {
            if (state.historyData) {
              renderHistoryContent(state.historyData);
            }
          });
      }

      function renderHistoryContent(rounds) {
        if (!rounds || rounds.length === 0) {
          els.historyContent.innerHTML =
            '<div class="placeholder-panel">' +
              '<div class="placeholder-panel-icon" aria-hidden="true">&#x1f4ca;</div>' +
              '<p>No rounds played yet. Start a game to see analytics.</p>' +
            '</div>';
          return;
        }

        var html = '';

        // Aggregate frequency data from all rounds
        var freqMap = {};
        var totalRounds = rounds.length;
        var winningNumbers = [];
        var maxNumber = state.config.maxNumber;

        for (var r = 0; r < rounds.length; r++) {
          var round = rounds[r];
          var guesses = [];
          try {
            guesses = typeof round.guesses === 'string' ? JSON.parse(round.guesses) : (round.guesses || []);
          } catch (e) {
            guesses = [];
          }
          for (var g = 0; g < guesses.length; g++) {
            var num = guesses[g].number;
            freqMap[num] = (freqMap[num] || 0) + 1;
          }
          if (round.winningNumber !== null && round.winningNumber !== '') {
            winningNumbers.push(parseInt(round.winningNumber, 10));
          }
        }

        // Compute stats
        var maxFreq = 0;
        var mostPicked = null;
        var leastPicked = null;
        var leastPickedCount = Infinity;
        var neverPicked = [];

        for (var n = 1; n <= maxNumber; n++) {
          var count = freqMap[n] || 0;
          if (count > maxFreq) {
            maxFreq = count;
            mostPicked = n;
          }
          if (count > 0 && count < leastPickedCount) {
            leastPickedCount = count;
            leastPicked = n;
          }
          if (count === 0) {
            neverPicked.push(n);
          }
        }

        // Stats grid
        html += '<div class="history-section">' +
          '<h2 class="history-section-title">Stats</h2>' +
          '<div class="history-stats-grid">' +
            '<div class="stat-card"><div class="stat-value">' + totalRounds + '</div><div class="stat-label">Rounds Played</div></div>' +
            '<div class="stat-card"><div class="stat-value">' + (mostPicked !== null ? mostPicked : '\u2014') + '</div><div class="stat-label">Most Picked</div></div>' +
            '<div class="stat-card"><div class="stat-value">' + (leastPicked !== null ? leastPicked : '\u2014') + '</div><div class="stat-label">Least Picked</div></div>' +
            '<div class="stat-card"><div class="stat-value">' + neverPicked.length + '</div><div class="stat-label">Never Picked</div></div>' +
          '</div>' +
        '</div>';

        // Frequency chart
        html += '<div class="history-section">' +
          '<h2 class="history-section-title">Number Frequency</h2>' +
          '<div class="freq-chart-container">' +
            '<div class="freq-chart" role="img" aria-label="Bar chart showing how often each number was picked">';

        var chartMax = Math.max(maxFreq, 1);
        var chartHeightPx = FREQ_CHART_HEIGHT_PX;
        for (var n2 = 1; n2 <= maxNumber; n2++) {
          var c = freqMap[n2] || 0;
          var barPx = c > 0 ? Math.max(Math.round((c / chartMax) * chartHeightPx), FREQ_CHART_MIN_BAR_PX) : 0;
          html += '<div class="freq-bar-col">' +
            (c > 0 ? '<span class="freq-bar-count">' + c + '</span>' : '') +
            '<div class="freq-bar" style="height:' + barPx + 'px"' +
              ' role="presentation"></div>' +
            '<span class="freq-bar-label">' + n2 + '</span>' +
          '</div>';
        }

        html += '</div></div></div>';

        // Recent rounds table
        html += '<div class="history-section">' +
          '<h2 class="history-section-title">Recent Rounds</h2>' +
          '<div class="rounds-table-wrap">' +
            '<table class="rounds-table"><thead><tr>' +
              '<th scope="col">#</th>' +
              '<th scope="col">Winner</th>' +
              '<th scope="col">Win #</th>' +
              '<th scope="col">Guesses</th>' +
              '<th scope="col">Unique</th>' +
            '</tr></thead><tbody>';

        var displayRounds = rounds.slice(0, RECENT_ROUNDS_COUNT);
        for (var i = 0; i < displayRounds.length; i++) {
          var rd = displayRounds[i];
          html += '<tr>' +
            '<td>' + (rd.roundId || '') + '</td>' +
            '<td>' + sanitizeString(rd.winnerName || '\u2014') + '</td>' +
            '<td>' + (rd.winningNumber !== null && rd.winningNumber !== '' ? rd.winningNumber : '\u2014') + '</td>' +
            '<td>' + (rd.totalGuesses || 0) + '</td>' +
            '<td>' + (rd.uniqueCount || 0) + '</td>' +
          '</tr>';
        }

        html += '</tbody></table></div></div>';

        els.historyContent.innerHTML = html;
      }

      // ─── Render: Admin Tab ────────────────────────────────────────

      function showAdminPanel() {
        els.passphraseGate.style.display = 'none';
        els.adminPanel.style.display = 'block';
        // Populate config fields with current values
        els.cfgMaxNumber.value = state.config.maxNumber;
        els.cfgGuessingDuration.value = state.config.guessingDuration;
        els.cfgRevealDuration.value = state.config.revealDuration;
        els.cfgMinPlayers.value = state.config.minPlayers;
        updateAdminStatus();
      }

      function updateAdminStatus() {
        if (!els.adminStatus) return;
        var phase = state.currentPhase || 'idle';
        var round = state.currentRoundId || 0;
        var conn = state.connectionStatus;
        els.adminStatus.textContent =
          'Phase: ' + phase + ' | Round: ' + round + ' | Connection: ' + conn;
      }

      function handlePassphraseSubmit() {
        var input = els.passphraseInput.value.trim();
        if (!input) {
          els.passphraseError.textContent = 'Please enter a passphrase.';
          els.passphraseInput.focus();
          return;
        }

        // Try to verify against server by attempting a benign admin action
        // We use getConfig first, but the real verification happens on admin POST actions
        // For now, store the passphrase and try it on the first admin action
        state.adminPassphrase = input;
        state.adminAuthenticated = true;
        els.passphraseError.textContent = '';

        // Store in sessionStorage so it persists across tab switches but not browser close
        try {
          sessionStorage.setItem('lun_admin', input);
        } catch (e) {}

        showAdminPanel();
      }

      function handleStartGame() {
        if (!state.adminPassphrase) return;
        setBtnLoading(els.btnStartGame, true);

        apiPost('startGame', { passphrase: state.adminPassphrase })
          .then(function(data) {
            setBtnLoading(els.btnStartGame, false);
            if (data && data.success) {
              announce('Game started! Round ' + (data.roundId || ''));
              pollGameState();
            } else {
              handleAdminError(data);
            }
          })
          .catch(function(err) {
            setBtnLoading(els.btnStartGame, false);
            handleAdminError({ error: err.message });
          });
      }

      function handlePauseGame() {
        if (!state.adminPassphrase) return;
        setBtnLoading(els.btnPauseGame, true);

        apiPost('pauseGame', { passphrase: state.adminPassphrase })
          .then(function(data) {
            setBtnLoading(els.btnPauseGame, false);
            if (data && data.success) {
              announce('Game paused.');
              pollGameState();
            } else {
              handleAdminError(data);
            }
          })
          .catch(function(err) {
            setBtnLoading(els.btnPauseGame, false);
            handleAdminError({ error: err.message });
          });
      }

      function handleForceNext() {
        if (!state.adminPassphrase) return;
        setBtnLoading(els.btnForceNext, true);

        apiPost('advancePhase', { passphrase: state.adminPassphrase })
          .then(function(data) {
            setBtnLoading(els.btnForceNext, false);
            if (data && data.success) {
              announce('Phase advanced to ' + (data.phase || 'next') + '.');
              // Invalidate history and leaderboard caches
              state.historyLastFetch = 0;
              state.leaderboardLastFetch = 0;
              pollGameState();
            } else {
              handleAdminError(data);
            }
          })
          .catch(function(err) {
            setBtnLoading(els.btnForceNext, false);
            handleAdminError({ error: err.message });
          });
      }

      function handleSaveConfig() {
        if (!state.adminPassphrase) return;

        // Validate inputs
        var maxNum = parseInt(els.cfgMaxNumber.value, 10);
        var guessDur = parseInt(els.cfgGuessingDuration.value, 10);
        var revealDur = parseInt(els.cfgRevealDuration.value, 10);
        var minPlayers = parseInt(els.cfgMinPlayers.value, 10);
        var valid = true;

        clearConfigErrors();

        if (isNaN(maxNum) || maxNum < 5 || maxNum > 200) {
          document.getElementById('cfgMaxNumberError').textContent = 'Must be 5\u2013200';
          valid = false;
        }
        if (isNaN(guessDur) || guessDur < 10 || guessDur > 600) {
          document.getElementById('cfgGuessingDurationError').textContent = 'Must be 10\u2013600';
          valid = false;
        }
        if (isNaN(revealDur) || revealDur < 5 || revealDur > 120) {
          document.getElementById('cfgRevealDurationError').textContent = 'Must be 5\u2013120';
          valid = false;
        }
        if (isNaN(minPlayers) || minPlayers < 2 || minPlayers > 100) {
          document.getElementById('cfgMinPlayersError').textContent = 'Must be 2\u2013100';
          valid = false;
        }

        if (!valid) return;

        setBtnLoading(els.btnSaveConfig, true);
        apiPost('setConfig', {
          passphrase: state.adminPassphrase,
          maxNumber: maxNum,
          guessingDuration: guessDur,
          revealDuration: revealDur,
          minPlayers: minPlayers
        })
          .then(function(data) {
            setBtnLoading(els.btnSaveConfig, false);
            if (data && data.success) {
              announce('Configuration saved.');
              pollGameState();
            } else {
              handleAdminError(data);
            }
          })
          .catch(function(err) {
            setBtnLoading(els.btnSaveConfig, false);
            handleAdminError({ error: err.message });
          });
      }

      function handleResetGame() {
        if (!state.adminPassphrase) return;

        if (!state.resetConfirmPending) {
          // First click — show confirmation
          state.resetConfirmPending = true;
          els.btnResetGame.textContent = 'Confirm Reset?';
          els.btnResetGame.classList.remove('btn--danger');
          els.btnResetGame.classList.add('btn--warning');
          // Auto-cancel after 5 seconds
          setTimeout(function() {
            if (state.resetConfirmPending) {
              state.resetConfirmPending = false;
              els.btnResetGame.textContent = 'Reset Game';
              els.btnResetGame.classList.remove('btn--warning');
              els.btnResetGame.classList.add('btn--danger');
            }
          }, 5000);
          return;
        }

        // Second click — actually reset
        state.resetConfirmPending = false;
        els.btnResetGame.textContent = 'Reset Game';
        els.btnResetGame.classList.remove('btn--warning');
        els.btnResetGame.classList.add('btn--danger');
        setBtnLoading(els.btnResetGame, true);

        apiPost('resetGame', { passphrase: state.adminPassphrase })
          .then(function(data) {
            setBtnLoading(els.btnResetGame, false);
            if (data && data.success) {
              announce('Game data has been reset.');
              state.lastRoundResult = null;
              state.leaderboardData = null;
              state.historyData = null;
              state.leaderboardLastFetch = 0;
              state.historyLastFetch = 0;
              pollGameState();
            } else {
              handleAdminError(data);
            }
          })
          .catch(function(err) {
            setBtnLoading(els.btnResetGame, false);
            handleAdminError({ error: err.message });
          });
      }

      function handleClearScores() {
        if (!state.adminPassphrase) return;
        setBtnLoading(els.btnClearScoresYes, true);

        apiPost('clearScores', { passphrase: state.adminPassphrase })
          .then(function(data) {
            setBtnLoading(els.btnClearScoresYes, false);
            els.clearScoresConfirm.style.display = 'none';
            els.btnClearScores.style.display = '';
            if (data && data.success) {
              announce('All scores and round history have been cleared.');
              state.lastRoundResult = null;
              state.leaderboardData = null;
              state.historyData = null;
              state.leaderboardLastFetch = 0;
              state.historyLastFetch = 0;
              pollGameState();
            } else {
              handleAdminError(data);
            }
          })
          .catch(function(err) {
            setBtnLoading(els.btnClearScoresYes, false);
            els.clearScoresConfirm.style.display = 'none';
            els.btnClearScores.style.display = '';
            handleAdminError({ error: err.message });
          });
      }

      function clearConfigErrors() {
        var errorEls = document.querySelectorAll('.config-field-error');
        for (var i = 0; i < errorEls.length; i++) {
          errorEls[i].textContent = '';
        }
      }

      function handleAdminError(data) {
        var msg = (data && data.error) || 'An error occurred';
        if (msg === 'Invalid passphrase') {
          // Kick back to passphrase gate
          state.adminAuthenticated = false;
          state.adminPassphrase = '';
          try { sessionStorage.removeItem('lun_admin'); } catch (e) {}
          els.adminPanel.style.display = 'none';
          els.passphraseGate.style.display = '';
          els.passphraseError.textContent = 'Passphrase was incorrect. Please try again.';
          els.passphraseInput.value = '';
          els.passphraseInput.focus();
        } else {
          announce('Admin error: ' + msg);
        }
      }

      function setBtnLoading(btn, loading) {
        if (loading) {
          btn.disabled = true;
          btn.setAttribute('data-orig-text', btn.textContent);
          btn.textContent = 'Loading...';
        } else {
          btn.disabled = false;
          btn.textContent = btn.getAttribute('data-orig-text') || btn.textContent;
        }
      }

      // ─── Number Pick Handler ────────────────────────────────────────

      var guessDebounceTimer = null;

      function handleNumberPick(number) {
        if (state.currentPhase !== 'guessing') return;

        var name = state.player.name.trim();
        if (!name) {
          els.playerNameInput.focus();
          announce('Please enter your name first.');
          return;
        }

        number = clampInt(number, 1, state.config.maxNumber);
        state.player.currentPick = number;
        state.player.pickStatus = 'sending';

        // Update UI immediately (optimistic)
        renderPickTabState();
        renderPickConfirmStatus();

        // Debounce the server submission
        if (guessDebounceTimer) clearTimeout(guessDebounceTimer);
        guessDebounceTimer = setTimeout(function() {
          submitGuessToServer(number);
        }, GUESS_DEBOUNCE_MS);
      }

      function submitGuessToServer(number) {
        apiPost('submitGuess', {
          playerId: state.player.id,
          playerName: state.player.name,
          number: number,
          deviceFingerprint: getDeviceFingerprint()
        }).then(function(data) {
          if (data && data.success) {
            state.player.confirmedPick = number;
            state.player.pickStatus = 'confirmed';
            state.guessCount = data.guessCount || state.guessCount;
            renderPickTabState();
            renderPickConfirmStatus();
          } else if (data && !data.success && data.error) {
            // Server rejected — revert to last confirmed pick or clear
            var revertTo = state.player.confirmedPick;
            state.player.currentPick = revertTo;
            state.player.pickStatus = 'reverted';
            renderPickTabState();
            renderPickConfirmStatus();
            // Make error messages user-friendly
            var errorText = data.error;
            if (errorText === 'Not in guessing phase') {
              errorText = revertTo
                ? 'Too late! Your previous pick of ' + revertTo + ' is locked in.'
                : 'Too late! The guessing phase has ended.';
            }
            // Show error in status area
            var msg = els.pickStatusMsg;
            msg.style.display = 'block';
            msg.textContent = errorText;
            msg.style.color = 'var(--color-danger)';
            announce(errorText);
            // Clear the error styling after 6 seconds
            setTimeout(function() {
              msg.style.color = '';
              if (state.player.pickStatus === 'reverted') {
                state.player.pickStatus = revertTo ? 'confirmed' : 'none';
                renderPickConfirmStatus();
              }
              renderPickTabState();
            }, 6000);
          }
        }).catch(function() {
          // Network error — keep optimistic pick, mark unconfirmed
          state.player.pickStatus = 'sending';
          renderPickConfirmStatus();
        });
      }

      function renderPickConfirmStatus() {
        var el = els.pickConfirmStatus;
        if (!el) return;
        var status = state.player.pickStatus;
        // Only show status if there's actually a pick in play
        if (status === 'confirmed' && state.player.currentPick !== null) {
          el.textContent = 'Confirmed';
          el.className = 'pick-confirm-status confirmed';
        } else if (status === 'sending' && state.player.currentPick !== null) {
          el.textContent = 'Sending...';
          el.className = 'pick-confirm-status sending';
        } else if (status === 'reverted') {
          var prev = state.player.confirmedPick;
          el.textContent = prev ? 'Reverted to ' + prev : 'Not submitted';
          el.className = 'pick-confirm-status reverted';
        } else {
          el.textContent = '';
          el.className = 'pick-confirm-status';
        }
      }

      // ─── Tab Navigation ─────────────────────────────────────────────

      function switchTab(tabId) {
        state.activeTab = tabId;

        els.tabBtns.forEach(function(btn) {
          var isSelected = btn.id === 'tab-' + tabId;
          btn.setAttribute('aria-selected', isSelected ? 'true' : 'false');
          btn.setAttribute('tabindex', isSelected ? '0' : '-1');
        });

        els.tabPanels.forEach(function(panel) {
          var panelTabId = panel.id.replace('panel-', '');
          panel.setAttribute('aria-hidden', panelTabId === tabId ? 'false' : 'true');
        });

        // Trigger data load for tabs that need it
        if (tabId === 'results') {
          renderResultsTab();
        } else if (tabId === 'leaderboard') {
          fetchAndRenderLeaderboard();
        } else if (tabId === 'history') {
          fetchAndRenderHistory();
        } else if (tabId === 'admin') {
          updateAdminStatus();
        }
      }

      function handleTabClick(e) {
        var btn = e.target.closest('[role="tab"]');
        if (!btn) return;
        var tabId = btn.id.replace('tab-', '');
        switchTab(tabId);
        btn.focus();
      }

      function handleTabKeydown(e) {
        var btn = e.target.closest('[role="tab"]');
        if (!btn) return;

        var currentIndex = els.tabBtns.indexOf(btn);
        var newIndex = -1;

        switch (e.key) {
          case 'ArrowRight':
          case 'ArrowDown':
            newIndex = (currentIndex + 1) % els.tabBtns.length;
            break;
          case 'ArrowLeft':
          case 'ArrowUp':
            newIndex = (currentIndex - 1 + els.tabBtns.length) % els.tabBtns.length;
            break;
          case 'Home':
            newIndex = 0;
            break;
          case 'End':
            newIndex = els.tabBtns.length - 1;
            break;
          default:
            return;
        }

        e.preventDefault();
        var targetBtn = els.tabBtns[newIndex];
        var tabId = targetBtn.id.replace('tab-', '');
        switchTab(tabId);
        targetBtn.focus();
      }

      // ─── Event Setup ────────────────────────────────────────────────

      function setupEvents() {
        // Tab navigation
        var tabNav = document.querySelector('.tab-nav');
        tabNav.addEventListener('click', handleTabClick);
        tabNav.addEventListener('keydown', handleTabKeydown);

        // Number grid (event delegation)
        els.numberGrid.addEventListener('click', function(e) {
          var btn = e.target.closest('.number-btn');
          if (!btn || btn.disabled) return;
          var num = parseInt(btn.getAttribute('data-number'), 10);
          if (!isNaN(num)) {
            handleNumberPick(num);
          }
        });

        // Player name input
        els.playerNameInput.addEventListener('input', function() {
          var val = els.playerNameInput.value.substring(0, MAX_NAME_LENGTH);
          state.player.name = val;
          savePlayer();
        });

        // Prevent form submission on Enter in name field
        els.playerNameInput.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            // Focus the number grid if name is entered
            if (state.player.name.trim()) {
              var firstBtn = els.numberGrid.querySelector('.number-btn:not(:disabled)');
              if (firstBtn) firstBtn.focus();
            }
          }
        });

        // Admin: passphrase submission
        els.passphraseSubmit.addEventListener('click', handlePassphraseSubmit);
        els.passphraseInput.addEventListener('keydown', function(e) {
          if (e.key === 'Enter') {
            e.preventDefault();
            handlePassphraseSubmit();
          }
        });

        // Admin: game controls
        els.btnStartGame.addEventListener('click', handleStartGame);
        els.btnPauseGame.addEventListener('click', handlePauseGame);
        els.btnForceNext.addEventListener('click', handleForceNext);
        els.btnSaveConfig.addEventListener('click', handleSaveConfig);
        els.btnResetGame.addEventListener('click', handleResetGame);
        els.btnClearScores.addEventListener('click', function() {
          els.clearScoresConfirm.style.display = '';
          els.btnClearScores.style.display = 'none';
        });
        els.btnClearScoresNo.addEventListener('click', function() {
          els.clearScoresConfirm.style.display = 'none';
          els.btnClearScores.style.display = '';
        });
        els.btnClearScoresYes.addEventListener('click', handleClearScores);

        // Visibility change — adjust polling and save state
        document.addEventListener('visibilitychange', function() {
          if (document.hidden) {
            // Reduce polling frequency
            schedulePoll();
          } else {
            // Immediately poll and restore normal frequency
            pollGameState();
            schedulePoll();
          }
        });

        // Save on unload
        window.addEventListener('beforeunload', function() {
          savePlayer();
        });
      }

      // ─── Initialization ─────────────────────────────────────────────

      function init() {
        cacheElements();
        loadPlayer();

        // Restore name in input
        if (state.player.name) {
          els.playerNameInput.value = state.player.name;
        }

        // Restore admin session if available
        try {
          var savedPass = sessionStorage.getItem('lun_admin');
          if (savedPass) {
            state.adminPassphrase = savedPass;
            state.adminAuthenticated = true;
            showAdminPanel();
          }
        } catch (e) {}

        renderNumberGrid();
        renderHeader();
        renderPickTabState();
        renderConnectionStatus();

        setupEvents();
        startTimer();
        startPolling();

        // Initialize shuffle mini-game
        initShuffle();

        // Show onboarding for first-time visitors
        setupOnboarding();
        setupThemeToggle();

        try {
          if (!localStorage.getItem('lun_onboarded')) showOnboarding();
        } catch (e) {}
      }

      // ─── Shuffle Mini-Game ─────────────────────────────────────────
      var SHUFFLE_GRID_SIZE = 4;
      var SHUFFLE_VOWELS = 'AEIOU';
      var SHUFFLE_CONSONANTS = 'BCDFGHLMNPRST';
      var SHUFFLE_COMBO_TIMEOUT_MS = 5000;
      var SHUFFLE_CELEBRATE_MS = 1300;
      var SHUFFLE_CHECK_DELAY_MS = 200;
      var SHUFFLE_WORD_MULTIPLIER = 15;
      var SHUFFLE_MAX_FOUND_DISPLAY = 10;
      var SHUFFLE_MAX_FOUND_KEEP = 15;

      var SHUFFLE_WORDS = new Set([
        // 3-letter words
        "ace","act","add","age","ago","aid","aim","air","ale","all","and","ant","any","ape","arc","are","ark","arm","art","ash","ask","ate","awe","axe",
        "bad","bag","ban","bar","bat","bay","bed","bee","bet","bid","big","bin","bit","bog","bow","box","boy","bud","bug","bun","bus","but","buy",
        "cab","cam","can","cap","car","cat","cob","cod","cog","con","cop","cot","cow","cry","cub","cud","cup","cur","cut",
        "dab","dad","dam","day","den","dew","did","dig","dim","din","dip","doe","dog","don","dot","dry","dub","dud","due","dug","dun","duo","dye",
        "ear","eat","eel","egg","ego","elk","elm","emu","end","era","eve","ewe","eye",
        "fad","fan","far","fat","fax","fed","fee","fen","few","fig","fin","fir","fit","fix","fly","fob","foe","fog","fop","for","fox","fry","fun","fur",
        "gab","gag","gal","gap","gas","gel","gem","get","gig","gin","gnu","god","got","gum","gun","gut","guy","gym",
        "had","ham","has","hat","hay","hen","her","hew","hex","hid","him","hip","his","hit","hob","hod","hog","hop","hot","how","hub","hue","hug","hum","hut",
        "ice","icy","ill","imp","ink","inn","ion","ire","irk","its","ivy",
        "jab","jag","jam","jar","jaw","jay","jet","jig","job","jog","jot","joy","jug","jut",
        "keg","ken","key","kid","kin","kit",
        "lab","lad","lag","lap","law","lay","lea","led","leg","let","lid","lie","lip","lit","log","lot","low","lug",
        "mad","man","map","mar","mat","maw","may","men","met","mid","mix","mob","mod","mop","mow","mud","mug","mum",
        "nab","nag","nap","nay","net","new","nil","nip","nit","nod","nor","not","now","nub","nun","nut",
        "oak","oar","oat","odd","ode","off","oft","ohm","oil","old","one","opt","orb","ore","our","out","ova","owe","owl","own",
        "pad","pal","pan","pap","par","pat","paw","pay","pea","peg","pen","pep","per","pet","pew","pie","pig","pin","pit","ply","pod","pop","pot","pow","pro","pry","pub","pug","pun","pup","pus","put",
        "rag","ram","ran","rap","rat","raw","ray","red","ref","rep","rib","rid","rig","rim","rip","rob","rod","roe","rot","row","rub","rug","rum","run","rut","rye",
        "sac","sad","sag","sap","sat","saw","say","sea","set","sew","she","shy","sin","sip","sir","sis","sit","six","ski","sky","sly","sob","sod","son","sop","sot","sow","soy","spa","spy","sty","sub","sue","sum","sun","sup",
        "tab","tad","tag","tan","tap","tar","tax","tea","ten","the","thy","tic","tie","tin","tip","toe","ton","too","top","tot","tow","toy","try","tub","tug","tun","two",
        "ugh","ump","urn","use",
        "van","vat","vet","via","vie","vim","vow",
        "wad","wag","war","was","wax","way","web","wed","wet","who","why","wig","win","wit","woe","wok","won","woo","wow",
        "yak","yam","yap","yaw","yea","yes","yet","yew","you","yow",
        "zag","zap","zed","zen","zig","zip","zoo",
        // 4-letter words
        "able","ache","acid","acme","acne","acre","aged","aide","also","arch","area","army","aunt","avid","away","axle",
        "back","bait","bake","bald","bale","ball","balm","band","bane","bang","bank","bare","bark","barn","base","bash","bath","bawl","bead","beak","beam","bean","bear","beat","beef","been","beer","bell","belt","bend","bent","best","bias","bill","bind","bird","bite","blam","bled","blew","blip","blob","bloc","blog","blot","blow","blue","blur","boar","boat","body","boil","bold","bolt","bomb","bond","bone","book","boom","boot","bore","born","boss","both","bout","bowl","brag","bran","brat","bred","brew","brim","buck","bulb","bulk","bull","bump","bunk","burn","burp","bush","bust","busy","buzz",
        "cafe","cage","cake","calf","call","calm","came","camp","cane","cape","card","care","carp","cart","case","cash","cast","cave","cell","chap","char","chat","chef","chin","chip","chop","cite","city","clad","clam","clan","clap","claw","clay","clip","clog","clot","club","clue","coal","coat","cock","code","coil","coin","cold","colt","coma","comb","come","cone","cook","cool","cope","copy","cord","core","cork","corn","cost","coup","cove","cozy","crab","crew","crib","crop","crow","crud","cube","cult","curb","curd","cure","curl","cute",
        "dale","damp","dare","dark","darn","dart","dash","data","date","dawn","dead","deaf","deal","dear","debt","deck","deed","deem","deep","deer","deny","desk","dial","dice","diet","dine","dire","dirt","disc","dish","disk","dock","does","dome","done","doom","door","dose","dote","down","drag","dram","draw","drew","drip","drop","drum","dual","duck","duel","duet","duke","dull","dumb","dump","dune","dung","dunk","dupe","dusk","dust","duty",
        "each","earl","earn","ease","east","easy","edge","edgy","edit","else","emit","epic","even","ever","evil","exam","exit","eyed",
        "face","fact","fade","fail","fair","fake","fall","fame","fang","fare","farm","fast","fate","fawn","fear","feat","feed","feel","feet","fell","felt","fend","fern","feud","file","fill","film","find","fine","fire","firm","fish","fist","five","flag","flak","flap","flat","flaw","flea","fled","flew","flex","flip","flit","flog","flop","flow","foam","foil","fold","folk","fond","font","food","fool","foot","ford","fore","fork","form","fort","foul","four","fowl","free","frog","from","fuel","full","fume","fund","funk","fury","fuse","fuss","fuzz",
        "gain","gait","gale","gall","game","gang","gape","garb","gate","gave","gaze","gear","gene","gift","gild","gill","girl","gist","give","glad","glen","glib","glob","glow","glue","glum","glut","gnat","gnaw","goad","goat","goes","gold","golf","gone","good","gore","grab","gram","gray","grew","grey","grid","grim","grin","grip","grit","grub","gulf","gull","gulp","guru","gush","gust","guts","guys",
        "hack","hail","hair","hale","half","hall","halt","halo","hand","hang","hard","hare","harm","harp","hash","hate","haul","have","hawk","haze","hazy","head","heal","heap","hear","heat","heed","heel","heir","held","hell","helm","help","hemp","herd","here","hero","hide","high","hike","hill","hilt","hind","hint","hire","hiss","hive","hoax","hock","hold","hole","holy","home","hone","hood","hoof","hook","hoop","hope","horn","hose","host","hour","howl","huge","hull","hump","hung","hunt","hurl","hurt","hush","hymn",
        "icon","idea","idle","inch","info","into","iron","isle","item",
        "jack","jade","jail","jamb","java","jazz","jean","jeer","jerk","jest","jilt","jock","join","joke","jolt","jump","junk","jury","just",
        "kale","keen","keep","kelp","kept","kick","kids","kill","kilt","kind","king","kiss","kite","knee","knew","knit","knob","knot","know",
        "lace","lack","lacy","laid","lain","lair","lake","lame","lamp","land","lane","lard","lark","lash","lass","last","late","laud","lawn","laws","lead","leaf","leak","lean","leap","left","lend","lens","less","lest","liar","lice","lick","lied","lieu","life","lift","like","lily","limb","lime","limp","line","link","lint","lion","lips","list","live","load","loaf","loam","loan","lobe","lock","lode","loft","logo","lone","long","look","loom","loop","loot","lord","lore","lose","loss","lost","loud","love","luck","lull","lump","lure","lurk","lush","lust",
        "mace","made","mail","maim","main","make","male","mall","malt","mane","many","maps","mare","mark","mars","mart","mash","mask","mass","mast","mate","math","maze","mead","meal","mean","meat","meek","meet","meld","melt","memo","mend","menu","mere","mesh","mess","mice","mild","mile","milk","mill","mime","mind","mine","mint","mire","miss","mist","mite","moan","moat","mock","mode","mold","mole","molt","monk","mood","moon","moor","mope","more","moss","most","moth","move","much","muck","muff","mule","mull","muse","mush","must","mute","myth",
        "nail","name","nape","navy","near","neat","neck","need","nest","nets","news","next","nice","nick","nine","node","none","noon","norm","nose","note","noun","nude","nuke","null","numb","nuts",
        "oafs","oaks","oars","oath","oats","obey","odds","odor","once","only","onto","ooze","opal","open","opts","oral","orbs","orca","ores","ours","oust","outs","oval","oven","over","owed","owes","owls","owns",
        "pace","pack","pact","page","paid","pail","pain","pair","pale","palm","pane","pang","pare","park","part","pass","past","path","pave","pawn","peak","peal","pear","peas","peat","peck","peel","peer","pelt","pend","pens","perk","perm","pert","pest","pick","pier","pike","pile","pill","pine","pink","pins","pint","pipe","plan","play","plea","plod","plot","plow","ploy","plug","plum","plus","pock","poem","poet","poke","pole","poll","polo","pomp","pond","pool","poor","pope","pops","pore","pork","port","pose","post","pour","pout","pray","prey","prod","prom","prop","prow","pubs","puck","pull","pulp","pump","punk","pure","push",
        "quad","quay","quit","quiz",
        "race","rack","raft","rage","rags","raid","rail","rain","rake","ramp","rams","rang","rank","rant","raps","rare","rash","rasp","rate","rats","rave","rays","raze","read","real","ream","reap","rear","reed","reef","reel","rein","rely","rend","rent","rest","rice","rich","ride","rift","rile","rill","rime","rind","ring","riot","ripe","rise","risk","rite","road","roam","roar","robe","rock","rode","role","roll","romp","roof","room","root","rope","rose","rosy","rote","rout","rove","rows","rude","rued","rugs","ruin","rule","rump","rung","runs","runt","ruse","rush","rust","ruts",
        "sack","safe","sage","said","sail","sake","sale","salt","same","sand","sane","sang","sank","sash","save","scan","scar","seal","seam","sear","seat","sect","seed","seek","seem","seen","self","sell","send","sent","sept","sets","sewn","shed","shin","ship","shod","shoe","shoo","shop","shot","show","shun","shut","sick","side","sift","sigh","sign","silk","sill","silt","sine","sing","sink","sire","site","size","skit","slab","slag","slam","slap","slat","slaw","slay","sled","slew","slid","slim","slit","slob","slop","slot","slow","slug","slum","slur","smog","snap","snag","snip","snob","snot","snow","snub","snug","soak","soap","soar","sock","soda","sofa","soft","soil","sold","sole","some","song","soon","soot","sore","sort","soul","soup","sour","span","spar","spat","spec","sped","spin","spit","spot","spry","spud","spun","spur","stab","stag","star","stay","stem","step","stew","stir","stop","stub","stud","stun","such","suck","suit","sulk","sumo","sump","sung","sunk","sure","surf","swan","swap","sway","swim","swum",
        "tack","tact","tail","take","tale","talk","tall","tame","tang","tank","tape","taps","tarn","tart","task","taxi","teak","teal","team","tear","teem","tell","temp","tend","tent","term","tern","test","text","than","that","thaw","them","then","they","thin","this","thud","thus","tick","tide","tidy","tied","tier","tile","till","tilt","time","tine","tint","tiny","tire","toad","toil","told","toll","tomb","tome","tone","took","tool","tops","tore","torn","tort","toss","tour","town","trap","tray","tree","trek","trim","trio","trip","trod","trot","true","tube","tuck","tuft","tuna","tune","turf","turn","tusk","twin","type",
        "ugly","undo","unit","unto","upon","urge","used","user",
        "vain","vale","vane","vary","vase","vast","veal","veer","veil","vein","vend","vent","verb","very","vest","veto","vial","vice","view","vile","vine","visa","void","vole","volt","vote","vows",
        "wade","wage","wail","wait","wake","walk","wall","wand","wane","want","ward","warm","warn","warp","wart","wary","wash","wasp","wave","wavy","waxy","weak","wean","wear","weed","week","weep","weld","well","welt","went","were","west","wham","what","when","whim","whip","whom","wick","wide","wife","wild","will","wilt","wily","wimp","wind","wine","wing","wink","wipe","wire","wise","wish","wisp","with","wits","woke","wolf","womb","wood","wool","word","wore","work","worm","worn","wove","wrap","wren",
        "yank","yard","yarn","yawn","year","yell","yelp","your",
        "zany","zeal","zero","zest","zinc","zing","zone","zoom",
        // 5-letter words
        "abide","about","above","abuse","acted","acute","adept","admit","adopt","adult","after","again","agent","agree","ahead","aisle","alarm","album","alert","alien","align","alike","alive","alley","allot","allow","alone","along","alter","amaze","ample","angel","anger","angle","angry","ankle","apart","apple","apply","arena","argue","arise","armor","arose","array","arrow","aside","asset","attic","audio","audit","avoid","awake","award","aware",
        "bacon","badge","badly","basic","basin","basis","batch","beach","beard","beast","began","begin","being","below","bench","birth","black","blade","blame","bland","blank","blast","blaze","bleed","blend","bless","blind","blink","bliss","block","blood","bloom","blown","board","boast","bonus","boost","booth","bound","brain","brand","brass","brave","bread","break","breed","brick","bride","brief","bring","broad","broke","brook","brown","brush","buddy","build","built","bunch","burst","buyer",
        "cabin","cable","candy","cargo","carry","catch","cater","cause","chain","chair","chalk","chant","chaos","charm","chart","chase","cheap","cheat","check","cheek","cheer","chess","chest","chief","child","chill","china","chord","chunk","civil","claim","clash","class","clean","clear","clerk","cliff","climb","cling","clock","clone","close","cloth","cloud","coach","coast","coral","count","could","court","cover","crack","craft","crane","crash","crazy","cream","crest","crisp","cross","crowd","crown","crude","cruel","crush","curve","cycle",
        "daily","dance","death","debut","delay","dense","depth","derby","devil","diary","dirty","donor","doubt","dough","draft","drain","drama","drank","drawn","dream","dress","dried","drift","drill","drink","drive","drove","drown","drunk","dying",
        "eager","eagle","early","earth","eight","elect","elite","email","ember","empty","enemy","enjoy","enter","equal","equip","erode","error","essay","ethic","event","every","evict","exact","exert","exile","exist","extra",
        "fable","facet","faint","faith","fault","feast","fence","fiber","field","fifth","fifty","fight","filed","final","first","fixed","flame","flash","flask","fleet","flesh","flick","float","flock","flood","floor","flora","flour","fluid","flush","focal","focus","force","forge","forth","found","frame","frank","fraud","fresh","front","frost","froze","fruit","fully","fungi",
        "giant","given","gland","glass","glaze","gleam","glide","globe","gloom","gloss","glove","grace","grade","grain","grand","grant","grape","graph","grasp","grass","grave","graze","great","greed","green","greet","grief","grind","groan","groom","gross","group","grove","growl","grown","guard","guess","guide","guild","guilt","guise",
        "habit","harsh","haste","hasty","hatch","haven","heart","heavy","hedge","heist","hence","herbs","honey","honor","horse","hotel","house","human","humor","hurry",
        "ideal","image","imply","inbox","index","indie","infer","inner","input","inter","intro","irony","ivory",
        "jewel","joint","joker","jolly","judge","juice","juicy",
        "knack","kneel","knife","knock","knoll",
        "label","labor","lance","large","laser","latch","later","laugh","layer","learn","lease","leave","ledge","legal","lemon","level","lever","light","liken","limit","linen","liner","liver","llama","lobby","local","lodge","logic","loose","lover","lower","loyal","lucid","lunar","lunch","lunge",
        "magic","major","maker","manor","maple","march","match","maybe","mayor","medal","media","mercy","merge","merit","merry","metal","meter","might","mince","miner","minor","minus","model","mogul","moist","money","month","moose","moral","mount","mourn","mouse","mouth","movie","muddy","mural","music",
        "naive","nasty","naval","nerve","never","niche","night","noble","noise","north","notch","noted","novel","nudge","nurse",
        "ocean","offer","often","olive","onset","opera","orbit","order","other","ought","outer","outdo","owned","owner","oxide",
        "paint","panel","panic","patch","pause","peace","peach","pearl","phase","phone","photo","piano","piece","pilot","pinch","pitch","pixel","place","plain","plane","plant","plate","plaza","plead","pleat","pluck","plumb","plume","plump","point","polar","pound","power","press","price","pride","prime","print","prior","prize","probe","prone","proof","prose","proud","prove","proxy","prune","psalm","pulse","punch","pupil","purge","purse",
        "quack","qualm","queen","query","quest","quick","quiet","quill","quirk","quota","quote",
        "radar","radio","raise","rally","ranch","range","rapid","ratio","reach","react","realm","rebel","reign","relax","renal","renew","repay","reply","rider","ridge","rifle","right","rigid","risky","rival","river","robin","robot","rocky","rough","round","route","royal","ruler","rumor","rural",
        "saint","salad","salon","salsa","sandy","sauce","sauna","scale","scare","scene","scent","scope","score","scout","scrap","sedan","sense","serum","serve","setup","seven","shade","shaft","shake","shall","shame","shape","share","shark","sharp","shave","shawl","shear","sheen","sheep","sheer","sheet","shelf","shell","shift","shine","shirt","shock","shore","short","shout","shove","shown","sight","since","sixth","sixty","sized","skill","skull","slate","sleep","slice","slide","slope","smell","smile","smoke","snake","solar","solid","solve","sonic","sorry","sound","south","space","spare","spark","speak","spear","speed","spell","spend","spent","spice","spill","spine","spite","spoke","spoon","sport","spray","stain","stair","stake","stale","stalk","stall","stamp","stand","stare","stark","start","state","stave","steak","steal","steam","steel","steep","steer","stern","stick","stiff","still","sting","stock","stole","stone","stood","stool","store","storm","story","stout","stove","strip","stuck","study","stuff","stump","stung","stunt","style","sugar","suite","sunny","super","surge","swamp","swarm","swear","sweat","sweep","sweet","swept","swift","swing","swirl","sword","swore","swung",
        "table","taken","taste","teach","teeth","tempo","tense","theft","theme","thick","thief","thigh","thing","think","third","thorn","those","three","threw","throw","thumb","tiger","tight","timer","tired","title","toast","token","topic","torch","total","touch","tough","towel","tower","toxic","trace","track","trade","trail","train","trait","trash","treat","trend","trial","tribe","trick","tried","troop","trout","truck","truly","trunk","trust","truth","tumor","tunes","tunic","turbo","tutor","twice","twist",
        "ultra","uncle","under","unfit","union","unite","unity","until","upper","upset","urban","usage","usher","usual","utter",
        "vague","valid","value","valve","vapor","vault","verse","vigor","vinyl","viola","viral","vivid","vocal","vodka","voice","voter",
        "wages","watch","water","waved","weary","weave","wedge","weigh","weird","wheat","wheel","where","which","while","whine","whole","whose","widen","width","witch","woman","women","world","worry","worse","worst","worth","would","wound","wrath","wrist","write","wrong","wrote",
        "yacht","yield","young","youth",
        "zebra","zonal",
        // 6-letter words
        "absorb","accent","accept","access","across","action","active","actual","advice","afford","agenda","almost","amount","animal","annual","answer","anyone","appeal","appear","arctic","around","artist","aspect","assert","assign","assist","assume","attach","attack","attend","autumn",
        "ballet","banner","barely","barrel","basket","battle","beauty","become","before","behalf","behave","behind","belong","beside","better","beyond","bishop","bitter","blanch","blight","boards","bonnet","borrow","bounce","branch","breach","breast","breath","breeze","bridge","bright","broken","bronze","broker","brutal","bubble","bucket","budget","bundle","burden","bureau","buried","butter",
        "cables","camera","cancel","candle","canvas","carbon","career","castle","cattle","caught","causal","center","chance","change","chapel","charge","chosen","church","circle","clause","clever","client","clinic","closed","closet","clouds","clutch","coffin","collar","colony","column","combat","comedy","coming","commit","common","comply","convey","cookie","corner","costly","cotton","couple","course","cousin","covers","cradle","create","credit","crisis","custom","cycles",
        "damage","danger","dealer","debate","debris","decade","decent","defeat","defend","define","degree","demand","denial","depart","deploy","deputy","derive","desert","design","desire","detail","detect","device","devote","differ","dinner","direct","divide","domain","donate","double","dragon","drawer","driven","driver",
        "easier","easily","eating","editor","effect","effort","eighth","either","emerge","empire","employ","enable","ending","energy","engage","engine","enough","ensure","entire","entity","equity","escape","estate","ethnic","evolve","exceed","except","excite","excuse","exempt","expand","expect","expert","export","expose","extend","extent",
        "fabric","factor","fairly","fallen","family","famine","famous","farmer","fasten","father","favour","fellow","female","fierce","figure","filter","finale","finger","finish","fiscal","flight","flower","flying","forest","forget","formal","format","former","fossil","foster","fought","fourth","freeze","friend","frozen","future",
        "galaxy","garden","garlic","gather","gender","gentle","gifted","ginger","global","golden","govern","gravel","grease","ground","growth","guitar",
        "handle","happen","harbor","hardly","hatred","hazard","headed","health","heaven","helped","heroic","hidden","highly","hockey","hollow","honest","horror",
        "immune","impact","import","impose","income","indeed","indoor","infant","inform","inject","injure","injury","inland","insect","insert","inside","insist","intact","intend","intent","invent","invest","island",
        "jacket","junior","jungle",
        "knight",
        "ladder","launch","lawyer","layout","leader","league","lender","lesson","letter","lights","likely","linear","linger","liquid","listen","little","litter","lively","living","locate","lonely","looked","loosen","lovely","lowest","luxury",
        "magnet","maiden","mainly","manage","manner","manual","marble","margin","marine","marker","market","master","matter","meadow","medium","member","memoir","memory","mental","mentor","method","middle","mighty","miller","mingle","mining","minute","mirror","misery","mister","mobile","modern","modest","molten","moment","monkey","mortal","mosaic","mostly","mother","motion","motive","museum","mutual","myself","mystic",
        "namely","narrow","nation","native","nature","nearby","nearly","neatly","needle","nickel","nimble","nobody","nodded","normal","notice","notion","number",
        "obtain","occupy","offend","office","online","opened","oppose","option","orange","origin","orphan","output","outset","oxygen",
        "packed","paddle","palace","parcel","parent","partly","pastor","patron","patrol","patter","paving","permit","person","phrase","pillar","pillow","pirate","pistol","planet","player","please","plenty","plunge","pocket","poetry","poison","police","policy","polish","polite","ponder","poorly","portal","poster","potato","potent","powder","praise","prayer","prefer","prison","profit","prompt","propel","proper","proven","public","punish","pursue","puzzle",
        "rabbit","racial","radius","random","rarely","rather","reader","reason","rebels","recall","recent","record","reduce","reform","refuse","regard","regime","region","reject","relate","relief","remain","remedy","remote","remove","render","rental","repair","repeat","report","rescue","resign","resist","resort","result","retain","retire","return","reveal","review","revolt","reward","ribbon","riddle","rights","ritual","robust","rocket","rotate","ruling","runner",
        "sacred","safari","safely","safety","sailor","salary","salmon","sample","saving","scared","scheme","school","screen","script","search","season","second","secret","sector","secure","select","seller","senior","sensor","serial","series","settle","severe","shadow","shaken","shaped","sheets","shield","signal","silent","silver","simple","simply","single","sister","sketch","slight","slowly","smooth","snatch","social","socket","soften","solely","solemn","solved","sought","source","speech","spirit","spoken","spread","spring","square","stable","static","statue","steady","stereo","stolen","stormy","strain","strand","stream","street","stress","strict","strike","string","stripe","stroke","strong","struck","studio","submit","subtle","sudden","suffer","summit","summer","supply","surely","survey","switch","symbol","system",
        "tablet","tackle","talent","target","temple","tenant","tender","tennis","terror","theirs","theory","thirty","thorny","though","thread","thrill","thrive","throne","thrown","thrust","timber","tissue","toggle","tongue","toward","tragic","travel","treaty","tribal","triple","trophy","tunnel","twelve","twenty","tycoon",
        "unfair","unfold","unique","unlike","unlock","unrest","unveil","upbeat","update","uphold","upkeep","uplift","upside","uptake","upward","urgent","usable","useful","utmost",
        "vacant","valley","vanish","vanity","velvet","vendor","verbal","verify","versus","vessel","victim","violet","virtue","vision","visual","volley","volume","voyage",
        "walker","wallet","wander","warmth","weaken","wealth","weapon","weekly","weight","wholly","wicked","widely","willow","window","winner","winter","wisdom","within","wonder","worker","worthy","wreath","writer",
        "yearly","zenith","zombie"
      ]);

      var shuffleState = {
        grid: [],
        selected: null,
        score: 0,
        foundWords: [],
        foundSet: {},
        totalFound: 0,
        combo: 0,
        expanded: false,
        checkLock: false,
        comboTimer: null
      };

      function generateShuffleGrid() {
        var letters = [];
        for (var i = 0; i < SHUFFLE_GRID_SIZE * SHUFFLE_GRID_SIZE; i++) {
          if (Math.random() < 0.4) {
            letters.push(SHUFFLE_VOWELS.charAt(Math.floor(Math.random() * SHUFFLE_VOWELS.length)));
          } else {
            letters.push(SHUFFLE_CONSONANTS.charAt(Math.floor(Math.random() * SHUFFLE_CONSONANTS.length)));
          }
        }
        return letters;
      }

      function findShuffleWords(grid) {
        var words = {};
        var sz = SHUFFLE_GRID_SIZE;

        // Check rows
        for (var r = 0; r < sz; r++) {
          for (var len = 3; len <= sz; len++) {
            for (var c = 0; c <= sz - len; c++) {
              var w = '', p = [];
              for (var i = 0; i < len; i++) { w += grid[r * sz + c + i]; p.push(r * sz + c + i); }
              var wl = w.toLowerCase();
              if (SHUFFLE_WORDS.has(wl) && !words[wl]) words[wl] = { word: w, path: p };
            }
          }
        }

        // Check columns
        for (var c2 = 0; c2 < sz; c2++) {
          for (var len2 = 3; len2 <= sz; len2++) {
            for (var r2 = 0; r2 <= sz - len2; r2++) {
              var w2 = '', p2 = [];
              for (var i2 = 0; i2 < len2; i2++) { w2 += grid[(r2 + i2) * sz + c2]; p2.push((r2 + i2) * sz + c2); }
              var wl2 = w2.toLowerCase();
              if (SHUFFLE_WORDS.has(wl2) && !words[wl2]) words[wl2] = { word: w2, path: p2 };
            }
          }
        }

        // Snake path search (DFS)
        var dirs = [[0,1],[1,0],[0,-1],[-1,0]];
        function dfs(r, c, path, word) {
          var wl = word.toLowerCase();
          if (word.length >= 3 && word.length <= 6 && SHUFFLE_WORDS.has(wl) && !words[wl]) {
            words[wl] = { word: word, path: path.slice() };
          }
          if (word.length >= 6) return;
          for (var d = 0; d < dirs.length; d++) {
            var nr = r + dirs[d][0], nc = c + dirs[d][1];
            if (nr >= 0 && nr < sz && nc >= 0 && nc < sz) {
              var idx = nr * sz + nc;
              var inPath = false;
              for (var pi = 0; pi < path.length; pi++) { if (path[pi] === idx) { inPath = true; break; } }
              if (!inPath) {
                path.push(idx);
                dfs(nr, nc, path, word + grid[idx]);
                path.pop();
              }
            }
          }
        }
        for (var r3 = 0; r3 < sz; r3++) {
          for (var c3 = 0; c3 < sz; c3++) {
            dfs(r3, c3, [r3 * sz + c3], grid[r3 * sz + c3]);
          }
        }

        var result = [];
        for (var key in words) {
          if (words.hasOwnProperty(key)) result.push(words[key]);
        }
        return result;
      }

      function isShuffleAdjacent(a, b) {
        var sz = SHUFFLE_GRID_SIZE;
        var ar = Math.floor(a / sz), ac = a % sz;
        var br = Math.floor(b / sz), bc = b % sz;
        return (Math.abs(ar - br) + Math.abs(ac - bc)) === 1;
      }

      function saveShuffleState() {
        var data = {
          grid: shuffleState.grid,
          score: shuffleState.score,
          foundWords: shuffleState.foundWords,
          foundSet: shuffleState.foundSet,
          totalFound: shuffleState.totalFound,
          combo: shuffleState.combo
        };
        storage.setJSON('lun_shuffle', data);
      }

      function loadShuffleState() {
        var data = storage.getJSON('lun_shuffle');
        if (data && data.grid && data.grid.length === SHUFFLE_GRID_SIZE * SHUFFLE_GRID_SIZE) {
          shuffleState.grid = data.grid;
          shuffleState.score = data.score || 0;
          shuffleState.foundWords = data.foundWords || [];
          shuffleState.foundSet = data.foundSet || {};
          shuffleState.totalFound = data.totalFound || 0;
          shuffleState.combo = data.combo || 0;
        } else {
          shuffleState.grid = generateShuffleGrid();
          shuffleState.score = 0;
          shuffleState.foundWords = [];
          shuffleState.foundSet = {};
          shuffleState.totalFound = 0;
          shuffleState.combo = 0;
        }
      }

      function renderShuffleGrid() {
        var grid = els.shuffleGrid;
        grid.innerHTML = '';
        var frag = document.createDocumentFragment();
        for (var i = 0; i < shuffleState.grid.length; i++) {
          var btn = document.createElement('button');
          btn.className = 'shuffle-tile';
          btn.setAttribute('type', 'button');
          btn.setAttribute('data-idx', i);
          btn.textContent = shuffleState.grid[i];
          if (shuffleState.selected === i) {
            btn.classList.add('shuffle-tile--selected');
          } else if (shuffleState.selected !== null && isShuffleAdjacent(shuffleState.selected, i)) {
            btn.classList.add('shuffle-tile--adjacent');
          }
          frag.appendChild(btn);
        }
        grid.appendChild(frag);
      }

      function renderShuffleStats() {
        els.shuffleScoreBadge.textContent = shuffleState.score.toLocaleString();
        els.shuffleTotalWords.textContent = shuffleState.totalFound;
        if (shuffleState.combo > 1) {
          els.shuffleComboWrap.style.display = '';
          els.shuffleComboCount.textContent = shuffleState.combo;
        } else {
          els.shuffleComboWrap.style.display = 'none';
        }
      }

      function renderShuffleFoundWords() {
        var html = '';
        var recent = shuffleState.foundWords.slice(-SHUFFLE_MAX_FOUND_DISPLAY);
        for (var i = 0; i < recent.length; i++) {
          html += '<span class="shuffle-found-tag">' + recent[i] + '</span>';
        }
        els.shuffleFoundWords.innerHTML = html;
      }

      function handleShuffleTileClick(idx) {
        if (shuffleState.checkLock) return;
        if (shuffleState.selected === null) {
          shuffleState.selected = idx;
        } else if (shuffleState.selected === idx) {
          shuffleState.selected = null;
        } else if (isShuffleAdjacent(shuffleState.selected, idx)) {
          // Swap tiles
          var temp = shuffleState.grid[shuffleState.selected];
          shuffleState.grid[shuffleState.selected] = shuffleState.grid[idx];
          shuffleState.grid[idx] = temp;
          shuffleState.selected = null;
          // Check for new words after swap
          scheduleShuffleCheck();
        } else {
          shuffleState.selected = idx;
        }
        renderShuffleGrid();
      }

      var shuffleCheckTimer = null;
      function scheduleShuffleCheck() {
        if (shuffleCheckTimer) clearTimeout(shuffleCheckTimer);
        shuffleCheckTimer = setTimeout(function() {
          if (shuffleState.checkLock) return;
          var allWords = findShuffleWords(shuffleState.grid);
          var newWords = [];
          for (var i = 0; i < allWords.length; i++) {
            var wl = allWords[i].word.toLowerCase();
            if (!shuffleState.foundSet[wl]) newWords.push(allWords[i]);
          }
          if (newWords.length > 0) {
            // Pick the longest/best word
            var best = newWords[0];
            for (var j = 1; j < newWords.length; j++) {
              if (newWords[j].word.length > best.word.length) best = newWords[j];
            }
            var wordKey = best.word.toLowerCase();
            shuffleState.checkLock = true;

            var multiplier = shuffleState.combo + 1;
            var pts = best.word.length * SHUFFLE_WORD_MULTIPLIER * multiplier;
            shuffleState.score += pts;
            shuffleState.foundWords.push(wordKey);
            if (shuffleState.foundWords.length > SHUFFLE_MAX_FOUND_KEEP) {
              shuffleState.foundWords = shuffleState.foundWords.slice(-SHUFFLE_MAX_FOUND_KEEP);
            }
            shuffleState.foundSet[wordKey] = true;
            shuffleState.totalFound += 1;
            shuffleState.combo += 1;

            if (shuffleState.comboTimer) clearTimeout(shuffleState.comboTimer);
            shuffleState.comboTimer = setTimeout(function() { shuffleState.combo = 0; renderShuffleStats(); }, SHUFFLE_COMBO_TIMEOUT_MS);

            // Highlight tiles
            highlightShuffleTiles(best.path);

            // Show word celebration
            els.shuffleWordFlash.innerHTML = '<span class="shuffle-word-flash-text">\u2605 ' + best.word.toUpperCase() + ' \u2605</span>';

            // Show floating points
            els.shufflePointsFloat.innerHTML = '<span class="shuffle-points-float">+' + pts + '</span>';

            renderShuffleStats();
            renderShuffleFoundWords();
            saveShuffleState();

            // After celebration, replace matched tiles then check again recursively
            setTimeout(function() {
              els.shuffleWordFlash.innerHTML = '<span class="shuffle-word-flash-hint">tap tiles to swap \u00b7 make words</span>';
              els.shufflePointsFloat.innerHTML = '';
              for (var k = 0; k < best.path.length; k++) {
                var pi = best.path[k];
                if (Math.random() < 0.4) {
                  shuffleState.grid[pi] = SHUFFLE_VOWELS.charAt(Math.floor(Math.random() * SHUFFLE_VOWELS.length));
                } else {
                  shuffleState.grid[pi] = SHUFFLE_CONSONANTS.charAt(Math.floor(Math.random() * SHUFFLE_CONSONANTS.length));
                }
              }
              shuffleState.checkLock = false;
              renderShuffleGrid();
              saveShuffleState();
              // Recursively check for more words formed by replacement tiles
              scheduleShuffleCheck();
            }, SHUFFLE_CELEBRATE_MS);
          }
        }, SHUFFLE_CHECK_DELAY_MS);
      }

      function highlightShuffleTiles(path) {
        var tiles = els.shuffleGrid.querySelectorAll('.shuffle-tile');
        for (var i = 0; i < tiles.length; i++) {
          var idx = parseInt(tiles[i].getAttribute('data-idx'), 10);
          var inPath = false;
          for (var j = 0; j < path.length; j++) { if (path[j] === idx) { inPath = true; break; } }
          if (inPath) {
            tiles[i].classList.add('shuffle-tile--highlight');
          }
        }
      }

      function shuffleNewTiles() {
        if (shuffleState.checkLock) return;
        shuffleState.grid = generateShuffleGrid();
        shuffleState.selected = null;
        shuffleState.foundSet = {};
        shuffleState.combo = 0;
        renderShuffleGrid();
        renderShuffleStats();
        saveShuffleState();
        scheduleShuffleCheck();
      }

      function updateShuffleAvailability() {
        if (!els.shuffleWidget) return;
        var phase = state.currentPhase;
        var hasConfirmedPick = !!state.player.confirmedPick;
        var isActive = (phase === 'guessing' && hasConfirmedPick) || phase === 'gathering';

        if (isActive) {
          els.shuffleWidget.classList.remove('shuffle-widget--disabled');
        } else {
          els.shuffleWidget.classList.add('shuffle-widget--disabled');
          // Collapse if open during non-active phase
          if (shuffleState.expanded) {
            shuffleState.expanded = false;
            els.shuffleBody.style.display = 'none';
            els.shuffleWidget.classList.remove('shuffle-widget--expanded');
            els.shuffleToggle.setAttribute('aria-expanded', 'false');
          }
        }
      }

      function toggleShuffleExpand() {
        if (els.shuffleWidget.classList.contains('shuffle-widget--disabled')) return;
        shuffleState.expanded = !shuffleState.expanded;
        if (shuffleState.expanded) {
          els.shuffleBody.style.display = '';
          els.shuffleWidget.classList.add('shuffle-widget--expanded');
          els.shuffleToggle.setAttribute('aria-expanded', 'true');
          renderShuffleGrid();
          renderShuffleFoundWords();
          scheduleShuffleCheck();
        } else {
          els.shuffleBody.style.display = 'none';
          els.shuffleWidget.classList.remove('shuffle-widget--expanded');
          els.shuffleToggle.setAttribute('aria-expanded', 'false');
        }
      }

      function initShuffle() {
        loadShuffleState();
        renderShuffleStats();
        updateShuffleAvailability();

        // Toggle expand/collapse
        els.shuffleToggle.addEventListener('click', toggleShuffleExpand);

        // Tile clicks via event delegation
        els.shuffleGrid.addEventListener('click', function(e) {
          var tile = e.target.closest('.shuffle-tile');
          if (!tile) return;
          var idx = parseInt(tile.getAttribute('data-idx'), 10);
          handleShuffleTileClick(idx);
        });

        // New tiles button
        els.shuffleNewTiles.addEventListener('click', shuffleNewTiles);
      }

      // ─── Onboarding ─────────────────────────────────────────────────
      function setupOnboarding() {
        var overlay = document.getElementById('onboardingOverlay');
        var hintsPanel = document.getElementById('onboardingHints');
        var hintsBtn = document.getElementById('onboardingHintsBtn');
        var tipEl = document.getElementById('onboardingTip');

        document.getElementById('onboardingDismiss').addEventListener('click', function() {
          overlay.style.display = 'none';
          try { localStorage.setItem('lun_onboarded', '1'); } catch (e) {}
        });

        hintsBtn.addEventListener('click', function() {
          var showing = hintsPanel.style.display !== 'none';
          hintsPanel.style.display = showing ? 'none' : '';
          tipEl.style.display = showing ? '' : 'none';
          hintsBtn.textContent = showing ? 'Hints' : 'Hide Hints';
        });

        // ? button in header re-opens overlay
        document.getElementById('btnHelp').addEventListener('click', showOnboarding);

        // Clicking the overlay backdrop dismisses it
        overlay.addEventListener('click', function(e) {
          if (e.target === overlay) {
            overlay.style.display = 'none';
            try { localStorage.setItem('lun_onboarded', '1'); } catch (e2) {}
          }
        });
      }

      function showOnboarding() {
        var overlay = document.getElementById('onboardingOverlay');
        // Reset hints to hidden each time
        document.getElementById('onboardingHints').style.display = 'none';
        document.getElementById('onboardingTip').style.display = '';
        document.getElementById('onboardingHintsBtn').textContent = 'Hints';
        overlay.style.display = '';
      }

      // ─── Theme Toggle ───────────────────────────────────────────────
      function setupThemeToggle() {
        var btnTheme = document.getElementById('btnTheme');
        var html = document.documentElement;

        // Restore saved preference
        try {
          var saved = localStorage.getItem('lun_theme');
          if (saved === 'dark') {
            html.setAttribute('data-theme', 'dark');
            btnTheme.textContent = '\u2600\ufe0f'; // sun
          }
        } catch (e) {}

        btnTheme.addEventListener('click', function() {
          var isDark = html.getAttribute('data-theme') === 'dark';
          if (isDark) {
            html.removeAttribute('data-theme');
            btnTheme.textContent = '\ud83c\udf19'; // moon
            try { localStorage.setItem('lun_theme', 'light'); } catch (e) {}
          } else {
            html.setAttribute('data-theme', 'dark');
            btnTheme.textContent = '\u2600\ufe0f'; // sun
            try { localStorage.setItem('lun_theme', 'dark'); } catch (e) {}
          }
        });
      }

      // Boot
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', init);
      } else {
        init();
      }

    })();
  </script>
</body>
</html>
