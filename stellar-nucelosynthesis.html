<!DOCTYPE html>
<html lang="en" data-theme="dark" data-version="0.1.0">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="description" content="Interactive stellar nucleosynthesis simulation — watch elements form as stars evolve">
  <meta name="theme-color" content="#0f172a">
  <title>Stellar Nucleosynthesis Simulator</title>
  <style>
    /* === CSS Reset === */
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html { -webkit-text-size-adjust: 100%; text-size-adjust: 100%; }
    body { min-height: 100dvh; line-height: 1.5; -webkit-font-smoothing: antialiased; }
    img, canvas, svg { display: block; max-width: 100%; }
    button, input, select { font: inherit; }
    p, h1, h2, h3, h4 { overflow-wrap: break-word; }

    /* === CSS Custom Properties === */
    :root {
      /* Spacing scale */
      --space-1: 0.25rem; --space-2: 0.5rem; --space-3: 0.75rem;
      --space-4: 1rem; --space-5: 1.25rem; --space-6: 1.5rem;
      --space-8: 2rem; --space-10: 2.5rem; --space-12: 3rem;

      /* Font sizes */
      --fs-xs: clamp(0.625rem, 0.6rem + 0.15vw, 0.75rem);
      --fs-sm: clamp(0.75rem, 0.7rem + 0.2vw, 0.875rem);
      --fs-base: clamp(0.875rem, 0.8rem + 0.3vw, 1rem);
      --fs-lg: clamp(1rem, 0.9rem + 0.4vw, 1.25rem);
      --fs-xl: clamp(1.25rem, 1.1rem + 0.5vw, 1.5rem);
      --fs-2xl: clamp(1.5rem, 1.3rem + 0.7vw, 2rem);

      /* Radii */
      --radius-sm: 4px; --radius-md: 8px; --radius-lg: 12px; --radius-xl: 16px;

      /* Transitions */
      --transition-fast: 0.15s ease; --transition-base: 0.25s ease; --transition-slow: 0.4s ease;

      /* Process colors — nucleosynthesis */
      --color-bigbang: #9CA3AF;
      --color-ppchain: #FBBF24;
      --color-cno: #F59E0B;
      --color-triplealpha: #EF4444;
      --color-alphacapture: #DC2626;
      --color-cburn: #F97316;
      --color-neburn: #FB923C;
      --color-oburn: #A855F7;
      --color-siburn: #6366F1;
      --color-sprocess: #22D3EE;
      --color-rprocess: #EC4899;
      --color-pprocess: #F472B6;
      --color-spallation: #78716C;

      /* Z-index layers */
      --z-base: 1; --z-overlay: 100; --z-modal: 200; --z-toast: 300;
    }

    /* Dark theme (default) */
    [data-theme="dark"] {
      --bg-primary: #0f172a; --bg-secondary: #1e293b; --bg-tertiary: #334155;
      --bg-surface: #1e293b; --bg-elevated: #273549;
      --text-primary: #f1f5f9; --text-secondary: #94a3b8; --text-muted: #64748b;
      --border-color: #334155; --border-subtle: #1e293b;
      --accent: #3b82f6; --accent-hover: #60a5fa;
      --success: #22c55e; --warning: #f59e0b; --error: #ef4444;
      --element-dormant-bg: #1e293b; --element-dormant-text: #475569;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.4); --shadow-md: 0 4px 12px rgba(0,0,0,0.5);
      --shadow-lg: 0 8px 24px rgba(0,0,0,0.6);
      --glow: 0 0 20px rgba(59,130,246,0.3);
    }

    /* Light theme */
    [data-theme="light"] {
      --bg-primary: #f8fafc; --bg-secondary: #f1f5f9; --bg-tertiary: #e2e8f0;
      --bg-surface: #ffffff; --bg-elevated: #ffffff;
      --text-primary: #0f172a; --text-secondary: #475569; --text-muted: #94a3b8;
      --border-color: #e2e8f0; --border-subtle: #f1f5f9;
      --accent: #2563eb; --accent-hover: #3b82f6;
      --success: #16a34a; --warning: #d97706; --error: #dc2626;
      --element-dormant-bg: #f1f5f9; --element-dormant-text: #94a3b8;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.1); --shadow-md: 0 4px 12px rgba(0,0,0,0.1);
      --shadow-lg: 0 8px 24px rgba(0,0,0,0.15);
      --glow: 0 0 20px rgba(37,99,235,0.2);
    }

    /* Theme transition */
    [data-theme] { transition: background-color var(--transition-slow), color var(--transition-slow); }

    /* === Base Styles === */
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
      background: var(--bg-primary); color: var(--text-primary); font-size: var(--fs-base);
      overflow-x: hidden;
    }

    /* === Skip Link === */
    .skip-link {
      position: absolute; top: -100%; left: var(--space-4); z-index: var(--z-modal);
      padding: var(--space-2) var(--space-4); background: var(--accent); color: #fff;
      border-radius: var(--radius-md); text-decoration: none; font-weight: 600;
    }
    .skip-link:focus { top: var(--space-2); }

    /* === App Layout === */
    .app { display: flex; flex-direction: column; min-height: 100dvh; }

    .app-header {
      display: flex; flex-wrap: wrap; align-items: center; gap: var(--space-2);
      padding: var(--space-1) var(--space-3);
      background: var(--bg-secondary); border-bottom: 1px solid var(--border-color);
      position: sticky; top: 0; z-index: var(--z-overlay);
    }
    .app-header h1 {
      font-size: var(--fs-base); font-weight: 700; white-space: nowrap;
      background: linear-gradient(135deg, #fbbf24, #ef4444, #a855f7, #3b82f6);
      -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;
    }
    .header-controls { display: flex; align-items: center; gap: var(--space-1); margin-inline-start: auto; }

    /* === Main Content Grid === */
    .app-main {
      flex: 1; display: grid; gap: var(--space-2); padding: var(--space-2);
      grid-template-columns: 1fr;
      grid-template-areas:
        "mass"
        "star"
        "info"
        "table"
        "timeline"
        "summary";
    }

    @media (min-width: 1024px) {
      .app-main {
        grid-template-columns: 1fr 1fr;
        grid-template-areas:
          "mass     mass"
          "star     info"
          "timeline timeline"
          "table    table"
          "summary  summary";
        gap: var(--space-2);
        padding: var(--space-2) var(--space-3);
      }
    }

    @media (min-width: 1400px) {
      .app-main {
        grid-template-columns: 1fr 1.2fr 0.8fr;
        grid-template-areas:
          "mass     mass     mass"
          "star     info     info"
          "timeline timeline timeline"
          "table    table    table"
          "summary  summary  summary";
      }
    }

    .mass-section { grid-area: mass; }
    .star-section { grid-area: star; }
    .info-section { grid-area: info; }
    .table-section { grid-area: table; }
    .timeline-section { grid-area: timeline; }
    .summary-section { grid-area: summary; }

    /* === Panel Styling === */
    .panel {
      background: var(--bg-surface); border: 1px solid var(--border-color);
      border-radius: var(--radius-md); padding: var(--space-2) var(--space-3);
      box-shadow: var(--shadow-sm);
    }
    .panel-title {
      font-size: var(--fs-sm); font-weight: 600; margin-block-end: var(--space-1);
      color: var(--text-primary); text-transform: uppercase; letter-spacing: 0.04em;
    }

    /* === Buttons === */
    .btn {
      display: inline-flex; align-items: center; justify-content: center; gap: var(--space-1);
      padding: var(--space-1) var(--space-2); border: 1px solid var(--border-color);
      border-radius: var(--radius-sm); background: var(--bg-tertiary); color: var(--text-primary);
      cursor: pointer; font-size: var(--fs-sm); font-weight: 500;
      transition: background var(--transition-fast), border-color var(--transition-fast),
                  box-shadow var(--transition-fast);
      min-height: 28px; min-width: 28px;
    }
    .btn:hover { background: var(--bg-elevated); border-color: var(--accent); }
    .btn:focus-visible { outline: 2px solid var(--accent); outline-offset: 2px; }
    .btn:active { transform: scale(0.97); }
    .btn--primary { background: var(--accent); color: #fff; border-color: var(--accent); }
    .btn--primary:hover { background: var(--accent-hover); }
    .btn--sm { padding: 2px var(--space-1); font-size: var(--fs-xs); min-height: 22px; }
    .btn--active { background: var(--accent); color: #fff; border-color: var(--accent); }
    .btn--icon { padding: var(--space-1); }

    /* === Mass Selector === */
    .mass-selector {
      display: flex; flex-wrap: wrap; align-items: center; gap: var(--space-2);
    }
    .mass-selector label { font-weight: 600; font-size: var(--fs-xs); white-space: nowrap; text-transform: uppercase; letter-spacing: 0.04em; color: var(--text-muted); }
    .mass-slider-wrap { flex: 1; min-width: 150px; display: flex; align-items: center; gap: var(--space-1); }
    .mass-slider {
      flex: 1; height: 4px; -webkit-appearance: none; appearance: none;
      background: var(--bg-tertiary); border-radius: 2px; outline: none;
    }
    .mass-slider::-webkit-slider-thumb {
      -webkit-appearance: none; width: 16px; height: 16px; border-radius: 50%;
      background: var(--accent); cursor: pointer; border: 2px solid var(--bg-primary);
    }
    .mass-slider::-moz-range-thumb {
      width: 16px; height: 16px; border-radius: 50%;
      background: var(--accent); cursor: pointer; border: 2px solid var(--bg-primary);
    }
    .mass-slider:focus-visible { box-shadow: 0 0 0 3px rgba(59,130,246,0.4); }
    .mass-value {
      font-weight: 700; font-size: var(--fs-base); min-width: 6ch; text-align: center;
      font-variant-numeric: tabular-nums;
    }
    .mass-presets { display: flex; flex-wrap: wrap; gap: 2px; }
    .star-class-label {
      font-size: var(--fs-xs); color: var(--text-secondary); font-style: italic;
    }

    /* === Star Visualization === */
    .star-canvas-wrap {
      position: relative; width: 100%; aspect-ratio: 4/3;
      max-height: 260px; display: flex; align-items: center; justify-content: center;
    }
    .star-canvas-wrap canvas {
      width: 100%; height: 100%; border-radius: var(--radius-sm);
    }
    .star-view-toggle {
      position: absolute; bottom: var(--space-1); right: var(--space-1);
      display: flex; gap: 2px;
    }
    .star-sr-desc { position: absolute; width: 1px; height: 1px; overflow: hidden; clip: rect(0,0,0,0); }

    /* === Info Panel === */
    .info-content { display: flex; flex-direction: column; gap: var(--space-1); }
    .info-stage-name { font-size: var(--fs-lg); font-weight: 700; line-height: 1.2; }
    .info-stats {
      display: grid; grid-template-columns: repeat(3, 1fr);
      gap: var(--space-1);
    }
    .info-stat {
      padding: var(--space-1); background: var(--bg-secondary); border-radius: var(--radius-sm);
    }
    .info-stat-label { font-size: clamp(0.55rem, 0.8vw, 0.65rem); color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.05em; }
    .info-stat-value { font-size: var(--fs-sm); font-weight: 600; font-variant-numeric: tabular-nums; }
    .info-reactions { font-family: 'Courier New', monospace; font-size: var(--fs-xs); }
    .info-reactions li { padding: 1px 0; list-style: none; }
    .info-description { color: var(--text-secondary); font-size: var(--fs-xs); line-height: 1.5; }
    .info-details-toggle {
      background: none; border: 1px solid var(--border-color); color: var(--text-secondary);
      padding: var(--space-1) var(--space-2); border-radius: var(--radius-sm);
      cursor: pointer; font-size: var(--fs-xs); text-align: left; width: 100%;
      transition: background var(--transition-fast);
    }
    .info-details-toggle:hover { background: var(--bg-secondary); }
    .info-details-content {
      overflow: hidden; max-height: 0; transition: max-height var(--transition-slow);
      font-size: var(--fs-xs); color: var(--text-secondary); line-height: 1.5;
    }
    .info-details-content.open { max-height: 400px; padding-top: var(--space-1); }

    /* === Periodic Table === */
    .periodic-table-wrap { overflow-x: auto; -webkit-overflow-scrolling: touch; padding-block-end: 0; }
    .periodic-table {
      display: grid; grid-template-columns: repeat(18, minmax(0, 1fr));
      gap: 1px; min-width: 600px; width: 100%;
    }
    .element-cell {
      aspect-ratio: 1; display: flex; flex-direction: column; align-items: center;
      justify-content: center; border-radius: 2px;
      background: var(--element-dormant-bg); color: var(--element-dormant-text);
      border: 1px solid transparent; cursor: pointer;
      transition: background var(--transition-fast), color var(--transition-fast),
                  border-color var(--transition-fast), box-shadow var(--transition-fast),
                  transform var(--transition-fast);
      position: relative; overflow: hidden; padding: 0;
      font-variant-numeric: tabular-nums;
    }
    .element-cell:hover { transform: scale(1.2); z-index: 2; box-shadow: var(--shadow-md); }
    .element-cell:focus-visible { outline: 2px solid var(--accent); outline-offset: 1px; z-index: 2; }
    .element-cell .z { font-size: clamp(0.4rem, 0.7vw, 0.6rem); line-height: 1; opacity: 0.7; }
    .element-cell .symbol { font-size: clamp(0.55rem, 1vw, 0.8rem); font-weight: 700; line-height: 1; }
    .element-cell .name { display: none; }

    /* Element states */
    .element-cell[data-state="formed"] {
      color: #fff; border-color: rgba(255,255,255,0.15);
    }
    .element-cell[data-state="active"] {
      color: #fff; border-color: rgba(255,255,255,0.3);
      animation: elementPulse 1.5s ease-in-out infinite;
    }
    @keyframes elementPulse {
      0%, 100% { box-shadow: 0 0 4px rgba(255,255,255,0.2); }
      50% { box-shadow: 0 0 12px rgba(255,255,255,0.5); }
    }

    /* Placeholder spacer cells */
    .element-spacer { visibility: hidden; }

    /* Lanthanide/Actinide gap indicator */
    .pt-gap { grid-column: 1 / -1; height: 4px; }
    .pt-label {
      font-size: var(--fs-xs); color: var(--text-muted);
      display: flex; align-items: center; justify-content: center;
    }

    /* Process legend */
    .process-legend {
      display: flex; flex-wrap: wrap; gap: var(--space-1) var(--space-2); margin-block-start: var(--space-1);
      font-size: clamp(0.55rem, 0.7vw, 0.65rem);
    }
    .legend-item { display: flex; align-items: center; gap: 3px; }
    .legend-swatch {
      width: 8px; height: 8px; border-radius: 1px; flex-shrink: 0;
    }

    /* === Timeline === */
    .timeline-controls {
      display: flex; flex-wrap: wrap; align-items: center; gap: var(--space-1) var(--space-2);
    }
    .playback-btns { display: flex; gap: 2px; }
    .speed-btns { display: flex; gap: 2px; }
    .timeline-bar-wrap { flex: 1; min-width: 150px; }
    .timeline-bar {
      width: 100%; height: 24px; position: relative; background: var(--bg-tertiary);
      border-radius: var(--radius-sm); overflow: hidden; cursor: pointer;
    }
    .timeline-progress {
      height: 100%; background: linear-gradient(90deg, var(--color-ppchain), var(--color-triplealpha), var(--color-siburn), var(--color-rprocess));
      border-radius: var(--radius-md); transition: width 0.1s linear; width: 0%;
    }
    .timeline-stages {
      position: absolute; top: 0; left: 0; right: 0; bottom: 0;
      display: flex; pointer-events: none;
    }
    .timeline-stage-seg {
      flex: 1; display: flex; align-items: center; justify-content: center;
      font-size: var(--fs-xs); color: rgba(255,255,255,0.7); font-weight: 500;
      border-right: 1px solid rgba(255,255,255,0.1);
      white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
      padding: 0 2px;
    }
    .timeline-stage-seg:last-child { border-right: none; }
    .timeline-time {
      font-size: var(--fs-sm); color: var(--text-secondary); white-space: nowrap;
      font-variant-numeric: tabular-nums;
    }

    /* === Stage Summary === */
    .stage-cards { display: flex; flex-direction: column; gap: 2px; }
    .stage-card {
      background: var(--bg-secondary); border: 1px solid var(--border-color);
      border-radius: var(--radius-sm); overflow: hidden;
    }
    .stage-card-header {
      display: flex; align-items: center; gap: var(--space-1);
      padding: var(--space-1) var(--space-2); cursor: pointer;
      transition: background var(--transition-fast);
    }
    .stage-card-header:hover { background: var(--bg-tertiary); }
    .stage-card-dot { width: 8px; height: 8px; border-radius: 50%; flex-shrink: 0; }
    .stage-card-name { font-weight: 600; font-size: var(--fs-xs); }
    .stage-card-meta { margin-inline-start: auto; font-size: clamp(0.55rem,0.7vw,0.65rem); color: var(--text-muted); }
    .stage-card-body {
      max-height: 0; overflow: hidden; transition: max-height var(--transition-slow);
      font-size: var(--fs-xs); color: var(--text-secondary); line-height: 1.5;
    }
    .stage-card-body.open { max-height: 250px; padding: 0 var(--space-2) var(--space-2); }
    .stage-card--locked { opacity: 0.4; }
    .stage-card--complete .stage-card-dot { box-shadow: 0 0 6px currentColor; }

    /* === Element Detail Overlay === */
    .element-detail {
      position: fixed; inset: 0; z-index: var(--z-modal);
      display: flex; align-items: center; justify-content: center;
      background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
      opacity: 0; pointer-events: none; transition: opacity var(--transition-base);
    }
    .element-detail.open { opacity: 1; pointer-events: auto; }
    .element-detail-card {
      background: var(--bg-surface); border: 1px solid var(--border-color);
      border-radius: var(--radius-xl); padding: var(--space-6);
      max-width: 420px; width: 90%; box-shadow: var(--shadow-lg);
      max-height: 80dvh; overflow-y: auto;
    }
    .element-detail-header { display: flex; align-items: flex-start; gap: var(--space-4); margin-block-end: var(--space-4); }
    .element-detail-symbol {
      font-size: var(--fs-2xl); font-weight: 800; width: 64px; height: 64px;
      display: flex; align-items: center; justify-content: center;
      border-radius: var(--radius-md); color: #fff;
    }
    .element-detail-close {
      position: absolute; top: var(--space-3); right: var(--space-3);
      background: none; border: none; color: var(--text-muted); cursor: pointer;
      font-size: var(--fs-xl); line-height: 1; padding: var(--space-1);
    }
    .element-detail-close:hover { color: var(--text-primary); }

    /* === Toast === */
    .toast-container {
      position: fixed; bottom: var(--space-4); right: var(--space-4); z-index: var(--z-toast);
      display: flex; flex-direction: column-reverse; gap: var(--space-2);
    }
    .toast {
      padding: var(--space-3) var(--space-4); background: var(--bg-elevated);
      border: 1px solid var(--border-color); border-radius: var(--radius-md);
      box-shadow: var(--shadow-md); font-size: var(--fs-sm);
      animation: toastIn 0.3s ease; min-width: 200px;
    }
    @keyframes toastIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    /* === Keyboard Shortcut Help === */
    .help-overlay {
      position: fixed; inset: 0; z-index: var(--z-modal);
      display: flex; align-items: center; justify-content: center;
      background: rgba(0,0,0,0.6); backdrop-filter: blur(4px);
      opacity: 0; pointer-events: none; transition: opacity var(--transition-base);
    }
    .help-overlay.open { opacity: 1; pointer-events: auto; }
    .help-card {
      background: var(--bg-surface); border: 1px solid var(--border-color);
      border-radius: var(--radius-xl); padding: var(--space-6);
      max-width: 480px; width: 90%; box-shadow: var(--shadow-lg);
    }
    .help-card h2 { margin-block-end: var(--space-4); }
    .help-row { display: flex; justify-content: space-between; padding: var(--space-1) 0; font-size: var(--fs-sm); }
    .help-key {
      display: inline-block; padding: 2px 8px; background: var(--bg-tertiary);
      border: 1px solid var(--border-color); border-radius: var(--radius-sm);
      font-family: monospace; font-size: var(--fs-xs);
    }

    /* === Accessibility === */
    .sr-only { position: absolute; width: 1px; height: 1px; overflow: hidden; clip: rect(0,0,0,0); white-space: nowrap; border: 0; }
    @media (prefers-reduced-motion: reduce) {
      *, *::before, *::after { animation-duration: 0.01ms !important; transition-duration: 0.01ms !important; }
    }
    @media (prefers-contrast: more) {
      :root { --border-color: #888; }
      .element-cell { border-width: 2px; }
    }

    /* === Print === */
    @media print {
      .app-header, .timeline-section, .mass-section, .star-view-toggle, .btn { display: none; }
      body { background: #fff; color: #000; }
      .panel { box-shadow: none; border: 1px solid #ccc; }
      .element-cell { print-color-adjust: exact; -webkit-print-color-adjust: exact; }
    }

    /* === Supernova flash === */
    @keyframes supernovaFlash {
      0% { opacity: 0; } 10% { opacity: 1; } 100% { opacity: 0; }
    }
    .supernova-flash {
      position: fixed; inset: 0; background: #fff; z-index: var(--z-overlay);
      pointer-events: none; opacity: 0;
    }
    .supernova-flash.active { animation: supernovaFlash 1.5s ease-out; }

    /* === Scrollbar styling === */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: var(--bg-secondary); }
    ::-webkit-scrollbar-thumb { background: var(--bg-tertiary); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-muted); }
  </style>
</head>
<body>
  <a href="#main-content" class="skip-link">Skip to main content</a>

  <div class="app">
    <!-- Header -->
    <header class="app-header" role="banner">
      <h1>Stellar Nucleosynthesis</h1>
      <div class="header-controls">
        <button class="btn btn--sm" id="lang-toggle" aria-label="Switch between standard and technical descriptions" title="Toggle description level">
          <span id="lang-icon">&#9733;</span> <span id="lang-label">Standard</span>
        </button>
        <button class="btn btn--icon" id="theme-toggle" aria-label="Toggle dark/light theme" title="Toggle theme">
          <span id="theme-icon">&#9790;</span>
        </button>
        <button class="btn btn--icon" id="help-toggle" aria-label="Keyboard shortcuts" title="Keyboard shortcuts (?)">?</button>
      </div>
    </header>

    <!-- Main Content -->
    <main class="app-main" id="main-content">

      <!-- Mass Selector -->
      <section class="mass-section panel" aria-label="Star mass selection">
        <div class="mass-selector">
          <label for="mass-slider">Star Mass</label>
          <div class="mass-slider-wrap">
            <span class="mass-label-min" aria-hidden="true">0.08</span>
            <input type="range" id="mass-slider" class="mass-slider" min="0" max="100" value="50" step="0.1"
                   aria-valuemin="0.08" aria-valuemax="150" aria-valuenow="1" aria-valuetext="1.0 solar masses">
            <span class="mass-label-max" aria-hidden="true">150</span>
          </div>
          <output class="mass-value" id="mass-value" for="mass-slider">1.0 M&#9737;</output>
          <span class="star-class-label" id="star-class">Sun-like Star</span>
        </div>
        <div class="mass-presets" role="group" aria-label="Star mass presets">
          <button class="btn btn--sm" data-mass="0.3">Red Dwarf</button>
          <button class="btn btn--sm" data-mass="1.0">Sun-like</button>
          <button class="btn btn--sm" data-mass="5.0">Giant</button>
          <button class="btn btn--sm" data-mass="15.0">Massive</button>
          <button class="btn btn--sm" data-mass="40.0">Supergiant</button>
        </div>
      </section>

      <!-- Star Visualization -->
      <section class="star-section panel" aria-label="Star visualization">
        <div class="star-canvas-wrap">
          <canvas id="star-canvas" aria-hidden="true"></canvas>
          <div class="star-sr-desc" id="star-desc" role="img" aria-live="polite">Star visualization: a yellow main-sequence star</div>
          <div class="star-view-toggle">
            <button class="btn btn--sm btn--active" id="view-external" aria-pressed="true">External</button>
            <button class="btn btn--sm" id="view-shell" aria-pressed="false">Cross-section</button>
          </div>
        </div>
      </section>

      <!-- Info Panel -->
      <section class="info-section panel" aria-label="Stage information">
        <div class="info-content">
          <div class="info-stage-name" id="info-stage-name">Pre-simulation</div>
          <div class="info-stats" id="info-stats">
            <div class="info-stat">
              <div class="info-stat-label">Core Temp</div>
              <div class="info-stat-value" id="info-temp">--</div>
            </div>
            <div class="info-stat">
              <div class="info-stat-label">Core Density</div>
              <div class="info-stat-value" id="info-density">--</div>
            </div>
            <div class="info-stat">
              <div class="info-stat-label">Stage Duration</div>
              <div class="info-stat-value" id="info-duration">--</div>
            </div>
          </div>
          <div id="info-reactions-wrap">
            <div class="info-stat-label">Key Reactions</div>
            <ul class="info-reactions" id="info-reactions" aria-label="Nuclear reactions"></ul>
          </div>
          <p class="info-description" id="info-desc">Select a star mass and press Play to begin the simulation.</p>
          <button class="info-details-toggle" id="details-toggle" aria-expanded="false" aria-controls="details-content">
            &#9660; <span id="details-toggle-text">Learn More</span>
          </button>
          <div class="info-details-content" id="details-content" role="region" aria-label="Detailed physics">
          </div>
        </div>
      </section>

      <!-- Periodic Table -->
      <section class="table-section panel" aria-label="Periodic table">
        <h2 class="panel-title">Periodic Table of Elements</h2>
        <div class="periodic-table-wrap">
          <div class="periodic-table" id="periodic-table" role="grid" aria-label="Periodic table showing nucleosynthesis origins">
            <!-- Generated by JavaScript -->
          </div>
        </div>
        <div class="process-legend" id="process-legend" aria-label="Nucleosynthesis process legend">
          <!-- Generated by JavaScript -->
        </div>
      </section>

      <!-- Timeline -->
      <section class="timeline-section panel" aria-label="Simulation timeline">
        <div class="timeline-controls">
          <div class="playback-btns" role="group" aria-label="Playback controls">
            <button class="btn btn--icon" id="btn-reset" aria-label="Reset" title="Reset">&#9632;</button>
            <button class="btn btn--icon btn--primary" id="btn-play" aria-label="Play" title="Play (Space)">&#9654;</button>
          </div>
          <div class="speed-btns" role="group" aria-label="Playback speed">
            <button class="btn btn--sm" data-speed="0.5">0.5x</button>
            <button class="btn btn--sm btn--active" data-speed="1">1x</button>
            <button class="btn btn--sm" data-speed="2">2x</button>
            <button class="btn btn--sm" data-speed="5">5x</button>
          </div>
          <div class="timeline-bar-wrap">
            <div class="timeline-bar" id="timeline-bar" role="slider" aria-label="Simulation progress"
                 aria-valuemin="0" aria-valuemax="100" aria-valuenow="0" tabindex="0">
              <div class="timeline-progress" id="timeline-progress"></div>
              <div class="timeline-stages" id="timeline-stages"></div>
            </div>
          </div>
          <div class="timeline-time" id="timeline-time" aria-live="polite">
            <span id="time-real">--</span>
          </div>
        </div>
      </section>

      <!-- Stage Summary -->
      <section class="summary-section panel" aria-label="Stage summary">
        <h2 class="panel-title">Evolution Summary</h2>
        <div class="stage-cards" id="stage-cards">
          <!-- Generated by JavaScript -->
        </div>
      </section>
    </main>
  </div>

  <!-- Element Detail Overlay -->
  <div class="element-detail" id="element-detail" role="dialog" aria-modal="true" aria-label="Element details">
    <div class="element-detail-card" id="element-detail-card">
      <button class="element-detail-close" id="element-detail-close" aria-label="Close">&times;</button>
      <div id="element-detail-body"></div>
    </div>
  </div>

  <!-- Keyboard Help Overlay -->
  <div class="help-overlay" id="help-overlay" role="dialog" aria-modal="true" aria-label="Keyboard shortcuts">
    <div class="help-card">
      <h2>Keyboard Shortcuts</h2>
      <div class="help-row"><span>Play / Pause</span><span class="help-key">Space</span></div>
      <div class="help-row"><span>Step backward</span><span class="help-key">&larr;</span></div>
      <div class="help-row"><span>Step forward</span><span class="help-key">&rarr;</span></div>
      <div class="help-row"><span>Speed up</span><span class="help-key">+</span></div>
      <div class="help-row"><span>Slow down</span><span class="help-key">-</span></div>
      <div class="help-row"><span>Toggle view</span><span class="help-key">V</span></div>
      <div class="help-row"><span>Jump to stage</span><span class="help-key">1-7</span></div>
      <div class="help-row"><span>Reset</span><span class="help-key">R</span></div>
      <div class="help-row"><span>Toggle theme</span><span class="help-key">T</span></div>
      <div class="help-row"><span>Standard / Technical</span><span class="help-key">L</span></div>
      <div class="help-row"><span>Close / dismiss</span><span class="help-key">Esc</span></div>
      <div class="help-row"><span>This help</span><span class="help-key">?</span></div>
      <button class="btn" id="help-close" style="margin-top:var(--space-4);width:100;">Close</button>
    </div>
  </div>

  <!-- Supernova Flash Effect -->
  <div class="supernova-flash" id="supernova-flash"></div>

  <!-- Toast Container -->
  <div class="toast-container" id="toast-container" aria-live="polite"></div>

  <script>
    'use strict';
    // ============================================================
    // STELLAR NUCLEOSYNTHESIS SIMULATOR
    // ============================================================

    // ============================================================
    // DATA LAYER — Elements, Processes, Stages
    // ============================================================

    // Process IDs and colors
    const PROCESSES = {
      bigbang:      { id: 'bigbang',      name: 'Big Bang Nucleosynthesis', color: '#9CA3AF', abbr: 'BB' },
      ppchain:      { id: 'ppchain',      name: 'pp-Chain',                 color: '#FBBF24', abbr: 'pp' },
      cno:          { id: 'cno',          name: 'CNO Cycle',                color: '#F59E0B', abbr: 'CNO' },
      triplealpha:  { id: 'triplealpha',  name: 'Triple-Alpha Process',     color: '#EF4444', abbr: '3\u03B1' },
      alphacapture: { id: 'alphacapture', name: 'Alpha Capture',            color: '#DC2626', abbr: '\u03B1-cap' },
      cburn:        { id: 'cburn',        name: 'Carbon Burning',           color: '#F97316', abbr: 'C' },
      neburn:       { id: 'neburn',       name: 'Neon Burning',             color: '#FB923C', abbr: 'Ne' },
      oburn:        { id: 'oburn',        name: 'Oxygen Burning',           color: '#A855F7', abbr: 'O' },
      siburn:       { id: 'siburn',       name: 'Silicon Burning',          color: '#6366F1', abbr: 'Si' },
      sprocess:     { id: 'sprocess',     name: 's-Process (Slow Neutron Capture)', color: '#22D3EE', abbr: 's' },
      rprocess:     { id: 'rprocess',     name: 'r-Process (Rapid Neutron Capture)', color: '#EC4899', abbr: 'r' },
      pprocess:     { id: 'pprocess',     name: 'p-Process (Proton Capture)', color: '#F472B6', abbr: 'p' },
      spallation:   { id: 'spallation',   name: 'Cosmic Ray Spallation',    color: '#78716C', abbr: 'CR' },
    };

    // Full 118-element database
    // [Z, symbol, name, atomicMass, row, col, primaryProcess]
    // row/col = periodic table grid position (1-indexed)
    // Lanthanides: row 9, Actinides: row 10
    const ELEMENTS_RAW = [
      [1,'H','Hydrogen',1.008,1,1,'bigbang'],
      [2,'He','Helium',4.003,1,18,'bigbang'],
      [3,'Li','Lithium',6.941,2,1,'spallation'],
      [4,'Be','Beryllium',9.012,2,2,'spallation'],
      [5,'B','Boron',10.81,2,13,'spallation'],
      [6,'C','Carbon',12.011,2,14,'triplealpha'],
      [7,'N','Nitrogen',14.007,2,15,'cno'],
      [8,'O','Oxygen',15.999,2,16,'alphacapture'],
      [9,'F','Fluorine',18.998,2,17,'cno'],
      [10,'Ne','Neon',20.180,2,18,'cburn'],
      [11,'Na','Sodium',22.990,3,1,'cburn'],
      [12,'Mg','Magnesium',24.305,3,2,'cburn'],
      [13,'Al','Aluminium',26.982,3,13,'cburn'],
      [14,'Si','Silicon',28.086,3,14,'oburn'],
      [15,'P','Phosphorus',30.974,3,15,'oburn'],
      [16,'S','Sulfur',32.065,3,16,'oburn'],
      [17,'Cl','Chlorine',35.453,3,17,'oburn'],
      [18,'Ar','Argon',39.948,3,18,'oburn'],
      [19,'K','Potassium',39.098,4,1,'oburn'],
      [20,'Ca','Calcium',40.078,4,2,'oburn'],
      [21,'Sc','Scandium',44.956,4,3,'siburn'],
      [22,'Ti','Titanium',47.867,4,4,'siburn'],
      [23,'V','Vanadium',50.942,4,5,'siburn'],
      [24,'Cr','Chromium',51.996,4,6,'siburn'],
      [25,'Mn','Manganese',54.938,4,7,'siburn'],
      [26,'Fe','Iron',55.845,4,8,'siburn'],
      [27,'Co','Cobalt',58.933,4,9,'siburn'],
      [28,'Ni','Nickel',58.693,4,10,'siburn'],
      [29,'Cu','Copper',63.546,4,11,'sprocess'],
      [30,'Zn','Zinc',65.38,4,12,'sprocess'],
      [31,'Ga','Gallium',69.723,4,13,'sprocess'],
      [32,'Ge','Germanium',72.630,4,14,'sprocess'],
      [33,'As','Arsenic',74.922,4,15,'rprocess'],
      [34,'Se','Selenium',78.971,4,16,'rprocess'],
      [35,'Br','Bromine',79.904,4,17,'rprocess'],
      [36,'Kr','Krypton',83.798,4,18,'sprocess'],
      [37,'Rb','Rubidium',85.468,5,1,'sprocess'],
      [38,'Sr','Strontium',87.62,5,2,'sprocess'],
      [39,'Y','Yttrium',88.906,5,3,'sprocess'],
      [40,'Zr','Zirconium',91.224,5,4,'sprocess'],
      [41,'Nb','Niobium',92.906,5,5,'sprocess'],
      [42,'Mo','Molybdenum',95.95,5,6,'sprocess'],
      [43,'Tc','Technetium',98,5,7,'sprocess'],
      [44,'Ru','Ruthenium',101.07,5,8,'rprocess'],
      [45,'Rh','Rhodium',102.91,5,9,'rprocess'],
      [46,'Pd','Palladium',106.42,5,10,'sprocess'],
      [47,'Ag','Silver',107.87,5,11,'rprocess'],
      [48,'Cd','Cadmium',112.41,5,12,'sprocess'],
      [49,'In','Indium',114.82,5,13,'sprocess'],
      [50,'Sn','Tin',118.71,5,14,'sprocess'],
      [51,'Sb','Antimony',121.76,5,15,'sprocess'],
      [52,'Te','Tellurium',127.60,5,16,'rprocess'],
      [53,'I','Iodine',126.90,5,17,'rprocess'],
      [54,'Xe','Xenon',131.29,5,18,'sprocess'],
      [55,'Cs','Caesium',132.91,6,1,'sprocess'],
      [56,'Ba','Barium',137.33,6,2,'sprocess'],
      [57,'La','Lanthanum',138.91,9,3,'sprocess'],
      [58,'Ce','Cerium',140.12,9,4,'sprocess'],
      [59,'Pr','Praseodymium',140.91,9,5,'sprocess'],
      [60,'Nd','Neodymium',144.24,9,6,'sprocess'],
      [61,'Pm','Promethium',145,9,7,'rprocess'],
      [62,'Sm','Samarium',150.36,9,8,'rprocess'],
      [63,'Eu','Europium',151.96,9,9,'rprocess'],
      [64,'Gd','Gadolinium',157.25,9,10,'rprocess'],
      [65,'Tb','Terbium',158.93,9,11,'rprocess'],
      [66,'Dy','Dysprosium',162.50,9,12,'rprocess'],
      [67,'Ho','Holmium',164.93,9,13,'rprocess'],
      [68,'Er','Erbium',167.26,9,14,'rprocess'],
      [69,'Tm','Thulium',168.93,9,15,'rprocess'],
      [70,'Yb','Ytterbium',173.05,9,16,'rprocess'],
      [71,'Lu','Lutetium',174.97,6,3,'rprocess'],
      [72,'Hf','Hafnium',178.49,6,4,'rprocess'],
      [73,'Ta','Tantalum',180.95,6,5,'rprocess'],
      [74,'W','Tungsten',183.84,6,6,'rprocess'],
      [75,'Re','Rhenium',186.21,6,7,'rprocess'],
      [76,'Os','Osmium',190.23,6,8,'rprocess'],
      [77,'Ir','Iridium',192.22,6,9,'rprocess'],
      [78,'Pt','Platinum',195.08,6,10,'rprocess'],
      [79,'Au','Gold',196.97,6,11,'rprocess'],
      [80,'Hg','Mercury',200.59,6,12,'rprocess'],
      [81,'Tl','Thallium',204.38,6,13,'sprocess'],
      [82,'Pb','Lead',207.2,6,14,'sprocess'],
      [83,'Bi','Bismuth',208.98,6,15,'sprocess'],
      [84,'Po','Polonium',209,6,16,'rprocess'],
      [85,'At','Astatine',210,6,17,'rprocess'],
      [86,'Rn','Radon',222,6,18,'rprocess'],
      [87,'Fr','Francium',223,7,1,'rprocess'],
      [88,'Ra','Radium',226,7,2,'rprocess'],
      [89,'Ac','Actinium',227,10,3,'rprocess'],
      [90,'Th','Thorium',232.04,10,4,'rprocess'],
      [91,'Pa','Protactinium',231.04,10,5,'rprocess'],
      [92,'U','Uranium',238.03,10,6,'rprocess'],
      [93,'Np','Neptunium',237,10,7,'rprocess'],
      [94,'Pu','Plutonium',244,10,8,'rprocess'],
      [95,'Am','Americium',243,10,9,'rprocess'],
      [96,'Cm','Curium',247,10,10,'rprocess'],
      [97,'Bk','Berkelium',247,10,11,'rprocess'],
      [98,'Cf','Californium',251,10,12,'rprocess'],
      [99,'Es','Einsteinium',252,10,13,'rprocess'],
      [100,'Fm','Fermium',257,10,14,'rprocess'],
      [101,'Md','Mendelevium',258,10,15,'rprocess'],
      [102,'No','Nobelium',259,10,16,'rprocess'],
      [103,'Lr','Lawrencium',266,7,3,'rprocess'],
      [104,'Rf','Rutherfordium',267,7,4,'rprocess'],
      [105,'Db','Dubnium',268,7,5,'rprocess'],
      [106,'Sg','Seaborgium',269,7,6,'rprocess'],
      [107,'Bh','Bohrium',270,7,7,'rprocess'],
      [108,'Hs','Hassium',269,7,8,'rprocess'],
      [109,'Mt','Meitnerium',278,7,9,'rprocess'],
      [110,'Ds','Darmstadtium',281,7,10,'rprocess'],
      [111,'Rg','Roentgenium',282,7,11,'rprocess'],
      [112,'Cn','Copernicium',285,7,12,'rprocess'],
      [113,'Nh','Nihonium',286,7,13,'rprocess'],
      [114,'Fl','Flerovium',289,7,14,'rprocess'],
      [115,'Mc','Moscovium',290,7,15,'rprocess'],
      [116,'Lv','Livermorium',293,7,16,'rprocess'],
      [117,'Ts','Tennessine',294,7,17,'rprocess'],
      [118,'Og','Oganesson',294,7,18,'rprocess'],
    ];

    // Build element objects
    const ELEMENTS = ELEMENTS_RAW.map(([z, symbol, name, mass, row, col, process]) => ({
      z, symbol, name, mass, row, col, process,
      abundance: 0, state: 'dormant' // dormant | formed | active
    }));

    // Index by atomic number for fast lookup
    const elementByZ = {};
    ELEMENTS.forEach(el => { elementByZ[el.z] = el; });

    // ============================================================
    // STAGE DEFINITIONS — the physics of stellar evolution
    // ============================================================

    const STAGES = [
      {
        id: 'hydrogen',
        name: 'Hydrogen Burning',
        shortName: 'H',
        minMass: 0.08,
        shellIndex: 0,
        color: PROCESSES.ppchain.color,
        temperature: (m) => 15e6 * Math.pow(m, 0.5),   // K
        density: (m) => 150 * Math.pow(m, 0.8),         // g/cm\u00B3
        duration: (m) => 1e10 * Math.pow(m, -2.5),      // years
        products: { 2: 'ppchain' },   // He from H
        depletions: [1],              // H consumed
        reactions: [
          '4 \u00B9H \u2192 \u2074He + 2e\u207A + 2\u03BD\u2091 + 26.7 MeV',
          '\u00B9\u00B2C + \u00B9H \u2192 \u00B9\u00B3N \u2192 \u00B9\u00B3C + e\u207A + \u03BD\u2091 (CNO)',
        ],
        description: 'The star fuses hydrogen into helium in its core. Low-mass stars use the proton-proton chain; higher-mass stars predominantly use the CNO cycle, which is more temperature-sensitive. This is the longest phase of stellar life.',
        simpleDescription: 'The star squeezes hydrogen atoms together in its centre to make helium \u2014 the same thing that makes the Sun shine. This releases enormous energy and is what keeps the star glowing. Small stars do this slowly and live for billions of years; big stars burn through their fuel much faster.',
        detailedDescription: 'The pp-chain operates at T > 4 million K and dominates below ~1.3 M\u2609. The CNO cycle dominates above this mass, using carbon, nitrogen, and oxygen as catalysts. The Gamow peak for pp fusion occurs at ~6 keV, requiring quantum tunneling through the Coulomb barrier. Energy generation rate: \u03B5 \u221D T\u2074 (pp-chain) vs \u03B5 \u221D T\u00B9\u2076 (CNO cycle).',
        simpleDetailedDescription: 'Deep inside the star, the temperature is over 15 million degrees \u2014 hot enough to force hydrogen nuclei to stick together despite pushing each other apart. Four hydrogen atoms combine to make one helium atom, and a tiny bit of mass is converted into a huge amount of energy (E=mc\u00B2). Our Sun has been doing this for 4.6 billion years and is only halfway through its hydrogen fuel.',
        starColor: (m) => m < 0.5 ? '#ff6b4a' : m < 2 ? '#fff4e0' : '#aaccff',
        starSize: (m) => Math.pow(m, 0.8),
      },
      {
        id: 'helium',
        name: 'Helium Burning',
        shortName: 'He',
        minMass: 0.5,
        shellIndex: 1,
        color: PROCESSES.triplealpha.color,
        temperature: (m) => 1e8 * (1 + 0.5 * Math.log10(m)),
        density: (m) => 1e4 * Math.pow(m, -0.5),
        duration: (m) => 1e9 * Math.pow(m, -2.5),
        products: { 6: 'triplealpha', 8: 'alphacapture' },
        depletions: [2],
        reactions: [
          '3 \u2074He \u2192 \u00B9\u00B2C + \u03B3 (Triple-alpha)',
          '\u00B9\u00B2C + \u2074He \u2192 \u00B9\u2076O + \u03B3',
        ],
        description: 'After hydrogen is exhausted in the core, the star contracts and heats until helium ignites. Three helium-4 nuclei fuse into carbon-12 via the triple-alpha process. Some carbon further captures helium to form oxygen-16. The star expands into a red giant.',
        simpleDescription: 'When the hydrogen runs out, the star\'s core shrinks and heats up until it\'s hot enough to start fusing helium. Three helium atoms combine to make carbon \u2014 the element that all life is based on. Some carbon then grabs another helium to make oxygen. The star puffs up enormously and turns red, becoming a "red giant."',
        detailedDescription: 'The triple-alpha process is highly temperature-sensitive (\u03B5 \u221D T\u2074\u2070) and proceeds through the unstable \u2078Be resonance, saved by the Hoyle state in \u00B9\u00B2C (7.65 MeV excited state). Without this resonance, carbon would be vanishingly rare. The \u00B9\u00B2C(\u03B1,\u03B3)\u00B9\u2076O rate determines the cosmic C/O ratio, one of the most important unsettled values in astrophysics.',
        simpleDetailedDescription: 'This is where carbon and oxygen come from \u2014 two of the most important elements for life. It takes three helium atoms colliding almost simultaneously to make carbon, which is incredibly unlikely. Physicist Fred Hoyle predicted there must be a special energy state in carbon that makes this work, and he was right! Without this lucky coincidence, carbon-based life (including us) could never exist.',
        starColor: () => '#ff4500',
        starSize: (m) => Math.pow(m, 0.8) * 10,
      },
      {
        id: 'carbon',
        name: 'Carbon Burning',
        shortName: 'C',
        minMass: 8,
        shellIndex: 2,
        color: PROCESSES.cburn.color,
        temperature: (m) => 6e8 * (1 + 0.3 * Math.log10(m / 8)),
        density: (m) => 2e5 * Math.pow(m / 8, 0.5),
        duration: (m) => 1000 * Math.pow(m / 8, -2),
        products: { 10: 'cburn', 11: 'cburn', 12: 'cburn', 13: 'cburn' },
        depletions: [6],
        reactions: [
          '\u00B9\u00B2C + \u00B9\u00B2C \u2192 \u00B2\u2070Ne + \u2074He',
          '\u00B9\u00B2C + \u00B9\u00B2C \u2192 \u00B2\u00B3Na + \u00B9H',
          '\u00B9\u00B2C + \u00B9\u00B2C \u2192 \u00B2\u2074Mg + \u03B3',
        ],
        description: 'In massive stars (>8 M\u2609), after helium exhaustion, the core contracts further until carbon ignites. Carbon-carbon fusion produces neon, sodium, and magnesium. This stage lasts only about 1,000 years.',
        simpleDescription: 'Only big stars (at least 8 times heavier than our Sun) get hot enough for this. Carbon atoms start fusing together, creating neon, sodium, and magnesium. Things are speeding up \u2014 this stage lasts only about 1,000 years compared to the billions of years spent on hydrogen.',
        detailedDescription: 'Carbon burning occurs at T \u2248 6\u00D710\u2078 K and \u03C1 \u2248 2\u00D710\u2075 g/cm\u00B3. Neutrino losses begin to dominate energy transport, dramatically shortening each subsequent burning stage. The \u00B9\u00B2C+\u00B9\u00B2C reaction has multiple branches with different products and energy releases.',
        simpleDetailedDescription: 'From this stage onward, the star is living on borrowed time. The core is now so hot (600 million degrees) that it produces ghostly particles called neutrinos that fly straight through the star, carrying away energy. Each new fuel burns faster than the last \u2014 the star is racing toward its end.',
        starColor: () => '#3366ff',
        starSize: (m) => Math.pow(m, 0.8) * 5,
      },
      {
        id: 'neon',
        name: 'Neon Burning',
        shortName: 'Ne',
        minMass: 8,
        shellIndex: 3,
        color: PROCESSES.neburn.color,
        temperature: (m) => 1.2e9 * (1 + 0.2 * Math.log10(m / 8)),
        density: (m) => 4e6,
        duration: (m) => 1 * Math.pow(m / 8, -1.5),
        products: { 8: 'neburn', 12: 'neburn' },
        depletions: [10],
        reactions: [
          '\u00B2\u2070Ne + \u03B3 \u2192 \u00B9\u2076O + \u2074He (photodisintegration)',
          '\u00B2\u2070Ne + \u2074He \u2192 \u00B2\u2074Mg + \u03B3',
        ],
        description: 'Neon burning is unusual \u2014 instead of two nuclei fusing, high-energy photons break apart neon-20 (photodisintegration). The freed alpha particles are captured by remaining neon to produce magnesium. This stage lasts roughly one year.',
        simpleDescription: 'Something strange happens here. Instead of atoms fusing together, the core is so hot that light itself has enough energy to shatter neon atoms apart. The pieces then rearrange into oxygen and magnesium. This stage lasts only about a year.',
        detailedDescription: 'At T \u2248 1.2\u00D710\u2079 K, photon energies are sufficient to photodisintegrate \u00B2\u2070Ne. This is a thermodynamically-driven process where the photon bath provides the energy. Neutrino losses now dominate over photon luminosity by orders of magnitude.',
        simpleDetailedDescription: 'At over a billion degrees, the photons (particles of light) inside the star are so energetic they can actually break atoms apart \u2014 the reverse of fusion! The fragments quickly recombine into heavier elements. The star is now losing far more energy through invisible neutrinos than through the light we can see.',
        starColor: () => '#2244dd',
        starSize: (m) => Math.pow(m, 0.8) * 4,
      },
      {
        id: 'oxygen',
        name: 'Oxygen Burning',
        shortName: 'O',
        minMass: 8,
        shellIndex: 4,
        color: PROCESSES.oburn.color,
        temperature: (m) => 1.5e9 * (1 + 0.15 * Math.log10(m / 8)),
        density: (m) => 1e7,
        duration: (m) => 0.5 * Math.pow(m / 8, -1.5),
        products: { 14: 'oburn', 15: 'oburn', 16: 'oburn', 17: 'oburn', 18: 'oburn', 19: 'oburn', 20: 'oburn' },
        depletions: [8],
        reactions: [
          '\u00B9\u2076O + \u00B9\u2076O \u2192 \u00B2\u2078Si + \u2074He',
          '\u00B9\u2076O + \u00B9\u2076O \u2192 \u00B3\u00B9P + \u00B9H',
          '\u00B9\u2076O + \u00B9\u2076O \u2192 \u00B3\u00B2S + \u03B3',
        ],
        description: 'Oxygen-oxygen fusion produces silicon, sulfur, phosphorus, argon, and calcium \u2014 elements critical for rocky planets and life. This stage lasts only about 6 months.',
        simpleDescription: 'Oxygen atoms slam together to make silicon, sulfur, phosphorus, and calcium \u2014 elements that make up rocks, bones, and the match heads you strike. This stage races by in only about 6 months. The star now has layers like an onion, each burning a different fuel.',
        detailedDescription: 'At T \u2248 1.5\u00D710\u2079 K and \u03C1 \u2248 10\u2077 g/cm\u00B3, oxygen burning has multiple branches. The silicon and sulfur produced here form the penultimate onion-shell layer. Pair neutrino production (\u03B3 \u2192 e\u207Ae\u207B \u2192 \u03BD\u1D49\u03BD\u0304\u1D49) drains energy enormously.',
        simpleDetailedDescription: 'The elements made here are essential for rocky planets like Earth. Silicon makes up most of Earth\'s crust (sand, glass, computer chips). Calcium builds bones and teeth. Phosphorus is in every molecule of DNA. Without oxygen burning in ancient stars, our planet and our bodies couldn\'t exist.',
        starColor: () => '#1a33bb',
        starSize: (m) => Math.pow(m, 0.8) * 3.5,
      },
      {
        id: 'silicon',
        name: 'Silicon Burning',
        shortName: 'Si',
        minMass: 8,
        shellIndex: 5,
        color: PROCESSES.siburn.color,
        temperature: (m) => 3e9 * (1 + 0.1 * Math.log10(m / 8)),
        density: (m) => 3e7,
        duration: (m) => 1 / 365.25,  // ~1 day in years
        products: { 21: 'siburn', 22: 'siburn', 23: 'siburn', 24: 'siburn', 25: 'siburn', 26: 'siburn', 27: 'siburn', 28: 'siburn' },
        depletions: [14],
        reactions: [
          '\u00B2\u2078Si \u2192 \u2076\u2074Ni (via alpha-rich freezeout)',
          '\u2076\u2074Ni \u2192 \u2076\u2074Co \u2192 \u2076\u2074Fe (radioactive decay)',
          'Nuclear Statistical Equilibrium (NSE) \u2192 Fe-peak',
        ],
        description: 'The final fusion stage. Silicon doesn\'t fuse directly \u2014 instead, photodisintegration breaks silicon into alpha particles which rapidly reassemble into iron-peak elements (iron, nickel, cobalt). This takes about ONE DAY. The iron core is an ash heap \u2014 no more energy can be extracted from fusion.',
        simpleDescription: 'The last act of fusion. Silicon is broken apart and reassembled into iron \u2014 and this happens in just ONE DAY. Iron is the dead end of fusion: you can\'t get energy by fusing iron into anything heavier. The core is now a ball of iron ash, and the star is doomed.',
        detailedDescription: 'At T \u2248 3\u00D710\u2079 K, the core reaches Nuclear Statistical Equilibrium (NSE) where forward and reverse nuclear reactions balance. The composition is set by the binding energy per nucleon, which peaks at \u2076\u2074Ni/\u2075\u2076Fe. The iron core grows toward the Chandrasekhar mass (~1.4 M\u2609), at which point electron degeneracy pressure can no longer support it.',
        simpleDetailedDescription: 'Iron is special \u2014 it\'s the most tightly bound atomic nucleus. Fusing lighter elements into iron releases energy, but trying to fuse iron into anything heavier actually costs energy. The star has been paying for its light by fusing lighter atoms into heavier ones for millions of years, and now it\'s hit the wall. A billion years of fuel spent in a single day. What comes next is catastrophic.',
        starColor: () => '#1122aa',
        starSize: (m) => Math.pow(m, 0.8) * 3,
      },
      {
        id: 'supernova',
        name: 'Core-Collapse Supernova',
        shortName: 'SN',
        minMass: 8,
        shellIndex: -1,
        color: PROCESSES.rprocess.color,
        temperature: (m) => 1e11,
        density: (m) => 1e14,
        duration: (m) => 10 / (365.25 * 24 * 3600),  // ~10 seconds in years
        products: (() => {
          const p = {};
          // s-process elements (formed during pre-SN AGB/shell burning)
          [29,30,31,32,36,37,38,39,40,41,42,43,46,48,49,50,51,54,55,56,57,58,59,60,81,82,83].forEach(z => { p[z] = 'sprocess'; });
          // r-process elements (formed during/after explosion)
          [33,34,35,44,45,47,52,53,61,62,63,64,65,66,67,68,69,70,71,72,73,74,75,76,77,78,79,80,
           84,85,86,87,88,89,90,91,92,93,94,95,96,97,98,99,100,101,102,103,104,105,106,107,108,109,110,111,112,113,114,115,116,117,118].forEach(z => { p[z] = 'rprocess'; });
          return p;
        })(),
        depletions: [],
        reactions: [
          'Fe core \u2265 1.4 M\u2609 \u2192 Collapse',
          'Core bounce \u2192 Shock wave + Neutrino burst',
          'r-process: seed + n \u2192 heavy nuclei (A > 56)',
          '\u00B2\u2076Fe + 13 \u2074He + 34n \u2192 \u00B9\u2079\u00B7Au',
        ],
        description: 'The iron core exceeds the Chandrasekhar limit and collapses in milliseconds. The rebounding shock wave, energized by neutrinos, tears the star apart. In the neutron-rich ejecta, rapid neutron capture (r-process) forges all elements heavier than iron \u2014 including gold, platinum, uranium. 10\u00B3\u00B3 neutrinos are released in ~10 seconds.',
        simpleDescription: 'The star explodes! The iron core can\'t support itself any more and collapses in a fraction of a second. It bounces back, sending a shockwave that tears the star apart in the most powerful explosion in the universe. In the chaos, atoms are bombarded with particles so fast that all the heaviest elements are created \u2014 including gold, platinum, and uranium. Every gold ring and every uranium atom on Earth was forged in an ancient supernova.',
        detailedDescription: 'Core collapse reaches velocities of ~70,000 km/s. The inner core bounces at nuclear density (\u03C1 \u2248 2.7\u00D710\u00B9\u2074 g/cm\u00B3) launching a shock wave. 99% of the gravitational binding energy (~3\u00D710\u00B3\u00B3 ergs) is carried away by neutrinos. The r-process occurs in the neutrino-driven wind where neutron densities reach ~10\u00B2\u2074/cm\u00B3, allowing neutron capture faster than beta decay. The resulting abundance pattern has peaks at A \u2248 80, 130, and 195 corresponding to neutron magic numbers.',
        simpleDetailedDescription: 'For a few weeks, a single exploding star can outshine an entire galaxy of 100 billion stars. The explosion scatters all the elements the star created during its life \u2014 plus the new heavy elements made in the explosion itself \u2014 into space. This stardust eventually comes together to form new stars, planets, and even people. As astronomer Carl Sagan said: "We are made of star stuff."',
        starColor: () => '#ffffff',
        starSize: (m) => Math.pow(m, 0.8) * 50,
      },
    ];

    // AGB / s-process stage for intermediate-mass stars (2-8 M\u2609)
    const STAGE_AGB = {
      id: 'agb',
      name: 'AGB & s-Process',
      shortName: 'AGB',
      minMass: 2,
      maxMass: 8,
      shellIndex: -1,
      color: PROCESSES.sprocess.color,
      temperature: (m) => 3e8,
      density: (m) => 1e4,
      duration: (m) => 1e6 * Math.pow(m / 2, -1),
      products: (() => {
        const p = {};
        [29,30,31,32,36,37,38,39,40,41,42,43,46,48,49,50,51,54,55,56,57,58,59,60,81,82,83].forEach(z => { p[z] = 'sprocess'; });
        return p;
      })(),
      depletions: [],
      reactions: [
        '\u00B9\u00B3C + \u2074He \u2192 \u00B9\u2076O + n (neutron source)',
        'Seed nucleus + n \u2192 heavier isotope (repeated)',
        'Slow capture: \u03C4_capture >> \u03C4_\u03B2-decay',
      ],
      description: 'On the Asymptotic Giant Branch, thermal pulses dredge up material between H and He burning shells. Free neutrons from \u00B9\u00B3C(\u03B1,n) capture onto iron-peak seeds, slowly building up heavier elements \u2014 strontium, barium, lead. These are ejected in a planetary nebula.',
      simpleDescription: 'The dying star swells into an enormous red giant and starts to pulse. Deep inside, spare neutrons slowly attach to atoms one at a time, gradually building up heavier elements like strontium, barium, and lead. The star\'s outer layers puff away into space as a beautiful glowing nebula, seeding the cosmos with these elements.',
      detailedDescription: 'The s-process path follows the valley of beta-stability. Neutron densities are ~10\u2077/cm\u00B3 (vs ~10\u00B2\u2074 for r-process), so beta-decay occurs between captures. The main s-process component (A=90-204) operates in AGB stars, producing the characteristic peaks at A\u224888, 138, and 208 corresponding to neutron magic numbers N=50, 82, 126.',
      simpleDetailedDescription: 'This is the gentle way to make heavy elements. Unlike the violent supernova, here neutrons are captured slowly \u2014 one at a time, with long waits between captures. It\'s like building with LEGOs one brick at a time. This process is responsible for about half of all elements heavier than iron, including much of the lead and barium in the universe.',
      starColor: () => '#ff2200',
      starSize: (m) => Math.pow(m, 0.8) * 15,
    };

    // Remnant types
    const REMNANTS = {
      whitedwarf: {
        name: 'White Dwarf',
        description: 'A dense stellar remnant supported by electron degeneracy pressure. Will slowly cool over trillions of years.',
        simpleDescription: 'The star\'s core is left behind as a tiny, incredibly dense glowing ember about the size of Earth but weighing as much as the Sun. It will slowly cool and fade over trillions of years \u2014 far longer than the current age of the universe.'
      },
      neutronstar: {
        name: 'Neutron Star',
        description: 'An incredibly dense remnant (~10\u00B9\u2074 g/cm\u00B3) supported by neutron degeneracy pressure. About 20 km across but 1.4-2 M\u2609.',
        simpleDescription: 'The core is crushed into a ball of neutrons only 20 km (12 miles) across \u2014 the size of a city \u2014 yet it weighs more than our Sun. A teaspoon of neutron star material would weigh about a billion tonnes. Some neutron stars spin hundreds of times per second and emit beams of radiation like cosmic lighthouses.'
      },
      blackhole: {
        name: 'Black Hole',
        description: 'The core mass exceeds ~3 M\u2609 \u2014 nothing can halt the collapse. A singularity forms, surrounded by an event horizon.',
        simpleDescription: 'The core is so heavy that nothing can stop its collapse \u2014 not even the force between neutrons. It crushes down to an infinitely small point, creating a region of space where gravity is so strong that nothing, not even light, can escape. This is a black hole.'
      },
    };

    // Star classification helper
    function classifyStar(mass) {
      if (mass < 0.08) return { name: 'Brown Dwarf', stages: [], remnant: null };
      if (mass < 0.5) return { name: 'Red Dwarf', stages: ['hydrogen'], remnant: 'whitedwarf' };
      if (mass < 2) return { name: 'Sun-like Star', stages: ['hydrogen', 'helium'], remnant: 'whitedwarf' };
      if (mass < 8) return { name: 'Intermediate Star', stages: ['hydrogen', 'helium', 'agb'], remnant: 'whitedwarf' };
      if (mass < 25) return { name: 'Massive Star', stages: ['hydrogen', 'helium', 'carbon', 'neon', 'oxygen', 'silicon', 'supernova'], remnant: 'neutronstar' };
      if (mass < 40) return { name: 'Supergiant', stages: ['hydrogen', 'helium', 'carbon', 'neon', 'oxygen', 'silicon', 'supernova'], remnant: 'blackhole' };
      return { name: 'Hypergiant', stages: ['hydrogen', 'helium', 'carbon', 'neon', 'oxygen', 'silicon', 'supernova'], remnant: 'blackhole' };
    }

    // Get stage object by ID
    function getStageById(id) {
      if (id === 'agb') return STAGE_AGB;
      return STAGES.find(s => s.id === id);
    }

    // Format large/small numbers for display
    function formatDuration(years) {
      if (years >= 1e9) return (years / 1e9).toFixed(1) + ' billion years';
      if (years >= 1e6) return (years / 1e6).toFixed(1) + ' million years';
      if (years >= 1e3) return (years / 1e3).toFixed(0) + ' years';
      if (years >= 1) return years.toFixed(1) + ' years';
      if (years >= 1/12) return (years * 12).toFixed(1) + ' months';
      if (years >= 1/365.25) return (years * 365.25).toFixed(1) + ' days';
      if (years >= 1/(365.25*24)) return (years * 365.25 * 24).toFixed(1) + ' hours';
      return (years * 365.25 * 24 * 3600).toFixed(1) + ' seconds';
    }

    function formatTemp(kelvin) {
      if (kelvin >= 1e9) return (kelvin / 1e9).toFixed(1) + ' billion K';
      if (kelvin >= 1e6) return (kelvin / 1e6).toFixed(0) + ' million K';
      return kelvin.toLocaleString() + ' K';
    }

    function formatDensity(gcm3) {
      if (gcm3 >= 1e12) return gcm3.toExponential(1) + ' g/cm\u00B3';
      if (gcm3 >= 1e6) return (gcm3 / 1e6).toFixed(0) + ' \u00D710\u2076 g/cm\u00B3';
      if (gcm3 >= 1e3) return (gcm3 / 1e3).toFixed(0) + ' \u00D710\u00B3 g/cm\u00B3';
      return gcm3.toFixed(0) + ' g/cm\u00B3';
    }

    // ============================================================
    // PERIODIC TABLE RENDERER
    // ============================================================

    const PeriodicTable = {
      container: null,
      cells: {},  // keyed by Z

      init() {
        this.container = document.getElementById('periodic-table');
        this.render();
        this.renderLegend();
      },

      render() {
        this.container.innerHTML = '';

        // Build grid: 10 rows (7 standard + gap + 2 lanthanide/actinide)
        // Standard rows 1-7, then gap, then rows 9-10 (lanthanides/actinides)
        const grid = [];
        for (let r = 1; r <= 10; r++) {
          for (let c = 1; c <= 18; c++) {
            grid.push({ r, c });
          }
        }

        // Create cells in grid order
        grid.forEach(({ r, c }) => {
          // Gap row 8
          if (r === 8) {
            if (c === 1) {
              const gap = document.createElement('div');
              gap.className = 'pt-gap';
              gap.style.gridColumn = '1 / -1';
              gap.style.gridRow = '8';
              this.container.appendChild(gap);
            }
            return;
          }

          const el = ELEMENTS.find(e => e.row === r && e.col === c);

          if (el) {
            const cell = document.createElement('div');
            cell.className = 'element-cell';
            cell.dataset.z = el.z;
            cell.dataset.state = 'dormant';
            cell.dataset.process = el.process;
            cell.setAttribute('role', 'gridcell');
            cell.setAttribute('tabindex', '0');
            cell.setAttribute('aria-label', `${el.name}, atomic number ${el.z}, ${PROCESSES[el.process].name}`);
            cell.style.gridRow = r;
            cell.style.gridColumn = c;

            cell.innerHTML = `<span class="z">${el.z}</span><span class="symbol">${el.symbol}</span><span class="name">${el.name}</span>`;

            cell.addEventListener('click', () => ElementDetail.show(el.z));
            cell.addEventListener('keydown', (e) => {
              if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); ElementDetail.show(el.z); }
            });

            this.container.appendChild(cell);
            this.cells[el.z] = cell;
          } else {
            // Lanthanide/actinide labels
            if (r === 6 && c === 3) {
              const label = document.createElement('div');
              label.className = 'pt-label';
              label.style.gridRow = 6; label.style.gridColumn = 3;
              label.textContent = '57-71';
              label.setAttribute('aria-label', 'Lanthanides, shown in row below');
              this.container.appendChild(label);
              return;
            }
            if (r === 7 && c === 3) {
              const label = document.createElement('div');
              label.className = 'pt-label';
              label.style.gridRow = 7; label.style.gridColumn = 3;
              label.textContent = '89-103';
              label.setAttribute('aria-label', 'Actinides, shown in row below');
              this.container.appendChild(label);
              return;
            }
            // Empty spacer
            const spacer = document.createElement('div');
            spacer.className = 'element-spacer';
            spacer.style.gridRow = r; spacer.style.gridColumn = c;
            this.container.appendChild(spacer);
          }
        });

        // Set primordial elements (Big Bang: H, He, trace Li) as pre-formed
        this.setElementState(1, 'formed', 'bigbang');
        this.setElementState(2, 'formed', 'bigbang');
        this.setElementState(3, 'formed', 'spallation');
      },

      setElementState(z, state, processId) {
        const cell = this.cells[z];
        if (!cell) return;
        const el = elementByZ[z];
        el.state = state;

        cell.dataset.state = state;
        if (state === 'formed' || state === 'active') {
          const color = PROCESSES[processId || el.process].color;
          cell.style.backgroundColor = color;
          cell.style.borderColor = color + '44';
        } else {
          cell.style.backgroundColor = '';
          cell.style.borderColor = '';
        }
      },

      // Activate elements for a given stage
      activateStageElements(stageId) {
        const stage = getStageById(stageId);
        if (!stage) return;
        Object.entries(stage.products).forEach(([z, processId]) => {
          this.setElementState(parseInt(z), 'active', processId);
        });
      },

      // Finalize elements for a given stage (active → formed)
      finalizeStageElements(stageId) {
        const stage = getStageById(stageId);
        if (!stage) return;
        Object.entries(stage.products).forEach(([z, processId]) => {
          this.setElementState(parseInt(z), 'formed', processId);
        });
      },

      // Reset all non-primordial elements
      resetAll() {
        ELEMENTS.forEach(el => {
          if (el.z <= 3) {
            // Primordial
            const proc = el.z <= 2 ? 'bigbang' : 'spallation';
            this.setElementState(el.z, 'formed', proc);
          } else {
            this.setElementState(el.z, 'dormant', el.process);
          }
        });
      },

      // Rapid cascade for r-process (used during supernova animation)
      async rProcessCascade(delayMs = 30) {
        const rElements = ELEMENTS.filter(e => e.process === 'rprocess' && e.z > 28).sort((a, b) => a.z - b.z);
        const sElements = ELEMENTS.filter(e => e.process === 'sprocess' && e.z > 28).sort((a, b) => a.z - b.z);

        // s-process elements first (slightly faster)
        for (const el of sElements) {
          this.setElementState(el.z, 'active', 'sprocess');
          await new Promise(r => setTimeout(r, delayMs / 2));
          this.setElementState(el.z, 'formed', 'sprocess');
        }
        // r-process cascade
        for (const el of rElements) {
          this.setElementState(el.z, 'active', 'rprocess');
          await new Promise(r => setTimeout(r, delayMs));
          this.setElementState(el.z, 'formed', 'rprocess');
        }
      },

      renderLegend() {
        const legend = document.getElementById('process-legend');
        legend.innerHTML = '';
        const shown = ['bigbang', 'ppchain', 'triplealpha', 'alphacapture', 'cburn', 'neburn', 'oburn', 'siburn', 'sprocess', 'rprocess', 'spallation'];
        shown.forEach(id => {
          const p = PROCESSES[id];
          const item = document.createElement('div');
          item.className = 'legend-item';
          item.innerHTML = `<span class="legend-swatch" style="background:${p.color}"></span><span>${p.name}</span>`;
          legend.appendChild(item);
        });
      }
    };

    // ============================================================
    // ELEMENT DETAIL PANEL
    // ============================================================

    const ElementDetail = {
      overlay: null,
      body: null,

      init() {
        this.overlay = document.getElementById('element-detail');
        this.body = document.getElementById('element-detail-body');
        document.getElementById('element-detail-close').addEventListener('click', () => this.hide());
        this.overlay.addEventListener('click', (e) => { if (e.target === this.overlay) this.hide(); });
      },

      show(z) {
        const el = elementByZ[z];
        if (!el) return;
        const proc = PROCESSES[el.process];
        const color = proc.color;

        this.body.innerHTML = `
          <div class="element-detail-header">
            <div class="element-detail-symbol" style="background:${color}">${el.symbol}</div>
            <div>
              <div style="font-size:var(--fs-xl);font-weight:700">${el.name}</div>
              <div style="color:var(--text-secondary);font-size:var(--fs-sm)">Atomic Number: ${el.z} &bull; Mass: ${el.mass} u</div>
            </div>
          </div>
          <div style="margin-bottom:var(--space-3)">
            <div class="info-stat-label">Primary Origin</div>
            <div style="display:flex;align-items:center;gap:var(--space-2);margin-top:var(--space-1)">
              <span class="legend-swatch" style="background:${color}"></span>
              <span style="font-weight:600">${proc.name}</span>
            </div>
          </div>
          <div style="color:var(--text-secondary);font-size:var(--fs-sm);line-height:1.7">
            ${this.getElementDescription(el)}
          </div>
        `;

        this.overlay.classList.add('open');
        document.getElementById('element-detail-close').focus();
      },

      hide() {
        this.overlay.classList.remove('open');
      },

      getElementDescription(el) {
        const tech = this.techDescs[el.z] || `Produced by ${PROCESSES[el.process].name} in stellar environments.`;
        const simple = this.simpleDescs[el.z] || this.getSimpleFallback(el);
        return LanguageToggle.isTechnical() ? tech : simple;
      },

      getSimpleFallback(el) {
        const processNames = {
          bigbang: 'created in the Big Bang, the beginning of the universe',
          ppchain: 'made inside stars by fusing hydrogen',
          cno: 'made inside stars as part of hydrogen fusion',
          triplealpha: 'forged inside dying red giant stars',
          alphacapture: 'built up inside massive stars',
          cburn: 'created when carbon fuses in massive stars',
          neburn: 'created when neon is broken apart in massive stars',
          oburn: 'created when oxygen fuses in massive stars',
          siburn: 'created in the final moments before a star explodes',
          sprocess: 'slowly built up inside aging giant stars',
          rprocess: 'forged in the explosion of a supernova',
          pprocess: 'created in rare nuclear reactions during stellar explosions',
          spallation: 'created when cosmic rays smash into atoms in space',
        };
        return `${el.name} was ${processNames[el.process] || 'created in stars'}.`;
      },

      // Technical descriptions (current)
      techDescs: {
        1: 'The most abundant element in the universe. Formed in the Big Bang (~75% of all baryonic matter). The fuel for main-sequence stars.',
        2: 'Second most abundant element. Formed in the Big Bang (~25%) and by hydrogen fusion in all stars. Inert noble gas.',
        3: 'Primarily produced by cosmic ray spallation. Trace amounts from Big Bang. Depleted in stellar interiors due to low nuclear binding energy.',
        4: 'Produced almost entirely by cosmic ray spallation of heavier elements. Extremely rare cosmically. Toxic but used in aerospace alloys.',
        5: 'Created by cosmic ray spallation. Not produced in significant quantities in stars. Used in borosilicate glass and as a neutron absorber.',
        6: 'Forged in the hearts of red giants via the triple-alpha process. The basis of all known life. Fourth most abundant element in the universe.',
        7: 'Produced as a byproduct of the CNO cycle in stars. Essential for amino acids and DNA. Makes up 78% of Earth\'s atmosphere.',
        8: 'Created by alpha capture onto carbon in massive stars. Third most abundant element. Essential for water and respiration.',
        9: 'Produced in the CNO cycle and by neutrino spallation in supernovae. The most reactive and electronegative element.',
        10: 'Product of carbon burning in massive stars. Noble gas, fifth most abundant element in the universe.',
        11: 'Produced in carbon burning. Highly reactive alkali metal. Essential for nerve function in biology.',
        12: 'Formed in both carbon and neon burning in massive stars. Essential for chlorophyll in plants.',
        13: 'Produced in carbon and neon burning. Most abundant metal in Earth\'s crust. Key isotope \u00B2\u2076Al is a radioactive tracer of recent nucleosynthesis.',
        14: 'Produced in oxygen burning in massive stars. The basis of rocky planets and semiconductor technology.',
        15: 'Created in oxygen burning. Essential component of DNA, RNA, and ATP \u2014 the energy currency of life.',
        16: 'Formed in oxygen burning. Essential for proteins (disulfide bonds). Tenth most abundant element in the universe.',
        17: 'Produced in oxygen burning. Used in water purification. The chloride ion is essential for digestion (HCl).',
        18: 'Produced in oxygen burning. Third most abundant gas in Earth\'s atmosphere. Used in welding and lighting.',
        19: 'Created in oxygen burning. Essential for cellular function and nerve signaling.',
        20: 'Produced in both oxygen and silicon burning. Fifth most abundant element in Earth\'s crust. Essential for bones and teeth.',
        21: 'Produced in silicon burning and the s-process. Rare on Earth. Used in aerospace alloys.',
        22: 'Formed in silicon burning. Lightweight, strong, corrosion-resistant. Used in aircraft, implants, and spacecraft.',
        23: 'Silicon burning product. Used to make high-strength steel alloys.',
        24: 'Iron-peak element from silicon burning. Used in stainless steel and chrome plating.',
        25: 'Iron-peak element. Essential trace nutrient. Used in steel production.',
        26: 'The endpoint of stellar fusion \u2014 the most tightly bound nucleus. Formed in silicon burning. Core of our planet. Essential for hemoglobin.',
        27: 'Iron-peak element from silicon burning. Used in rechargeable batteries and blue pigments. Radioactive \u2076\u2070Co used in radiation therapy.',
        28: 'Iron-peak element. Much of Earth\'s core is iron-nickel alloy. Used in stainless steel and coins.',
        29: 'Produced by the s-process in AGB stars. One of humanity\'s first metals, used since ~9000 BCE.',
        30: 'Created via the s-process. Essential trace element for immune function and wound healing.',
        31: 's-Process product. Used in semiconductors (GaAs) for LEDs and solar cells.',
        32: 's-Process product. Used in fiber optics and infrared optics.',
        33: 'Produced by the r-process. Historically infamous as a poison. Used in semiconductors.',
        34: 'r-Process element. Essential trace nutrient (selenoproteins). Used in electronics.',
        35: 'r-Process product. Reddish-brown liquid at room temperature. Used in flame retardants.',
        36: 's-Process noble gas. Used in photographic flash equipment and some fluorescent lighting.',
        37: 's-Process product. Used in atomic clocks and GPS satellite technology.',
        38: 'Classic s-process element. Used in fireworks (red color) and in refining sugar.',
        39: 's-Process product. Used in LED screens and laser crystals (YAG lasers).',
        40: 's-Process element. Highly corrosion-resistant, used in nuclear reactor cladding.',
        41: 's-Process product. Used in superconducting magnets (MRI scanners, particle accelerators).',
        42: 's-Process element. Essential trace element in biology. Used in high-strength steel alloys.',
        43: 'First artificially produced element. Created in the s-process but has no stable isotopes. Used in medical imaging.',
        44: 'r-Process element. Used as a catalyst in chemical processes and in electronics.',
        45: 'r-Process element. Extremely rare. Used in catalytic converters to reduce vehicle emissions.',
        46: 's-Process element. Used in catalytic converters and in hydrogen purification.',
        47: 'Produced primarily by the r-process in supernovae and neutron star mergers. Used in electronics, photography, and jewelry.',
        48: 's-Process product. Toxic heavy metal. Used in rechargeable batteries (NiCd) and pigments.',
        49: 's-Process product. Used in touchscreens (indium tin oxide \u2014 ITO) and semiconductor production.',
        50: 's-Process element. One of the earliest metals used by humans (bronze = tin + copper).',
        51: 's-Process product. Used in flame retardants and lead-antimony alloys.',
        52: 'r-Process element. Extremely rare on Earth. Used in solar panels and thermoelectric devices.',
        53: 'r-Process product. Essential for thyroid function. Deficiency causes goiter.',
        54: 's-Process noble gas. Used in ion propulsion engines for spacecraft and in lighting.',
        55: 's-Process product. Used in atomic clocks (caesium-133 defines the second).',
        56: 'Classic s-process product. Used in medical imaging (barium swallow) and in drilling fluids.',
        57: 's-Process product. Used in camera lenses and hybrid car battery electrodes.',
        58: 's-Process lanthanide. Most abundant rare earth element. Used in catalytic converters and self-cleaning ovens.',
        59: 's-Process product. Used in special glass for welder\'s goggles and in aircraft engines.',
        60: 's-Process lanthanide. Used in powerful permanent magnets (Nd\u2082Fe\u00B9\u2074B) found in headphones, hard drives, and electric motors.',
        61: 'r-Process element. No stable isotopes \u2014 all radioactive. Used in nuclear batteries and luminous paint.',
        62: 'r-Process lanthanide. Used in nuclear reactor control rods (excellent neutron absorber).',
        63: 'Predominantly r-process. Used in red phosphors for TV screens and in nuclear control rods.',
        64: 'r-Process lanthanide. Used as MRI contrast agent and in nuclear reactor shielding.',
        65: 'r-Process product. Used in solid-state devices and green phosphors.',
        66: 'r-Process lanthanide. Used in powerful magnets and nuclear reactor control rods.',
        67: 'r-Process product. Highest magnetic moment of any element. Used in MRI machines.',
        68: 'r-Process lanthanide. Used in fiber optic communications (erbium-doped fiber amplifiers).',
        69: 'r-Process product. Rarest naturally occurring lanthanide. Used in portable X-ray machines.',
        70: 'r-Process product. Used in stress gauges and thermal barrier coatings.',
        71: 'r-Process lanthanide. Dense and hard. Used in PET scan detectors.',
        72: 'r-Process product. Used in nuclear submarine reactor control rods. Always found with zirconium.',
        73: 'r-Process element. Extremely corrosion-resistant. Used in surgical implants and electronics (capacitors in phones).',
        74: 'r-Process product. Highest melting point of all elements (3,422\u00B0C). Used in light bulb filaments and drill bits.',
        75: 'r-Process element. One of the rarest elements in Earth\'s crust. Used in jet engine turbine blades.',
        76: 'r-Process product. Densest naturally occurring element. Used in fountain pen tips and electrical contacts.',
        77: 'r-Process element. Third-densest element. The iridium layer in Earth\'s crust is evidence of the asteroid that killed the dinosaurs.',
        78: 'r-Process product. Extremely rare and valuable. Used in catalytic converters, lab equipment, and jewelry.',
        79: 'Forged in the r-process during supernovae and neutron star mergers. Every gold atom on Earth was created in a cosmic cataclysm.',
        80: 'r-Process product. Only metal that is liquid at room temperature. Historically used in thermometers. Toxic.',
        81: 's-Process product. Extremely toxic. Historically used as rat poison. Used in specialized electronics.',
        82: 'The heaviest stable element. End-product of several s-process decay chains. All heavier elements are radioactive.',
        83: 's-Process end-product. Very slightly radioactive (longest half-life of any radioactive element). Used in medicine (Pepto-Bismol).',
        84: 'r-Process element. Highly radioactive. Discovered by Marie and Pierre Curie. Named after Poland.',
        85: 'r-Process product. Rarest naturally occurring element on Earth. Extremely radioactive.',
        86: 'r-Process noble gas. Radioactive. Forms naturally from radium decay. Indoor health hazard (lung cancer risk).',
        87: 'r-Process product. Most electropositive and reactive of all elements. Extremely radioactive and rare.',
        88: 'r-Process product. Discovered by Marie Curie. Historically used in luminous watch dials (before hazards were known).',
        89: 'r-Process product. Radioactive. Source of neutrons for research.',
        90: 'Radioactive element produced by the r-process. Its long half-life (14 billion years) makes it useful for dating the age of the Earth.',
        91: 'r-Process product. Extremely rare and radioactive. One of the rarest naturally occurring elements.',
        92: 'Heaviest naturally abundant element. Produced by the r-process. Powers nuclear reactors and was used in the first atomic weapons.',
        93: 'r-Process product. First synthetic transuranium element. Found in trace amounts from uranium decay.',
        94: 'r-Process product. Used in nuclear weapons and RTG power sources for space probes (Voyager, Curiosity rover).',
        95: 'r-Process product. Synthetic. Used in smoke detectors (\u00B2\u2074\u00B9Am).',
        96: 'r-Process product. Named after Marie and Pierre Curie. Used as alpha particle source.',
        97: 'Synthetic r-process product. Named after Berkeley, California. Only microgram quantities ever produced.',
        98: 'Synthetic element. Strong neutron emitter. Used in nuclear reactor startup and in cancer treatment.',
        99: 'First identified in debris of first hydrogen bomb test (1952). Named after Albert Einstein.',
        100: 'Discovered in hydrogen bomb debris alongside einsteinium. Named after Enrico Fermi.',
        101: 'Synthetic element. Named after Dmitri Mendeleev, creator of the periodic table.',
        102: 'Synthetic element. Named after Alfred Nobel, inventor of dynamite.',
        103: 'Synthetic element. Named after Ernest O. Lawrence, inventor of the cyclotron.',
      },

      // Simple/accessible descriptions
      simpleDescs: {
        1: 'The simplest and most common element in the universe \u2014 it makes up about 75% of all normal matter. Created in the Big Bang. Hydrogen is what stars burn as fuel, and two hydrogen atoms combine with oxygen to make water.',
        2: 'The second lightest and second most common element. Also made in the Big Bang. Helium is the gas that makes balloons float and makes your voice squeaky. Stars make helium by fusing hydrogen.',
        3: 'A soft, silvery metal used in rechargeable batteries (like in your phone). Most lithium in space is made when cosmic rays smash into heavier atoms, breaking them into smaller pieces.',
        4: 'A very rare, lightweight metal. Created when cosmic rays break apart heavier atoms in space. Used in aircraft and spacecraft because it\'s incredibly stiff for its weight. Emeralds get their green color from beryllium.',
        5: 'Created by cosmic ray impacts in space, not in stars. Used in heat-resistant glass (Pyrex) and laundry detergent (borax). Boron is essential for plant growth.',
        6: 'Made inside dying stars when three helium atoms fuse together. Carbon is the backbone of all known life \u2014 every living thing on Earth is carbon-based. Also forms diamonds, graphite in pencils, and carbon fiber.',
        7: 'Created as a byproduct when stars fuse hydrogen using the CNO cycle. Makes up 78% of the air you breathe. Essential for DNA, proteins, and fertilizer.',
        8: 'Made when carbon captures helium inside massive stars. The third most common element in the universe. You breathe it, water contains it, and it makes fire possible.',
        9: 'Made in small amounts in stars. The most reactive element \u2014 it attacks almost everything. Added to toothpaste and drinking water to prevent tooth decay. Used in non-stick pans (Teflon).',
        10: 'Created when carbon fuses in massive stars. A noble gas \u2014 it doesn\'t react with anything. Used in bright glowing signs (that\'s why they\'re called "neon signs").',
        11: 'Made in carbon-burning stars. Combined with chlorine, it\'s table salt. Essential for nerve signals in your body. Sodium vapor lamps give streetlights their yellow-orange glow.',
        12: 'Forged in massive stars during carbon and neon burning. The central atom in chlorophyll, which makes plants green and powers photosynthesis. Used in lightweight alloys for cars and laptops.',
        13: 'Created in massive stars. The most abundant metal in Earth\'s crust, yet was once rarer than gold because it\'s hard to extract. Used in soda cans, foil, and aircraft.',
        14: 'Forged when oxygen fuses in massive stars. Sand, glass, and computer chips are all based on silicon. The second most common element in Earth\'s crust. Silicon Valley is named after it.',
        15: 'Made in oxygen-burning stars. Found in every cell of your body \u2014 it\'s in DNA, bones, and teeth. Matches strike because of phosphorus. Essential for fertilizer to grow food.',
        16: 'Created in oxygen-burning stars. Gives rotten eggs and volcanoes their smell. Essential for proteins in your body. Used in gunpowder, rubber vulcanization, and medicines.',
        17: 'Made in massive stars. Combined with sodium, it\'s table salt. Used to purify drinking water and in swimming pools. Your stomach uses hydrochloric acid for digestion.',
        18: 'Produced in oxygen-burning stars. The third most common gas in our atmosphere. Used in welding to shield metals from reacting with air, and inside energy-efficient windows.',
        19: 'Created in massive stars. Essential for every cell in your body \u2014 your heart needs it to beat. Found in bananas, potatoes, and most foods. Used in fertilizer.',
        20: 'Forged in massive stars. What your bones and teeth are made of. Also in limestone, marble, chalk, and seashells. Corals build reefs with calcium carbonate.',
        21: 'Made in the final stages of a massive star\'s life. Rare on Earth. Creates very bright, sun-like light when used in stadiums and film sets.',
        22: 'Forged just before a star explodes. Strong as steel but 45% lighter. Used in aircraft, spacecraft, artificial joints, and dental implants. Won\'t rust.',
        23: 'Made in the final fusion stages of massive stars. Added to steel to make it incredibly strong \u2014 used in wrenches, axles, and armor plating.',
        24: 'An iron-peak element made just before stellar explosion. That shiny silver coating on car bumpers and faucets? That\'s chromium. Also gives rubies their red color.',
        25: 'Made alongside iron in dying massive stars. Essential for steel production. Your body needs tiny amounts for bone health and metabolism.',
        26: 'The end of the line for stellar fusion \u2014 iron is the most tightly bound atom, so no energy can be released by fusing it further. Iron makes up most of Earth\'s core, gives blood its red color, and is the basis of all steel.',
        27: 'Made alongside iron in dying stars. Used in rechargeable batteries (lithium-ion batteries contain cobalt) and gives glass and pottery a brilliant blue color. Vitamin B12 contains cobalt.',
        28: 'Created at the same time as iron in massive stars. Earth\'s core is largely iron and nickel. Used in coins, stainless steel, and guitar strings. Many meteorites are iron-nickel alloy.',
        29: 'Slowly built up inside aging giant stars by capturing neutrons. One of the first metals used by humans (around 9000 BCE). Conducts electricity well \u2014 used in all electrical wiring.',
        30: 'Made in aging giant stars. Your body needs zinc to fight off infections and heal wounds. Used to coat steel (galvanizing) to prevent rust. Found in sunscreen.',
        31: 'Built up by neutron capture in aging stars. Used in LED lights and smartphone screens \u2014 gallium arsenide is a key semiconductor.',
        32: 'Made in aging stars. Used in fiber optic cables that carry internet data at the speed of light. Also used in infrared night-vision devices.',
        33: 'Forged in supernova explosions. Historically infamous as a poison. Today used in computer chips and LED lights.',
        34: 'Made in supernova explosions. Your body needs tiny amounts for a healthy immune system. Used in the red glass of traffic lights and solar cells.',
        35: 'Created in supernovae. One of only two elements that are liquid at room temperature (the other is mercury). Used in swimming pool sanitizers and fire retardants.',
        36: 'Made in aging giant stars. A noble gas used in camera flash bulbs, some car headlights, and Superman\'s home planet is named after it.',
        37: 'Built up in aging stars. Used in the atomic clocks that keep GPS satellites accurate. Rubidium clocks lose only about one second every 300 million years.',
        38: 'A classic product of slow neutron capture in aging stars. Famous for making fireworks burn bright red. Also used in glow-in-the-dark paints.',
        39: 'Made in aging giant stars. Used in LED TV and phone screens (the bright white LEDs), laser surgery tools, and spark plugs.',
        40: 'Built by neutron capture in stars. Won\'t corrode even in extreme conditions \u2014 used as cladding around nuclear fuel rods. Also in some deodorants.',
        41: 'Made in aging stars. Crucial for MRI machines and particle accelerators \u2014 niobium becomes a superconductor at very low temperatures.',
        42: 'Product of stellar neutron capture. Has one of the highest melting points of any element. Used in high-strength steel for bridges and aircraft landing gear.',
        43: 'Created in stars but has no stable forms \u2014 it\'s always radioactive and decays away. The first element ever made artificially. Used in medical imaging to find diseases.',
        44: 'Forged in supernova explosions. Extremely rare and valuable. Used as a catalyst in chemistry and in electronics.',
        45: 'Made in supernovae. One of the rarest elements on Earth. Used in catalytic converters in cars to clean exhaust fumes.',
        46: 'Made in aging stars. Used in catalytic converters (which clean car exhaust) and in jewelry as "white gold."',
        47: 'Forged in the violent explosions of supernovae. The best conductor of electricity of any element. Used in jewelry, electronics, photography, and medical bandages (silver kills bacteria).',
        48: 'Made in aging stars. Used in rechargeable batteries. Toxic heavy metal \u2014 famous from the Itai-itai disease in Japan.',
        49: 'Built up in aging stars. Used in touchscreens \u2014 indium tin oxide is the transparent conductor that makes your phone screen respond to your finger.',
        50: 'Made in aging giant stars. One of the first metals used by humans \u2014 mixed with copper to make bronze, starting the Bronze Age around 3300 BCE. Used to coat steel cans.',
        51: 'Product of stellar neutron capture. Used in flame retardants to make materials fire-resistant. Also in lead-acid batteries.',
        52: 'Created in supernova explosions. Extremely rare on Earth. Used in solar panels and thermoelectric cooling devices.',
        53: 'Forged in supernovae. Your thyroid gland needs iodine to make hormones that control growth and metabolism. Added to table salt (iodized salt) to prevent deficiency.',
        54: 'Made in aging stars. A noble gas used in ion engines that power deep-space probes. Also used in car headlights and camera flash tubes.',
        55: 'Built in aging giant stars. Caesium-133 defines the second \u2014 all clocks in the world are calibrated to caesium atomic clocks.',
        56: 'A classic s-process element made in aging stars. You may have swallowed it \u2014 barium sulfate is used in "barium swallow" X-rays to image your digestive tract.',
        57: 'Made in aging giant stars. Used in high-quality camera lenses and in battery electrodes for hybrid and electric cars.',
        58: 'Made in aging stars. The most abundant of the "rare earth" elements (which aren\'t actually that rare). Used in catalytic converters and self-cleaning ovens.',
        59: 'Built in aging stars. Used in special glass for welder\'s goggles (blocks harmful UV light) and in aircraft engine alloys.',
        60: 'Made in aging stars. Neodymium magnets are the strongest permanent magnets in the world \u2014 found in headphones, hard drives, electric car motors, and wind turbines.',
        61: 'Has no stable forms \u2014 always radioactive. Created in supernovae but decays quickly. Used in some nuclear batteries and glow-in-the-dark paint.',
        62: 'Forged in supernova explosions. Excellent at absorbing neutrons, so it\'s used in nuclear reactor control rods to regulate the chain reaction.',
        63: 'Mostly made in supernova explosions. Used in the red phosphors in old CRT television screens and in euro banknote security features.',
        64: 'Made in supernovae. When injected into your body for an MRI scan, gadolinium makes internal organs show up more clearly. Also used in nuclear reactor shielding.',
        65: 'Forged in stellar explosions. Used in green phosphors for screens and in solid-state electronic devices.',
        66: 'Made in supernovae. Used in data storage (hard drives) and in powerful magnets for electric vehicle motors.',
        67: 'Created in stellar explosions. Has the strongest magnetic properties of any element. Used in MRI machines and nuclear reactors.',
        68: 'Made in supernovae. Erbium-doped fiber amplifiers are what make long-distance internet cables work \u2014 they boost light signals traveling through fiber optic cables.',
        69: 'Forged in stellar explosions. The rarest of the naturally occurring rare earth elements. Used in portable X-ray machines.',
        70: 'Made in supernovae. Used in specialized metals that resist stress and in thermal barrier coatings for jet engines.',
        71: 'Created in stellar explosions. Used in the detectors of PET scanners that help doctors find cancer.',
        72: 'Made in supernovae. Used in control rods for nuclear submarine reactors because it absorbs neutrons extremely well.',
        73: 'Forged in stellar explosions. Your phone contains tantalum \u2014 it\'s used in the tiny capacitors that store electrical charge in electronic devices. Also used in surgical implants because the body doesn\'t reject it.',
        74: 'Made in supernovae. Has the highest melting point of any element (3,422\u00B0C). Used in light bulb filaments, drill bits, and armor-piercing ammunition.',
        75: 'Created in stellar explosions. One of the rarest elements in Earth\'s crust. Used in jet engine parts that must withstand extreme heat.',
        76: 'Forged in supernovae. The densest naturally occurring element \u2014 a block the size of a shoebox would weigh over 250 kg. Used in ultra-durable pen tips and electrical contacts.',
        77: 'Made in stellar explosions. A thin layer of iridium found worldwide in rocks from 66 million years ago is key evidence for the asteroid impact that killed the dinosaurs.',
        78: 'Forged in supernovae and neutron star collisions. Extremely rare and precious. Used in catalytic converters, lab equipment, and jewelry. Won\'t tarnish or corrode.',
        79: 'Created in the most violent events in the universe \u2014 supernova explosions and neutron star collisions. Every gold atom on Earth came from an ancient cosmic cataclysm. Prized for jewelry because it never tarnishes.',
        80: 'Made in stellar explosions. The only metal that\'s liquid at room temperature. Historically used in thermometers. Very toxic \u2014 don\'t touch it.',
        81: 'Made in aging stars. Extremely poisonous \u2014 once used as rat poison and in murder mysteries. Now used in specialized electronics and medical imaging.',
        82: 'The heaviest element with any stable form. Made slowly in aging stars as the end product of neutron capture chains. Used in batteries, radiation shielding, and (historically) paint and plumbing.',
        83: 'The end of the line for the slow neutron capture process. Very slightly radioactive but essentially stable. The active ingredient in Pepto-Bismol. Used in cosmetics and shotgun pellets.',
        84: 'Created in supernovae. Intensely radioactive. Discovered by Marie and Pierre Curie, who named it after Marie\'s homeland of Poland. Used in antistatic devices.',
        85: 'Made in supernovae. The rarest naturally occurring element on Earth \u2014 at any given moment, there are less than 30 grams in the entire Earth\'s crust.',
        86: 'Radioactive noble gas created in supernovae. Forms naturally as radium decays in the ground. Can accumulate in basements and is a leading cause of lung cancer in non-smokers.',
        87: 'Created in stellar explosions. The most reactive metal in existence \u2014 explodes on contact with water. So rare and radioactive it has no practical uses.',
        88: 'Made in stellar explosions. Discovered by Marie Curie. Used to glow in the dark on watch dials in the early 1900s, before people realized how dangerous radiation was.',
        89: 'Made in supernovae. Intensely radioactive. Glows pale blue in the dark. Used as a source of neutrons for scientific research.',
        90: 'Forged in supernova explosions. Mildly radioactive with an incredibly long half-life (14 billion years \u2014 the age of the universe). Could potentially fuel nuclear reactors. Used to date the age of rocks.',
        91: 'Created in supernovae. Extremely rare and radioactive. One of the rarest elements that occurs naturally on Earth.',
        92: 'The heaviest element found in significant amounts in nature. Forged in supernovae. Powers nuclear reactors that generate about 10% of the world\'s electricity. Also used in the first atomic bombs.',
        93: 'Made in stellar explosions but decays away. First made artificially in 1940. Named after Neptune. Found in tiny traces from uranium decay.',
        94: 'Forged in supernovae. Used in nuclear weapons and in RTG batteries that have powered space missions to the outer planets (Voyager probes, Curiosity Mars rover). Named after Pluto.',
        95: 'Made in stellar explosions. Used in common household smoke detectors \u2014 a tiny amount of americium-241 ionizes air to detect smoke particles.',
        96: 'Named after Marie and Pierre Curie. So radioactive it glows in the dark. Used as a power source in some space instruments.',
        97: 'Named after Berkeley, California, where it was first made. So rare that only tiny amounts have ever been produced.',
        98: 'A strong source of neutrons. Used to start up nuclear reactors and in medical treatments for certain cancers.',
        99: 'First discovered in the fallout from the first hydrogen bomb test in 1952. Named after Albert Einstein.',
        100: 'Also discovered in hydrogen bomb fallout. Named after Enrico Fermi, the physicist who built the first nuclear reactor.',
        101: 'Named after Dmitri Mendeleev, the Russian chemist who created the periodic table of elements.',
        102: 'Named after Alfred Nobel, who invented dynamite and established the Nobel Prizes.',
        103: 'Named after Ernest Lawrence, who invented the cyclotron particle accelerator used to discover many elements.',
      }
    };

    // === LANGUAGE TOGGLE (Standard / Technical) ===
    const LanguageToggle = {
      mode: 'standard', // 'standard' | 'technical'

      init() {
        const saved = localStorage.getItem('sn-lang');
        this.mode = saved || 'standard';
        this.updateUI();
        document.getElementById('lang-toggle').addEventListener('click', () => this.toggle());
      },

      toggle() {
        this.mode = this.mode === 'standard' ? 'technical' : 'standard';
        localStorage.setItem('sn-lang', this.mode);
        this.updateUI();
        // Refresh all displayed text
        InfoPanel.update();
        // Force stage summary to rebuild with new language
        if (StageSummary.container) StageSummary.container.dataset.count = '';
        StageSummary.update();
        showToast(this.mode === 'technical' ? 'Technical mode' : 'Standard mode');
      },

      updateUI() {
        const label = document.getElementById('lang-label');
        const icon = document.getElementById('lang-icon');
        if (this.mode === 'technical') {
          label.textContent = 'Technical';
          icon.textContent = '\u2699'; // gear
        } else {
          label.textContent = 'Standard';
          icon.textContent = '\u2605'; // star
        }
      },

      isTechnical() { return this.mode === 'technical'; },
      isStandard() { return this.mode === 'standard'; },
    };

    // === THEME MANAGER ===
    const ThemeManager = {
      init() {
        const saved = localStorage.getItem('sn-theme');
        if (saved) {
          document.documentElement.dataset.theme = saved;
        } else if (window.matchMedia('(prefers-color-scheme: light)').matches) {
          document.documentElement.dataset.theme = 'light';
        }
        this.updateIcon();
        document.getElementById('theme-toggle').addEventListener('click', () => this.toggle());
      },
      toggle() {
        const html = document.documentElement;
        html.dataset.theme = html.dataset.theme === 'dark' ? 'light' : 'dark';
        localStorage.setItem('sn-theme', html.dataset.theme);
        this.updateIcon();
      },
      updateIcon() {
        const icon = document.getElementById('theme-icon');
        icon.textContent = document.documentElement.dataset.theme === 'dark' ? '\u263E' : '\u2600';
      }
    };

    // === HELP OVERLAY ===
    const HelpOverlay = {
      init() {
        this.el = document.getElementById('help-overlay');
        document.getElementById('help-toggle').addEventListener('click', () => this.toggle());
        document.getElementById('help-close').addEventListener('click', () => this.close());
        this.el.addEventListener('click', (e) => { if (e.target === this.el) this.close(); });
      },
      toggle() { this.el.classList.toggle('open'); },
      open() { this.el.classList.add('open'); },
      close() { this.el.classList.remove('open'); }
    };

    // === TOAST ===
    function showToast(msg, duration = 3000) {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = msg;
      container.appendChild(toast);
      setTimeout(() => { toast.style.opacity = '0'; toast.style.transition = 'opacity 0.3s'; }, duration - 300);
      setTimeout(() => toast.remove(), duration);
    }

    // ============================================================
    // SIMULATION ENGINE
    // ============================================================

    const Simulation = {
      mass: 1.0,
      classification: null,
      stageList: [],
      progress: 0,
      currentStageIdx: 0,
      stageProgress: 0,
      playing: false,
      speed: 1,
      animFrameId: null,
      lastTime: 0,
      supernovaTriggered: false,
      onUpdate: null,
      BASE_DURATION: 30,

      setMass(mass) {
        this.mass = mass;
        this.classification = classifyStar(mass);
        this.stageList = this.classification.stages.map(id => getStageById(id));
        this.reset();
      },

      reset() {
        this.progress = 0;
        this.currentStageIdx = 0;
        this.stageProgress = 0;
        this.playing = false;
        this.supernovaTriggered = false;
        PeriodicTable.resetAll();
        if (this.animFrameId) cancelAnimationFrame(this.animFrameId);
        this.animFrameId = null;
        if (this.onUpdate) this.onUpdate();
      },

      play() {
        if (this.stageList.length === 0) return;
        if (this.progress >= 1) { this.reset(); }
        this.playing = true;
        this.lastTime = performance.now();
        this.tick();
      },

      pause() {
        this.playing = false;
        if (this.animFrameId) cancelAnimationFrame(this.animFrameId);
        this.animFrameId = null;
      },

      togglePlay() {
        if (this.playing) this.pause(); else this.play();
      },

      setSpeed(s) { this.speed = s; },

      tick() {
        if (!this.playing) return;
        const now = performance.now();
        const dt = (now - this.lastTime) / 1000;
        this.lastTime = now;

        const stageCount = this.stageList.length;
        if (stageCount === 0) return;

        const increment = (dt * this.speed) / this.BASE_DURATION;
        this.progress = Math.min(1, this.progress + increment);

        const rawStageIdx = Math.min(stageCount - 1, Math.floor(this.progress * stageCount));
        const stageStart = rawStageIdx / stageCount;
        const stageEnd = (rawStageIdx + 1) / stageCount;
        this.stageProgress = (this.progress - stageStart) / (stageEnd - stageStart);

        if (rawStageIdx !== this.currentStageIdx) {
          if (this.currentStageIdx < this.stageList.length) {
            PeriodicTable.finalizeStageElements(this.stageList[this.currentStageIdx].id);
          }
          this.currentStageIdx = rawStageIdx;
        }

        const currentStage = this.stageList[this.currentStageIdx];
        if (currentStage) {
          PeriodicTable.activateStageElements(currentStage.id);
        }

        if (currentStage && currentStage.id === 'supernova' && !this.supernovaTriggered) {
          this.supernovaTriggered = true;
          this.triggerSupernova();
        }

        if (this.onUpdate) this.onUpdate();

        if (this.progress >= 1) {
          PeriodicTable.finalizeStageElements(this.stageList[this.stageList.length - 1].id);
          this.playing = false;
          if (this.onUpdate) this.onUpdate();
          return;
        }

        this.animFrameId = requestAnimationFrame(() => this.tick());
      },

      async triggerSupernova() {
        const flash = document.getElementById('supernova-flash');
        flash.classList.add('active');
        setTimeout(() => flash.classList.remove('active'), 1500);
        await PeriodicTable.rProcessCascade(25);
      },

      seekTo(pct) {
        const wasPlaying = this.playing;
        this.pause();
        this.progress = Math.max(0, Math.min(1, pct));
        this.supernovaTriggered = false;

        PeriodicTable.resetAll();
        const stageCount = this.stageList.length;
        if (stageCount === 0) return;

        const rawStageIdx = Math.min(stageCount - 1, Math.floor(this.progress * stageCount));
        this.currentStageIdx = rawStageIdx;
        const stageStart = rawStageIdx / stageCount;
        const stageEnd = (rawStageIdx + 1) / stageCount;
        this.stageProgress = stageEnd > stageStart ? (this.progress - stageStart) / (stageEnd - stageStart) : 0;

        for (let i = 0; i < rawStageIdx; i++) {
          PeriodicTable.finalizeStageElements(this.stageList[i].id);
          if (this.stageList[i].id === 'supernova') this.supernovaTriggered = true;
        }
        if (this.stageList[rawStageIdx]) {
          PeriodicTable.activateStageElements(this.stageList[rawStageIdx].id);
        }

        if (this.onUpdate) this.onUpdate();
        if (wasPlaying) this.play();
      },

      jumpToStage(idx) {
        const stageCount = this.stageList.length;
        if (idx < 0 || idx >= stageCount) return;
        this.seekTo(idx / stageCount + 0.001);
      },

      getCurrentStage() { return this.stageList[this.currentStageIdx] || null; },

      getRealTime() {
        let total = 0;
        for (let i = 0; i < this.currentStageIdx && i < this.stageList.length; i++) {
          total += this.stageList[i].duration(this.mass);
        }
        if (this.stageList[this.currentStageIdx]) {
          total += this.stageList[this.currentStageIdx].duration(this.mass) * this.stageProgress;
        }
        return total;
      },
    };

    // ============================================================
    // PLAYBACK CONTROLLER
    // ============================================================

    const PlaybackController = {
      init() {
        document.getElementById('btn-play').addEventListener('click', () => {
          Simulation.togglePlay();
          this.updateUI();
        });
        document.getElementById('btn-reset').addEventListener('click', () => {
          Simulation.reset();
          this.updateUI();
        });
        document.querySelectorAll('[data-speed]').forEach(btn => {
          btn.addEventListener('click', () => {
            Simulation.setSpeed(parseFloat(btn.dataset.speed));
            document.querySelectorAll('[data-speed]').forEach(b => b.classList.remove('btn--active'));
            btn.classList.add('btn--active');
          });
        });
        const bar = document.getElementById('timeline-bar');
        bar.addEventListener('click', (e) => {
          const rect = bar.getBoundingClientRect();
          Simulation.seekTo((e.clientX - rect.left) / rect.width);
        });
        bar.addEventListener('keydown', (e) => {
          if (e.key === 'ArrowRight') Simulation.seekTo(Simulation.progress + 0.02);
          if (e.key === 'ArrowLeft') Simulation.seekTo(Simulation.progress - 0.02);
        });
        Simulation.onUpdate = () => this.updateUI();
      },

      updateUI() {
        const playBtn = document.getElementById('btn-play');
        playBtn.innerHTML = Simulation.playing ? '&#9646;&#9646;' : '&#9654;';
        playBtn.setAttribute('aria-label', Simulation.playing ? 'Pause' : 'Play');

        document.getElementById('timeline-progress').style.width = (Simulation.progress * 100) + '%';
        document.getElementById('timeline-bar').setAttribute('aria-valuenow', Math.round(Simulation.progress * 100));

        const realTime = Simulation.getRealTime();
        document.getElementById('time-real').textContent = realTime > 0 ? formatDuration(realTime) : '--';

        this.renderTimelineStages();
        InfoPanel.update();
        StageSummary.update();
        StarViz.draw();
      },

      renderTimelineStages() {
        const container = document.getElementById('timeline-stages');
        if (container.childElementCount !== Simulation.stageList.length) {
          container.innerHTML = '';
          Simulation.stageList.forEach(stage => {
            const seg = document.createElement('div');
            seg.className = 'timeline-stage-seg';
            seg.textContent = stage.shortName;
            seg.style.borderRightColor = stage.color + '44';
            container.appendChild(seg);
          });
        }
      }
    };

    // ============================================================
    // MASS SELECTOR CONTROLLER
    // ============================================================

    const MassSelector = {
      init() {
        const slider = document.getElementById('mass-slider');
        const output = document.getElementById('mass-value');
        const classLabel = document.getElementById('star-class');

        const toMass = (v) => 0.08 * Math.pow(150 / 0.08, v / 100);
        const toSlider = (m) => 100 * Math.log(m / 0.08) / Math.log(150 / 0.08);

        const update = () => {
          const mass = toMass(parseFloat(slider.value));
          const rounded = parseFloat(mass.toPrecision(3));
          output.textContent = rounded + ' M\u2609';
          slider.setAttribute('aria-valuenow', rounded);
          slider.setAttribute('aria-valuetext', rounded + ' solar masses');
          classLabel.textContent = classifyStar(rounded).name;
          Simulation.setMass(rounded);
          PlaybackController.updateUI();
        };

        slider.addEventListener('input', update);
        document.querySelectorAll('[data-mass]').forEach(btn => {
          btn.addEventListener('click', () => {
            slider.value = toSlider(parseFloat(btn.dataset.mass));
            update();
          });
        });
        slider.value = toSlider(1.0);
        update();
      }
    };

    // ============================================================
    // INFO PANEL
    // ============================================================

    const InfoPanel = {
      init() {
        const toggle = document.getElementById('details-toggle');
        const content = document.getElementById('details-content');
        toggle.addEventListener('click', () => {
          const open = content.classList.toggle('open');
          toggle.setAttribute('aria-expanded', open);
          const label = LanguageToggle.isTechnical() ? 'Detailed Physics' : 'Learn More';
          toggle.innerHTML = (open ? '\u25B2 Hide' : '\u25BC Show') + ' ' + label;
        });
      },

      update() {
        const stage = Simulation.getCurrentStage();
        const nameEl = document.getElementById('info-stage-name');
        const tempEl = document.getElementById('info-temp');
        const densityEl = document.getElementById('info-density');
        const durationEl = document.getElementById('info-duration');
        const reactionsEl = document.getElementById('info-reactions');
        const descEl = document.getElementById('info-desc');
        const detailsEl = document.getElementById('details-content');

        if (!stage) {
          nameEl.textContent = 'Pre-simulation'; nameEl.style.color = '';
          tempEl.textContent = '--'; densityEl.textContent = '--'; durationEl.textContent = '--';
          reactionsEl.innerHTML = '';
          descEl.textContent = 'Select a star mass and press Play to begin.';
          detailsEl.textContent = '';
          return;
        }

        if (Simulation.progress >= 1 && Simulation.classification.remnant) {
          const rem = REMNANTS[Simulation.classification.remnant];
          nameEl.textContent = rem.name; nameEl.style.color = '';
          tempEl.textContent = 'Cooling';
          densityEl.textContent = Simulation.classification.remnant === 'blackhole' ? '\u221E' : 'Extreme';
          durationEl.textContent = 'Forever';
          reactionsEl.innerHTML = '';
          descEl.textContent = (LanguageToggle.isStandard() && rem.simpleDescription) ? rem.simpleDescription : rem.description;
          detailsEl.textContent = '';
          return;
        }

        nameEl.textContent = stage.name; nameEl.style.color = stage.color;
        tempEl.textContent = formatTemp(stage.temperature(Simulation.mass));
        densityEl.textContent = formatDensity(stage.density(Simulation.mass));
        durationEl.textContent = formatDuration(stage.duration(Simulation.mass));
        reactionsEl.innerHTML = stage.reactions.map(r => `<li>${r}</li>`).join('');

        const useSimple = LanguageToggle.isStandard();
        descEl.textContent = (useSimple && stage.simpleDescription) ? stage.simpleDescription : stage.description;
        detailsEl.textContent = (useSimple && stage.simpleDetailedDescription) ? stage.simpleDetailedDescription : stage.detailedDescription;
      }
    };

    // ============================================================
    // STAGE SUMMARY CARDS
    // ============================================================

    const StageSummary = {
      container: null,
      init() { this.container = document.getElementById('stage-cards'); },

      update() {
        const stages = Simulation.stageList;
        if (this.container.dataset.count !== String(stages.length)) {
          this.container.dataset.count = stages.length;
          this.container.innerHTML = '';
          stages.forEach((stage, idx) => {
            const card = document.createElement('div');
            card.className = 'stage-card stage-card--locked';
            card.dataset.idx = idx;
            card.innerHTML = `
              <div class="stage-card-header" tabindex="0" aria-expanded="false">
                <span class="stage-card-dot" style="color:${stage.color};background:${stage.color}"></span>
                <span class="stage-card-name">${stage.name}</span>
                <span class="stage-card-meta">${formatDuration(stage.duration(Simulation.mass))}</span>
              </div>
              <div class="stage-card-body">
                <p>${(LanguageToggle.isStandard() && stage.simpleDescription) ? stage.simpleDescription : stage.description}</p>
                <p style="margin-top:var(--space-2);font-family:monospace;font-size:var(--fs-xs)">${stage.reactions.join('<br>')}</p>
              </div>`;
            const header = card.querySelector('.stage-card-header');
            header.addEventListener('click', () => {
              const body = card.querySelector('.stage-card-body');
              const open = body.classList.toggle('open');
              header.setAttribute('aria-expanded', open);
            });
            header.addEventListener('keydown', (e) => {
              if (e.key === 'Enter' || e.key === ' ') { e.preventDefault(); header.click(); }
            });
            this.container.appendChild(card);
          });
        }

        this.container.querySelectorAll('.stage-card').forEach((card, idx) => {
          if (idx < Simulation.currentStageIdx) card.className = 'stage-card stage-card--complete';
          else if (idx === Simulation.currentStageIdx && Simulation.progress > 0) card.className = 'stage-card stage-card--active';
          else card.className = 'stage-card stage-card--locked';
        });
      }
    };

    // ============================================================
    // STAR VISUALIZATION (Canvas)
    // ============================================================

    const StarViz = {
      canvas: null, ctx: null,
      viewMode: 'external', // 'external' | 'shell'

      init() {
        this.canvas = document.getElementById('star-canvas');
        this.ctx = this.canvas.getContext('2d');

        // View toggle
        document.getElementById('view-external').addEventListener('click', () => this.setView('external'));
        document.getElementById('view-shell').addEventListener('click', () => this.setView('shell'));

        // Resize
        this.resize();
        window.addEventListener('resize', () => this.resize());
        this.draw();
      },

      setView(mode) {
        this.viewMode = mode;
        document.getElementById('view-external').classList.toggle('btn--active', mode === 'external');
        document.getElementById('view-external').setAttribute('aria-pressed', mode === 'external');
        document.getElementById('view-shell').classList.toggle('btn--active', mode === 'shell');
        document.getElementById('view-shell').setAttribute('aria-pressed', mode === 'shell');
        this.draw();
      },

      resize() {
        const wrap = this.canvas.parentElement;
        const size = Math.min(wrap.clientWidth, wrap.clientHeight) || 300;
        this.canvas.width = size * window.devicePixelRatio;
        this.canvas.height = size * window.devicePixelRatio;
        this.canvas.style.width = size + 'px';
        this.canvas.style.height = size + 'px';
        this.ctx.setTransform(window.devicePixelRatio, 0, 0, window.devicePixelRatio, 0, 0);
        this.draw();
      },

      draw() {
        const ctx = this.ctx;
        const w = this.canvas.width / window.devicePixelRatio;
        const h = this.canvas.height / window.devicePixelRatio;
        const cx = w / 2, cy = h / 2;
        const maxR = Math.min(w, h) * 0.4;

        ctx.clearRect(0, 0, w, h);

        if (this.viewMode === 'external') {
          this.drawExternal(ctx, cx, cy, maxR);
        } else {
          this.drawCrossSection(ctx, cx, cy, maxR);
        }
      },

      drawExternal(ctx, cx, cy, maxR) {
        const stage = Simulation.getCurrentStage();
        const mass = Simulation.mass;

        // Determine star color and size
        let color = '#fff4e0';
        let sizeF = 0.3;
        if (stage) {
          color = stage.starColor(mass);
          // Normalize size factor
          const rawSize = stage.starSize(mass);
          sizeF = Math.min(1, Math.max(0.1, rawSize / 50));
        }

        // Remnant
        if (Simulation.progress >= 1 && Simulation.classification.remnant) {
          const rem = Simulation.classification.remnant;
          if (rem === 'whitedwarf') { color = '#e8e8ff'; sizeF = 0.08; }
          else if (rem === 'neutronstar') { color = '#aaddff'; sizeF = 0.04; }
          else { color = '#111'; sizeF = 0.06; }
        }

        const r = maxR * sizeF;

        // Glow
        const glow = ctx.createRadialGradient(cx, cy, r * 0.3, cx, cy, r * 2.5);
        glow.addColorStop(0, color + '66');
        glow.addColorStop(0.5, color + '22');
        glow.addColorStop(1, 'transparent');
        ctx.fillStyle = glow;
        ctx.fillRect(0, 0, cx * 2, cy * 2);

        // Star body
        const body = ctx.createRadialGradient(cx, cy, 0, cx, cy, r);
        body.addColorStop(0, '#ffffff');
        body.addColorStop(0.3, color);
        body.addColorStop(1, this.darken(color, 0.5));
        ctx.beginPath();
        ctx.arc(cx, cy, r, 0, Math.PI * 2);
        ctx.fillStyle = body;
        ctx.fill();

        // Black hole special
        if (Simulation.progress >= 1 && Simulation.classification.remnant === 'blackhole') {
          ctx.beginPath();
          ctx.arc(cx, cy, r, 0, Math.PI * 2);
          ctx.fillStyle = '#000';
          ctx.fill();
          // Accretion ring
          ctx.beginPath();
          ctx.ellipse(cx, cy, r * 3, r * 0.8, 0, 0, Math.PI * 2);
          ctx.strokeStyle = '#ff8800';
          ctx.lineWidth = 2;
          ctx.stroke();
        }

        // SR description
        const desc = document.getElementById('star-desc');
        if (stage) {
          desc.textContent = `Star visualization: ${Simulation.classification.name} during ${stage.name}`;
        }
      },

      drawCrossSection(ctx, cx, cy, maxR) {
        const stages = Simulation.stageList;
        const currentIdx = Simulation.currentStageIdx;
        if (Simulation.progress === 0 || stages.length === 0) {
          // Draw a simple star
          ctx.beginPath();
          ctx.arc(cx, cy, maxR * 0.5, 0, Math.PI * 2);
          ctx.fillStyle = '#FBBF2444';
          ctx.fill();
          ctx.strokeStyle = '#FBBF24';
          ctx.lineWidth = 2;
          ctx.stroke();
          ctx.fillStyle = 'var(--text-secondary)';
          ctx.font = '14px sans-serif';
          ctx.textAlign = 'center';
          ctx.fillStyle = '#94a3b8';
          ctx.fillText('Press Play to begin', cx, cy);
          return;
        }

        // Determine active shells (up to currentIdx)
        const activeShells = [];
        for (let i = 0; i <= currentIdx && i < stages.length; i++) {
          if (stages[i].shellIndex >= 0) {
            activeShells.push(stages[i]);
          }
        }

        if (activeShells.length === 0) {
          // Only H-burning: one shell
          const stage = stages[0];
          ctx.beginPath();
          ctx.arc(cx, cy, maxR * 0.8, 0, Math.PI * 2);
          ctx.fillStyle = stage.color + '44';
          ctx.fill();
          ctx.strokeStyle = stage.color;
          ctx.lineWidth = 2;
          ctx.stroke();
          ctx.fillStyle = '#f1f5f9';
          ctx.font = '12px sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText(stage.shortName + ' burning', cx, cy);
          return;
        }

        // Draw shells from outermost to innermost
        const shellCount = activeShells.length;
        for (let i = 0; i < shellCount; i++) {
          const shell = activeShells[i];
          const outerR = maxR * (1 - i * 0.12);
          const innerR = maxR * (1 - (i + 1) * 0.12);

          // Shell band
          ctx.beginPath();
          ctx.arc(cx, cy, outerR, 0, Math.PI * 2);
          ctx.fillStyle = shell.color + '33';
          ctx.fill();
          ctx.beginPath();
          ctx.arc(cx, cy, outerR, 0, Math.PI * 2);
          ctx.strokeStyle = shell.color + '88';
          ctx.lineWidth = 1.5;
          ctx.stroke();

          // Label
          const labelR = (outerR + innerR) / 2;
          ctx.fillStyle = '#f1f5f9';
          ctx.font = '11px sans-serif';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText(shell.shortName, cx, cy - labelR);
        }

        // Iron core (for Si-burning and beyond)
        if (currentIdx >= stages.findIndex(s => s.id === 'silicon')) {
          const coreR = maxR * 0.15;
          ctx.beginPath();
          ctx.arc(cx, cy, coreR, 0, Math.PI * 2);
          ctx.fillStyle = '#6366F1';
          ctx.fill();
          ctx.fillStyle = '#fff';
          ctx.font = 'bold 11px sans-serif';
          ctx.textAlign = 'center';
          ctx.textBaseline = 'middle';
          ctx.fillText('Fe core', cx, cy);
        }

        // SR description
        const desc = document.getElementById('star-desc');
        desc.textContent = `Cross-section view: ${activeShells.length} burning shells, currently in ${stages[currentIdx].name}`;
      },

      darken(hex, factor) {
        const r = parseInt(hex.slice(1, 3), 16);
        const g = parseInt(hex.slice(3, 5), 16);
        const b = parseInt(hex.slice(5, 7), 16);
        return `rgb(${Math.round(r * factor)},${Math.round(g * factor)},${Math.round(b * factor)})`;
      }
    };

    // ============================================================
    // PERSISTENCE (localStorage)
    // ============================================================

    const Persistence = {
      KEY: 'sn-state',
      save() {
        try {
          const state = {
            mass: Simulation.mass,
            theme: document.documentElement.dataset.theme,
            viewMode: StarViz.viewMode,
          };
          localStorage.setItem(this.KEY, JSON.stringify(state));
        } catch (e) { /* quota exceeded — silently fail */ }
      },
      restore() {
        try {
          const raw = localStorage.getItem(this.KEY);
          if (!raw) return null;
          return JSON.parse(raw);
        } catch (e) { return null; }
      }
    };

    // EASTER EGG: Konami code → show binding energy curve
    const KonamiCode = {
      sequence: ['ArrowUp','ArrowUp','ArrowDown','ArrowDown','ArrowLeft','ArrowRight','ArrowLeft','ArrowRight','b','a'],
      pos: 0,
      init() {
        document.addEventListener('keydown', (e) => {
          if (e.key === this.sequence[this.pos]) {
            this.pos++;
            if (this.pos === this.sequence.length) {
              this.pos = 0;
              this.showBindingEnergyCurve();
            }
          } else {
            this.pos = 0;
          }
        });
      },
      showBindingEnergyCurve() {
        showToast('You found the Binding Energy Curve!', 5000);
        // Draw a mini binding energy curve in the star canvas
        const ctx = StarViz.ctx;
        const w = StarViz.canvas.width / window.devicePixelRatio;
        const h = StarViz.canvas.height / window.devicePixelRatio;
        ctx.clearRect(0, 0, w, h);

        // Binding energy per nucleon data (approximate, key nuclei)
        const data = [
          {z: 1, be: 0, label: 'H'},
          {z: 2, be: 7.07, label: 'He'},
          {z: 6, be: 7.68, label: 'C'},
          {z: 8, be: 7.98, label: 'O'},
          {z: 14, be: 8.45, label: 'Si'},
          {z: 26, be: 8.79, label: 'Fe'},
          {z: 28, be: 8.77, label: 'Ni'},
          {z: 56, be: 8.57, label: 'Ba'},
          {z: 79, be: 7.91, label: 'Au'},
          {z: 92, be: 7.57, label: 'U'},
        ];

        const margin = 40;
        const gw = w - margin * 2;
        const gh = h - margin * 2;

        // Axes
        ctx.strokeStyle = '#94a3b8';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.moveTo(margin, margin); ctx.lineTo(margin, h - margin); ctx.lineTo(w - margin, h - margin);
        ctx.stroke();

        // Labels
        ctx.fillStyle = '#f1f5f9';
        ctx.font = '11px sans-serif';
        ctx.textAlign = 'center';
        ctx.fillText('Atomic Number (Z)', w / 2, h - 8);
        ctx.save();
        ctx.translate(12, h / 2);
        ctx.rotate(-Math.PI / 2);
        ctx.fillText('Binding Energy / Nucleon (MeV)', 0, 0);
        ctx.restore();

        // Title
        ctx.font = 'bold 14px sans-serif';
        ctx.fillText('Binding Energy per Nucleon', w / 2, margin - 15);
        ctx.font = '10px sans-serif';
        ctx.fillStyle = '#64748b';
        ctx.fillText('Peak at Fe-56: fusion releases energy left of peak, fission right of peak', w / 2, margin - 2);

        // Plot
        ctx.strokeStyle = '#FBBF24';
        ctx.lineWidth = 2;
        ctx.beginPath();
        data.forEach((d, i) => {
          const x = margin + (d.z / 100) * gw;
          const y = h - margin - (d.be / 9.5) * gh;
          if (i === 0) ctx.moveTo(x, y); else ctx.lineTo(x, y);
        });
        ctx.stroke();

        // Points and labels
        data.forEach(d => {
          const x = margin + (d.z / 100) * gw;
          const y = h - margin - (d.be / 9.5) * gh;
          ctx.beginPath();
          ctx.arc(x, y, 4, 0, Math.PI * 2);
          ctx.fillStyle = d.label === 'Fe' ? '#EF4444' : '#FBBF24';
          ctx.fill();
          ctx.fillStyle = '#f1f5f9';
          ctx.font = '10px sans-serif';
          ctx.textAlign = 'center';
          ctx.fillText(d.label, x, y - 10);
        });

        // Fe annotation
        const feX = margin + (26 / 100) * gw;
        const feY = h - margin - (8.79 / 9.5) * gh;
        ctx.fillStyle = '#EF4444';
        ctx.font = 'bold 11px sans-serif';
        ctx.fillText('\u2190 FUSION \u2192 \u2190 FISSION', feX + 40, feY + 20);
      }
    };

    // ============================================================
    // INITIALIZATION
    // ============================================================
    document.addEventListener('DOMContentLoaded', () => {
      LanguageToggle.init();
      ThemeManager.init();
      HelpOverlay.init();
      PeriodicTable.init();
      ElementDetail.init();
      InfoPanel.init();
      StageSummary.init();
      StarViz.init();
      PlaybackController.init();
      MassSelector.init();
      KonamiCode.init();

      // Restore saved state
      const saved = Persistence.restore();
      if (saved) {
        if (saved.viewMode) StarViz.setView(saved.viewMode);
      }

      // Auto-save on meaningful changes
      const debouncedSave = (() => {
        let timer;
        return () => { clearTimeout(timer); timer = setTimeout(() => Persistence.save(), 500); };
      })();
      const origOnUpdate = Simulation.onUpdate;
      Simulation.onUpdate = () => { if (origOnUpdate) origOnUpdate(); debouncedSave(); };

      // Save on exit
      window.addEventListener('beforeunload', () => Persistence.save());
      document.addEventListener('visibilitychange', () => { if (document.hidden) Persistence.save(); });

      // Global keyboard shortcuts
      document.addEventListener('keydown', (e) => {
        if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') return;

        switch (e.key) {
          case '?': HelpOverlay.toggle(); break;
          case 't': case 'T': ThemeManager.toggle(); break;
          case ' ':
            e.preventDefault();
            Simulation.togglePlay();
            PlaybackController.updateUI();
            break;
          case 'ArrowRight': Simulation.seekTo(Simulation.progress + 0.02); break;
          case 'ArrowLeft': Simulation.seekTo(Simulation.progress - 0.02); break;
          case 'v': case 'V':
            StarViz.setView(StarViz.viewMode === 'external' ? 'shell' : 'external');
            break;
          case 'l': case 'L':
            LanguageToggle.toggle();
            break;
          case 'r': case 'R':
            Simulation.reset();
            PlaybackController.updateUI();
            break;
          case '+': case '=':
            Simulation.setSpeed(Math.min(10, Simulation.speed * 2));
            showToast('Speed: ' + Simulation.speed + 'x');
            break;
          case '-': case '_':
            Simulation.setSpeed(Math.max(0.25, Simulation.speed / 2));
            showToast('Speed: ' + Simulation.speed + 'x');
            break;
          case '1': case '2': case '3': case '4': case '5': case '6': case '7':
            Simulation.jumpToStage(parseInt(e.key) - 1);
            break;
          case 'Escape':
            HelpOverlay.close();
            ElementDetail.hide();
            break;
        }
      });
    });
  </script>
</body>
</html>
